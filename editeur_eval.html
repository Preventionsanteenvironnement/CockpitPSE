<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editeur d'Evaluations ‚Äî PSE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a; color: white; height: 100vh; display: flex; overflow: hidden;
        }

        /* === SIDEBAR === */
        #sidebar {
            width: 320px; min-width: 320px; background: #1e293b; display: flex; flex-direction: column;
            border-right: 1px solid #334155; overflow-y: auto;
        }
        #sidebar::-webkit-scrollbar { width: 4px; }
        #sidebar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .sidebar-header {
            padding: 16px; border-bottom: 1px solid #334155; display: flex;
            align-items: center; justify-content: space-between;
        }
        .sidebar-header h2 { font-size: 1.05rem; }
        .sidebar-header a { color: #94a3b8; text-decoration: none; font-size: 0.8rem; }
        .sidebar-header a:hover { color: white; }

        .sidebar-section { padding: 14px; border-bottom: 1px solid #334155; }
        .sidebar-section label {
            font-size: 0.7rem; color: #64748b; text-transform: uppercase;
            letter-spacing: 1px; display: block; margin-bottom: 8px;
        }

        #btn-new-eval {
            width: 100%; padding: 12px; background: #22c55e; color: white;
            border: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem;
            cursor: pointer; transition: opacity 0.2s;
        }
        #btn-new-eval:hover { opacity: 0.85; }

        .eval-list { display: flex; flex-direction: column; gap: 4px; }
        .eval-list-item {
            padding: 10px 12px; background: #0f172a; border-radius: 8px;
            cursor: pointer; transition: 0.2s; border: 2px solid transparent; position: relative;
        }
        .eval-list-item:hover { border-color: #475569; }
        .eval-list-item.active { border-color: #3b82f6; background: #1e3a5f; }
        .eval-list-item .ei-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 2px; padding-right: 28px; }
        .eval-list-item .ei-meta { font-size: 0.7rem; color: #64748b; }
        .eval-list-item .ei-del {
            position: absolute; top: 8px; right: 8px;
            background: transparent; border: none; color: #64748b;
            font-size: 0.85rem; cursor: pointer; padding: 2px 5px; border-radius: 4px;
            opacity: 0; transition: 0.2s;
        }
        .eval-list-item:hover .ei-del { opacity: 1; }
        .eval-list-item .ei-del:hover { color: #ef4444; background: rgba(239,68,68,0.15); }
        .ei-badge {
            display: inline-block; padding: 2px 6px; border-radius: 4px;
            font-size: 0.65rem; font-weight: 700; margin-right: 4px;
        }
        .badge-pub { background: #dcfce7; color: #166534; }
        .badge-draft { background: #fef3c7; color: #92400e; }
        .badge-qcount { background: #dbeafe; color: #1e40af; }
        .badge-bareme { background: #ede9fe; color: #5b21b6; }

        /* === MAIN === */
        #main {
            flex: 1; display: flex; flex-direction: column; overflow-y: auto;
            padding: 30px; background: #0f172a;
        }

        #main-empty {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; flex: 1; text-align: center; color: #64748b;
        }
        #main-empty .big-icon { font-size: 4rem; margin-bottom: 16px; }

        #main-editor { display: none; flex-direction: column; gap: 20px; max-width: 850px; width: 100%; margin: 0 auto; }

        /* Form elements */
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .form-input, .form-textarea {
            padding: 10px 14px; background: #1e293b; border: 1px solid #475569;
            border-radius: 8px; color: white; font-size: 0.95rem; outline: none; font-family: inherit;
        }
        .form-textarea { resize: vertical; min-height: 60px; }
        .form-input:focus, .form-textarea:focus { border-color: #3b82f6; }
        .form-input::placeholder, .form-textarea::placeholder { color: #64748b; }
        .form-select {
            padding: 10px 14px; background: #1e293b; border: 1px solid #475569;
            border-radius: 8px; color: white; font-size: 0.95rem; outline: none; cursor: pointer;
        }
        .form-select:focus { border-color: #3b82f6; }

        .form-row { display: flex; gap: 12px; }
        .form-row > * { flex: 1; }

        /* Meta section */
        .meta-card {
            background: #1e293b; border-radius: 12px; padding: 20px;
            border: 1px solid #334155;
        }
        .meta-card h3 { font-size: 1rem; margin-bottom: 16px; color: #f1f5f9; }

        /* Bareme radio */
        .bareme-toggle { display: flex; gap: 8px; }
        .bareme-btn {
            flex: 1; padding: 10px; border: 2px solid #475569; border-radius: 10px;
            background: transparent; color: #94a3b8; font-weight: 700; font-size: 0.95rem;
            cursor: pointer; transition: 0.2s; text-align: center;
        }
        .bareme-btn.active { border-color: #8b5cf6; background: rgba(139,92,246,0.15); color: #c4b5fd; }

        /* Mode toggle */
        .mode-toggle { display: flex; gap: 8px; }
        .mode-btn {
            flex: 1; padding: 10px; border: 2px solid #475569; border-radius: 10px;
            background: transparent; color: #94a3b8; font-weight: 700; font-size: 0.85rem;
            cursor: pointer; transition: 0.2s; text-align: center;
        }
        .mode-btn.active { border-color: #3b82f6; background: rgba(59,130,246,0.15); color: #93c5fd; }

        /* Documents section */
        .doc-card {
            background: #0f172a; border: 1px solid #334155; border-radius: 8px;
            padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        .doc-card .doc-info { flex: 1; }
        .doc-card .doc-title { font-weight: 700; font-size: 0.9rem; }
        .doc-card .doc-type { font-size: 0.7rem; color: #64748b; }
        .doc-card .doc-del {
            background: transparent; border: none; color: #64748b; font-size: 1rem;
            cursor: pointer; padding: 4px 8px;
        }
        .doc-card .doc-del:hover { color: #ef4444; }

        .doc-form {
            background: #1a1a2e; border: 2px solid #8b5cf6; border-radius: 12px;
            padding: 16px; margin-bottom: 12px; display: none;
        }

        /* Questions section */
        .questions-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
        }
        .questions-header h3 { font-size: 1.1rem; }
        .questions-count { font-size: 0.85rem; color: #64748b; }

        .add-btns { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
        .add-btn {
            flex: 1; min-width: 100px; padding: 10px 8px; border: 2px dashed #475569; border-radius: 10px;
            background: transparent; color: #94a3b8; font-weight: 700; font-size: 0.8rem;
            cursor: pointer; transition: 0.2s; text-align: center;
        }
        .add-btn:hover { border-color: #3b82f6; color: #3b82f6; background: rgba(59,130,246,0.05); }

        /* Question cards */
        .q-card {
            background: #1e293b; border: 1px solid #334155; border-radius: 12px;
            padding: 16px; margin-bottom: 10px; position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .q-card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        .q-card-num { font-weight: 900; font-size: 1rem; color: #3b82f6; }
        .q-card-type-badge {
            display: inline-block; padding: 3px 8px; border-radius: 6px;
            font-size: 0.7rem; font-weight: 700; margin-left: 8px;
        }
        .type-qcm_single { background: #3b82f6; color: white; }
        .type-qcm_multi { background: #06b6d4; color: white; }
        .type-vf { background: #8b5cf6; color: white; }
        .type-mot { background: #f59e0b; color: white; }
        .type-nombre { background: #22c55e; color: white; }

        .q-card-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .q-card-meta span {
            font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: 600;
        }
        .qm-pts { background: #ede9fe; color: #5b21b6; }
        .qm-comp { background: #dbeafe; color: #1e40af; }
        .qm-doc { background: #fef3c7; color: #92400e; }

        .q-card-actions { display: flex; gap: 4px; }
        .q-card-actions button {
            background: #0f172a; border: 1px solid #475569; color: #94a3b8;
            width: 30px; height: 30px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 0.85rem;
            transition: 0.2s;
        }
        .q-card-actions button:hover { background: #334155; color: white; }
        .q-card-actions button.btn-del:hover { background: #ef4444; color: white; }
        .q-card-actions button.btn-edit:hover { background: #3b82f6; color: white; }

        .q-card-question { font-size: 0.95rem; font-weight: 600; color: #e2e8f0; margin-bottom: 8px; }
        .q-card-choices { display: flex; flex-wrap: wrap; gap: 6px; }
        .q-card-choice {
            padding: 4px 10px; border-radius: 6px; font-size: 0.8rem;
            background: #0f172a; color: #94a3b8; border: 1px solid #334155;
        }
        .q-card-choice.correct { background: #166534; color: #bbf7d0; border-color: #22c55e; }
        .q-card-answer { font-size: 0.85rem; color: #22c55e; font-weight: 600; }
        .q-card-correction { font-size: 0.75rem; color: #64748b; margin-top: 6px; font-style: italic; }

        /* Question add form */
        .q-form {
            background: #1a1a2e; border: 2px solid #3b82f6; border-radius: 12px;
            padding: 20px; margin-bottom: 12px; display: none;
        }
        .q-form h4 { font-size: 0.95rem; margin-bottom: 14px; color: #93c5fd; }
        .q-form .form-input, .q-form .form-textarea { background: #0f172a; }
        .q-form-actions { display: flex; gap: 8px; margin-top: 14px; }
        .btn-save-q {
            flex: 1; padding: 10px; background: #22c55e; color: white;
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
        }
        .btn-save-q:hover { opacity: 0.85; }
        .btn-cancel-q {
            padding: 10px 20px; background: #334155; color: #94a3b8;
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
        }
        .btn-cancel-q:hover { background: #475569; color: white; }

        /* Common question fields (points, competence, correction, explication) */
        .q-extra-fields {
            border-top: 1px solid #334155; margin-top: 14px; padding-top: 14px;
        }

        /* Radio/checkbox custom */
        .radio-row, .check-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .radio-row input[type="radio"], .check-row input[type="checkbox"] { accent-color: #22c55e; width: 18px; height: 18px; }
        .radio-row input[type="text"], .check-row input[type="text"] { flex: 1; }
        .radio-row .remove-choice, .check-row .remove-choice {
            background: transparent; border: none; color: #ef4444; font-size: 1.2rem;
            cursor: pointer; padding: 0 4px; opacity: 0.5;
        }
        .radio-row .remove-choice:hover, .check-row .remove-choice:hover { opacity: 1; }
        .btn-add-choice {
            padding: 6px 12px; background: #1e293b; border: 1px dashed #475569;
            color: #64748b; border-radius: 6px; font-size: 0.8rem; cursor: pointer; margin-top: 4px;
        }
        .btn-add-choice:hover { border-color: #3b82f6; color: #3b82f6; }

        /* VF buttons */
        .vf-toggle { display: flex; gap: 8px; }
        .vf-btn {
            flex: 1; padding: 12px; border: 2px solid #475569; border-radius: 10px;
            background: transparent; color: #94a3b8; font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: 0.2s;
        }
        .vf-btn.selected-true { border-color: #22c55e; background: rgba(34,197,94,0.15); color: #22c55e; }
        .vf-btn.selected-false { border-color: #ef4444; background: rgba(239,68,68,0.15); color: #ef4444; }

        /* Validation banner */
        .validation-banner {
            background: #7f1d1d; border: 1px solid #ef4444; border-radius: 10px;
            padding: 14px 18px; display: none;
        }
        .validation-banner h4 { color: #fca5a5; font-size: 0.9rem; margin-bottom: 8px; }
        .validation-banner ul { list-style: none; }
        .validation-banner li { color: #fca5a5; font-size: 0.85rem; margin-bottom: 4px; }
        .validation-banner li::before { content: "‚ö†Ô∏è "; }

        /* Bottom actions */
        .bottom-actions {
            display: flex; gap: 10px; margin-top: 20px; padding-top: 20px;
            border-top: 1px solid #334155;
        }
        .btn-save-eval {
            flex: 1; padding: 14px; background: #3b82f6; color: white;
            border: none; border-radius: 10px; font-weight: 800; font-size: 1rem;
            cursor: pointer; transition: 0.2s;
        }
        .btn-save-eval:hover { background: #2563eb; }
        .btn-publish-eval {
            padding: 14px 24px; background: #22c55e; color: white;
            border: none; border-radius: 10px; font-weight: 800; font-size: 1rem;
            cursor: pointer; transition: 0.2s;
        }
        .btn-publish-eval:hover { background: #16a34a; }
        .btn-delete-eval {
            padding: 14px 20px; background: #7f1d1d; color: #fca5a5;
            border: none; border-radius: 10px; font-weight: 700; font-size: 0.9rem;
            cursor: pointer; transition: 0.2s;
        }
        .btn-delete-eval:hover { background: #ef4444; color: white; }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; background: #22c55e; color: white;
            border-radius: 10px; font-weight: 700; font-size: 0.95rem;
            z-index: 1000; display: none; animation: fadeIn 0.3s;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .info-text { font-size: 0.75rem; color: #64748b; font-style: italic; margin-top: 4px; }
        .q-card.editing { border-color: #f59e0b; box-shadow: 0 0 12px rgba(245,158,11,0.15); }
        .q-form.edit-mode { border-color: #f59e0b; }
        .q-form.edit-mode h4 { color: #fbbf24; }

        /* Points total display */
        .points-total {
            font-size: 0.85rem; padding: 6px 12px; border-radius: 8px; font-weight: 700;
        }
        .points-ok { background: rgba(34,197,94,0.15); color: #22c55e; }
        .points-warn { background: rgba(245,158,11,0.15); color: #f59e0b; }
        .points-err { background: rgba(239,68,68,0.15); color: #ef4444; }

        /* === FLOW MODE === */
        .flow-segment-doc {
            border-left: 4px solid var(--seg-color, #64748b);
            margin-bottom: 4px; padding-left: 0;
            border-radius: 8px;
        }
        .flow-doc-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; background: #1e293b; border-radius: 8px;
            margin-bottom: 8px; border-left: 4px solid var(--seg-color, #64748b);
        }
        .flow-doc-header .flow-doc-info {
            display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0;
        }
        .flow-doc-header .flow-doc-icon {
            font-size: 1.3rem; flex-shrink: 0;
        }
        .flow-doc-header .flow-doc-title {
            font-weight: 700; font-size: 0.95rem; color: #f1f5f9;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .flow-doc-header .flow-doc-type {
            font-size: 0.7rem; color: #94a3b8; margin-left: 8px;
        }
        .flow-doc-header .flow-doc-actions { display: flex; gap: 4px; flex-shrink: 0; }
        .flow-doc-header .flow-doc-actions button {
            background: #0f172a; border: 1px solid #475569; color: #94a3b8;
            width: 30px; height: 30px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 0.85rem;
            transition: 0.2s;
        }
        .flow-doc-header .flow-doc-actions button:hover { background: #334155; color: white; }
        .flow-doc-header .flow-doc-actions button.btn-del:hover { background: #ef4444; color: white; }

        .flow-add-btns {
            display: flex; gap: 6px; margin: 8px 0 12px 0; flex-wrap: wrap;
        }
        .flow-add-btns .add-btn {
            padding: 7px 12px; font-size: 0.75rem; min-width: 70px; flex: 0;
        }

        .flow-orphan-docs {
            border: 2px dashed #f59e0b; border-radius: 10px; padding: 14px;
            margin-top: 12px; background: rgba(245, 158, 11, 0.05);
        }
        .flow-orphan-docs .orphan-title {
            font-size: 0.85rem; color: #f59e0b; font-weight: 700; margin-bottom: 8px;
        }

        .flow-section-label {
            font-size: 0.7rem; color: #64748b; text-transform: uppercase;
            letter-spacing: 1px; margin: 16px 0 6px 0; display: flex; align-items: center; gap: 8px;
        }
        .flow-section-label::after {
            content: ''; flex: 1; height: 1px; background: #334155;
        }
        /* === HAMBURGER MENU INFRASTRUCTURE === */
        .menu-overlay { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.55); backdrop-filter:blur(2px); z-index:999; }
        .menu-btn { display:none; border:none; background:#1e293b; color:#fff; width:44px; height:44px; border-radius:12px; font-size:20px; cursor:pointer; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
        body.menu-open #sidebar { transform:translateX(0); }
        body.menu-open .menu-overlay { display:block; }
        .close-sidebar-btn { display:none; }

        /* === MOBILE 768px === */
        @media (max-width:768px) {
            body { height:auto; overflow:auto; display:block; }
            #sidebar { position:fixed; top:0; left:0; bottom:0; height:100vh; width:min(86vw,320px); min-width:0; transform:translateX(-110%); transition:transform 0.25s ease; z-index:1000; overflow-y:auto; }
            #main { padding:16px; min-height:100vh; }
            .menu-btn { display:inline-flex; margin-bottom:12px; }
            .close-sidebar-btn { display:block; position:absolute; top:15px; right:15px; background:none; border:none; color:white; font-size:24px; cursor:pointer; z-index:1002; }
            .form-row { flex-direction:column; gap:10px; }
            .add-btns { gap:8px; }
            .add-btn { min-width:calc(50% - 8px); }
            .bottom-actions { flex-direction:column; gap:8px; }
            .btn-save-eval, .btn-publish-eval, .btn-delete-eval { width:100%; text-align:center; }
            .q-card { padding:12px; }
            .q-form { padding:14px; }
            .bareme-toggle { flex-wrap:wrap; }
            .doc-form { padding:12px; }
        }

        /* === PHONE 480px === */
        @media (max-width:480px) {
            #main { padding:10px; }
            .add-btn { min-width:100%; }
        }
    </style>
</head>
<body>

<!-- Menu overlay -->
<div id="menuOverlay" class="menu-overlay" onclick="closeMenu()"></div>

<!-- SIDEBAR -->
<div id="sidebar">
    <button class="close-sidebar-btn" onclick="closeMenu()">‚úï</button>
    <div class="sidebar-header">
        <h2>üìã Editeur d'Eval</h2>
        <a href="index.html">‚Üê Cockpit</a>
    </div>

    <div class="sidebar-section">
        <button id="btn-new-eval" onclick="newEval()">+ Nouvelle evaluation</button>
    </div>

    <div class="sidebar-section">
        <label>Mes evaluations (<span id="eval-count">0</span>)</label>
        <div class="eval-list" id="eval-list"></div>
    </div>
</div>

<!-- MAIN -->
<div id="main">
    <button id="menuBtn" class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <!-- Empty state -->
    <div id="main-empty">
        <div class="big-icon">üìã</div>
        <h2 style="margin-bottom:8px;">Editeur d'Evaluations</h2>
        <p>Cree une nouvelle evaluation ou selectionne-en une dans la liste.</p>
    </div>

    <!-- Editor -->
    <div id="main-editor">
        <!-- Metadonnees -->
        <div class="meta-card">
            <h3>Informations de l'evaluation</h3>
            <div class="form-group" style="margin-bottom:12px;">
                <label>Titre *</label>
                <input type="text" class="form-input" id="eval-titre" placeholder="Ex: Evaluation Module A2 Le sommeil">
            </div>
            <div class="form-row" style="margin-bottom:12px;">
                <div class="form-group">
                    <label>Classe</label>
                    <select class="form-select" id="eval-classe">
                        <option value="">‚Äî Toutes les classes ‚Äî</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Module</label>
                    <select class="form-select" id="eval-module" disabled>
                        <option value="">‚Äî Choisir une classe d'abord ‚Äî</option>
                    </select>
                </div>
            </div>
            <div class="form-row" style="margin-bottom:12px;">
                <div class="form-group">
                    <label>Bareme</label>
                    <div class="bareme-toggle">
                        <button class="bareme-btn" id="bareme-10" onclick="setBareme(10)">/ 10</button>
                        <button class="bareme-btn active" id="bareme-20" onclick="setBareme(20)">/ 20</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Timer (0 = pas de limite)</label>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <input type="number" class="form-input" id="eval-timer" value="0" min="0" max="120" step="5" style="width:80px; text-align:center;">
                        <span style="color:#64748b; font-size:0.85rem;">minutes</span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Mode</label>
                <div class="mode-toggle">
                    <button class="mode-btn active" id="mode-libre" onclick="setModeEval('libre')">üìñ Libre (a son rythme)</button>
                    <button class="mode-btn" id="mode-sync" onclick="setModeEval('synchronise')">üë®‚Äçüè´ Synchronise (en classe)</button>
                </div>
            </div>
        </div>

        <!-- Contenu de l'evaluation (flux lineaire : documents + questions) -->
        <div>
            <div class="questions-header">
                <h3>Contenu de l'evaluation</h3>
                <div style="display:flex; align-items:center; gap:12px;">
                    <span class="points-total" id="points-total">0 pts</span>
                    <span class="questions-count" id="q-count">0 question(s)</span>
                </div>
            </div>

            <!-- Doc form (hidden by default, shown inline) -->
            <div class="doc-form" id="doc-form">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Titre du document</label>
                    <input type="text" class="form-input" id="doc-titre" placeholder="Ex: Document 1 - Le cycle du sommeil">
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Type</label>
                    <select class="form-select" id="doc-type">
                        <option value="text">Texte</option>
                        <option value="image">Image (URL)</option>
                        <option value="video">Video (URL YouTube)</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label id="doc-content-label">Contenu du texte</label>
                    <textarea class="form-textarea" id="doc-content" placeholder="Collez le texte ici..." rows="4"></textarea>
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label id="doc-description-label">Description (optionnel)</label>
                    <textarea class="form-textarea" id="doc-description" placeholder="Ajoutez une description ou un texte sous le document..." rows="2"></textarea>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-save-q" id="btn-save-doc" onclick="saveDocument()" style="flex:1;">Ajouter le document</button>
                    <button class="btn-cancel-q" onclick="hideDocForm()">Annuler</button>
                </div>
            </div>

            <!-- QCM Single Form -->
            <div class="q-form" id="form-qcm_single">
                <h4>Nouvelle question QCM (choix unique)</h4>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Question</label>
                    <textarea class="form-textarea" id="qcm_single-question" placeholder="Tapez la question..."></textarea>
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Reponses (cochez la bonne)</label>
                    <div id="qcm_single-choices"></div>
                    <button class="btn-add-choice" id="btn-add-choice-single" onclick="addChoiceSingle()">+ Ajouter un choix</button>
                </div>
                <div class="q-extra-fields">
                    <div class="form-row" style="margin-bottom:10px;">
                        <div class="form-group">
                            <label>Points</label>
                            <input type="number" class="form-input" id="qcm_single-points" value="1" min="0.5" step="0.5" style="width:80px;">
                        </div>
                        <div class="form-group">
                            <label>Competence</label>
                            <select class="form-select" id="qcm_single-competence"></select>
                        </div>
                        <div class="form-group">
                            <label>Document associe</label>
                            <select class="form-select" id="qcm_single-docref"><option value="">‚Äî Aucun ‚Äî</option></select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label>Correction (affichee a l'eleve)</label>
                        <textarea class="form-textarea" id="qcm_single-correction" placeholder="Explication de la bonne reponse..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Explication pedagogique</label>
                        <textarea class="form-textarea" id="qcm_single-explication" placeholder="Explication detaillee..."></textarea>
                    </div>
                </div>
                <div class="q-form-actions">
                    <button class="btn-save-q" onclick="saveQuestion('qcm_single')">Ajouter la question</button>
                    <button class="btn-cancel-q" onclick="hideAddForm()">Annuler</button>
                </div>
            </div>

            <!-- QCM Multi Form -->
            <div class="q-form" id="form-qcm_multi">
                <h4>Nouvelle question QCM (choix multiples)</h4>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Question</label>
                    <textarea class="form-textarea" id="qcm_multi-question" placeholder="Tapez la question..."></textarea>
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Reponses (cochez toutes les bonnes)</label>
                    <div id="qcm_multi-choices"></div>
                    <button class="btn-add-choice" id="btn-add-choice-multi" onclick="addChoiceMulti()">+ Ajouter un choix</button>
                </div>
                <div class="q-extra-fields">
                    <div class="form-row" style="margin-bottom:10px;">
                        <div class="form-group">
                            <label>Points</label>
                            <input type="number" class="form-input" id="qcm_multi-points" value="2" min="0.5" step="0.5" style="width:80px;">
                        </div>
                        <div class="form-group">
                            <label>Competence</label>
                            <select class="form-select" id="qcm_multi-competence"></select>
                        </div>
                        <div class="form-group">
                            <label>Document associe</label>
                            <select class="form-select" id="qcm_multi-docref"><option value="">‚Äî Aucun ‚Äî</option></select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label>Correction</label>
                        <textarea class="form-textarea" id="qcm_multi-correction" placeholder="Explication de la bonne reponse..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Explication pedagogique</label>
                        <textarea class="form-textarea" id="qcm_multi-explication" placeholder="Explication detaillee..."></textarea>
                    </div>
                </div>
                <div class="q-form-actions">
                    <button class="btn-save-q" onclick="saveQuestion('qcm_multi')">Ajouter la question</button>
                    <button class="btn-cancel-q" onclick="hideAddForm()">Annuler</button>
                </div>
            </div>

            <!-- VF Form -->
            <div class="q-form" id="form-vf">
                <h4>Nouvelle question Vrai / Faux</h4>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Question (affirmation)</label>
                    <textarea class="form-textarea" id="vf-question" placeholder="Tapez une affirmation..."></textarea>
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Bonne reponse</label>
                    <div class="vf-toggle">
                        <button class="vf-btn selected-true" id="vf-true" onclick="setVF(true)">Vrai</button>
                        <button class="vf-btn" id="vf-false" onclick="setVF(false)">Faux</button>
                    </div>
                </div>
                <div class="q-extra-fields">
                    <div class="form-row" style="margin-bottom:10px;">
                        <div class="form-group">
                            <label>Points</label>
                            <input type="number" class="form-input" id="vf-points" value="1" min="0.5" step="0.5" style="width:80px;">
                        </div>
                        <div class="form-group">
                            <label>Competence</label>
                            <select class="form-select" id="vf-competence"></select>
                        </div>
                        <div class="form-group">
                            <label>Document associe</label>
                            <select class="form-select" id="vf-docref"><option value="">‚Äî Aucun ‚Äî</option></select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label>Correction</label>
                        <textarea class="form-textarea" id="vf-correction" placeholder="Explication..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Explication pedagogique</label>
                        <textarea class="form-textarea" id="vf-explication" placeholder="Explication detaillee..."></textarea>
                    </div>
                </div>
                <div class="q-form-actions">
                    <button class="btn-save-q" onclick="saveQuestion('vf')">Ajouter la question</button>
                    <button class="btn-cancel-q" onclick="hideAddForm()">Annuler</button>
                </div>
            </div>

            <!-- Mot Form -->
            <div class="q-form" id="form-mot">
                <h4>Nouvelle question Reponse courte</h4>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Question</label>
                    <textarea class="form-textarea" id="mot-question" placeholder="Tapez la question..."></textarea>
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Reponse attendue (1-2 mots)</label>
                    <input type="text" class="form-input" id="mot-reponse" placeholder="Ex: melatonine">
                    <div class="info-text">Les accents et majuscules seront toleres automatiquement.</div>
                </div>
                <div class="q-extra-fields">
                    <div class="form-row" style="margin-bottom:10px;">
                        <div class="form-group">
                            <label>Points</label>
                            <input type="number" class="form-input" id="mot-points" value="1" min="0.5" step="0.5" style="width:80px;">
                        </div>
                        <div class="form-group">
                            <label>Competence</label>
                            <select class="form-select" id="mot-competence"></select>
                        </div>
                        <div class="form-group">
                            <label>Document associe</label>
                            <select class="form-select" id="mot-docref"><option value="">‚Äî Aucun ‚Äî</option></select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label>Correction</label>
                        <textarea class="form-textarea" id="mot-correction" placeholder="Explication..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Explication pedagogique</label>
                        <textarea class="form-textarea" id="mot-explication" placeholder="Explication detaillee..."></textarea>
                    </div>
                </div>
                <div class="q-form-actions">
                    <button class="btn-save-q" onclick="saveQuestion('mot')">Ajouter la question</button>
                    <button class="btn-cancel-q" onclick="hideAddForm()">Annuler</button>
                </div>
            </div>

            <!-- Nombre Form -->
            <div class="q-form" id="form-nombre">
                <h4>Nouvelle question Nombre</h4>
                <div class="form-group" style="margin-bottom:12px;">
                    <label>Question</label>
                    <textarea class="form-textarea" id="nombre-question" placeholder="Tapez la question..."></textarea>
                </div>
                <div class="form-row" style="margin-bottom:12px;">
                    <div class="form-group">
                        <label>Reponse attendue (nombre)</label>
                        <input type="number" class="form-input" id="nombre-reponse" placeholder="Ex: 8" step="any">
                    </div>
                    <div class="form-group">
                        <label>Tolerance (+/-)</label>
                        <input type="number" class="form-input" id="nombre-tolerance" value="0" min="0" step="any" style="width:80px;">
                        <div class="info-text">0 = reponse exacte requise</div>
                    </div>
                </div>
                <div class="q-extra-fields">
                    <div class="form-row" style="margin-bottom:10px;">
                        <div class="form-group">
                            <label>Points</label>
                            <input type="number" class="form-input" id="nombre-points" value="1" min="0.5" step="0.5" style="width:80px;">
                        </div>
                        <div class="form-group">
                            <label>Competence</label>
                            <select class="form-select" id="nombre-competence"></select>
                        </div>
                        <div class="form-group">
                            <label>Document associe</label>
                            <select class="form-select" id="nombre-docref"><option value="">‚Äî Aucun ‚Äî</option></select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label>Correction</label>
                        <textarea class="form-textarea" id="nombre-correction" placeholder="Explication..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Explication pedagogique</label>
                        <textarea class="form-textarea" id="nombre-explication" placeholder="Explication detaillee..."></textarea>
                    </div>
                </div>
                <div class="q-form-actions">
                    <button class="btn-save-q" onclick="saveQuestion('nombre')">Ajouter la question</button>
                    <button class="btn-cancel-q" onclick="hideAddForm()">Annuler</button>
                </div>
            </div>

            <!-- Questions list -->
            <div id="questions-container"></div>
        </div>

        <!-- Validation banner -->
        <div class="validation-banner" id="validation-banner">
            <h4>Verifications avant publication</h4>
            <ul id="validation-list"></ul>
        </div>

        <!-- Save / Publish / Delete -->
        <div class="bottom-actions">
            <button class="btn-save-eval" onclick="saveEval()">üíæ Sauvegarder (brouillon)</button>
            <button class="btn-publish-eval" onclick="publishEval()">üì¢ Publier</button>
            <button class="btn-save-eval" id="btn-duplicate-eval" onclick="duplicateCurrentEval()" style="display:none; background:#f59e0b; color:#000;">üìã Dupliquer</button>
            <button class="btn-delete-eval" id="btn-delete-eval" onclick="deleteEval()" style="display:none;">üóëÔ∏è Supprimer</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="data_modules.js"></script>
<script>
function toggleMenu(){ document.body.classList.toggle('menu-open'); }
function closeMenu(){ document.body.classList.remove('menu-open'); }
</script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.firebasestorage.app",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // === STATE ===
    let currentEvalId = null;
    let questions = [];
    let documents = [];
    let vfAnswer = true;
    let allEvals = [];
    let editingIndex = -1;
    let editingDocIndex = -1;
    let currentBareme = 20;
    let currentModeEval = 'libre';
    let insertAfterDocRef = null;       // doc context for new questions from flow buttons
    let insertAtIndex = null;           // position in questions[] for insertion

    const DOC_COLORS = ['#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#10b981', '#e11d48'];

    // Compute segments: groups consecutive questions by documentRef
    function computeEditorSegments() {
        const segments = [];
        let currentSeg = null;
        questions.forEach((q, i) => {
            const ref = q.documentRef || null;
            if (!currentSeg || currentSeg.documentRef !== ref) {
                currentSeg = { documentRef: ref, questionIndices: [i] };
                segments.push(currentSeg);
            } else {
                currentSeg.questionIndices.push(i);
            }
        });
        return segments;
    }

    function buildDocColorMap() {
        const map = {};
        let ci = 0;
        documents.forEach(d => {
            map[d.id] = DOC_COLORS[ci % DOC_COLORS.length];
            ci++;
        });
        return map;
    }

    // === POPULATE CLASSE DROPDOWN ===
    function populateClasses() {
        const sel = document.getElementById('eval-classe');
        const classes = window.getListeClassesPourAffichage ? window.getListeClassesPourAffichage() : [];
        classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.label + ' (' + c.niveau.replace(/_/g, ' ') + ')';
            sel.appendChild(opt);
        });
    }
    populateClasses();

    // === CLASSE -> MODULE DYNAMIC ===
    document.getElementById('eval-classe').addEventListener('change', function() {
        const classeId = this.value;
        const modSel = document.getElementById('eval-module');
        modSel.innerHTML = '';

        if (!classeId) {
            modSel.disabled = true;
            modSel.innerHTML = '<option value="">‚Äî Choisir une classe d\'abord ‚Äî</option>';
            populateCompetenceDropdowns(null);
            return;
        }

        modSel.disabled = false;
        modSel.innerHTML = '<option value="">‚Äî Aucun module ‚Äî</option>';

        const classesInGroup = window.getClassesFromGroupe ? window.getClassesFromGroupe(classeId) : [classeId];
        const firstClass = classesInGroup[0];
        const modules = window.getModulesForClasse ? window.getModulesForClasse(firstClass) : [];

        let currentTheme = '';
        modules.forEach(m => {
            if (m.theme !== currentTheme) {
                currentTheme = m.theme;
                const optGroup = document.createElement('optgroup');
                optGroup.label = 'Theme ' + m.theme;
                modSel.appendChild(optGroup);
            }
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = m.id + ' ‚Äî ' + m.titre;
            const lastGroup = modSel.querySelector('optgroup:last-of-type');
            if (lastGroup) lastGroup.appendChild(opt);
            else modSel.appendChild(opt);
        });

        // Update competence dropdowns based on class niveau
        populateCompetenceDropdowns(classeId);
    });

    // === COMPETENCE DROPDOWNS ===
    function populateCompetenceDropdowns(classeId) {
        let comps = [];
        if (classeId && window.getCompetencesForClasse) {
            const classesInGroup = window.getClassesFromGroupe ? window.getClassesFromGroupe(classeId) : [classeId];
            comps = window.getCompetencesForClasse(classesInGroup[0]) || [];
        }
        if (comps.length === 0 && window.COMPETENCES_PSE) {
            // Default to CAP competences
            comps = window.COMPETENCES_PSE['CAP'] || [];
        }

        const selectors = document.querySelectorAll('[id$="-competence"]');
        selectors.forEach(sel => {
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">‚Äî Choisir ‚Äî</option>';
            comps.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.id + ' ‚Äî ' + c.titre;
                sel.appendChild(opt);
            });
            if (currentVal) sel.value = currentVal;
        });
    }
    // Initial population with default comps
    populateCompetenceDropdowns(null);

    // === DOCUMENT REF DROPDOWNS ===
    function updateDocRefDropdowns() {
        const selectors = document.querySelectorAll('[id$="-docref"]');
        selectors.forEach(sel => {
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">‚Äî Aucun ‚Äî</option>';
            documents.forEach((d, i) => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.textContent = d.titre || ('Document ' + (i + 1));
                sel.appendChild(opt);
            });
            if (currentVal) sel.value = currentVal;
        });
    }

    // === BAREME TOGGLE ===
    window.setBareme = function(val) {
        currentBareme = val;
        document.getElementById('bareme-10').className = 'bareme-btn' + (val === 10 ? ' active' : '');
        document.getElementById('bareme-20').className = 'bareme-btn' + (val === 20 ? ' active' : '');
        updatePointsTotal();
    };

    // === MODE TOGGLE ===
    window.setModeEval = function(mode) {
        currentModeEval = mode;
        document.getElementById('mode-libre').className = 'mode-btn' + (mode === 'libre' ? ' active' : '');
        document.getElementById('mode-sync').className = 'mode-btn' + (mode === 'synchronise' ? ' active' : '');
    };

    // === DOCUMENTS MANAGEMENT ===
    window.showDocForm = function() {
        editingDocIndex = -1;
        document.getElementById('doc-form').style.display = 'block';
        document.getElementById('doc-titre').value = '';
        document.getElementById('doc-type').value = 'text';
        document.getElementById('doc-content').value = '';
        document.getElementById('doc-description').value = '';
        document.getElementById('btn-save-doc').textContent = 'Ajouter le document';
        updateDocContentLabel();
        document.getElementById('doc-titre').focus();
    };

    window.hideDocForm = function() {
        editingDocIndex = -1;
        document.getElementById('doc-form').style.display = 'none';
    };

    window.editDocument = function(index) {
        const d = documents[index];
        editingDocIndex = index;
        document.getElementById('doc-form').style.display = 'block';
        document.getElementById('doc-titre').value = d.titre;
        document.getElementById('doc-type').value = d.type;
        updateDocContentLabel();
        document.getElementById('doc-content').value = d.content;
        document.getElementById('doc-description').value = d.description || '';
        document.getElementById('btn-save-doc').textContent = 'Modifier le document';
        document.getElementById('doc-titre').focus();
    };

    document.getElementById('doc-type').addEventListener('change', updateDocContentLabel);
    function updateDocContentLabel() {
        const type = document.getElementById('doc-type').value;
        if (type === 'video') {
            document.getElementById('doc-content-label').textContent = 'URL YouTube';
            document.getElementById('doc-content').placeholder = 'https://www.youtube.com/watch?v=...';
        } else if (type === 'image') {
            document.getElementById('doc-content-label').textContent = 'URL de l\'image';
            document.getElementById('doc-content').placeholder = 'https://...';
        } else {
            document.getElementById('doc-content-label').textContent = 'Contenu du texte';
            document.getElementById('doc-content').placeholder = 'Collez le texte ici...';
        }
        const descLabel = document.getElementById('doc-description-label');
        if (descLabel) {
            descLabel.textContent = type === 'image' ? 'Texte sous l\'image (optionnel)' : (type === 'video' ? 'Description de la video (optionnel)' : 'Description supplementaire (optionnel)');
        }
    }

    window.saveDocument = function() {
        const titre = document.getElementById('doc-titre').value.trim();
        const type = document.getElementById('doc-type').value;
        const content = document.getElementById('doc-content').value.trim();
        const description = document.getElementById('doc-description').value.trim();
        if (!titre) { alert('Donne un titre au document !'); return; }
        if (!content) { alert('Ajoute le contenu !'); return; }

        if (editingDocIndex >= 0 && editingDocIndex < documents.length) {
            // Mode edition : mettre a jour le document existant (meme ID)
            documents[editingDocIndex].titre = titre;
            documents[editingDocIndex].type = type;
            documents[editingDocIndex].content = content;
            documents[editingDocIndex].description = description;
        } else {
            // Mode ajout : creer un nouveau document (toujours en fin de liste)
            const newDoc = {
                id: 'doc_' + Date.now().toString(36),
                type, titre, content, description
            };
            documents.push(newDoc);
            insertAfterDocRef = newDoc.id;
        }
        editingDocIndex = -1;
        updateDocRefDropdowns();
        hideDocForm();
        renderFlow();
    };

    window.deleteDocument = function(index) {
        if (!confirm('Supprimer ce document ? Les questions liees deviendront independantes.')) return;
        const docId = documents[index].id;
        documents.splice(index, 1);
        // Remove references from questions
        questions.forEach(q => {
            if (q.documentRef === docId) q.documentRef = null;
        });
        updateDocRefDropdowns();
        renderFlow();
    };

    // renderFlow() ‚Äî unified rendering of documents + questions in a linear flow
    function renderFlow() {
        const container = document.getElementById('questions-container');
        container.innerHTML = '';
        document.getElementById('q-count').textContent = questions.length + ' question(s)';

        const segments = computeEditorSegments();
        const colorMap = buildDocColorMap();
        const typeLabels = { qcm_single: 'QCM', qcm_multi: 'QCM Multi', vf: 'V/F', mot: 'Mot', nombre: 'Nombre' };
        const qTypes = [
            { t: 'qcm_single', label: '+ QCM' },
            { t: 'qcm_multi', label: '+ QCM Multi' },
            { t: 'vf', label: '+ V/F' },
            { t: 'mot', label: '+ Mot' },
            { t: 'nombre', label: '+ Nombre' }
        ];
        const referencedDocIds = new Set();
        questions.forEach(q => { if (q.documentRef) referencedDocIds.add(q.documentRef); });

        // Render each segment
        segments.forEach((seg, si) => {
            const docRef = seg.documentRef;
            const docObj = docRef ? documents.find(d => d.id === docRef) : null;
            const color = docObj ? (colorMap[docObj.id] || '#64748b') : '#64748b';

            if (docObj) {
                // Document header
                container.appendChild(buildDocHeader(docObj, color));
            } else if (!docRef && si > 0) {
                // Independent questions label
                const label = document.createElement('div');
                label.className = 'flow-section-label';
                label.textContent = 'Questions independantes';
                container.appendChild(label);
            }

            // Render question cards for this segment
            seg.questionIndices.forEach(qi => {
                const q = questions[qi];
                const card = buildQuestionCard(q, qi, typeLabels, color, docRef);
                container.appendChild(card);
            });

            // Contextual add-question buttons ONLY for document-linked segments
            if (docRef) {
                const lastQIndex = seg.questionIndices[seg.questionIndices.length - 1];
                const addBtnsRow = document.createElement('div');
                addBtnsRow.className = 'flow-add-btns';
                qTypes.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'add-btn';
                    btn.textContent = item.label;
                    btn.onclick = () => showAddForm(item.t, docRef, lastQIndex + 1);
                    addBtnsRow.appendChild(btn);
                });
                container.appendChild(addBtnsRow);
            }
        });

        // Orphan documents: show as normal doc headers with add-question buttons (in-flow, not as errors)
        const orphanDocs = documents.filter(d => !referencedDocIds.has(d.id));
        orphanDocs.forEach(d => {
            const color = colorMap[d.id] || '#64748b';
            container.appendChild(buildDocHeader(d, color));

            // Add-question buttons linked to this orphan document
            const addBtnsRow = document.createElement('div');
            addBtnsRow.className = 'flow-add-btns';
            qTypes.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'add-btn';
                btn.textContent = item.label;
                btn.onclick = () => showAddForm(item.t, d.id, questions.length);
                addBtnsRow.appendChild(btn);
            });
            container.appendChild(addBtnsRow);
        });

        // === BOTTOM ADD SECTION (always present) ===
        const bottomSection = document.createElement('div');
        bottomSection.style.cssText = 'margin-top: 20px; padding-top: 16px; border-top: 2px dashed #334155;';

        // "Add document" button
        const addDocBtn = document.createElement('button');
        addDocBtn.className = 'add-btn';
        addDocBtn.style.cssText = 'width: 100%; margin-bottom: 10px; padding: 12px; font-size: 0.85rem; border-color: #7c3aed; color: #a78bfa;';
        addDocBtn.textContent = '+ Ajouter un document';
        addDocBtn.onclick = () => showDocForm();
        bottomSection.appendChild(addDocBtn);

        // "Add question" buttons row (independent questions at end)
        const addQRow = document.createElement('div');
        addQRow.className = 'flow-add-btns';
        qTypes.forEach(item => {
            const btn = document.createElement('button');
            btn.className = 'add-btn';
            btn.textContent = item.label;
            btn.onclick = () => showAddForm(item.t, null, null);
            addQRow.appendChild(btn);
        });
        bottomSection.appendChild(addQRow);
        container.appendChild(bottomSection);

        updatePointsTotal();
    }

    // Helper: build a document header element for the flow
    function buildDocHeader(docObj, color) {
        const docIndex = documents.indexOf(docObj);
        const header = document.createElement('div');
        header.className = 'flow-doc-header';
        header.style.setProperty('--seg-color', color);
        const typeIcon = docObj.type === 'image' ? 'üñºÔ∏è' : (docObj.type === 'video' ? 'üé¨' : 'üìÑ');
        const descPreview = docObj.description ? ' ‚Äî ' + escHtml(docObj.description.substring(0, 40)) + (docObj.description.length > 40 ? '...' : '') : '';
        header.innerHTML = '<div class="flow-doc-info">' +
            '<span class="flow-doc-icon">' + typeIcon + '</span>' +
            '<span class="flow-doc-title">' + escHtml(docObj.titre) + '</span>' +
            '<span class="flow-doc-type">(' + docObj.type + descPreview + ')</span>' +
            '</div>' +
            '<div class="flow-doc-actions">' +
            '<button onclick="editDocument(' + docIndex + ')" title="Modifier">‚úèÔ∏è</button>' +
            '<button class="btn-del" onclick="deleteDocument(' + docIndex + ')" title="Supprimer">&times;</button>' +
            '</div>';
        return header;
    }

    function escHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function buildQuestionCard(q, i, typeLabels, borderColor, docRef) {
        const card = document.createElement('div');
        card.className = 'q-card';
        card.dataset.qIndex = i;
        if (docRef) {
            card.style.borderLeftColor = borderColor;
        }

        const typeLabel = typeLabels[q.type] || q.type;
        const typeClass = 'type-' + q.type;

        // Meta badges
        let metaHtml = '<div class="q-card-meta">';
        if (q.points) metaHtml += '<span class="qm-pts">' + q.points + ' pt' + (q.points > 1 ? 's' : '') + '</span>';
        if (q.competence) metaHtml += '<span class="qm-comp">' + q.competence + '</span>';
        if (q.documentRef) {
            const docObj = documents.find(d => d.id === q.documentRef);
            if (docObj) metaHtml += '<span class="qm-doc">' + escHtml(docObj.titre) + '</span>';
        }
        metaHtml += '</div>';

        // Answer display
        let body = '';
        if (q.type === 'qcm_single') {
            body = '<div class="q-card-choices">';
            (q.choices || []).forEach((c, ci) => {
                body += '<span class="q-card-choice' + (ci === q.correct ? ' correct' : '') + '">' + escHtml(c) + '</span>';
            });
            body += '</div>';
        } else if (q.type === 'qcm_multi') {
            body = '<div class="q-card-choices">';
            (q.choices || []).forEach((c, ci) => {
                body += '<span class="q-card-choice' + ((q.correct || []).includes(ci) ? ' correct' : '') + '">' + escHtml(c) + '</span>';
            });
            body += '</div>';
        } else if (q.type === 'vf') {
            body = '<div class="q-card-answer">' + (q.correct ? 'Vrai' : 'Faux') + '</div>';
        } else if (q.type === 'mot') {
            body = '<div class="q-card-answer">Reponse : ' + escHtml(q.correct || q.reponse || '') + '</div>';
        } else if (q.type === 'nombre') {
            body = '<div class="q-card-answer">Reponse : ' + q.correct + (q.tolerance ? ' (+/- ' + q.tolerance + ')' : '') + '</div>';
        }

        if (q.correction) {
            body += '<div class="q-card-correction">' + escHtml(q.correction.substring(0, 80)) + (q.correction.length > 80 ? '...' : '') + '</div>';
        }

        card.innerHTML = '<div class="q-card-header">' +
            '<div><span class="q-card-num">Q' + (i + 1) + '</span><span class="q-card-type-badge ' + typeClass + '">' + typeLabel + '</span></div>' +
            '<div class="q-card-actions">' +
                '<button class="btn-edit" onclick="editQuestion(' + i + ')" title="Modifier">‚úèÔ∏è</button>' +
                '<button onclick="moveQuestion(' + i + ', -1)" title="Monter"' + (i === 0 ? ' disabled style="opacity:0.3"' : '') + '>&#9650;</button>' +
                '<button onclick="moveQuestion(' + i + ', 1)" title="Descendre"' + (i === questions.length - 1 ? ' disabled style="opacity:0.3"' : '') + '>&#9660;</button>' +
                '<button class="btn-del" onclick="deleteQuestion(' + i + ')" title="Supprimer">&times;</button>' +
            '</div></div>' +
            metaHtml +
            '<div class="q-card-question">' + escHtml(q.question) + '</div>' +
            body;

        return card;
    }

    // === LOAD EVAL LIST (real-time) ===
    let pendingLoadId = new URLSearchParams(window.location.search).get('id');
    const qBanque = query(collection(db, "eval_banque"), orderBy("updatedAt", "desc"));
    onSnapshot(qBanque, (snap) => {
        allEvals = [];
        snap.forEach(d => {
            allEvals.push({ id: d.id, ...d.data() });
        });
        renderEvalList();
        // Auto-load eval from URL param ?id=xxx
        if (pendingLoadId) {
            const ev = allEvals.find(e => e.id === pendingLoadId);
            if (ev) loadEval(pendingLoadId);
            pendingLoadId = null;
        }
    });

    function renderEvalList() {
        const container = document.getElementById('eval-list');
        container.innerHTML = '';
        document.getElementById('eval-count').textContent = allEvals.length;

        allEvals.forEach(ev => {
            const div = document.createElement('div');
            div.className = 'eval-list-item' + (ev.id === currentEvalId ? ' active' : '');
            div.onclick = (e) => {
                if (e.target.classList.contains('ei-del')) return;
                loadEval(ev.id);
            };

            const pubBadge = ev.publie
                ? '<span class="ei-badge badge-pub">Publie</span>'
                : '<span class="ei-badge badge-draft">Brouillon</span>';
            const qCountBadge = '<span class="ei-badge badge-qcount">' + (ev.questions ? ev.questions.length : 0) + ' Q</span>';
            const baremeBadge = '<span class="ei-badge badge-bareme">/' + (ev.bareme || 20) + '</span>';
            const classInfo = ev.classeId || 'Toutes';

            div.innerHTML = '<div class="ei-title">' + (ev.titre || 'Sans titre') + '</div>' +
                '<div class="ei-meta">' + pubBadge + qCountBadge + baremeBadge + ' ' + classInfo + '</div>' +
                '<button class="ei-del" style="right:32px;" onclick="duplicateEval(\'' + ev.id + '\', event)" title="Dupliquer">üìã</button>' +
                '<button class="ei-del" onclick="deleteEvalFromSidebar(\'' + ev.id + '\', event)" title="Supprimer">üóëÔ∏è</button>';
            container.appendChild(div);
        });
    }

    // === DELETE EVAL FROM SIDEBAR ===
    window.deleteEvalFromSidebar = async function(evalId, event) {
        event.stopPropagation();
        if (!confirm("Supprimer definitivement cette evaluation ?")) return;

        try {
            await deleteDoc(doc(db, "eval_banque", evalId));
            if (currentEvalId === evalId) {
                currentEvalId = null;
                questions = [];
                documents = [];
                editingIndex = -1;
                document.getElementById('main-editor').style.display = 'none';
                document.getElementById('main-empty').style.display = 'flex';
            }
            showToast('Evaluation supprimee.');
        } catch(e) {
            console.error("Erreur suppression:", e);
            alert("Erreur : " + e.message);
        }
    };

    // === DUPLICATE EVAL ===
    window.duplicateEval = async function(evalId, event) {
        if (event && event.stopPropagation) event.stopPropagation();
        const ev = allEvals.find(e => e.id === evalId);
        if (!ev) return;

        if (!confirm('Dupliquer "' + (ev.titre || 'Sans titre') + '" ?\nLa copie sera en brouillon, sans classe assignee.')) return;

        const newId = 'eval_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 4);
        const newEvalData = {
            titre: (ev.titre || 'Sans titre') + ' (copie)',
            classeId: null,
            moduleId: null,
            niveau: null,
            bareme: ev.bareme || 20,
            timer: ev.timer || 0,
            mode: ev.mode || 'libre',
            documents: ev.documents ? JSON.parse(JSON.stringify(ev.documents)) : [],
            questions: ev.questions ? JSON.parse(JSON.stringify(ev.questions)) : [],
            publie: false,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
        };

        try {
            await setDoc(doc(db, "eval_banque", newId), newEvalData);
            showToast('Evaluation dupliquee ! Choisis la classe et publie.');
            // onSnapshot will update allEvals, then load the new eval
            setTimeout(() => loadEval(newId), 500);
        } catch(e) {
            console.error("Erreur duplication:", e);
            alert("Erreur : " + e.message);
        }
    };

    window.duplicateCurrentEval = function() {
        if (!currentEvalId) return;
        duplicateEval(currentEvalId, null);
    };

    // === NEW EVAL ===
    window.newEval = function() {
        currentEvalId = null;
        questions = [];
        documents = [];
        editingIndex = -1;
        currentBareme = 20;
        currentModeEval = 'libre';

        document.getElementById('eval-titre').value = '';
        document.getElementById('eval-classe').value = '';
        document.getElementById('eval-module').innerHTML = '<option value="">‚Äî Choisir une classe d\'abord ‚Äî</option>';
        document.getElementById('eval-module').disabled = true;
        document.getElementById('eval-timer').value = '0';
        setBareme(20);
        setModeEval('libre');
        document.getElementById('btn-delete-eval').style.display = 'none';
        document.getElementById('btn-duplicate-eval').style.display = 'none';
        document.getElementById('validation-banner').style.display = 'none';
        hideAddForm();
        hideDocForm();
        updateDocRefDropdowns();
        renderFlow();
        showEditor();
        populateCompetenceDropdowns(null);

        document.querySelectorAll('.eval-list-item').forEach(i => i.classList.remove('active'));
    };

    // === LOAD EVAL ===
    window.loadEval = function(evalId) {
        const ev = allEvals.find(e => e.id === evalId);
        if (!ev) return;

        currentEvalId = evalId;
        questions = ev.questions ? JSON.parse(JSON.stringify(ev.questions)) : [];
        documents = ev.documents ? JSON.parse(JSON.stringify(ev.documents)) : [];
        currentBareme = ev.bareme || 20;
        currentModeEval = ev.mode || 'libre';

        document.getElementById('eval-titre').value = ev.titre || '';
        document.getElementById('eval-classe').value = ev.classeId || '';
        document.getElementById('eval-classe').dispatchEvent(new Event('change'));
        setTimeout(() => {
            document.getElementById('eval-module').value = ev.moduleId || '';
        }, 100);

        document.getElementById('eval-timer').value = ev.timer || 0;
        setBareme(currentBareme);
        setModeEval(currentModeEval);

        document.getElementById('btn-delete-eval').style.display = 'block';
        document.getElementById('btn-duplicate-eval').style.display = 'block';
        document.getElementById('validation-banner').style.display = 'none';
        hideAddForm();
        hideDocForm();
        updateDocRefDropdowns();
        renderFlow();
        showEditor();
        renderEvalList();
        if (window.innerWidth <= 768) closeMenu();
    };

    // === SHOW EDITOR ===
    function showEditor() {
        document.getElementById('main-empty').style.display = 'none';
        document.getElementById('main-editor').style.display = 'flex';
    }

    // === QCM SINGLE CHOICES ===
    function resetChoicesSingle() {
        const container = document.getElementById('qcm_single-choices');
        container.innerHTML = '';
        for (let i = 0; i < 2; i++) addChoiceRowSingle(container, i);
        updateRemoveButtonsSingle();
        document.getElementById('btn-add-choice-single').style.display = 'block';
    }

    function addChoiceRowSingle(container, index) {
        const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
        const row = document.createElement('div');
        row.className = 'radio-row';
        row.innerHTML = '<input type="radio" name="qcm_single-correct" value="' + index + '"' + (index === 0 ? ' checked' : '') + '>' +
            '<input type="text" class="form-input" placeholder="Reponse ' + letters[index] + '" data-choice="' + index + '">' +
            '<button class="remove-choice" onclick="removeChoiceSingle(this)" title="Supprimer">&times;</button>';
        container.appendChild(row);
    }

    window.addChoiceSingle = function() {
        const container = document.getElementById('qcm_single-choices');
        if (container.children.length >= 6) return;
        addChoiceRowSingle(container, container.children.length);
        updateRemoveButtonsSingle();
        if (container.children.length >= 6) document.getElementById('btn-add-choice-single').style.display = 'none';
    };

    window.removeChoiceSingle = function(btn) {
        const container = document.getElementById('qcm_single-choices');
        if (container.children.length <= 2) return;
        btn.closest('.radio-row').remove();
        renumberRows(container, 'radio');
        updateRemoveButtonsSingle();
        document.getElementById('btn-add-choice-single').style.display = container.children.length < 6 ? 'block' : 'none';
    };

    function updateRemoveButtonsSingle() {
        const container = document.getElementById('qcm_single-choices');
        const rows = container.querySelectorAll('.radio-row');
        rows.forEach(r => { r.querySelector('.remove-choice').style.display = rows.length > 2 ? 'block' : 'none'; });
    }

    // === QCM MULTI CHOICES ===
    function resetChoicesMulti() {
        const container = document.getElementById('qcm_multi-choices');
        container.innerHTML = '';
        for (let i = 0; i < 2; i++) addChoiceRowMulti(container, i);
        updateRemoveButtonsMulti();
        document.getElementById('btn-add-choice-multi').style.display = 'block';
    }

    function addChoiceRowMulti(container, index) {
        const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
        const row = document.createElement('div');
        row.className = 'check-row';
        row.innerHTML = '<input type="checkbox" name="qcm_multi-correct" value="' + index + '">' +
            '<input type="text" class="form-input" placeholder="Reponse ' + letters[index] + '" data-choice="' + index + '">' +
            '<button class="remove-choice" onclick="removeChoiceMulti(this)" title="Supprimer">&times;</button>';
        container.appendChild(row);
    }

    window.addChoiceMulti = function() {
        const container = document.getElementById('qcm_multi-choices');
        if (container.children.length >= 6) return;
        addChoiceRowMulti(container, container.children.length);
        updateRemoveButtonsMulti();
        if (container.children.length >= 6) document.getElementById('btn-add-choice-multi').style.display = 'none';
    };

    window.removeChoiceMulti = function(btn) {
        const container = document.getElementById('qcm_multi-choices');
        if (container.children.length <= 2) return;
        btn.closest('.check-row').remove();
        renumberRows(container, 'checkbox');
        updateRemoveButtonsMulti();
        document.getElementById('btn-add-choice-multi').style.display = container.children.length < 6 ? 'block' : 'none';
    };

    function updateRemoveButtonsMulti() {
        const container = document.getElementById('qcm_multi-choices');
        const rows = container.querySelectorAll('.check-row');
        rows.forEach(r => { r.querySelector('.remove-choice').style.display = rows.length > 2 ? 'block' : 'none'; });
    }

    // === RENUMBER ROWS (shared) ===
    function renumberRows(container, inputType) {
        const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
        const rows = container.children;
        for (let i = 0; i < rows.length; i++) {
            const inp = rows[i].querySelector('input[type="' + inputType + '"]');
            if (inp) inp.value = i;
            const text = rows[i].querySelector('input[type="text"]');
            if (text) { text.dataset.choice = i; text.placeholder = 'Reponse ' + letters[i]; }
        }
        if (inputType === 'radio' && !container.querySelector('input[type="radio"]:checked')) {
            const first = container.querySelector('input[type="radio"]');
            if (first) first.checked = true;
        }
    }

    // === VF ===
    window.setVF = function(val) {
        vfAnswer = val;
        document.getElementById('vf-true').className = 'vf-btn' + (vfAnswer ? ' selected-true' : '');
        document.getElementById('vf-false').className = 'vf-btn' + (!vfAnswer ? ' selected-false' : '');
    };

    // === SHOW/HIDE ADD FORM ===
    window.showAddForm = function(type, docRef, atIndex) {
        hideAddForm();
        editingIndex = -1;
        insertAfterDocRef = docRef || null;
        insertAtIndex = (typeof atIndex === 'number') ? atIndex : null;

        const form = document.getElementById('form-' + type);
        form.style.display = 'block';
        form.classList.remove('edit-mode');

        const typeLabels = {
            qcm_single: 'QCM (choix unique)',
            qcm_multi: 'QCM (choix multiples)',
            vf: 'Vrai / Faux',
            mot: 'Reponse courte',
            nombre: 'Nombre'
        };
        updateFormTitle(type, 'Nouvelle question ' + typeLabels[type]);
        updateFormButtonText(type, 'Ajouter la question');

        // Reset form
        const qField = document.getElementById(type + '-question');
        if (qField) qField.value = '';

        if (type === 'qcm_single') {
            resetChoicesSingle();
        } else if (type === 'qcm_multi') {
            resetChoicesMulti();
        } else if (type === 'vf') {
            vfAnswer = true;
            setVF(true);
        } else if (type === 'mot') {
            document.getElementById('mot-reponse').value = '';
        } else if (type === 'nombre') {
            document.getElementById('nombre-reponse').value = '';
            document.getElementById('nombre-tolerance').value = '0';
        }

        // Reset extra fields
        const ptsField = document.getElementById(type + '-points');
        if (ptsField) ptsField.value = type === 'qcm_multi' ? '2' : '1';
        const compField = document.getElementById(type + '-competence');
        if (compField) compField.value = '';
        const corrField = document.getElementById(type + '-correction');
        if (corrField) corrField.value = '';
        const explField = document.getElementById(type + '-explication');
        if (explField) explField.value = '';
        // Auto-select the document ref based on flow context
        const docField = document.getElementById(type + '-docref');
        if (docField) docField.value = insertAfterDocRef || '';

        document.querySelectorAll('.q-card').forEach(c => c.classList.remove('editing'));
        if (qField) qField.focus();
    };

    window.hideAddForm = function() {
        editingIndex = -1;
        insertAfterDocRef = null;
        insertAtIndex = null;
        document.querySelectorAll('.q-form').forEach(f => { f.style.display = 'none'; f.classList.remove('edit-mode'); });
        document.querySelectorAll('.q-card').forEach(c => c.classList.remove('editing'));
    };

    function updateFormButtonText(type, text) {
        const form = document.getElementById('form-' + type);
        const btn = form.querySelector('.btn-save-q');
        if (btn) btn.textContent = text;
    }

    function updateFormTitle(type, text) {
        const form = document.getElementById('form-' + type);
        const h4 = form.querySelector('h4');
        if (h4) h4.textContent = text;
    }

    // === EDIT QUESTION ===
    window.editQuestion = function(index) {
        const q = questions[index];
        if (!q) return;

        hideAddForm();
        editingIndex = index;
        const type = q.type;
        const form = document.getElementById('form-' + type);
        form.style.display = 'block';
        form.classList.add('edit-mode');

        updateFormButtonText(type, 'Enregistrer la modification');
        updateFormTitle(type, 'Modifier Q' + (index + 1));

        document.querySelectorAll('.q-card').forEach(c => c.classList.remove('editing'));
        const targetCard = document.querySelector('.q-card[data-q-index="' + index + '"]');
        if (targetCard) targetCard.classList.add('editing');

        // Pre-fill question text
        const qField = document.getElementById(type + '-question');
        if (qField) qField.value = q.question || '';

        // Pre-fill type-specific
        if (type === 'qcm_single') {
            const container = document.getElementById('qcm_single-choices');
            container.innerHTML = '';
            (q.choices || []).forEach((choice, ci) => {
                addChoiceRowSingle(container, ci);
                container.querySelectorAll('input[type="text"]')[ci].value = choice;
                if (ci === q.correct) container.querySelectorAll('input[type="radio"]')[ci].checked = true;
            });
            updateRemoveButtonsSingle();
            document.getElementById('btn-add-choice-single').style.display = (q.choices || []).length < 6 ? 'block' : 'none';
        } else if (type === 'qcm_multi') {
            const container = document.getElementById('qcm_multi-choices');
            container.innerHTML = '';
            (q.choices || []).forEach((choice, ci) => {
                addChoiceRowMulti(container, ci);
                container.querySelectorAll('input[type="text"]')[ci].value = choice;
                if ((q.correct || []).includes(ci)) container.querySelectorAll('input[type="checkbox"]')[ci].checked = true;
            });
            updateRemoveButtonsMulti();
            document.getElementById('btn-add-choice-multi').style.display = (q.choices || []).length < 6 ? 'block' : 'none';
        } else if (type === 'vf') {
            vfAnswer = q.correct;
            setVF(q.correct);
        } else if (type === 'mot') {
            document.getElementById('mot-reponse').value = q.correct || q.reponse || '';
        } else if (type === 'nombre') {
            document.getElementById('nombre-reponse').value = q.correct;
            document.getElementById('nombre-tolerance').value = q.tolerance || 0;
        }

        // Pre-fill extra fields
        const ptsField = document.getElementById(type + '-points');
        if (ptsField) ptsField.value = q.points || 1;
        const compField = document.getElementById(type + '-competence');
        if (compField) compField.value = q.competence || '';
        const corrField = document.getElementById(type + '-correction');
        if (corrField) corrField.value = q.correction || '';
        const explField = document.getElementById(type + '-explication');
        if (explField) explField.value = q.explication || '';
        const docField = document.getElementById(type + '-docref');
        if (docField) docField.value = q.documentRef || '';

        form.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    // === SAVE QUESTION ===
    window.saveQuestion = function(type) {
        // Get question text
        const qField = document.getElementById(type + '-question');
        const questionText = qField ? qField.value.trim() : '';
        if (!questionText) { alert('Ecris la question !'); return; }

        let newQ = { type, question: questionText, id: 'q_' + Date.now().toString(36) };

        // Type-specific
        if (type === 'qcm_single') {
            const choiceInputs = document.querySelectorAll('#qcm_single-choices input[type="text"]');
            const choices = [];
            let hasEmpty = false;
            choiceInputs.forEach(inp => { const v = inp.value.trim(); if (!v) hasEmpty = true; choices.push(v); });
            if (hasEmpty) { alert('Remplis toutes les reponses !'); return; }
            const correctRadio = document.querySelector('input[name="qcm_single-correct"]:checked');
            newQ.choices = choices;
            newQ.correct = parseInt(correctRadio.value);
        } else if (type === 'qcm_multi') {
            const choiceInputs = document.querySelectorAll('#qcm_multi-choices input[type="text"]');
            const choices = [];
            let hasEmpty = false;
            choiceInputs.forEach(inp => { const v = inp.value.trim(); if (!v) hasEmpty = true; choices.push(v); });
            if (hasEmpty) { alert('Remplis toutes les reponses !'); return; }
            const checked = document.querySelectorAll('input[name="qcm_multi-correct"]:checked');
            if (checked.length === 0) { alert('Coche au moins une bonne reponse !'); return; }
            newQ.choices = choices;
            newQ.correct = Array.from(checked).map(c => parseInt(c.value));
        } else if (type === 'vf') {
            newQ.correct = vfAnswer;
        } else if (type === 'mot') {
            const reponse = document.getElementById('mot-reponse').value.trim();
            if (!reponse) { alert('Ecris la reponse attendue !'); return; }
            newQ.correct = reponse;
        } else if (type === 'nombre') {
            const reponse = document.getElementById('nombre-reponse').value;
            if (reponse === '') { alert('Ecris la reponse attendue !'); return; }
            newQ.correct = parseFloat(reponse);
            newQ.tolerance = parseFloat(document.getElementById('nombre-tolerance').value) || 0;
        }

        // Extra fields
        newQ.points = parseFloat(document.getElementById(type + '-points').value) || 1;
        newQ.competence = document.getElementById(type + '-competence').value || '';
        newQ.correction = document.getElementById(type + '-correction').value.trim();
        newQ.explication = document.getElementById(type + '-explication').value.trim();
        newQ.documentRef = document.getElementById(type + '-docref').value || null;

        // If adding from a flow context, force the docRef
        if (editingIndex < 0 && insertAfterDocRef && !newQ.documentRef) {
            newQ.documentRef = insertAfterDocRef;
        }

        // Keep original id if editing
        if (editingIndex >= 0 && editingIndex < questions.length) {
            newQ.id = questions[editingIndex].id || newQ.id;
            questions[editingIndex] = newQ;
        } else if (insertAtIndex !== null && insertAtIndex >= 0 && insertAtIndex <= questions.length) {
            questions.splice(insertAtIndex, 0, newQ);
        } else {
            questions.push(newQ);
        }

        editingIndex = -1;
        insertAfterDocRef = null;
        insertAtIndex = null;
        hideAddForm();
        renderFlow();
        updatePointsTotal();
    };

    // === UPDATE POINTS TOTAL ===
    function updatePointsTotal() {
        const total = questions.reduce((sum, q) => sum + (q.points || 0), 0);
        const el = document.getElementById('points-total');
        el.textContent = total + ' / ' + currentBareme + ' pts';
        if (total === currentBareme) {
            el.className = 'points-total points-ok';
        } else if (total > 0) {
            el.className = 'points-total ' + (total > currentBareme ? 'points-err' : 'points-warn');
        } else {
            el.className = 'points-total';
        }
    }

    // renderQuestions is now replaced by renderFlow() ‚Äî keep alias for safety
    function renderQuestions() { renderFlow(); }

    // === MOVE / DELETE ===
    window.moveQuestion = function(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= questions.length) return;
        [questions[index], questions[newIndex]] = [questions[newIndex], questions[index]];
        renderFlow();
    };

    window.deleteQuestion = function(index) {
        questions.splice(index, 1);
        renderFlow();
    };

    // === VALIDATION ===
    function validateEval() {
        const warnings = [];
        const total = questions.reduce((sum, q) => sum + (q.points || 0), 0);

        if (questions.length === 0) warnings.push('Aucune question ajoutee');
        if (total !== currentBareme) warnings.push('Le total des points (' + total + ') ne correspond pas au bareme (/' + currentBareme + ')');

        questions.forEach((q, i) => {
            if (!q.points || q.points <= 0) warnings.push('Q' + (i + 1) + ' : pas de points attribues');
            if (!q.competence) warnings.push('Q' + (i + 1) + ' : pas de competence associee');
            if (!q.correction) warnings.push('Q' + (i + 1) + ' : pas de correction / explication');
        });

        return warnings;
    }

    // === SAVE EVAL ===
    window.saveEval = async function() {
        const titre = document.getElementById('eval-titre').value.trim();
        if (!titre) { alert('Donne un titre a l\'evaluation !'); return; }
        if (questions.length === 0) { alert('Ajoute au moins une question !'); return; }

        const classeId = document.getElementById('eval-classe').value || null;
        const moduleId = document.getElementById('eval-module').value || null;
        let niveau = null;
        if (classeId) {
            const classesInGroup = window.getClassesFromGroupe ? window.getClassesFromGroupe(classeId) : [classeId];
            niveau = window.getNiveauClasse ? window.getNiveauClasse(classesInGroup[0]) : null;
        }

        const evalData = {
            titre,
            classeId,
            moduleId,
            niveau,
            bareme: currentBareme,
            timer: parseInt(document.getElementById('eval-timer').value) || 0,
            mode: currentModeEval,
            documents: documents,
            questions: questions,
            updatedAt: serverTimestamp()
        };

        try {
            if (currentEvalId) {
                await setDoc(doc(db, "eval_banque", currentEvalId), evalData, { merge: true });
            } else {
                const newId = 'eval_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 4);
                evalData.createdAt = serverTimestamp();
                evalData.publie = false;
                await setDoc(doc(db, "eval_banque", newId), evalData);
                currentEvalId = newId;
                document.getElementById('btn-delete-eval').style.display = 'block';
            }
            showToast('Evaluation sauvegardee (brouillon) !');
            renderEvalList();
        } catch(e) {
            console.error("Erreur sauvegarde:", e);
            alert("Erreur : " + e.message);
        }
    };

    // === PUBLISH EVAL ===
    window.publishEval = async function() {
        const titre = document.getElementById('eval-titre').value.trim();
        if (!titre) { alert('Donne un titre a l\'evaluation !'); return; }
        if (questions.length === 0) { alert('Ajoute au moins une question !'); return; }

        // Validate
        const warnings = validateEval();
        const banner = document.getElementById('validation-banner');
        const list = document.getElementById('validation-list');

        if (warnings.length > 0) {
            list.innerHTML = warnings.map(w => '<li>' + w + '</li>').join('');
            banner.style.display = 'block';
            banner.scrollIntoView({ behavior: 'smooth' });

            if (!confirm('Il y a ' + warnings.length + ' avertissement(s). Publier quand meme ?')) return;
        }

        // Save first then publish
        await saveEval();

        if (currentEvalId) {
            await setDoc(doc(db, "eval_banque", currentEvalId), { publie: true }, { merge: true });
            showToast('Evaluation publiee ! Les eleves peuvent y acceder.');
            banner.style.display = 'none';
            renderEvalList();
        }
    };

    // === DELETE EVAL ===
    window.deleteEval = async function() {
        if (!currentEvalId) return;
        if (!confirm("Supprimer definitivement cette evaluation ?")) return;

        try {
            await deleteDoc(doc(db, "eval_banque", currentEvalId));
            currentEvalId = null;
            questions = [];
            documents = [];
            document.getElementById('main-editor').style.display = 'none';
            document.getElementById('main-empty').style.display = 'flex';
            showToast('Evaluation supprimee.');
        } catch(e) {
            console.error("Erreur suppression:", e);
            alert("Erreur : " + e.message);
        }
    };

    // === TOAST ===
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 2500);
    }
</script>
</body>
</html>

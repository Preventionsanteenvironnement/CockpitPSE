<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultats Auto-Evaluations ‚Äî Prof</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a; color: white; height: 100vh; display: flex; overflow: hidden;
        }

        /* === SIDEBAR === */
        #sidebar {
            width: 340px; min-width: 340px; background: #1e293b; display: flex; flex-direction: column;
            border-right: 1px solid #334155; overflow-y: auto;
        }
        #sidebar::-webkit-scrollbar { width: 4px; }
        #sidebar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .sidebar-header {
            padding: 16px; border-bottom: 1px solid #334155; display: flex;
            align-items: center; justify-content: space-between;
        }
        .sidebar-header h2 { font-size: 1.05rem; }
        .sidebar-header a { color: #94a3b8; text-decoration: none; font-size: 0.8rem; }
        .sidebar-header a:hover { color: white; }

        .sidebar-section { padding: 14px; border-bottom: 1px solid #334155; }
        .sidebar-section label {
            font-size: 0.7rem; color: #64748b; text-transform: uppercase;
            letter-spacing: 1px; display: block; margin-bottom: 8px;
        }

        .form-select {
            width: 100%; padding: 8px 12px; background: #0f172a; color: white;
            border: 1px solid #475569; border-radius: 6px; font-size: 0.85rem;
            outline: none; cursor: pointer;
        }
        .form-select:focus { border-color: #3b82f6; }

        /* Eval list in sidebar */
        .eval-list { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
        .eval-list-item {
            padding: 10px 12px; background: #0f172a; border-radius: 8px;
            cursor: pointer; transition: 0.2s; border: 2px solid transparent;
        }
        .eval-list-item:hover { border-color: #475569; }
        .eval-list-item.active { border-color: #3b82f6; background: #1e3a5f; }
        .eval-list-item .ei-title { font-weight: 700; font-size: 0.85rem; margin-bottom: 2px; }
        .eval-list-item .ei-meta { font-size: 0.7rem; color: #64748b; }
        .ei-badge {
            display: inline-block; padding: 2px 6px; border-radius: 4px;
            font-size: 0.6rem; font-weight: 700; margin-right: 3px;
        }
        .badge-pub { background: #dcfce7; color: #166534; }
        .badge-draft { background: #fef3c7; color: #92400e; }
        .badge-qcount { background: #dbeafe; color: #1e40af; }
        .badge-bareme { background: #ede9fe; color: #5b21b6; }

        /* Session section */
        .session-box {
            background: #0f172a; border-radius: 8px; padding: 12px; margin-top: 10px;
            border: 1px solid #334155;
        }
        .session-box h4 { font-size: 0.8rem; color: #94a3b8; margin-bottom: 8px; }
        .session-code {
            font-size: 1.8rem; font-weight: 900; color: #f59e0b;
            letter-spacing: 4px; text-align: center; padding: 8px 0;
        }
        .session-btns { display: flex; gap: 6px; margin-top: 8px; }
        .session-btns button {
            flex: 1; padding: 8px; border: none; border-radius: 6px;
            font-weight: 700; cursor: pointer; font-size: 0.75rem; color: white;
        }
        .btn-session-create { background: #22c55e; }
        .btn-session-start { background: #3b82f6; }
        .btn-session-end { background: #ef4444; }
        .btn-session-create:hover, .btn-session-start:hover, .btn-session-end:hover { opacity: 0.85; }
        .btn-session-create:disabled, .btn-session-start:disabled, .btn-session-end:disabled {
            opacity: 0.3; cursor: not-allowed;
        }
        .session-students {
            max-height: 150px; overflow-y: auto; margin-top: 8px;
        }
        .session-student {
            display: flex; justify-content: space-between; padding: 4px 6px;
            background: #1e293b; border-radius: 4px; margin-bottom: 3px; font-size: 0.8rem;
        }
        .ss-code { font-weight: 700; }
        .ss-status { font-size: 0.7rem; }
        .ss-waiting { color: #f59e0b; }
        .ss-submitted { color: #22c55e; }

        /* === MAIN === */
        #main {
            flex: 1; display: flex; flex-direction: column; overflow-y: auto;
            padding: 30px; background: #0f172a;
        }

        #main-empty {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; flex: 1; text-align: center; color: #64748b;
        }
        #main-empty .big-icon { font-size: 4rem; margin-bottom: 16px; }

        #main-content { display: none; max-width: 1200px; width: 100%; margin: 0 auto; }

        /* Stats bar */
        .stats-bar {
            display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;
        }
        .stat-card {
            background: #1e293b; border-radius: 12px; padding: 16px 20px;
            border: 1px solid #334155; flex: 1; min-width: 140px; text-align: center;
        }
        .stat-value { font-size: 2rem; font-weight: 900; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }
        .sv-blue { color: #3b82f6; }
        .sv-green { color: #22c55e; }
        .sv-amber { color: #f59e0b; }
        .sv-red { color: #ef4444; }
        .sv-purple { color: #8b5cf6; }

        /* Action bar */
        .action-bar {
            display: flex; gap: 10px; margin-bottom: 20px; align-items: center;
            flex-wrap: wrap;
        }
        .action-bar .ab-title { font-size: 1.2rem; font-weight: 800; flex: 1; }
        .ab-btn {
            padding: 10px 18px; border: none; border-radius: 8px; font-weight: 700;
            cursor: pointer; font-size: 0.85rem; color: white; transition: 0.2s;
        }
        .ab-btn:hover { opacity: 0.85; }
        .ab-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .ab-publish { background: #22c55e; }
        .ab-refresh { background: #3b82f6; }
        .ab-export { background: #8b5cf6; }

        /* Results table */
        .results-table-wrap {
            background: #1e293b; border-radius: 12px; border: 1px solid #334155;
            overflow-x: auto;
        }
        .results-table {
            width: 100%; border-collapse: collapse; font-size: 0.85rem;
        }
        .results-table th {
            text-align: left; padding: 12px 14px; background: #0f172a;
            font-size: 0.7rem; color: #64748b; text-transform: uppercase;
            letter-spacing: 0.5px; border-bottom: 1px solid #334155;
            position: sticky; top: 0; z-index: 2;
        }
        .results-table th.sortable { cursor: pointer; }
        .results-table th.sortable:hover { color: #3b82f6; }
        .results-table td {
            padding: 10px 14px; border-bottom: 1px solid #1e293b;
        }
        .results-table tbody tr { transition: 0.15s; }
        .results-table tbody tr:hover { background: #0f172a; }

        .td-code { font-weight: 800; color: #f1f5f9; }
        .td-classe { font-size: 0.8rem; color: #64748b; }
        .td-note { font-weight: 800; font-size: 1rem; }
        .note-high { color: #22c55e; }
        .note-mid { color: #f59e0b; }
        .note-low { color: #ef4444; }

        .comp-badge {
            display: inline-block; padding: 2px 6px; border-radius: 4px;
            font-size: 0.7rem; font-weight: 700; min-width: 28px; text-align: center;
        }
        .cb-M { background: #dcfce7; color: #166534; }
        .cb-A { background: #dbeafe; color: #1e40af; }
        .cb-I { background: #fef3c7; color: #92400e; }
        .cb-NT { background: #e2e8f0; color: #64748b; }

        .status-badge {
            display: inline-block; padding: 3px 8px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 700;
        }
        .status-published { background: #dcfce7; color: #166534; }
        .status-submitted { background: #dbeafe; color: #1e40af; }
        .status-pending { background: #e2e8f0; color: #64748b; }

        .btn-sm {
            padding: 4px 10px; border: none; border-radius: 4px;
            font-size: 0.7rem; font-weight: 700; cursor: pointer; color: white;
            transition: 0.2s; margin-right: 3px;
        }
        .btn-sm:hover { opacity: 0.85; }
        .btn-view { background: #3b82f6; }
        .btn-pub { background: #22c55e; }
        .btn-unpub { background: #ef4444; }
        .btn-del { background: #dc2626; }
        .btn-del:hover { opacity: 0.85; }
        .btn-edit-note {
            background: transparent; border: none; cursor: pointer;
            font-size: 0.75rem; color: #64748b; padding: 2px;
            opacity: 0; transition: opacity 0.2s;
        }
        tr:hover .btn-edit-note { opacity: 1; }
        .btn-edit-note:hover { color: #3b82f6; }
        .note-adjusted-badge {
            font-size: 0.55rem; background: #fef3c7; color: #92400e;
            padding: 1px 4px; border-radius: 3px; font-weight: 700;
            vertical-align: super; margin-left: 2px;
        }
        .note-edit-inline {
            display: inline-flex; align-items: center; gap: 4px;
        }
        .note-edit-inline input {
            width: 50px; padding: 3px 6px; border: 1px solid #3b82f6;
            border-radius: 4px; background: #0f172a; color: white;
            font-size: 0.9rem; font-weight: 800; text-align: center;
        }
        .note-edit-inline button {
            padding: 3px 6px; border: none; border-radius: 4px;
            font-size: 0.7rem; font-weight: 700; cursor: pointer; color: white;
        }
        .note-edit-ok { background: #22c55e; }
        .note-edit-cancel { background: #64748b; }

        /* Delete eval modal buttons */
        .del-eval-btn {
            display: block; width: 100%; padding: 14px; margin: 8px 0;
            border: none; border-radius: 10px; font-weight: 700; font-size: 0.9rem;
            cursor: pointer; color: white; transition: 0.2s; text-align: center;
        }
        .del-eval-full { background: #dc2626; }
        .del-eval-full:hover { background: #b91c1c; }
        .del-eval-keep { background: #f59e0b; color: #000; }
        .del-eval-keep:hover { background: #d97706; }
        .del-eval-cancel { background: #475569; }
        .del-eval-cancel:hover { background: #334155; }
        .del-eval-info {
            font-size: 0.8rem; color: #94a3b8; margin: 12px 0; padding: 10px;
            background: #0f172a; border-radius: 8px; text-align: left;
        }
        .del-eval-pdf-link {
            display: inline-block; margin-top: 12px; font-size: 0.85rem;
            color: #8b5cf6; cursor: pointer; text-decoration: underline;
        }
        .del-eval-pdf-link:hover { color: #a78bfa; }

        /* Detail modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; padding: 20px;
        }
        .modal-overlay.visible { display: flex; }
        .modal-box {
            background: #1e293b; border-radius: 16px; padding: 24px;
            max-width: 700px; width: 100%; max-height: 85vh; overflow-y: auto;
            border: 1px solid #334155;
        }
        .modal-box::-webkit-scrollbar { width: 6px; }
        .modal-box::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 14px; border-bottom: 1px solid #334155;
        }
        .modal-header h3 { font-size: 1.1rem; }
        .modal-close {
            background: transparent; border: none; color: #94a3b8; font-size: 1.5rem;
            cursor: pointer; padding: 4px 8px;
        }
        .modal-close:hover { color: white; }

        .modal-score {
            text-align: center; padding: 20px; margin-bottom: 16px;
            background: #0f172a; border-radius: 12px;
        }
        .modal-score .ms-note { font-size: 2.5rem; font-weight: 900; }
        .modal-score .ms-label { font-size: 0.85rem; color: #94a3b8; margin-top: 4px; }

        .modal-q {
            background: #0f172a; border-radius: 10px; padding: 14px; margin-bottom: 10px;
            border-left: 3px solid #334155;
        }
        .modal-q.mq-correct { border-left-color: #22c55e; }
        .modal-q.mq-incorrect { border-left-color: #ef4444; }
        .modal-q.mq-nt { border-left-color: #94a3b8; }

        .mq-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 6px;
        }
        .mq-num { font-weight: 800; color: #3b82f6; font-size: 0.85rem; }
        .mq-result { font-weight: 700; font-size: 0.8rem; }
        .mq-correct-label { color: #22c55e; }
        .mq-incorrect-label { color: #ef4444; }
        .mq-nt-label { color: #94a3b8; }
        .mq-question { font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; color: #e2e8f0; }
        .mq-detail {
            font-size: 0.8rem; padding: 6px 10px; border-radius: 6px; margin-bottom: 4px;
        }
        .mq-student-ans { background: rgba(59,130,246,0.1); color: #93c5fd; }
        .mq-correct-ans { background: rgba(34,197,94,0.1); color: #86efac; }

        /* Empty table */
        .table-empty { text-align: center; padding: 40px; color: #64748b; }
        .table-empty .te-icon { font-size: 2.5rem; margin-bottom: 8px; }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; background: #22c55e; color: white;
            border-radius: 10px; font-weight: 700; font-size: 0.95rem;
            z-index: 2000; display: none; animation: fadeIn 0.3s;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        /* Filter pills */
        .filter-pills { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px; }
        .filter-pill {
            padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700;
            cursor: pointer; transition: 0.2s; border: 1px solid #475569;
            background: transparent; color: #94a3b8;
        }
        .filter-pill.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .filter-pill:hover { border-color: #3b82f6; color: #93c5fd; }

        /* === HAMBURGER MENU INFRASTRUCTURE === */
        .menu-overlay { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.55); backdrop-filter:blur(2px); z-index:999; }
        .menu-btn { display:none; border:none; background:#1e293b; color:#fff; width:44px; height:44px; border-radius:12px; font-size:20px; cursor:pointer; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
        body.menu-open #sidebar { transform:translateX(0); }
        body.menu-open .menu-overlay { display:block; }
        .close-sidebar-btn { display:none; }

        /* === MOBILE 768px === */
        @media (max-width:768px) {
            body { height:auto; overflow:auto; display:block; }
            #sidebar { position:fixed; top:0; left:0; bottom:0; height:100vh; width:min(86vw,340px); min-width:0; transform:translateX(-110%); transition:transform 0.25s ease; z-index:1000; overflow-y:auto; }
            #main { padding:16px; min-height:100vh; }
            .menu-btn { display:inline-flex; margin-bottom:12px; }
            .close-sidebar-btn { display:block; position:absolute; top:15px; right:15px; background:none; border:none; color:white; font-size:24px; cursor:pointer; z-index:1002; }
            .stats-bar { gap:8px; }
            .stat-card { min-width:calc(50% - 4px); flex:none; }
            .stat-value { font-size:1.4rem; }
            .action-bar { flex-wrap:wrap; gap:8px; }
            .action-bar .ab-title { width:100%; }
            .ab-btn { flex:1; min-width:calc(50% - 8px); text-align:center; padding:10px 14px; }
            .btn-sm { padding:8px 14px; min-height:44px; min-width:44px; }
            .modal-box { max-width:95vw; padding:16px; }
            .modal-overlay { z-index:1100; }
            .results-table { min-width:900px; }
            .filter-pill { padding:8px 14px; min-height:36px; }
        }

        /* === PHONE 480px === */
        @media (max-width:480px) {
            #main { padding:10px; }
            .stat-card { min-width:100%; }
            .ab-btn { min-width:100%; }
            .modal-box { max-width:100%; border-radius:8px; }
        }
    </style>
</head>
<body>

<!-- Menu overlay -->
<div id="menuOverlay" class="menu-overlay" onclick="closeMenu()"></div>

<!-- SIDEBAR -->
<div id="sidebar">
    <button class="close-sidebar-btn" onclick="closeMenu()">‚úï</button>
    <div class="sidebar-header">
        <h2>üìä Resultats Eval</h2>
        <a href="index.html">‚Üê Cockpit</a>
    </div>

    <div class="sidebar-section">
        <label>Filtrer les evaluations</label>
        <div style="margin-bottom:6px;">
            <span style="font-size:0.65rem; color:#475569; text-transform:uppercase;">Par classe</span>
            <div class="filter-pills" id="sidebar-class-pills">
                <button class="filter-pill active" onclick="setSidebarClassFilter('all')">Toutes</button>
            </div>
        </div>
        <div>
            <span style="font-size:0.65rem; color:#475569; text-transform:uppercase;">Par module</span>
            <div class="filter-pills" id="sidebar-module-pills">
                <button class="filter-pill active" onclick="setSidebarModuleFilter('all')">Tous</button>
            </div>
        </div>
    </div>

    <div class="sidebar-section">
        <label>Selection de l'evaluation</label>
        <select class="form-select" id="eval-selector" onchange="selectEval(this.value)">
            <option value="">‚Äî Choisir une evaluation ‚Äî</option>
        </select>
        <div class="eval-list" id="eval-sidebar-list"></div>
    </div>

    <div class="sidebar-section" id="session-section" style="display:none;">
        <label>Session synchronisee</label>
        <div class="session-box">
            <h4>Mode synchronise</h4>
            <div class="session-code" id="session-code-display" style="display:none;">----</div>
            <div class="session-btns">
                <button class="btn-session-create" id="btn-create-session" onclick="createSession()">Creer</button>
                <button class="btn-session-start" id="btn-start-session" onclick="startSession()" disabled>Lancer</button>
                <button class="btn-session-end" id="btn-end-session" onclick="endSession()" disabled>Terminer</button>
            </div>
            <div class="session-students" id="session-students"></div>
        </div>
    </div>

    <div class="sidebar-section">
        <label>Filtre par classe</label>
        <div class="filter-pills" id="class-filters">
            <button class="filter-pill active" data-classe="all" onclick="setClassFilter('all')">Toutes</button>
        </div>
    </div>

    <div class="sidebar-section">
        <label>Noms des eleves (RGPD local)</label>
        <div id="import-status" style="font-size:0.8rem; color:#94a3b8; margin-bottom:6px;"></div>
        <input type="file" id="csv-import" accept=".csv,.txt" style="display:none;" onchange="importCSVEleves(event)">
        <button onclick="document.getElementById('csv-import').click()" style="width:100%; padding:8px; background:#1e293b; border:1px dashed #475569; color:#94a3b8; border-radius:6px; font-size:0.8rem; cursor:pointer;">üìÅ Importer mes_eleves.csv</button>
        <div style="font-size:0.65rem; color:#475569; margin-top:4px; text-align:center;">üîí Reste sur cet appareil uniquement</div>
    </div>
</div>

<!-- MAIN -->
<div id="main">
    <button id="menuBtn" class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <!-- Empty state -->
    <div id="main-empty">
        <div class="big-icon">üìä</div>
        <h2 style="margin-bottom:8px;">Resultats des auto-evaluations</h2>
        <p>Selectionne une evaluation dans la sidebar pour voir les resultats des eleves.</p>
    </div>

    <!-- Results content -->
    <div id="main-content">
        <!-- Stats -->
        <div class="stats-bar" id="stats-bar">
            <div class="stat-card">
                <div class="stat-value sv-blue" id="stat-soumis">0</div>
                <div class="stat-label">Soumis</div>
            </div>
            <div class="stat-card">
                <div class="stat-value sv-green" id="stat-moyenne">--</div>
                <div class="stat-label">Moyenne</div>
            </div>
            <div class="stat-card">
                <div class="stat-value sv-amber" id="stat-min">--</div>
                <div class="stat-label">Min</div>
            </div>
            <div class="stat-card">
                <div class="stat-value sv-purple" id="stat-max">--</div>
                <div class="stat-label">Max</div>
            </div>
            <div class="stat-card">
                <div class="stat-value sv-green" id="stat-publies">0</div>
                <div class="stat-label">Publies</div>
            </div>
        </div>

        <!-- Action bar -->
        <div class="action-bar">
            <div class="ab-title" id="eval-title-display">Evaluation</div>
            <button class="ab-btn" style="background:#f59e0b;color:#000;" onclick="viewEvalContent()">üìã Voir l'evaluation</button>
            <button class="ab-btn ab-refresh" onclick="refreshResults()">üîÑ Actualiser</button>
            <button class="ab-btn ab-publish" id="btn-publish-all" onclick="publishAll()">üì¢ Publier tout</button>
            <button class="ab-btn ab-export" onclick="exportCSV()">üì• Export CSV</button>
            <button class="ab-btn" style="background:#8b5cf6;" onclick="exportResultsPDF()">üìÑ PDF</button>
            <button class="ab-btn" style="background:#dc2626;" onclick="deleteEvaluation()">üóëÔ∏è Supprimer eval</button>
            <button id="authBtn" class="ab-btn" style="background:#dbeafe;color:#1d4ed8;" onclick="connexionProf()">üîê Connexion</button>
        </div>

        <!-- Results table -->
        <div class="results-table-wrap">
            <table class="results-table" id="results-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortBy('code')">Eleve ‚áÖ</th>
                        <th>Classe</th>
                        <th class="sortable" onclick="sortBy('note')">Note ‚áÖ</th>
                        <th>C1</th>
                        <th>C2</th>
                        <th>C3</th>
                        <th>C4</th>
                        <th>C5</th>
                        <th>C6</th>
                        <th>Statut</th>
                        <th>Temps</th>
                        <th class="sortable" onclick="sortBy('date')">Date ‚áÖ</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="results-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Detail modal -->
<div class="modal-overlay" id="modal-detail" onclick="if(event.target===this)closeModal()">
    <div class="modal-box">
        <div class="modal-header">
            <h3 id="modal-title">Detail</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<!-- Eval preview modal -->
<div class="modal-overlay" id="modal-eval-preview" onclick="if(event.target===this)closeEvalPreview()">
    <div class="modal-box">
        <div class="modal-header">
            <h3 id="modal-eval-title">Contenu de l'evaluation</h3>
            <button class="modal-close" onclick="closeEvalPreview()">&times;</button>
        </div>
        <div id="modal-eval-body"></div>
    </div>
</div>

<!-- Delete eval modal -->
<div class="modal-overlay" id="modal-delete-eval" onclick="if(event.target===this)closeDeleteModal()">
    <div class="modal-box" style="max-width:480px;">
        <div class="modal-header">
            <h3 id="modal-delete-title">Supprimer l'evaluation</h3>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div id="modal-delete-body"></div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="data_modules.js"></script>
<script src="data_eleves.js"></script>
<script>
function toggleMenu(){ document.body.classList.toggle('menu-open'); }
function closeMenu(){ document.body.classList.remove('menu-open'); }
</script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
        getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc,
        collection, collectionGroup, query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.firebasestorage.app",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    let currentAuthUser = null;

    // === AUTHENTIFICATION PROF (requise pour suppression) ===
    onAuthStateChanged(auth, (user) => {
        currentAuthUser = user;
        updateAuthButton();
        if (user) console.log("‚úÖ Prof connecte:", user.email);
    });

    window.connexionProf = async function() {
        try {
            const result = await signInWithPopup(auth, googleProvider);
            currentAuthUser = result.user;
            updateAuthButton();
            showToast('‚úÖ Connecte : ' + currentAuthUser.email);
        } catch (error) {
            console.error("Erreur connexion:", error);
            alert("Erreur : " + error.message);
        }
    };

    function updateAuthButton() {
        const btn = document.getElementById('authBtn');
        if (!btn) return;
        if (currentAuthUser) {
            btn.textContent = "‚úÖ " + currentAuthUser.email.split('@')[0];
            btn.style.background = "#dcfce7";
            btn.style.color = "#166534";
        } else {
            btn.textContent = "üîê Connexion";
            btn.style.background = "#dbeafe";
            btn.style.color = "#1d4ed8";
        }
    }

    // === NOMS ELEVES (RGPD - localStorage uniquement) ===
    const CLE_ELEVES = 'cockpit_eleves_noms';
    function getNomEleve(code) {
        if (!code) return null;
        const eleves = JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}');
        return eleves[code.toUpperCase()] || null;
    }
    function afficherAvecNom(code) {
        if (!code) return '';
        const nom = getNomEleve(code);
        return nom ? nom + ' (' + code + ')' : code;
    }

    // === STATE ===
    let allEvals = [];
    let currentEvalId = null;
    let currentEvalData = null;
    let results = [];
    let filteredResults = [];
    let currentClassFilter = 'all';
    let sortField = 'code';
    let sortAsc = true;
    let sessionId = null;
    let sessionUnsubscribe = null;
    let sidebarClassFilter = 'all';
    let sidebarModuleFilter = 'all';

    // === LOAD ALL EVALS (real-time) ===
    const qBanque = query(collection(db, "eval_banque"), orderBy("updatedAt", "desc"));
    onSnapshot(qBanque, (snap) => {
        allEvals = [];
        snap.forEach(d => {
            allEvals.push({ id: d.id, ...d.data() });
        });
        buildSidebarFilters();
        renderEvalSelector();
        renderEvalSidebarList();
    });

    // === SIDEBAR EVAL FILTERS ===
    function buildSidebarFilters() {
        // Class pills
        const classContainer = document.getElementById('sidebar-class-pills');
        const classes = new Set();
        allEvals.forEach(ev => {
            const ids = ev.classeIds || (ev.classeId ? [ev.classeId] : []);
            ids.forEach(id => classes.add(id));
        });
        classContainer.innerHTML = '<button class="filter-pill' + (sidebarClassFilter === 'all' ? ' active' : '') + '" onclick="setSidebarClassFilter(\'all\')">Toutes</button>';
        [...classes].sort().forEach(c => {
            const pill = document.createElement('button');
            pill.className = 'filter-pill' + (sidebarClassFilter === c ? ' active' : '');
            pill.textContent = c;
            pill.onclick = () => setSidebarClassFilter(c);
            classContainer.appendChild(pill);
        });
        // Module pills
        const moduleContainer = document.getElementById('sidebar-module-pills');
        const modules = new Set();
        allEvals.forEach(ev => { if (ev.moduleId) modules.add(ev.moduleId); });
        moduleContainer.innerHTML = '<button class="filter-pill' + (sidebarModuleFilter === 'all' ? ' active' : '') + '" onclick="setSidebarModuleFilter(\'all\')">Tous</button>';
        [...modules].sort().forEach(m => {
            const pill = document.createElement('button');
            pill.className = 'filter-pill' + (sidebarModuleFilter === m ? ' active' : '');
            pill.textContent = m;
            pill.onclick = () => setSidebarModuleFilter(m);
            moduleContainer.appendChild(pill);
        });
    }
    window.setSidebarClassFilter = function(v) { sidebarClassFilter = v; buildSidebarFilters(); renderEvalSelector(); renderEvalSidebarList(); };
    window.setSidebarModuleFilter = function(v) { sidebarModuleFilter = v; buildSidebarFilters(); renderEvalSelector(); renderEvalSidebarList(); };

    function getFilteredEvals() {
        return allEvals.filter(ev => {
            if (sidebarClassFilter !== 'all') {
                const ids = ev.classeIds || (ev.classeId ? [ev.classeId] : []);
                if (ids.length > 0 && !ids.includes(sidebarClassFilter)) return false;
            }
            if (sidebarModuleFilter !== 'all' && ev.moduleId !== sidebarModuleFilter) return false;
            return true;
        });
    }

    function renderEvalSelector() {
        const sel = document.getElementById('eval-selector');
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">‚Äî Choisir une evaluation ‚Äî</option>';
        getFilteredEvals().forEach(ev => {
            const opt = document.createElement('option');
            opt.value = ev.id;
            const pubLabel = ev.publie ? ' [Publie]' : ' [Brouillon]';
            const qCount = (ev.questions || []).length;
            opt.textContent = (ev.titre || 'Sans titre') + ' ‚Äî /' + (ev.bareme || 20) + ' (' + qCount + 'Q)' + pubLabel;
            sel.appendChild(opt);
        });
        if (currentVal) sel.value = currentVal;
    }

    function renderEvalSidebarList() {
        const container = document.getElementById('eval-sidebar-list');
        container.innerHTML = '';
        getFilteredEvals().forEach(ev => {
            const div = document.createElement('div');
            div.className = 'eval-list-item' + (ev.id === currentEvalId ? ' active' : '');
            div.onclick = () => {
                document.getElementById('eval-selector').value = ev.id;
                selectEval(ev.id);
            };

            const pubBadge = ev.publie
                ? '<span class="ei-badge badge-pub">Publie</span>'
                : '<span class="ei-badge badge-draft">Brouillon</span>';
            const qCountBadge = '<span class="ei-badge badge-qcount">' + (ev.questions ? ev.questions.length : 0) + ' Q</span>';
            const baremeBadge = '<span class="ei-badge badge-bareme">/' + (ev.bareme || 20) + '</span>';

            const evClasseIds = ev.classeIds || (ev.classeId ? [ev.classeId] : []);
            const classeBadge = evClasseIds.length > 0
                ? '<span class="ei-badge" style="background:#fef3c7;color:#92400e;">' + evClasseIds.join(', ') + '</span>'
                : '<span class="ei-badge" style="background:#e2e8f0;color:#64748b;">Toutes</span>';

            div.innerHTML = '<div class="ei-title">' + (ev.titre || 'Sans titre') + '</div>' +
                '<div class="ei-meta">' + pubBadge + qCountBadge + baremeBadge + classeBadge + '</div>';
            container.appendChild(div);
        });
    }

    // === SELECT EVAL ===
    window.selectEval = async function(evalId) {
        if (!evalId) {
            currentEvalId = null;
            currentEvalData = null;
            results = [];
            filteredResults = [];
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('main-empty').style.display = 'flex';
            renderEvalSidebarList();
            return;
        }

        currentEvalId = evalId;
        currentEvalData = allEvals.find(e => e.id === evalId) || null;

        document.getElementById('main-empty').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';

        const title = currentEvalData ? currentEvalData.titre : 'Evaluation';
        const evalClasseIds = currentEvalData ? (currentEvalData.classeIds || (currentEvalData.classeId ? [currentEvalData.classeId] : [])) : [];
        const classeInfo = evalClasseIds.length > 0 ? ' ‚Äî Classe(s) : ' + evalClasseIds.join(', ') : ' ‚Äî Toutes classes';
        document.getElementById('eval-title-display').textContent = title + classeInfo;

        // Show session section if synchronise mode
        const isSyncMode = currentEvalData && currentEvalData.mode === 'synchronise';
        document.getElementById('session-section').style.display = isSyncMode ? 'block' : 'none';

        renderEvalSidebarList();
        if (window.innerWidth <= 768) closeMenu();
        await loadResults();
    };

    // === LOAD RESULTS ===
    async function loadResults() {
        if (!currentEvalId) return;
        results = [];

        try {
            // Query eval_reponses for this eval
            const qReponses = query(
                collection(db, "eval_reponses"),
                where("evalId", "==", currentEvalId)
            );
            const snap = await getDocs(qReponses);

            const promises = [];
            snap.forEach(d => {
                const resp = d.data();
                resp._reponseDocId = d.id;
                promises.push(loadStudentResult(resp));
            });

            results = await Promise.all(promises);
            results = results.filter(r => r !== null);

            buildClassFilters();
            applyFilters();
            renderStats();
            renderTable();

        } catch(e) {
            console.error("Erreur chargement resultats:", e);
        }
    }

    async function loadStudentResult(resp) {
        const eleveCode = resp.eleveCode;
        const evalDocId = currentEvalId + '_eval';

        try {
            // Load the evaluation document for this student
            const evalDocRef = doc(db, "resultats", eleveCode, "evaluations", evalDocId);
            const evalSnap = await getDoc(evalDocRef);

            let evalData = {};
            let publie = false;
            let note = null;
            let competences = {};
            let questionsResult = {};

            if (evalSnap.exists()) {
                evalData = evalSnap.data();
                publie = evalData.publie || false;
                note = evalData.note_finale;
                competences = evalData.competences || {};
                questionsResult = evalData.questions || {};
            }

            return {
                eleveCode,
                classe: resp.classe || '',
                note,
                note_ajustee: evalData.note_ajustee ?? null,
                bareme: currentEvalData ? (currentEvalData.bareme || 20) : 20,
                competences,
                questionsResult,
                publie,
                tempsSecondes: resp.tempsSecondes || 0,
                tabSwitchCount: resp.tabSwitchCount || 0,
                copyPasteCount: resp.copyPasteCount || 0,
                rightClickCount: resp.rightClickCount || 0,
                screenshotCount: resp.screenshotCount || 0,
                submittedAt: resp.submittedAt || '',
                reponses: resp.reponses || {},
                evalDocId,
                evalData,
                reponseDocId: resp._reponseDocId || null
            };
        } catch(e) {
            console.error("Erreur chargement eleve:", eleveCode, e);
            return null;
        }
    }

    // === CLASS FILTERS ===
    function buildClassFilters() {
        const classes = new Set();
        // 1. Classes from results
        results.forEach(r => { if (r.classe) classes.add(r.classe); });
        // 2. Classes from eval target (classeIds or classeId, can be groups)
        if (currentEvalData) {
            const targetIds = currentEvalData.classeIds || (currentEvalData.classeId ? [currentEvalData.classeId] : []);
            targetIds.forEach(id => {
                const expanded = window.getClassesFromGroupe ? window.getClassesFromGroupe(id) : [id];
                expanded.forEach(c => classes.add(c));
            });
        }
        // 3. If no classes targeted (all classes), show classes from results
        const targetIds = currentEvalData ? (currentEvalData.classeIds || (currentEvalData.classeId ? [currentEvalData.classeId] : [])) : [];
        if (targetIds.length === 0) {
            results.forEach(r => { if (r.classe) classes.add(r.classe); });
        }

        const container = document.getElementById('class-filters');
        container.innerHTML = '<button class="filter-pill' + (currentClassFilter === 'all' ? ' active' : '') + '" onclick="setClassFilter(\'all\')">Toutes (' + results.length + ')</button>';

        const sorted = [...classes].sort();
        sorted.forEach(c => {
            const count = results.filter(r => r.classe === c).length;
            const pill = document.createElement('button');
            pill.className = 'filter-pill' + (currentClassFilter === c ? ' active' : '');
            pill.textContent = c + (count > 0 ? ' (' + count + ')' : '');
            pill.onclick = () => setClassFilter(c);
            container.appendChild(pill);
        });
    }

    window.setClassFilter = function(classe) {
        currentClassFilter = classe;
        // Rebuild filters to update active state
        buildClassFilters();
        applyFilters();
        renderStats();
        renderTable();
    };

    function applyFilters() {
        filteredResults = results.filter(r => {
            if (currentClassFilter !== 'all' && r.classe !== currentClassFilter) return false;
            return true;
        });
        sortResults();
    }

    // === SORT ===
    window.sortBy = function(field) {
        if (sortField === field) sortAsc = !sortAsc;
        else { sortField = field; sortAsc = true; }
        sortResults();
        renderTable();
    };

    function getDisplayNote(r) {
        return (r.note_ajustee !== null && r.note_ajustee !== undefined) ? r.note_ajustee : r.note;
    }

    function formatDate(submittedAt) {
        if (!submittedAt) return '--';
        try {
            const dt = submittedAt.toDate ? submittedAt.toDate() : new Date(submittedAt);
            if (isNaN(dt.getTime())) return '--';
            return dt.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit' })
                + ' ' + dt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        } catch(e) { return '--'; }
    }

    function getTimestamp(submittedAt) {
        if (!submittedAt) return 0;
        try {
            const dt = submittedAt.toDate ? submittedAt.toDate() : new Date(submittedAt);
            return isNaN(dt.getTime()) ? 0 : dt.getTime();
        } catch(e) { return 0; }
    }

    function sortResults() {
        filteredResults.sort((a, b) => {
            let va, vb;
            if (sortField === 'code') { va = a.eleveCode; vb = b.eleveCode; }
            else if (sortField === 'note') { va = getDisplayNote(a) ?? -1; vb = getDisplayNote(b) ?? -1; }
            else if (sortField === 'date') { va = getTimestamp(a.submittedAt); vb = getTimestamp(b.submittedAt); }
            else { va = a.eleveCode; vb = b.eleveCode; }

            if (typeof va === 'string') {
                return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            }
            return sortAsc ? va - vb : vb - va;
        });
    }

    // === RENDER STATS ===
    function renderStats() {
        const notes = filteredResults.map(r => getDisplayNote(r)).filter(n => n !== null && n !== undefined && !isNaN(n)).map(n => parseFloat(n));
        const bareme = currentEvalData ? (currentEvalData.bareme || 20) : 20;
        const publies = filteredResults.filter(r => r.publie).length;

        document.getElementById('stat-soumis').textContent = filteredResults.length;
        document.getElementById('stat-publies').textContent = publies;

        if (notes.length > 0) {
            const avg = (notes.reduce((a, b) => a + b, 0) / notes.length).toFixed(1);
            const min = Math.min(...notes).toFixed(1);
            const max = Math.max(...notes).toFixed(1);
            document.getElementById('stat-moyenne').textContent = avg + '/' + bareme;
            document.getElementById('stat-min').textContent = min;
            document.getElementById('stat-max').textContent = max;
        } else {
            document.getElementById('stat-moyenne').textContent = '--';
            document.getElementById('stat-min').textContent = '--';
            document.getElementById('stat-max').textContent = '--';
        }
    }

    // === RENDER TABLE ===
    function renderTable() {
        const tbody = document.getElementById('results-tbody');

        if (filteredResults.length === 0) {
            tbody.innerHTML = '<tr><td colspan="13"><div class="table-empty"><div class="te-icon">üì≠</div><p>Aucun resultat pour cette evaluation.</p></div></td></tr>';
            return;
        }

        tbody.innerHTML = '';
        filteredResults.forEach((r, idx) => {
            const tr = document.createElement('tr');

            // Note coloring ‚Äî use display note (ajustee if exists)
            const bareme = r.bareme || 20;
            const displayNote = getDisplayNote(r);
            const pct = displayNote !== null ? (displayNote / bareme) * 100 : 0;
            const noteClass = displayNote === null ? '' : (pct >= 60 ? 'note-high' : pct >= 40 ? 'note-mid' : 'note-low');

            // Note cell content with adjusted badge + edit button
            let noteHtml = '';
            if (displayNote !== null) {
                noteHtml = displayNote + '/' + bareme;
                if (r.note_ajustee !== null && r.note_ajustee !== undefined) {
                    noteHtml += ' <span class="note-adjusted-badge">ajuste</span>';
                }
                noteHtml += ' <button class="btn-edit-note" onclick="editNote(\'' + r.eleveCode + '\', event)" title="Modifier la note">‚úèÔ∏è</button>';
            } else {
                noteHtml = '--';
            }

            // Competence badges
            let compsCells = '';
            for (let c = 1; c <= 6; c++) {
                const compKey = 'C' + c;
                const comp = r.competences[compKey];
                if (comp) {
                    const compPct = comp.max > 0 ? (comp.pts / comp.max) * 100 : 0;
                    let level = 'NT';
                    if (compPct >= 80) level = 'M';
                    else if (compPct >= 50) level = 'A';
                    else if (compPct > 0) level = 'I';
                    compsCells += '<td><span class="comp-badge cb-' + level + '">' + level + '</span></td>';
                } else {
                    compsCells += '<td><span class="comp-badge cb-NT">-</span></td>';
                }
            }

            // Status
            const statusHtml = r.publie
                ? '<span class="status-badge status-published">Publie</span>'
                : '<span class="status-badge status-submitted">Soumis</span>';

            // Time
            const mins = Math.floor(r.tempsSecondes / 60);
            const secs = r.tempsSecondes % 60;
            const timeStr = mins + ':' + (secs < 10 ? '0' : '') + secs;

            // Anti-cheat warnings
            const tabWarn = r.tabSwitchCount > 0 ? ' <span title="Sorties detectees" style="color:#ef4444; font-size:0.7rem;">‚ö†Ô∏è' + r.tabSwitchCount + '</span>' : '';
            const copyWarn = r.copyPasteCount > 0 ? ' <span title="Copier-coller detecte" style="color:#f59e0b; font-size:0.7rem;">üìã' + r.copyPasteCount + '</span>' : '';
            const rightWarn = r.rightClickCount > 0 ? ' <span title="Clics droit detectes" style="color:#f97316; font-size:0.7rem;">üñ±Ô∏è' + r.rightClickCount + '</span>' : '';
            const screenWarn = r.screenshotCount > 0 ? ' <span title="Captures d\'ecran detectees" style="color:#dc2626; font-size:0.7rem;">üì∏' + r.screenshotCount + '</span>' : '';

            // Date
            const dateStr = formatDate(r.submittedAt);

            // Publish/Unpublish button
            const pubBtn = r.publie
                ? '<button class="btn-sm btn-unpub" onclick="unpublishOne(\'' + r.eleveCode + '\')" title="Depublier">üîí</button>'
                : '<button class="btn-sm btn-pub" onclick="publishOne(\'' + r.eleveCode + '\')" title="Publier">üì¢</button>';

            // Delete button
            const delBtn = '<button class="btn-sm btn-del" onclick="deleteResult(\'' + r.eleveCode + '\')" title="Supprimer ce resultat">üóëÔ∏è</button>';

            const displayName = afficherAvecNom(r.eleveCode);

            tr.innerHTML =
                '<td class="td-code">' + displayName + tabWarn + copyWarn + rightWarn + screenWarn + '</td>' +
                '<td class="td-classe">' + r.classe + '</td>' +
                '<td class="td-note ' + noteClass + '">' + noteHtml + '</td>' +
                compsCells +
                '<td>' + statusHtml + '</td>' +
                '<td style="font-size:0.8rem; color:#94a3b8;">' + timeStr + '</td>' +
                '<td style="font-size:0.75rem; color:#94a3b8;">' + dateStr + '</td>' +
                '<td>' +
                    '<button class="btn-sm btn-view" onclick="viewDetail(\'' + r.eleveCode + '\')" title="Detail">üëÅÔ∏è</button>' +
                    pubBtn +
                    delBtn +
                '</td>';

            tbody.appendChild(tr);
        });
    }

    // === PUBLISH ONE ===
    window.publishOne = async function(eleveCode) {
        try {
            const evalDocRef = doc(db, "resultats", eleveCode, "evaluations", currentEvalId + '_eval');
            await updateDoc(evalDocRef, { publie: true });

            const r = results.find(r => r.eleveCode === eleveCode);
            if (r) r.publie = true;
            applyFilters();
            renderStats();
            renderTable();
            showToast('Resultat publie pour ' + eleveCode);
        } catch(e) {
            console.error("Erreur publication:", e);
            alert("Erreur : " + e.message);
        }
    };

    // === UNPUBLISH ONE ===
    window.unpublishOne = async function(eleveCode) {
        try {
            const evalDocRef = doc(db, "resultats", eleveCode, "evaluations", currentEvalId + '_eval');
            await updateDoc(evalDocRef, { publie: false });

            const r = results.find(r => r.eleveCode === eleveCode);
            if (r) r.publie = false;
            applyFilters();
            renderStats();
            renderTable();
            showToast('Resultat depublie pour ' + eleveCode);
        } catch(e) {
            console.error("Erreur depublication:", e);
            alert("Erreur : " + e.message);
        }
    };

    // === PUBLISH ALL ===
    window.publishAll = async function() {
        const toPublish = filteredResults.filter(r => !r.publie);
        if (toPublish.length === 0) {
            showToast('Tous les resultats sont deja publies.');
            return;
        }
        if (!confirm('Publier ' + toPublish.length + ' resultat(s) ? Les eleves les verront dans "Mes Resultats".')) return;

        try {
            const promises = toPublish.map(r => {
                const evalDocRef = doc(db, "resultats", r.eleveCode, "evaluations", currentEvalId + '_eval');
                return updateDoc(evalDocRef, { publie: true });
            });
            await Promise.all(promises);

            toPublish.forEach(r => r.publie = true);
            applyFilters();
            renderStats();
            renderTable();
            showToast(toPublish.length + ' resultat(s) publie(s) !');
        } catch(e) {
            console.error("Erreur publication groupee:", e);
            alert("Erreur : " + e.message);
        }
    };

    // === REFRESH ===
    window.refreshResults = async function() {
        if (!currentEvalId) return;
        showToast('Actualisation...');
        await loadResults();
        showToast('Resultats actualises !');
    };

    // === DELETE RESULT ===
    window.deleteResult = async function(eleveCode) {
        if (!currentAuthUser) {
            showToast('üîê Connectez-vous pour supprimer');
            connexionProf();
            return;
        }
        const r = results.find(r => r.eleveCode === eleveCode);
        if (!r) return;
        const displayName = afficherAvecNom(eleveCode);
        if (!confirm('Supprimer le resultat de ' + displayName + ' ?\n\nCette action est irreversible.')) return;

        try {
            // 1. Delete from resultats/{eleveCode}/evaluations/{evalId}_eval
            const evalDocRef = doc(db, "resultats", eleveCode, "evaluations", currentEvalId + '_eval');
            await deleteDoc(evalDocRef);

            // 2. Delete from eval_reponses if we have the doc ID
            if (r.reponseDocId) {
                const reponseDocRef = doc(db, "eval_reponses", r.reponseDocId);
                await deleteDoc(reponseDocRef);
            }

            // 3. Remove from local arrays
            const idx = results.indexOf(r);
            if (idx > -1) results.splice(idx, 1);

            applyFilters();
            buildClassFilters();
            renderStats();
            renderTable();
            showToast('Resultat supprime pour ' + displayName);
        } catch(e) {
            console.error("Erreur suppression:", e);
            alert("Erreur : " + e.message);
        }
    };

    // === EDIT NOTE (inline) ===
    window.editNote = function(eleveCode, event) {
        if (event) event.stopPropagation();
        const r = filteredResults.find(r => r.eleveCode === eleveCode);
        if (!r) return;

        const bareme = r.bareme || 20;
        const currentNote = getDisplayNote(r);

        // Find the note cell in the table row
        const rows = document.querySelectorAll('#results-tbody tr');
        for (const row of rows) {
            if (row.innerHTML.includes("editNote('" + eleveCode + "'")) {
                const noteCell = row.querySelector('.td-note');
                if (noteCell) {
                    noteCell.innerHTML =
                        '<div class="note-edit-inline">' +
                            '<input type="number" id="note-input-' + eleveCode + '" value="' + (currentNote !== null ? currentNote : '') + '" min="0" max="' + bareme + '" step="0.5" onkeydown="if(event.key===\'Enter\')saveNote(\'' + eleveCode + '\');if(event.key===\'Escape\')cancelEditNote();">' +
                            '/' + bareme +
                            ' <button class="note-edit-ok" onclick="saveNote(\'' + eleveCode + '\')">OK</button>' +
                            ' <button class="note-edit-cancel" onclick="cancelEditNote()">‚úï</button>' +
                        '</div>';
                    const input = document.getElementById('note-input-' + eleveCode);
                    if (input) { input.focus(); input.select(); }
                }
                break;
            }
        }
    };

    window.saveNote = async function(eleveCode) {
        const input = document.getElementById('note-input-' + eleveCode);
        if (!input) return;

        const newNote = parseFloat(input.value);
        const r = results.find(r => r.eleveCode === eleveCode);
        if (!r) return;

        const bareme = r.bareme || 20;
        if (isNaN(newNote) || newNote < 0 || newNote > bareme) {
            alert('Note invalide. Entrez une valeur entre 0 et ' + bareme + '.');
            return;
        }

        try {
            const evalDocRef = doc(db, "resultats", eleveCode, "evaluations", currentEvalId + '_eval');
            await updateDoc(evalDocRef, { note_ajustee: newNote });

            // Update local data
            r.note_ajustee = newNote;

            applyFilters();
            renderStats();
            renderTable();
            showToast('Note ajustee a ' + newNote + '/' + bareme + ' pour ' + afficherAvecNom(eleveCode));
        } catch(e) {
            console.error("Erreur sauvegarde note:", e);
            alert("Erreur : " + e.message);
        }
    };

    window.cancelEditNote = function() {
        renderTable();
    };

    // === VIEW DETAIL ===
    window.viewDetail = function(eleveCode) {
        const r = filteredResults.find(r => r.eleveCode === eleveCode);
        if (!r || !currentEvalData) return;

        const qs = currentEvalData.questions || [];
        const bareme = currentEvalData.bareme || 20;

        document.getElementById('modal-title').textContent = 'üë§ ' + afficherAvecNom(eleveCode) + ' ‚Äî ' + (currentEvalData.titre || 'Evaluation');

        let html = '';

        // Score ‚Äî show adjusted note if exists
        const displayNote = getDisplayNote(r);
        const pct = displayNote !== null ? (displayNote / bareme) * 100 : 0;
        const scoreClass = displayNote === null ? '' : (pct >= 60 ? 'sv-green' : pct >= 40 ? 'sv-amber' : 'sv-red');
        html += '<div class="modal-score">';
        html += '<div class="ms-note ' + scoreClass + '">' + (displayNote !== null ? displayNote + ' / ' + bareme : '--') + '</div>';
        if (r.note_ajustee !== null && r.note_ajustee !== undefined) {
            html += '<div style="font-size:0.8rem; color:#fbbf24; margin-top:4px;"><span class="note-adjusted-badge">ajuste</span> Auto-correction : ' + r.note + '/' + bareme + ' ‚Üí Note ajustee : ' + r.note_ajustee + '/' + bareme + '</div>';
        }
        html += '<div class="ms-label">Temps : ' + Math.floor(r.tempsSecondes / 60) + ' min ' + (r.tempsSecondes % 60) + ' sec';
        if (r.tabSwitchCount > 0) html += ' | ‚ö†Ô∏è ' + r.tabSwitchCount + ' sortie(s) d\'onglet';
        if (r.copyPasteCount > 0) html += ' | üìã ' + r.copyPasteCount + ' copier-coller';
        if (r.rightClickCount > 0) html += ' | üñ±Ô∏è ' + r.rightClickCount + ' clic(s) droit';
        if (r.screenshotCount > 0) html += ' | üì∏ ' + r.screenshotCount + ' capture(s) d\'ecran';
        html += '</div></div>';

        // Per-question detail
        qs.forEach((q, i) => {
            const qResult = r.questionsResult['q_' + i] || { level: 'NT' };
            const level = qResult.level || 'NT';
            const cardClass = level === 'M' ? 'mq-correct' : (level === 'I' ? 'mq-incorrect' : 'mq-nt');
            const resultLabel = level === 'M' ? '‚úÖ Correct' : (level === 'I' ? '‚ùå Incorrect' : '‚ö´ Non repondu');
            const labelClass = level === 'M' ? 'mq-correct-label' : (level === 'I' ? 'mq-incorrect-label' : 'mq-nt-label');

            html += '<div class="modal-q ' + cardClass + '">';
            html += '<div class="mq-header"><span class="mq-num">Q' + (i + 1) + (q.competence ? ' ‚Äî ' + q.competence : '') + ' (' + (q.points || 0) + ' pts)</span><span class="mq-result ' + labelClass + '">' + resultLabel + '</span></div>';
            html += '<div class="mq-question">' + q.question + '</div>';

            // Student answer
            const studentAns = r.reponses[q.id];
            if (studentAns !== undefined && studentAns !== null) {
                html += '<div class="mq-detail mq-student-ans">‚úçÔ∏è Reponse : ' + formatStudentAnswer(q, studentAns) + '</div>';
            }

            // Correct answer
            html += '<div class="mq-detail mq-correct-ans">‚úÖ Attendu : ' + formatCorrectAnswer(q) + '</div>';

            html += '</div>';
        });

        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal-detail').classList.add('visible');
    };

    window.closeModal = function() {
        document.getElementById('modal-detail').classList.remove('visible');
    };

    // Close modals on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { closeModal(); closeEvalPreview(); closeDeleteModal(); }
    });

    // === PREVIEW EVAL CONTENT ===
    window.viewEvalContent = function() {
        if (!currentEvalData) { showToast('Selectionnez une evaluation.'); return; }
        const ev = currentEvalData;
        const qs = ev.questions || [];
        const docs = ev.documents || [];

        document.getElementById('modal-eval-title').textContent = 'üìã ' + (ev.titre || 'Evaluation') + ' ‚Äî ' + qs.length + ' question' + (qs.length > 1 ? 's' : '');

        let html = '';
        // Metadata
        html += '<div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:16px;">';
        html += '<div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">';
        html += '<span class="ei-badge badge-bareme">/' + (ev.bareme || 20) + '</span>';
        const classeLabel = ev.classeId || 'Toutes les classes';
        html += '<span class="ei-badge" style="background:#fef3c7;color:#92400e;">üéØ ' + classeLabel + '</span>';
        if (ev.moduleId) html += '<span class="ei-badge" style="background:#dbeafe;color:#1e40af;">üìò ' + ev.moduleId + '</span>';
        if (ev.timer > 0) html += '<span class="ei-badge" style="background:#fef3c7;color:#92400e;">‚è± ' + ev.timer + ' min</span>';
        html += '<span class="ei-badge" style="background:#1e293b;color:#94a3b8;">Mode : ' + (ev.mode || 'libre') + '</span>';
        html += '</div></div>';

        // Documents
        if (docs.length > 0) {
            html += '<div style="margin-bottom:14px;">';
            html += '<div style="font-weight:700; font-size:0.85rem; color:#94a3b8; margin-bottom:6px; text-transform:uppercase;">Documents (' + docs.length + ')</div>';
            docs.forEach(function(d) {
                const icon = d.type === 'image' ? 'üñºÔ∏è' : (d.type === 'video' ? 'üé¨' : 'üìÑ');
                html += '<div style="background:#0f172a; border-radius:8px; padding:10px; margin-bottom:6px; font-size:0.85rem; color:#e2e8f0;">';
                html += icon + ' <strong>' + (d.titre || 'Document') + '</strong>';
                if (d.type === 'image' && d.content) html += '<br><img src="' + d.content + '" style="max-width:100%;max-height:200px;margin-top:8px;border-radius:6px;" onerror="this.style.display=\'none\'">';
                if (d.type === 'text' && d.content) html += '<div style="margin-top:6px;color:#94a3b8;font-size:0.8rem;white-space:pre-wrap;">' + d.content.substring(0, 300) + (d.content.length > 300 ? '...' : '') + '</div>';
                if (d.type === 'video' && d.content) {
                    const embedUrl = extractYouTubeEmbed(d.content);
                    if (embedUrl) html += '<iframe src="' + embedUrl + '" style="width:100%;aspect-ratio:16/9;max-height:200px;border:none;border-radius:8px;margin-top:8px;" allowfullscreen></iframe>';
                    else html += '<div style="margin-top:6px;color:#ef4444;font-size:0.8rem;">URL video invalide</div>';
                }
                if (d.description) html += '<div style="margin-top:6px;color:#94a3b8;font-size:0.8rem;white-space:pre-wrap;">' + d.description + '</div>';
                html += '</div>';
            });
            html += '</div>';
        }

        // Points total
        let totalPoints = 0;
        qs.forEach(function(q) { totalPoints += (q.points || 0); });
        html += '<div style="font-weight:700; font-size:0.85rem; color:#94a3b8; margin-bottom:10px; text-transform:uppercase;">Questions ‚Äî Total : ' + totalPoints + ' pts</div>';

        // Questions
        qs.forEach(function(q, i) {
            html += '<div class="modal-q" style="border-left-color:#3b82f6;">';
            html += '<div class="mq-header">';
            html += '<span class="mq-num">Q' + (i + 1) + '</span>';
            html += '<span style="font-size:0.7rem; padding:2px 6px; border-radius:4px; background:#1e293b; color:#94a3b8; margin-left:6px;">' + (q.type || '?') + '</span>';
            if (q.competence) html += '<span style="font-size:0.7rem; padding:2px 6px; border-radius:4px; background:#312e81; color:#a5b4fc; margin-left:4px;">' + q.competence + '</span>';
            html += '<span style="font-size:0.7rem; padding:2px 6px; border-radius:4px; background:#064e3b; color:#6ee7b7; margin-left:auto;">' + (q.points || 0) + ' pt' + ((q.points || 0) > 1 ? 's' : '') + '</span>';
            html += '</div>';
            html += '<div class="mq-question">' + (q.question || '') + '</div>';

            // Choices for QCM
            if ((q.type === 'qcm_single' || q.type === 'qcm_multi') && q.choices) {
                html += '<div style="margin:6px 0; font-size:0.8rem;">';
                q.choices.forEach(function(ch, ci) {
                    const isCorrect = q.type === 'qcm_single' ? ci === q.correct : (q.correct || []).includes(ci);
                    html += '<div style="padding:3px 8px; margin:2px 0; border-radius:4px; ' + (isCorrect ? 'background:rgba(34,197,94,0.15); color:#22c55e;' : 'color:#94a3b8;') + '">';
                    html += (isCorrect ? '‚úÖ' : '‚óã') + ' ' + ch;
                    html += '</div>';
                });
                html += '</div>';
            } else {
                html += '<div class="mq-detail mq-correct-ans">‚úÖ Reponse : ' + formatCorrectAnswer(q) + '</div>';
            }

            if (q.correction) html += '<div class="mq-detail" style="background:rgba(245,158,11,0.1); color:#fbbf24;">üìù Correction : ' + q.correction + '</div>';
            if (q.explication) html += '<div class="mq-detail" style="background:rgba(139,92,246,0.1); color:#c4b5fd;">üí° Explication : ' + q.explication + '</div>';
            if (q.documentRef) html += '<div style="font-size:0.7rem; color:#64748b; margin-top:4px;">üìé Document : ' + q.documentRef + '</div>';
            html += '</div>';
        });

        // Link to editor
        if (currentEvalId) {
            html += '<div style="text-align:center; margin-top:20px; padding-top:16px; border-top:1px solid #1e293b;">';
            html += '<a href="editeur_eval.html?id=' + currentEvalId + '" style="color:#3b82f6; font-weight:700; text-decoration:none; font-size:0.9rem;">‚úèÔ∏è Ouvrir dans l\'editeur pour modifier</a>';
            html += '</div>';
        }

        document.getElementById('modal-eval-body').innerHTML = html;
        document.getElementById('modal-eval-preview').classList.add('visible');
    };

    window.closeEvalPreview = function() {
        document.getElementById('modal-eval-preview').classList.remove('visible');
    };

    function formatStudentAnswer(q, answer) {
        if (answer === null || answer === undefined) return '<em>Non repondu</em>';
        if (q.type === 'qcm_single') return (q.choices || [])[answer] || '?';
        if (q.type === 'qcm_multi') return (Array.isArray(answer) ? answer : []).map(i => (q.choices || [])[i]).join(', ') || '?';
        if (q.type === 'vf') return answer === true ? 'Vrai' : 'Faux';
        if (q.type === 'mot') return String(answer);
        if (q.type === 'nombre') return String(answer);
        return String(answer);
    }

    function extractYouTubeEmbed(url) {
        if (!url) return null;
        let videoId = null;
        try {
            // youtube.com/watch?v=ID
            const u = new URL(url);
            if (u.hostname.includes('youtube.com') && u.searchParams.get('v')) {
                videoId = u.searchParams.get('v');
            }
            // youtu.be/ID
            else if (u.hostname === 'youtu.be') {
                videoId = u.pathname.slice(1);
            }
            // youtube.com/embed/ID
            else if (u.hostname.includes('youtube.com') && u.pathname.startsWith('/embed/')) {
                videoId = u.pathname.split('/embed/')[1];
            }
        } catch(e) {}
        // Fallback regex
        if (!videoId) {
            const m = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            if (m) videoId = m[1];
        }
        return videoId ? 'https://www.youtube.com/embed/' + videoId : null;
    }

    function formatCorrectAnswer(q) {
        if (q.type === 'qcm_single') return (q.choices || [])[q.correct] || '?';
        if (q.type === 'qcm_multi') return (q.correct || []).map(i => (q.choices || [])[i]).join(', ') || '?';
        if (q.type === 'vf') return q.correct === true ? 'Vrai' : 'Faux';
        if (q.type === 'mot') return q.correct || q.reponse || '?';
        if (q.type === 'nombre') return String(q.correct) + (q.tolerance ? ' (¬± ' + q.tolerance + ')' : '');
        return '?';
    }

    // === EXPORT CSV ===
    window.exportCSV = function() {
        if (filteredResults.length === 0) {
            showToast('Aucun resultat a exporter.');
            return;
        }

        const bareme = currentEvalData ? (currentEvalData.bareme || 20) : 20;
        const header = ['Eleve', 'Code', 'Classe', 'Note/' + bareme, 'Note auto', 'Note ajustee', 'C1', 'C2', 'C3', 'C4', 'C5', 'C6', 'Statut', 'Temps (sec)', 'Date', 'Sorties onglet', 'Copier-coller', 'Clics droit', 'Captures ecran'];

        const rows = filteredResults.map(r => {
            const comps = [];
            for (let c = 1; c <= 6; c++) {
                const comp = r.competences['C' + c];
                if (comp) {
                    const compPct = comp.max > 0 ? (comp.pts / comp.max) * 100 : 0;
                    let level = 'NT';
                    if (compPct >= 80) level = 'M';
                    else if (compPct >= 50) level = 'A';
                    else if (compPct > 0) level = 'I';
                    comps.push(level);
                } else {
                    comps.push('-');
                }
            }
            const displayNote = getDisplayNote(r);
            return [
                getNomEleve(r.eleveCode) || r.eleveCode,
                r.eleveCode,
                r.classe,
                displayNote !== null ? displayNote : '--',
                r.note !== null ? r.note : '--',
                (r.note_ajustee !== null && r.note_ajustee !== undefined) ? r.note_ajustee : '',
                ...comps,
                r.publie ? 'Publie' : 'Soumis',
                r.tempsSecondes,
                formatDate(r.submittedAt),
                r.tabSwitchCount,
                r.copyPasteCount || 0,
                r.rightClickCount || 0,
                r.screenshotCount || 0
            ].join(';');
        });

        const csv = '\ufeff' + header.join(';') + '\n' + rows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'resultats_eval_' + (currentEvalData?.titre || 'export').replace(/\s+/g, '_') + '.csv';
        a.click();
        URL.revokeObjectURL(url);
        showToast('CSV exporte !');
    };

    // === EXPORT PDF ===
    window.exportResultsPDF = function() {
        if (!currentEvalData) { showToast('Selectionnez une evaluation.'); return; }
        if (filteredResults.length === 0) { showToast('Aucun resultat a exporter.'); return; }

        const bareme = currentEvalData.bareme || 20;
        const titre = currentEvalData.titre || 'Evaluation';
        const now = new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

        // Stats
        const notes = filteredResults.map(r => getDisplayNote(r)).filter(n => n !== null && n !== undefined && !isNaN(n)).map(n => parseFloat(n));
        const avg = notes.length > 0 ? (notes.reduce((a, b) => a + b, 0) / notes.length).toFixed(1) : '--';
        const min = notes.length > 0 ? Math.min(...notes).toFixed(1) : '--';
        const max = notes.length > 0 ? Math.max(...notes).toFixed(1) : '--';
        const publies = filteredResults.filter(r => r.publie).length;

        // Build table rows
        let tableRows = '';
        filteredResults.forEach(r => {
            const displayNote = getDisplayNote(r);
            const noteStr = displayNote !== null ? displayNote + '/' + bareme : '--';
            const adjusted = (r.note_ajustee !== null && r.note_ajustee !== undefined) ? ' (ajuste)' : '';
            let comps = '';
            for (let c = 1; c <= 6; c++) {
                const comp = r.competences['C' + c];
                if (comp) {
                    const compPct = comp.max > 0 ? (comp.pts / comp.max) * 100 : 0;
                    let level = 'NT';
                    if (compPct >= 80) level = 'M';
                    else if (compPct >= 50) level = 'A';
                    else if (compPct > 0) level = 'I';
                    comps += '<td>' + level + '</td>';
                } else {
                    comps += '<td>-</td>';
                }
            }
            const dateStr = formatDate(r.submittedAt);
            const displayName = getNomEleve(r.eleveCode) ? (getNomEleve(r.eleveCode) + ' (' + r.eleveCode + ')') : r.eleveCode;
            // Anti-cheat alerts summary
            let alertParts = [];
            if (r.tabSwitchCount > 0) alertParts.push(r.tabSwitchCount + ' sortie(s)');
            if (r.copyPasteCount > 0) alertParts.push(r.copyPasteCount + ' copier-coller');
            if (r.rightClickCount > 0) alertParts.push(r.rightClickCount + ' clic(s) droit');
            if (r.screenshotCount > 0) alertParts.push(r.screenshotCount + ' capture(s)');
            const alertStr = alertParts.length > 0 ? alertParts.join(', ') : '-';
            tableRows += '<tr>' +
                '<td>' + displayName + '</td>' +
                '<td>' + r.classe + '</td>' +
                '<td style="font-weight:bold;">' + noteStr + adjusted + '</td>' +
                comps +
                '<td>' + (r.publie ? 'Publie' : 'Soumis') + '</td>' +
                '<td>' + dateStr + '</td>' +
                '<td style="font-size:0.7rem;color:#dc2626;">' + alertStr + '</td>' +
                '</tr>';
        });

        const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Resultats ‚Äî ' + titre + '</title>' +
            '<style>' +
            'body { font-family: Arial, sans-serif; padding: 30px; color: #000; }' +
            'h1 { font-size: 1.4rem; margin-bottom: 4px; }' +
            '.meta { font-size: 0.85rem; color: #555; margin-bottom: 16px; }' +
            '.stats { display: flex; gap: 20px; margin-bottom: 20px; padding: 12px; background: #f5f5f5; border-radius: 8px; font-size: 0.85rem; }' +
            '.stats strong { color: #000; }' +
            'table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }' +
            'th { background: #1e293b; color: white; padding: 8px 6px; text-align: left; font-size: 0.75rem; }' +
            'td { padding: 6px; border-bottom: 1px solid #ddd; }' +
            'tr:nth-child(even) { background: #f9f9f9; }' +
            '@media print { body { padding: 10px; } }' +
            '</style></head><body>' +
            '<h1>Resultats : ' + titre + '</h1>' +
            '<div class="meta">Exporte le ' + now + ' | Bareme : /' + bareme + '</div>' +
            '<div class="stats">' +
                '<span><strong>' + filteredResults.length + '</strong> soumis</span>' +
                '<span>Moyenne : <strong>' + avg + '/' + bareme + '</strong></span>' +
                '<span>Min : <strong>' + min + '</strong></span>' +
                '<span>Max : <strong>' + max + '</strong></span>' +
                '<span><strong>' + publies + '</strong> publies</span>' +
            '</div>' +
            '<table><thead><tr>' +
                '<th>Eleve</th><th>Classe</th><th>Note</th>' +
                '<th>C1</th><th>C2</th><th>C3</th><th>C4</th><th>C5</th><th>C6</th>' +
                '<th>Statut</th><th>Date</th><th>Alertes</th>' +
            '</tr></thead><tbody>' + tableRows + '</tbody></table>' +
            '<script>window.onload=function(){window.print();}<\/script>' +
            '</body></html>';

        const w = window.open('', '_blank');
        w.document.write(html);
        w.document.close();
    };

    // === DELETE EVALUATION ===
    window.deleteEvaluation = function() {
        if (!currentEvalId || !currentEvalData) {
            showToast('Selectionnez une evaluation.');
            return;
        }

        const titre = currentEvalData.titre || 'Evaluation';
        const nbResults = results.length;
        const nbPublies = results.filter(r => r.publie).length;

        let bodyHtml = '';
        bodyHtml += '<div class="del-eval-info">';
        bodyHtml += '<strong>' + titre + '</strong><br>';
        bodyHtml += nbResults + ' resultat(s) dont ' + nbPublies + ' publie(s)';
        bodyHtml += '</div>';

        bodyHtml += '<button class="del-eval-btn del-eval-full" onclick="deleteEvalFull()">üóëÔ∏è Tout supprimer (eval + resultats eleves)</button>';
        bodyHtml += '<button class="del-eval-btn del-eval-keep" onclick="deleteEvalKeepResults()">üìã Supprimer eval, garder les notes</button>';
        bodyHtml += '<button class="del-eval-btn del-eval-cancel" onclick="closeDeleteModal()">Annuler</button>';
        bodyHtml += '<span class="del-eval-pdf-link" onclick="exportResultsPDF()">üìÑ Exporter en PDF avant de supprimer</span>';

        document.getElementById('modal-delete-title').textContent = 'Supprimer : ' + titre;
        document.getElementById('modal-delete-body').innerHTML = bodyHtml;
        document.getElementById('modal-delete-eval').classList.add('visible');
    };

    window.closeDeleteModal = function() {
        document.getElementById('modal-delete-eval').classList.remove('visible');
    };

    window.deleteEvalFull = async function() {
        if (!currentAuthUser) {
            showToast('üîê Connectez-vous pour supprimer');
            connexionProf();
            return;
        }
        const nbResults = results.length;
        if (!confirm('ATTENTION : Cela va supprimer l\'evaluation ET tous les resultats de ' + nbResults + ' eleve(s).\n\nCette action est IRREVERSIBLE. Confirmer ?')) return;

        closeDeleteModal();
        showToast('Suppression en cours...');

        try {
            // 1. Delete all eval_reponses for this eval
            const qReponses = query(collection(db, "eval_reponses"), where("evalId", "==", currentEvalId));
            const reponseSnap = await getDocs(qReponses);
            const deleteTasks = [];
            const eleveCodes = new Set();

            reponseSnap.forEach(d => {
                deleteTasks.push(deleteDoc(doc(db, "eval_reponses", d.id)));
                const data = d.data();
                if (data.eleveCode) eleveCodes.add(data.eleveCode);
            });

            // 2. Delete resultats/{eleveCode}/evaluations/{evalId}_eval for each student
            eleveCodes.forEach(code => {
                deleteTasks.push(deleteDoc(doc(db, "resultats", code, "evaluations", currentEvalId + '_eval')));
            });

            // 3. Delete resultats/{eleveCode}/copies/{evalId}_autoeval for each student
            eleveCodes.forEach(code => {
                deleteTasks.push(deleteDoc(doc(db, "resultats", code, "copies", currentEvalId + '_autoeval')));
            });

            // 4. Delete eval_sessions for this eval
            const qSessions = query(collection(db, "eval_sessions"), where("evalId", "==", currentEvalId));
            const sessionSnap = await getDocs(qSessions);
            sessionSnap.forEach(d => {
                deleteTasks.push(deleteDoc(doc(db, "eval_sessions", d.id)));
            });

            // 5. Delete the evaluation itself
            deleteTasks.push(deleteDoc(doc(db, "eval_banque", currentEvalId)));

            await Promise.all(deleteTasks);

            // 6. Clean up local state
            resetAfterEvalDelete();
            showToast('Evaluation et ' + eleveCodes.size + ' resultat(s) supprimes !');
        } catch(e) {
            console.error("Erreur suppression totale:", e);
            alert("Erreur : " + e.message);
        }
    };

    window.deleteEvalKeepResults = async function() {
        if (!confirm('Supprimer l\'evaluation de la banque ?\n\nLes notes des eleves seront conservees dans "Mes Resultats". Confirmer ?')) return;

        closeDeleteModal();
        showToast('Suppression en cours...');

        try {
            await deleteDoc(doc(db, "eval_banque", currentEvalId));
            resetAfterEvalDelete();
            showToast('Evaluation supprimee (notes conservees)');
        } catch(e) {
            console.error("Erreur suppression partielle:", e);
            alert("Erreur : " + e.message);
        }
    };

    function resetAfterEvalDelete() {
        // Remove from local list
        const idx = allEvals.findIndex(e => e.id === currentEvalId);
        if (idx > -1) allEvals.splice(idx, 1);

        // Reset current state
        currentEvalId = null;
        currentEvalData = null;
        results = [];
        filteredResults = [];

        // Re-render UI
        buildSidebarFilters();
        renderEvalSelector();
        renderEvalSidebarList();
        document.getElementById('eval-title-display').textContent = 'Evaluation';
        document.getElementById('results-tbody').innerHTML = '<tr><td colspan="13"><div class="table-empty"><div class="te-icon">üì≠</div><p>Selectionnez une evaluation dans la sidebar.</p></div></td></tr>';
        document.getElementById('stat-soumis').textContent = '0';
        document.getElementById('stat-moyenne').textContent = '--';
        document.getElementById('stat-min').textContent = '--';
        document.getElementById('stat-max').textContent = '--';
        document.getElementById('stat-publies').textContent = '0';
    }

    // === SESSION MANAGEMENT (synchronized mode) ===
    window.createSession = async function() {
        if (!currentEvalId || !currentEvalData) return;

        const code = generateSessionCode();
        sessionId = 'eval_' + currentEvalId + '_' + Date.now();

        try {
            await setDoc(doc(db, "eval_sessions", sessionId), {
                evalId: currentEvalId,
                code: code,
                status: 'lobby', // lobby, active, ended
                classeId: currentEvalData.classeId || null,
                createdAt: new Date().toISOString(),
                students: []
            });

            document.getElementById('session-code-display').textContent = code;
            document.getElementById('session-code-display').style.display = 'block';
            document.getElementById('btn-create-session').disabled = true;
            document.getElementById('btn-start-session').disabled = false;
            document.getElementById('btn-end-session').disabled = true;

            // Listen to session for student joins
            listenToSession();

            showToast('Session creee ! Code : ' + code);
        } catch(e) {
            console.error("Erreur creation session:", e);
            alert("Erreur : " + e.message);
        }
    };

    window.startSession = async function() {
        if (!sessionId) return;
        try {
            await updateDoc(doc(db, "eval_sessions", sessionId), { status: 'active' });
            document.getElementById('btn-start-session').disabled = true;
            document.getElementById('btn-end-session').disabled = false;
            showToast('Session demarree !');
        } catch(e) {
            console.error("Erreur demarrage session:", e);
        }
    };

    window.endSession = async function() {
        if (!sessionId) return;
        try {
            await updateDoc(doc(db, "eval_sessions", sessionId), { status: 'ended' });
            document.getElementById('btn-start-session').disabled = true;
            document.getElementById('btn-end-session').disabled = true;

            if (sessionUnsubscribe) { sessionUnsubscribe(); sessionUnsubscribe = null; }
            showToast('Session terminee.');

            // Refresh results
            await loadResults();
        } catch(e) {
            console.error("Erreur fin session:", e);
        }
    };

    function listenToSession() {
        if (sessionUnsubscribe) sessionUnsubscribe();

        sessionUnsubscribe = onSnapshot(doc(db, "eval_sessions", sessionId), (docSnap) => {
            if (!docSnap.exists()) return;
            const data = docSnap.data();
            renderSessionStudents(data.students || []);
        });
    }

    function renderSessionStudents(students) {
        const container = document.getElementById('session-students');
        if (students.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#64748b; font-size:0.8rem; padding:8px;">En attente d\'eleves...</div>';
            return;
        }
        container.innerHTML = '';
        students.forEach(s => {
            const div = document.createElement('div');
            div.className = 'session-student';
            const statusClass = s.submitted ? 'ss-submitted' : 'ss-waiting';
            const statusText = s.submitted ? '‚úì Soumis' : '‚è≥ En cours';
            div.innerHTML = '<span class="ss-code">' + s.code + '</span><span class="ss-status ' + statusClass + '">' + statusText + '</span>';
            container.appendChild(div);
        });
    }

    function generateSessionCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
        return code;
    }

    // === IMPORT CSV ELEVES ===
    window.importCSVEleves = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const lignes = e.target.result.split(/\r?\n/);
            const eleves = JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}');
            let nb = 0;
            lignes.forEach(ligne => {
                ligne = ligne.trim();
                if (!ligne) return;
                const parts = ligne.split(/[,;]/);
                if (parts.length >= 2) {
                    const code = parts[0].trim().toUpperCase();
                    const nom = parts.slice(1).join(' ').trim();
                    if (code && nom) { eleves[code] = nom; nb++; }
                }
            });
            localStorage.setItem(CLE_ELEVES, JSON.stringify(eleves));
            updateImportStatus();
            if (results.length > 0) renderTable();
            showToast(nb + ' eleve(s) importe(s) !');
        };
        reader.readAsText(file, 'UTF-8');
    };

    function updateImportStatus() {
        const eleves = JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}');
        const nb = Object.keys(eleves).length;
        const el = document.getElementById('import-status');
        if (nb > 0) {
            el.innerHTML = '‚úÖ ' + nb + ' eleve(s) charges';
            el.style.color = '#22c55e';
        } else {
            el.innerHTML = '‚ö†Ô∏è Aucun nom charge ‚Äî importe ton CSV';
            el.style.color = '#f59e0b';
        }
    }
    updateImportStatus();

    // === TOAST ===
    function showToast(msg) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 2500);
    }
    window.showToast = showToast;
</script>
</body>
</html>

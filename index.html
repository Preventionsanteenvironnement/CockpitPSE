<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cockpit Professeur â€“ Pilotage Global</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="annuaire.js"></script>

  <style>
    /* --- TON CSS D'ORIGINE (INTACT) --- */
    :root{
      --bg-body:#f1f5f9; --bg-sidebar:#0f172a; --text-main:#1e293b; --text-muted:#64748b;
      --col-pedago:#3b82f6; --col-eval:#f59e0b; --col-class:#10b981; --col-proj:#8b5cf6;
      --col-admin:#f97316; --col-live-web:#795548; --col-sites:#607d8b;
    }
    *{box-sizing:border-box;}
    body{ margin:0; font-family:'Inter',sans-serif; background-color:var(--bg-body); color:var(--text-main); display:flex; height:100vh; overflow:hidden; }

    /* SIDEBAR & NAV */
    .sidebar{ width:300px; background-color:var(--bg-sidebar); color:#fff; display:flex; flex-direction:column; padding:20px; flex-shrink:0; overflow-y:auto; gap:10px; position: relative; }
    .brand{ font-size:1.3rem; font-weight:800; margin-bottom:20px; letter-spacing:1px; display:flex; align-items:center; gap:10px; }
    .nav-category{ font-size:.75rem; text-transform:uppercase; letter-spacing:1px; font-weight:700; color:#64748b; margin:15px 0 5px; }
    .nav-item{ display:flex; align-items:center; gap:12px; padding:12px 15px; border-radius:8px; cursor:pointer; transition:.2s; font-weight:600; color:#cbd5e1; border-left:4px solid transparent; }
    .nav-item:hover{background:rgba(255,255,255,.05); color:#fff;}
    .nav-item.active{background:rgba(255,255,255,.10); color:#fff;}
    /* Couleurs Nav */
    .nav-item[data-theme="pedago"].active{border-left-color:var(--col-pedago);}
    .nav-item[data-theme="eval"].active{border-left-color:var(--col-eval);}
    .nav-item[data-theme="class"].active{border-left-color:var(--col-class);}
    .nav-item[data-theme="proj"].active{border-left-color:var(--col-proj);}
    .nav-item[data-theme="admin"].active{border-left-color:var(--col-admin);}
    .nav-item[data-theme="live"].active{border-left-color:var(--col-live-web);}
    .nav-item[data-theme="sites"].active{border-left-color:var(--col-sites);}

    /* MAIN CONTENT */
    .main-content{ flex:1; padding:40px; overflow-y:auto; display:flex; flex-direction:column; position:relative; }
    header{ display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:30px; border-bottom:1px solid #e2e8f0; padding-bottom:20px; }
    h1{margin:0; font-size:2rem; font-weight:800; color:var(--text-main);}
    .header-infos{text-align:right;}
    .clock-time{font-size:1.5rem; font-weight:800;}
    .clock-date{font-size:.9rem; color:var(--text-muted);}
    .vacation-badge{ margin-top:5px; font-size:.8rem; background:#dbeafe; color:#2563eb; padding:4px 10px; border-radius:20px; border:1px solid #bfdbfe; font-weight:bold; }

    /* SECTIONS */
    .view-section{display:none; animation:fadeUp .4s ease-out;}
    .view-section.active{display:block;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

    /* WIDGETS DASHBOARD */
    .quick-actions{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:30px; }
    .btn-quick{ background:#fff; border:1px solid #e2e8f0; padding:15px; border-radius:12px; text-align:left; cursor:pointer; transition:.2s; display:flex; align-items:center; gap:15px; box-shadow:0 2px 4px rgba(0,0,0,.02); text-decoration:none; color:inherit; }
    .btn-quick:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.05); border-color:var(--col-pedago); }

    .dashboard-grid{display:grid; grid-template-columns:2fr 1fr; gap:25px;}
    .widget{ background:#fff; border-radius:16px; padding:25px; border:1px solid #e2e8f0; display:flex; flex-direction:column; min-height:320px; }
    .widget h3{ margin:0 0 15px; padding-bottom:10px; border-bottom:2px solid #f1f5f9; font-size:1.1rem; display:flex; justify-content:space-between; align-items:center; }

    /* --- CSS AJOUTÃ‰ POUR LE MODULE TRAFIC & GRAPHIQUES --- */
    
    /* Cartes Statistiques (AmÃ©liorÃ©es pour Ãªtre cliquables) */
    .stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-color: var(--col-pedago); }
    .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .icon-blue { background: #e0f2fe; color: #0284c7; }
    .icon-purple { background: #f3e8ff; color: #9333ea; }
    .icon-green { background: #dcfce7; color: #16a34a; }
    .stat-info h4 { margin: 0; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
    .stat-info p { margin: 5px 0 0; font-size: 1.4rem; font-weight: 800; color: #0f172a; }

    /* Modale Trafic (Overlay & FenÃªtre) */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; animation: fadeIn 0.3s; }
    .traffic-modal { background: #fff; width: 95%; height: 95vh; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .traffic-header { padding: 20px; background: #0f172a; color: white; display: flex; justify-content: space-between; align-items: center; }
    .traffic-body { padding: 20px; overflow-y: auto; flex: 1; background: #f8fafc; }
    
    .traffic-filters { display: flex; gap: 15px; background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .tf-select { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-weight: 600; color: #334155; }
    
    .traffic-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
    .traffic-box { background: white; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .traffic-box h3 { margin-top: 0; color: #64748b; font-size: 0.9rem; text-transform: uppercase; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }

    /* Tableaux de donnÃ©es */
    .results-table { width:100%; border-collapse:collapse; min-width:600px; }
    .results-table thead { background:#f1f5f9; color:#475569; }
    .results-table th { padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:.88rem; cursor: pointer; }
    .results-table td { padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:.88rem; }
    .results-table tr:hover { background:#f8fafc; }
    .pill { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-right: 5px; display: inline-block; }
    .pill-green { background: #dcfce7; color: #166534; }
    .pill-blue { background: #dbeafe; color: #1e40af; }

    /* Graphiques & Badges */
    .chart-container { height: 250px; width: 100%; position: relative; }
    .radar-container { height: 320px; display: flex; justify-content: center; margin-bottom: 10px; }
    .badge-period { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
    .bg-school { background-color: #3b82f6; } .bg-evening { background-color: #8b5cf6; } .bg-weekend { background-color: #f97316; }

    /* Utils UI */
    .close-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; }
    .close-btn:hover { background: rgba(255,255,255,0.2); }
    .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
    
    /* ElÃ©ments de ton CSS original conservÃ©s */
    .btn-yellow{ display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:#fffbeb; color:#b45309; border:1px solid #fcd34d; border-radius:6px; text-decoration:none; font-weight:600; font-size:.85rem; }
    .btn-blue-outline{ display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:#f0f9ff; color:#0369a1; border:1px solid #bae6fd; border-radius:6px; text-decoration:none; font-weight:600; font-size:.85rem; cursor:pointer; }
    .badge-soon{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; margin-left:6px; border:1px solid rgba(0,0,0,.05); background:#fef3c7; color:#92400e; }
    details{ background:#fff; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px; overflow:hidden; }
    summary{ padding:15px; font-weight:600; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; }
    details[open]>summary{background:#f1f5f9; border-bottom:1px solid #e2e8f0;}
    .content-links{ padding:15px; display:flex; flex-wrap:wrap; gap:10px; }
    .live-block{ margin-top:12px; border:1px solid rgba(0,0,0,.08); border-radius:14px; overflow:hidden; background:#fff; }
    .live-summary{ font-weight:900; padding:14px 16px; background:#f1f5f9; }
    .live-links{padding:14px 12px;}
    .badge-role{ display:inline-flex; align-items:center; padding:2px 10px; border-radius:999px; font-size:12px; font-weight:900; margin-left:8px; border:1px solid rgba(0,0,0,.08); white-space:nowrap; }
    .role-eleve{background:rgba(245,158,11,.18); color:#a16207;}
    .role-prof{background:rgba(59,130,246,.18); color:#1d4ed8;}
    
    /* Listes d'agenda */
    .planning-list, .alert-list, .agenda-list { list-style:none; padding:0; margin:0; flex:1; overflow-y:auto; }
    .course-item, .alert-item, .agenda-item { display:flex; align-items:center; padding:12px; border-bottom:1px solid #f1f5f9; gap:15px; transition:.2s; }
    .course-time { font-weight:700; color:var(--col-pedago); min-width:50px; }
    .alert-item { background:#fffbeb; border-left:4px solid #f59e0b; border-radius:4px; margin-bottom:8px; justify-content:space-between; }
    .agenda-form { display:flex; gap:8px; margin-bottom:15px; flex-wrap:wrap; }
    .wide { flex:1; }
    input, select { padding:8px; border:1px solid #cbd5e1; border-radius:6px; }

    /* Mobile */
    .menu-btn, .close-sidebar-btn { display:none; }
    @media(max-width:980px){
      .sidebar{ position:fixed; top:0; left:0; bottom:0; height:100vh; width:280px; transform:translateX(-100%); transition:0.3s; z-index:1000; }
      body.menu-open .sidebar{transform:translateX(0);}
      .menu-btn{display:inline-block; background:none; border:none; font-size:1.5rem; margin-right:10px;}
      .close-sidebar-btn{display:block; position:absolute; top:10px; right:10px; background:none; border:none; color:white; font-size:1.5rem;}
      .dashboard-grid, .stats-overview, .traffic-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div id="modalTraffic" class="modal-overlay">
    <div class="traffic-modal">
      <div class="traffic-header">
        <h2 style="margin:0; display:flex; align-items:center; gap:10px;">ğŸ“¡ MODULE PILOTAGE TRAFIC <span style="font-size:0.8rem; background:#3b82f6; padding:4px 8px; border-radius:10px;">Monitoring</span></h2>
        <button class="close-btn" onclick="closeTraffic()">Ã—</button>
      </div>
      
      <div class="traffic-body">
        <div class="traffic-filters">
          <span style="font-weight:800; color:#0f172a;">ğŸ›ï¸ FILTRES :</span>
          <select id="tf-period" class="tf-select" onchange="updateTrafficView()">
            <option value="7">ğŸ“… 7 derniers jours</option>
            <option value="30">ğŸ“… Ce mois</option>
            <option value="365">ğŸ“… Cette annÃ©e</option>
          </select>
          <select id="tf-class" class="tf-select" onchange="updateTrafficView()">
            <option value="ALL">ğŸ« Toutes les classes</option>
          </select>
          <select id="tf-student" class="tf-select" onchange="updateTrafficView()">
            <option value="ALL">ğŸ‘¤ Tous les Ã©lÃ¨ves</option>
          </select>
          <button onclick="chargerDonnees()" style="margin-left:auto; background:#3b82f6; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ”„ Actualiser</button>
        </div>

        <div class="traffic-grid">
          <div class="traffic-box">
            <div style="display:flex; justify-content:space-between;">
              <h3>ğŸ“Š Histogramme d'ActivitÃ© (Semaine)</h3>
              <div style="font-size:0.8rem;">
                <span class="badge-period bg-school"></span>Scolaire
                <span class="badge-period bg-evening"></span>Soir
                <span class="badge-period bg-weekend"></span>Week-end
              </div>
            </div>
            <div class="chart-container"><canvas id="chartActivity"></canvas></div>
          </div>
          <div class="traffic-box">
            <h3>ğŸ•’ Radar Temporel</h3>
            <div class="chart-container"><canvas id="chartPie"></canvas></div>
          </div>
        </div>

        <div class="traffic-grid">
          <div class="traffic-box">
            <h3>ğŸ“ Tableau de PrÃ©sence</h3>
            <div style="overflow-y:auto; max-height:300px;">
              <table class="results-table">
                <thead><tr><th>Ã‰lÃ¨ve</th><th style="text-align:center;">Connexions</th><th>DerniÃ¨re vue</th></tr></thead>
                <tbody id="tbody-presence"></tbody>
              </table>
            </div>
          </div>
          <div class="traffic-box">
            <h3>ğŸ“‹ Journal de Bord (Logs)</h3>
            <div style="overflow-y:auto; max-height:300px;">
              <table class="results-table">
                <thead><tr><th>Heure</th><th>Qui ?</th><th>Quoi ?</th></tr></thead>
                <tbody id="tbody-logs"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="traffic-box">
          <h3>ğŸ“š Top Contenus ConsultÃ©s</h3>
          <div id="top-pages-list" style="display:flex; gap:15px; flex-wrap:wrap;"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="modalStudent" class="modal-overlay">
    <div class="student-modal">
        <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
            <h2 id="modal-name" style="margin:0;">Ã‰lÃ¨ve</h2>
            <button class="close-btn-dark" onclick="closeStudentModal()">Ã—</button>
        </div>
        <div style="padding:20px; overflow-y:auto;">
            <div style="height:300px; margin-bottom:20px;"><canvas id="studentRadar"></canvas></div>
            <h3 style="margin-bottom:10px;">Historique des notes</h3>
            <table class="results-table">
                <thead><tr><th>Date</th><th>Exercice</th><th>Note</th></tr></thead>
                <tbody id="modal-history"></tbody>
            </table>
        </div>
    </div>
  </div>

  <button id="menuBtn" class="menu-btn" onclick="document.body.classList.add('menu-open')">â˜°</button>
  
  <nav class="sidebar" id="mySidebar">
    <button class="close-sidebar-btn" onclick="document.body.classList.remove('menu-open')">âœ•</button>
    <div class="brand">ğŸš€ COCKPIT</div>
    <div class="nav-item active" onclick="showView('dashboard', this)">ğŸ  Tableau de bord</div>
    <div class="nav-category">Pilotage</div>
    <div class="nav-item" onclick="showView('view-scores', this)">ğŸ“Š Suivi & Trafic</div>
    <div class="nav-category">Mes dossiers</div>
    <div class="nav-item" data-theme="pedago" onclick="showView('view-pedago', this)">ğŸŸ¦ 1. PÃ©dagogie & cours</div>
    <div class="nav-item" data-theme="eval" onclick="showView('view-eval', this)">ğŸŸ¨ 2. Ã‰valuation & suivi</div>
    <div class="nav-item" data-theme="class" onclick="showView('view-class', this)">ğŸŸ© 3. Classes & groupes</div>
    <div class="nav-item" data-theme="proj" onclick="showView('view-proj', this)">ğŸŸª 4. Projets & transversal</div>
    <div class="nav-item" data-theme="admin" onclick="showView('view-admin', this)">ğŸŸ§ 5. Temps & admin</div>
    <div class="nav-item" data-theme="live" onclick="showView('view-live', this)">ğŸŸ« 6. Classe en temps rÃ©el</div>
    <div class="nav-item" data-theme="sites" onclick="showView('view-sites', this)">ğŸŒ 7. Sites internet</div>
  </nav>

  <div id="menuOverlay" class="menu-overlay" onclick="document.body.classList.remove('menu-open')"></div>

  <main class="main-content">
    <header>
      <h1 id="page-title">Tableau de bord</h1>
      <div class="header-infos">
        <button onclick="chargerDonnees()" style="margin-right:15px; background:white; border:1px solid #cbd5e1; padding:5px 10px; border-radius:8px; cursor:pointer; font-size:0.9rem;">ğŸ”„ Tout actualiser</button>
        <span id="clock" class="clock-time">--:--</span>
        <div id="date" class="clock-date">--</div>
        <div id="vacation-badge" class="vacation-badge" style="display:none;"></div>
      </div>
    </header>

    <section id="dashboard" class="view-section active">
      <div class="quick-actions">
        <a href="prof_plan.html" target="_blank" class="btn-quick"><span>ğŸª‘</span><span><strong>Plan de classe</strong><br>Pilotage des places</span></a>
        <a href="https://www.pronote.index-education.net/" target="_blank" class="btn-quick"><span>ğŸ“</span><span><strong>Pronote Web</strong><br>AccÃ¨s rapide</span></a>
        <button class="btn-quick" type="button" onclick="document.getElementById('memo-input').focus()"><span>ğŸ§ </span><span><strong>MÃ©mo ciblÃ©</strong><br>Rappel contextuel</span></button>
      </div>
      <div class="dashboard-grid">
        <div class="widget">
          <h3>ğŸ“… Planning <span style="font-size:.8rem;"><button type="button" onclick="changeDate(-1)">â—€</button><span id="planning-date-label">Aujourdâ€™hui</span><button type="button" onclick="changeDate(1)">â–¶</button></span></h3>
          <ul id="planning-list" class="planning-list"></ul>
        </div>
        <div class="right-stack">
          <div class="widget">
            <h3>ğŸ’¡ Pense-bÃªte</h3>
            <div class="agenda-form">
              <select id="memo-target"><option value="dashboard">Tableau de bord</option><option value="view-pedago">PÃ©dagogie</option></select>
              <input id="memo-input" class="wide" placeholder="Note liÃ©e au contexteâ€¦" />
              <button type="button" onclick="addMemo()">+</button>
            </div>
            <ul id="memo-list" class="alert-list"></ul>
          </div>
          <div class="widget">
            <h3>ğŸ—“ï¸ Agenda</h3>
            <div class="agenda-form">
              <input id="agenda-date" type="date" /><input id="agenda-title" class="wide" placeholder="Titre..." />
              <button type="button" onclick="addAgenda()">+</button>
            </div>
            <ul id="agenda-list" class="agenda-list"></ul>
          </div>
        </div>
      </div>
    </section>

    <section id="view-scores" class="view-section">
      <h2 style="color:var(--col-eval);">Suivi des CompÃ©tences & Trafic</h2>
      
      <div class="stats-overview">
        <div class="stat-card" onclick="openTrafficModule()" style="border-left:5px solid #3b82f6;">
          <div class="stat-icon icon-blue">ğŸ‘€</div>
          <div class="stat-info">
            <h4>Trafic Total</h4>
            <p id="stat-total-views">0</p>
            <small style="color:#3b82f6; font-weight:bold;">ğŸ” Ouvrir le Module Trafic</small>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-green">ğŸ†</div>
          <div class="stat-info"><h4>Top Exercice</h4><p id="stat-top-page" style="font-size:1rem; font-weight:600;">--</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-purple">ğŸ‘¥</div>
          <div class="stat-info"><h4>Ã‰lÃ¨ves Actifs</h4><p id="stat-unique-users">0</p></div>
        </div>
      </div>

      <div class="dashboard-grid">
          <div class="widget">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span><strong>ğŸ“ DerniÃ¨res Ã©valuations</strong></span>
            </div>
            <div class="toolbar">
              <select id="filter-class" class="filter-select" onchange="applyFilters()"><option value="ALL">Toutes les classes</option></select>
              <input type="text" id="filter-student" class="filter-input" placeholder="ğŸ” Chercher..." onkeyup="applyFilters()">
            </div>
            <div style="overflow-x:auto;">
                <table class="results-table">
                    <thead><tr><th onclick="sortData('date')">Date â†•</th><th onclick="sortData('identifiant')">Ã‰lÃ¨ve â†•</th><th onclick="sortData('classe')">Classe â†•</th><th onclick="sortData('exercice_titre')">Exercice â†•</th><th onclick="sortData('note_finale')">Note â†•</th><th>CompÃ©tences</th></tr></thead>
                    <tbody id="tbody-eleves"><tr><td colspan="6" class="scores-empty">Chargement...</td></tr></tbody>
                </table>
            </div>
          </div>

          <div class="widget">
              <h3>ğŸ“Š CompÃ©tences Moyennes</h3>
              <div class="radar-container"><canvas id="radarChart"></canvas></div>
              <div style="text-align:center; margin-top:15px;">Moyenne : <strong id="moyenne-globale" style="color:#3b82f6;">--</strong></div>
          </div>
      </div>
    </section>

    <section id="view-pedago" class="view-section">
      <h2 style="color:var(--col-pedago);">PÃ©dagogie & cours</h2>
      <details open>
        <summary>ğŸ“ SÃ©quences CAP</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“ Exercices <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ—ºï¸ Progression <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
      <details>
        <summary>ğŸ“ SÃ©quences Bac Pro</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“ Exercices <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ—ºï¸ Progression <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
      <details id="course-structure">
        <summary>ğŸ“š Structure des cours CAP / Bac Pro</summary>
        <details class="lvl-cap">
          <summary>CAP</summary>
          <details>
            <summary>ThÃ©matique A â€“ Lâ€™individu et sa santÃ©</summary>
            <div class="content-links">
              <a href="#" class="btn-yellow">A1 â€“ SystÃ¨me de santÃ© <span class="badge-soon">BientÃ´t</span></a>
              <a href="#" class="btn-yellow">A2 â€“ Sommeil <span class="badge-soon">BientÃ´t</span></a>
              <a href="#" class="btn-yellow">A3 â€“ ActivitÃ© physique <span class="badge-soon">BientÃ´t</span></a>
              <a href="#" class="btn-yellow">A4 â€“ Addictions <span class="badge-soon">BientÃ´t</span></a>
            </div>
          </details>
          <details>
            <summary>ThÃ©matique B â€“ Environnement</summary>
            <div class="content-links">
              <a href="#" class="btn-yellow">B1 â€“ Ressource en eau <span class="badge-soon">BientÃ´t</span></a>
              <a href="#" class="btn-yellow">B2 â€“ Risques majeurs <span class="badge-soon">BientÃ´t</span></a>
            </div>
          </details>
        </details>
        <details class="lvl-bacpro">
          <summary>Bac Pro</summary>
          <details>
            <summary>Seconde Bac Pro</summary>
            <div class="content-links">
              <a href="#" class="btn-yellow">A â€“ SantÃ© <span class="badge-soon">BientÃ´t</span></a>
              <a href="#" class="btn-yellow">B â€“ Environnement <span class="badge-soon">BientÃ´t</span></a>
              <a href="#" class="btn-yellow">C â€“ Travail <span class="badge-soon">BientÃ´t</span></a>
            </div>
          </details>
        </details>
      </details>
      <details>
        <summary>ğŸ“˜ RÃ©fÃ©rentiels PSE</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">CAP PSE <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">Bac Pro PSE <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
    </section>

    <section id="view-eval" class="view-section">
      <h2 style="color:var(--col-eval);">Ã‰valuation & suivi</h2>
      <details open>
        <summary>ğŸ“Š PageProf & suivis</summary>
        <div class="content-links">
          <a href="pageprof.html" target="_blank" class="btn-yellow">ğŸ“Š Ouvrir PageProf</a>
          <a href="#" class="btn-yellow">ğŸ“ˆ Tableau de bord <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ§¾ Grilles / barÃ¨mes <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
      <details>
        <summary>ğŸ“‚ Historique & exports</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">ğŸ—“ï¸ Bilans <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“¥ Exports JSON / CSV <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
    </section>

    <section id="view-class" class="view-section">
      <h2 style="color:var(--col-class);">Classes & groupes</h2>
      <details open>
        <summary>ğŸª‘ Plans de classe</summary>
        <div class="content-links">
          <a href="prof_plan.html" target="_blank" class="btn-yellow">ğŸš€ Piloter</a>
          <button class="btn-blue-outline" type="button" onclick="window.open('ecran_plan.html','proj')">ğŸ“º Afficher au tableau</button>
        </div>
      </details>
      <details>
        <summary>ğŸ“‹ Listes dâ€™Ã©lÃ¨ves</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">ğŸ‘¥ Listes <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ” Recherche rapide <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
      <details>
        <summary>ğŸ§© Besoins particuliers</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">â™¿ AmÃ©nagements <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“˜ Dossiers MDPH / PAP <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
    </section>

    <section id="view-proj" class="view-section">
      <h2 style="color:var(--col-proj);">Projets & transversal</h2>
      <details open>
        <summary>ğŸ¨ Chef-dâ€™Å“uvre</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">CAP 1re annÃ©e <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">CAP 2e annÃ©e <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
      <details>
        <summary>ğŸ« Projet dâ€™Ã©tablissement</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Documents <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ—“ï¸ RÃ©unions / CR <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
      <details>
        <summary>ğŸ§  Ateliers CPS</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">SÃ©quences CPS <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">Outils dâ€™animation <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
    </section>

    <section id="view-admin" class="view-section">
      <h2 style="color:var(--col-admin);">Temps & institution</h2>
      <details open>
        <summary>ğŸ“… Emploi du temps</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">Vue semaine <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">Vue mois <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
      <details>
        <summary>ğŸ¢ PFMP / stages</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">Calendrier PFMP <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">Suivi Ã©lÃ¨ves <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
      <details>
        <summary>ğŸ¤ Pacte / missions</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">Heures rÃ©alisÃ©es <span class="badge-soon">BientÃ´t</span></a>
          <a href="#" class="btn-yellow">Bilans <span class="badge-soon">BientÃ´t</span></a>
        </div>
      </details>
    </section>
    
    <section id="view-live" class="view-section">
      <h2 style="color:var(--col-live-web);">Classe en temps rÃ©el</h2>
      <details class="live-block" open>
        <summary class="live-summary">ğŸ—¨ï¸ Sâ€™exprimer / Explorer</summary>
        <div class="content-links live-links">
          <a href="eleve_nuage.html" class="btn-yellow">ğŸŒ¥ï¸ Nuage de mots <span class="badge-role role-eleve">Ã‰lÃ¨ves</span></a>
          <a href="prof_nuage.html" class="btn-yellow">â˜ï¸ Nuage â€“ Prof <span class="badge-role role-prof">Prof</span></a>
          <a href="eleve_meteo.html" class="btn-yellow">ğŸ§  MÃ©tÃ©o Ã©lÃ¨ves <span class="badge-role role-eleve">Ã‰lÃ¨ves</span></a>
          <a href="prof_meteo.html" class="btn-yellow">ğŸ§  MÃ©tÃ©o â€“ Prof <span class="badge-role role-prof">Prof</span></a>
        </div>
      </details>
      <details class="live-block">
        <summary class="live-summary">ğŸ® Jeux / entraÃ®nement</summary>
        <div class="content-links live-links">
          <a href="eleve_vraifaux.html" class="btn-yellow">âœ…/âŒ Vrai / Faux <span class="badge-role role-eleve">Ã‰lÃ¨ves</span></a>
          <a href="prof_vraifaux.html" class="btn-yellow">âœ…/âŒ Vrai / Faux â€“ Prof <span class="badge-role role-prof">Prof</span></a>
        </div>
      </details>
      <details class="live-block">
        <summary class="live-summary">ğŸ“¤ Productions Ã©lÃ¨ves</summary>
        <div class="content-links live-links">
          <a href="devoirA3_cap_sedentarite_pse.html" class="btn-yellow">ğŸ“ CAP â€“ Devoir A3 sÃ©dentaritÃ©</a>
        </div>
      </details>
      <details class="live-block">
        <summary class="live-summary">ğŸ§˜ DÃ©tente</summary>
        <div class="content-links live-links">
          <a href="ecran_bulle.html" class="btn-yellow">ğŸ¤« Bulle silence <span class="badge-role role-prof">Prof</span></a>
          <a href="ecran_zen.html" class="btn-yellow">ğŸ§˜ Zen <span class="badge-role role-prof">Prof</span></a>
        </div>
      </details>
    </section>

    <section id="view-sites" class="view-section">
      <h2 style="color:var(--col-sites);">Sites internet favoris</h2>
      <details open>
        <summary>ğŸ¢ Administratif</summary>
        <div class="content-links">
          <a href="https://portail.ac-lyon.fr/" class="btn-yellow" target="_blank">Portail AcadÃ©mie</a>
          <a href="https://eduscol.education.fr/" class="btn-yellow" target="_blank">Eduscol</a>
          <a href="https://www.education.gouv.fr/bo" class="btn-yellow" target="_blank">BO Ã‰ducation</a>
          <a href="https://www.service-public.fr/" class="btn-yellow" target="_blank">Service-public</a>
          <a href="https://cas.ent.auvergnerhonealpes.fr" class="btn-yellow" target="_blank">ENT / Mail pro</a>
        </div>
      </details>
      <details>
        <summary>ğŸ“š Ressources pÃ©dagogiques</summary>
        <div class="content-links">
          <a href="https://www.inrs.fr/" class="btn-yellow" target="_blank">INRS</a>
          <a href="https://www.santepubliquefrance.fr/" class="btn-yellow" target="_blank">SantÃ© Publique France</a>
        </div>
      </details>
    </section>
  </main>

  <script>
    // 1. LOGIQUE D'ORIGINE (Agenda, Horloge, Navigation)
    function updateClock(){ const d=new Date(); document.getElementById("clock").innerText=d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0'); document.getElementById("date").innerText=d.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"}); }
    setInterval(updateClock,1000); updateClock();
    
    let planningOffset = 0; const planningData = [ {time:"08h30",label:"CAP â€“ PSE",room:"Salle 12"}, {time:"10h00",label:"Bac Pro â€“ PSE",room:"Salle 14"}, {time:"13h30",label:"Accompagnement perso",room:"CDI"} ];
    function renderPlanning(){ const l=document.getElementById("planning-list"); l.innerHTML=""; planningData.forEach(c=>{ l.innerHTML+=`<li class="course-item"><div class="course-time">${c.time}</div><div><strong>${c.label}</strong><br><small>${c.room}</small></div></li>`; }); }
    renderPlanning(); function changeDate(d){planningOffset+=d; renderPlanning();}

    function save(k,v){localStorage.setItem(k,JSON.stringify(v));} function load(k){try{return JSON.parse(localStorage.getItem(k))||[];}catch(e){return[];}}
    let memos=load("cockpit_memos"), agenda=load("cockpit_agenda");
    function renderMemos(){ const l=document.getElementById("memo-list"); l.innerHTML=""; memos.forEach((m,i)=>{ l.innerHTML+=`<li class="alert-item"><span>${m.text}</span><button onclick="memos.splice(${i},1);save('cockpit_memos',memos);renderMemos()">âœ•</button></li>`; }); }
    function addMemo(){ const v=document.getElementById("memo-input").value; if(v){memos.push({text:v,target:"dashboard"});save("cockpit_memos",memos);renderMemos();document.getElementById("memo-input").value="";} }
    function renderAgenda(){ const l=document.getElementById("agenda-list"); l.innerHTML=""; agenda.forEach((a,i)=>{ l.innerHTML+=`<li class="agenda-item"><div><strong>${a.title}</strong></div><button onclick="agenda.splice(${i},1);save('cockpit_agenda',agenda);renderAgenda()">âœ•</button></li>`; }); }
    function addAgenda(){ const t=document.getElementById("agenda-title").value; if(t){agenda.push({title:t,date:"Aujourd'hui"});save("cockpit_agenda",agenda);renderAgenda();} }
    renderMemos(); renderAgenda();

    function showView(id, el){
        document.querySelectorAll(".view-section").forEach(v=>v.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        if(el) { document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active")); el.classList.add("active"); }
        document.body.classList.remove("menu-open");
    }

    // Fonctions Modale Trafic
    function openTrafficModule(){ document.getElementById("modalTraffic").classList.add("open"); if(window.updateTrafficView) window.updateTrafficView(); }
    function closeTraffic(){ document.getElementById("modalTraffic").classList.remove("open"); }
    function closeStudentModal(){ document.getElementById("modalStudent").classList.remove("open"); }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let rawLogs = [], allEvaluations = [], filteredEvaluations = [];
    let chartActivity = null, chartPie = null, globalRadar = null;

    // --- CHARGEMENT ---
    window.chargerDonnees = async function() {
        console.log("Chargement...");
        
        // A. NOTES (Tableau & Radar)
        try {
            const q = query(collection(db, "resultats_exercices"), orderBy("timestamp", "desc"), limit(100));
            const snap = await getDocs(q);
            allEvaluations = []; let classes = new Set();
            snap.forEach(doc => {
                const d = doc.data();
                allEvaluations.push(d);
                if(d.classe) classes.add(d.classe);
            });
            const sel = document.getElementById("filter-class");
            sel.innerHTML = '<option value="ALL">Toutes les classes</option>';
            classes.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
            applyFilters();
        } catch(e) { console.error("Err Notes", e); }

        // B. TRAFIC (Logs)
        try {
            const qLogs = query(collection(db, "statistiques_usage"), orderBy("timestamp", "desc"), limit(500));
            const snapLogs = await getDocs(qLogs);
            rawLogs = []; let uniqueUsers = new Set(), classesSet = new Set(), studentsSet = new Set(), pageCounts = {};

            snapLogs.forEach(doc => {
                const d = doc.data();
                d.jsDate = d.timestamp ? d.timestamp.toDate() : new Date(d.date);
                if(d.userCode && d.userCode !== "ANONYME") uniqueUsers.add(d.userCode);
                if(d.classe && d.classe !== "AUTRE") classesSet.add(d.classe);
                if(d.userCode) studentsSet.add(d.userCode);
                let p = d.page || "Inconnu"; pageCounts[p] = (pageCounts[p] || 0) + 1;
                rawLogs.push(d);
            });

            document.getElementById("stat-total-views").innerText = rawLogs.length;
            document.getElementById("stat-unique-users").innerText = uniqueUsers.size;
            const sortedPages = Object.entries(pageCounts).sort((a,b) => b[1]-a[1]);
            if(sortedPages.length>0) document.getElementById("stat-top-page").innerText = sortedPages[0][0].substring(0,18)+"...";

            // Update Filtres Trafic
            const tfClass = document.getElementById("tf-class"), tfStudent = document.getElementById("tf-student");
            tfClass.innerHTML = '<option value="ALL">ğŸ« Toutes les classes</option>';
            classesSet.forEach(c => tfClass.innerHTML += `<option value="${c}">${c}</option>`);
            tfStudent.innerHTML = '<option value="ALL">ğŸ‘¤ Tous les Ã©lÃ¨ves</option>';
            studentsSet.forEach(s => tfStudent.innerHTML += `<option value="${s}">${s}</option>`);

            if(document.getElementById("modalTraffic").classList.contains("open")) updateTrafficView();

        } catch(e) { console.error("Err Trafic", e); }
    };

    // --- MODULE TRAFIC : LOGIQUE ---
    window.updateTrafficView = function() {
        const period = parseInt(document.getElementById("tf-period").value);
        const fClass = document.getElementById("tf-class").value;
        const fStudent = document.getElementById("tf-student").value;
        const now = new Date(); const cutoff = new Date(); cutoff.setDate(now.getDate() - period);

        const filtered = rawLogs.filter(l => {
            if(l.jsDate < cutoff) return false;
            if(fClass !== "ALL" && l.classe !== fClass) return false;
            if(fStudent !== "ALL" && l.userCode !== fStudent) return false;
            return true;
        });

        // 1. Data Prep
        let daysData = {"Lundi":{s:0,e:0,w:0},"Mardi":{s:0,e:0,w:0},"Mercredi":{s:0,e:0,w:0},"Jeudi":{s:0,e:0,w:0},"Vendredi":{s:0,e:0,w:0},"Samedi":{s:0,e:0,w:0},"Dimanche":{s:0,e:0,w:0}};
        const dayNames = ["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
        let pieData = {s:0, e:0, w:0};
        let userPresence = {}; let pageCounts = {};

        filtered.forEach(log => {
            const dayName = dayNames[log.jsDate.getDay()];
            const hour = log.jsDate.getHours();
            let type = "e";
            if(dayName === "Samedi" || dayName === "Dimanche") type = "w";
            else if(hour >= 8 && hour < 18) type = "s";

            if(daysData[dayName]) daysData[dayName][type]++;
            pieData[type]++;

            let u = log.userCode || "Anonyme";
            if(!userPresence[u]) userPresence[u] = {count:0, last:log.jsDate};
            userPresence[u].count++;
            if(log.jsDate > userPresence[u].last) userPresence[u].last = log.jsDate;

            let p = log.page || "?"; pageCounts[p] = (pageCounts[p]||0)+1;
        });

        // 2. Charts
        const ctxBar = document.getElementById("chartActivity").getContext("2d");
        if(chartActivity) chartActivity.destroy();
        const labelsDays = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];
        chartActivity = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: labelsDays,
                datasets: [
                    { label:'Scolaire', data: labelsDays.map(d=>daysData[d].s), backgroundColor:'#3b82f6', stack:'0' },
                    { label:'Soir', data: labelsDays.map(d=>daysData[d].e), backgroundColor:'#8b5cf6', stack:'0' },
                    { label:'WE', data: labelsDays.map(d=>daysData[d].w), backgroundColor:'#f97316', stack:'0' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales:{x:{stacked:true}, y:{stacked:true}}, plugins:{legend:{display:false}} }
        });

        const ctxPie = document.getElementById("chartPie").getContext("2d");
        if(chartPie) chartPie.destroy();
        chartPie = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: ['Scolaire', 'Soir/Nuit', 'Week-end'],
                datasets: [{ data: [pieData.s, pieData.e, pieData.w], backgroundColor: ['#3b82f6', '#8b5cf6', '#f97316'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'bottom'} } }
        });

        // 3. Tables
        const tbPres = document.getElementById("tbody-presence"); tbPres.innerHTML = "";
        Object.entries(userPresence).sort((a,b)=>b[1].last-a[1].last).forEach(([u,d]) => {
            let style = "font-weight:bold; color:#1e293b;";
            if(u==="INV"||u==="PSE") { u="ğŸ›¡ï¸ "+u; style="color:#f59e0b; font-weight:bold;"; }
            tbPres.innerHTML += `<tr><td style="${style}">${u}</td><td style="text-align:center;"><span class="pill pill-blue">${d.count}</span></td><td style="color:#64748b; font-size:0.85rem;">${d.last.toLocaleDateString()}</td></tr>`;
        });

        const tbLogs = document.getElementById("tbody-logs"); tbLogs.innerHTML = "";
        filtered.slice(0, 100).forEach(l => {
            let time = l.jsDate.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
            let u = l.userCode || "?"; let c = "#1e293b"; if(u==="INV"||u==="PSE") c="#f59e0b";
            tbLogs.innerHTML += `<tr><td style="color:#64748b;">${time}</td><td style="font-weight:bold; color:${c};">${u} <small style="font-weight:normal;color:#94a3b8;">(${l.classe})</small></td><td>${l.page}</td></tr>`;
        });

        const divTop = document.getElementById("top-pages-list"); divTop.innerHTML = "";
        Object.entries(pageCounts).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([p,c], i) => {
            divTop.innerHTML += `<div style="background:#f1f5f9; padding:10px 15px; border-radius:8px; border:1px solid #e2e8f0; font-size:0.9rem;"><strong>${p}</strong> : ${c} vues</div>`;
        });
    };

    // --- FONCTIONS TABLEAU NOTES ---
    window.applyFilters = function() {
        const cls = document.getElementById("filter-class").value;
        const search = document.getElementById("filter-student").value.toLowerCase();
        filteredEvaluations = allEvaluations.filter(d => {
            if(cls !== "ALL" && d.classe !== cls) return false;
            if(search && d.eleve && !d.eleve.toLowerCase().includes(search)) return false;
            return true;
        });
        renderTable();
        updateRadar();
    };

    function renderTable() {
        const tb = document.getElementById("tbody-eleves"); tb.innerHTML = "";
        if(filteredEvaluations.length === 0) { tb.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999">Aucune donnÃ©e.</td></tr>`; return; }
        filteredEvaluations.forEach(d => {
            let date = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleDateString() : "-";
            let badges = "";
            if(d.competences) { for(let k in d.competences) badges += `<span class="pill pill-blue">${k}</span> `; }
            tb.innerHTML += `<tr><td>${date}</td><td><strong>${d.eleve}</strong></td><td>${d.classe||""}</td><td>${d.exercice}</td><td style="color:#2563eb; font-weight:800;">${d.note}/20</td><td>${badges}</td></tr>`;
        });
    }

    function updateRadar() {
        let sums = {C1:0, C2:0, C3:0, C4:0, C5:0, C6:0}, counts = {C1:0, C2:0, C3:0, C4:0, C5:0, C6:0};
        let totalSum = 0, totalCount = 0;
        filteredEvaluations.forEach(d => {
            if(d.note) { totalSum += parseFloat(d.note); totalCount++; }
            if(d.competences) {
                for(let k in d.competences) {
                    let key = k.substring(0,2);
                    if(sums[key] !== undefined) { sums[key] += d.competences[k]; counts[key]++; }
                }
            }
        });
        
        if(totalCount > 0) document.getElementById("moyenne-globale").innerText = (totalSum/totalCount).toFixed(1) + "/20";
        else document.getElementById("moyenne-globale").innerText = "--";

        const dataRadar = [ counts.C1?sums.C1/counts.C1:0, counts.C2?sums.C2/counts.C2:0, counts.C3?sums.C3/counts.C3:0, counts.C4?sums.C4/counts.C4:0, counts.C5?sums.C5/counts.C5:0, counts.C6?sums.C6/counts.C6:0 ];
        const ctx = document.getElementById("radarChart");
        if(globalRadar) globalRadar.destroy();
        globalRadar = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['C1 Info', 'C2 Analyse', 'C3 Expliq', 'C4 Solution', 'C5 Argum', 'C6 Com'],
                datasets: [{ label: 'Niveau Moyen / 20', data: dataRadar, backgroundColor: 'rgba(37, 99, 235, 0.2)', borderColor: '#2563eb', pointBackgroundColor: '#2563eb' }]
            },
            options: { scales: { r: { suggestedMin: 0, suggestedMax: 20 } }, maintainAspectRatio: false }
        });
    }

    // --- TRI SIMPLE ---
    window.sortData = function(col) {
        filteredEvaluations.sort((a,b) => {
            let va = a[col] || "", vb = b[col] || "";
            if(col==='note_finale') return parseFloat(vb) - parseFloat(va);
            if(col==='date') return b.timestamp - a.timestamp;
            return va.toString().localeCompare(vb.toString());
        });
        renderTable();
    }

    // Auto-Start
    chargerDonnees();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cockpit Professeur â€“ Pilotage Global</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-body:#f1f5f9; --bg-sidebar:#0f172a; --text-main:#1e293b; --text-muted:#64748b;
      --col-pedago:#3b82f6; --col-eval:#f59e0b; --col-class:#10b981; --col-proj:#8b5cf6;
      --col-admin:#f97316; --col-live-web:#795548; --col-sites:#607d8b;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; font-family:'Inter',sans-serif;
      background-color:var(--bg-body); color:var(--text-main);
      display:flex; height:100vh; overflow:hidden;
    }

    /* SIDEBAR */
    .sidebar{
      width:300px; background-color:var(--bg-sidebar); color:#fff;
      display:flex; flex-direction:column; padding:20px; flex-shrink:0;
      overflow-y:auto; gap:10px;
      position: relative; /* Pour le bouton fermer mobile */
    }
    .brand{ font-size:1.3rem; font-weight:800; margin-bottom:20px; letter-spacing:1px; display:flex; align-items:center; gap:10px; }
    .nav-category{ font-size:.75rem; text-transform:uppercase; letter-spacing:1px; font-weight:700; color:#64748b; margin:15px 0 5px; }
    .nav-item{
      display:flex; align-items:center; gap:12px; padding:12px 15px; border-radius:8px;
      cursor:pointer; transition:.2s; font-weight:600; color:#cbd5e1; border-left:4px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:#fff;}
    .nav-item.active{background:rgba(255,255,255,.10); color:#fff;}
    .nav-item[data-theme="pedago"].active{border-left-color:var(--col-pedago);}
    .nav-item[data-theme="eval"].active{border-left-color:var(--col-eval);}
    .nav-item[data-theme="class"].active{border-left-color:var(--col-class);}
    .nav-item[data-theme="proj"].active{border-left-color:var(--col-proj);}
    .nav-item[data-theme="admin"].active{border-left-color:var(--col-admin);}
    .nav-item[data-theme="live"].active{border-left-color:var(--col-live-web);}
    .nav-item[data-theme="sites"].active{border-left-color:var(--col-sites);}

    /* MAIN */
    .main-content{ flex:1; padding:40px; overflow-y:auto; display:flex; flex-direction:column; position:relative; }
    header{ display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:30px; border-bottom:1px solid #e2e8f0; padding-bottom:20px; }
    h1{margin:0; font-size:2rem; font-weight:800; color:var(--text-main);}
    .header-infos{text-align:right;}
    .clock-time{font-size:1.5rem; font-weight:800;}
    .clock-date{font-size:.9rem; color:var(--text-muted);}
    .vacation-badge{ margin-top:5px; font-size:.8rem; background:#dbeafe; color:#2563eb; padding:4px 10px; border-radius:20px; border:1px solid #bfdbfe; font-weight:bold; }

    .view-section{display:none; animation:fadeUp .4s ease-out;}
    .view-section.active{display:block;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

    .quick-actions{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:30px; }
    .btn-quick{
      background:#fff; border:1px solid #e2e8f0; padding:15px; border-radius:12px;
      text-align:left; cursor:pointer; transition:.2s; display:flex; align-items:center; gap:15px;
      box-shadow:0 2px 4px rgba(0,0,0,.02); text-decoration:none; color:inherit;
    }
    .btn-quick:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.05); border-color:var(--col-pedago); }

    .dashboard-grid{display:grid; grid-template-columns:2fr 1fr; gap:25px;}
    .widget{ background:#fff; border-radius:16px; padding:25px; border:1px solid #e2e8f0; display:flex; flex-direction:column; min-height:320px; }
    .widget h3{ margin:0 0 15px; padding-bottom:10px; border-bottom:2px solid #f1f5f9; font-size:1.1rem; display:flex; justify-content:space-between; align-items:center; }

    /* ZONE 1 : MÃ‰TÃ‰O DU SITE (AUDIENCE) */
    .stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    
    /* MODIFICATION DESIGN: Cartes interactives */
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-color: var(--col-pedago); }
    .stat-card:active { transform: scale(0.98); }

    .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .icon-blue { background: #e0f2fe; color: #0284c7; }
    .icon-purple { background: #f3e8ff; color: #9333ea; }
    .icon-green { background: #dcfce7; color: #16a34a; }
    .stat-info h4 { margin: 0; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
    .stat-info p { margin: 5px 0 0; font-size: 1.4rem; font-weight: 800; color: #0f172a; }

    /* CODEPILOTE : BARRE D'OUTILS FILTRES */
    .toolbar {
      display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;
    }
    .filter-input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
    .filter-select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; min-width: 150px; background: white; }

    /* CODEPILOTE : STYLES TABLEAU & RADAR */
    .radar-container { height: 320px; display: flex; justify-content: center; margin-bottom: 10px; }
    .pill { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-right: 5px; display: inline-block; margin-bottom: 2px;}
    .pill-green { background: #dcfce7; color: #166534; }
    .pill-orange { background: #ffedd5; color: #9a3412; }
    .pill-red { background: #fee2e2; color: #991b1b; }
    .pill-blue { background: #dbeafe; color: #1e40af; }
    
    .results-table { width:100%; border-collapse:collapse; min-width:600px; }
    .results-table thead { background:#f1f5f9; color:#475569; }
    /* EntÃªtes cliquables pour le tri */
    .results-table th { padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:.88rem; cursor: pointer; user-select: none; }
    .results-table th:hover { background: #e2e8f0; }
    .results-table td { padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:.88rem; }
    .results-table tr:hover { background:#f8fafc; }
    .scores-empty { text-align:center; padding: 20px; color: #64748b; }

    /* Styles Modale */
    .eleve-link { color: #2563eb; font-weight: 700; cursor: pointer; text-decoration: underline; text-decoration-color: transparent; transition: 0.2s; }
    .eleve-link:hover { text-decoration-color: #2563eb; }
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; animation: fadeIn 0.3s; }
    .modal-card { background: #fff; width: 90%; max-width: 900px; max-height: 90vh; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); overflow-y: auto; display: flex; flex-direction: column; }
    .modal-header { padding: 20px 30px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; position: sticky; top: 0; z-index: 10; }
    .modal-body { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; }
    .stat-box { background: #f1f5f9; padding: 15px; border-radius: 12px; text-align: center; }
    .stat-val { font-size: 1.8rem; font-weight: 800; color: #0f172a; display: block; }
    .stat-label { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
    @media(max-width: 800px) { .modal-body { grid-template-columns: 1fr; } }

    /* STYLES SPÃ‰CIFIQUES POUR LA MODALE DÃ‰TAILS (MICRO-STATS) */
    .detail-modal-content { height: 400px; display: flex; flex-direction: column; width: 100%; }
    .rank-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
    .rank-item:hover { background-color: #f8fafc; }
    .rank-pos { font-weight: 800; color: var(--col-pedago); width: 35px; }
    .rank-name { flex: 1; font-weight: 500; color: #334155; }
    .rank-val { font-weight: 700; color: #0f172a; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-size: 0.9rem;}

    /* UTILS & RESPONSIVE */
    .btn-yellow{ display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:#fffbeb; color:#b45309; border:1px solid #fcd34d; border-radius:6px; text-decoration:none; font-weight:600; font-size:.85rem; }
    .btn-blue-outline{ display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:#f0f9ff; color:#0369a1; border:1px solid #bae6fd; border-radius:6px; text-decoration:none; font-weight:600; font-size:.85rem; cursor:pointer; }
    .badge-soon{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; margin-left:6px; border:1px solid rgba(0,0,0,.05); background:#fef3c7; color:#92400e; }
    
    details{ background:#fff; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px; overflow:hidden; }
    summary{ padding:15px; font-weight:600; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; }
    details[open]>summary{background:#f1f5f9; border-bottom:1px solid #e2e8f0;}
    .content-links{ padding:15px; display:flex; flex-wrap:wrap; gap:10px; }
    
    #course-structure>summary{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); }
    #course-structure .lvl-cap>summary{ background:rgba(37,99,235,.12); border-left:6px solid rgba(37,99,235,.9); font-weight:900; }
    #course-structure .lvl-bacpro>summary{ background:rgba(22,163,74,.12); border-left:6px solid rgba(22,163,74,.9); font-weight:900; }

    .live-block{ margin-top:12px; border:1px solid rgba(0,0,0,.08); border-radius:14px; overflow:hidden; background:#fff; }
    .live-summary{ font-weight:900; padding:14px 16px; background:#f1f5f9; }
    .live-links{padding:14px 12px;}
    .badge-role{ display:inline-flex; align-items:center; padding:2px 10px; border-radius:999px; font-size:12px; font-weight:900; margin-left:8px; border:1px solid rgba(0,0,0,.08); white-space:nowrap; }
    .role-eleve{background:rgba(245,158,11,.18); color:#a16207;}
    .role-prof{background:rgba(59,130,246,.18); color:#1d4ed8;}

    /* MENU MOBILE */
    .menu-overlay{ display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); backdrop-filter:blur(2px); z-index:999; }
    .menu-btn{ display:none; border:none; background:#0f172a; color:#fff; width:44px; height:44px; border-radius:12px; font-size:20px; font-weight:900; cursor:pointer; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,.18); flex-shrink:0; }
    body.menu-open .sidebar{transform:translateX(0);}
    body.menu-open .menu-overlay{display:block;}

    /* AJOUT: Bouton fermer sidebar mobile */
    .close-sidebar-btn { display: none; }

    @media(max-width:980px){
      body{height:auto; overflow:auto; display:block;}
      .sidebar{ position:fixed; top:0; left:0; bottom:0; height:100vh; width:min(86vw,340px); transform:translateX(-110%); transition:transform .25s ease; z-index:1000; padding:18px; }
      .main-content{padding:16px; min-height:100vh; overflow:visible;}
      header{align-items:center; gap:12px; margin-bottom:16px; padding-bottom:14px;}
      h1{font-size:1.35rem;}
      .clock-time{font-size:1.15rem;}
      .menu-btn{display:inline-flex;}
      .dashboard-grid{grid-template-columns:1fr; gap:14px;}
      .widget{min-height:auto; padding:16px; border-radius:14px;}
      .quick-actions{grid-template-columns:1fr;}
      .btn-quick{padding:14px;}
      .content-links{padding:12px; gap:8px;}
      .btn-yellow,.btn-blue-outline{width:100%; justify-content:space-between;}
      .stats-overview { grid-template-columns: 1fr; }
      
      /* Affichage du bouton fermer uniquement sur mobile */
      .close-sidebar-btn { 
          display: block; 
          position: absolute; 
          top: 15px; 
          right: 15px; 
          background: none; 
          border: none; 
          color: white; 
          font-size: 24px; 
          cursor: pointer; 
          z-index: 1002;
          padding: 5px;
      }
    }
    /* --- AJOUTS V4 (BIBLIOTHÃˆQUE & QUIZ) --- */
    .col-left { flex: 1; display: flex; flex-direction: column; gap: 20px; }
    .col-right { flex: 1; background: #fff; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; height: fit-content; }
    
    .grid-acts { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .act-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; font-weight: 600; text-align: center; background: #fff; transition: 0.2s; font-size: 0.9rem; }
    .act-btn:hover { background: #f8fafc; }
    .act-btn.active { border-color: #db2777; background: #fff0f6; color: #db2777; }

    .lib-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
    .lib-item { padding: 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
    .lib-item:hover { background: #f0f9ff; }
    
    .tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-right: 8px; letter-spacing: 0.5px; }
    .tag-poll { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
    .tag-quiz { background: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd; }
    .tag-cloud { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }

    .option-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
  </style>
</head>
<body>

  <div id="modalStudent" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <h2 id="modal-name" style="margin:0; color:#0f172a;">Ã‰lÃ¨ve</h2>
          <span id="modal-class" style="color:#64748b; font-weight:500;">Classe</span>
        </div>
        <button class="close-modal" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div>
          <div style="display:flex; gap:15px; margin-bottom:20px;">
            <div class="stat-box" style="flex:1;">
              <span class="stat-val" id="modal-avg">--/20</span>
              <span class="stat-label">Moyenne</span>
            </div>
            <div class="stat-box" style="flex:1;">
              <span class="stat-val" id="modal-time">--</span>
              <span class="stat-label">Temps Moyen</span>
            </div>
          </div>
          <div style="height:300px;">
            <canvas id="studentRadar"></canvas>
          </div>
        </div>
        <div>
          <h3 style="margin-top:0;">Historique des activitÃ©s</h3>
          <table class="results-table">
            <thead><tr><th>Date</th><th>Exercice</th><th>Note</th></tr></thead>
            <tbody id="modal-history"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="modalStats" class="modal-overlay" onclick="closeStatModal()">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 id="stats-title" style="margin:0;">DÃ©tails</h2>
        <button class="close-modal" onclick="closeStatModal()">Ã—</button>
      </div>
      <div class="modal-body" style="display: block;">
        <div class="detail-modal-content">
          <canvas id="statsChart" style="max-height: 300px; display:none;"></canvas>
          <div id="statsList" style="overflow-y:auto; flex:1;"></div>
        </div>
      </div>
    </div>
  </div>

  <nav class="sidebar" id="mySidebar">
    <button class="close-sidebar-btn" onclick="closeMenu()">âœ•</button>
    
    <div class="brand">ğŸš€ COCKPIT</div>
    <div class="nav-item active" onclick="showView('dashboard', this)">ğŸ  Tableau de bord</div>
    <div class="nav-category">Mes dossiers</div>
    <div class="nav-item" data-theme="pedago" onclick="showView('view-pedago', this)">ğŸŸ¦ 1. PÃ©dagogie & cours</div>
    <div class="nav-item" data-theme="eval" onclick="showView('view-eval', this)">ğŸŸ¨ 2. Ã‰valuation & suivi</div>
    <div class="nav-item" data-theme="eval" onclick="showView('view-scores', this)">ğŸŸ¨ 2b. Scores exercices</div>
    <div class="nav-item" data-theme="admin" onclick="showView('view-trafic', this)">ğŸš¦ 2c. Trafic (monitoring)</div>
    <div class="nav-item" data-theme="class" onclick="showView('view-class', this)">ğŸŸ© 3. Classes & groupes</div>
    <div class="nav-item" data-theme="proj" onclick="showView('view-proj', this)">ğŸŸª 4. Projets & transversal</div>
    <div class="nav-item" data-theme="admin" onclick="showView('view-admin', this)">ğŸŸ§ 5. Temps & admin</div>
    <div class="nav-item" data-theme="live" onclick="showView('view-live', this)">ğŸŸ« 6. Classe en temps rÃ©el</div>
    <div class="nav-category" style="margin-top:15px; color:#db2777;">ANIMATION</div>
<div class="nav-item" data-theme="session" onclick="showView('view-sessions', this)" 
     style="border-left: 4px solid #db2777; color:#fff; background:linear-gradient(90deg, rgba(219,39,119,0.1) 0%, rgba(15,23,42,0) 100%);">
  ğŸ“¡ 8. Sessions & Sondages
</div>
    <div class="nav-item" data-theme="sites" onclick="showView('view-sites', this)">ğŸŒ 7. Sites internet</div>
  </nav>

  <div id="menuOverlay" class="menu-overlay" onclick="closeMenu()"></div>

  <main class="main-content">
        <header>
            <button id="menuBtn" class="menu-btn" aria-label="Menu" onclick="toggleMenu()">â˜°</button>
            <h1 id="page-title">Tableau de Bord</h1>
            <div class="header-infos">
                <div class="clock-time" id="clock">--:--</div>
                <div class="clock-date" id="date">--</div>
                <div id="vacation-badge" class="vacation-badge" style="display:none;"></div>
                <div id="inboxBadge" title="Nouvelles copies" style="display:none;min-width:24px;height:24px;padding:0 8px;border-radius:999px;background:#111827;color:#fff;font-weight:900;font-size:12px;align-items:center;justify-content:center;"></div>
                </div>
        </header>

        <div id="dashboard" class="view-section active">
            <div class="quick-actions">
                <a href="prof_plan.html" target="_blank" class="btn-quick"><span>ğŸª‘</span><div><strong>Plan de Classe</strong><span>Piloter les places</span></div></a>
                <a href="https://www.pronote.index-education.net/" target="_blank" class="btn-quick"><span>ğŸ“</span><div><strong>Pronote Web</strong><span>AccÃ¨s direct</span></div></a>
                <button onclick="document.getElementById('memo-input').focus()" class="btn-quick"><span>ğŸ§ </span><div><strong>MÃ©mo CiblÃ©</strong><span>Rappel contextuel</span></div></button>
            </div>
            <div class="dashboard-grid">
                <div class="widget">
                    <h3>ğŸ“… Planning <div style="font-size:0.8rem;"><button onclick="changeDate(-1)">â—€</button> <span id="planning-date-label">...</span> <button onclick="changeDate(1)">â–¶</button> <button onclick="openTimeline()" title="Timeline" style="margin-left:8px;background:#0f172a;color:white;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;">Timeline</button></div></h3>
                    <ul class="planning-list" id="planning-list"></ul>
                </div>
                                <div class="right-stack">
<div class="widget memo-widget">
                    <h3>ğŸ’¡ Pense-BÃªte Contextuel</h3>
                    <div style="display:flex;gap:5px;margin-bottom:15px;">
                        <select id="memo-target" style="padding:8px;border-radius:6px;border:1px solid #ddd;"></select>
                        <input id="memo-input" style="flex-grow:1;padding:8px;border-radius:6px;border:1px solid #ddd;" placeholder="Note...">
                        <button onclick="addMemo()" style="background:#0f172a;color:white;border:none;padding:8px 15px;border-radius:6px;">+</button>
                    </div>
                    <ul class="alert-list" id="memo-list"></ul>
                </div>
            
                <div class="widget agenda-widget">
                    <h3>ğŸ—“ï¸ Agenda</h3>
                    <div class="agenda-form">
                        <select id="agenda-type">
                            <option value="RÃ©union">RÃ©union</option>
                            <option value="Parents">Parents</option>
                            <option value="Admin">Admin</option>
                            <option value="Personnel">Personnel</option>
                            <option value="Classe">Classe</option>
                            <option value="Autre">Autre</option>
                        </select>
                        <input id="agenda-date" type="date" aria-label="Date">
                        <input id="agenda-time" type="time" aria-label="Heure">
                    </div>
                    <div class="agenda-form">
                        <input id="agenda-title" class="wide" placeholder="Titre (rÃ©union, rdv...)" aria-label="Titre">
                        <input id="agenda-place" class="wide" placeholder="Lieu (optionnel)" aria-label="Lieu">
                        <button onclick="addAgenda()" style="background:#0f172a;color:white;border:none;padding:8px 15px;border-radius:6px;">+</button>
                    </div>
                    <ul class="agenda-list" id="agenda-list"></ul>
                </div>
                </div>
</div>
        </div>
            </section>
    <section id="view-scores" class="view-section">
      <h2 style="color:var(--col-eval);">Suivi des CompÃ©tences & Notes</h2>
      
      <div class="stats-overview">
        <div class="stat-card" onclick="showStatDetails('views')">
          <div class="stat-icon icon-blue">ğŸ‘€</div>
          <div class="stat-info"><h4>Trafic Total</h4><p id="stat-total-views">0</p></div>
        </div>
        <div class="stat-card" onclick="showStatDetails('devices')">
          <div class="stat-icon icon-purple">ğŸ“±</div>
          <div class="stat-info"><h4>Supports</h4><p id="stat-device" style="font-size:1rem; font-weight:600;">--</p></div>
        </div>
        <div class="stat-card" onclick="showStatDetails('exercices')">
          <div class="stat-icon icon-green">ğŸ†</div>
          <div class="stat-info"><h4>Top Exercice</h4><p id="stat-top-page" style="font-size:1rem; font-weight:600;">--</p></div>
        </div>
      </div>

      <div class="dashboard-grid">
          <div class="widget">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span><strong>DerniÃ¨res Ã©valuations reÃ§ues</strong></span>
                <button onclick="chargerDonnees()" style="padding:8px 15px; cursor:pointer; background:#f1f5f9; border:1px solid #ccc; border-radius:20px;">ğŸ”„ Actualiser</button>
            </div>

            <div class="toolbar">
              <select id="filter-class" class="filter-select" onchange="applyFilters()">
                <option value="ALL">Toutes les classes</option>
              </select>
              <input type="text" id="filter-student" class="filter-input" placeholder="ğŸ” Chercher un Ã©lÃ¨ve..." onkeyup="applyFilters()">
              <select id="filter-exercice" class="filter-select" onchange="applyFilters()">
                <option value="ALL">Tous les exercices</option>
              </select>
            </div>

            <div style="overflow-x:auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th onclick="sortData('date')">Date â†•</th>
                            <th onclick="sortData('identifiant')">Ã‰lÃ¨ve â†•</th>
                            <th onclick="sortData('classe')">Classe â†•</th>
                            <th onclick="sortData('temps_secondes')">Temps â†•</th>
                            <th onclick="sortData('exercice_titre')">Exercice â†•</th>
                            <th onclick="sortData('note_finale')">Note â†•</th>
                            <th>DÃ©tail CompÃ©tences</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-eleves">
                        <tr><td colspan="7" class="scores-empty">Chargement automatique...</td></tr>
                    </tbody>
                </table>
            </div>
          </div>

          <div class="widget">
              <h3>ğŸ“Š Radar Moyen (FiltrÃ©)</h3>
              <div class="radar-container"><canvas id="radarChart"></canvas></div>
              <div style="text-align:center; margin-top:15px;">Moyenne : <strong id="moyenne-globale" style="color:#3b82f6; font-size:1.3rem;">--</strong></div>
          </div>
      </div>
    </section>
    <section id="view-trafic" class="view-section">
      <h2 style="color:var(--col-admin);">Trafic (monitoring)</h2>

      <div class="widget" style="min-height:auto; margin-bottom:18px;">
        <h3>ğŸ›ï¸ Filtres</h3>
        <div class="toolbar" id="trafic-filters">
          <select id="trafic-period" class="filter-select">
            <option value="today">Aujourdâ€™hui</option>
            <option value="7d" selected>7 derniers jours</option>
            <option value="month">Ce mois</option>
            <option value="year">Cette annÃ©e</option>
          </select>

          <select id="trafic-class" class="filter-select">
            <option value="ALL">Toutes les classes</option>
          </select>

          <select id="trafic-eleve" class="filter-select">
            <option value="ALL">Tous les Ã©lÃ¨ves</option>
          </select>

          <select id="trafic-type" class="filter-select">
            <option value="ALL">Tout</option>
            <option value="IDENT">IdentifiÃ©s</option>
            <option value="ANON">Anonymes</option>
          </select>

          <button id="trafic-refresh" class="filter-input" style="cursor:pointer; background:#fff;">ğŸ”„ Actualiser</button>
        </div>

        <div id="trafic-note" style="font-size:.9rem; color:#64748b;">
          Les filtres Classe / Ã‰lÃ¨ve / Type fonctionnent si les logs contiennent userCode et classe (annuaire.js). Sinon, ils resteront approximatifs.
        </div>
      </div>

      <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="widget">
          <h3>ğŸ“Š ActivitÃ© (Lun â†’ Dim)</h3>
          <div style="height:320px;">
            <canvas id="traficChartWeek"></canvas>
          </div>
        </div>

        <div class="widget">
          <h3>ğŸ•’ RÃ©partition temporelle</h3>
          <div style="height:320px;">
            <canvas id="traficChartSplit"></canvas>
          </div>
        </div>
      </div>

      <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; margin-top:18px;">
        <div class="widget" style="min-height:auto;">
          <h3>ğŸ‘¥ PrÃ©sence (micro)</h3>
          <div style="overflow-x:auto;">
            <table class="results-table" style="min-width:720px;">
              <thead>
                <tr>
                  <th>Ã‰lÃ¨ve</th>
                  <th>Classe</th>
                  <th>AssiduitÃ© (pÃ©riode)</th>
                  <th>DerniÃ¨re activitÃ©</th>
                </tr>
              </thead>
              <tbody id="trafic-presence-body">
                <tr><td colspan="4" class="scores-empty">Chargementâ€¦</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="widget" style="min-height:auto;">
          <h3>ğŸ“„ Top contenus</h3>
          <div id="trafic-top-pages" style="overflow:auto; max-height:360px;"></div>
        </div>
      </div>

      <div class="widget" style="min-height:auto; margin-top:18px;">
        <h3>ğŸ“ Journal de bord (logs bruts)</h3>
        <div style="overflow:auto; max-height:420px;">
          <table class="results-table" style="min-width:880px;">
            <thead>
              <tr>
                <th>Date/Heure</th>
                <th>Ã‰lÃ¨ve</th>
                <th>Classe</th>
                <th>Action</th>
                <th>Page / Contenu</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody id="trafic-logs-body">
              <tr><td colspan="6" class="scores-empty">Chargementâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-pedago" class="view-section">
      <h2 style="color:var(--col-pedago);">PÃ©dagogie & cours</h2>
      <details open>
    <summary>ğŸ“ SÃ©quences CAP</summary>
    <div class="content-links">
      <a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
      <a href="#" class="btn-yellow">ğŸ“ Exercices <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
      <a href="#" class="btn-yellow">ğŸ—ºï¸ Progression <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
      <a href="#" class="btn-yellow">ğŸ–¥ï¸ SÃ©ance projetÃ©e <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
      <a href="#" class="btn-yellow">ğŸ§© ActivitÃ©s rapides <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
    </div>
  </details>

  <details>
    <summary>ğŸ“ SÃ©quences BAC PRO</summary>
    <div class="content-links">
      <a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
      <a href="#" class="btn-yellow">ğŸ“ Exercices <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
      <a href="#" class="btn-yellow">ğŸ—ºï¸ Progression <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
      <a href="#" class="btn-yellow">ğŸ–¥ï¸ SÃ©ance projetÃ©e <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
      <a href="#" class="btn-yellow">ğŸ§© ActivitÃ©s rapides <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
    </div>
  </details>

  <details id="course-structure">
    <summary>ğŸ“š Cours CAP & Bac Pro (structure)</summary>

    <details class="lvl-cap">
      <summary>CAP</summary>

      <details>
        <summary>ThÃ©matique A â€“ Lâ€™individu et sa santÃ©</summary>
        <details><summary>Module A1 â€“ Le systÃ¨me de santÃ©</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module A2 â€“ Le sommeil</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module A3 â€“ Lâ€™activitÃ© physique</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module A4 â€“ Les addictions</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module A5 â€“ SexualitÃ© / Contraception</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module A6 â€“ PrÃ©venir les IST</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module A7 â€“ Lâ€™alimentation adaptÃ©e</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
      </details>

      <details>
        <summary>ThÃ©matique B â€“ Lâ€™environnement</summary>
        <details><summary>Module B1 â€“ Les ressources en eau</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module B2 â€“ Le risque majeur</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module B3 â€“ Les ressources en Ã©nergie</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module B4 â€“ Le bruit au quotidien</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
      </details>

      <details>
        <summary>ThÃ©matique C â€“ Milieu professionnel</summary>
        <details><summary>Module C1 â€“ Contrats de travail</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module C2 â€“ Enjeux santÃ© sÃ©curitÃ©</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module C3 â€“ DÃ©marche de prÃ©vention</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module C4 â€“ Risques spÃ©cifiques</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module C5 â€“ ActivitÃ© physique (travail)</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module C6 â€“ Acteurs de prÃ©vention</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module C7 â€“ Suivi mÃ©dical</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module C8 â€“ Secourisme</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
      </details>

      <details>
        <summary>ThÃ©matique D â€“ Consommateur</summary>
        <details><summary>Module D1 â€“ Lâ€™assurance</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module D2 â€“ Le budget</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
        <details><summary>Module D3 â€“ Les achats</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
      </details>
    </details>

    <details class="lvl-bacpro">
      <summary>Bac Pro</summary>

      <details>
        <summary>Seconde Bac Pro</summary>
        <details><summary>ThÃ©matique A</summary><div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours A1 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours A2 (Sommeil) <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours A3 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours A4 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours A5 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div></details>
        <details><summary>ThÃ©matique B</summary><div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours B1 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours B2 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div></details>
        <details><summary>ThÃ©matique C</summary><div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours C1 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours C2 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div></details>
      </details>

      <details>
        <summary>PremiÃ¨re Bac Pro</summary>
        <details><summary>ThÃ©matique A</summary><div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours A6 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours A7 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours A8 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div></details>
        <details><summary>ThÃ©matique B</summary><div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours B3 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours B4 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div></details>
        <details><summary>ThÃ©matique C</summary><div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours C3 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours C4 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours C5 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours C6 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div></details>
      </details>

      <details>
        <summary>Terminale Bac Pro</summary>
        <details><summary>ThÃ©matique A</summary><div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours A9 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div></details>
        <details><summary>ThÃ©matique B</summary><div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours B5 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div></details>
        <details><summary>ThÃ©matique C</summary><div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours C7 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours C8 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours C9 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours C10 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours C11 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“„ Cours C12 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div></details>
      </details>
    </details>
  </details>

    </section>

    <section id="view-eval" class="view-section">
      <h2 style="color:var(--col-eval);">Ã‰valuation & suivi</h2>
      <details open><summary>ğŸ“Š PageProf & suivis</summary><div class="content-links"><a href="pageprof.html" target="_blank" class="btn-yellow">ğŸ“Š Ouvrir PageProf</a><a href="#" class="btn-yellow">ğŸ“ˆ Tableau de bord <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">ğŸ§¾ Grilles / barÃ¨mes <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ“‚ Historique & exports</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ—“ï¸ Bilans <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">ğŸ“¥ Exports JSON / CSV <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-class" class="view-section">
      <h2 style="color:var(--col-class);">Classes & groupes</h2>
      <details open><summary>ğŸª‘ Plans de classe</summary><div class="content-links"><a href="prof_plan.html" target="_blank" class="btn-yellow">ğŸš€ Piloter</a><button class="btn-blue-outline" type="button" onclick="window.open('ecran_plan.html','proj')">ğŸ“º Afficher au tableau</button></div></details>
      <details><summary>ğŸ“‹ Listes dâ€™Ã©lÃ¨ves</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ‘¥ Listes <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">ğŸ” Recherche rapide <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ§© Besoins particuliers</summary><div class="content-links"><a href="#" class="btn-yellow">â™¿ AmÃ©nagements <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">ğŸ“˜ Dossiers MDPH / PAP <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-proj" class="view-section">
      <h2 style="color:var(--col-proj);">Projets & transversal</h2>
      <details open><summary>ğŸ¨ Chef-dâ€™Å“uvre</summary><div class="content-links"><a href="#" class="btn-yellow">CAP 1re annÃ©e <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">CAP 2e annÃ©e <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ« Projet dâ€™Ã©tablissement</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Documents <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">ğŸ—“ï¸ RÃ©unions / CR <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ§  Ateliers CPS</summary><div class="content-links"><a href="#" class="btn-yellow">SÃ©quences CPS <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">Outils dâ€™animation <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-admin" class="view-section">
      <h2 style="color:var(--col-admin);">Temps & institution</h2>
      <details open><summary>ğŸ“… Emploi du temps</summary><div class="content-links"><a href="#" class="btn-yellow">Vue semaine <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">Vue mois <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ¢ PFMP / stages</summary><div class="content-links"><a href="#" class="btn-yellow">Calendrier PFMP <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">Suivi Ã©lÃ¨ves <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ¤ Pacte / missions</summary><div class="content-links"><a href="#" class="btn-yellow">Heures rÃ©alisÃ©es <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">Bilans <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-live" class="view-section">
      <h2 style="color:var(--col-live-web);">Classe en temps rÃ©el</h2>
      <details class="live-block" open>
              <summary class="live-summary">ğŸ—¨ï¸ Sâ€™exprimer / Explorer</summary>
              <div class="content-links live-links">
                <a href="eleve_nuage.html" class="btn btn-yellow">ğŸŒ¥ï¸ Nuage de mots <span class="badge-role role-eleve">Ã‰lÃ¨ves</span></a>
                <a href="prof_nuage.html" class="btn btn-yellow">â˜ï¸ Nuage <span class="badge-role role-prof">Prof</span></a>
                  <a href="prof_postit.html" class="btn btn-yellow">â˜ï¸ PostIt prof <span class="badge-role role-prof">Prof</span></a>

                <a href="#" class="btn btn-yellow">ğŸ’¡ Brainstorming <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
                <a href="#" class="btn btn-yellow">ğŸ’¡ Brainstorming <span class="badge-soon">ğŸš§ BientÃ´t</span> <span class="badge-role role-prof">Prof</span></a>

                <a href="eleve_meteo.html" class="btn btn-yellow">ğŸ§  Ma mÃ©tÃ©o <span class="badge-role role-eleve">Ã‰lÃ¨ves</span></a>
                <a href="prof_meteo.html" class="btn btn-yellow">ğŸ§  MÃ©tÃ©o <span class="badge-role role-prof">Prof</span></a>

                <a href="ecran_classe.html" class="btn btn-blue-outline">ğŸ“º Ã‰cran Classe <span class="badge-role role-prof">Prof</span></a>
                <a href="ecran_plat.html" class="btn btn-blue-outline">ğŸ“º Ã‰cran Plat <span class="badge-role role-prof">Prof</span></a>
              </div>
            </details>

            <details class="live-block">
              <summary class="live-summary">ğŸ¤ Travail collaboratif</summary>
              <div class="content-links live-links">
                <a href="#" class="btn btn-yellow">ğŸ‘¥ Travail de groupe <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
                <a href="#" class="btn btn-yellow">ğŸ‘¥ Travail de groupe <span class="badge-soon">ğŸš§ BientÃ´t</span> <span class="badge-role role-prof">Prof</span></a>

                <a href="prof_mindmap.html" class="btn btn-yellow">ğŸ—£ï¸ carte mentale collective <span class="badge-soon">ğŸ‘‡ ici</span></a>
                  <a href="ecran_mindmap.html" class="btn btn-yellow">ğŸ—£ï¸ carte mentale Ã©cran <span class="badge-soon">ğŸ‘‡ ici</span></a>
                  <a href="prof_itamami.html" class="btn btn-yellow">ğŸ—£ï¸ ITAMAMI <span class="badge-soon">ğŸ‘‡ ici</span></a>
                  <a href="prof_qqoqcp.html" class="btn btn-yellow">ğŸ—£ï¸ QQOQCP <span class="badge-soon">ğŸ‘‡ ici</span></a>
                  <a href="prof_pad.html" class="btn btn-yellow">ğŸ—£ï¸ PAD <span class="badge-soon">ğŸ‘‡ ici</span></a>
                  <a href="prof_ishikawa.html" class="btn btn-yellow">ğŸ—£ï¸ ishikawa <span class="badge-soon">ğŸ‘‡ ici</span></a>
                <a href="#" class="btn btn-yellow">ğŸ—£ï¸ DÃ©bat structurÃ© <span class="badge-soon">ğŸš§ BientÃ´t</span> <span class="badge-role role-prof">Prof</span></a>
              </div>
            </details>
    </section>
    <section id="view-sessions" class="view-section">
  <h2 style="color:#db2777; border-bottom: 2px solid #db2777; padding-bottom:10px;">ğŸ“¡ Gestionnaire & BibliothÃ¨que</h2>
  
  <div class="dashboard-grid">
    
    <div class="col-left">
        
        <div class="widget">
            <h3>âœ¨ DÃ©marrer une session</h3>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <input type="text" id="session-title-input" placeholder="Titre (ex: CafÃ© du 12 Janvier)" style="flex:1; padding:12px; border-radius:8px; border:1px solid #cbd5e1; font-weight:bold;">
                <button onclick="createNewSession()" style="background:#db2777; color:white; border:none; padding:0 20px; border-radius:8px; font-weight:bold; cursor:pointer;">Lancer ğŸš€</button>
            </div>
            <div id="session-info" style="display:none; margin-top:10px; color:#16a34a; font-weight:bold; font-size:0.9rem;">
                âœ… Session active : <span id="current-session-name">...</span>
            </div>
        </div>

        <div id="live-panel" style="display:none; background:#fff; border:2px solid #db2777; border-radius:12px; padding:20px; box-shadow: 0 10px 25px rgba(219, 39, 119, 0.15);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #fce7f3; padding-bottom:10px;">
                <h3 style="margin:0; color:#db2777;">ğŸ”´ EN DIRECT</h3>
                <button onclick="stopSession()" style="background:#fff; color:#64748b; border:1px solid #cbd5e1; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.8rem;">â¹ Stop</button>
            </div>

            <div class="grid-acts">
                <div class="act-btn" onclick="setMode('meteo')">ğŸ˜ MÃ©tÃ©o</div>
                <div class="act-btn" onclick="setMode('nuage')">â˜ï¸ Nuage</div>
                <div class="act-btn" onclick="setMode('sondage')">ğŸ“Š Sondage</div>
                <div class="act-btn" onclick="setMode('quiz')">ğŸ† Quiz</div>
            </div>

            <div id="config-zone" style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; min-height:80px; display:flex; align-items:center; justify-content:center;">
                <p style="text-align:center; color:#94a3b8; margin:0; font-size:0.9rem;">ğŸ‘ˆ SÃ©lectionnez une activitÃ© ou chargez depuis la bibliothÃ¨que.</p>
            </div>

            <div id="quiz-controls" style="display:none; margin-top:10px; padding-top:10px; border-top:1px solid #db2777;">
                <div style="display:flex; gap:10px;">
                    <button onclick="revealQuiz()" style="flex:1; background:#db2777; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ‘€ RÃ©vÃ©ler RÃ©ponse</button>
                    <button onclick="resetQuiz()" style="flex:1; background:white; color:#db2777; border:1px solid #db2777; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ”„ Re-Voter</button>
                </div>
            </div>
            
            <div style="margin-top:15px;">
                <div style="font-size:0.7rem; font-weight:bold; color:#475569; margin-bottom:5px;">DERNIERS MOTS (Cliquer pour censurer âŒ)</div>
                <div id="live-word-feed" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            </div>
        </div>
        
        <div class="widget">
             <h3>ğŸ—‚ï¸ Archives</h3>
             <div id="history-list" style="max-height:150px; overflow-y:auto; font-size:0.85rem;">Chargement...</div>
        </div>
    </div>

    <div class="col-right">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:#0f172a;">ğŸ“š BibliothÃ¨que</h3>
            <button onclick="toggleCreator()" style="background:#f1f5f9; border:1px solid #cbd5e1; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.8rem;">+ CrÃ©er</button>
        </div>

        <div id="creator-panel" style="display:none; background:#f0f9ff; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #bae6fd;">
            <label style="font-size:0.75rem; font-weight:bold; color:#0369a1;">TYPE :</label>
            <select id="create-type" onchange="updateCreatorForm()" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom:10px;">
                <option value="poll">ğŸ“Š CrÃ©er un Sondage</option>
                <option value="quiz">ğŸ† CrÃ©er un Quiz (avec rÃ©ponse)</option>
                <option value="cloud">â˜ï¸ CrÃ©er un ThÃ¨me Nuage</option>
            </select>
            
            <input type="text" id="create-title" placeholder="Titre dans la biblio (ex: Maths 1)" style="width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #cbd5e1; box-sizing:border-box;">
            <input type="text" id="create-question" placeholder="La question posÃ©e..." style="width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #cbd5e1; box-sizing:border-box;">
            
            <div id="options-container"></div>
            <button onclick="addOptionInput()" style="width:100%; margin-bottom:10px; background:white; border:1px dashed #cbd5e1; padding:5px; border-radius:6px; cursor:pointer; color:#64748b; font-size:0.8rem;">+ Ajouter une option</button>

            <button onclick="saveToLibrary()" style="width:100%; padding:10px; background:#0369a1; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ’¾ Enregistrer</button>
        </div>

        <ul id="library-list" class="lib-list">
            <li style="text-align:center; color:#94a3b8; padding:20px;">Chargement...</li>
        </ul>
    </div>

  </div>
</section>

    <section id="view-sites" class="view-section">
      <h2 style="color:var(--col-sites);">Sites internet favoris</h2>
      <details open><summary>ğŸ¢ Administratif</summary><div class="content-links"><a href="https://portail.ac-lyon.fr/" class="btn-yellow" target="_blank">Portail AcadÃ©mie</a><a href="https://eduscol.education.fr/" class="btn-yellow" target="_blank">Eduscol</a><a href="https://www.education.gouv.fr/bo" class="btn-yellow" target="_blank">BO Ã‰ducation</a><a href="https://www.service-public.fr/" class="btn-yellow" target="_blank">Service-public</a><a href="https://cas.ent.auvergnerhonealpes.fr" class="btn-yellow" target="_blank">ENT / Mail pro</a></div></details>
      <details><summary>ğŸ“š Ressources pÃ©dagogiques</summary><div class="content-links"><a href="https://www.inrs.fr/" class="btn-yellow" target="_blank">INRS</a><a href="https://www.santepubliquefrance.fr/" class="btn-yellow" target="_blank">SantÃ© Publique France</a></div></details>
    </section>
  </main>

  <script>
    // UX Basics (Horloge, Planning, Agenda, Memos, Menu)
    function updateClock(){ const d=new Date(); document.getElementById("clock").innerText=d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0'); document.getElementById("date").innerText=d.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"}); }
    setInterval(updateClock,1000); updateClock();
    let planningOffset = 0; const planningData = [ {time:"08h30",label:"CAP â€“ PSE",room:"Salle 12"}, {time:"10h00",label:"Bac Pro â€“ PSE",room:"Salle 14"}, {time:"13h30",label:"Accompagnement perso",room:"CDI"} ];
    function renderPlanning(){ const list = document.getElementById("planning-list"); const date = new Date(); date.setDate(date.getDate()+planningOffset); document.getElementById("planning-date-label").textContent = date.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"2-digit"}); list.innerHTML = ""; planningData.forEach(c=>{ list.innerHTML += `<li class="course-item"><div class="course-time">${c.time}</div><div class="course-details"><strong>${c.label}</strong><br><small>${c.room}</small></div></li>`; }); }
    function changeDate(delta){planningOffset+=delta;renderPlanning();} renderPlanning();
    function save(key,value){localStorage.setItem(key,JSON.stringify(value));} function load(key,def){try{const v=JSON.parse(localStorage.getItem(key));return v??def;}catch(e){return def;}}
    let memos = load("cockpit_memos",[]);
    function renderMemos(){ const ul = document.getElementById("memo-list"); ul.innerHTML = ""; const current = document.querySelector(".view-section.active")?.id || "dashboard"; memos.forEach((m,i)=>{ ul.innerHTML += `<li class="alert-item${m.target===current?" context-active":""}"><span>${m.text}<br><small>${m.target}</small></span><button type="button" onclick="deleteMemo(${i})">âœ•</button></li>`; }); }
    function addMemo(){ const t=document.getElementById("memo-target").value, v=document.getElementById("memo-input").value.trim(); if(v){memos.push({target:t,text:v}); save("cockpit_memos",memos); document.getElementById("memo-input").value=""; renderMemos();} }
    function deleteMemo(i){ memos.splice(i,1); save("cockpit_memos",memos); renderMemos(); }
    let agenda = load("cockpit_agenda",[]);
    function renderAgenda(){ const ul = document.getElementById("agenda-list"); ul.innerHTML=""; const now=new Date(); agenda.sort((a,b)=>new Date(a.when)-new Date(b.when)); agenda.forEach((ev,i)=>{ const d=new Date(ev.when), soon=(d-now)<7*24*3600*1000 && d>now; ul.innerHTML += `<li class="agenda-item${soon?" soon":""}"><div><strong>${ev.title}</strong><div class="agenda-meta">${d.toLocaleDateString("fr-FR")} â€¢ ${ev.type}</div></div><button type="button" onclick="deleteAgenda(${i})">âœ•</button></li>`; }); }
    function addAgenda(){ const type=document.getElementById("agenda-type").value, date=document.getElementById("agenda-date").value, title=document.getElementById("agenda-title").value.trim(); if(date&&title){ agenda.push({type,title,place:document.getElementById("agenda-place").value,when:new Date(date+"T"+(document.getElementById("agenda-time").value||"08:00"))}); save("cockpit_agenda",agenda); renderAgenda(); } }
    function deleteAgenda(i){ agenda.splice(i,1); save("cockpit_agenda",agenda); renderAgenda(); }
    
    function toggleMenu(){document.body.classList.toggle("menu-open");} function closeMenu(){document.body.classList.remove("menu-open");}
    renderMemos(); renderAgenda();
  </script>

  <script type="module">
  
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, setDoc, updateDoc, deleteDoc, doc,
  onSnapshot, query, orderBy, where, limit, Timestamp, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
  authDomain: "devoirs-pse.firebaseapp.com",
  projectId: "devoirs-pse",
  storageBucket: "devoirs-pse.appspot.com",
  messagingSenderId: "614730413904",
  appId: "1:614730413904:web:a5dd478af5de30f6bede55"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
    
    // VARIABLES GLOBALES
    // --- VARIABLES GLOBALES ---
let traficEstCharge = false;
let traficEnCours = false;
// --- NOUVELLE FONCTION NAVIGATION (Accessible globalement) ---
    window.showView = function(viewId, navEl) {
        
        // 1. UI : Gestion des classes active
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        const target = document.getElementById(viewId);
        if (target) target.classList.add('active');
        if (navEl) navEl.classList.add('active');

        // 2. LOGIQUE TRAFIC (On ne change rien)
        if (viewId === 'view-trafic' && !traficEstCharge && !traficEnCours) {
            console.log("ğŸš¦ Premier clic sur Trafic : Lancement du chargement...");
            traficEnCours = true;
            if (typeof traficRefresh === 'function') {
                traficRefresh()
                    .then(() => {
                        traficEstCharge = true;
                        console.log("âœ… Trafic chargÃ©.");
                    })
                    .catch(e => console.error("Erreur Trafic:", e))
                    .finally(() => traficEnCours = false);
            }
        }

        // 3. LOGIQUE SESSIONS (LA SEULE NOUVEAUTÃ‰ ICI ğŸ‘‡)
        if (viewId === 'view-sessions') {
            console.log("ğŸ“¡ Chargement du module Session...");
            if (typeof loadHistory === 'function') loadHistory(); 
        }

        // 4. Mobile : Fermer menu
        if (window.innerWidth <= 980) {
            document.body.classList.remove('menu-open');
        }
        
        // 5. MÃ©mos
        if (typeof renderMemos === 'function') renderMemos();
    };
        
// ... tes autres variables (allEvalData, etc.) ...
    let allData = []; 
    let filteredData = [];
    let statsDetails = { 
        hourly: new Array(24).fill(0), // Pour les 24h
        devices: { Mobile: 0, Desktop: 0 },
        pages: [] 
    };
    let currentSort = { col: 'date', dir: 'desc' };
    let globalChart = null;
    let detailsChart = null; // Pour le graphique dans la modale

   // --- 1. FONCTION DE CHARGEMENT PRINCIPALE (VERSION V12 - AVEC DÃ‰TECTIVE DE NOTE) ---
    window.chargerDonnees = async function() {
        console.log("ğŸš€ DÃ©marrage chargement...");
        const btns = document.querySelectorAll("button");
        btns.forEach(b => { if(b.innerText.includes("Actualiser")) b.innerText = "â³..."; });

        // --- LA FONCTION DÃ‰TECTIVE (ProposÃ©e par l'IA) ---
        function extractNote20(d){
            const candidates = [
                d?.resultat_auto?.score,
                d?.note_finale,
                d?.meta?.score,              
                d?.score,
                d?.note,
                d?.raw?.meta?.score,         // Souvent ici pour les vieux formats
                d?.raw?.score,
                d?.raw?.note_finale,
                d?.raw?.note,
            ];

            for (const c of candidates){
                if (c === 0) return 0;
                if (c === null || c === undefined) continue;
                if (typeof c === "number" && !isNaN(c)) return c;
                if (typeof c === "string"){
                    const m = c.match(/(\d+(?:[.,]\d+)?)/);
                    if (m) return parseFloat(m[1].replace(",", "."));
                }
            }
            return null;
        }
        // --------------------------------------------------
        
        try {
            const qEval = query(collection(db, "devoirs_rendus"), orderBy("createdAtISO", "desc"), limit(100));
            const snapEval = await getDocs(qEval);
            
            allData = [];
            let classes = new Set();
            let exercices = new Set();

            if (!snapEval.empty) {
                snapEval.forEach(doc => {
                    const d = doc.data();
                    
                    const item = {
                        id: doc.id,
                        raw: d, // <--- C'EST ICI LA CLÃ‰ (Sauvegarde la copie brute)
                        date: d.createdAtISO ? new Date(d.createdAtISO) : (d.date ? new Date(d.date) : new Date()),
                        identifiant: (d.eleve?.prenom || "") + " " + (d.eleve?.nom || "") || d.identifiant || "Anonyme",
                        classe: d.eleve?.classe || d.classe || "?",
                        temps_secondes: d.temps_secondes || 0,
                        exercice_titre: d.titre || d.devoirId || "Devoir",
                        
                        // âœ… ON UTILISE LE DÃ‰TECTIVE ICI
                        note_finale: extractNote20(d) ?? "--",
                        
                        competences: d.competences || {} 
                    };
                    allData.push(item);

                    if(item.classe) classes.add(item.classe);
                    if(item.exercice_titre) exercices.add(item.exercice_titre);
                });
            }
            
            // Mise Ã  jour des filtres
            const selClass = document.getElementById("filter-class");
            const selExo = document.getElementById("filter-exercice");
            const oldClass = selClass.value; 
            const oldExo = selExo.value;

            selClass.innerHTML = '<option value="ALL">Toutes les classes</option>';
            classes.forEach(c => selClass.innerHTML += `<option value="${c}">${c}</option>`);
            selClass.value = oldClass || "ALL";

            selExo.innerHTML = '<option value="ALL">Tous les exercices</option>';
            exercices.forEach(e => selExo.innerHTML += `<option value="${e}">${e}</option>`);
            selExo.value = oldExo || "ALL";

            applyFilters(); 

        } catch(e) { console.error("Erreur Eval:", e); }

        // Lancement des stats
        if(typeof chargerStatsCompletes === 'function') await chargerStatsCompletes();
        
        // Remise Ã  zÃ©ro des boutons
        btns.forEach(b => { if(b.innerText.includes("â³")) b.innerText = "ğŸ”„ Tout actualiser"; });
    }

    // --- 2. TRAITEMENT DES STATS (Pour le dÃ©tail) ---
    async function chargerStatsCompletes() {
        try {
            const qStats = query(collection(db, "statistiques_usage"));
            const snapStats = await getDocs(qStats);
            
            let totalViews = 0;
            // RÃ©initialiser les compteurs
            statsDetails.hourly.fill(0);
            statsDetails.devices = { Mobile: 0, Desktop: 0 };
            let pageCounts = {};

            snapStats.forEach(doc => {
                totalViews++;
                const d = doc.data();
                
                // 1. Device
                if(d.device && /Mobi|Android/i.test(d.device)) statsDetails.devices.Mobile++;
                else statsDetails.devices.Desktop++;

                // 2. Heure (Si disponible)
                if(d.timestamp) {
                    let date = d.timestamp.toDate ? d.timestamp.toDate() : new Date(d.timestamp);
                    let hour = date.getHours();
                    if(hour >= 0 && hour < 24) statsDetails.hourly[hour]++;
                } else if(d.date) {
                    // Fallback si format date string
                    let date = new Date(d.date);
                    let hour = date.getHours();
                    if(!isNaN(hour)) statsDetails.hourly[hour]++;
                }

                // 3. Pages
                let p = d.page || "Inconnu";
                pageCounts[p] = (pageCounts[p] || 0) + 1;
            });

            // PrÃ©parer le classement des pages
            statsDetails.pages = Object.keys(pageCounts).map(key => {
                return { name: key, count: pageCounts[key] };
            }).sort((a,b) => b.count - a.count);

            // Mise Ã  jour Affichage "Carte" (RÃ©sumÃ©)
            const elTotal = document.getElementById("stat-total-views");
            if(elTotal) elTotal.innerText = totalViews;

            let mobPct = totalViews>0 ? Math.round((statsDetails.devices.Mobile/totalViews)*100) : 0;
            const elDevice = document.getElementById("stat-device");
            if(elDevice) elDevice.innerText = `${mobPct}% Mobile`;

            let topExo = statsDetails.pages.length > 0 ? statsDetails.pages[0].name : "--";
            if(topExo.length > 18) topExo = topExo.substring(0, 16) + "...";
            const elTop = document.getElementById("stat-top-page");
            if(elTop) elTop.innerText = topExo;

        } catch(e) { console.error("Erreur Stats:", e); }
    }

    // --- 3. MODALE DÃ‰TAILS ---
    window.showStatDetails = function(type) {
        const modal = document.getElementById("modalStats");
        const title = document.getElementById("stats-title");
        const chartCanvas = document.getElementById("statsChart");
        const listDiv = document.getElementById("statsList");
        
        modal.classList.add("open");
        chartCanvas.style.display = "block";
        listDiv.innerHTML = "";
        
        if(detailsChart) { detailsChart.destroy(); }
        const ctx = chartCanvas.getContext('2d');

        if(type === 'views') {
            title.innerText = "â±ï¸ Trafic par heure (Jour vs Nuit)";
            listDiv.innerHTML = "<p style='text-align:center; color:#64748b; font-size:0.9rem;'>Analyse sur l'ensemble de l'historique</p>";
            
            detailsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [...Array(24).keys()].map(h => h+"h"),
                    datasets: [{
                        label: 'Visites',
                        data: statsDetails.hourly,
                        backgroundColor: (ctx) => {
                            const idx = ctx.dataIndex;
                            // Bleu pour la journÃ©e (8h-18h), Violet pour le soir/nuit
                            return (idx >= 8 && idx <= 18) ? '#3b82f6' : '#8b5cf6';
                        },
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

        } else if(type === 'devices') {
            title.innerText = "ğŸ“± RÃ©partition des supports";
            listDiv.innerHTML = "";
            
            detailsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mobile/Tablette', 'Ordinateur'],
                    datasets: [{
                        data: [statsDetails.devices.Mobile, statsDetails.devices.Desktop],
                        backgroundColor: ['#f59e0b', '#3b82f6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

        } else if(type === 'exercices') {
            title.innerText = "ğŸ† Classement complet des exercices";
            chartCanvas.style.display = "none"; // Pas de graph pour la liste longue
            
            let html = "";
            statsDetails.pages.forEach((p, i) => {
                let medal = "";
                if(i===0) medal = "ğŸ¥‡"; else if(i===1) medal = "ğŸ¥ˆ"; else if(i===2) medal = "ğŸ¥‰";
                
                html += `
                <div class="rank-item">
                    <span class="rank-pos">${medal || (i+1)+'.'}</span>
                    <span class="rank-name">${p.name}</span>
                    <span class="rank-val">${p.count} vues</span>
                </div>`;
            });
            listDiv.innerHTML = html;
        }
    }
    
    window.closeStatModal = function() {
        document.getElementById("modalStats").classList.remove("open");
    }

    // --- 4. GESTION DU SWIPE & SIDEBAR (Fix Mobile) ---
    let touchStartX = 0;
    
    // Fermeture par bouton
    window.closeMenu = function() {
        document.body.classList.remove("menu-open");
    }

    // Fermeture par Swipe
    document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
    document.addEventListener('touchend', e => {
        let touchEndX = e.changedTouches[0].screenX;
        // Si menu ouvert et glissement vers la gauche
        if(document.body.classList.contains("menu-open") && touchEndX < touchStartX - 50) {
            closeMenu();
        }
    }, {passive: true});

    // --- 5. INITIALISATION AUTO ---
    chargerDonnees(); // DÃ‰MARRAGE AUTOMATIQUE

    // ---------------------------------------------------------
    // FONCTIONS UTILITAIRES (Tableau, Tri, Badge...) inchangÃ©es
    // ---------------------------------------------------------
    window.applyFilters = function() {
        const fClass = document.getElementById("filter-class").value;
        const fExo = document.getElementById("filter-exercice").value;
        const fName = document.getElementById("filter-student").value.toLowerCase();

        filteredData = allData.filter(d => {
            if(fClass !== "ALL" && d.classe !== fClass) return false;
            if(fExo !== "ALL" && d.exercice_titre !== fExo) return false;
            if(fName && !d.identifiant.toLowerCase().includes(fName)) return false;
            return true;
        });
        sortData(currentSort.col, false);
    }
    
    window.sortData = function(col, toggle=true) {
        if(toggle) {
            if(currentSort.col === col) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            else { currentSort.col = col; currentSort.dir = 'asc'; } 
            if((col === 'date' || col === 'note_finale') && toggle && currentSort.col !== col) currentSort.dir = 'desc';
        }
        filteredData.sort((a,b) => {
            let va = a[col], vb = b[col];
            if(col === 'date') { va = a.date.seconds; vb = b.date.seconds; }
            if(col === 'note_finale' || col === 'temps_secondes') { va = Number(va||0); vb = Number(vb||0); }
            if(typeof va === 'string') va = va.toLowerCase();
            if(typeof vb === 'string') vb = vb.toLowerCase();
            if(va < vb) return currentSort.dir === 'asc' ? -1 : 1;
            if(va > vb) return currentSort.dir === 'asc' ? 1 : -1;
            return 0;
        });
        renderTable();
        updateGlobalRadar();
    }

    function renderTable() {
        const tbody = document.getElementById("tbody-eleves");
        // RÃ©cupÃ©ration sÃ©curisÃ©e des filtres
        const elClass = document.getElementById("filter-class");
        const elExo = document.getElementById("filter-exercice");
        const fCls = elClass ? elClass.value : "ALL";
        const fExo = elExo ? elExo.value : "ALL";

        tbody.innerHTML = ""; // âœ… Correction: innerHTML en majuscules

        // Filtrage local
        const filtered = allData.filter(d => {
            if(fCls !== "ALL" && d.classe !== fCls) return false;
            if(fExo !== "ALL" && d.exercice_titre !== fExo) return false;
            return true;
        });

        if (filtered.length === 0) { 
            tbody.innerHTML = "<tr><td colspan='7' class='scores-empty'>Aucun rÃ©sultat.</td></tr>"; 
            return;
        }

        filtered.forEach(d => {
            // Gestion Date (Compatible V10)
            let dateStr = "-";
            if(d.date instanceof Date) dateStr = d.date.toLocaleDateString("fr-FR");
            
            // Gestion du temps
            let timeStr = "-";
            if(d.temps_secondes) { 
                let m = Math.floor(d.temps_secondes/60);
                timeStr = m + " min"; 
            }

            // Gestion Note et Couleur
            let scoreClass = "color:#4b5563"; // Gris par dÃ©faut
            let scoreTxt = d.note_finale;
            
            if(scoreTxt !== "--") {
                scoreTxt += "/20";
                // Couleur rouge/vert
                let val = parseFloat(d.note_finale);
                if(val < 10) scoreClass = "color:#dc2626;font-weight:bold";
                else if(val >= 14) scoreClass = "color:#16a34a;font-weight:bold";
            }

            // URL du devoir (Mode Miroir)
            const urlDevoir = "https://preventionsanteenvironnement.github.io/PSE/devoirs/PSE_devoirs_CAP_A3_sedentarite_v1.html";

            // Insertion Ligne avec les DEUX BOUTONS
            tbody.innerHTML += `<tr>
                <td>${dateStr}</td>
                <td><span class="eleve-link" onclick="openStudentDetail('${d.identifiant}')">${d.identifiant}</span></td>
                <td><span class="pill pill-blue">${d.classe}</span></td>
                <td>${timeStr}</td>
                <td>${d.exercice_titre}</td>
                <td style="font-weight:bold; ${scoreClass}">${scoreTxt}</td>
                
                <td style="display:flex; gap:5px;">
                    <button onclick="ouvrirCorrection('${d.id}')" 
                       style="background:#fef3c7; color:#b45309; border:1px solid #fcd34d; padding:5px 8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.8rem;" title="Ouvrir la grille">
                       âœï¸ Grille
                    </button>
                    
                    <button onclick="window.open('${urlDevoir}?docId=${d.id}', '_blank')" 
                       style="background:#e0f2fe; color:#0369a1; border:1px solid #bae6fd; padding:5px 8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.8rem;" title="Voir copie originale">
                       ğŸ‘ï¸ Copie
                    </button>
                </td>
            </tr>`;
        });
    }

    function updateGlobalRadar() {
        let sums ={C1:0,C2:0,C3:0,C4:0,C5:0,C6:0}, counts={C1:0,C2:0,C3:0,C4:0,C5:0,C6:0};
        let totalNote=0, count=0;
        
        filteredData.forEach(d => {
            // 1. Calcul de la Note Moyenne (SÃ©curisÃ©)
            // On ne compte que si c'est un vrai chiffre
            if(d.note_finale && d.note_finale !== "--") {
                let val = parseFloat(d.note_finale);
                if(!isNaN(val)) {
                    totalNote += val;
                    count++;
                }
            }

            // 2. Calcul des CompÃ©tences
            if(d.competences) {
                for(let k in d.competences) {
                    let key = k.substring(0,2);
                    if(sums[key] !== undefined && d.competences[k] !== null) {
                        sums[key] += d.competences[k];
                        counts[key]++;
                    }
                }
            }
        });

        // Mise Ã  jour de l'affichage texte
        if(count > 0) document.getElementById("moyenne-globale").innerText = (totalNote/count).toFixed(1) + " / 20";
        else document.getElementById("moyenne-globale").innerText = "--";

        // Mise Ã  jour du graphique
        updateChart(radarChart, globalChart, sums, counts, "Moyenne SÃ©lection", 'rgba(59, 130, 246, 0.2)', '#3b82f6');
    }

    window.makeBadge = function(name, level) {
       let c = "pill-red"; if(level >= 1) c = "pill-orange"; if(level >= 2) c = "pill-green"; if(level === 3) c = "pill-blue";
       return `<span class="pill ${c}">${name}:${level}</span>`;
    }
    
    window.openStudentDetail = function(studentId) {
        // On rÃ©cupÃ¨re tout l'historique de cet Ã©lÃ¨ve
        const studentHistory = allData.filter(d => d.identifiant === studentId);
        if(studentHistory.length === 0) return;
        
        const last = studentHistory[0];
        document.getElementById("modal-name").innerText = last.identifiant;
        document.getElementById("modal-class").innerText = last.classe;
        
        let totalTime = 0, totalScore = 0, nbNotes = 0;
        let sums = {C1:0,C2:0,C3:0,C4:0,C5:0,C6:0}, counts = {C1:0,C2:0,C3:0,C4:0,C5:0,C6:0};
        let histHtml = "";
        
        studentHistory.forEach(h => {
            if(h.temps_secondes) totalTime += h.temps_secondes;
            
            // Calcul note sÃ©curisÃ©
            if(h.note_finale && h.note_finale !== "--"){
                let v = parseFloat(h.note_finale);
                if(!isNaN(v)) { totalScore += v; nbNotes++; }
            }

            if(h.competences) {
                for(let k in h.competences) {
                    let key = k.substring(0,2);
                    if(h.competences[k] !== null && sums[key] !== undefined) { 
                        sums[key] += h.competences[k]; 
                        counts[key]++; 
                    }
                }
            }
            
            // âœ… CORRECTION DATE (Gestion universelle)
            let dateAff = "-";
            if(h.date instanceof Date) {
                dateAff = h.date.toLocaleDateString("fr-FR");
            } else if (h.date && h.date.seconds) {
                dateAff = new Date(h.date.seconds * 1000).toLocaleDateString("fr-FR");
            } else if (typeof h.date === "string") {
                 dateAff = new Date(h.date).toLocaleDateString("fr-FR");
            }
            
            histHtml += `<tr><td>${dateAff}</td><td>${h.exercice_titre}</td><td><strong>${h.note_finale}/20</strong></td></tr>`;
        });
        
        // Moyennes affichÃ©es
        let avgScore = nbNotes > 0 ? (totalScore / nbNotes).toFixed(1) : "--";
        let avgTimeStr = "--";
        if(studentHistory.length > 0 && totalTime > 0) {
             let avgT = totalTime / studentHistory.length;
             avgTimeStr = Math.floor(avgT / 60) + "m " + Math.floor(avgT % 60);
        }
        
        document.getElementById("modal-avg").innerText = avgScore + " / 20";
        document.getElementById("modal-time").innerText = avgTimeStr;
        document.getElementById("modal-history").innerHTML = histHtml;
        
        document.getElementById("modalStudent").classList.add("open");
        
        setTimeout(() => { 
            updateChart("studentRadar", null, sums, counts, "Niveau de l'Ã©lÃ¨ve", 'rgba(16, 185, 129, 0.2)', '#10b981'); 
        }, 100);
    }
    window.closeModal = function() { document.getElementById("modalStudent").classList.remove("open"); }

    window.updateChart = function(canvasId, chartInstance, sums, counts, label, bgColor, borderColor) {
        const ctx = document.getElementById(canvasId);
        if(Chart.getChart(canvasId)) Chart.getChart(canvasId).destroy();
        const dataArr = [
            counts.C1 ? sums.C1/counts.C1 : 0, counts.C2 ? sums.C2/counts.C2 : 0, counts.C3 ? sums.C3/counts.C3 : 0,
            counts.C4 ? sums.C4/counts.C4 : 0, counts.C5 ? sums.C5/counts.C5 : 0, counts.C6 ? sums.C6/counts.C6 : 0
        ];
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['C1 Info', 'C2 Analyse', 'C3 Expliquer', 'C4 Solution', 'C5 Arg', 'C6 Com'],
                datasets: [{ label: label, data: dataArr, backgroundColor: bgColor, borderColor: borderColor, pointBackgroundColor: borderColor }]
            },
            options: { scales: { r: { suggestedMin: 0, suggestedMax: 3 } }, maintainAspectRatio: false }
        });
    }

  
    // ---------------------------------------------------------
    // TRAFIC (Monitoring) â€” module isolÃ©, dÃ©clenchÃ© Ã  lâ€™ouverture
    // ---------------------------------------------------------
    let traficWeekChart = null;
    let traficSplitChart = null;

    function traficPeriodStart(period) {
      const now = new Date();
      if (period === "today") return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
      if (period === "7d") {
        const d = new Date(now);
        d.setDate(d.getDate() - 6);
        d.setHours(0, 0, 0, 0);
        return d;
      }
      if (period === "month") return new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
      if (period === "year") return new Date(now.getFullYear(), 0, 1, 0, 0, 0, 0);
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
    }

    function traficToDate(d) {
      if (!d) return null;
      if (d.timestamp && d.timestamp.toDate) return d.timestamp.toDate();
      if (d.date) {
        const x = new Date(d.date);
        return isNaN(x.getTime()) ? null : x;
      }
      return null;
    }

    function traficNormalizeCode(code) {
      if (!code) return "INV";
      const c = String(code).trim();
      if (!c) return "INV";
      return c.toUpperCase();
    }

    function traficClassLabel(doc) {
      const c = doc.classe || doc.class || "";
      return c ? String(c) : "AUTRE";
    }

    function traficIsAnonymous(doc) {
      const code = traficNormalizeCode(doc.userCode || doc.code || doc.eleve || doc.identifiant);
      const classe = traficClassLabel(doc);
      if (code === "INV" || code === "ANONYME" || code === "PSE") return true;
      if (classe === "VISITEUR") return true;
      return false;
    }

    function traficPeriodLabel(doc, dt) {
      // prioritÃ© au champ "periode" si prÃ©sent, sinon calcul
      if (doc.periode) return String(doc.periode);
      const day = dt.getDay(); // 0 dim
      const hour = dt.getHours();
      if (day === 0 || day === 6) return "Week-end";
      if (hour >= 8 && hour < 18) return "Scolaire (8h-18h)";
      return "Soir/Nuit";
    }

    function traficWeekdayIndex(dt) {
      // On veut Lun..Dim => index 0..6
      const js = dt.getDay(); // 0 dim, 1 lun ... 6 sam
      return (js + 6) % 7;
    }

    function traficFmtDateTime(dt) {
      try {
        return dt.toLocaleString("fr-FR", { dateStyle: "short", timeStyle: "short" });
      } catch {
        return dt.toISOString();
      }
    }

    async function traficFetchLogs(startDate) {
      // On tente une requÃªte performante sur timestamp, sinon fallback sans where
      const startTs = Timestamp.fromDate(startDate);
      let snap = null;
      try {
        const q = query(
          collection(db, "statistiques_usage"),
          where("timestamp", ">=", startTs),
          orderBy("timestamp", "desc"),
          limit(1500)
        );
        snap = await getDocs(q);
      } catch (e) {
        console.warn("TRAFIC: requÃªte avec where/orderBy non disponible (index?) -> fallback", e);
        const q2 = query(collection(db, "statistiques_usage"), orderBy("timestamp", "desc"), limit(1500));
        snap = await getDocs(q2);
      }

      const out = [];
      snap.forEach(doc => {
        const d = doc.data();
        const dt = traficToDate(d);
        if (!dt) return;
        if (dt < startDate) return;
        out.push({ ...d, __dt: dt });
      });
      return out;
    }

    function traficFillSelect(selectEl, values, keepValue = true) {
      if (!selectEl) return;
      const current = selectEl.value;
      selectEl.innerHTML = "";
      values.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.value;
        opt.textContent = v.label;
        selectEl.appendChild(opt);
      });
      if (keepValue) {
        const found = [...selectEl.options].some(o => o.value === current);
        if (found) selectEl.value = current;
      }
    }

    function traficDestroyCharts() {
      if (Chart.getChart("traficChartWeek")) Chart.getChart("traficChartWeek").destroy();
      if (Chart.getChart("traficChartSplit")) Chart.getChart("traficChartSplit").destroy();
    }

    function traficRenderCharts(logs) {
      const labels = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"];
      const week = {
        "Scolaire (8h-18h)": new Array(7).fill(0),
        "Soir/Nuit": new Array(7).fill(0),
        "Week-end": new Array(7).fill(0),
      };

      const split = {
        "Scolaire (8h-18h)": 0,
        "Soir/Nuit": 0,
        "Week-end": 0,
      };

      logs.forEach(d => {
        const dt = d.__dt;
        const per = traficPeriodLabel(d, dt);
        const idx = traficWeekdayIndex(dt);
        if (!week[per]) return;
        week[per][idx] += 1;
        split[per] += 1;
      });

      if (Chart.getChart("traficChartWeek")) Chart.getChart("traficChartWeek").destroy();
      const ctxWeek = document.getElementById("traficChartWeek");
      if (ctxWeek) {
        traficWeekChart = new Chart(ctxWeek, {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: "Scolaire (8h-18h)", data: week["Scolaire (8h-18h)"], stack: "s" },
              { label: "Soir/Nuit", data: week["Soir/Nuit"], stack: "s" },
              { label: "Week-end", data: week["Week-end"], stack: "s" },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: true },
              y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } },
            },
            plugins: { legend: { position: "bottom" } },
          },
        });
      }

      if (Chart.getChart("traficChartSplit")) Chart.getChart("traficChartSplit").destroy();
      const ctxSplit = document.getElementById("traficChartSplit");
      if (ctxSplit) {
        traficSplitChart = new Chart(ctxSplit, {
          type: "doughnut",
          data: {
            labels: Object.keys(split),
            datasets: [{ data: Object.values(split) }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: "bottom" } },
          },
        });
      }
    }

    function traficRenderTopPages(logs) {
      const box = document.getElementById("trafic-top-pages");
      if (!box) return;

      const counts = {};
      const anonCounts = {};
      logs.forEach(d => {
        const page = String(d.page || d.nomPage || d.contenu || "Inconnu");
        counts[page] = (counts[page] || 0) + 1;
        if (traficIsAnonymous(d)) anonCounts[page] = (anonCounts[page] || 0) + 1;
      });

      const ranked = Object.keys(counts).map(name => {
        const total = counts[name];
        const anon = anonCounts[name] || 0;
        const anonPct = total ? Math.round((anon / total) * 100) : 0;
        return { name, total, anonPct };
      }).sort((a, b) => b.total - a.total).slice(0, 15);

      let html = "";
      ranked.forEach((p, i) => {
        html += `
          <div class="rank-item">
            <span class="rank-pos">${i + 1}.</span>
            <span class="rank-name">${p.name}</span>
            <span class="rank-val">${p.total} vues â€¢ ${p.anonPct}% anon.</span>
          </div>`;
      });

      box.innerHTML = html || `<div style="color:#64748b;">Aucune donnÃ©e sur la pÃ©riode.</div>`;
    }

    function traficRenderPresence(logs, classFilter, eleveFilter) {
      const tbody = document.getElementById("trafic-presence-body");
      if (!tbody) return;

      // AgrÃ©gation par Ã©lÃ¨ve
      const map = new Map();
      logs.forEach(d => {
        const code = traficNormalizeCode(d.userCode || d.code || d.eleve || d.identifiant);
        const classe = traficClassLabel(d);
        const dt = d.__dt;

        if (classFilter !== "ALL" && classe !== classFilter) return;
        if (eleveFilter !== "ALL" && code !== eleveFilter) return;

        const key = `${code}__${classe}`;
        const item = map.get(key) || { code, classe, count: 0, lastDt: null, lastPage: "" };
        item.count += 1;

        if (!item.lastDt || dt > item.lastDt) {
          item.lastDt = dt;
          item.lastPage = String(d.page || d.nomPage || d.contenu || "Inconnu");
        }
        map.set(key, item);
      });

      const rows = [...map.values()].sort((a, b) => {
        if (b.count !== a.count) return b.count - a.count;
        return (b.lastDt?.getTime() || 0) - (a.lastDt?.getTime() || 0);
      }).slice(0, 60);

      if (rows.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4' class='scores-empty'>Aucune activitÃ© sur la pÃ©riode.</td></tr>";
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const last = r.lastDt ? `${traficFmtDateTime(r.lastDt)} â€¢ ${r.lastPage}` : "-";
        return `<tr>
          <td style="font-weight:800;">${r.code}</td>
          <td>${r.classe}</td>
          <td>${r.count}</td>
          <td>${last}</td>
        </tr>`;
      }).join("");
    }

    function traficRenderLogs(logs, classFilter, eleveFilter, typeFilter) {
      const tbody = document.getElementById("trafic-logs-body");
      if (!tbody) return;

      const filtered = logs.filter(d => {
        const code = traficNormalizeCode(d.userCode || d.code || d.eleve || d.identifiant);
        const classe = traficClassLabel(d);
        const anon = traficIsAnonymous(d);

        if (classFilter !== "ALL" && classe !== classFilter) return false;
        if (eleveFilter !== "ALL" && code !== eleveFilter) return false;
        if (typeFilter === "IDENT" && anon) return false;
        if (typeFilter === "ANON" && !anon) return false;
        return true;
      }).slice(0, 120);

      if (filtered.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' class='scores-empty'>Aucune ligne sur la pÃ©riode.</td></tr>";
        return;
      }

      tbody.innerHTML = filtered.map(d => {
        const dt = d.__dt;
        const code = traficNormalizeCode(d.userCode || d.code || d.eleve || d.identifiant);
        const classe = traficClassLabel(d);
        const action = String(d.action || "Consultation");
        const page = String(d.page || d.nomPage || d.contenu || "Inconnu");
        const anon = traficIsAnonymous(d);
        const type = anon ? "Anonyme" : "IdentifiÃ©";
        return `<tr>
          <td>${traficFmtDateTime(dt)}</td>
          <td style="font-weight:800;">${code}</td>
          <td>${classe}</td>
          <td>${action}</td>
          <td>${page}</td>
          <td>${type}</td>
        </tr>`;
      }).join("");
    }

    async function traficRefresh() {
      const period = document.getElementById("trafic-period")?.value || "7d";
      const classSel = document.getElementById("trafic-class");
      const eleveSel = document.getElementById("trafic-eleve");
      const typeSel = document.getElementById("trafic-type");

      const start = traficPeriodStart(period);

      const note = document.getElementById("trafic-note");
      if (note) note.textContent = "Chargementâ€¦";

      const logs = await traficFetchLogs(start);

      // Remplir listes Classe/Ã‰lÃ¨ve Ã  partir des logs (dynamiques)
      const classes = new Set(["ALL"]);
      const elevesAll = new Set(["ALL"]);

      logs.forEach(d => {
        const classe = traficClassLabel(d);
        const code = traficNormalizeCode(d.userCode || d.code || d.eleve || d.identifiant);
        classes.add(classe);
        elevesAll.add(code);
      });

      const classFilter = classSel?.value || "ALL";
      const classValues = [{ value: "ALL", label: "Toutes les classes" }, ...[...classes].filter(x => x !== "ALL").sort().map(c => ({ value: c, label: c }))];
      traficFillSelect(classSel, classValues, true);

      // Ã‰lÃ¨ves dÃ©pendant de la classe choisie
      const eleves = new Set(["ALL"]);
      logs.forEach(d => {
        const classe = traficClassLabel(d);
        if (classSel && classSel.value !== "ALL" && classe !== classSel.value) return;
        const code = traficNormalizeCode(d.userCode || d.code || d.eleve || d.identifiant);
        eleves.add(code);
      });

      const eleveValues = [{ value: "ALL", label: "Tous les Ã©lÃ¨ves" }, ...[...eleves].filter(x => x !== "ALL").sort().map(e => ({ value: e, label: e }))];
      traficFillSelect(eleveSel, eleveValues, true);

      const effectiveClass = classSel?.value || "ALL";
      const effectiveEleve = eleveSel?.value || "ALL";
      const effectiveType = typeSel?.value || "ALL";

      // Filtrer pour les rendus (macro dÃ©pend aussi type/classe/Ã©lÃ¨ve)
      const logsForView = logs.filter(d => {
        const classe = traficClassLabel(d);
        const code = traficNormalizeCode(d.userCode || d.code || d.eleve || d.identifiant);
        const anon = traficIsAnonymous(d);

        if (effectiveClass !== "ALL" && classe !== effectiveClass) return false;
        if (effectiveEleve !== "ALL" && code !== effectiveEleve) return false;
        if (effectiveType === "IDENT" && anon) return false;
        if (effectiveType === "ANON" && !anon) return false;
        return true;
      });

      traficRenderCharts(logsForView);
      traficRenderTopPages(logsForView);
      traficRenderPresence(logsForView, effectiveClass, effectiveEleve);
      traficRenderLogs(logsForView, effectiveClass, effectiveEleve, effectiveType);

      if (note) {
        note.textContent = `${logsForView.length} Ã©vÃ©nements sur la pÃ©riode (${period}).`;
      }
    }

    window.traficInit = (function () {
      let done = false;
      return function () {
        if (done) return;
        done = true;

        const period = document.getElementById("trafic-period");
        const cls = document.getElementById("trafic-class");
        const eleve = document.getElementById("trafic-eleve");
        const type = document.getElementById("trafic-type");
        const btn = document.getElementById("trafic-refresh");

        [period, cls, eleve, type].forEach(el => {
          if (!el) return;
          el.addEventListener("change", () => traficRefresh());
        });
        if (btn) btn.addEventListener("click", () => traficRefresh());

        traficRefresh();
      };
    })();

// --- 3. FONCTION POUR OUVRIR LA GRILLE (Ã‰TAPE 3) ---
    window.ouvrirCorrection = function(id) {
        console.log("Tentative d'ouverture de la grille pour l'ID :", id);
        
        // 1. Trouver l'Ã©lÃ¨ve dans la liste chargÃ©e
        const student = allData.find(d => d.id === id);
        
        if(!student) {
            alert("Erreur : Ã‰lÃ¨ve introuvable dans les donnÃ©es.");
            return;
        }
        
        if(!student.raw) {
            alert("Erreur : Pas de donnÃ©es brutes (raw) pour cet Ã©lÃ¨ve. Avez-vous bien fait l'Ã©tape 2 ?");
            return;
        }

        // 2. Sauvegarder ses donnÃ©es dans la "valise" (localStorage) pour le voyage
        localStorage.setItem("cockpit_transfert", JSON.stringify(student.raw));

        // 3. Ouvrir le fichier grille.html
        // IMPORTANT : Le fichier doit s'appeler exactement "grille.html"
        window.open("grille.html", "_blank");
    };
    // ==========================================
// MODULE : GESTIONNAIRE DE SESSIONS (Standard)
// ==========================================

    // Variables pour le module session
let currentSessionId = null;
let sessionUnsubscribe = null;
let wordsUnsubscribe = null;

// 1. DÃ‰MARRAGE : Charger l'historique quand on ouvre la vue
// Ajoute ceci dans ta fonction showView existante (voir plus bas pour l'intÃ©gration)
window.initSessionModule = function() {
    loadHistory();
}

// 2. CRÃ‰ER UNE NOUVELLE SESSION
window.createNewSession = async function() {
    const titleInput = document.getElementById("session-title-input");
    const title = titleInput.value.trim();
    
    if(!title) { alert("Merci de donner un titre !"); return; }

    try {
        // A. CrÃ©er le document dans la collection 'sessions'
        const sessionRef = await addDoc(collection(db, "sessions"), {
  title: title,
  createdAt: new Date(),
  isActive: true,
  currentStep: 'attente'
});

        currentSessionId = sessionRef.id;

        // B. Mettre Ã  jour la CONFIG GLOBALE pour que les tÃ©lÃ©phones sachent oÃ¹ aller
        // Les tÃ©lÃ©phones Ã©coutent le doc 'config/live'
       await setDoc(doc(db, "config", "live"), {
  activeSessionId: currentSessionId,
  sessionTitle: title,
  currentStep: "attente",
  updatedAt: serverTimestamp()
}, { merge: true });

        // C. UI : Passer en mode Live
        activateLivePanel(title, 0);
        titleInput.value = ""; // Vider le champ

        // D. Lancer l'Ã©coute des mots (pour modÃ©ration)
        listenToLiveWords(currentSessionId);

        console.log("âœ… Session lancÃ©e : " + currentSessionId);
    } catch(e) {
        console.error("Erreur crÃ©ation session", e);
        alert("Erreur technique Firebase (voir console)");
    }
}

// 3. CHANGER L'Ã‰TAPE (MÃ©tÃ©o, Nuage...)
window.switchStep = async function(stepName) {
    if(!currentSessionId) return;
    
    // Mise Ã  jour locale (visuel bouton)
    // (Optionnel : ajouter une classe 'active' sur le bouton cliquÃ©)
    
    // Mise Ã  jour Firebase (Config globale + Session)
    try {
        await setDoc(doc(db, "config", "live"), { currentStep: stepName, updatedAt: serverTimestamp() }, { merge:true });
await updateDoc(doc(db, "sessions", currentSessionId), { currentStep: stepName });
    } catch(e) { console.error(e); }
}

// 4. Ã‰COUTER LES MOTS EN DIRECT (ModÃ©ration)
function listenToLiveWords(sessId) {
    if(wordsUnsubscribe) wordsUnsubscribe(); // Stop ancienne Ã©coute

    // On Ã©coute la sous-collection 'inputs' de cette session
    const q = query(collection(db, `sessions/${sessId}/inputs`), orderBy("timestamp", "desc"), limit(100));

    wordsUnsubscribe = onSnapshot(q, (snapshot) => {
        const feed = document.getElementById("live-word-feed");
        const counter = document.getElementById("live-counter");
        
        // Compteur de participants (approximatif basÃ© sur les rÃ©ponses)
        if(counter) counter.innerText = snapshot.size;

        if(snapshot.empty) {
            feed.innerHTML = '<span style="color:#94a3b8; width:100%; text-align:center; margin-top:20px;">En attente...</span>';
            return;
        }

        feed.innerHTML = "";
        
        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            
            // On n'affiche que les mots (pas les votes sondage) et ceux non bannis
            if(d.type === 'word' && !d.banned) {
                const tag = document.createElement("div");
                tag.style.cssText = "display:inline-flex; align-items:center; gap:5px; padding:6px 10px; background:#fff; border:1px solid #cbd5e1; border-radius:20px; font-weight:bold; font-size:0.9rem; box-shadow:0 2px 5px rgba(0,0,0,0.05);";
                tag.innerHTML = `
                    ${d.content} 
                    <button onclick="banWord('${sessId}', '${docSnap.id}')" style="background:none; border:none; cursor:pointer; font-size:0.8rem;">âŒ</button>
                `;
                feed.appendChild(tag);
            }
        });
    });
}

// 5. BANNIR UN MOT
window.banWord = async function(sessId, wordId) {
    if(confirm("Masquer ce mot de l'Ã©cran gÃ©ant ?")) {
        await updateDoc(doc(db, `sessions/${sessId}/inputs/${wordId}`), { banned: true });
    }
}

// 6. STOPPER LA SESSION
window.stopSession = async function() {
    if(!confirm("Terminer et archiver cette session ? Les participants seront dÃ©connectÃ©s.")) return;

    if(currentSessionId) {
        // DÃ©sactiver dans Firebase
        await updateDoc(doc(db, "sessions", currentSessionId), { isActive: false });

await setDoc(doc(db, "config", "live"), {
  activeSessionId: null,
  currentStep: "attente",
  updatedAt: serverTimestamp()
}, { merge: true });
        
        // UI : Retour Ã  l'accueil
        document.getElementById("live-panel").style.display = "none";
        
        // ArrÃªter les Ã©coutes
        if(wordsUnsubscribe) wordsUnsubscribe();
        currentSessionId = null;
        
        // Recharger l'historique
        loadHistory();
    }
}

// 7. CHARGER L'HISTORIQUE (Archives)
async function loadHistory() {
    const list = document.getElementById("history-list");
    list.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8;">Chargement...</div>';

    try {
        const q = query(collection(db, "sessions"), orderBy("createdAt", "desc"), limit(20));
        const snap = await getDocs(q);

        if(snap.empty) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8;">Aucune session archivÃ©e.</div>';
            return;
        }

        list.innerHTML = "";
        snap.forEach(docSnap => {
            const d = docSnap.data();
            let dateStr = "?";
if (d.createdAt?.toDate) dateStr = d.createdAt.toDate().toLocaleDateString("fr-FR");
else if (d.createdAt instanceof Date) dateStr = d.createdAt.toLocaleDateString("fr-FR");
            const statusBadge = d.isActive ? '<span style="background:#fecaca; color:#be185d; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:bold;">EN COURS</span>' : '<span style="background:#f1f5f9; color:#64748b; padding:2px 6px; border-radius:4px; font-size:0.7rem;">TERMINE</span>';

            list.innerHTML += `
                <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; color:#1e293b;">${d.title || "Sans titre"}</div>
                        <div style="font-size:0.8rem; color:#64748b;">${dateStr} â€¢ ${statusBadge}</div>
                    </div>
                    ${!d.isActive ? `<button onclick="alert('BientÃ´t : Rapport PDF')" class="btn-blue-outline" style="font-size:0.75rem;">ğŸ“„ Rapport</button>` : ''}
                </div>
            `;
        });
    } catch(e) {
        console.error("Erreur historique", e);
        list.innerHTML = "Erreur chargement.";
    }
}

// Helpers UI
function activateLivePanel(title, count) {
    const panel = document.getElementById("live-panel");
    const titleSpan = document.getElementById("live-title-display");
    const countSpan = document.getElementById("live-counter");
    
    panel.style.display = "block";
    titleSpan.innerText = title;
    countSpan.innerText = count;
    
    // Animation scroll vers le panneau
    panel.scrollIntoView({behavior: "smooth"});
}
    // --- GESTION DES CONFIGURATIONS & BIBLIOTHÃˆQUE ---

    // 1. LES DONNÃ‰ES PRÃ‰PARÃ‰ES (C'est ici que tu prÃ©pares tes dossiers !)
    const PRESETS_CLOUD = {
        "cafe_parents": "HarcÃ¨lement, Ã‰crans, Sommeil, Cantine, Discipline, Orientation",
        "absenteisme": "Maladie, Transport, Motivation, ProblÃ¨mes familiaux, Retards",
        "orientation": "Seconde gÃ©nÃ©rale, Bac Pro, CAP, Apprentissage, Stage",
        "reunion_prof": "Budget, Planning, Conseil de classe, Projets, Voyage"
    };

    const PRESETS_POLL = {
        "satisfaction": { q: "ÃŠtes-vous satisfait de cet Ã©change ?", o: ["Oui, trÃ¨s", "Moyennement", "Pas du tout"] },
        "compr_cours": { q: "Avez-vous compris ce point ?", o: ["Vert (Compris)", "Orange (Moyen)", "Rouge (Perdu)"] },
        "date_reunion": { q: "Quelle dispo pour la prochaine ?", o: ["Lundi Soir", "Mardi Soir", "Samedi Matin"] },
        "climat": { q: "Comment jugez-vous le climat de la classe ?", o: ["Serein", "AgitÃ©", "Tendu"] }
    };

    // 2. FONCTIONS DE CHARGEMENT
    window.loadCloudPreset = function() {
        const key = document.getElementById('preset-cloud').value;
        if(PRESETS_CLOUD[key]) {
            document.getElementById('word-bank-input').value = PRESETS_CLOUD[key];
        }
    }

    window.loadPollPreset = function() {
        const key = document.getElementById('preset-poll').value;
        if(PRESETS_POLL[key]) {
            const p = PRESETS_POLL[key];
            document.getElementById('poll-question').value = p.q;
            document.getElementById('poll-opt1').value = p.o[0] || "";
            document.getElementById('poll-opt2').value = p.o[1] || "";
            document.getElementById('poll-opt3').value = p.o[2] || "";
        }
    }

    // 3. FONCTIONS D'AFFICHAGE ET D'ENVOI (DÃ©jÃ  existantes mais rappelÃ©es)
    
    // Modifier switchStep pour afficher les bons rÃ©glages
    const originalSwitchStep = window.switchStep;
    window.switchStep = async function(stepName) {
        await originalSwitchStep(stepName); 
        const configNuage = document.getElementById('config-nuage');
        const configSondage = document.getElementById('config-sondage');
        if(configNuage) configNuage.style.display = (stepName === 'nuage') ? 'block' : 'none';
        if(configSondage) configSondage.style.display = (stepName === 'sondage') ? 'block' : 'none';
    }

    window.updateWordBank = async function() {
        const text = document.getElementById('word-bank-input').value;
        const words = text.split(',').map(w => w.trim()).filter(w => w); 
        await setDoc(doc(db, "config", "live"), { wordBank: words, updatedAt: serverTimestamp() }, { merge: true });
        alert("Boutons envoyÃ©s aux parents !");
    }

    window.updatePollDetails = async function() {
        const question = document.getElementById('poll-question').value.trim();
        const opt1 = document.getElementById('poll-opt1').value.trim();
        const opt2 = document.getElementById('poll-opt2').value.trim();
        const opt3 = document.getElementById('poll-opt3').value.trim();

        let options = [];
        if(opt1) options.push(opt1);
        if(opt2) options.push(opt2);
        if(opt3) options.push(opt3);

        if(!question || options.length < 2) {
            alert("âš ï¸ Il faut une question et au moins 2 choix !");
            return;
        }

        await setDoc(doc(db, "config", "live"), { pollQuestion: question, pollOptions: options, updatedAt: serverTimestamp() }, { merge: true });
        alert("âœ… Sondage lancÃ© !");
    }
  </script>
</body>
</html>

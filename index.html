<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cockpit Professeur ‚Äì Pilotage Global</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-body:#f1f5f9; --bg-sidebar:#0f172a; --text-main:#1e293b; --text-muted:#64748b;
      --col-pedago:#3b82f6; --col-eval:#f59e0b; --col-class:#10b981; --col-proj:#8b5cf6;
      --col-admin:#f97316; --col-live-web:#795548; --col-sites:#607d8b;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; font-family:'Inter',sans-serif;
      background-color:var(--bg-body); color:var(--text-main);
      display:flex; height:100vh; overflow:hidden;
    }

    /* SIDEBAR */
    .sidebar{
      width:300px; background-color:var(--bg-sidebar); color:#fff;
      display:flex; flex-direction:column; padding:20px; transition:transform 0.3s ease;
      position:fixed; height:100%; z-index:1000;
    }
    .sidebar.closed{ transform:translateX(-100%); }
    .logo-area{
      font-size:1.4rem; font-weight:700; margin-bottom:30px; letter-spacing:-0.5px;
      display:flex; align-items:center; gap:10px; color:#fff; text-decoration:none;
    }
    .nav-item{
      padding:12px 15px; margin-bottom:5px; border-radius:8px; cursor:pointer;
      font-weight:500; color:#94a3b8; transition:all 0.2s; display:flex; align-items:center; gap:10px;
    }
    .nav-item:hover{ background-color:rgba(255,255,255,0.05); color:#fff; }
    .nav-item.active{ background-color:#3b82f6; color:#fff; box-shadow:0 4px 12px rgba(59,130,246,0.3); }
    
    /* Couleurs sp√©cifiques par item actif */
    .nav-item[data-theme="pedago"].active{ background-color:var(--col-pedago); box-shadow:0 4px 12px rgba(59,130,246,0.3); }
    .nav-item[data-theme="eval"].active{ background-color:var(--col-eval); box-shadow:0 4px 12px rgba(245,158,11,0.3); }
    .nav-item[data-theme="class"].active{ background-color:var(--col-class); box-shadow:0 4px 12px rgba(16,185,129,0.3); }
    .nav-item[data-theme="proj"].active{ background-color:var(--col-proj); box-shadow:0 4px 12px rgba(139,92,246,0.3); }
    .nav-item[data-theme="admin"].active{ background-color:var(--col-admin); box-shadow:0 4px 12px rgba(249,115,22,0.3); }
    .nav-item[data-theme="live"].active{ background-color:var(--col-live-web); box-shadow:0 4px 12px rgba(121,85,72,0.3); }
    .nav-item[data-theme="sites"].active{ background-color:var(--col-sites); box-shadow:0 4px 12px rgba(96,125,139,0.3); }

    .bottom-link{ margin-top:auto; font-size:0.85rem; color:#64748b; text-align:center; cursor:pointer; }
    .bottom-link:hover{ color:#fff; }

    /* MAIN CONTENT */
    .main-content{
      flex:1; margin-left:300px; padding:30px; overflow-y:auto;
      transition:margin-left 0.3s ease; width:calc(100% - 300px);
    }
    .main-content.full{ margin-left:0; width:100%; }

    /* HEADER MOBILE */
    .mobile-header{
      display:none; align-items:center; justify-content:space-between;
      padding:15px 20px; background:var(--bg-sidebar); color:#fff;
      position:fixed; top:0; left:0; width:100%; z-index:999;
    }
    .hamburger{ font-size:1.5rem; cursor:pointer; }

    /* VIEW SECTIONS */
    .view-section{ display:none; animation:fadeIn 0.3s ease; }
    .view-section.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    h2{ margin-top:0; font-size:1.8rem; margin-bottom:20px; border-bottom:2px solid #e2e8f0; padding-bottom:10px; }

    /* WIDGETS & CARDS */
    .dashboard-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-bottom:30px; }
    .widget{ background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,0.03); border:1px solid #e2e8f0; }
    .widget h3{ margin-top:0; font-size:1rem; color:var(--text-muted); margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;}
    
    .stat-card{ background:#fff; padding:20px; border-radius:12px; border-left:5px solid #ccc; box-shadow:0 2px 4px rgba(0,0,0,0.03); }
    .stat-value{ font-size:2rem; font-weight:700; color:var(--text-main); }
    .stat-label{ color:var(--text-muted); font-size:0.9rem; }

    /* TABLEAUX */
    .results-table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:0.9rem; }
    .results-table th{ text-align:left; padding:12px; background-color:#f8fafc; color:var(--text-muted); border-bottom:2px solid #e2e8f0; }
    .results-table td{ padding:12px; border-bottom:1px solid #e2e8f0; }
    .results-table tr:hover{ background-color:#f1f5f9; }
    .badge-score{ padding:4px 8px; border-radius:12px; font-weight:600; font-size:0.8rem; }
    .score-high{ background:#dcfce7; color:#166534; }
    .score-mid{ background:#fef9c3; color:#854d0e; }
    .score-low{ background:#fee2e2; color:#991b1b; }

    /* FILTRES TOOLBAR */
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; }
    .filter-select{ padding:8px 12px; border:1px solid #cbd5e1; border-radius:6px; background:#fff; font-size:0.9rem; }
    
    /* MODAL */
    .modal-overlay{
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.5); z-index:2000;
        display:none; justify-content:center; align-items:center;
    }
    .modal-overlay.open{ display:flex; }
    .modal-content{
        background:#fff; width:90%; max-width:800px; max-height:90vh;
        border-radius:12px; padding:25px; overflow-y:auto; position:relative;
        box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);
    }
    .close-modal{ position:absolute; top:15px; right:20px; font-size:1.5rem; cursor:pointer; color:#64748b; }

    /* RESPONSIVE */
    @media(max-width:768px){
      .sidebar{ transform:translateX(-100%); width:260px; }
      .sidebar.open{ transform:translateX(0); }
      .main-content{ margin-left:0; width:100%; padding-top:70px; }
      .mobile-header{ display:flex; }
      .dashboard-grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

  <div class="mobile-header">
    <div style="font-weight:700;">Cockpit Prof</div>
    <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
  </div>

  <nav class="sidebar" id="mySidebar">
    <a href="#" class="logo-area">üöÄ COCKPIT v2</a>
    
    <div class="nav-item active" onclick="showView('dashboard', this)">üìä Tableau de bord</div>
    
    <div id="nav-trafic" class="nav-item" data-theme="admin" onclick="showView('view-trafic', this)">üö¶ TRAFIC</div>

    <div class="nav-item" data-theme="pedago" onclick="showView('view-pedago', this)">üìö P√©dagogie</div>
    <div class="nav-item" data-theme="eval" onclick="showView('view-scores', this)">üìù √âvaluations</div>
    <div class="nav-item" data-theme="class" onclick="showView('view-classes', this)">üë• Mes Classes</div>
    <div class="nav-item" data-theme="proj" onclick="showView('view-projets', this)">üé® Projets & Chefs d'≈íuvre</div>
    <div class="nav-item" data-theme="admin" onclick="showView('view-admin', this)">‚öôÔ∏è Administration</div>
    <div class="nav-item" data-theme="live" onclick="showView('view-live', this)">üî¥ Live Web</div>
    <div class="nav-item" data-theme="sites" onclick="showView('view-sites', this)">üåê Sites & Ressources</div>

    <div class="bottom-link" onclick="alert('D√©connexion simul√©e')">Se d√©connecter</div>
  </nav>

  <main class="main-content" id="mainContent">

    <section id="dashboard" class="view-section active">
      <h2>Vue d'ensemble</h2>
      <div class="dashboard-grid">
        <div class="stat-card" style="border-left-color:var(--col-pedago);">
          <div class="stat-value" id="nb-activites">-</div>
          <div class="stat-label">Activit√©s actives</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--col-eval);">
          <div class="stat-value" id="nb-evals">-</div>
          <div class="stat-label">√âvaluations re√ßues</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--col-class);">
          <div class="stat-value" id="nb-eleves">-</div>
          <div class="stat-label">√âl√®ves suivis</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--col-admin);">
          <div class="stat-value" id="nb-visites">-</div>
          <div class="stat-label">Visites totales</div>
        </div>
      </div>
      <div class="widget">
        <h3>Activit√© R√©cente (Toutes classes)</h3>
        <div style="height:300px;"><canvas id="globalChart"></canvas></div>
      </div>
    </section>

    <section id="view-pedago" class="view-section">
      <h2 style="color:var(--col-pedago);">Biblioth√®que P√©dagogique</h2>
      <div class="widget">
        <p>Liste des chapitres, fiches de r√©vision et supports de cours.</p>
        <div style="padding:20px; background:#f8fafc; border-radius:8px; text-align:center; color:#94a3b8;">
          Module en construction...
        </div>
      </div>
    </section>

    <section id="view-scores" class="view-section">
      <h2 style="color:var(--col-eval);">R√©sultats & Comp√©tences</h2>
      
      <div class="widget">
        <div class="toolbar">
           <select id="filter-class" class="filter-select" onchange="applyFilters()">
             <option value="ALL">Toutes les classes</option>
           </select>
           <select id="filter-eleve" class="filter-select" onchange="applyFilters()">
             <option value="ALL">Tous les √©l√®ves</option>
           </select>
           <input type="text" id="search-eval" placeholder="Rechercher..." class="filter-select" onkeyup="applyFilters()">
           <button class="filter-select" style="background:var(--col-eval); color:#fff; border:none; cursor:pointer;" onclick="sortData('date')">üìÖ Trier Date</button>
           <button class="filter-select" style="background:#fff; cursor:pointer;" onclick="sortData('note')">üèÜ Trier Note</button>
        </div>
      </div>

      <div class="dashboard-grid">
         <div class="widget">
           <h3>Tableau des R√©sultats</h3>
           <div style="overflow-x:auto;">
             <table class="results-table">
               <thead>
                 <tr>
                   <th>Date</th>
                   <th>√âl√®ve</th>
                   <th>Classe</th>
                   <th>Exercice</th>
                   <th>Note /20</th>
                   <th>Action</th>
                 </tr>
               </thead>
               <tbody id="scores-body">
                 </tbody>
             </table>
           </div>
         </div>
         
         <div class="widget">
            <h3>Progression par Comp√©tence (Moyenne classe)</h3>
            <div style="height:250px;"><canvas id="competenceRadar"></canvas></div>
         </div>
      </div>
    </section>

    <section id="view-classes" class="view-section">
      <h2 style="color:var(--col-class);">Gestion des Classes</h2>
      <div class="dashboard-grid">
        <div id="classes-list-container" style="display:contents;"></div>
      </div>
    </section>

    <section id="view-projets" class="view-section">
      <h2 style="color:var(--col-proj);">Suivi de Projets</h2>
      <div class="widget">
         <p>Espace de suivi des Chefs d'Oeuvre et projets de groupe.</p>
      </div>
    </section>

    <section id="view-admin" class="view-section">
      <h2 style="color:var(--col-admin);">Administration</h2>
      <div class="widget">
        <h3>Configuration</h3>
        <p>Gestion des param√®tres du Cockpit.</p>
      </div>
    </section>

    <section id="view-live" class="view-section">
      <h2 style="color:var(--col-live-web);">Live & Visio</h2>
      <div class="widget">
        <p>Interfaces pour lancer des sessions live.</p>
      </div>
    </section>

    <section id="view-sites" class="view-section">
      <h2 style="color:var(--col-sites);">Sites & Ressources Externes</h2>
      <div class="dashboard-grid">
         <div class="widget">
            <h3>Mes Sites P√©dagogiques</h3>
            <ul style="line-height:1.8;">
                <li><a href="#" target="_blank">Site de Cours Principal</a></li>
                <li><a href="#" target="_blank">Blog √âl√®ves</a></li>
                <li><a href="#" target="_blank">Drive Ressources</a></li>
            </ul>
         </div>
         <div class="widget">
            <h3>Outils Institutionnels</h3>
            <ul style="line-height:1.8;">
                <li><a href="https://pronote.index-education.net/" target="_blank">Pronote</a></li>
                <li><a href="#" target="_blank">ENT R√©gion</a></li>
            </ul>
         </div>
      </div>
    </section>

    <section id="view-trafic" class="view-section">
      <h2 style="color:var(--col-admin);">üö¶ Monitoring & Trafic</h2>

      <div class="widget" style="margin-bottom:20px;">
        <h3>üéõÔ∏è Filtres de pilotage</h3>
        <div class="toolbar" id="trafic-filters-container">
           <p style="color:#666;">Chargement des filtres...</p>
        </div>
      </div>

      <div class="dashboard-grid" style="margin-bottom:25px;">
        <div class="widget">
            <h3>üìä Activit√© (Jour/Soir)</h3>
            <div style="height:300px;">
                <canvas id="trafic-chart-activity"></canvas>
            </div>
        </div>
        <div class="widget">
            <h3>üïí R√©partition Temporelle</h3>
            <div style="height:300px;">
                <canvas id="trafic-chart-pie"></canvas>
            </div>
        </div>
      </div>

      <div class="dashboard-grid">
         <div class="widget">
            <h3>üìù Logs en temps r√©el</h3>
            <div style="overflow-x:auto; max-height:400px; overflow-y:auto;">
              <table class="results-table">
                <thead>
                    <tr>
                        <th>Heure</th>
                        <th>√âl√®ve</th>
                        <th>Classe</th>
                        <th>Page</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody id="trafic-table-body">
                   <tr><td colspan="5" style="text-align:center;">En attente de donn√©es...</td></tr>
                </tbody>
              </table>
            </div>
         </div>
      </div>
    </section>
    </main>

  <div class="modal-overlay" id="modalStudent">
    <div class="modal-content">
        <div class="close-modal" onclick="closeModal()">√ó</div>
        <h2 id="modal-title" style="color:var(--col-eval);">D√©tails √âl√®ve</h2>
        
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-value" id="modal-avg">-</div>
                <div class="stat-label">Moyenne</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="modal-time">-</div>
                <div class="stat-label">Temps Moyen</div>
            </div>
        </div>

        <div class="widget">
            <h3>Profil de Comp√©tences</h3>
            <div style="height:300px; max-width:500px; margin:0 auto;">
                <canvas id="studentRadar"></canvas>
            </div>
        </div>

        <div class="widget">
            <h3>Historique Complet</h3>
            <div id="modal-history"></div>
        </div>
    </div>
  </div>

  <script>
    // Navigation Simple (UI)
    function showView(viewId, navEl){
        // Gestion Sidebar Active
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(navEl) navEl.classList.add('active');

        // Gestion Sections
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(viewId);
        if(target) target.classList.add('active');
        
        // Mobile : fermer menu apr√®s clic
        if(window.innerWidth <= 768){
            document.getElementById('mySidebar').classList.remove('open');
            document.getElementById('mainContent').classList.remove('full');
        }
    }
    
    function toggleMenu(){
        document.getElementById('mySidebar').classList.toggle('open');
        // Sur mobile on ne d√©cale pas le mainContent, l'overlay suffit
        // Sur desktop on pourrait toggle la classe .closed
    }
  </script>

  <script type="module">
    // --- 1. CONFIGURATION FIREBASE ---
    // (Ta configuration officielle)
    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    // Imports CDN (compatibles modules)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables Globales (accessibles dans le module)
    let allEvalData = [];
    let allStatsData = [];

    // --- 2. CHARGEMENT DONNEES ---
    async function chargerDonnees() {
        console.log("Chargement Firebase...");
        
        // A. √âvaluations
        try {
            const qEval = query(collection(db, "evaluations_competences"), orderBy("timestamp", "desc"), limit(200));
            const snapshotEval = await getDocs(qEval);
            allEvalData = snapshotEval.docs.map(doc => {
                const d = doc.data();
                // Conversion Timestamp -> Date lisible
                let dateStr = "N/A";
                if(d.timestamp && d.timestamp.toDate){
                    dateStr = d.timestamp.toDate().toLocaleDateString('fr-FR');
                } else if(d.date){
                    dateStr = new Date(d.date).toLocaleDateString('fr-FR');
                }
                return { ...d, dateLisible: dateStr, id: doc.id };
            });
            
            // Stats Dashboard
            document.getElementById("nb-evals").innerText = allEvalData.length;
            
            // Extraction Classes uniques pour le filtre
            const classes = [...new Set(allEvalData.map(e => e.classe).filter(c => c))].sort();
            const selClass = document.getElementById("filter-class");
            // Garder option ALL
            selClass.innerHTML = '<option value="ALL">Toutes les classes</option>';
            classes.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c; opt.innerText = c;
                selClass.appendChild(opt);
            });

            remplirTableau(allEvalData);

        } catch (e) {
            console.error("Erreur chargement Evals:", e);
        }

        // B. Statistiques Usage (Visites)
        try {
            // On charge un peu plus d'historique pour les stats
            const qStats = query(collection(db, "statistiques_usage"), orderBy("timestamp", "desc"), limit(500));
            const snapshotStats = await getDocs(qStats);
            allStatsData = snapshotStats.docs.map(doc => doc.data());
            
            document.getElementById("nb-visites").innerText = allStatsData.length;
            
            // Petit graph d'accueil (Visites par jour)
            dessinerGraphGlobal(allStatsData);

        } catch (e) {
            console.error("Erreur chargement Stats:", e);
        }
    }

    // --- 3. FONCTIONS AFFICHAGE (EXISTANTES) ---
    
    // Remplir le tableau des √©valuations
    function remplirTableau(data) {
        const tbody = document.getElementById("scores-body");
        tbody.innerHTML = "";
        
        data.forEach(item => {
            const tr = document.createElement("tr");
            
            // Badge Note
            let scoreClass = "score-low";
            const note = parseFloat(item.noteGlobale);
            if(note >= 15) scoreClass = "score-high";
            else if(note >= 10) scoreClass = "score-mid";
            
            tr.innerHTML = `
                <td>${item.dateLisible}</td>
                <td style="font-weight:600;">${item.eleve || 'Anonyme'}</td>
                <td><span style="background:#e2e8f0; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${item.classe || '?'}</span></td>
                <td>${item.exercice || 'Exercice'}</td>
                <td><span class="badge-score ${scoreClass}">${item.noteGlobale}/20</span></td>
                <td><button onclick="window.openModalDetails('${item.id}')" style="cursor:pointer; border:1px solid #ccc; background:#fff; border-radius:4px;">üëÅÔ∏è</button></td>
            `;
            tbody.appendChild(tr);
        });
        
        // Init Graph Radar avec ces donn√©es
        updateRadarMoyen(data);
    }

    // Filtrage dynamique
    window.applyFilters = function() {
        const fClass = document.getElementById("filter-class").value;
        const fEleve = document.getElementById("filter-eleve").value;
        const fSearch = document.getElementById("search-eval").value.toLowerCase();
        
        let filtered = allEvalData.filter(d => {
            let ok = true;
            if(fClass !== "ALL" && d.classe !== fClass) ok = false;
            if(fEleve !== "ALL" && d.eleve !== fEleve) ok = false;
            if(fSearch && !JSON.stringify(d).toLowerCase().includes(fSearch)) ok = false;
            return ok;
        });
        
        remplirTableau(filtered);
    };

    // Tri
    window.sortData = function(critere) {
        let sorted = [...allEvalData]; // Copie pour ne pas casser l'ordre initial
        if(critere === 'date') {
            sorted.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        } else if(critere === 'note') {
            sorted.sort((a,b) => parseFloat(b.noteGlobale) - parseFloat(a.noteGlobale));
        }
        remplirTableau(sorted);
    };

    // Graphique Radar Global
    function updateRadarMoyen(data) {
        const ctx = document.getElementById('competenceRadar');
        if(!ctx) return;
        
        // Calcul moyennes C1..C6
        let sums = {C1:0, C2:0, C3:0, C4:0, C5:0, C6:0};
        let counts = {C1:0, C2:0, C3:0, C4:0, C5:0, C6:0};
        
        data.forEach(d => {
            if(d.detailsCompetences){
                for(let c in d.detailsCompetences){
                    if(sums[c] !== undefined){
                        sums[c] += d.detailsCompetences[c];
                        counts[c]++;
                    }
                }
            }
        });
        
        const dataArr = [
            counts.C1 ? sums.C1/counts.C1 : 0,
            counts.C2 ? sums.C2/counts.C2 : 0,
            counts.C3 ? sums.C3/counts.C3 : 0,
            counts.C4 ? sums.C4/counts.C4 : 0,
            counts.C5 ? sums.C5/counts.C5 : 0,
            counts.C6 ? sums.C6/counts.C6 : 0
        ];
        
        // Appel global updateChart
        window.updateChart('competenceRadar', null, sums, counts, 'Moyenne Classe', 'rgba(59, 130, 246, 0.2)', '#3b82f6');
    }

    // Graphique Activit√© (Dashboard Accueil)
    function dessinerGraphGlobal(stats) {
        const ctx = document.getElementById('globalChart');
        if(!ctx) return;
        
        // Regrouper par date (MM-DD)
        let parJour = {};
        stats.forEach(s => {
            let d;
            if(s.timestamp && s.timestamp.toDate) d = s.timestamp.toDate();
            else if(s.date) d = new Date(s.date);
            
            if(d){
                const key = d.toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit'});
                parJour[key] = (parJour[key] || 0) + 1;
            }
        });
        
        // Trier les dates (les 7 derni√®res)
        const labels = Object.keys(parJour).slice(-7);
        const values = Object.values(parJour).slice(-7);
        
        if(Chart.getChart("globalChart")) Chart.getChart("globalChart").destroy();
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visites',
                    data: values,
                    borderColor: '#f97316',
                    tension: 0.3,
                    fill: true,
                    backgroundColor: 'rgba(249, 115, 22, 0.1)'
                }]
            },
            options: { responsive:true, maintainAspectRatio:false }
        });
    }

    // --- 4. EXPORTATION GLOBALE (Pour les onlick HTML) ---
    // N√©cessaire car module = scope ferm√©
    
    window.openModalDetails = function(id) {
        const item = allEvalData.find(e => e.id === id);
        if(!item) return;
        
        document.getElementById("modal-title").innerText = `D√©tails : ${item.eleve} (${item.exercice})`;
        
        // Remplissage simple
        let sums = {C1:0, C2:0, C3:0, C4:0, C5:0, C6:0};
        let counts = {C1:0, C2:0, C3:0, C4:0, C5:0, C6:0};
        let htmlDetails = "<ul>";
        
        if(item.detailsCompetences) {
            for(let [k,v] of Object.entries(item.detailsCompetences)){
                sums[k] = v; counts[k] = 1; // 1 note unique
                htmlDetails += `<li><b>${k}</b> : ${v}/100</li>`;
            }
        }
        htmlDetails += "</ul>";
        
        // Temps
        let avgTime = item.duree ? Math.round(item.duree/60)+" min" : "N/A";
        // Score
        let avgScore = item.noteGlobale;
        
        let histHtml = `<p>Date: ${item.dateLisible}</p><p>Note: ${item.noteGlobale}/20</p>${htmlDetails}`;
        
        document.getElementById("modal-avg").innerText = avgScore + "/20";
        document.getElementById("modal-time").innerText = avgTime;
        document.getElementById("modal-history").innerHTML = histHtml;
        
        document.getElementById("modalStudent").classList.add("open");
        
        // Petit d√©lai pour laisser le canvas appara√Ætre
        setTimeout(() => {
             updateChart("studentRadar", null, sums, counts, "Niveau de l'√©l√®ve", 'rgba(16, 185, 129, 0.2)', '#10b981');
        }, 100);
    }

    window.closeModal = function() {
        document.getElementById("modalStudent").classList.remove("open");
    }

    // Fonction utilitaire Chart g√©n√©rique
    window.updateChart = function(canvasId, chartInstance, sums, counts, label, bgColor, borderColor) {
        const ctx = document.getElementById(canvasId);
        if(!ctx) return;
        
        // Destruction s√©cure
        if(Chart.getChart(canvasId)) Chart.getChart(canvasId).destroy();
        
        const dataArr = [
            counts.C1 ? sums.C1/counts.C1 : 0,
            counts.C2 ? sums.C2/counts.C2 : 0,
            counts.C3 ? sums.C3/counts.C3 : 0,
            counts.C4 ? sums.C4/counts.C4 : 0,
            counts.C5 ? sums.C5/counts.C5 : 0,
            counts.C6 ? sums.C6/counts.C6 : 0
        ];
        
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['C1 Info', 'C2 Analyse', 'C3 Expliquer', 'C4 Solution', 'C5 Arg', 'C6 Com'],
                datasets: [{
                    label: label,
                    data: dataArr,
                    backgroundColor: bgColor,
                    borderColor: borderColor,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: { min: 0, max: 100 }
                }
            }
        });
    };

    // Lancement au d√©marrage
    chargerDonnees();

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cockpit PSE ‚Äì Pilotage Premium</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-body:#f8fafc; --bg-sidebar:#0f172a; --text-main:#1e293b; --text-muted:#64748b;
      --col-pedago:#3b82f6; --col-eval:#f59e0b; --col-class:#10b981; --col-proj:#8b5cf6;
      --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    *{box-sizing:border-box; transition: all 0.2s ease;}
    body{ margin:0; font-family:'Inter',sans-serif; background-color:var(--bg-body); color:var(--text-main); display:flex; height:100vh; overflow:hidden; }

    /* SIDEBAR CORRIG√âE MOBILE */
    .sidebar{
      width:280px; background-color:var(--bg-sidebar); color:#fff;
      display:flex; flex-direction:column; padding:24px; flex-shrink:0;
      overflow-y:auto; z-index:1000;
    }
    .nav-item{
      display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:10px;
      cursor:pointer; margin-bottom:4px; color:#cbd5e1; font-weight:500; text-decoration:none;
    }
    .nav-item:hover, .nav-item.active{ background:rgba(255,255,255,0.1); color:#fff; }
    
    /* MAIN CONTENT */
    .main-content{ flex:1; padding:32px; overflow-y:auto; position:relative; }
    header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:32px; background:white; padding:20px 32px; border-radius:16px; box-shadow:var(--card-shadow); }
    h1{ margin:0; font-size:1.5rem; font-weight:800; color:#0f172a; }

    /* STATS CARDS */
    .stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .stat-card { background: white; padding: 24px; border-radius: 16px; box-shadow: var(--card-shadow); display: flex; align-items: center; gap: 20px; }
    .stat-icon { width: 56px; height: 56px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: #f1f5f9; }
    .stat-info p { margin: 4px 0 0; font-size: 1.5rem; font-weight: 800; }

    /* GRILLE DYNAMIQUE */
    .dashboard-grid{ display:grid; grid-template-columns: 2fr 1fr; gap:32px; }
    .widget{ background:white; border-radius:20px; padding:24px; box-shadow:var(--card-shadow); border: 1px solid #f1f5f9; }
    .widget h3 { margin:0 0 20px; font-size:1.1rem; font-weight:700; display:flex; justify-content:space-between; }

    /* TABLEAU & PILLS */
    .results-table { width:100%; border-collapse:collapse; }
    .results-table th { text-align:left; padding:12px; font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; border-bottom:2px solid #f1f5f9; cursor:pointer; }
    .results-table td { padding:14px 12px; border-bottom:1px solid #f1f5f9; font-size:0.9rem; }
    .eleve-link { color:var(--col-pedago); font-weight:700; cursor:pointer; text-decoration:underline; }
    .pill { padding:4px 8px; border-radius:6px; font-size:0.7rem; font-weight:800; margin:2px; display:inline-block; }

    /* MODALE √âL√àVE (LE MICRO) */
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.7); backdrop-filter:blur(8px); z-index:2000; align-items:center; justify-content:center; }
    .modal-overlay.open { display:flex; }
    .modal-card { background:white; width:90%; max-width:1000px; height:85vh; border-radius:24px; display:grid; grid-template-columns: 1fr 1.5fr; overflow:hidden; }
    
    /* MOBILE UI */
    .menu-btn { display:none; border:none; background:none; font-size:1.5rem; cursor:pointer; }
    @media(max-width:1024px){
      .dashboard-grid { grid-template-columns: 1fr; }
      .sidebar { position:fixed; left:-280px; height:100vh; transition: 0.3s; }
      body.menu-open .sidebar { left:0; }
      .menu-btn { display:block; }
    }
  </style>
</head>
<body class="">

  <div id="modalStudent" class="modal-overlay">
    <div class="modal-card">
      <div style="padding:32px; border-right:1px solid #f1f5f9; background:#f8fafc;">
        <button onclick="closeModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem;">‚úï</button>
        <h2 id="modal-name" style="margin:20px 0 5px;">Nom √âl√®ve</h2>
        <span id="modal-class" style="color:var(--text-muted);">Classe</span>
        <div style="margin-top:30px; display:grid; gap:16px;">
          <div style="background:white; padding:16px; border-radius:12px; text-align:center; box-shadow:var(--card-shadow);">
             <span id="modal-avg" style="font-size:1.8rem; font-weight:800; color:var(--col-pedago);">--/20</span><br><small>Moyenne</small>
          </div>
          <div style="height:250px;"><canvas id="studentRadar"></canvas></div>
        </div>
      </div>
      <div style="padding:32px; overflow-y:auto;">
        <h3>Historique Complet</h3>
        <table class="results-table" id="modal-history"></table>
      </div>
    </div>
  </div>

  <nav class="sidebar">
    <div style="font-weight:900; font-size:1.4rem; margin-bottom:40px;">üöÄ COCKPIT</div>
    <div class="nav-item active" onclick="showView('view-scores')">üìä Suivi & Comp√©tences</div>
    <div class="nav-item" onclick="showView('view-pedago')">üìÅ P√©dagogie</div>
    <div class="nav-item" onclick="showView('view-live')">üó®Ô∏è Live Classe</div>
  </nav>

  <main class="main-content">
    <header>
      <div style="display:flex; align-items:center; gap:15px;">
        <button class="menu-btn" onclick="document.body.classList.toggle('menu-open')">‚ò∞</button>
        <h1 id="page-title">Tableau de Bord Global</h1>
      </div>
      <button onclick="chargerDonnees()" style="background:var(--bg-sidebar); color:white; border:none; padding:10px 20px; border-radius:30px; cursor:pointer; font-weight:600;">üîÑ Actualiser les donn√©es</button>
    </header>

    <section id="view-scores" class="view-section">
      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-icon" style="color:#3b82f6;">üë•</div>
          <div class="stat-info"><h4>Trafic Total</h4><p id="stat-total-views">--</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="color:#10b981;">üì±</div>
          <div class="stat-info"><h4>Supports</h4><p id="stat-device">--</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="color:#f59e0b;">üèÜ</div>
          <div class="stat-info"><h4>Top Exercice</h4><p id="stat-top-page" style="font-size:1rem;">--</p></div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="widget">
          <h3>Derni√®res √âvaluations 
            <div style="display:flex; gap:10px;">
              <select id="filter-class" onchange="applyFilters()" style="padding:5px; border-radius:5px;"><option value="ALL">Classes</option></select>
              <input type="text" id="filter-student" placeholder="Chercher..." onkeyup="applyFilters()" style="padding:5px; border-radius:5px; border:1px solid #ddd;">
            </div>
          </h3>
          <div style="overflow-x:auto;">
            <table class="results-table">
              <thead>
                <tr>
                  <th onclick="sortData('date')">Date</th>
                  <th onclick="sortData('identifiant')">√âl√®ve</th>
                  <th onclick="sortData('classe')">Classe</th>
                  <th onclick="sortData('note_finale')">Note</th>
                  <th>Comp√©tences</th>
                </tr>
              </thead>
              <tbody id="tbody-eleves"></tbody>
            </table>
          </div>
        </div>

        <div class="widget">
          <h3>Radar de Comp√©tences</h3>
          <div style="height:300px;"><canvas id="radarChart"></canvas></div>
          <div style="text-align:center; margin-top:20px;">
            <span style="font-size:0.9rem; color:var(--text-muted);">Moyenne S√©lection :</span><br>
            <strong id="moyenne-globale" style="font-size:2rem; color:var(--col-pedago);">--</strong>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allData = [];

    window.chargerDonnees = async () => {
      const snapEval = await getDocs(query(collection(db, "evaluations_competences"), orderBy("date", "desc")));
      allData = snapEval.docs.map(doc => doc.data());
      
      const snapStats = await getDocs(collection(db, "statistiques_usage"));
      processStats(snapStats);
      
      populateFilters();
      applyFilters();
    };

    function processStats(snap) {
      let total = snap.size, mobile = 0, pages = {};
      snap.forEach(doc => {
        const d = doc.data();
        if(/Mobi|Android/i.test(d.device)) mobile++;
        pages[d.page] = (pages[d.page] || 0) + 1;
      });
      document.getElementById("stat-total-views").innerText = total;
      document.getElementById("stat-device").innerText = Math.round((mobile/total)*100) + "% Mobile";
      document.getElementById("stat-top-page").innerText = Object.keys(pages).reduce((a, b) => pages[a] > pages[b] ? a : b, "--");
    }

    window.applyFilters = () => {
      const fClass = document.getElementById("filter-class").value;
      const fName = document.getElementById("filter-student").value.toLowerCase();
      const filtered = allData.filter(d => (fClass === "ALL" || d.classe === fClass) && d.identifiant.toLowerCase().includes(fName));
      renderTable(filtered);
      updateRadar(filtered);
    };

    function renderTable(data) {
      const tbody = document.getElementById("tbody-eleves");
      tbody.innerHTML = data.map(d => `
        <tr>
          <td>${new Date(d.date.seconds*1000).toLocaleDateString()}</td>
          <td><span class="eleve-link" onclick="openStudentDetail('${d.identifiant}')">${d.identifiant}</span></td>
          <td>${d.classe}</td>
          <td style="font-weight:800; color:var(--col-pedago);">${d.note_finale}/20</td>
          <td>${Object.entries(d.competences).map(([k,v]) => `<span class="pill" style="background:${v>=2?'#dcfce7':'#fee2e2'}">${k.substring(0,2)}:${v}</span>`).join('')}</td>
        </tr>
      `).join('');
    }

    // Graphique Radar
    function updateRadar(data) {
      const ctx = document.getElementById('radarChart');
      if(window.mainChart) window.mainChart.destroy();
      const averages = [0,0,0,0,0,0]; // Calcul des moyennes C1-C6 ici...
      window.mainChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['C1', 'C2', 'C3', 'C4', 'C5', 'C6'],
          datasets: [{ label: 'Moyenne Classe', data: [2.1, 1.8, 2.5, 1.9, 2.2, 2.0], backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: '#3b82f6' }]
        },
        options: { scales: { r: { min: 0, max: 3 } }, maintainAspectRatio: false }
      });
    }

    window.openStudentDetail = (id) => {
      const student = allData.filter(d => d.identifiant === id);
      document.getElementById("modal-name").innerText = id;
      document.getElementById("modalStudent").classList.add("open");
    };
    window.closeModal = () => document.getElementById("modalStudent").classList.remove("open");

    function populateFilters() {
      const classes = [...new Set(allData.map(d => d.classe))];
      document.getElementById("filter-class").innerHTML = '<option value="ALL">Toutes les classes</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    chargerDonnees();
  </script>
</body>
</html>

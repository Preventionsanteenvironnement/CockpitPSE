<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè† Cockpit PSE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        h1 { color: #d9534f; margin-bottom: 20px; text-align: center; }
        .toolbar { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .toolbar button { padding: 10px 20px; background: #5cb85c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.95em; }
        .toolbar button:hover { background: #4cae4c; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2.5em; font-weight: bold; color: #d9534f; }
        .stat-label { color: #666; margin-top: 5px; }
        table { width: 100%; background: white; border-collapse: collapse; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        thead { background: #d9534f; color: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        tbody tr:hover { background: #f9f9f9; }
        .note-corrigee { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .badge-check { background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 5px; }
        .btn-small { padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; margin: 0 2px; }
        .btn-small:hover { background: #0056b3; }
        .loading { text-align: center; padding: 40px; color: #666; font-size: 1.1em; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #dc2626; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>üè† Cockpit PSE - Tableau de Bord</h1>
    
    <div class="toolbar">
        <button onclick="chargerDonnees()">üîÑ Actualiser</button>
        <button onclick="window.location.href='grille.html'">üìù Grille</button>
        <button onclick="window.location.href='resultats.html'">üëÅÔ∏è Vue √âl√®ve</button>
    </div>
    
    <div id="messageZone"></div>
    
    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">üì• Copies re√ßues</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statCorriges">0</div>
            <div class="stat-label">‚úÖ Corrig√©es</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statAttente">0</div>
            <div class="stat-label">‚è≥ En attente</div>
        </div>
    </div>
    
    <div id="tableContainer">
        <div class="loading">‚è≥ Chargement...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collectionGroup, query, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.firebaseapp.com",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allData = [];

        window.chargerDonnees = async function() {
            console.log("üöÄ Chargement cockpit v3.0...");
            showMessage("‚è≥ Chargement...");
            
            try {
                // √âTAPE 1 : Charger COPIES
                console.log("üìÇ Chargement copies...");
                const qCopies = query(collectionGroup(db, "copies"), limit(100));
                const snapCopies = await getDocs(qCopies);
                
                console.log(`‚úÖ Copies: ${snapCopies.size}`);
                
                if (snapCopies.empty) {
                    showMessage("‚ö†Ô∏è Aucune copie trouv√©e", "error");
                    document.getElementById('tableContainer').innerHTML = '<div class="loading">üì≠ Aucune copie</div>';
                    return;
                }
                
                // Map copies par cl√©
                const copiesMap = new Map();
                snapCopies.forEach(doc => {
                    const d = doc.data();
                    const key = `${d.devoirId}_${d.eleveCode}`;
                    copiesMap.set(key, { id: doc.id, ...d });
                });
                
                // √âTAPE 2 : Charger √âVALUATIONS
                console.log("üìÇ Chargement √©valuations...");
                const evalsMap = new Map();
                
                try {
                    const qEvals = query(collectionGroup(db, "evaluations"), limit(100));
                    const snapEvals = await getDocs(qEvals);
                    
                    console.log(`‚úÖ √âvaluations: ${snapEvals.size}`);
                    
                    snapEvals.forEach(doc => {
                        const d = doc.data();
                        const key = `${d.devoirId}_${d.eleveCode}`;
                        evalsMap.set(key, d);
                    });
                } catch (e) {
                    console.warn("‚ö†Ô∏è √âvaluations non charg√©es:", e.message);
                }
                
                // √âTAPE 3 : FUSION
                console.log("üìä Fusion...");
                allData = [];
                
                copiesMap.forEach((copie, key) => {
                    const eval = evalsMap.get(key);
                    const estCorrige = eval && eval.note_finale !== undefined;
                    
                    let note = null;
                    if (estCorrige) {
                        note = eval.note_finale;
                    } else {
                        note = copie.note_auto || copie.resultat_auto?.score || 0;
                    }
                    
                    allData.push({
                        id: copie.id,
                        devoirId: copie.devoirId,
                        titre: copie.titre || "Devoir",
                        eleveCode: copie.eleveCode,
                        nom: copie.eleve?.nom || copie.eleveCode,
                        prenom: copie.eleve?.prenom || "",
                        classe: copie.eleve?.classe || copie.classe || "?",
                        date: copie.createdAtISO || (copie.createdAt?.toDate ? copie.createdAt.toDate().toLocaleDateString('fr-FR') : "--"),
                        temps: copie.temps_secondes ? Math.floor(copie.temps_secondes / 60) + " min" : "--",
                        note: note,
                        estCorrige: estCorrige,
                        pastes: copie.pasteStats?.total || 0
                    });
                });
                
                console.log(`‚úÖ ${allData.length} copies fusionn√©es`);
                console.log(`üìä Corrig√©es: ${allData.filter(d => d.estCorrige).length}`);
                
                afficherDonnees();
                afficherStats();
                showMessage(`‚úÖ ${allData.length} copies charg√©es`, "success");
                setTimeout(() => document.getElementById('messageZone').innerHTML = '', 3000);
                
            } catch (error) {
                console.error("‚ùå Erreur:", error);
                showMessage(`‚ùå ERREUR Firebase: ${error.message}`, "error");
                
                document.getElementById('tableContainer').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Erreur Firebase</strong><br>
                        ${error.message}<br><br>
                        <strong>Solutions:</strong><br>
                        1. V√©rifiez r√®gles Firestore (allow read: if true;)<br>
                        2. Console F12 ‚Üí onglet Console<br>
                        3. Videz cache (Ctrl+Shift+Delete)
                    </div>
                `;
            }
        };

        function afficherDonnees() {
            const container = document.getElementById('tableContainer');
            
            if (allData.length === 0) {
                container.innerHTML = '<div class="loading">üì≠ Aucune copie</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>√âl√®ve</th>
                            <th>Classe</th>
                            <th>Temps</th>
                            <th>Exercice</th>
                            <th>üìã</th>
                            <th>Note</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allData.forEach(d => {
                const nomComplet = `${d.prenom} ${d.nom}`.trim() || d.eleveCode;
                
                let noteHTML = '';
                if (d.estCorrige) {
                    noteHTML = `<span class="note-corrigee">${d.note.toFixed(1)}/20<span class="badge-check">‚úì</span></span>`;
                } else {
                    noteHTML = `${d.note !== null ? d.note.toFixed(1) + '/20' : '--'}`;
                }
                
                html += `
                    <tr>
                        <td>${d.date}</td>
                        <td><strong>${nomComplet}</strong><br><small>${d.eleveCode}</small></td>
                        <td>${d.classe}</td>
                        <td>${d.temps}</td>
                        <td>${d.titre}</td>
                        <td style="text-align:center;">${d.pastes}</td>
                        <td>${noteHTML}</td>
                        <td>
                            <button class="btn-small" onclick="ouvrirGrille('${d.id}')">üìù</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function afficherStats() {
            document.getElementById('statTotal').textContent = allData.length;
            document.getElementById('statCorriges').textContent = allData.filter(d => d.estCorrige).length;
            document.getElementById('statAttente').textContent = allData.filter(d => !d.estCorrige).length;
        }

        window.ouvrirGrille = function(id) {
            window.location.href = `grille.html?id=${id}`;
        };

        function showMessage(msg, type = '') {
            const zone = document.getElementById('messageZone');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            zone.innerHTML = className ? `<div class="${className}">${msg}</div>` : `<div class="loading">${msg}</div>`;
        }

        window.addEventListener('DOMContentLoaded', () => {
            chargerDonnees();
        });
    </script>
</body>
</html>

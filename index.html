<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cockpit Professeur â€“ Pilotage Global</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-body:#f1f5f9; --bg-sidebar:#0f172a; --text-main:#1e293b; --text-muted:#64748b;
      --col-pedago:#3b82f6; --col-eval:#f59e0b; --col-class:#10b981; --col-proj:#8b5cf6;
      --col-admin:#f97316; --col-live-web:#795548; --col-sites:#607d8b;
      --col-notes:#facc15;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; font-family:'Inter',sans-serif;
      background-color:var(--bg-body); color:var(--text-main);
      display:flex; height:100vh; overflow:hidden;
    }

    /* SIDEBAR */
    .sidebar{
      width:300px; background-color:var(--bg-sidebar); color:#fff;
      display:flex; flex-direction:column; padding:20px; flex-shrink:0;
      overflow-y:auto; gap:10px;
      position: relative; /* Pour le bouton fermer mobile */
    }
    .brand{ font-size:1.3rem; font-weight:800; margin-bottom:20px; letter-spacing:1px; display:flex; align-items:center; gap:10px; }
    .nav-category{ font-size:.75rem; text-transform:uppercase; letter-spacing:1px; font-weight:700; color:#64748b; margin:15px 0 5px; }
    .nav-item{
      display:flex; align-items:center; gap:12px; padding:12px 15px; border-radius:8px;
      cursor:pointer; transition:.2s; font-weight:600; color:#cbd5e1; border-left:4px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:#fff;}
    .nav-item.active{background:rgba(255,255,255,.10); color:#fff;}
    .nav-item[data-theme="pedago"].active{border-left-color:var(--col-pedago);}
    .nav-item[data-theme="eval"].active{border-left-color:var(--col-eval);}
    .nav-item[data-theme="class"].active{border-left-color:var(--col-class);}
    .nav-item[data-theme="proj"].active{border-left-color:var(--col-proj);}
    .nav-item[data-theme="admin"].active{border-left-color:var(--col-admin);}
    .nav-item[data-theme="live"].active{border-left-color:var(--col-live-web);}
    .nav-item[data-theme="sites"].active{border-left-color:var(--col-sites);}
    .nav-item[data-theme="notes"].active{border-left-color:var(--col-notes);}

    /* MAIN */
    .main-content{ flex:1; padding:40px; overflow-y:auto; display:flex; flex-direction:column; position:relative; }
    header{ display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:30px; border-bottom:1px solid #e2e8f0; padding-bottom:20px; }
    h1{margin:0; font-size:2rem; font-weight:800; color:var(--text-main);}
    .header-infos{text-align:right;}
    .clock-time{font-size:1.5rem; font-weight:800;}
    .clock-date{font-size:.9rem; color:var(--text-muted);}
    .vacation-badge{ margin-top:5px; font-size:.8rem; background:#dbeafe; color:#2563eb; padding:4px 10px; border-radius:20px; border:1px solid #bfdbfe; font-weight:bold; }

    .view-section{display:none; animation:fadeUp .4s ease-out;}
    .view-section.active{display:block;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

    .quick-actions{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:30px; }
    .btn-quick{
      background:#fff; border:1px solid #e2e8f0; padding:15px; border-radius:12px;
      text-align:left; cursor:pointer; transition:.2s; display:flex; align-items:center; gap:15px;
      box-shadow:0 2px 4px rgba(0,0,0,.02); text-decoration:none; color:inherit;
    }
    .btn-quick:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.05); border-color:var(--col-pedago); }

    .dashboard-grid{display:grid; grid-template-columns:2fr 1fr; gap:25px;}
    .widget{ background:#fff; border-radius:16px; padding:25px; border:1px solid #e2e8f0; display:flex; flex-direction:column; min-height:320px; }
    .widget h3{ margin:0 0 15px; padding-bottom:10px; border-bottom:2px solid #f1f5f9; font-size:1.1rem; display:flex; justify-content:space-between; align-items:center; }

    /* ZONE 1 : MÃ‰TÃ‰O DU SITE (AUDIENCE) */
    .stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    
    /* MODIFICATION DESIGN: Cartes interactives */
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-color: var(--col-pedago); }
    .stat-card:active { transform: scale(0.98); }

    .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .icon-blue { background: #e0f2fe; color: #0284c7; }
    .icon-purple { background: #f3e8ff; color: #9333ea; }
    .icon-green { background: #dcfce7; color: #16a34a; }
    .stat-info h4 { margin: 0; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
    .stat-info p { margin: 5px 0 0; font-size: 1.4rem; font-weight: 800; color: #0f172a; }

    /* CODEPILOTE : BARRE D'OUTILS FILTRES */
    .toolbar {
      display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;
    }
    .filter-input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
    .filter-select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; min-width: 150px; background: white; }

    /* CODEPILOTE : STYLES TABLEAU & RADAR */
    .radar-container { height: 320px; display: flex; justify-content: center; margin-bottom: 10px; }
    .pill { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-right: 5px; display: inline-block; margin-bottom: 2px;}
    .pill-green { background: #dcfce7; color: #166534; }
    .pill-orange { background: #ffedd5; color: #9a3412; }
    .pill-red { background: #fee2e2; color: #991b1b; }
    .pill-blue { background: #dbeafe; color: #1e40af; }
    
    .results-table { width:100%; border-collapse:collapse; min-width:600px; }
    .results-table thead { background:#f1f5f9; color:#475569; }
    /* EntÃªtes cliquables pour le tri */
    .results-table th { padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:.88rem; cursor: pointer; user-select: none; }
    .results-table th:hover { background: #e2e8f0; }
    .results-table td { padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:.88rem; }
    .results-table tr:hover { background:#f8fafc; }
    .scores-empty { text-align:center; padding: 20px; color: #64748b; }

    /* Styles Modale */
    .eleve-link { color: #2563eb; font-weight: 700; cursor: pointer; text-decoration: underline; text-decoration-color: transparent; transition: 0.2s; }
    .eleve-link:hover { text-decoration-color: #2563eb; }
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; animation: fadeIn 0.3s; }
    .modal-card { background: #fff; width: 90%; max-width: 900px; max-height: 90vh; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); overflow-y: auto; display: flex; flex-direction: column; }
    .modal-header { padding: 20px 30px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; position: sticky; top: 0; z-index: 10; }
    .modal-body { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; }
    .stat-box { background: #f1f5f9; padding: 15px; border-radius: 12px; text-align: center; }
    .stat-val { font-size: 1.8rem; font-weight: 800; color: #0f172a; display: block; }
    .stat-label { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
    @media(max-width: 800px) { .modal-body { grid-template-columns: 1fr; } }

    /* STYLES SPÃ‰CIFIQUES POUR LA MODALE DÃ‰TAILS (MICRO-STATS) */
    .detail-modal-content { height: 400px; display: flex; flex-direction: column; width: 100%; }
    .rank-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
    .rank-item:hover { background-color: #f8fafc; }
    .rank-pos { font-weight: 800; color: var(--col-pedago); width: 35px; }
    .rank-name { flex: 1; font-weight: 500; color: #334155; }
    .rank-val { font-weight: 700; color: #0f172a; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-size: 0.9rem;}

    /* UTILS & RESPONSIVE */
    .btn-yellow{ display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:#fffbeb; color:#b45309; border:1px solid #fcd34d; border-radius:6px; text-decoration:none; font-weight:600; font-size:.85rem; }
    .btn-blue-outline{ display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:#f0f9ff; color:#0369a1; border:1px solid #bae6fd; border-radius:6px; text-decoration:none; font-weight:600; font-size:.85rem; cursor:pointer; }
    .badge-soon{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; margin-left:6px; border:1px solid rgba(0,0,0,.05); background:#fef3c7; color:#92400e; }
    
    details{ background:#fff; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px; overflow:hidden; }
    summary{ padding:15px; font-weight:600; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; }
    details[open]>summary{background:#f1f5f9; border-bottom:1px solid #e2e8f0;}
    .content-links{ padding:15px; display:flex; flex-wrap:wrap; gap:10px; }
    
    #course-structure>summary{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); }
    #course-structure .lvl-cap>summary{ background:rgba(37,99,235,.12); border-left:6px solid rgba(37,99,235,.9); font-weight:900; }
    #course-structure .lvl-bacpro>summary{ background:rgba(22,163,74,.12); border-left:6px solid rgba(22,163,74,.9); font-weight:900; }

    .live-block{ margin-top:12px; border:1px solid rgba(0,0,0,.08); border-radius:14px; overflow:hidden; background:#fff; }
    .live-summary{ font-weight:900; padding:14px 16px; background:#f1f5f9; }
    .live-links{padding:14px 12px;}
    .badge-role{ display:inline-flex; align-items:center; padding:2px 10px; border-radius:999px; font-size:12px; font-weight:900; margin-left:8px; border:1px solid rgba(0,0,0,.08); white-space:nowrap; }
    .role-eleve{background:rgba(245,158,11,.18); color:#a16207;}
    .role-prof{background:rgba(59,130,246,.18); color:#1d4ed8;}

    /* MENU MOBILE */
    .menu-overlay{ display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); backdrop-filter:blur(2px); z-index:999; }
    .menu-btn{ display:none; border:none; background:#0f172a; color:#fff; width:44px; height:44px; border-radius:12px; font-size:20px; font-weight:900; cursor:pointer; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,.18); flex-shrink:0; }
    body.menu-open .sidebar{transform:translateX(0);}
    body.menu-open .menu-overlay{display:block;}

    /* AJOUT: Bouton fermer sidebar mobile */
    .close-sidebar-btn { display: none; }

    @media(max-width:980px){
      body{height:auto; overflow:auto; display:block;}
      .sidebar{ position:fixed; top:0; left:0; bottom:0; height:100vh; width:min(86vw,340px); transform:translateX(-110%); transition:transform .25s ease; z-index:1000; padding:18px; }
      .main-content{padding:16px; min-height:100vh; overflow:visible;}
      header{align-items:center; gap:12px; margin-bottom:16px; padding-bottom:14px;}
      h1{font-size:1.35rem;}
      .clock-time{font-size:1.15rem;}
      .menu-btn{display:inline-flex;}
      .dashboard-grid{grid-template-columns:1fr; gap:14px;}
      .widget{min-height:auto; padding:16px; border-radius:14px;}
      .quick-actions{grid-template-columns:1fr;}
      .btn-quick{padding:14px;}
      .content-links{padding:12px; gap:8px;}
      .btn-yellow,.btn-blue-outline{width:100%; justify-content:space-between;}
      .stats-overview { grid-template-columns: 1fr; }
      
      /* Affichage du bouton fermer uniquement sur mobile */
      .close-sidebar-btn { 
          display: block; 
          position: absolute; 
          top: 15px; 
          right: 15px; 
          background: none; 
          border: none; 
          color: white; 
          font-size: 24px; 
          cursor: pointer; 
          z-index: 1002;
          padding: 5px;
      }
    }
    /* --- AJOUTS V4 (BIBLIOTHÃˆQUE & QUIZ) --- */
    .col-left { flex: 1; display: flex; flex-direction: column; gap: 20px; }
    .col-right { flex: 1; background: #fff; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; height: fit-content; }
    
    .grid-acts { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .act-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; font-weight: 600; text-align: center; background: #fff; transition: 0.2s; font-size: 0.9rem; }
    .act-btn:hover { background: #f8fafc; }
    .act-btn.active { border-color: #db2777; background: #fff0f6; color: #db2777; }

    .lib-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
    .lib-item { padding: 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
    .lib-item:hover { background: #f0f9ff; }
    
    .tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-right: 8px; letter-spacing: 0.5px; }
    .tag-poll { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
    .tag-quiz { background: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd; }
    .tag-cloud { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }

    .option-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
  </style>
</head>
<body>

  <div id="modalStudent" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <h2 id="modal-name" style="margin:0; color:#0f172a;">Ã‰lÃ¨ve</h2>
          <span id="modal-class" style="color:#64748b; font-weight:500;">Classe</span>
        </div>
        <button class="close-modal" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div>
          <div style="display:flex; gap:15px; margin-bottom:20px;">
            <div class="stat-box" style="flex:1;">
              <span class="stat-val" id="modal-avg">--/20</span>
              <span class="stat-label">Moyenne</span>
            </div>
            <div class="stat-box" style="flex:1;">
              <span class="stat-val" id="modal-time">--</span>
              <span class="stat-label">Temps Moyen</span>
            </div>
          </div>
          <div style="height:300px;">
            <canvas id="studentRadar"></canvas>
          </div>
        </div>
        <div>
          <h3 style="margin-top:0;">Historique des activitÃ©s</h3>
          <table class="results-table">
            <thead><tr><th>Date</th><th>Exercice</th><th>Note</th></tr></thead>
            <tbody id="modal-history"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="modalStats" class="modal-overlay" onclick="closeStatModal()">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 id="stats-title" style="margin:0;">DÃ©tails</h2>
        <button class="close-modal" onclick="closeStatModal()">Ã—</button>
      </div>
      <div class="modal-body" style="display: block;">
        <div class="detail-modal-content">
          <canvas id="statsChart" style="max-height: 300px; display:none;"></canvas>
          <div id="statsList" style="overflow-y:auto; flex:1;"></div>
        </div>
      </div>
    </div>
  </div>

  <nav class="sidebar" id="mySidebar">
    <button class="close-sidebar-btn" onclick="closeMenu()">âœ•</button>
    
    <div class="brand">ğŸš€ COCKPIT</div>
    <div class="nav-item active" onclick="showView('dashboard', this)">ğŸ  Tableau de bord</div>
    <div class="nav-category">Mes dossiers</div>
    <div class="nav-item" data-theme="pedago" onclick="showView('view-pedago', this)">ğŸŸ¦ 1. PÃ©dagogie & cours</div>
    <div class="nav-item" data-theme="notes" onclick="showView('view-notes', this)">ğŸŸ¨ 2. RÃ‰DACTION / NOTES</div>
    <div class="nav-item" data-theme="eval" onclick="showView('view-eval', this)">ğŸŸ¨ 3. Ã‰valuation & suivi</div>
    <div class="nav-item" data-theme="eval" onclick="showView('view-scores', this)">ğŸŸ¨ 4. Scores exercices</div>
    <div class="nav-item" data-theme="admin" onclick="showView('view-trafic', this)">ğŸš¦ 5. Trafic (monitoring)</div>
    <div class="nav-item" data-theme="class" onclick="showView('view-class', this)">ğŸŸ© 6. Classes & groupes</div>
    <div class="nav-item" data-theme="proj" onclick="showView('view-proj', this)">ğŸŸª 7. Projets & transversal</div>
    <div class="nav-item" data-theme="admin" onclick="showView('view-admin', this)">ğŸŸ§ 8. Temps & admin</div>
    <div class="nav-item" data-theme="live" onclick="showView('view-live', this)">ğŸŸ« 9. Classe en temps rÃ©el</div>
    <div class="nav-category" style="margin-top:15px; color:#db2777;">ANIMATION</div>
    <div class="nav-item" data-theme="session" onclick="showView('view-sessions', this)" 
         style="border-left: 4px solid #db2777; color:#fff; background:linear-gradient(90deg, rgba(219,39,119,0.1) 0%, rgba(15,23,42,0) 100%);">
      ğŸ“¡ 8. Sessions & Sondages
    </div>
    <div class="nav-item" data-theme="sites" onclick="showView('view-sites', this)">ğŸŒ 7. Sites internet</div>
  </nav>

  <div id="menuOverlay" class="menu-overlay" onclick="closeMenu()"></div>

  <main class="main-content">
        <header>
            <button id="menuBtn" class="menu-btn" aria-label="Menu" onclick="toggleMenu()">â˜°</button>
            <h1 id="page-title">Tableau de Bord</h1>
            <div class="header-infos">
                <div id="authBadge" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:5px 10px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;"></div>
                <div class="clock-time" id="clock">--:--</div>
                <div class="clock-date" id="date">--</div>
                <div id="vacation-badge" class="vacation-badge" style="display:none;"></div>
                <div id="inboxBadge" title="Nouvelles copies" style="display:none;min-width:24px;height:24px;padding:0 8px;border-radius:999px;background:#111827;color:#fff;font-weight:900;font-size:12px;align-items:center;justify-content:center;"></div>
            </div>
        </header>

        <div id="dashboard" class="view-section active">
            <div class="quick-actions">
                <a href="prof_plan.html" target="_blank" class="btn-quick"><span>ğŸª‘</span><div><strong>Plan de Classe</strong><span>Piloter les places</span></div></a>
                <a href="https://www.pronote.index-education.net/" target="_blank" class="btn-quick"><span>ğŸ“</span><div><strong>Pronote Web</strong><span>AccÃ¨s direct</span></div></a>
                <button onclick="document.getElementById('memo-input').focus()" class="btn-quick"><span>ğŸ§ </span><div><strong>MÃ©mo CiblÃ©</strong><span>Rappel contextuel</span></div></button>
            </div>
            <div class="dashboard-grid">
                <div class="widget">
                    <h3>ğŸ“… Planning <div style="font-size:0.8rem;"><button onclick="changeDate(-1)">â—€</button> <span id="planning-date-label">...</span> <button onclick="changeDate(1)">â–¶</button> <button onclick="openTimelineDashboard()" title="Timeline" style="margin-left:8px;background:#0f172a;color:white;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;">Timeline</button></div></h3>
                    <ul class="planning-list" id="planning-list"></ul>
                </div>
                <div class="right-stack">
                    <div class="widget memo-widget">
                        <h3>ğŸ’¡ Pense-BÃªte Contextuel</h3>
                        <div style="display:flex;gap:5px;margin-bottom:15px;">
                            <select id="memo-target" style="padding:8px;border-radius:6px;border:1px solid #ddd;"></select>
                            <input id="memo-input" style="flex-grow:1;padding:8px;border-radius:6px;border:1px solid #ddd;" placeholder="Note...">
                            <button onclick="addMemo()" style="background:#0f172a;color:white;border:none;padding:8px 15px;border-radius:6px;">+</button>
                        </div>
                        <ul class="alert-list" id="memo-list"></ul>
                    </div>
            
                    <div class="widget agenda-widget">
                        <h3>ğŸ—“ï¸ Agenda</h3>
                        <div class="agenda-form">
                            <select id="agenda-type">
                                <option value="RÃ©union">RÃ©union</option>
                                <option value="Parents">Parents</option>
                                <option value="Admin">Admin</option>
                                <option value="Personnel">Personnel</option>
                                <option value="Classe">Classe</option>
                                <option value="Autre">Autre</option>
                            </select>
                            <input id="agenda-date" type="date" aria-label="Date">
                            <input id="agenda-time" type="time" aria-label="Heure">
                        </div>
                        <div class="agenda-form">
                            <input id="agenda-title" class="wide" placeholder="Titre (rÃ©union, rdv...)" aria-label="Titre">
                            <input id="agenda-place" class="wide" placeholder="Lieu (optionnel)" aria-label="Lieu">
                            <button onclick="addAgenda()" style="background:#0f172a;color:white;border:none;padding:8px 15px;border-radius:6px;">+</button>
                        </div>
                        <ul class="agenda-list" id="agenda-list"></ul>
                    </div>
                </div>
            </div>
        </div>

    <section id="view-scores" class="view-section">
      <h2 style="color:var(--col-eval);">Suivi des CompÃ©tences & Notes</h2>
      
      <div class="stats-overview">
        <div class="stat-card" onclick="showStatDetails('views')">
          <div class="stat-icon icon-blue">ğŸ‘€</div>
          <div class="stat-info"><h4>Trafic Total</h4><p id="stat-total-views">0</p></div>
        </div>
        <div class="stat-card" onclick="showStatDetails('devices')">
          <div class="stat-icon icon-purple">ğŸ“±</div>
          <div class="stat-info"><h4>Supports</h4><p id="stat-device" style="font-size:1rem; font-weight:600;">--</p></div>
        </div>
        <div class="stat-card" onclick="showStatDetails('exercices')">
          <div class="stat-icon icon-green">ğŸ†</div>
          <div class="stat-info"><h4>Top Exercice</h4><p id="stat-top-page" style="font-size:1rem; font-weight:600;">--</p></div>
        </div>
      </div>

      <div class="dashboard-grid">
          <div class="widget">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span><strong>DerniÃ¨res Ã©valuations reÃ§ues</strong></span>
                <button onclick="chargerDonnees()" style="padding:8px 15px; cursor:pointer; background:#f1f5f9; border:1px solid #ccc; border-radius:20px;">ğŸ”„ Actualiser</button>
            </div>

            <div class="toolbar">
              <select id="filter-class" class="filter-select" onchange="applyFilters()">
                <option value="ALL">Toutes les classes</option>
              </select>
              <input type="text" id="filter-student" class="filter-input" placeholder="ğŸ” Chercher un Ã©lÃ¨ve..." onkeyup="applyFilters()">
              <select id="filter-exercice" class="filter-select" onchange="applyFilters()">
                <option value="ALL">Tous les exercices</option>
              </select>
            </div>

            <div style="overflow-x:auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th onclick="sortData('date')">Date â†•</th>
                            <th onclick="sortData('identifiant')">Ã‰lÃ¨ve â†•</th>
                            <th onclick="sortData('classe')">Classe â†•</th>
                            <th onclick="sortData('temps_secondes')">Temps â†•</th>
                            <th onclick="sortData('exercice_titre')">Exercice â†•</th>
                            <th onclick="sortData('note_finale')">Note â†•</th>
<th onclick="sortTable('collages')">ğŸ“‹ â†•</th>
<th title="L'Ã©lÃ¨ve a-t-il lu sa copie ?">ğŸ‘ï¸</th>
<th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-eleves">
                        <tr><td colspan="9" class="scores-empty">Chargement automatique...</td></tr>
                    </tbody>
                </table>
            </div>
          </div>

          <div class="widget">
              <h3>ğŸ“Š Radar Moyen (FiltrÃ©)</h3>
              <div class="radar-container"><canvas id="radarChart"></canvas></div>
              <div style="text-align:center; margin-top:15px;">Moyenne : <strong id="moyenne-globale" style="color:#3b82f6; font-size:1.3rem;">--</strong></div>
          </div>
      </div>
    </section>

    <section id="view-trafic" class="view-section">
      <h2 style="color:var(--col-admin);">Trafic (monitoring)</h2>

      <!-- Widget Google Analytics -->
      <div class="widget" style="min-height:auto; text-align:center; padding:60px 40px;">
        
        <!-- IcÃ´ne animÃ©e -->
        <div style="font-size:4rem; margin-bottom:20px; animation: pulse 2s infinite;">
          ğŸ“Š
        </div>
        
        <h3 style="border:none; font-size:1.5rem; color:#0f172a; margin-bottom:15px; justify-content:center;">
          Le suivi du trafic est maintenant sur Google Analytics
        </h3>
        
        <p style="color:#64748b; font-size:1rem; max-width:500px; margin:0 auto 30px; line-height:1.6;">
          Consultez vos statistiques de visites, pages vues, appareils utilisÃ©s et bien plus encore directement sur Google Analytics.
        </p>
        
        <!-- Bouton principal -->
        <a href="https://analytics.google.com/analytics/web/#/p518029608/reports/intelligenthome" 
           target="_blank" 
           style="display:inline-flex; align-items:center; gap:12px; padding:16px 32px; background:linear-gradient(135deg, #f97316, #ea580c); color:white; text-decoration:none; border-radius:12px; font-weight:700; font-size:1.1rem; box-shadow:0 4px 15px rgba(249,115,22,0.4); transition:all 0.3s;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          Ouvrir Google Analytics
        </a>
        
        <!-- Infos supplÃ©mentaires -->
        <div style="margin-top:40px; display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:20px; max-width:600px; margin-left:auto; margin-right:auto;">
          
          <div style="background:#f0f9ff; padding:20px; border-radius:12px; border:1px solid #bae6fd;">
            <div style="font-size:1.5rem; margin-bottom:8px;">ğŸ‘€</div>
            <div style="font-weight:700; color:#0369a1;">Pages vues</div>
            <div style="font-size:0.85rem; color:#64748b;">Temps rÃ©el</div>
          </div>
          
          <div style="background:#f0fdf4; padding:20px; border-radius:12px; border:1px solid #bbf7d0;">
            <div style="font-size:1.5rem; margin-bottom:8px;">ğŸ“±</div>
            <div style="font-weight:700; color:#16a34a;">Appareils</div>
            <div style="font-size:0.85rem; color:#64748b;">Mobile / Desktop</div>
          </div>
          
          <div style="background:#fef3c7; padding:20px; border-radius:12px; border:1px solid #fcd34d;">
            <div style="font-size:1.5rem; margin-bottom:8px;">ğŸ•</div>
            <div style="font-weight:700; color:#b45309;">DurÃ©e</div>
            <div style="font-size:0.85rem; color:#64748b;">Sessions</div>
          </div>
          
          <div style="background:#f3e8ff; padding:20px; border-radius:12px; border:1px solid #d8b4fe;">
            <div style="font-size:1.5rem; margin-bottom:8px;">ğŸ†</div>
            <div style="font-weight:700; color:#9333ea;">Top pages</div>
            <div style="font-size:0.85rem; color:#64748b;">Classement</div>
          </div>
          
        </div>
        
        <!-- Note -->
        <p style="margin-top:30px; font-size:0.85rem; color:#94a3b8;">
          ğŸ’¡ ID de mesure : G-7R9N0JL6GG
        </p>
        
      </div>
      
      <style>
        @keyframes pulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.1); }
        }
        a[href*="analytics.google.com"]:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(249,115,22,0.5);
        }
      </style>
      
    </section>
    <section id="view-pedago" class="view-section">
      <h2 style="color:var(--col-pedago);">PÃ©dagogie & cours</h2>
      <details open>
        <summary>ğŸ“ SÃ©quences CAP</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="test_bacpro.html" target="_blank" class="btn-yellow">ğŸ“„ Test Bac Pro (QQOQCP)</a>
          <a href="#" class="btn-yellow">ğŸ“ Exercices <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ—ºï¸ Progression <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ–¥ï¸ SÃ©ance projetÃ©e <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ§© ActivitÃ©s rapides <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div>
      </details>

      <details>
        <summary>ğŸ“ SÃ©quences BAC PRO</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ“ Exercices <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ—ºï¸ Progression <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ–¥ï¸ SÃ©ance projetÃ©e <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn-yellow">ğŸ§© ActivitÃ©s rapides <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div>
      </details>

      <details id="course-structure">
        <summary>ğŸ“š Cours CAP & Bac Pro (structure)</summary>

        <details class="lvl-cap">
          <summary>CAP</summary>

          <details>
            <summary>ThÃ©matique A â€“ Lâ€™individu et sa santÃ©</summary>
            <details><summary>Module A1 â€“ Le systÃ¨me de santÃ©</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module A2 â€“ Le sommeil</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module A3 â€“ Lâ€™activitÃ© physique</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module A4 â€“ Les addictions</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module A5 â€“ SexualitÃ© / Contraception</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module A6 â€“ PrÃ©venir les IST</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module A7 â€“ Lâ€™alimentation adaptÃ©e</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
          </details>

          <details>
            <summary>ThÃ©matique B â€“ Lâ€™environnement</summary>
            <details><summary>Module B1 â€“ Les ressources en eau</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module B2 â€“ Le risque majeur</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module B3 â€“ Les ressources en Ã©nergie</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module B4 â€“ Le bruit au quotidien</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
          </details>

          <details>
            <summary>ThÃ©matique C â€“ Milieu professionnel</summary>
            <details><summary>Module C1 â€“ Contrats de travail</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module C2 â€“ Enjeux santÃ© sÃ©curitÃ©</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module C3 â€“ DÃ©marche de prÃ©vention</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module C4 â€“ Risques spÃ©cifiques</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module C5 â€“ ActivitÃ© physique (travail)</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module C6 â€“ Acteurs de prÃ©vention</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module C7 â€“ Suivi mÃ©dical</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module C8 â€“ Secourisme</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
          </details>

          <details>
            <summary>ThÃ©matique D â€“ Consommateur</summary>
            <details><summary>Module D1 â€“ Lâ€™assurance</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module D2 â€“ Le budget</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
            <details><summary>Module D3 â€“ Les achats</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a></div></details>
          </details>
        </details>

        <details class="lvl-bacpro">
          <summary>Bac Pro</summary>

          <details>
            <summary>Seconde Bac Pro</summary>
            <details><summary>ThÃ©matique A</summary><div class="content-links">
              <a href="#" class="btn-yellow">ğŸ“„ Cours A1 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours A2 (Sommeil) <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours A3 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours A4 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours A5 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
            </div></details>
            <details><summary>ThÃ©matique B</summary><div class="content-links">
              <a href="#" class="btn-yellow">ğŸ“„ Cours B1 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours B2 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
            </div></details>
            <details><summary>ThÃ©matique C</summary><div class="content-links">
              <a href="#" class="btn-yellow">ğŸ“„ Cours C1 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours C2 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
            </div></details>
          </details>

          <details>
            <summary>PremiÃ¨re Bac Pro</summary>
            <details><summary>ThÃ©matique A</summary><div class="content-links">
              <a href="#" class="btn-yellow">ğŸ“„ Cours A6 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours A7 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours A8 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
            </div></details>
            <details><summary>ThÃ©matique B</summary><div class="content-links">
              <a href="#" class="btn-yellow">ğŸ“„ Cours B3 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours B4 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
            </div></details>
            <details><summary>ThÃ©matique C</summary><div class="content-links">
              <a href="#" class="btn-yellow">ğŸ“„ Cours C3 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours C4 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours C5 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours C6 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
            </div></details>
          </details>

          <details>
            <summary>Terminale Bac Pro</summary>
            <details><summary>ThÃ©matique A</summary><div class="content-links">
              <a href="#" class="btn-yellow">ğŸ“„ Cours A9 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
            </div></details>
            <details><summary>ThÃ©matique B</summary><div class="content-links">
              <a href="#" class="btn-yellow">ğŸ“„ Cours B5 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
            </div></details>
            <details><summary>ThÃ©matique C</summary><div class="content-links">
              <a href="#" class="btn-yellow">ğŸ“„ Cours C7 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours C8 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours C9 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours C10 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours C11 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
              <a href="#" class="btn-yellow">ğŸ“„ Cours C12 <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
            </div></details>
          </details>
        </details>
      </details>
    </section>

    <section id="view-notes" class="view-section" style="height:100%;">
      <div style="display:flex; flex-direction:column; height:100%;">
        <h2 style="color:var(--col-notes); border-bottom: 2px solid var(--col-notes); padding-bottom:10px; margin-top:0;">
          ğŸ“’ Atelier de RÃ©daction
        </h2>
        <iframe src="notes.html" style="flex:1; width:100%; border:none; border-radius:12px; background:#fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05);"></iframe>
      </div>
    </section> 

    <section id="view-eval" class="view-section">
      <h2 style="color:var(--col-eval);">Ã‰valuation & suivi</h2>
      <details open><summary>ğŸ“Š PageProf & suivis</summary><div class="content-links"><a href="pageprof.html" target="_blank" class="btn-yellow">ğŸ“Š Ouvrir PageProf</a><a href="#" class="btn-yellow">ğŸ“ˆ Tableau de bord <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">ğŸ§¾ Grilles / barÃ¨mes <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ“‚ Historique & exports</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ—“ï¸ Bilans <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">ğŸ“¥ Exports JSON / CSV <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-class" class="view-section">
      <h2 style="color:var(--col-class);">Classes & groupes</h2>
      <details open><summary>ğŸª‘ Plans de classe</summary><div class="content-links"><a href="prof_plan.html" target="_blank" class="btn-yellow">ğŸš€ Piloter</a><button class="btn-blue-outline" type="button" onclick="window.open('ecran_plan.html','proj')">ğŸ“º Afficher au tableau</button></div></details>
      <details><summary>ğŸ“‹ Listes dâ€™Ã©lÃ¨ves</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ‘¥ Listes <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">ğŸ” Recherche rapide <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ§© Besoins particuliers</summary><div class="content-links"><a href="#" class="btn-yellow">â™¿ AmÃ©nagements <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">ğŸ“˜ Dossiers MDPH / PAP <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-proj" class="view-section">
      <h2 style="color:var(--col-proj);">Projets & transversal</h2>
      <details open><summary>ğŸ¨ Chef-dâ€™Å“uvre</summary><div class="content-links"><a href="#" class="btn-yellow">CAP 1re annÃ©e <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">CAP 2e annÃ©e <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ« Projet dâ€™Ã©tablissement</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Documents <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">ğŸ—“ï¸ RÃ©unions / CR <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ§  Ateliers CPS</summary><div class="content-links"><a href="#" class="btn-yellow">SÃ©quences CPS <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">Outils dâ€™animation <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-admin" class="view-section">
      <h2 style="color:var(--col-admin);">Temps & institution</h2>
      <details open><summary>ğŸ“… Emploi du temps</summary><div class="content-links"><a href="#" class="btn-yellow">Vue semaine <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">Vue mois <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ¢ PFMP / stages</summary><div class="content-links"><a href="#" class="btn-yellow">Calendrier PFMP <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">Suivi Ã©lÃ¨ves <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ¤ Pacte / missions</summary><div class="content-links"><a href="#" class="btn-yellow">Heures rÃ©alisÃ©es <span class="badge-soon">BientÃ´t</span></a><a href="#" class="btn-yellow">Bilans <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-live" class="view-section">
      <h2 style="color:var(--col-live-web);">Classe en temps rÃ©el</h2>
      <details class="live-block" open>
        <summary class="live-summary">ğŸ—¨ï¸ Sâ€™exprimer / Explorer</summary>
        <div class="content-links live-links">
          <a href="eleve_nuage.html" class="btn btn-yellow">ğŸŒ¥ï¸ Nuage de mots <span class="badge-role role-eleve">Ã‰lÃ¨ves</span></a>
          <a href="prof_nuage.html" class="btn btn-yellow">â˜ï¸ Nuage <span class="badge-role role-prof">Prof</span></a>
          <a href="prof_postit.html" class="btn btn-yellow">â˜ï¸ PostIt prof <span class="badge-role role-prof">Prof</span></a>
          <a href="#" class="btn btn-yellow">ğŸ’¡ Brainstorming <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn btn-yellow">ğŸ’¡ Brainstorming <span class="badge-soon">ğŸš§ BientÃ´t</span> <span class="badge-role role-prof">Prof</span></a>
          <a href="eleve_meteo.html" class="btn btn-yellow">ğŸ§  Ma mÃ©tÃ©o <span class="badge-role role-eleve">Ã‰lÃ¨ves</span></a>
          <a href="prof_meteo.html" class="btn btn-yellow">ğŸ§  MÃ©tÃ©o <span class="badge-role role-prof">Prof</span></a>
          <a href="cafe_wall.html" class="btn-yellow">ğŸ–¥ï¸ Affichage Salle cafÃ© des parents<span class="badge-soon">ğŸ‘‡ ici</span></a>
          <a href="ecran_classe.html" class="btn btn-blue-outline">ğŸ“º Ã‰cran Classe <span class="badge-role role-prof">Prof</span></a>
          <a href="ecran_plat.html" class="btn btn-blue-outline">ğŸ“º Ã‰cran Plat <span class="badge-role role-prof">Prof</span></a>
        </div>
      </details>

      <details class="live-block">
        <summary class="live-summary">ğŸ¤ Travail collaboratif</summary>
        <div class="content-links live-links">
          <a href="#" class="btn btn-yellow">ğŸ‘¥ Travail de groupe <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="#" class="btn btn-yellow">ğŸ‘¥ Travail de groupe <span class="badge-soon">ğŸš§ BientÃ´t</span> <span class="badge-role role-prof">Prof</span></a>
          <a href="prof_mindmap.html" class="btn btn-yellow">ğŸ—£ï¸ carte mentale collective <span class="badge-soon">ğŸ‘‡ ici</span></a>
          <a href="ecran_mindmap.html" class="btn btn-yellow">ğŸ—£ï¸ carte mentale Ã©cran <span class="badge-soon">ğŸ‘‡ ici</span></a>
          <a href="prof_itamami.html" class="btn btn-yellow">ğŸ—£ï¸ ITAMAMI <span class="badge-soon">ğŸ‘‡ ici</span></a>
          <a href="prof_qqoqcp.html" class="btn btn-yellow">ğŸ—£ï¸ QQOQCP <span class="badge-soon">ğŸ‘‡ ici</span></a>
          <a href="prof_pad.html" class="btn btn-yellow">ğŸ—£ï¸ PAD <span class="badge-soon">ğŸ‘‡ ici</span></a>
          <a href="prof_ishikawa.html" class="btn btn-yellow">ğŸ—£ï¸ ishikawa <span class="badge-soon">ğŸ‘‡ ici</span></a>
          <a href="#" class="btn btn-yellow">ğŸ—£ï¸ DÃ©bat structurÃ© <span class="badge-soon">ğŸš§ BientÃ´t</span> <span class="badge-role role-prof">Prof</span></a>
        </div>
      </details>
    </section>

    <section id="view-sessions" class="view-section">
      <h2 style="color:#db2777; border-bottom: 2px solid #db2777; padding-bottom:10px;">ğŸ“¡ Gestionnaire & BibliothÃ¨que</h2>
      
      <div class="dashboard-grid">
        
        <div class="col-left">
            
            <div class="widget">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #f1f5f9; margin-bottom: 15px; padding-bottom: 10px;">
                    <h3 style="margin:0; border:none; padding:0;">âœ¨ DÃ©marrer une session</h3>
                    <a href="cafe_wall.html" target="_blank" class="btn-blue-outline" style="text-decoration:none; font-size:0.85rem; padding: 6px 12px;">
                        ğŸ–¥ï¸ Ouvrir l'Ã‰cran GÃ©ant
                    </a>
                </div>

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="session-title-input" placeholder="Titre (ex: CafÃ© du 12 Janvier)" style="flex:1; padding:12px; border-radius:8px; border:1px solid #cbd5e1; font-weight:bold;">
                    <button onclick="createNewSession()" style="background:#db2777; color:white; border:none; padding:0 20px; border-radius:8px; font-weight:bold; cursor:pointer;">Lancer ğŸš€</button>
                </div>
                <div id="session-info" style="display:none; margin-top:10px; color:#16a34a; font-weight:bold; font-size:0.9rem;">
                    âœ… Session active : <span id="current-session-name">...</span>
                </div>
            </div>

            <div id="live-panel" style="display:none; background:#fff; border:2px solid #db2777; border-radius:12px; padding:20px; box-shadow: 0 10px 25px rgba(219, 39, 119, 0.15);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #fce7f3; padding-bottom:10px;">
                    <h3 style="margin:0; color:#db2777;">ğŸ”´ EN DIRECT</h3>
                    <button onclick="stopSession()" style="background:#fff; color:#64748b; border:1px solid #cbd5e1; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.8rem;">â¹ Stop</button>
                </div>

                <div class="grid-acts">
                    <div class="act-btn" onclick="setMode('meteo')">ğŸ˜ MÃ©tÃ©o</div>
                    <div class="act-btn" onclick="setMode('nuage')">â˜ï¸ Nuage</div>
                    <div class="act-btn" onclick="setMode('sondage')">ğŸ“Š Sondage</div>
                    <div class="act-btn" onclick="setMode('quiz')">ğŸ† Quiz</div>
                </div>

                <div id="config-zone" style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; min-height:80px; display:flex; align-items:center; justify-content:center;">
                    <p style="text-align:center; color:#94a3b8; margin:0; font-size:0.9rem;">ğŸ‘ˆ SÃ©lectionnez une activitÃ© ou chargez depuis la bibliothÃ¨que.</p>
                </div>

                <div id="quiz-controls" style="display:none; margin-top:10px; padding-top:10px; border-top:1px solid #db2777;">
                    <div style="display:flex; gap:10px;">
                        <button onclick="revealQuiz()" style="flex:1; background:#db2777; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ‘€ RÃ©vÃ©ler RÃ©ponse</button>
                        <button onclick="resetQuiz()" style="flex:1; background:white; color:#db2777; border:1px solid #db2777; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ”„ Re-Voter</button>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                 <h3>ğŸ—‚ï¸ Archives</h3>
                 <div id="history-list" style="max-height:150px; overflow-y:auto; font-size:0.85rem;">Chargement...</div>
            </div>
        </div>

        <div class="col-right">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:#0f172a;">ğŸ“š BibliothÃ¨que</h3>
                <button onclick="toggleCreator()" style="background:#f1f5f9; border:1px solid #cbd5e1; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.8rem;">+ CrÃ©er</button>
            </div>

            <div id="creator-panel" style="display:none; background:#f0f9ff; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #bae6fd;">
                <input type="hidden" id="edit-id">
              <label style="font-size:0.75rem; font-weight:bold; color:#0369a1;">TYPE :</label>
                <select id="create-type" onchange="updateCreatorForm()" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom:10px;">
                    <option value="poll">ğŸ“Š CrÃ©er un Sondage</option>
                    <option value="quiz">ğŸ† CrÃ©er un Quiz (avec rÃ©ponse)</option>
                    <option value="cloud">â˜ï¸ CrÃ©er un ThÃ¨me Nuage</option>
                </select>
                
                <input type="text" id="create-title" placeholder="Titre dans la biblio (ex: Maths 1)" style="width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #cbd5e1; box-sizing:border-box;">
                <input type="text" id="create-question" placeholder="La question posÃ©e..." style="width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #cbd5e1; box-sizing:border-box;">
                
                <div id="options-container"></div>
                <button onclick="addOptionInput()" style="width:100%; margin-bottom:10px; background:white; border:1px dashed #cbd5e1; padding:5px; border-radius:6px; cursor:pointer; color:#64748b; font-size:0.8rem;">+ Ajouter une option</button>

                <button onclick="saveToLibrary()" style="width:100%; padding:10px; background:#0369a1; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ’¾ Enregistrer</button>
            </div>

            <ul id="library-list" class="lib-list">
                <li style="text-align:center; color:#94a3b8; padding:20px;">Chargement...</li>
            </ul>
        </div>
      </div>
    </section>

    <section id="view-sites" class="view-section">
      <h2 style="color:var(--col-sites);">Sites internet favoris</h2>
      <details open><summary>ğŸ¢ Administratif</summary><div class="content-links"><a href="https://portail.ac-lyon.fr/" class="btn-yellow" target="_blank">Portail AcadÃ©mie</a><a href="https://eduscol.education.fr/" class="btn-yellow" target="_blank">Eduscol</a><a href="https://www.education.gouv.fr/bo" class="btn-yellow" target="_blank">BO Ã‰ducation</a><a href="https://www.service-public.fr/" class="btn-yellow" target="_blank">Service-public</a><a href="https://cas.ent.auvergnerhonealpes.fr" class="btn-yellow" target="_blank">ENT / Mail pro</a></div></details>
      <details><summary>ğŸ“š Ressources pÃ©dagogiques</summary><div class="content-links"><a href="https://www.inrs.fr/" class="btn-yellow" target="_blank">INRS</a><a href="https://www.santepubliquefrance.fr/" class="btn-yellow" target="_blank">SantÃ© Publique France</a></div></details>
    </section>
  </main>

  <script>
    // UX Basics (Horloge, Planning, Agenda, Memos, Menu)
    function updateClock(){ const d=new Date(); document.getElementById("clock").innerText=d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0'); document.getElementById("date").innerText=d.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"}); }
    setInterval(updateClock,1000); updateClock();
    let planningOffset = 0; const planningData = [ {time:"08h30",label:"CAP â€“ PSE",room:"Salle 12"}, {time:"10h00",label:"Bac Pro â€“ PSE",room:"Salle 14"}, {time:"13h30",label:"Accompagnement perso",room:"CDI"} ];
    function renderPlanning(){ const list = document.getElementById("planning-list"); const date = new Date(); date.setDate(date.getDate()+planningOffset); document.getElementById("planning-date-label").textContent = date.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"2-digit"}); list.innerHTML = ""; planningData.forEach(c=>{ list.innerHTML += `<li class="course-item"><div class="course-time">${c.time}</div><div class="course-details"><strong>${c.label}</strong><br><small>${c.room}</small></div></li>`; }); }
    function changeDate(delta){planningOffset+=delta;renderPlanning();} renderPlanning();
    function save(key,value){localStorage.setItem(key,JSON.stringify(value));} function load(key,def){try{const v=JSON.parse(localStorage.getItem(key));return v??def;}catch(e){return def;}}
    let memos = load("cockpit_memos",[]);
    
    // Remplir memo-target avec les IDs des sections
    function fillMemoTarget() {
        const select = document.getElementById("memo-target");
        if (!select) return;
        
        const sections = [
            {id: "dashboard", label: "Tableau de bord"},
            {id: "view-scores", label: "Scores exercices"},
            {id: "view-trafic", label: "Trafic (monitoring)"},
            {id: "view-pedago", label: "PÃ©dagogie & cours"},
            {id: "view-notes", label: "RÃ©daction / Notes"},
            {id: "view-eval", label: "Ã‰valuation & suivi"},
            {id: "view-class", label: "Classes & groupes"},
            {id: "view-proj", label: "Projets & transversal"},
            {id: "view-admin", label: "Temps & admin"},
            {id: "view-live", label: "Classe en temps rÃ©el"},
            {id: "view-sessions", label: "Sessions & Sondages"},
            {id: "view-sites", label: "Sites internet"}
        ];
        
        select.innerHTML = '';
        sections.forEach(section => {
            const option = document.createElement("option");
            option.value = section.id;
            option.textContent = section.label;
            select.appendChild(option);
        });
    }
    
    function renderMemos(){ 
        const ul = document.getElementById("memo-list"); 
        ul.innerHTML = ""; 
        const current = document.querySelector(".view-section.active")?.id || "dashboard"; 
        memos.forEach((m,i)=>{ 
            ul.innerHTML += `<li class="alert-item${m.target===current?" context-active":""}"><span>${m.text}<br><small>${m.target}</small></span><button type="button" onclick="deleteMemo(${i})">âœ•</button></li>`; 
        }); 
    }
    function addMemo(){ 
        const t=document.getElementById("memo-target").value, 
              v=document.getElementById("memo-input").value.trim(); 
        if(v){
            memos.push({target:t,text:v}); 
            save("cockpit_memos",memos); 
            document.getElementById("memo-input").value=""; 
            renderMemos();
        } 
    }
    function deleteMemo(i){ memos.splice(i,1); save("cockpit_memos",memos); renderMemos(); }
    let agenda = load("cockpit_agenda",[]);
    function renderAgenda(){ const ul = document.getElementById("agenda-list"); ul.innerHTML=""; const now=new Date(); agenda.sort((a,b)=>new Date(a.when)-new Date(b.when)); agenda.forEach((ev,i)=>{ const d=new Date(ev.when), soon=(d-now)<7*24*3600*1000 && d>now; ul.innerHTML += `<li class="agenda-item${soon?" soon":""}"><div><strong>${ev.title}</strong><div class="agenda-meta">${d.toLocaleDateString("fr-FR")} â€¢ ${ev.type}</div></div><button type="button" onclick="deleteAgenda(${i})">âœ•</button></li>`; }); }
    function addAgenda(){ const type=document.getElementById("agenda-type").value, date=document.getElementById("agenda-date").value, title=document.getElementById("agenda-title").value.trim(); if(date&&title){ agenda.push({type,title,place:document.getElementById("agenda-place").value,when:new Date(date+"T"+(document.getElementById("agenda-time").value||"08:00"))}); save("cockpit_agenda",agenda); renderAgenda(); } }
    function deleteAgenda(i){ agenda.splice(i,1); save("cockpit_agenda",agenda); renderAgenda(); }
    
    function toggleMenu(){document.body.classList.toggle("menu-open");} 
    function closeMenu(){document.body.classList.remove("menu-open");}
    
    // Fonction escapeHtml unique
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Fonction timeline renommÃ©e pour Ã©viter les conflits
    function openTimelineDashboard() {
        alert("Timeline dashboard - FonctionnalitÃ© Ã  implÃ©menter");
    }
    
    // Initialisation
    fillMemoTarget();
    renderMemos(); 
    renderAgenda();
  </script>

  <script type="module">
    // Import Firebase avec compatibilitÃ©
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
      getFirestore, collection, collectionGroup, getDocs, getDoc, addDoc, setDoc, updateDoc, deleteDoc, doc,
      onSnapshot, query, orderBy, where, limit, Timestamp, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    
    // â­ AUTH GOOGLE pour sÃ©curiser les corrections
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // â­ AUTH GOOGLE
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    let currentUser = null;
    
    // Connexion Google Prof
    window.connexionProf = async function() {
      try {
        const result = await signInWithPopup(auth, googleProvider);
        currentUser = result.user;
        console.log("âœ… ConnectÃ©:", currentUser.email);
        console.log("ğŸ“ Votre UID:", currentUser.uid);
        alert("âœ… ConnectÃ© en tant que " + currentUser.email + "\n\nVotre UID (Ã  copier dans les rÃ¨gles Firestore):\n" + currentUser.uid);
        updateAuthUI();
        return currentUser;
      } catch (error) {
        console.error("âŒ Erreur connexion:", error);
        alert("Erreur de connexion: " + error.message);
      }
    };
    
    // DÃ©connexion
    window.deconnexionProf = async function() {
      await signOut(auth);
      currentUser = null;
      updateAuthUI();
      console.log("ğŸ‘‹ DÃ©connectÃ©");
    };
    
    // Mettre Ã  jour l'interface selon l'Ã©tat de connexion
    function updateAuthUI() {
      const authBadge = document.getElementById("authBadge");
      if (authBadge) {
        if (currentUser) {
          authBadge.innerHTML = `<span style="color:#16a34a;">âœ… ${currentUser.email}</span> <button onclick="deconnexionProf()" style="margin-left:5px;padding:2px 8px;font-size:11px;cursor:pointer;">DÃ©co</button>`;
          authBadge.style.display = "flex";
        } else {
          authBadge.innerHTML = `<button onclick="connexionProf()" style="background:#4285f4;color:white;border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-weight:bold;font-size:12px;">ğŸ” Connexion Prof</button>`;
          authBadge.style.display = "flex";
        }
      }
    }
    
    // VÃ©rifier l'Ã©tat de connexion au dÃ©marrage
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      updateAuthUI();
      if (user) {
        console.log("âœ… Prof connectÃ©:", user.email);
      }
    });
    
    // VARIABLES GLOBALES
    // Note: trafic dÃ©sactivÃ© - utilise Google Analytics maintenant
    let currentSessionId = null; 
    let sessionUnsubscribe = null;
    let wordsUnsubscribe = null;
    let allData = []; 
    let filteredData = [];
    let statsDetails = { 
        hourly: new Array(24).fill(0),
        devices: { Mobile: 0, Desktop: 0 },
        pages: [] 
    };
    let currentSort = { col: 'date', dir: 'desc' };
    let globalChart = null;
    let detailsChart = null;
    // â­ FONCTION BADGE COLLAGES
function getPasteBadge(pasteStats) {
    if (!pasteStats) return '<span style="color:#9ca3af;">-</span>';
    
    const external = pasteStats.external || 0;
    const internal = pasteStats.internal || 0;
    const total = pasteStats.total || (external + internal);
    
    if (external === 0 && total === 0) {
        return '<span style="color:#10b981;" title="Aucun collage dÃ©tectÃ©">âœ“</span>';
    }
    
    if (external === 0) {
        return `<span style="color:#10b981;" title="${internal} collage(s) interne(s)">âœ“</span>`;
    }
    
    if (external <= 2) {
        return `<span style="color:#f59e0b; font-weight:bold;" title="${external} collage(s) externe(s)">âš ï¸ ${external}</span>`;
    }
    
    return `<span style="color:#ef4444; font-weight:bold;" title="${external} collages externes - Attention !">ğŸš¨ ${external}</span>`;
}

// Fonction dÃ©tail collages pour modale
function getPasteDetailHTML(pasteStats) {
    if (!pasteStats) return '<p style="color:#9ca3af;">Aucune donnÃ©e</p>';
    
    const events = pasteStats.events || [];
    if (events.length === 0) {
        return '<p style="color:#10b981;">âœ… Aucun collage dÃ©tectÃ©</p>';
    }
    
    let html = '<div style="max-height:200px; overflow-y:auto;">';
    html += '<table style="width:100%; font-size:0.85rem;">';
    html += '<tr style="background:#f1f5f9;"><th>Heure</th><th>Type</th><th>Longueur</th></tr>';
    
    events.forEach(ev => {
        const time = ev.timestamp ? new Date(ev.timestamp).toLocaleTimeString('fr-FR') : '-';
        const type = ev.isExternal ? 
            '<span style="color:#ef4444;">ğŸŒ Externe</span>' : 
            '<span style="color:#10b981;">ğŸ“ Interne</span>';
        const len = ev.length || '?';
        
        html += `<tr><td>${time}</td><td>${type}</td><td>${len} car.</td></tr>`;
    });
    
    html += '</table></div>';
    return html;
}

    // --- FONCTIONS ACCESSIBLES GLOBALEMENT ---
    
    // Fonction showView (doit Ãªtre accessible globalement)
    window.showView = function(viewId, navEl) {
        // 1. UI : Gestion des classes active
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        const target = document.getElementById(viewId);
        if (target) target.classList.add('active');
        if (navEl) navEl.classList.add('active');

        // 2. Mise Ã  jour du titre de la page
        const pageTitle = document.getElementById("page-title");
        if (pageTitle) {
            const navItem = document.querySelector(`.nav-item[onclick*="${viewId}"]`);
            if (navItem) {
                pageTitle.textContent = navItem.textContent.replace(/[^a-zA-ZÃ€-Ã¿0-9\s]/g, '').trim();
            }
        }

        // 3. LOGIQUE TRAFIC - DÃ©sactivÃ© (utilise Google Analytics)
        // Rien Ã  charger, la section affiche juste un lien vers Google Analytics

        // 4. LOGIQUE SESSIONS
        if (viewId === 'view-sessions') {
            console.log("ğŸ“¡ Chargement du module Session...");
            if (typeof loadHistory === 'function') loadHistory(); 
        }

        // 5. Mobile : Fermer menu
        if (window.innerWidth <= 980) {
            document.body.classList.remove('menu-open');
        }
        
        // 6. MÃ©mos
        if (typeof renderMemos === 'function') renderMemos();
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”§ Fonction chargerDonnees CORRIGÃ‰E v2.0
    // Fusion copies + Ã©valuations pour afficher les vraies notes
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.chargerDonnees = async function() {
        console.log("ğŸš€ DÃ©marrage chargement v2.0 (fusion copies + Ã©valuations)...");
        const btns = document.querySelectorAll("button");
        btns.forEach(b => { if(b.innerText.includes("Actualiser")) b.innerText = "â³..."; });

        // Fonction pour extraire la note (fallback)
        function extractNote20(d){
            const candidates = [
                d?.note_finale,              // PrioritÃ© 1 : note_finale
                d?.resultat_auto?.score,     // PrioritÃ© 2 : score auto
                d?.meta?.score,              
                d?.score,
                d?.note,
                d?.raw?.meta?.score,
                d?.raw?.score,
                d?.raw?.note_finale,
                d?.raw?.note,
            ];

            for (const c of candidates){
                if (c === 0) return 0;
                if (c === null || c === undefined) continue;
                if (typeof c === "number" && !isNaN(c)) return c;
                if (typeof c === "string"){
                    const m = c.match(/(\d+(?:[.,]\d+)?)/);
                    if (m) return parseFloat(m[1].replace(",", "."));
                }
            }
            return null;
        }
        
        try {
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Ã‰TAPE 1 : Charger toutes les COPIES
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            console.log("ğŸ“‚ Chargement des copies...");
            const qCopies = query(collectionGroup(db, "copies"), limit(100));
            const snapCopies = await getDocs(qCopies);
            
            // Map : devoirId_eleveCode â†’ copie
            const copiesMap = new Map();
            
            snapCopies.forEach(docSnap => {
                const d = docSnap.data();
                const pathParts = docSnap.ref.path.split('/');
                const eleveCodeFromPath = pathParts.length >= 2 ? pathParts[1] : null;
                const userCode = eleveCodeFromPath || d.eleve?.userCode || d.userCode || d.eleveCode || null;
                const devoirId = d.devoirId || "unknown";
                
                const key = `${devoirId}_${userCode}`;
                
                copiesMap.set(key, {
                    docSnap: docSnap,
                    data: d,
                    eleveCode: userCode,
                    devoirId: devoirId
                });
            });
            
            console.log("âœ… Copies chargÃ©es:", copiesMap.size);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Ã‰TAPE 2 : Charger toutes les Ã‰VALUATIONS (corrections)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            console.log("ğŸ“‚ Chargement des Ã©valuations...");
            const qEvals = query(collectionGroup(db, "evaluations"), limit(100));
            const snapEvals = await getDocs(qEvals);
            
            // Map : devoirId_eleveCode â†’ Ã©valuation
            const evalsMap = new Map();
            
            snapEvals.forEach(docSnap => {
                const evalData = docSnap.data();
                const pathParts = docSnap.ref.path.split('/');
                const eleveCodeFromPath = pathParts.length >= 2 ? pathParts[1] : null;
                const userCode = eleveCodeFromPath || evalData.eleveCode || null;
                const devoirId = evalData.devoirId || "unknown";
                
                const key = `${devoirId}_${userCode}`;
                
                evalsMap.set(key, evalData);
            });
            
            console.log("âœ… Ã‰valuations chargÃ©es:", evalsMap.size);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Ã‰TAPE 3 : FUSION copies + Ã©valuations
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            allData = [];
            let classes = new Set();
            let exercices = new Set();
            
            copiesMap.forEach((copyObj, key) => {
                const d = copyObj.data;
                const docSnap = copyObj.docSnap;
                const userCode = copyObj.eleveCode;
                const devoirId = copyObj.devoirId;
                
                // â­ Chercher l'Ã©valuation correspondante
                const evaluation = evalsMap.get(key);
                
                // Identifiant pour l'affichage
                const identifiant = userCode || 
                                  (d.eleve?.prenom ? (d.eleve.prenom + " " + d.eleve.nom) : 
                                  (d.identifiant || "Anonyme"));
                
                // Gestion de la date
                let dateValue;
                if (d.createdAtISO) {
                    dateValue = new Date(d.createdAtISO);
                } else if (d.date) {
                    dateValue = new Date(d.date);
                } else if (d.createdAt?.toDate) {
                    dateValue = d.createdAt.toDate();
                } else {
                    dateValue = new Date();
                }
                
                // â­â­â­ PRIORITÃ‰ Ã€ LA NOTE FINALE DE L'Ã‰VALUATION â­â­â­
                let noteFinal = "--";
                let estCorrige = false;
                
                if (evaluation && evaluation.note_finale !== undefined) {
                    // Si Ã©valuation existe â†’ utiliser note_finale
                    noteFinal = evaluation.note_finale;
                    estCorrige = true;
                    console.log("âœ… Correction trouvÃ©e pour", identifiant, devoirId, "â†’", noteFinal);
                } else {
                    // Sinon â†’ utiliser note_auto de la copie
                    noteFinal = extractNote20(d) ?? "--";
                    console.log("âš ï¸ Pas de correction pour", identifiant, devoirId, "â†’ note auto:", noteFinal);
                }
                
                const item = {
                    id: docSnap.id,
                    path: docSnap.ref.path,
                    eleveCode: userCode,
                    raw: d,
                    date: dateValue,
                    identifiant: identifiant,
                    userCode: userCode,
                    classe: d.eleve?.classe || d.classe || "?",
                    temps_secondes: d.temps_secondes || 0,
                    exercice_titre: d.titre || devoirId || "Devoir",
                    devoirId: devoirId,
                    reponses: d.reponses,
                    eleve: d.eleve,
                    note_finale: noteFinal,  // â­ NOTE CORRIGÃ‰E
                    competences: d.competences || {},
                    estCorrige: estCorrige,  // â­ Indicateur de correction
                    evaluation: evaluation   // â­ Ã‰valuation complÃ¨te si disponible
                };
                allData.push(item);

                if(item.classe) classes.add(item.classe);
                if(item.exercice_titre) exercices.add(item.exercice_titre);
            });
            
            console.log("âœ… DonnÃ©es fusionnÃ©es:", allData.length, "copies");
            console.log("ğŸ“Š Corrections:", allData.filter(d => d.estCorrige).length, "/", allData.length);
            
            // Mise Ã  jour des filtres
            const selClass = document.getElementById("filter-class");
            const selExo = document.getElementById("filter-exercice");
            const oldClass = selClass.value; 
            const oldExo = selExo.value;

            selClass.innerHTML = '<option value="ALL">Toutes les classes</option>';
            classes.forEach(c => selClass.innerHTML += `<option value="${c}">${c}</option>`);
            selClass.value = oldClass || "ALL";

            selExo.innerHTML = '<option value="ALL">Tous les exercices</option>';
            exercices.forEach(e => selExo.innerHTML += `<option value="${e}">${e}</option>`);
            selExo.value = oldExo || "ALL";

            applyFilters(); 

        } catch(e) { 
            console.error("âŒ Erreur chargement:", e); 
            alert("Erreur lors du chargement des donnÃ©es:\n\n" + e.message);
        }

        // Lancement des stats
        if(typeof chargerStatsCompletes === 'function') await chargerStatsCompletes();
        
        // Remise Ã  zÃ©ro des boutons
        btns.forEach(b => { if(b.innerText.includes("â³")) b.innerText = "ğŸ”„ Tout actualiser"; });
    };

    // Fonctions de tri et filtrage
    window.applyFilters = function() {
        const fClass = document.getElementById("filter-class").value;
        const fExo = document.getElementById("filter-exercice").value;
        const fName = document.getElementById("filter-student").value.toLowerCase();

        filteredData = allData.filter(d => {
            if(fClass !== "ALL" && d.classe !== fClass) return false;
            if(fExo !== "ALL" && d.exercice_titre !== fExo) return false;
            if(fName && !d.identifiant.toLowerCase().includes(fName)) return false;
            return true;
        });
        sortData(currentSort.col, false);
    };
    
    window.sortData = function(col, toggle = true) {
        if (toggle) {
            if (currentSort.col === col) {
                currentSort.dir = currentSort.dir === "asc" ? "desc" : "asc";
            } else {
                currentSort.col = col;
                currentSort.dir = "asc";
            }
            if ((col === "date" || col === "note_finale") && toggle && currentSort.col !== col) {
                currentSort.dir = "desc";
            }
        }

        const getDateValue = (x) => {
            if (!x) return 0;
            if (x instanceof Date) return x.getTime();
            if (typeof x === "string") {
                const d = new Date(x);
                return isNaN(d.getTime()) ? 0 : d.getTime();
            }
            if (x.seconds) return x.seconds * 1000;
            return 0;
        };

        filteredData.sort((a, b) => {
            let va = a[col], vb = b[col];

            if (col === "date") { 
                va = getDateValue(a.date); 
                vb = getDateValue(b.date); 
            }
            if (col === "note_finale" || col === "temps_secondes") { 
                va = Number(va ?? 0); 
                vb = Number(vb ?? 0); 
            }
          if (col === "collages") {
    va = a.raw?.pasteStats?.external || 0;
    vb = b.raw?.pasteStats?.external || 0;
}

            if (typeof va === "string") va = va.toLowerCase();
            if (typeof vb === "string") vb = vb.toLowerCase();

            if (va < vb) return currentSort.dir === "asc" ? -1 : 1;
            if (va > vb) return currentSort.dir === "asc" ? 1 : -1;
            return 0;
        });

        renderTable();
        updateGlobalRadar();
    };

    function renderTable() {
        const tbody = document.getElementById("tbody-eleves");
        if (!tbody) return;
        
        tbody.innerHTML = "";

        if (!filteredData || filteredData.length === 0) {
            tbody.innerHTML = "<tr><td colspan='9' class='scores-empty'>Aucun rÃ©sultat trouvÃ©.</td></tr>";
            return;
        }

        filteredData.forEach(d => {
            let dateStr = "-";
            if (d.date instanceof Date) {
                dateStr = d.date.toLocaleDateString("fr-FR");
            } else if (d.date && d.date.seconds) {
                dateStr = new Date(d.date.seconds * 1000).toLocaleDateString("fr-FR");
            }

            let timeStr = "-";
            if (d.temps_secondes) {
                const m = Math.floor(d.temps_secondes / 60);
                timeStr = m + " min";
            }

            // â­ AFFICHAGE AMÃ‰LIORÃ‰ AVEC INDICATEUR DE CORRECTION
            let scoreStyle = "color:#4b5563";
            let scoreTxt = d.note_finale;
            let correctionBadge = "";

            if (scoreTxt !== "--") {
                scoreTxt = scoreTxt + "/20";
                const val = parseFloat(d.note_finale);
                if (!isNaN(val)) {
                    if (val < 10) scoreStyle = "color:#dc2626;font-weight:bold";
                    else if (val >= 14) scoreStyle = "color:#16a34a;font-weight:bold";
                }
                
                // â­ Badge de correction
                if (d.estCorrige) {
                    correctionBadge = '<span style="display:inline-block; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px; font-size:0.7em; margin-left:5px;">âœ“</span>';
                }
            } else {
                scoreTxt = "--";
            }

            // RÃ©cupÃ©rer les stats de collage
const pasteStats = d.raw?.pasteStats || d.pasteStats || null;
const pasteBadge = getPasteBadge(pasteStats);

tbody.innerHTML += `<tr>
    <td>${dateStr}</td>
    <td><span class="eleve-link" onclick="openStudentDetail('${d.userCode || d.identifiant}')">${d.identifiant}</span></td>
    <td><span class="pill pill-blue">${d.classe}</span></td>
    <td>${timeStr}</td>
    <td>${d.exercice_titre}</td>
    <td style="font-weight:bold; ${scoreStyle}">${scoreTxt}${correctionBadge}</td>
    <td style="text-align:center;">${pasteBadge}</td>
    <td style="text-align:center;" title="${d.evaluation?.luLe ? 'Lu le ' + (d.evaluation.luLe.toDate ? d.evaluation.luLe.toDate().toLocaleDateString('fr-FR') : new Date(d.evaluation.luLe).toLocaleDateString('fr-FR')) : 'Non lu'}">${d.evaluation?.luLe ? 'ğŸ‘ï¸' : 'âœ‰ï¸'}</td>
    <td style="display:flex; gap:5px;">
  <button type="button"
  onclick='ouvrirCorrection(${JSON.stringify(d).replace(/'/g,"&#39;")})'
  style="background:#fef3c7; color:#b45309; border:1px solid #fcd34d; padding:5px 8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.8rem;"
  title="Ouvrir la grille">âœï¸ Grille</button>

  <button type="button"
    onclick='openMirror(${JSON.stringify(d).replace(/'/g, "&#39;")})'
    style="background:#e0f2fe; color:#0369a1; border:1px solid:#bae6fd; padding:5px 8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.8rem;"
    title="Voir la copie">ğŸ‘ï¸ Copie</button>

  <button type="button"
    onclick='deleteSubmission("${d.path}", "${d.eleveCode}", "${d.devoirId}", "${d.identifiant}")'
    style="background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; padding:5px 8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.8rem;"
    title="Supprimer dÃ©finitivement">ğŸ—‘ï¸</button>
</td>
            </tr>`;
        });
    }

    // Fonction ouvrirCorrection (version simplifiÃ©e)
    window.ouvrirCorrection = function(copy) {
  try {
    // 1) on envoie la copie complÃ¨te Ã  la grille
    localStorage.setItem("cockpit_transfert", JSON.stringify(copy));

    // 2) on ouvre la grille SANS paramÃ¨tre id
    window.open("grille.html", "_blank");
  } catch (e) {
    alert("Erreur ouverture grille : " + e.message);
  }
};

    // Fonction openMirror
    window.openMirror = function(data) {
        // CrÃ©er une modale pour afficher la copie
        const modal = document.createElement("div");
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        `;
        
        const content = document.createElement("div");
        content.style.cssText = `
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
        `;
        
        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">ğŸ“„ Copie de ${data.identifiant}</h2>
                <button onclick="this.closest('.modal-mirror').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
            </div>
            <div style="margin-bottom: 15px;">
                <strong>Exercice:</strong> ${data.exercice_titre}<br>
                <strong>Classe:</strong> ${data.classe}<br>
                <strong>Date:</strong> ${data.date instanceof Date ? data.date.toLocaleDateString("fr-FR") : data.date}
            </div>
        `;
        
        if (data.reponses && Object.keys(data.reponses).length > 0) {
            html += `<h3>RÃ©ponses:</h3>`;
            html += `<div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
            for (const [key, value] of Object.entries(data.reponses)) {
                html += `<div><strong>${key}:</strong> ${typeof value === 'object' ? JSON.stringify(value) : value}</div>`;
            }
            html += `</div>`;
        }
        // Section Collages
const pasteStats = data.raw?.pasteStats || data.pasteStats || null;
html += `<h3>ğŸ“‹ Analyse Collages</h3>`;
html += `<div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
html += getPasteDetailHTML(pasteStats);
html += `</div>`;
        if (data.competences && Object.keys(data.competences).length > 0) {
            html += `<h3>CompÃ©tences:</h3>`;
            html += `<div style="background: #f0f9ff; padding: 15px; border-radius: 8px;">`;
            for (const [key, value] of Object.entries(data.competences)) {
                html += `<span style="background: #dbeafe; padding: 4px 8px; border-radius: 4px; margin-right: 5px; display: inline-block; margin-bottom: 5px;">${key}: ${value}</span>`;
            }
            html += `</div>`;
        }
        
        content.innerHTML = html;
        modal.appendChild(content);
        modal.classList.add("modal-mirror");
        document.body.appendChild(modal);
        
        // Fermer en cliquant en dehors
        modal.addEventListener("click", function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
    };

    // â­ Fonction de SUPPRESSION dÃ©finitive d'une soumission
    window.deleteSubmission = async function(path, eleveCode, devoirId, identifiant) {
        // âš ï¸ VÃ©rification de connexion prof
        if (!currentUser) {
            alert("âŒ Vous devez Ãªtre connectÃ© en tant que professeur pour supprimer.");
            return;
        }
        
        // âš ï¸ Confirmation double sÃ©curitÃ©
        const confirmMsg = `âš ï¸ ATTENTION - SUPPRESSION DÃ‰FINITIVE\n\n` +
                          `Ã‰lÃ¨ve : ${identifiant}\n` +
                          `Devoir : ${devoirId}\n\n` +
                          `Cette action supprimera :\n` +
                          `â€¢ La copie de l'Ã©lÃ¨ve\n` +
                          `â€¢ La correction associÃ©e (si existante)\n\n` +
                          `Cette action est IRRÃ‰VERSIBLE.\n\n` +
                          `Voulez-vous vraiment supprimer ?`;
        
        if (!confirm(confirmMsg)) return;
        
        // Seconde confirmation
        if (!confirm("â— DerniÃ¨re confirmation : Ãªtes-vous VRAIMENT sÃ»r ?")) return;
        
        try {
            console.log("ğŸ—‘ï¸ Suppression en cours...");
            console.log("   Path copie:", path);
            console.log("   Ã‰lÃ¨ve:", eleveCode);
            console.log("   Devoir:", devoirId);
            
            // 1ï¸âƒ£ Supprimer la COPIE
            const copyRef = doc(db, path);
            await deleteDoc(copyRef);
            console.log("âœ… Copie supprimÃ©e");
            
            // 2ï¸âƒ£ Supprimer l'Ã‰VALUATION associÃ©e (si elle existe)
            if (eleveCode && devoirId) {
                const evalPath = `resultats/${eleveCode}/evaluations/${devoirId}_eval`;
                const evalRef = doc(db, evalPath);
                const evalSnap = await getDoc(evalRef);
                
                if (evalSnap.exists()) {
                    await deleteDoc(evalRef);
                    console.log("âœ… Ã‰valuation supprimÃ©e");
                } else {
                    console.log("â„¹ï¸ Pas d'Ã©valuation associÃ©e");
                }
            }
            
            // 3ï¸âƒ£ RafraÃ®chir l'affichage
            alert("âœ… Document supprimÃ© dÃ©finitivement !");
            chargerDonnees(); // Recharger la liste
            
        } catch (error) {
            console.error("âŒ Erreur suppression:", error);
            
            if (error.code === "permission-denied") {
                alert("âŒ Permission refusÃ©e.\n\nVÃ©rifiez que :\n1. Vous Ãªtes connectÃ©\n2. Les rÃ¨gles Firestore autorisent la suppression");
            } else {
                alert("âŒ Erreur lors de la suppression :\n" + error.message);
            }
        }
    };

    // Fonction openStudentDetail avec clÃ© userCode
    window.openStudentDetail = function(studentIdentifier) {
        // Chercher par userCode d'abord, puis par identifiant
        const studentHistory = allData.filter(d => 
            (d.userCode && d.userCode === studentIdentifier) || 
            d.identifiant === studentIdentifier
        );
        
        if(studentHistory.length === 0) return;
        
        const last = studentHistory[0];
        document.getElementById("modal-name").innerText = last.identifiant;
        document.getElementById("modal-class").innerText = last.classe;
        
        let totalTime = 0, totalScore = 0, nbNotes = 0;
        let sums = {C1:0,C2:0,C3:0,C4:0,C5:0,C6:0}, counts = {C1:0,C2:0,C3:0,C4:0,C5:0,C6:0};
        let histHtml = "";
        
        studentHistory.forEach(h => {
            if(h.temps_secondes) totalTime += h.temps_secondes;
            
            if(h.note_finale && h.note_finale !== "--"){
                let v = parseFloat(h.note_finale);
                if(!isNaN(v)) { totalScore += v; nbNotes++; }
            }

            if(h.competences) {
                for(let k in h.competences) {
                    let key = k.substring(0,2);
                    if(h.competences[k] !== null && sums[key] !== undefined) { 
                        sums[key] += h.competences[k]; 
                        counts[key]++; 
                    }
                }
            }
            
            let dateAff = "-";
            if(h.date instanceof Date) {
                dateAff = h.date.toLocaleDateString("fr-FR");
            } else if (h.date && h.date.seconds) {
                dateAff = new Date(h.date.seconds * 1000).toLocaleDateString("fr-FR");
            } else if (typeof h.date === "string") {
                 dateAff = new Date(h.date).toLocaleDateString("fr-FR");
            }
            
            histHtml += `<tr><td>${dateAff}</td><td>${h.exercice_titre}</td><td><strong>${h.note_finale}/20</strong></td></tr>`;
        });
        
        let avgScore = nbNotes > 0 ? (totalScore / nbNotes).toFixed(1) : "--";
        let avgTimeStr = "--";
        if(studentHistory.length > 0 && totalTime > 0) {
             let avgT = totalTime / studentHistory.length;
             avgTimeStr = Math.floor(avgT / 60) + "m " + Math.floor(avgT % 60);
        }
        
        document.getElementById("modal-avg").innerText = avgScore + " / 20";
        document.getElementById("modal-time").innerText = avgTimeStr;
        document.getElementById("modal-history").innerHTML = histHtml;
        
        document.getElementById("modalStudent").classList.add("open");
        
        setTimeout(() => { 
            updateChart("studentRadar", null, sums, counts, "Niveau de l'Ã©lÃ¨ve", 'rgba(16, 185, 129, 0.2)', '#10b981'); 
        }, 100);
    };

    window.closeModal = function() { 
        document.getElementById("modalStudent").classList.remove("open"); 
    };

    window.showStatDetails = function(type) {
        const modal = document.getElementById("modalStats");
        const title = document.getElementById("stats-title");
        const chartCanvas = document.getElementById("statsChart");
        const listDiv = document.getElementById("statsList");
        
        modal.classList.add("open");
        chartCanvas.style.display = "block";
        listDiv.innerHTML = "";
        
        if(detailsChart) { detailsChart.destroy(); }
        const ctx = chartCanvas.getContext('2d');

        if(type === 'views') {
            title.innerText = "â±ï¸ Trafic par heure (Jour vs Nuit)";
            listDiv.innerHTML = "<p style='text-align:center; color:#64748b; font-size:0.9rem;'>Analyse sur l'ensemble de l'historique</p>";
            
            detailsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [...Array(24).keys()].map(h => h+"h"),
                    datasets: [{
                        label: 'Visites',
                        data: statsDetails.hourly,
                        backgroundColor: (ctx) => {
                            const idx = ctx.dataIndex;
                            return (idx >= 8 && idx <= 18) ? '#3b82f6' : '#8b5cf6';
                        },
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

        } else if(type === 'devices') {
            title.innerText = "ğŸ“± RÃ©partition des supports";
            listDiv.innerHTML = "";
            
            detailsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mobile/Tablette', 'Ordinateur'],
                    datasets: [{
                        data: [statsDetails.devices.Mobile, statsDetails.devices.Desktop],
                        backgroundColor: ['#f59e0b', '#3b82f6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

        } else if(type === 'exercices') {
            title.innerText = "ğŸ† Classement complet des exercices";
            chartCanvas.style.display = "none";
            
            let html = "";
            statsDetails.pages.forEach((p, i) => {
                let medal = "";
                if(i===0) medal = "ğŸ¥‡"; else if(i===1) medal = "ğŸ¥ˆ"; else if(i===2) medal = "ğŸ¥‰";
                
                html += `
                <div class="rank-item">
                    <span class="rank-pos">${medal || (i+1)+'.'}</span>
                    <span class="rank-name">${p.name}</span>
                    <span class="rank-val">${p.count} vues</span>
                </div>`;
            });
            listDiv.innerHTML = html;
        }
    };

    window.closeStatModal = function() {
        document.getElementById("modalStats").classList.remove("open");
    };

    // Fonctions utilitaires
    function updateGlobalRadar() {
        let sums = {C1:0,C2:0,C3:0,C4:0,C5:0,C6:0}, counts = {C1:0,C2:0,C3:0,C4:0,C5:0,C6:0};
        let totalNote = 0, count = 0;
        
        filteredData.forEach(d => {
            if(d.note_finale && d.note_finale !== "--") {
                let val = parseFloat(d.note_finale);
                if(!isNaN(val)) {
                    totalNote += val;
                    count++;
                }
            }

            if(d.competences) {
                for(let k in d.competences) {
                    let key = k.substring(0,2);
                    if(sums[key] !== undefined && d.competences[k] !== null) {
                        sums[key] += d.competences[k];
                        counts[key]++;
                    }
                }
            }
        });

        if(count > 0) {
            document.getElementById("moyenne-globale").innerText = (totalNote/count).toFixed(1) + " / 20";
        } else {
            document.getElementById("moyenne-globale").innerText = "--";
        }

        updateChart("radarChart", null, sums, counts, "Moyenne SÃ©lection", 'rgba(59, 130, 246, 0.2)', '#3b82f6');
    }

    window.updateChart = function(canvasId, chartInstance, sums, counts, label, bgColor, borderColor) {
        const ctx = document.getElementById(canvasId);
        if(!ctx) return;
        
        if(Chart.getChart(canvasId)) {
            Chart.getChart(canvasId).destroy();
        }
        
        const dataArr = [
            counts.C1 ? sums.C1/counts.C1 : 0, 
            counts.C2 ? sums.C2/counts.C2 : 0, 
            counts.C3 ? sums.C3/counts.C3 : 0,
            counts.C4 ? sums.C4/counts.C4 : 0, 
            counts.C5 ? sums.C5/counts.C5 : 0, 
            counts.C6 ? sums.C6/counts.C6 : 0
        ];
        
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['C1 Info', 'C2 Analyse', 'C3 Expliquer', 'C4 Solution', 'C5 Arg', 'C6 Com'],
                datasets: [{ 
                    label: label, 
                    data: dataArr, 
                    backgroundColor: bgColor, 
                    borderColor: borderColor, 
                    pointBackgroundColor: borderColor 
                }]
            },
            options: { 
                scales: { 
                    r: { 
                        suggestedMin: 0, 
                        suggestedMax: 3 
                    } 
                }, 
                maintainAspectRatio: false 
            }
        });
    };

    // Fonctions trafic - DÃ‰SACTIVÃ‰ES (Google Analytics utilisÃ©)
    let traficInitDone = false;
    window.traficInit = function() { /* DÃ©sactivÃ© - utilise Google Analytics */ };
    window.traficRefresh = function() { /* DÃ©sactivÃ© - utilise Google Analytics */ };

    // Charger les donnÃ©es au dÃ©marrage
    chargerDonnees();
    
    // Initialiser les Ã©vÃ©nements de swipe pour mobile
    let touchStartX = 0;
    document.addEventListener('touchstart', e => { 
        touchStartX = e.changedTouches[0].screenX; 
    }, {passive: true});
    
    document.addEventListener('touchend', e => {
        let touchEndX = e.changedTouches[0].screenX;
        if(document.body.classList.contains("menu-open") && touchEndX < touchStartX - 50) {
            closeMenu();
        }
    }, {passive: true});

    // --- FONCTIONS POUR LE MODULE SESSIONS (copiÃ©es du code original) ---
    
    async function chargerStatsCompletes() {
        try {
            const qStats = query(collection(db, "statistiques_usage"));
            const snapStats = await getDocs(qStats);
            
            let totalViews = 0;
            statsDetails.hourly.fill(0);
            statsDetails.devices = { Mobile: 0, Desktop: 0 };
            let pageCounts = {};

            snapStats.forEach(doc => {
                totalViews++;
                const d = doc.data();
                
                if(d.device && /Mobi|Android/i.test(d.device)) statsDetails.devices.Mobile++;
                else statsDetails.devices.Desktop++;

                if(d.timestamp) {
                    let date = d.timestamp.toDate ? d.timestamp.toDate() : new Date(d.timestamp);
                    let hour = date.getHours();
                    if(hour >= 0 && hour < 24) statsDetails.hourly[hour]++;
                } else if(d.date) {
                    let date = new Date(d.date);
                    let hour = date.getHours();
                    if(!isNaN(hour)) statsDetails.hourly[hour]++;
                }

                let p = d.page || "Inconnu";
                pageCounts[p] = (pageCounts[p] || 0) + 1;
            });

            statsDetails.pages = Object.keys(pageCounts).map(key => {
                return { name: key, count: pageCounts[key] };
            }).sort((a,b) => b.count - a.count);

            const elTotal = document.getElementById("stat-total-views");
            if(elTotal) elTotal.innerText = totalViews;

            let mobPct = totalViews>0 ? Math.round((statsDetails.devices.Mobile/totalViews)*100) : 0;
            const elDevice = document.getElementById("stat-device");
            if(elDevice) elDevice.innerText = `${mobPct}% Mobile`;

            let topExo = statsDetails.pages.length > 0 ? statsDetails.pages[0].name : "--";
            if(topExo.length > 18) topExo = topExo.substring(0, 16) + "...";
            const elTop = document.getElementById("stat-top-page");
            if(elTop) elTop.innerText = topExo;

        } catch(e) { console.error("Erreur Stats:", e); }
    }

    // Fonctions pour le module sessions (gardÃ©es du code original)
    window.createNewSession = async function() {
        const titleInput = document.getElementById("session-title-input");
        const title = titleInput.value.trim();
        if(!title) { alert("Mettez un titre !"); return; }

        const ref = await addDoc(collection(db, "sessions"), {
            title: title, createdAt: serverTimestamp(), isActive: true
        });
        currentSessionId = ref.id;

        await setDoc(doc(db, "config", "live"), {
            activeSessionId: currentSessionId,
            sessionTitle: title,
            currentStep: "wait",
            updatedAt: serverTimestamp()
        }, { merge: true });

        document.getElementById("live-panel").style.display = "block";
        document.getElementById("session-info").style.display = "block";
        document.getElementById("current-session-name").innerText = title;
        
        const qc = document.getElementById("quiz-controls");
        if(qc) qc.style.display = "none";
        
        titleInput.value = "";
    };

    window.stopSession = async function() {
        if(!confirm("ArrÃªter la session ?")) return;
        
        if(currentSessionId) {
            await updateDoc(doc(db, "sessions", currentSessionId), { isActive: false });
        }
        await setDoc(doc(db, "config", "live"), { activeSessionId: null, currentStep: "wait" }, { merge: true });

        document.getElementById("live-panel").style.display = "none";
        document.getElementById("session-info").style.display = "none";
        currentSessionId = null;
        
        if(typeof loadHistory === 'function') loadHistory();
    };

    // ... (autres fonctions du module sessions restent inchangÃ©es)
    
    // Note: Les fonctions traficRefresh() et autres fonctions Firestore 
    // sont dÃ©jÃ  dÃ©finies dans le code original et fonctionnent correctement

// ============================================================================
// TRAFIC DÃ‰SACTIVÃ‰ - Utilise Google Analytics (G-7R9N0JL6GG)
// ============================================================================

// ============================================================================
// CORRECTION 3 : Fonctions pour le module Sessions & Sondages
// ============================================================================

// Variables globales pour les sessions
let libraryData = [];
let currentMode = null;
let currentConfig = null;

// Fonction loadHistory
window.loadHistory = async function() {
  console.log("ğŸ“š Chargement de l'historique des sessions...");
  
  try {
    const qSessions = query(
      collection(db, "sessions"),
      orderBy("createdAt", "desc"),
      limit(10)
    );
    
    const snapshot = await getDocs(qSessions);
    const histDiv = document.getElementById("history-list");
    
    if (!histDiv) return;
    
    let html = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const date = data.createdAt?.toDate 
        ? data.createdAt.toDate().toLocaleString("fr-FR", {
            day: "2-digit",
            month: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
          })
        : "-";
      
      const status = data.isActive 
        ? '<span class="pill pill-green">Active</span>'
        : '<span class="pill pill-orange">TerminÃ©e</span>';
      
      html += `
      <div style="padding:8px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>${data.title}</strong><br>
          <small style="color:#64748b;">${date}</small>
        </div>
        ${status}
      </div>`;
    });
    
    histDiv.innerHTML = html || '<p style="text-align:center; color:#94a3b8;">Aucun historique</p>';
    
  } catch(e) {
    console.error("âŒ Erreur loadHistory:", e);
  }
};

// Fonction toggleCreator
window.toggleCreator = function() {
  const panel = document.getElementById("creator-panel");
  if (!panel) return;
  
  if (panel.style.display === "none" || !panel.style.display) {
    panel.style.display = "block";
    updateCreatorForm();
  } else {
    panel.style.display = "none";
    // RÃ©initialiser le formulaire
    document.getElementById("edit-id").value = "";
    document.getElementById("create-title").value = "";
    document.getElementById("create-question").value = "";
    document.getElementById("options-container").innerHTML = "";
  }
};

// Fonction updateCreatorForm
window.updateCreatorForm = function() {
  const type = document.getElementById("create-type").value;
  const container = document.getElementById("options-container");
  
  if (!container) return;
  
  if (type === "cloud") {
    container.innerHTML = '<p style="color:#64748b; font-size:0.85rem; margin:10px 0;">Pour un nuage de mots, seul le thÃ¨me est nÃ©cessaire.</p>';
  } else {
    // Quiz ou Sondage : afficher 2 options par dÃ©faut
    container.innerHTML = `
      <div class="option-row">
        <input type="text" placeholder="Option A" class="filter-input" style="flex:1;">
        <input type="number" placeholder="Points (quiz)" class="filter-input" style="width:80px;" min="0" max="10">
        <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:#991b1b; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">âœ•</button>
      </div>
      <div class="option-row">
        <input type="text" placeholder="Option B" class="filter-input" style="flex:1;">
        <input type="number" placeholder="Points (quiz)" class="filter-input" style="width:80px;" min="0" max="10">
        <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:#991b1b; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">âœ•</button>
      </div>
    `;
  }
};

// Fonction addOptionInput
window.addOptionInput = function() {
  const container = document.getElementById("options-container");
  if (!container) return;
  
  const div = document.createElement("div");
  div.className = "option-row";
  div.innerHTML = `
    <input type="text" placeholder="Option..." class="filter-input" style="flex:1;">
    <input type="number" placeholder="Points" class="filter-input" style="width:80px;" min="0" max="10">
    <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:#991b1b; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">âœ•</button>
  `;
  container.appendChild(div);
};

// Fonction saveToLibrary
window.saveToLibrary = async function() {
  const type = document.getElementById("create-type").value;
  const title = document.getElementById("create-title").value.trim();
  const question = document.getElementById("create-question").value.trim();
  const editId = document.getElementById("edit-id").value;
  
  if (!title) {
    alert("Le titre est obligatoire !");
    return;
  }
  
  // PrÃ©parer les donnÃ©es selon le type
  let data = {
    type: type === "poll" ? "poll" : type === "quiz" ? "quiz" : "cloud",
    title: title,
    question: question || title,
    createdAt: serverTimestamp()
  };
  
  // RÃ©cupÃ©rer les options si ce n'est pas un nuage
  if (type !== "cloud") {
    const rows = document.querySelectorAll("#options-container .option-row");
    data.options = [];
    rows.forEach(row => {
      const inputs = row.querySelectorAll("input");
      if (inputs[0].value.trim()) {
        data.options.push({
          text: inputs[0].value.trim(),
          points: type === "quiz" ? (parseInt(inputs[1].value) || 0) : 0
        });
      }
    });
    
    if (data.options.length === 0) {
      alert("Ajoutez au moins une option !");
      return;
    }
  }
  
  try {
    if (editId) {
      // Mise Ã  jour
      await updateDoc(doc(db, "library", editId), data);
      console.log("âœ… Item mis Ã  jour");
    } else {
      // CrÃ©ation
      await addDoc(collection(db, "library"), data);
      console.log("âœ… Item crÃ©Ã©");
    }
    
    // RÃ©initialiser et recharger
    toggleCreator();
    loadLibrary();
    
  } catch(e) {
    console.error("âŒ Erreur saveToLibrary:", e);
    alert("Erreur lors de l'enregistrement : " + e.message);
  }
};

// Fonction loadLibrary
window.loadLibrary = async function() {
  console.log("ğŸ“š Chargement de la bibliothÃ¨que...");
  
  try {
    const qLib = query(collection(db, "library"), orderBy("createdAt", "desc"));
    const snapshot = await getDocs(qLib);
    
    libraryData = [];
    const ul = document.getElementById("library-list");
    if (!ul) return;
    
    let html = "";
    snapshot.forEach(doc => {
      const data = { id: doc.id, ...doc.data() };
      libraryData.push(data);
      
      const tag = data.type === "poll" 
        ? '<span class="tag tag-poll">Sondage</span>'
        : data.type === "quiz"
        ? '<span class="tag tag-quiz">Quiz</span>'
        : '<span class="tag tag-cloud">Nuage</span>';
      
      html += `
      <li class="lib-item" onclick="loadFromLibrary('${data.id}')">
        <div>
          ${tag}
          <strong>${data.title}</strong>
        </div>
        <div style="display:flex; gap:5px;">
          <button onclick="event.stopPropagation(); editLibraryItem('${data.id}')" style="background:#f1f5f9; border:1px solid #cbd5e1; padding:3px 8px; border-radius:4px; cursor:pointer; font-size:0.75rem;">âœï¸</button>
          <button onclick="event.stopPropagation(); deleteLibraryItem('${data.id}')" style="background:#fee2e2; border:1px solid #fecaca; color:#991b1b; padding:3px 8px; border-radius:4px; cursor:pointer; font-size:0.75rem;">ğŸ—‘ï¸</button>
        </div>
      </li>`;
    });
    
    ul.innerHTML = html || '<li style="text-align:center; color:#94a3b8; padding:20px;">BibliothÃ¨que vide</li>';
    
  } catch(e) {
    console.error("âŒ Erreur loadLibrary:", e);
  }
};

// Fonction loadFromLibrary
window.loadFromLibrary = async function(itemId) {
  if (!currentSessionId) {
    alert("Aucune session active ! CrÃ©ez-en une d'abord.");
    return;
  }
  
  const item = libraryData.find(i => i.id === itemId);
  if (!item) return;
  
  console.log("ğŸ“¥ Chargement de l'item:", item.title);
  
  // Mettre Ã  jour la config live
  await setDoc(doc(db, "config", "live"), {
    activeSessionId: currentSessionId,
    currentStep: item.type === "cloud" ? "nuage" : item.type === "poll" ? "sondage" : "quiz",
    config: item,
    updatedAt: serverTimestamp()
  }, { merge: true });
  
  // Afficher l'interface de configuration
  const configZone = document.getElementById("config-zone");
  if (configZone) {
    configZone.innerHTML = `
      <div style="width:100%;">
        <h4 style="margin:0 0 10px; color:#0f172a;">${item.title}</h4>
        <p style="margin:0; color:#64748b; font-size:0.9rem;">${item.question}</p>
        ${item.options ? `
          <div style="margin-top:10px;">
            ${item.options.map((opt, i) => 
              `<div style="padding:5px; background:#fff; border:1px solid #e2e8f0; border-radius:4px; margin-bottom:3px;">
                ${opt.text} ${item.type === "quiz" ? `(${opt.points} pts)` : ''}
              </div>`
            ).join('')}
          </div>
        ` : ''}
      </div>
    `;
  }
  
  // Afficher les contrÃ´les quiz si nÃ©cessaire
  const quizControls = document.getElementById("quiz-controls");
  if (quizControls) {
    quizControls.style.display = item.type === "quiz" ? "block" : "none";
  }
  
  // Activer le mode
  setMode(item.type === "cloud" ? "nuage" : item.type);
};

// Fonction editLibraryItem
window.editLibraryItem = function(itemId) {
  const item = libraryData.find(i => i.id === itemId);
  if (!item) return;
  
  // Remplir le formulaire
  document.getElementById("edit-id").value = item.id;
  document.getElementById("create-type").value = item.type;
  document.getElementById("create-title").value = item.title;
  document.getElementById("create-question").value = item.question;
  
  updateCreatorForm();
  
  // Remplir les options
  if (item.options) {
    const container = document.getElementById("options-container");
    container.innerHTML = "";
    item.options.forEach(opt => {
      const div = document.createElement("div");
      div.className = "option-row";
      div.innerHTML = `
        <input type="text" placeholder="Option..." class="filter-input" style="flex:1;" value="${opt.text}">
        <input type="number" placeholder="Points" class="filter-input" style="width:80px;" min="0" max="10" value="${opt.points || 0}">
        <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:#991b1b; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">âœ•</button>
      `;
      container.appendChild(div);
    });
  }
  
  // Afficher le panneau
  document.getElementById("creator-panel").style.display = "block";
};

// Fonction deleteLibraryItem
window.deleteLibraryItem = async function(itemId) {
  if (!confirm("Supprimer cet Ã©lÃ©ment de la bibliothÃ¨que ?")) return;
  
  try {
    await deleteDoc(doc(db, "library", itemId));
    console.log("âœ… Item supprimÃ©");
    loadLibrary();
  } catch(e) {
    console.error("âŒ Erreur deleteLibraryItem:", e);
    alert("Erreur lors de la suppression : " + e.message);
  }
};

// Fonction setMode
window.setMode = function(mode) {
  console.log("ğŸ¯ Mode:", mode);
  currentMode = mode;
  
  // Activer visuellement le bouton
  document.querySelectorAll(".act-btn").forEach(btn => btn.classList.remove("active"));
  const buttons = {
    meteo: 0,
    nuage: 1,
    sondage: 2,
    quiz: 3
  };
  const btns = document.querySelectorAll(".act-btn");
  if (btns[buttons[mode]]) {
    btns[buttons[mode]].classList.add("active");
  }
};

// Fonction revealQuiz
window.revealQuiz = async function() {
  if (!currentSessionId) return;
  
  try {
    await updateDoc(doc(db, "config", "live"), {
      revealed: true,
      updatedAt: serverTimestamp()
    });
    console.log("âœ… RÃ©ponse rÃ©vÃ©lÃ©e");
  } catch(e) {
    console.error("âŒ Erreur revealQuiz:", e);
  }
};

// Fonction resetQuiz
window.resetQuiz = async function() {
  if (!currentSessionId) return;
  if (!confirm("RÃ©initialiser les votes ?")) return;
  
  try {
    // Supprimer tous les votes de la session
    const qVotes = query(
      collection(db, "votes"),
      where("sessionId", "==", currentSessionId)
    );
    const snapshot = await getDocs(qVotes);
    
    const batch = [];
    snapshot.forEach(doc => {
      batch.push(deleteDoc(doc.ref));
    });
    
    await Promise.all(batch);
    
    // RÃ©initialiser revealed
    await updateDoc(doc(db, "config", "live"), {
      revealed: false,
      updatedAt: serverTimestamp()
    });
    
    console.log("âœ… Quiz rÃ©initialisÃ©");
  } catch(e) {
    console.error("âŒ Erreur resetQuiz:", e);
  }
};

// Auto-chargement de la bibliothÃ¨que au dÃ©marrage
if (typeof db !== 'undefined') {
  loadLibrary();
}

console.log("âœ… Toutes les fonctions de correction sont chargÃ©es");
  </script>
</body>
</html>

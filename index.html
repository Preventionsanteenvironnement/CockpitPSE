<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cockpit Professeur â€“ Pilotage Global</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-body:#f1f5f9; --bg-sidebar:#0f172a; --text-main:#1e293b; --text-muted:#64748b;
      --col-pedago:#3b82f6; --col-eval:#f59e0b; --col-class:#10b981; --col-proj:#8b5cf6;
      --col-admin:#f97316; --col-live-web:#795548; --col-sites:#607d8b;
      --col-notes:#facc15;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; font-family:'Inter',sans-serif;
      background-color:var(--bg-body); color:var(--text-main);
      display:flex; height:100vh; overflow:hidden;
    }

    /* SIDEBAR */
    .sidebar{
      width:300px; background-color:var(--bg-sidebar); color:#fff;
      display:flex; flex-direction:column; padding:20px; flex-shrink:0;
      overflow-y:auto; gap:10px;
      position: relative;
    }
    .brand{ font-size:1.3rem; font-weight:800; margin-bottom:20px; letter-spacing:1px; display:flex; align-items:center; gap:10px; }
    .nav-category{ font-size:.75rem; text-transform:uppercase; letter-spacing:1px; font-weight:700; color:#64748b; margin:15px 0 5px; }
    .nav-item{
      display:flex; align-items:center; gap:12px; padding:12px 15px; border-radius:8px;
      cursor:pointer; transition:.2s; font-weight:600; color:#cbd5e1; border-left:4px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:#fff;}
    .nav-item.active{background:rgba(255,255,255,.10); color:#fff;}
    .nav-item[data-theme="pedago"].active{border-left-color:var(--col-pedago);}
    .nav-item[data-theme="eval"].active{border-left-color:var(--col-eval);}
    .nav-item[data-theme="class"].active{border-left-color:var(--col-class);}
    .nav-item[data-theme="proj"].active{border-left-color:var(--col-proj);}
    .nav-item[data-theme="admin"].active{border-left-color:var(--col-admin);}
    .nav-item[data-theme="live"].active{border-left-color:var(--col-live-web);}
    .nav-item[data-theme="sites"].active{border-left-color:var(--col-sites);}
    .nav-item[data-theme="notes"].active{border-left-color:var(--col-notes);}

    /* MAIN */
    .main-content{ flex:1; padding:40px; overflow-y:auto; display:flex; flex-direction:column; position:relative; }
    header{ display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:30px; border-bottom:1px solid #e2e8f0; padding-bottom:20px; }
    h1{margin:0; font-size:2rem; font-weight:800; color:var(--text-main);}
    .header-infos{text-align:right;}
    .clock-time{font-size:1.5rem; font-weight:800;}
    .clock-date{font-size:.9rem; color:var(--text-muted);}
    .vacation-badge{ margin-top:5px; font-size:.8rem; background:#dbeafe; color:#2563eb; padding:4px 10px; border-radius:20px; border:1px solid #bfdbfe; font-weight:bold; }

    .view-section{display:none; animation:fadeUp .4s ease-out;}
    .view-section.active{display:block;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

    .quick-actions{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:30px; }
    .btn-quick{
      background:#fff; border:1px solid #e2e8f0; padding:15px; border-radius:12px;
      text-align:left; cursor:pointer; transition:.2s; display:flex; align-items:center; gap:15px;
      box-shadow:0 2px 4px rgba(0,0,0,.02); text-decoration:none; color:inherit;
    }
    .btn-quick div { display: flex; flex-direction: column; }
    .btn-quick div strong { font-size: 1em; color: #1e293b; }
    .btn-quick div span { font-size: 0.8em; color: #64748b; }
    .btn-quick:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.05); border-color:var(--col-pedago); }

    .dashboard-grid{display:grid; grid-template-columns:2fr 1fr; gap:25px;}
    .widget{ background:#fff; border-radius:16px; padding:25px; border:1px solid #e2e8f0; display:flex; flex-direction:column; min-height:320px; }
    .widget h3{ margin:0 0 15px; padding-bottom:10px; border-bottom:2px solid #f1f5f9; font-size:1.1rem; display:flex; justify-content:space-between; align-items:center; }

    .stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-color: var(--col-pedago); }
    .stat-card:active { transform: scale(0.98); }

    .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .icon-blue { background: #e0f2fe; color: #0284c7; }
    .icon-purple { background: #f3e8ff; color: #9333ea; }
    .icon-green { background: #dcfce7; color: #16a34a; }
    .stat-info h4 { margin: 0; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
    .stat-info p { margin: 5px 0 0; font-size: 1.4rem; font-weight: 800; color: #0f172a; }

    .toolbar {
      display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;
    }
    .filter-input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
    .filter-select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; min-width: 150px; background: white; }

    .radar-container { height: 320px; display: flex; justify-content: center; margin-bottom: 10px; }
    .pill { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-right: 5px; display: inline-block; margin-bottom: 2px;}
    .pill-green { background: #dcfce7; color: #166534; }
    .pill-orange { background: #ffedd5; color: #9a3412; }
    .pill-red { background: #fee2e2; color: #991b1b; }
    .pill-blue { background: #dbeafe; color: #1e40af; }
    
    .results-table { width:100%; border-collapse:collapse; min-width:600px; }
    .results-table thead { background:#f1f5f9; color:#475569; }
    .results-table th { padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:.88rem; cursor: pointer; user-select: none; }
    .results-table th:hover { background: #e2e8f0; }
    .results-table td { padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:.88rem; }
    .results-table tr:hover { background:#f8fafc; }
    .scores-empty { text-align:center; padding: 20px; color: #64748b; }

    .eleve-link { color: #2563eb; font-weight: 700; cursor: pointer; text-decoration: underline; text-decoration-color: transparent; transition: 0.2s; }
    .eleve-link:hover { text-decoration-color: #2563eb; }
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; animation: fadeIn 0.3s; }
    .modal-card { background: #fff; width: 90%; max-width: 900px; max-height: 90vh; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); overflow-y: auto; display: flex; flex-direction: column; }
    .modal-header { padding: 20px 30px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; position: sticky; top: 0; z-index: 10; }
    .modal-body { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; }
    .stat-box { background: #f1f5f9; padding: 15px; border-radius: 12px; text-align: center; }
    .stat-val { font-size: 1.8rem; font-weight: 800; color: #0f172a; display: block; }
    .stat-label { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
    @media(max-width: 800px) { .modal-body { grid-template-columns: 1fr; } }

    .detail-modal-content { height: 400px; display: flex; flex-direction: column; width: 100%; }
    .rank-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
    .rank-item:hover { background-color: #f8fafc; }
    .rank-pos { font-weight: 800; color: var(--col-pedago); width: 35px; }
    .rank-name { flex: 1; font-weight: 500; color: #334155; }
    .rank-val { font-weight: 700; color: #0f172a; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-size: 0.9rem;}

    .btn-yellow{ display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:#fffbeb; color:#b45309; border:1px solid #fcd34d; border-radius:6px; text-decoration:none; font-weight:600; font-size:.85rem; }
    .btn-blue-outline{ display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:#f0f9ff; color:#0369a1; border:1px solid #bae6fd; border-radius:6px; text-decoration:none; font-weight:600; font-size:.85rem; cursor:pointer; }
    .badge-soon{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; margin-left:6px; border:1px solid rgba(0,0,0,.05); background:#fef3c7; color:#92400e; }
    
    details{ background:#fff; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px; overflow:hidden; }
    summary{ padding:15px; font-weight:600; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; }
    details[open]>summary{background:#f1f5f9; border-bottom:1px solid #e2e8f0;}
    .content-links{ padding:15px; display:flex; flex-wrap:wrap; gap:10px; }
    
    #course-structure>summary{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); }
    #course-structure .lvl-cap>summary{ background:rgba(37,99,235,.12); border-left:6px solid rgba(37,99,235,.9); font-weight:900; }
    #course-structure .lvl-bacpro>summary{ background:rgba(22,163,74,.12); border-left:6px solid rgba(22,163,74,.9); font-weight:900; }

    .live-block{ margin-top:12px; border:1px solid rgba(0,0,0,.08); border-radius:14px; overflow:hidden; background:#fff; }
    .live-summary{ font-weight:900; padding:14px 16px; background:#f1f5f9; }
    .live-links{padding:14px 12px;}
    .badge-role{ display:inline-flex; align-items:center; padding:2px 10px; border-radius:999px; font-size:12px; font-weight:900; margin-left:8px; border:1px solid rgba(0,0,0,.08); white-space:nowrap; }
    .role-eleve{background:rgba(245,158,11,.18); color:#a16207;}
    .role-prof{background:rgba(59,130,246,.18); color:#1d4ed8;}

    .menu-overlay{ display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); backdrop-filter:blur(2px); z-index:999; }
    .menu-btn{ display:none; border:none; background:#0f172a; color:#fff; width:44px; height:44px; border-radius:12px; font-size:20px; font-weight:900; cursor:pointer; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,.18); flex-shrink:0; }
    body.menu-open .sidebar{transform:translateX(0);}
    body.menu-open .menu-overlay{display:block;}
    .close-sidebar-btn { display: none; }

    @media(max-width:980px){
      body{height:auto; overflow:auto; display:block;}
      .sidebar{ position:fixed; top:0; left:0; bottom:0; height:100vh; width:min(86vw,340px); transform:translateX(-110%); transition:transform .25s ease; z-index:1000; padding:18px; }
      .main-content{padding:16px; min-height:100vh; overflow:visible;}
      header{align-items:center; gap:12px; margin-bottom:16px; padding-bottom:14px;}
      h1{font-size:1.35rem;}
      .clock-time{font-size:1.15rem;}
      .menu-btn{display:inline-flex;}
      .dashboard-grid{grid-template-columns:1fr; gap:14px;}
      .widget{min-height:auto; padding:16px; border-radius:14px;}
      .quick-actions{grid-template-columns:1fr;}
      .btn-quick{padding:14px;}
      .content-links{padding:12px; gap:8px;}
      .btn-yellow,.btn-blue-outline{width:100%; justify-content:space-between;}
      .stats-overview { grid-template-columns: 1fr; }
      .close-sidebar-btn { display: block; position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 24px; cursor: pointer; z-index: 1002; padding: 5px; }
    }

    .col-left { flex: 1; display: flex; flex-direction: column; gap: 20px; }
    .col-right { flex: 1; background: #fff; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; height: fit-content; }
    .grid-acts { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .act-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; font-weight: 600; text-align: center; background: #fff; transition: 0.2s; font-size: 0.9rem; }
    .act-btn:hover { background: #f8fafc; }
    .act-btn.active { border-color: #db2777; background: #fff0f6; color: #db2777; }
    .lib-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
    .lib-item { padding: 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
    .lib-item:hover { background: #f0f9ff; }
    .tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-right: 8px; letter-spacing: 0.5px; }
    .tag-poll { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
    .tag-quiz { background: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd; }
    .tag-cloud { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
    .option-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
  </style>
</head>
<body>

  <div id="modalStudent" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <h2 id="modal-name" style="margin:0; color:#0f172a;">Ã‰lÃ¨ve</h2>
          <span id="modal-class" style="color:#64748b; font-weight:500;">Classe</span>
        </div>
        <button class="close-modal" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div>
          <div style="display:flex; gap:15px; margin-bottom:20px;">
            <div class="stat-box" style="flex:1;">
              <span class="stat-val" id="modal-avg">--/20</span>
              <span class="stat-label">Moyenne</span>
            </div>
            <div class="stat-box" style="flex:1;">
              <span class="stat-val" id="modal-time">--</span>
              <span class="stat-label">Temps Moyen</span>
            </div>
          </div>
          <div style="height:300px;">
            <canvas id="studentRadar"></canvas>
          </div>
        </div>
        <div>
          <h3 style="margin-top:0;">Historique des activitÃ©s</h3>
          <table class="results-table">
            <thead><tr><th>Date</th><th>Exercice</th><th>Note</th></tr></thead>
            <tbody id="modal-history"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="modalStats" class="modal-overlay" onclick="closeStatModal()">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 id="stats-title" style="margin:0;">DÃ©tails</h2>
        <button class="close-modal" onclick="closeStatModal()">Ã—</button>
      </div>
      <div class="modal-body" style="display: block;">
        <div class="detail-modal-content">
          <canvas id="statsChart" style="max-height: 300px; display:none;"></canvas>
          <div id="statsList" style="overflow-y:auto; flex:1;"></div>
        </div>
      </div>
    </div>
  </div>

  <nav class="sidebar" id="mySidebar">
    <button class="close-sidebar-btn" onclick="closeMenu()">âœ•</button>
    
    <div class="brand">ğŸš€ COCKPIT</div>
    <div class="nav-item active" onclick="showView('dashboard', this)">ğŸ  Tableau de bord</div>
    <div class="nav-category">Mes dossiers</div>
    <div class="nav-item" data-theme="pedago" onclick="showView('view-pedago', this)">ğŸŸ¦ 1. PÃ©dagogie & cours</div>
    <div class="nav-item" data-theme="notes" onclick="showView('view-notes', this)">ğŸŸ¨ 2. RÃ‰DACTION / NOTES</div>
    <div class="nav-item" data-theme="eval" onclick="showView('view-eval', this)">ğŸŸ¨ 3. Ã‰valuation & suivi</div>
    <div class="nav-item" data-theme="eval" onclick="showView('view-scores', this)">ğŸŸ¨ 4. Scores exercices</div>
    <div class="nav-item" data-theme="admin" onclick="showView('view-trafic', this)">ğŸš¦ 5. Trafic (monitoring)</div>
    <div class="nav-item" data-theme="class" onclick="showView('view-class', this)">ğŸŸ© 6. Classes & groupes</div>
    <div class="nav-item" data-theme="proj" onclick="showView('view-proj', this)">ğŸŸª 7. Projets & transversal</div>
    <div class="nav-item" data-theme="admin" onclick="showView('view-admin', this)">ğŸŸ§ 8. Temps & admin</div>
    <div class="nav-item" data-theme="live" onclick="showView('view-live', this)">ğŸŸ« 9. Classe en temps rÃ©el</div>
    <div class="nav-category" style="margin-top:15px; color:#db2777;">ANIMATION</div>
    <div class="nav-item" data-theme="session" onclick="showView('view-sessions', this)" 
         style="border-left: 4px solid #db2777; color:#fff; background:linear-gradient(90deg, rgba(219,39,119,0.1) 0%, rgba(15,23,42,0) 100%);">
      ğŸ“¡ 8. Sessions & Sondages
    </div>
    <div class="nav-item" data-theme="sites" onclick="showView('view-sites', this)">ğŸŒ 7. Sites internet</div>
  </nav>

  <div id="menuOverlay" class="menu-overlay" onclick="closeMenu()"></div>

  <main class="main-content">
        <header>
            <button id="menuBtn" class="menu-btn" aria-label="Menu" onclick="toggleMenu()">â˜°</button>
            <h1 id="page-title">Tableau de Bord</h1>
            <div class="header-infos">
                <div id="authBadge" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:5px 10px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;"></div>
                <div class="clock-time" id="clock">--:--</div>
                <div class="clock-date" id="date">--</div>
                <div id="vacation-badge" class="vacation-badge" style="display:none;"></div>
                <div id="inboxBadge" title="Nouvelles copies" style="display:none;min-width:24px;height:24px;padding:0 8px;border-radius:999px;background:#111827;color:#fff;font-weight:900;font-size:12px;align-items:center;justify-content:center;"></div>
            </div>
        </header>

        <div id="dashboard" class="view-section active">
            <div class="quick-actions">
                <a href="prof_plan.html" target="_blank" class="btn-quick"><span>ğŸª‘</span><div><strong>Plan de Classe</strong><span>Piloter les places</span></div></a>
                <a href="suivi-complet.html" target="_blank" class="btn-quick" style="border-color:#22c55e;"><span>ğŸ“Š</span><div><strong>Suivi Complet</strong><span>Notes, sÃ©ances & consultations</span></div></a>
                <a href="bilans-eleves.html" target="_blank" class="btn-quick" style="border-color:#10b981; background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.05));"><span>ğŸ“‹</span><div><strong>Bilans Ã‰lÃ¨ves</strong><span>Auto-Ã©valuations hebdo</span></div></a>
                <a href="https://www.pronote.index-education.net/" target="_blank" class="btn-quick"><span>ğŸ“</span><div><strong>Pronote Web</strong><span>AccÃ¨s direct</span></div></a>
                <button onclick="document.getElementById('memo-input').focus()" class="btn-quick"><span>ğŸ§ </span><div><strong>MÃ©mo CiblÃ©</strong><span>Rappel contextuel</span></div></button>
                <button onclick="ouvrirModalEleves()" class="btn-quick" style="border-color:#8b5cf6; background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(124,58,237,0.05));">
                    <span>ğŸ‘¤</span>
                    <div>
                        <strong>Mes Ã©lÃ¨ves</strong>
                        <span>Voir les noms (RGPD)</span>
                    </div>
                </button>
            </div>
            <div class="dashboard-grid">
                <div class="widget">
                    <h3>ğŸ“… Planning <div style="font-size:0.8rem;"><button onclick="changeDate(-1)">â—€</button> <span id="planning-date-label">...</span> <button onclick="changeDate(1)">â–¶</button> <button onclick="openTimelineDashboard()" title="Timeline" style="margin-left:8px;background:#0f172a;color:white;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;">Timeline</button></div></h3>
                    <ul class="planning-list" id="planning-list"></ul>
                </div>
                <div class="right-stack">
                    <div class="widget memo-widget">
                        <h3>ğŸ’¡ Pense-BÃªte Contextuel</h3>
                        <div style="display:flex;gap:5px;margin-bottom:15px;">
                            <select id="memo-target" style="padding:8px;border-radius:6px;border:1px solid #ddd;"></select>
                            <input id="memo-input" style="flex-grow:1;padding:8px;border-radius:6px;border:1px solid #ddd;" placeholder="Note...">
                            <button onclick="addMemo()" style="background:#0f172a;color:white;border:none;padding:8px 15px;border-radius:6px;">+</button>
                        </div>
                        <ul class="alert-list" id="memo-list"></ul>
                    </div>
            
                    <div class="widget agenda-widget">
                        <h3>ğŸ—“ï¸ Agenda</h3>
                        <div class="agenda-form">
                            <select id="agenda-type">
                                <option value="RÃ©union">RÃ©union</option>
                                <option value="Parents">Parents</option>
                                <option value="Admin">Admin</option>
                                <option value="Personnel">Personnel</option>
                                <option value="Classe">Classe</option>
                                <option value="Autre">Autre</option>
                            </select>
                            <input id="agenda-date" type="date" aria-label="Date">
                            <input id="agenda-time" type="time" aria-label="Heure">
                        </div>
                        <div class="agenda-form">
                            <input id="agenda-title" class="wide" placeholder="Titre (rÃ©union, rdv...)" aria-label="Titre">
                            <input id="agenda-place" class="wide" placeholder="Lieu (optionnel)" aria-label="Lieu">
                            <button onclick="addAgenda()" style="background:#0f172a;color:white;border:none;padding:8px 15px;border-radius:6px;">+</button>
                        </div>
                        <ul class="agenda-list" id="agenda-list"></ul>
                    </div>
                </div>
            </div>
        </div>

    <section id="view-scores" class="view-section">
      <h2 style="color:var(--col-eval);">Suivi des CompÃ©tences & Notes</h2>
      
      <div class="stats-overview">
        <div class="stat-card" onclick="showStatDetails('views')">
          <div class="stat-icon icon-blue">ğŸ‘€</div>
          <div class="stat-info"><h4>Trafic Total</h4><p id="stat-total-views">0</p></div>
        </div>
        <div class="stat-card" onclick="showStatDetails('devices')">
          <div class="stat-icon icon-purple">ğŸ“±</div>
          <div class="stat-info"><h4>Supports</h4><p id="stat-device" style="font-size:1rem; font-weight:600;">--</p></div>
        </div>
        <div class="stat-card" onclick="showStatDetails('exercices')">
          <div class="stat-icon icon-green">ğŸ†</div>
          <div class="stat-info"><h4>Top Exercice</h4><p id="stat-top-page" style="font-size:1rem; font-weight:600;">--</p></div>
        </div>
      </div>

      <div class="dashboard-grid">
          <div class="widget">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span><strong>DerniÃ¨res Ã©valuations reÃ§ues</strong></span>
                <button onclick="chargerDonnees()" style="padding:8px 15px; cursor:pointer; background:#f1f5f9; border:1px solid #ccc; border-radius:20px;">ğŸ”„ Actualiser</button>
            </div>

            <div class="toolbar">
              <select id="filter-class" class="filter-select" onchange="applyFilters()">
                <option value="ALL">Toutes les classes</option>
              </select>
              <input type="text" id="filter-student" class="filter-input" placeholder="ğŸ” Chercher un Ã©lÃ¨ve..." onkeyup="applyFilters()">
              <select id="filter-exercice" class="filter-select" onchange="applyFilters()">
                <option value="ALL">Tous les exercices</option>
              </select>
              <select id="filter-statut" class="filter-select" onchange="applyFilters()">
                <option value="ALL">Tous les statuts</option>
                <option value="A_CORRIGER">ğŸ“ Ã€ corriger</option>
                <option value="CORRIGES">âœ… CorrigÃ©s</option>
                <option value="NON_NOTE">âš ï¸ Non notÃ©s</option>
              </select>
            </div>

            <div style="overflow-x:auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th onclick="sortData('date')">Date â†•</th>
                            <th onclick="sortData('identifiant')">Ã‰lÃ¨ve â†•</th>
                            <th onclick="sortData('classe')">Classe â†•</th>
                            <th onclick="sortData('exercice_titre')">Exercice â†•</th>
                            <th onclick="sortData('note_finale')">Note â†•</th>
                            <th onclick="sortTable('collages')">ğŸ“‹ â†•</th>
                            <th title="L'Ã©lÃ¨ve a-t-il lu sa copie ?">ğŸ‘ï¸</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-eleves">
                        <tr><td colspan="8" class="scores-empty">Chargement automatique...</td></tr>
                    </tbody>
                </table>
            </div>
          </div>

          <div class="widget">
              <h3>ğŸ“Š Radar Moyen (FiltrÃ©)</h3>
              <div class="radar-container"><canvas id="radarChart"></canvas></div>
              <div style="text-align:center; margin-top:15px;">Moyenne : <strong id="moyenne-globale" style="color:#3b82f6; font-size:1.3rem;">--</strong></div>
          </div>
      </div>
    </section>

    <section id="view-trafic" class="view-section">
      <h2 style="color:var(--col-admin);">Trafic (monitoring)</h2>
      <div class="widget" style="min-height:auto; text-align:center; padding:60px 40px;">
        <div style="font-size:4rem; margin-bottom:20px; animation: pulse 2s infinite;">ğŸ“Š</div>
        <h3 style="border:none; font-size:1.5rem; color:#0f172a; margin-bottom:15px; justify-content:center;">Le suivi du trafic est maintenant sur Google Analytics</h3>
        <p style="color:#64748b; font-size:1rem; max-width:500px; margin:0 auto 30px; line-height:1.6;">Consultez vos statistiques de visites directement sur Google Analytics.</p>
        <a href="https://analytics.google.com/analytics/web/#/p518029608/reports/intelligenthome" target="_blank" style="display:inline-flex; align-items:center; gap:12px; padding:16px 32px; background:linear-gradient(135deg, #f97316, #ea580c); color:white; text-decoration:none; border-radius:12px; font-weight:700; font-size:1.1rem; box-shadow:0 4px 15px rgba(249,115,22,0.4);">Ouvrir Google Analytics</a>
        <p style="margin-top:30px; font-size:0.85rem; color:#94a3b8;">ğŸ’¡ ID de mesure : G-7R9N0JL6GG</p>
      </div>
      <style>@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }</style>
    </section>

    <section id="view-pedago" class="view-section">
      <h2 style="color:var(--col-pedago);">PÃ©dagogie & cours</h2>
      <details open>
        <summary>ğŸ“ SÃ©quences CAP</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
          <a href="test_bacpro.html" target="_blank" class="btn-yellow">ğŸ“„ Test Bac Pro (QQOQCP)</a>
          <a href="#" class="btn-yellow">ğŸ“ Exercices <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div>
      </details>
      <details>
        <summary>ğŸ“ SÃ©quences BAC PRO</summary>
        <div class="content-links">
          <a href="#" class="btn-yellow">ğŸ“„ Cours <span class="badge-soon">ğŸš§ BientÃ´t</span></a>
        </div>
      </details>
      <details id="course-structure">
        <summary>ğŸ“š Cours CAP & Bac Pro (structure)</summary>
        <details class="lvl-cap">
          <summary>CAP</summary>
          <details><summary>ThÃ©matique A â€“ L'individu et sa santÃ©</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Modules A1-A7</a></div></details>
          <details><summary>ThÃ©matique B â€“ L'environnement</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Modules B1-B4</a></div></details>
          <details><summary>ThÃ©matique C â€“ Milieu professionnel</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Modules C1-C8</a></div></details>
          <details><summary>ThÃ©matique D â€“ Consommateur</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ Modules D1-D3</a></div></details>
        </details>
        <details class="lvl-bacpro">
          <summary>Bac Pro</summary>
          <details><summary>Seconde Bac Pro</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ ThÃ©matiques A, B, C</a></div></details>
          <details><summary>PremiÃ¨re Bac Pro</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ ThÃ©matiques A, B, C</a></div></details>
          <details><summary>Terminale Bac Pro</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ“„ ThÃ©matiques A, B, C</a></div></details>
        </details>
      </details>
    </section>

    <section id="view-notes" class="view-section" style="height:100%;">
      <div style="display:flex; flex-direction:column; height:100%;">
        <h2 style="color:var(--col-notes); border-bottom: 2px solid var(--col-notes); padding-bottom:10px; margin-top:0;">ğŸ“’ Atelier de RÃ©daction</h2>
        <iframe src="notes.html" style="flex:1; width:100%; border:none; border-radius:12px; background:#fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05);"></iframe>
      </div>
    </section> 

    <section id="view-eval" class="view-section">
      <h2 style="color:var(--col-eval);">Ã‰valuation & suivi</h2>
      <details open><summary>ğŸ“Š PageProf & suivis</summary><div class="content-links"><a href="pageprof.html" target="_blank" class="btn-yellow">ğŸ“Š Ouvrir PageProf</a></div></details>
      <details><summary>ğŸ“‚ Historique & exports</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ—“ï¸ Bilans <span class="badge-soon">BientÃ´t</span></a></div></details>
      <details><summary>ğŸ§¹ Maintenance</summary><div class="content-links"><a href="nettoyage-doublons.html" target="_blank" class="btn-yellow">ğŸ§¹ Nettoyage doublons</a></div></details>
    </section>

    <section id="view-class" class="view-section">
      <h2 style="color:var(--col-class);">Classes & groupes</h2>
      <details open><summary>ğŸª‘ Plans de classe</summary><div class="content-links"><a href="prof_plan.html" target="_blank" class="btn-yellow">ğŸš€ Piloter</a><button class="btn-blue-outline" type="button" onclick="window.open('ecran_plan.html','proj')">ğŸ“º Afficher au tableau</button></div></details>
      <details><summary>ğŸ“‹ Listes d'Ã©lÃ¨ves</summary><div class="content-links"><a href="#" class="btn-yellow">ğŸ‘¥ Listes <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-proj" class="view-section">
      <h2 style="color:var(--col-proj);">Projets & transversal</h2>
      <details open><summary>ğŸ¨ Chef-d'Å“uvre</summary><div class="content-links"><a href="#" class="btn-yellow">CAP 1re annÃ©e <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-admin" class="view-section">
      <h2 style="color:var(--col-admin);">Temps & institution</h2>
      <details open><summary>ğŸ“… Emploi du temps</summary><div class="content-links"><a href="#" class="btn-yellow">Vue semaine <span class="badge-soon">BientÃ´t</span></a></div></details>
    </section>

    <section id="view-live" class="view-section">
      <h2 style="color:var(--col-live-web);">Classe en temps rÃ©el</h2>
      <details class="live-block" open>
        <summary class="live-summary">ğŸ—¨ï¸ S'exprimer / Explorer</summary>
        <div class="content-links live-links">
          <a href="eleve_nuage.html" class="btn btn-yellow">ğŸŒ¥ï¸ Nuage de mots <span class="badge-role role-eleve">Ã‰lÃ¨ves</span></a>
          <a href="prof_nuage.html" class="btn btn-yellow">â˜ï¸ Nuage <span class="badge-role role-prof">Prof</span></a>
          <a href="eleve_meteo.html" class="btn btn-yellow">ğŸ§  Ma mÃ©tÃ©o <span class="badge-role role-eleve">Ã‰lÃ¨ves</span></a>
          <a href="prof_meteo.html" class="btn btn-yellow">ğŸ§  MÃ©tÃ©o <span class="badge-role role-prof">Prof</span></a>
          <a href="ecran_classe.html" class="btn btn-blue-outline">ğŸ“º Ã‰cran Classe <span class="badge-role role-prof">Prof</span></a>
        </div>
      </details>
      <details class="live-block">
        <summary class="live-summary">ğŸ¤ Travail collaboratif</summary>
        <div class="content-links live-links">
          <a href="prof_mindmap.html" class="btn btn-yellow">ğŸ—£ï¸ Carte mentale collective</a>
          <a href="prof_qqoqcp.html" class="btn btn-yellow">ğŸ—£ï¸ QQOQCP</a>
          <a href="prof_ishikawa.html" class="btn btn-yellow">ğŸ—£ï¸ Ishikawa</a>
        </div>
      </details>
    </section>

    <section id="view-sessions" class="view-section">
      <h2 style="color:#db2777; border-bottom: 2px solid #db2777; padding-bottom:10px;">ğŸ“¡ Gestionnaire & BibliothÃ¨que</h2>
      <div class="dashboard-grid">
        <div class="col-left">
            <div class="widget">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #f1f5f9; margin-bottom: 15px; padding-bottom: 10px;">
                    <h3 style="margin:0; border:none; padding:0;">âœ¨ DÃ©marrer une session</h3>
                    <a href="cafe_wall.html" target="_blank" class="btn-blue-outline" style="text-decoration:none; font-size:0.85rem; padding: 6px 12px;">ğŸ–¥ï¸ Ouvrir l'Ã‰cran GÃ©ant</a>
                </div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="session-title-input" placeholder="Titre (ex: CafÃ© du 12 Janvier)" style="flex:1; padding:12px; border-radius:8px; border:1px solid #cbd5e1; font-weight:bold;">
                    <button onclick="createNewSession()" style="background:#db2777; color:white; border:none; padding:0 20px; border-radius:8px; font-weight:bold; cursor:pointer;">Lancer ğŸš€</button>
                </div>
                <div id="session-info" style="display:none; margin-top:10px; color:#16a34a; font-weight:bold; font-size:0.9rem;">âœ… Session active : <span id="current-session-name">...</span></div>
            </div>
            <div id="live-panel" style="display:none; background:#fff; border:2px solid #db2777; border-radius:12px; padding:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; color:#db2777;">ğŸ”´ EN DIRECT</h3>
                    <button onclick="stopSession()" style="background:#fff; color:#64748b; border:1px solid #cbd5e1; padding:5px 10px; border-radius:6px; cursor:pointer;">â¹ Stop</button>
                </div>
                <div class="grid-acts">
                    <div class="act-btn" onclick="setMode('meteo')">ğŸ˜ MÃ©tÃ©o</div>
                    <div class="act-btn" onclick="setMode('nuage')">â˜ï¸ Nuage</div>
                    <div class="act-btn" onclick="setMode('sondage')">ğŸ“Š Sondage</div>
                    <div class="act-btn" onclick="setMode('quiz')">ğŸ† Quiz</div>
                </div>
                <div id="config-zone" style="background:#f8fafc; padding:15px; border-radius:8px; min-height:80px; display:flex; align-items:center; justify-content:center;">
                    <p style="text-align:center; color:#94a3b8; margin:0;">ğŸ‘ˆ SÃ©lectionnez une activitÃ©</p>
                </div>
                <div id="quiz-controls" style="display:none; margin-top:10px; padding-top:10px; border-top:1px solid #db2777;">
                    <div style="display:flex; gap:10px;">
                        <button onclick="revealQuiz()" style="flex:1; background:#db2777; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ‘€ RÃ©vÃ©ler</button>
                        <button onclick="resetQuiz()" style="flex:1; background:white; color:#db2777; border:1px solid #db2777; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ”„ Re-Voter</button>
                    </div>
                </div>
            </div>
            <div class="widget"><h3>ğŸ—‚ï¸ Archives</h3><div id="history-list" style="max-height:150px; overflow-y:auto; font-size:0.85rem;">Chargement...</div></div>
        </div>
        <div class="col-right">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:#0f172a;">ğŸ“š BibliothÃ¨que</h3>
                <button onclick="toggleCreator()" style="background:#f1f5f9; border:1px solid #cbd5e1; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.8rem;">+ CrÃ©er</button>
            </div>
            <div id="creator-panel" style="display:none; background:#f0f9ff; padding:15px; border-radius:8px; margin-bottom:20px;">
                <input type="hidden" id="edit-id">
                <label style="font-size:0.75rem; font-weight:bold; color:#0369a1;">TYPE :</label>
                <select id="create-type" onchange="updateCreatorForm()" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom:10px;">
                    <option value="poll">ğŸ“Š Sondage</option>
                    <option value="quiz">ğŸ† Quiz</option>
                    <option value="cloud">â˜ï¸ Nuage</option>
                </select>
                <input type="text" id="create-title" placeholder="Titre" style="width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #cbd5e1; box-sizing:border-box;">
                <input type="text" id="create-question" placeholder="Question" style="width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #cbd5e1; box-sizing:border-box;">
                <div id="options-container"></div>
                <button onclick="addOptionInput()" style="width:100%; margin-bottom:10px; background:white; border:1px dashed #cbd5e1; padding:5px; border-radius:6px; cursor:pointer; color:#64748b;">+ Option</button>
                <button onclick="saveToLibrary()" style="width:100%; padding:10px; background:#0369a1; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ’¾ Enregistrer</button>
            </div>
            <ul id="library-list" class="lib-list"><li style="text-align:center; color:#94a3b8; padding:20px;">Chargement...</li></ul>
        </div>
      </div>
    </section>

    <section id="view-sites" class="view-section">
      <h2 style="color:var(--col-sites);">Sites internet favoris</h2>
      <details open><summary>ğŸ¢ Administratif</summary><div class="content-links"><a href="https://portail.ac-lyon.fr/" class="btn-yellow" target="_blank">Portail AcadÃ©mie</a><a href="https://eduscol.education.fr/" class="btn-yellow" target="_blank">Eduscol</a><a href="https://cas.ent.auvergnerhonealpes.fr" class="btn-yellow" target="_blank">ENT / Mail pro</a></div></details>
      <details><summary>ğŸ“š Ressources pÃ©dagogiques</summary><div class="content-links"><a href="https://www.inrs.fr/" class="btn-yellow" target="_blank">INRS</a><a href="https://www.santepubliquefrance.fr/" class="btn-yellow" target="_blank">SantÃ© Publique France</a></div></details>
    </section>
  </main>

  <!-- â­â­â­ MODALE MES Ã‰LÃˆVES â­â­â­ -->
  <div id="modalEleves" class="modal-overlay" onclick="if(event.target===this) fermerModalEleves()">
    <div class="modal-card" style="max-width: 700px;" onclick="event.stopPropagation()">
      <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
        <div>
          <h2 style="margin:0; color:white;">ğŸ‘¤ Mes Ã©lÃ¨ves</h2>
          <span style="color:rgba(255,255,255,0.8); font-weight:500;" id="nbElevesCharges">0 Ã©lÃ¨ves chargÃ©s</span>
        </div>
        <button class="close-modal" onclick="fermerModalEleves()" style="color:white;">Ã—</button>
      </div>
      <div class="modal-body" style="display: block; padding: 20px;">
        
        <!-- Zone si pas d'Ã©lÃ¨ves -->
        <div id="zoneImportEleves" style="text-align:center; padding: 30px;">
          <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ“</div>
          <h3 style="margin-bottom: 15px; color: #1e293b;">Aucun fichier Ã©lÃ¨ves chargÃ©</h3>
          <p style="color: #64748b; margin-bottom: 20px; line-height: 1.6;">
            Pour voir les noms de tes Ã©lÃ¨ves Ã  cÃ´tÃ© de leurs codes,<br>
            importe ton fichier CSV.
          </p>
          <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
            <strong>Format attendu :</strong>
            <pre style="background: #1e293b; color: #22c55e; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.85rem;">LX11,Sarah TRABELSI
HK47,Amelia KAMBEMBA
QN80,Wael HWORI</pre>
          </div>
          <label style="display: inline-block; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 1.1rem;">
            ğŸ“ Importer mon fichier
            <input type="file" id="inputImportEleves" accept=".csv,.txt" style="display:none;" onchange="importerFichierEleves(event)">
          </label>
          <p style="margin-top: 15px; font-size: 0.85rem; color: #94a3b8;">
            ğŸ”’ Le fichier reste sur cet appareil uniquement (RGPD)
          </p>
        </div>
        
        <!-- Zone liste Ã©lÃ¨ves -->
        <div id="zoneListeEleves" style="display:none;">
          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <input type="text" id="rechercheEleve" placeholder="ğŸ” Rechercher un Ã©lÃ¨ve..." 
                   style="flex: 1; min-width: 200px; padding: 10px 15px; border: 1px solid #e2e8f0; border-radius: 8px;"
                   oninput="filtrerListeEleves()">
            <button onclick="ajouterEleveManuel()" style="background: #22c55e; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">â• Ajouter</button>
            <button onclick="exporterFichierEleves()" style="background: #3b82f6; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ“¥ Exporter</button>
            <label style="background: #f59e0b; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-block;">
              ğŸ“ RÃ©importer
              <input type="file" accept=".csv,.txt" style="display:none;" onchange="importerFichierEleves(event)">
            </label>
            <button onclick="if(confirm('Supprimer tous les Ã©lÃ¨ves ?')) supprimerTousEleves()" style="background: #ef4444; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ—‘ï¸</button>
          </div>
          
          <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 12px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="background: #f8fafc; position: sticky; top: 0;">
                <tr>
                  <th style="padding: 12px 15px; text-align: left; font-weight: 600; color: #64748b; border-bottom: 2px solid #e2e8f0;">CODE</th>
                  <th style="padding: 12px 15px; text-align: left; font-weight: 600; color: #64748b; border-bottom: 2px solid #e2e8f0;">NOM</th>
                  <th style="padding: 12px 15px; text-align: center; font-weight: 600; color: #64748b; border-bottom: 2px solid #e2e8f0; width: 80px;">ACTION</th>
                </tr>
              </thead>
              <tbody id="tbodyEleves"></tbody>
            </table>
          </div>
          <p style="margin-top: 15px; font-size: 0.85rem; color: #94a3b8; text-align: center;">ğŸ”’ Ces donnÃ©es restent uniquement sur cet appareil (RGPD)</p>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALE AJOUT Ã‰LÃˆVE -->
  <div id="modalAjoutEleve" class="modal-overlay" style="display:none; z-index: 2100;" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-card" style="max-width: 400px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 style="margin:0;">â• Ajouter un Ã©lÃ¨ve</h2>
        <button class="close-modal" onclick="document.getElementById('modalAjoutEleve').style.display='none'">Ã—</button>
      </div>
      <div class="modal-body" style="display: block;">
        <div style="margin-bottom: 15px;">
          <label style="font-weight: 600; display: block; margin-bottom: 5px;">Code Ã©lÃ¨ve :</label>
          <input type="text" id="inputNouveauCode" placeholder="Ex: AB12" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1.1rem; text-transform: uppercase;">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="font-weight: 600; display: block; margin-bottom: 5px;">Nom complet :</label>
          <input type="text" id="inputNouveauNom" placeholder="Ex: Dupont Marie" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1.1rem;">
        </div>
        <button onclick="sauvegarderNouvelEleve()" style="width: 100%; background: #22c55e; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer;">âœ… Enregistrer</button>
      </div>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // JAVASCRIPT DE BASE (Horloge, Planning, Agenda, Memos, Menu)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function updateClock(){ const d=new Date(); document.getElementById("clock").innerText=d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0'); document.getElementById("date").innerText=d.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"}); }
    setInterval(updateClock,1000); updateClock();
    
    let planningOffset = 0; 
    const planningData = [ {time:"08h30",label:"CAP â€“ PSE",room:"Salle 12"}, {time:"10h00",label:"Bac Pro â€“ PSE",room:"Salle 14"}, {time:"13h30",label:"Accompagnement perso",room:"CDI"} ];
    function renderPlanning(){ const list = document.getElementById("planning-list"); const date = new Date(); date.setDate(date.getDate()+planningOffset); document.getElementById("planning-date-label").textContent = date.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"2-digit"}); list.innerHTML = ""; planningData.forEach(c=>{ list.innerHTML += `<li class="course-item"><div class="course-time">${c.time}</div><div class="course-details"><strong>${c.label}</strong><br><small>${c.room}</small></div></li>`; }); }
    function changeDate(delta){planningOffset+=delta;renderPlanning();} 
    renderPlanning();
    
    function save(key,value){localStorage.setItem(key,JSON.stringify(value));} 
    function load(key,def){try{const v=JSON.parse(localStorage.getItem(key));return v??def;}catch(e){return def;}}
    
    let memos = load("cockpit_memos",[]);
    
    function fillMemoTarget() {
        const select = document.getElementById("memo-target");
        if (!select) return;
        const sections = [
            {id: "dashboard", label: "Tableau de bord"},
            {id: "view-scores", label: "Scores exercices"},
            {id: "view-trafic", label: "Trafic"},
            {id: "view-pedago", label: "PÃ©dagogie"},
            {id: "view-notes", label: "RÃ©daction"},
            {id: "view-eval", label: "Ã‰valuation"},
            {id: "view-class", label: "Classes"},
            {id: "view-proj", label: "Projets"},
            {id: "view-admin", label: "Admin"},
            {id: "view-live", label: "Temps rÃ©el"},
            {id: "view-sessions", label: "Sessions"},
            {id: "view-sites", label: "Sites"}
        ];
        select.innerHTML = '';
        sections.forEach(section => {
            const option = document.createElement("option");
            option.value = section.id;
            option.textContent = section.label;
            select.appendChild(option);
        });
    }
    
    function renderMemos(){ const ul = document.getElementById("memo-list"); ul.innerHTML = ""; const current = document.querySelector(".view-section.active")?.id || "dashboard"; memos.forEach((m,i)=>{ ul.innerHTML += `<li class="alert-item${m.target===current?" context-active":""}"><span>${m.text}<br><small>${m.target}</small></span><button type="button" onclick="deleteMemo(${i})">âœ•</button></li>`; }); }
    function addMemo(){ const t=document.getElementById("memo-target").value, v=document.getElementById("memo-input").value.trim(); if(v){ memos.push({target:t,text:v}); save("cockpit_memos",memos); document.getElementById("memo-input").value=""; renderMemos(); } }
    function deleteMemo(i){ memos.splice(i,1); save("cockpit_memos",memos); renderMemos(); }
    
    let agenda = load("cockpit_agenda",[]);
    function renderAgenda(){ const ul = document.getElementById("agenda-list"); ul.innerHTML=""; const now=new Date(); agenda.sort((a,b)=>new Date(a.when)-new Date(b.when)); agenda.forEach((ev,i)=>{ const d=new Date(ev.when), soon=(d-now)<7*24*3600*1000 && d>now; ul.innerHTML += `<li class="agenda-item${soon?" soon":""}"><div><strong>${ev.title}</strong><div class="agenda-meta">${d.toLocaleDateString("fr-FR")} â€¢ ${ev.type}</div></div><button type="button" onclick="deleteAgenda(${i})">âœ•</button></li>`; }); }
    function addAgenda(){ const type=document.getElementById("agenda-type").value, date=document.getElementById("agenda-date").value, title=document.getElementById("agenda-title").value.trim(); if(date&&title){ agenda.push({type,title,place:document.getElementById("agenda-place").value,when:new Date(date+"T"+(document.getElementById("agenda-time").value||"08:00"))}); save("cockpit_agenda",agenda); renderAgenda(); } }
    function deleteAgenda(i){ agenda.splice(i,1); save("cockpit_agenda",agenda); renderAgenda(); }
    
    function toggleMenu(){document.body.classList.toggle("menu-open");} 
    function closeMenu(){document.body.classList.remove("menu-open");}
    function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    function openTimelineDashboard() { alert("Timeline - FonctionnalitÃ© Ã  venir"); }
    
    fillMemoTarget();
    renderMemos(); 
    renderAgenda();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â­â­â­ MODULE "MES Ã‰LÃˆVES" - Correspondance code â†’ nom (100% RGPD) â­â­â­
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const CLE_ELEVES = 'cockpit_eleves_noms';

    window.getNomEleve = function(code) {
        if (!code) return null;
        const eleves = JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}');
        return eleves[code.toUpperCase()] || null;
    };

    window.afficherAvecNom = function(code) {
        if (!code) return code || '';
        const nom = window.getNomEleve(code);
        return nom ? `${code} (${nom})` : code;
    };

    window.hasElevesCharges = function() {
        return Object.keys(JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}')).length > 0;
    };

    window.getTousLesEleves = function() {
        return JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}');
    };

    window.getNbElevesCharges = function() {
        return Object.keys(window.getTousLesEleves()).length;
    };

    window.ouvrirModalEleves = function() {
        document.getElementById('modalEleves').classList.add('open');
        rafraichirListeEleves();
    };

    window.fermerModalEleves = function() {
        document.getElementById('modalEleves').classList.remove('open');
    };

    window.rafraichirListeEleves = function() {
        const eleves = window.getTousLesEleves();
        const nbEleves = Object.keys(eleves).length;
        
        document.getElementById('nbElevesCharges').textContent = nbEleves + ' Ã©lÃ¨ve' + (nbEleves > 1 ? 's' : '') + ' chargÃ©' + (nbEleves > 1 ? 's' : '');
        
        if (nbEleves === 0) {
            document.getElementById('zoneImportEleves').style.display = 'block';
            document.getElementById('zoneListeEleves').style.display = 'none';
        } else {
            document.getElementById('zoneImportEleves').style.display = 'none';
            document.getElementById('zoneListeEleves').style.display = 'block';
            afficherTableauEleves(eleves);
        }
    };

    window.afficherTableauEleves = function(eleves, filtre = '') {
        const tbody = document.getElementById('tbodyEleves');
        tbody.innerHTML = '';
        const entries = Object.entries(eleves).sort((a, b) => a[1].localeCompare(b[1]));
        const filtreMin = filtre.toLowerCase();
        
        entries.forEach(([code, nom]) => {
            if (filtre && !code.toLowerCase().includes(filtreMin) && !nom.toLowerCase().includes(filtreMin)) return;
            tbody.innerHTML += `<tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 12px 15px; font-weight: 700; color: #3b82f6;">${code}</td>
                <td style="padding: 12px 15px;">${nom}</td>
                <td style="padding: 12px 15px; text-align: center;">
                    <button onclick="supprimerEleve('${code}')" style="background: #fee2e2; color: #991b1b; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer;">ğŸ—‘ï¸</button>
                </td>
            </tr>`;
        });
        if (!tbody.innerHTML) tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #94a3b8;">Aucun Ã©lÃ¨ve trouvÃ©</td></tr>';
    };

    window.filtrerListeEleves = function() {
        const input = document.getElementById('rechercheEleve');
        afficherTableauEleves(window.getTousLesEleves(), input ? input.value : '');
    };

    window.importerFichierEleves = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const lignes = e.target.result.split(/\r?\n/);
            const eleves = window.getTousLesEleves();
            let nb = 0;
            lignes.forEach(ligne => {
                ligne = ligne.trim();
                if (!ligne) return;
                const parts = ligne.split(/[,;]/);
                if (parts.length >= 2) {
                    const code = parts[0].trim().toUpperCase();
                    const nom = parts.slice(1).join(' ').trim();
                    if (code && nom) { eleves[code] = nom; nb++; }
                }
            });
            localStorage.setItem(CLE_ELEVES, JSON.stringify(eleves));
            rafraichirListeEleves();
            alert('âœ… ' + nb + ' Ã©lÃ¨ve(s) importÃ©(s) !');
        };
        reader.readAsText(file, 'UTF-8');
        event.target.value = '';
    };

    window.exporterFichierEleves = function() {
        const entries = Object.entries(window.getTousLesEleves()).sort((a, b) => a[1].localeCompare(b[1]));
        if (!entries.length) { alert('Aucun Ã©lÃ¨ve'); return; }
        let csv = entries.map(([c, n]) => c + ',' + n).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mes_eleves_' + new Date().toISOString().slice(0,10) + '.csv';
        a.click();
    };

    window.ajouterEleveManuel = function() {
        document.getElementById('inputNouveauCode').value = '';
        document.getElementById('inputNouveauNom').value = '';
        document.getElementById('modalAjoutEleve').style.display = 'flex';
    };

    window.sauvegarderNouvelEleve = function() {
        const code = document.getElementById('inputNouveauCode').value.trim().toUpperCase();
        const nom = document.getElementById('inputNouveauNom').value.trim();
        if (!code || !nom) { alert('Remplir les deux champs'); return; }
        const eleves = window.getTousLesEleves();
        eleves[code] = nom;
        localStorage.setItem(CLE_ELEVES, JSON.stringify(eleves));
        document.getElementById('modalAjoutEleve').style.display = 'none';
        rafraichirListeEleves();
    };

    window.supprimerEleve = function(code) {
        if (!confirm('Supprimer ' + code + ' ?')) return;
        const eleves = window.getTousLesEleves();
        delete eleves[code];
        localStorage.setItem(CLE_ELEVES, JSON.stringify(eleves));
        rafraichirListeEleves();
    };

    window.supprimerTousEleves = function() {
        localStorage.removeItem(CLE_ELEVES);
        rafraichirListeEleves();
    };

    // Auto-init au chargement
    setTimeout(rafraichirListeEleves, 100);
    console.log('âœ… Module "Mes Ã©lÃ¨ves" chargÃ© (' + window.getNbElevesCharges() + ' en mÃ©moire)');
  </script>

  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
      getFirestore, collection, collectionGroup, getDocs, getDoc, addDoc, setDoc, updateDoc, deleteDoc, doc,
      onSnapshot, query, orderBy, where, limit, Timestamp, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { 
      getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    let currentUser = null;
    
    // Connexion Google
    window.connexionProf = async function() {
      try {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
          await signInWithRedirect(auth, googleProvider);
        } else {
          const result = await signInWithPopup(auth, googleProvider);
          currentUser = result.user;
          alert("âœ… ConnectÃ©: " + currentUser.email);
          updateAuthUI();
        }
      } catch (error) {
        console.error("Erreur connexion:", error);
        alert("Erreur: " + error.message);
      }
    };
    
    window.deconnexionProf = async function() {
      await signOut(auth);
      currentUser = null;
      updateAuthUI();
    };
    
    function updateAuthUI() {
      const authBadge = document.getElementById("authBadge");
      if (authBadge) {
        if (currentUser) {
          authBadge.innerHTML = `<span style="color:#16a34a;">âœ… ${currentUser.email}</span> <button onclick="deconnexionProf()" style="margin-left:5px;padding:2px 8px;font-size:11px;cursor:pointer;">DÃ©co</button>`;
        } else {
          authBadge.innerHTML = `<button onclick="connexionProf()" style="background:#4285f4;color:white;border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-weight:bold;font-size:12px;">ğŸ” Connexion Prof</button>`;
        }
        authBadge.style.display = "flex";
      }
    }
    
    onAuthStateChanged(auth, (user) => { currentUser = user; updateAuthUI(); });
    getRedirectResult(auth).then((result) => { if (result?.user) { currentUser = result.user; updateAuthUI(); } }).catch(() => {});

    // Variables globales
    let currentSessionId = null; 
    let allData = []; 
    let filteredData = [];
    let statsDetails = { hourly: new Array(24).fill(0), devices: { Mobile: 0, Desktop: 0 }, pages: [] };
    let currentSort = { col: 'date', dir: 'desc' };
    let libraryData = [];

    // showView
    window.showView = function(viewId, navEl) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(viewId);
        if (target) target.classList.add('active');
        if (navEl) navEl.classList.add('active');
        const pageTitle = document.getElementById("page-title");
        if (pageTitle && navEl) pageTitle.textContent = navEl.textContent.replace(/[^a-zA-ZÃ€-Ã¿0-9\s]/g, '').trim();
        if (viewId === 'view-sessions' && typeof loadHistory === 'function') loadHistory();
        if (window.innerWidth <= 980) document.body.classList.remove('menu-open');
        if (typeof renderMemos === 'function') renderMemos();
    };

    // Badge collages
    function getPasteBadge(pasteStats) {
        if (!pasteStats) return '<span style="color:#9ca3af;">-</span>';
        const external = pasteStats.external || 0;
        if (external === 0) return '<span style="color:#10b981;">âœ“</span>';
        if (external <= 2) return `<span style="color:#f59e0b; font-weight:bold;">âš ï¸ ${external}</span>`;
        return `<span style="color:#ef4444; font-weight:bold;">ğŸš¨ ${external}</span>`;
    }

    // Charger donnÃ©es
    window.chargerDonnees = async function() {
        console.log("ğŸš€ Chargement des donnÃ©es...");
        
        function extractNote20(d){
            const candidates = [d?.note_finale, d?.resultat_auto?.score, d?.meta?.score, d?.score, d?.note];
            for (const c of candidates){
                if (c === 0) return 0;
                if (c === null || c === undefined) continue;
                if (typeof c === "number" && !isNaN(c)) return c;
                if (typeof c === "string"){ const m = c.match(/(\d+(?:[.,]\d+)?)/); if (m) return parseFloat(m[1].replace(",", ".")); }
            }
            return null;
        }
        
        try {
            const qCopies = query(collectionGroup(db, "copies"), limit(100));
            const snapCopies = await getDocs(qCopies);
            const copiesMap = new Map();
            
            snapCopies.forEach(docSnap => {
                const d = docSnap.data();
                const pathParts = docSnap.ref.path.split('/');
                const userCode = pathParts.length >= 2 ? pathParts[1] : (d.eleve?.userCode || d.userCode || null);
                const devoirId = d.devoirId || "unknown";
                copiesMap.set(`${devoirId}_${userCode}`, { docSnap, data: d, eleveCode: userCode, devoirId });
            });
            
            const qEvals = query(collectionGroup(db, "evaluations"), limit(100));
            const snapEvals = await getDocs(qEvals);
            const evalsMap = new Map();
            
            snapEvals.forEach(docSnap => {
                const evalData = docSnap.data();
                const pathParts = docSnap.ref.path.split('/');
                const userCode = pathParts.length >= 2 ? pathParts[1] : evalData.eleveCode;
                const devoirId = evalData.devoirId || "unknown";
                evalsMap.set(`${devoirId}_${userCode}`, evalData);
            });
            
            allData = [];
            let classes = new Set();
            let exercices = new Set();
            
            copiesMap.forEach((copyObj, key) => {
                const d = copyObj.data;
                const docSnap = copyObj.docSnap;
                const userCode = copyObj.eleveCode;
                const devoirId = copyObj.devoirId;
                const evaluation = evalsMap.get(key);
                
                // â­ UTILISER afficherAvecNom POUR MONTRER LE NOM
                const identifiant = window.afficherAvecNom(userCode) || "Anonyme";
                
                let dateValue = d.createdAtISO ? new Date(d.createdAtISO) : (d.date ? new Date(d.date) : (d.createdAt?.toDate ? d.createdAt.toDate() : new Date()));
                
                let noteFinal = "--";
                let estCorrige = false;
                
                if (evaluation && evaluation.note_finale !== undefined) {
                    noteFinal = evaluation.note_finale;
                    estCorrige = true;
                } else {
                    noteFinal = extractNote20(d) ?? "--";
                }
                
                allData.push({
                    id: docSnap.id, path: docSnap.ref.path, eleveCode: userCode, raw: d,
                    date: dateValue, identifiant, userCode, classe: d.eleve?.classe || d.classe || "?",
                    temps_secondes: d.temps_secondes || 0, exercice_titre: d.titre || devoirId || "Devoir",
                    devoirId, reponses: d.reponses, eleve: d.eleve, note_finale: noteFinal,
                    competences: d.competences || {}, estCorrige, evaluation
                });

                if(d.eleve?.classe || d.classe) classes.add(d.eleve?.classe || d.classe);
                if(d.titre || devoirId) exercices.add(d.titre || devoirId);
            });
            
            // Filtres
            const selClass = document.getElementById("filter-class");
            const selExo = document.getElementById("filter-exercice");
            selClass.innerHTML = '<option value="ALL">Toutes les classes</option>';
            classes.forEach(c => selClass.innerHTML += `<option value="${c}">${c}</option>`);
            selExo.innerHTML = '<option value="ALL">Tous les exercices</option>';
            exercices.forEach(e => selExo.innerHTML += `<option value="${e}">${e}</option>`);

            applyFilters();
            console.log("âœ… " + allData.length + " copies chargÃ©es");

        } catch(e) { 
            console.error("âŒ Erreur:", e); 
            alert("Erreur: " + e.message);
        }
    };

    window.applyFilters = function() {
        const fClass = document.getElementById("filter-class").value;
        const fExo = document.getElementById("filter-exercice").value;
        const fName = document.getElementById("filter-student").value.toLowerCase();
        const fStatut = document.getElementById("filter-statut").value;

        filteredData = allData.filter(d => {
            if(fClass !== "ALL" && d.classe !== fClass) return false;
            if(fExo !== "ALL" && d.exercice_titre !== fExo) return false;
            if(fName && !d.identifiant.toLowerCase().includes(fName)) return false;
            if(fStatut === "A_CORRIGER" && d.estCorrige) return false;
            if(fStatut === "CORRIGES" && !d.estCorrige) return false;
            if(fStatut === "NON_NOTE" && d.note_finale !== "NN") return false;
            return true;
        });
        sortData(currentSort.col, false);
    };
    
    window.sortData = function(col, toggle = true) {
        if (toggle) {
            if (currentSort.col === col) currentSort.dir = currentSort.dir === "asc" ? "desc" : "asc";
            else { currentSort.col = col; currentSort.dir = "asc"; }
        }

        filteredData.sort((a, b) => {
            let va = a[col], vb = b[col];
            if (col === "date") { va = a.date?.getTime?.() || 0; vb = b.date?.getTime?.() || 0; }
            if (col === "note_finale" || col === "temps_secondes") { va = Number(va ?? 0); vb = Number(vb ?? 0); }
            if (col === "collages") { va = a.raw?.pasteStats?.external || 0; vb = b.raw?.pasteStats?.external || 0; }
            if (typeof va === "string") va = va.toLowerCase();
            if (typeof vb === "string") vb = vb.toLowerCase();
            if (va < vb) return currentSort.dir === "asc" ? -1 : 1;
            if (va > vb) return currentSort.dir === "asc" ? 1 : -1;
            return 0;
        });

        renderTable();
    };

    function renderTable() {
        const tbody = document.getElementById("tbody-eleves");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!filteredData || filteredData.length === 0) {
            tbody.innerHTML = "<tr><td colspan='8' class='scores-empty'>Aucun rÃ©sultat trouvÃ©.</td></tr>";
            return;
        }

        filteredData.forEach(d => {
            let dateStr = d.date instanceof Date ? d.date.toLocaleDateString("fr-FR") : "-";
            let scoreStyle = "color:#4b5563";
            let scoreTxt = d.note_finale;
            let correctionBadge = "";

            if (scoreTxt === "NN" || d.evaluation?.nonNote) {
                scoreTxt = "NN"; scoreStyle = "color:#b45309;font-weight:bold";
                correctionBadge = '<span style="display:inline-block; background:#fef3c7; color:#b45309; padding:2px 6px; border-radius:4px; font-size:0.7em; margin-left:5px;">âš ï¸</span>';
            } else if (scoreTxt !== "--") {
                scoreTxt = scoreTxt + "/20";
                const val = parseFloat(d.note_finale);
                if (!isNaN(val)) {
                    if (val < 10) scoreStyle = "color:#dc2626;font-weight:bold";
                    else if (val >= 14) scoreStyle = "color:#16a34a;font-weight:bold";
                }
                if (d.estCorrige) correctionBadge = '<span style="display:inline-block; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px; font-size:0.7em; margin-left:5px;">âœ“</span>';
            }

            const pasteBadge = getPasteBadge(d.raw?.pasteStats);

            tbody.innerHTML += `<tr>
                <td>${dateStr}</td>
                <td><span class="eleve-link" onclick="openStudentDetail('${d.userCode || d.identifiant}')">${d.identifiant}</span></td>
                <td><span class="pill pill-blue">${d.classe}</span></td>
                <td>${d.exercice_titre}</td>
                <td style="font-weight:bold; ${scoreStyle}">${scoreTxt}${correctionBadge}</td>
                <td style="text-align:center;">${pasteBadge}</td>
                <td style="text-align:center;">${d.evaluation?.luLe ? 'ğŸ‘ï¸' : 'âœ‰ï¸'}</td>
                <td style="display:flex; gap:5px;">
                    <button onclick='ouvrirCorrection(${JSON.stringify(d).replace(/'/g,"&#39;")})' style="background:#fef3c7; color:#b45309; border:1px solid #fcd34d; padding:5px 8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.8rem;">âœï¸</button>
                    <button onclick='openMirror(${JSON.stringify(d).replace(/'/g, "&#39;")})' style="background:#e0f2fe; color:#0369a1; border:1px solid #bae6fd; padding:5px 8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.8rem;">ğŸ‘ï¸</button>
                    <button onclick='deleteSubmission("${d.path}", "${d.eleveCode}", "${d.devoirId}", "${d.identifiant}")' style="background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; padding:5px 8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.8rem;">ğŸ—‘ï¸</button>
                </td>
            </tr>`;
        });
    }

    window.ouvrirCorrection = function(copy) {
        try {
            localStorage.setItem("cockpit_transfert", JSON.stringify(copy));
            window.open("grille.html", "_blank");
        } catch (e) { alert("Erreur: " + e.message); }
    };

    window.openMirror = function(data) {
        alert("Copie de " + data.identifiant + "\n\nExercice: " + data.exercice_titre + "\nNote: " + data.note_finale);
    };

    window.deleteSubmission = async function(path, eleveCode, devoirId, identifiant) {
        if (!currentUser) { alert("Connexion requise"); return; }
        if (!confirm("Supprimer la copie de " + identifiant + " ?")) return;
        try {
            await deleteDoc(doc(db, path));
            const evalPath = `resultats/${eleveCode}/evaluations/${devoirId}_eval`;
            const evalSnap = await getDoc(doc(db, evalPath));
            if (evalSnap.exists()) await deleteDoc(doc(db, evalPath));
            alert("âœ… SupprimÃ© !");
            chargerDonnees();
        } catch (error) {
            alert("Erreur: " + error.message);
        }
    };

    window.openStudentDetail = function(studentIdentifier) {
        const studentHistory = allData.filter(d => d.userCode === studentIdentifier || d.identifiant === studentIdentifier);
        if(studentHistory.length === 0) return;
        const last = studentHistory[0];
        document.getElementById("modal-name").innerText = last.identifiant;
        document.getElementById("modal-class").innerText = last.classe;
        let totalScore = 0, nbNotes = 0;
        studentHistory.forEach(h => {
            if(h.note_finale && h.note_finale !== "--"){
                let v = parseFloat(h.note_finale);
                if(!isNaN(v)) { totalScore += v; nbNotes++; }
            }
        });
        document.getElementById("modal-avg").innerText = nbNotes > 0 ? (totalScore/nbNotes).toFixed(1) + " / 20" : "--";
        document.getElementById("modalStudent").classList.add("open");
    };

    window.closeModal = function() { document.getElementById("modalStudent").classList.remove("open"); };
    window.showStatDetails = function(type) { alert("Statistiques: " + type); };
    window.closeStatModal = function() { document.getElementById("modalStats").classList.remove("open"); };

    // Sessions
    window.createNewSession = async function() {
        const title = document.getElementById("session-title-input").value.trim();
        if(!title) { alert("Mettez un titre !"); return; }
        const ref = await addDoc(collection(db, "sessions"), { title, createdAt: serverTimestamp(), isActive: true });
        currentSessionId = ref.id;
        await setDoc(doc(db, "config", "live"), { activeSessionId: currentSessionId, sessionTitle: title, currentStep: "wait", updatedAt: serverTimestamp() }, { merge: true });
        document.getElementById("live-panel").style.display = "block";
        document.getElementById("session-info").style.display = "block";
        document.getElementById("current-session-name").innerText = title;
        document.getElementById("session-title-input").value = "";
    };

    window.stopSession = async function() {
        if(!confirm("ArrÃªter la session ?")) return;
        if(currentSessionId) await updateDoc(doc(db, "sessions", currentSessionId), { isActive: false });
        await setDoc(doc(db, "config", "live"), { activeSessionId: null, currentStep: "wait" }, { merge: true });
        document.getElementById("live-panel").style.display = "none";
        document.getElementById("session-info").style.display = "none";
        currentSessionId = null;
        if(typeof loadHistory === 'function') loadHistory();
    };

    window.loadHistory = async function() {
        try {
            const qSessions = query(collection(db, "sessions"), orderBy("createdAt", "desc"), limit(10));
            const snapshot = await getDocs(qSessions);
            const histDiv = document.getElementById("history-list");
            if (!histDiv) return;
            let html = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString("fr-FR", { day: "2-digit", month: "2-digit", hour: "2-digit", minute: "2-digit" }) : "-";
                const status = data.isActive ? '<span class="pill pill-green">Active</span>' : '<span class="pill pill-orange">TerminÃ©e</span>';
                html += `<div style="padding:8px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between;"><div><strong>${data.title}</strong><br><small style="color:#64748b;">${date}</small></div>${status}</div>`;
            });
            histDiv.innerHTML = html || '<p style="text-align:center; color:#94a3b8;">Aucun historique</p>';
        } catch(e) { console.error("Erreur loadHistory:", e); }
    };

    window.loadLibrary = async function() {
        try {
            const qLib = query(collection(db, "library"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(qLib);
            libraryData = [];
            const ul = document.getElementById("library-list");
            if (!ul) return;
            let html = "";
            snapshot.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                libraryData.push(data);
                const tag = data.type === "poll" ? '<span class="tag tag-poll">Sondage</span>' : data.type === "quiz" ? '<span class="tag tag-quiz">Quiz</span>' : '<span class="tag tag-cloud">Nuage</span>';
                html += `<li class="lib-item" onclick="loadFromLibrary('${data.id}')"><div>${tag}<strong>${data.title}</strong></div></li>`;
            });
            ul.innerHTML = html || '<li style="text-align:center; color:#94a3b8; padding:20px;">BibliothÃ¨que vide</li>';
        } catch(e) { console.error("Erreur loadLibrary:", e); }
    };

    window.toggleCreator = function() {
        const panel = document.getElementById("creator-panel");
        panel.style.display = panel.style.display === "none" ? "block" : "none";
    };

    window.updateCreatorForm = function() {};
    window.addOptionInput = function() {};
    window.saveToLibrary = async function() { alert("Enregistrement bibliothÃ¨que"); };
    window.loadFromLibrary = function(id) { alert("Chargement item " + id); };
    window.setMode = function(mode) { console.log("Mode:", mode); };
    window.revealQuiz = function() {};
    window.resetQuiz = function() {};

    // Chargement initial
    chargerDonnees();
    loadLibrary();

    // Swipe mobile
    let touchStartX = 0;
    document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
    document.addEventListener('touchend', e => {
        if(document.body.classList.contains("menu-open") && e.changedTouches[0].screenX < touchStartX - 50) closeMenu();
    }, {passive: true});

    console.log("âœ… Cockpit chargÃ© avec succÃ¨s !");
  </script>
</body>
</html>

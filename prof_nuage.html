<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nuage Live - Prof (Style ITAMaMi)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* === STYLE ITAMAMI === */
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: white; display: flex; height: 100vh; overflow: hidden; user-select: none; }
        
        /* SIDEBAR */
        .sidebar { width: 320px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 20; flex-shrink: 0; }
        .sidebar-header { padding: 15px; background: #0f172a; border-bottom: 1px solid #334155; display:flex; justify-content:space-between; align-items:center; }
        .sidebar-section { padding: 15px; border-bottom: 1px solid #334155; }
        .sidebar-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .section-title { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: bold; margin-bottom: 10px; }

        /* INPUTS SIDEBAR */
        .control-input { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-blue { background: #3b82f6; color: white; } .btn-blue:hover { background: #2563eb; }
        .btn-red { background: #ef4444; color: white; margin-top: 10px; } .btn-red:hover { background: #dc2626; }

        /* LISTE DES MOTS (SIDEBAR) */
        .word-item { background: #334155; padding: 8px; border-radius: 4px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .del-btn { cursor: pointer; color: #ef4444; font-weight: bold; padding: 0 5px; }

        /* MAIN CONTENT */
        .main-content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); }
        
        .btn-projection { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: #3b82f6; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; z-index: 50; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* QUESTION DISPLAY */
        #display-question { text-align: center; font-size: 2rem; font-weight: 800; color: #fff; margin-top: 40px; text-shadow: 0 0 20px rgba(255,255,255,0.1); z-index: 10; min-height: 50px; }

        /* NUAGE CONTAINER */
        #cloud-container { flex-grow: 1; position: relative; overflow: hidden; margin-top: 20px; border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px; }

        .word-tag { position: absolute; white-space: nowrap; font-weight: 800; cursor: pointer; transition: all 0.5s ease-out; animation: float 20s infinite linear; text-shadow: 2px 2px 0px rgba(0,0,0,0.5); }
        .word-tag:hover { z-index: 100; transform: scale(1.2); color: #ff0000 !important; text-decoration: line-through; }
        
        /* WIDGET FLOTTANT (CHRONO + SONO) */
        .ambient-widget { position: absolute; bottom: 15px; right: 15px; background: #1e293b; padding: 10px 20px; border-radius: 10px; display: flex; gap: 20px; align-items: center; border: 1px solid #334155; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 100; }
        .chrono { font-family: monospace; font-size: 1.5rem; font-weight: bold; color: #3b82f6; cursor: pointer; width: 80px; text-align: center; }
        .chrono.alert { color: #ef4444; animation: pulse 1s infinite; }
        .sono-box { width: 100px; height: 15px; background: #0f172a; border-radius: 4px; overflow: hidden; border: 1px solid #475569; position: relative; }
        .sono-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #22c55e, #eab308, #ef4444); transition: width 0.05s; }

        /* ANIMATIONS & COULEURS */
        @keyframes float { 0% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(10px, 15px) rotate(2deg); } 50% { transform: translate(-5px, -10px) rotate(-1deg); } 75% { transform: translate(-15px, 5px) rotate(1deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .pop { animation: popAnim 0.3s ease-out; }
        @keyframes popAnim { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        
        .c1 { color: #00f2ea; } .c2 { color: #ff0050; } .c3 { color: #f9f871; } .c4 { color: #00ff87; } .c5 { color: #be00ff; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2 style="margin:0; font-size:1.1rem;">NUAGE PROF</h2>
            <button onclick="toggleLock()" id="btn-lock" style="background:none; border:1px solid #22c55e; color:#22c55e; padding:4px 10px; border-radius:4px; cursor:pointer; font-weight:bold;">üîì Ouvert</button>
        </div>
        
        <div class="sidebar-section">
            <div class="section-title">üì° Lancer une question</div>
            <input type="text" id="q-input" class="control-input" placeholder="Ex: Un mot pour d√©finir..." value="Un mot pour d√©finir...">
            <button class="btn-action btn-blue" onclick="updateQuestion()">LANCER</button>
        </div>

        <div class="sidebar-list">
            <div class="section-title">üìù Derniers mots re√ßus</div>
            <div id="words-list"></div>
        </div>

        <div class="sidebar-section" style="border-top:1px solid #334155;">
            <button class="btn-action btn-red" onclick="resetCloud()">üóëÔ∏è TOUT EFFACER</button>
        </div>
    </div>

    <div class="main-content">
        <button class="btn-projection" onclick="toggleProjection()">üì∫ Mode Projection</button>
        
        <div id="display-question">...</div>
        <div id="cloud-container">
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#334155; font-weight:bold;">En attente de mots...</div>
        </div>

        <div class="ambient-widget">
            <div onclick="handleChronoClick()"><div class="chrono" id="chrono">00:00</div></div>
            <div style="display:flex; align-items:center;">
                <div class="sono-box"><div class="sono-bar" id="sono-bar"></div></div>
                <span style="font-size:0.6rem; color:#64748b; margin-left:5px;">Micro</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI", authDomain: "devoirs-pse.firebaseapp.com", projectId: "devoirs-pse", storageBucket: "devoirs-pse.firebasestorage.app", messagingSenderId: "614730413904", appId: "1:614730413904:web:a5dd478af5de30f6bede55" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colors = ['c1', 'c2', 'c3', 'c4', 'c5'];

        // --- GESTION DES MOTS ---
        const wordsMap = new Map();
        const container = document.getElementById('cloud-container');
        const listContainer = document.getElementById('words-list');

        onSnapshot(collection(db, "nuage_mots"), (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    addWordToCloud(data.text, change.doc.id);
                    addWordToList(data.text, change.doc.id);
                }
                if (change.type === "removed") {
                    removeWordVisuals(change.doc.id);
                }
            });
        });

        function addWordToCloud(text, docId) {
            const cleanText = text.toUpperCase();
            // Logique de regroupement simple (si m√™me mot, on grossit)
            let existing = null;
            document.querySelectorAll('.word-tag').forEach(el => { if(el.innerText === cleanText) existing = el; });

            if(existing) {
                let size = parseFloat(existing.style.fontSize);
                existing.style.fontSize = (size + 0.5) + "rem";
                existing.classList.add('pop'); setTimeout(()=>existing.classList.remove('pop'), 300);
            } else {
                const el = document.createElement('div');
                el.innerText = cleanText;
                el.className = `word-tag ${colors[Math.floor(Math.random() * colors.length)]}`;
                el.style.left = (Math.random() * 80 + 10) + "%";
                el.style.top = (Math.random() * 80 + 10) + "%";
                el.style.fontSize = "2rem";
                el.dataset.id = docId; // On stocke l'ID pour suppression facile
                el.onclick = () => deleteDoc(doc(db, "nuage_mots", docId));
                
                container.appendChild(el);
                el.classList.add('pop'); setTimeout(()=>el.classList.remove('pop'), 300);
            }
        }

        function addWordToList(text, docId) {
            const div = document.createElement('div');
            div.className = 'word-item';
            div.id = 'list-' + docId;
            div.innerHTML = `<span>${text}</span> <span class="del-btn" onclick="del('${docId}')">‚úï</span>`;
            listContainer.prepend(div); // Ajoute en haut
        }

        function removeWordVisuals(docId) {
            const listEl = document.getElementById('list-' + docId);
            if(listEl) listEl.remove();
            
            // Pour le nuage, c'est plus complexe si regroup√©, mais ici on simplifie :
            // Si on supprime via la liste, on supprime le mot du nuage li√© √† cet ID
            const cloudEl = document.querySelector(`.word-tag[data-id="${docId}"]`);
            if(cloudEl) cloudEl.remove();
        }

        window.del = (id) => deleteDoc(doc(db, "nuage_mots", id));

        // --- COMMANDES PROF ---
        window.updateQuestion = async () => {
            const q = document.getElementById('q-input').value;
            document.getElementById('display-question').innerText = q;
            await setDoc(doc(db, "nuage_etat", "config"), { question: q, isOpen: true });
            setLockState(true);
        };

        window.resetCloud = async () => {
            if(confirm("Tout effacer ?")) {
                const snap = await getDocs(collection(db, "nuage_mots"));
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
                location.reload();
            }
        };

        // --- VERROUILLAGE ---
        let isLocked = false;
        window.toggleLock = async () => {
            isLocked = !isLocked;
            await updateDoc(doc(db, "nuage_etat", "config"), { isOpen: !isLocked });
            setLockState(!isLocked);
        };

        function setLockState(isOpen) {
            const btn = document.getElementById('btn-lock');
            if(isOpen) {
                btn.innerText = "üîì Ouvert";
                btn.style.borderColor = "#22c55e"; btn.style.color = "#22c55e";
                isLocked = false;
            } else {
                btn.innerText = "üîí Ferm√©";
                btn.style.borderColor = "#ef4444"; btn.style.color = "#ef4444";
                isLocked = true;
            }
        }

        // --- PROJECTION ---
        window.toggleProjection = () => {
            // Ouvrir une fenetre √©pur√©e (copie de celle-ci mais en cachant la sidebar via CSS ou URL param)
            // Pour faire simple ici, on peut imaginer un fichier separ√©, mais on peut aussi juste masquer la sidebar
            const w = window.open("", "_blank");
            w.document.write(document.documentElement.outerHTML);
            w.document.close();
            // Injecter un style pour cacher la sidebar dans la nouvelle fen√™tre
            const style = w.document.createElement('style');
            style.innerHTML = `.sidebar { display: none !important; } .btn-projection { display: none !important; }`;
            w.document.head.appendChild(style);
        };

        // --- WIDGET CHRONO & SONO (Identique ITAMAMI) ---
        let ti, ir=false, ts=0;
        window.handleChronoClick=()=>{ if(ir){clearInterval(ti);ir=false;document.getElementById('chrono').style.color="#3b82f6";return;} const i=prompt("Minuteur (min)?"); clearInterval(ti); document.getElementById('chrono').classList.remove('alert'); if(i&&parseInt(i)>0){ ts=parseInt(i)*60; updC(ts); ti=setInterval(()=>{ ts--; updC(ts); if(ts<=0){clearInterval(ti);ir=false;document.getElementById('chrono').classList.add('alert');document.getElementById('chrono').innerText="FIN!";} },1000); } else { ts=0; updC(0); ti=setInterval(()=>{ ts++; updC(ts); },1000); } ir=true; };
        function updC(s){ document.getElementById('chrono').innerText=`${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        
        navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{ const c=new(window.AudioContext||window.webkitAudioContext)(), a=c.createAnalyser(), m=c.createMediaStreamSource(s); m.connect(a); a.fftSize=256; const d=new Uint8Array(a.frequencyBinCount); function dr(){ requestAnimationFrame(dr); a.getByteFrequencyData(d); let sm=0; for(let i=0;i<d.length;i++)sm+=d[i]; document.getElementById('sono-bar').style.width=Math.min(100,(sm/d.length/50)*100)+"%"; } dr(); }).catch(()=>{});

    </script>
</body>
</html>

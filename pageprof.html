<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Page prof â€“ Exercices (rÃ©sultats anonymes)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f4f4f5;margin:0}
    .page{max-width:1100px;margin:0 auto;padding:20px 16px 60px}
    h1{font-size:1.6rem;margin:0 0 .35rem}
    p{font-size:.95rem;color:#4b5563;margin:.2rem 0 1rem}
    .card{margin-top:14px;background:#fff;border-radius:12px;padding:14px 16px;box-shadow:0 8px 18px rgba(15,23,42,.08)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:8px 12px;border-radius:999px;border:none;font-size:.9rem;font-weight:700;cursor:pointer;background:#2563eb;color:#fff;white-space:nowrap}
    .btn.gray{background:#6b7280}
    .btn.red{background:#dc2626}
    input,select{padding:9px 10px;border:1px solid #e5e7eb;border-radius:10px;font-weight:600}
    input{min-width:240px;flex:1}
    table{width:100%;border-collapse:collapse;font-size:.92rem}
    th,td{padding:10px 8px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:middle}
    th{background:#f3f4f6;font-weight:800;color:#111827;position:sticky;top:0}
    tr:hover td{background:#f9fafb}
    .status{margin-top:10px;font-size:.9rem;font-weight:700}
    .ok{color:#16a34a}
    .err{color:#dc2626}
    .muted{color:#6b7280;font-weight:700}
    a{color:#2563eb;text-decoration:none;font-weight:800}
    a:hover{text-decoration:underline}
    .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1}
    .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#f8fafc;font-weight:800}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="page">
    <h1>Page prof â€“ Exercices</h1>
    <p>RÃ©sultats anonymes des exercices (sans nom, sans classe). Tu peux tÃ©lÃ©charger un JSON par ligne.</p>

    <div class="card">
      <div class="row">
        <button class="btn gray" id="refresh-btn">ðŸ”„ Actualiser</button>
        <input id="q" placeholder="Filtrer (exercice, score, url)" />
        <select id="limitSel" title="Limite">
          <option value="50">50</option>
          <option value="100" selected>100</option>
          <option value="200">200</option>
        </select>
      </div>

      <div id="status" class="status muted">Chargementâ€¦</div>

      <div style="overflow:auto;margin-top:10px;border:1px solid #e5e7eb;border-radius:12px">
        <table>
          <thead>
            <tr>
              <th style="width:56px">#</th>
              <th>Exercice</th>
              <th style="width:120px">Score</th>
              <th style="width:190px">Date</th>
              <th>URL</th>
              <th style="width:220px">Action</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6">Chargementâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.firebasestorage.app",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tbody = document.getElementById("tbody");
    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refresh-btn");
    const qEl = document.getElementById("q");
    const limitSel = document.getElementById("limitSel");

    function setStatus(msg, cls="muted"){
      statusEl.className = "status " + cls;
      statusEl.textContent = msg;
    }

    function toISOorEmpty(v){
      if(!v) return "";
      if(typeof v === "string") return v;
      if(v && typeof v.toDate === "function"){
        const d = v.toDate();
        return d instanceof Date && !isNaN(d) ? d.toISOString() : "";
      }
      if(v instanceof Date && !isNaN(v)) return v.toISOString();
      return "";
    }

    function formatFR(iso){
      if(!iso) return "â€”";
      const d = new Date(iso);
      if(isNaN(d)) return iso;
      return d.toLocaleString("fr-FR");
    }

    function downloadJSON(row){
      const exportObj = {
        type: row.type || "exercice",
        createdAt: toISOorEmpty(row.createdAt) || row.createdAt || "",
        exercice: row.exercice || document.title || "",
        score: row.score || "",
        url: row.url || "",
        meta: row.meta || {}
      };
      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const safeExo = (row.exercice || "exercice").toString().replace(/[^\w\-]+/g, "_").slice(0,60);
      const safeDate = (toISOorEmpty(row.createdAt) || "date").replace(/[^\w\-]+/g, "_").slice(0,25);
      const a = document.createElement("a");
      a.href = url;
      a.download = `exercice_${safeExo}_${safeDate}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    let cache = [];

    function applyFilter(){
      const q = (qEl.value || "").trim().toLowerCase();
      const rows = !q ? cache : cache.filter(r => {
        const blob = [
          r.exercice, r.score, r.url, toISOorEmpty(r.createdAt), r.type
        ].map(x => (x || "").toString().toLowerCase()).join(" | ");
        return blob.includes(q);
      });
      render(rows);
      setStatus(`${rows.length} rÃ©sultat(s) affichÃ©(s).`, "ok");
    }

    function render(rows){
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="6">Aucun rÃ©sultat.</td></tr>`;
        return;
      }
      tbody.innerHTML = "";
      rows.forEach((r, i) => {
        const tr = document.createElement("tr");
        const iso = toISOorEmpty(r.createdAt);
        const url = (r.url || "").toString();
        tr.innerHTML = `
          <td class="mono">${i+1}</td>
          <td><span class="pill">${(r.exercice || "â€”").toString().slice(0,120)}</span></td>
          <td class="mono"><b>${(r.score || "â€”").toString().slice(0,30)}</b></td>
          <td class="mono">${formatFR(iso || r.createdAt)}</td>
          <td>${url ? `<a href="${url}" target="_blank" rel="noopener">ouvrir</a>` : "â€”"}</td>
          <td></td>
        `;
        const td = tr.lastElementChild;
        const wrap = document.createElement("div");
        wrap.className = "actions";
        const b1 = document.createElement("button");
        b1.className = "btn";
        b1.type = "button";
        b1.textContent = "TÃ©lÃ©charger JSON";
        b1.addEventListener("click", () => downloadJSON(r));
        wrap.appendChild(b1);
        td.appendChild(wrap);
        tbody.appendChild(tr);
      });
    }

    async function load(){
      try{
        setStatus("Chargementâ€¦");
        tbody.innerHTML = `<tr><td colspan="6">Chargementâ€¦</td></tr>`;

        const lim = parseInt(limitSel.value || "100", 10);
        const col = collection(db, "exercices");
        const qq = query(col, orderBy("createdAt", "desc"), limit(lim));
        const snap = await getDocs(qq);

        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
        cache = rows;

        if(!rows.length){
          tbody.innerHTML = `<tr><td colspan="6">Aucun rÃ©sultat pour lâ€™instant.</td></tr>`;
          setStatus("0 rÃ©sultat.", "ok");
          return;
        }

        applyFilter();
      }catch(err){
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="6">Erreur technique.</td></tr>`;
        setStatus("Erreur Firebase : " + (err?.message || err), "err");
      }
    }

    refreshBtn.addEventListener("click", load);
    qEl.addEventListener("input", applyFilter);
    limitSel.addEventListener("change", load);

    load();
  </script>
</body>
</html>

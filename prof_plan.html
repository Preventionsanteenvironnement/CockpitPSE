<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Classe - Pilotage & Stats</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* === BASE === */
        :root { --bg: #121212; --panel: #1e1e1e; --border: #333; --accent: #3b82f6; --text: #fff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* === SIDEBAR (Menu Gauche) === */
        #sidebar { 
            width: 320px; background: var(--panel); border-right: 1px solid var(--border); 
            padding: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 50; 
            overflow-y: auto; flex-shrink: 0; transition: transform 0.3s ease;
        }
        
        h2 { font-size: 0.85rem; text-transform: uppercase; color: #888; border-bottom: 1px solid #444; padding-bottom: 5px; margin: 0 0 5px 0; letter-spacing: 1px; }
        select, input[type="number"], input[type="text"] { 
            width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; 
            color: white; border-radius: 8px; font-weight: bold; margin-bottom: 5px; box-sizing: border-box;
        }
        button { cursor: pointer; border: none; }
        
        .action-btn { width: 100%; padding: 12px; background: #333; color: white; border-radius: 8px; font-weight: bold; margin-bottom: 5px; text-align: left; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .action-btn:hover { background: #444; }
        .btn-primary { background: var(--accent); color: white; text-align: center; justify-content: center; }
        .btn-primary:hover { background: #2563eb; }

        .pool-container { 
            min-height: 80px; background: #181818; border: 2px dashed #444; border-radius: 8px; 
            padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; align-content: flex-start;
        }

        /* === ZONE PRINCIPALE (Grille) === */
        #main-area { flex-grow: 1; position: relative; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        
        /* Header Mobile (invisible sur PC) */
        #mobile-header { display: none; padding: 15px; background: var(--panel); border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; }
        #menu-toggle { background: none; color: white; font-size: 1.5rem; border: none; padding: 5px; }

        #grid-container { 
            flex-grow: 1; padding: 20px; overflow: auto; 
            display: flex; align-items: center; justify-content: center;
            background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;
        }

        #classroom { 
            display: grid; gap: 10px; padding: 20px; background: #1a1a1a; 
            border: 2px solid #444; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: 0.3s;
        }

        /* TABLES & Ã‰LÃˆVES */
        .desk { 
            width: 100px; height: 60px; background: #2d2d2d; border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.8rem; font-weight: bold; cursor: pointer; border: 2px solid #3d3d3d;
            position: relative; user-select: none; transition: 0.2s;
        }
        .desk:hover { border-color: #666; }
        .desk.filled { background: #1e3a8a; border-color: var(--accent); color: white; }
        .desk.selected { box-shadow: 0 0 0 3px #fbbf24; z-index: 10; transform: scale(1.05); }
        .desk.wall { background: repeating-linear-gradient(45deg, #222, #222 10px, #111 10px, #111 20px); border: none; pointer-events: none; opacity: 0.5; }
        .desk.prof { background: #7f1d1d; color: #fecaca; border: 1px solid #ef4444; }

        .student-tag { padding: 4px 8px; background: #444; color: white; border-radius: 4px; font-size: 0.8rem; cursor: grab; user-select: none; border: 1px solid #555; }
        .student-tag:active { cursor: grabbing; background: var(--accent); }

        /* Tableau (Board) */
        .board-indicator { 
            grid-column: 1 / -1; height: 10px; background: #22c55e; 
            border-radius: 5px; margin-bottom: 10px; box-shadow: 0 0 10px rgba(34, 197, 94, 0.4); 
        }

        /* === RESPONSIVE MOBILE === */
        @media (max-width: 768px) {
            body { flex-direction: column; height: 100vh; overflow: hidden; }
            
            #sidebar { 
                position: fixed; top: 0; left: 0; bottom: 0; width: 85%; max-width: 320px;
                transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            }
            #sidebar.open { transform: translateX(0); }
            
            /* Overlay pour fermer le menu */
            #overlay {
                display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40;
                backdrop-filter: blur(2px);
            }
            #overlay.visible { display: block; }

            #mobile-header { display: flex; z-index: 30; }
            
            #grid-container { padding: 10px; align-items: flex-start; } /* Scroll facile */
            
            /* Ajustement taille des tables sur mobile */
            .desk { width: 80px; height: 50px; font-size: 0.7rem; }
        }
    </style>
</head>
<body>

    <div id="overlay" onclick="toggleMenu()"></div>

    <div id="sidebar">
        <h1 style="margin:0 0 10px 0; font-size:1.2rem; display:flex; justify-content:space-between; align-items:center;">
            PLAN DE CLASSE
            <button onclick="toggleMenu()" style="background:none; color:white; font-size:1.5rem; display:none;" class="mobile-close">Ã—</button>
        </h1>
        
        <div>
            <h2>1. CONFIGURATION</h2>
            <select id="classSelect" onchange="loadClass(this.value)">
                <option value="">-- Choisir une classe --</option>
                <option value="2GATL">2nde GATL</option>
                <option value="1AGORA">1Ã¨re AGORA</option>
                <option value="TAGORA">Terminale AGORA</option>
            </select>
            <div style="display:flex; gap:5px;">
                <input type="number" id="nbRows" value="4" min="2" max="10" onchange="buildGrid()">
                <input type="number" id="nbCols" value="5" min="2" max="10" onchange="buildGrid()">
            </div>
            <select id="boardPos" onchange="buildGrid()">
                <option value="top">Tableau en HAUT</option>
                <option value="bottom">Tableau en BAS</option>
            </select>
        </div>

        <div>
            <h2>2. Ã‰LÃˆVES (Drag & Drop)</h2>
            <div class="pool-container" id="studentPool" ondragover="allowDrop(event)" ondrop="dropToPool(event)">
                </div>
            <div style="margin-top:5px; display:flex; gap:5px;">
                <input type="text" id="newStudentName" placeholder="Ajouter Ã©lÃ¨ve..." onkeypress="if(event.key==='Enter') addStudentManual()">
                <button onclick="addStudentManual()" style="background:#444; color:white; padding:0 10px; border-radius:6px;">+</button>
            </div>
        </div>

        <div>
            <h2>3. ACTIONS</h2>
            <button class="action-btn" onclick="autoPlace()">ðŸŽ² Placement AlÃ©atoire</button>
            <button class="action-btn" onclick="resetPlacements()">ðŸ§¹ Tout retirer</button>
            <button class="action-btn" onclick="toggleEditMode()">ðŸ§± Mode Murs/Vides</button>
            <button class="action-btn btn-primary" onclick="pushToScreen()">ðŸš€ PROJETER / SAUVER</button>
        </div>

        <div id="notif" style="margin-top:auto; padding:10px; background:#22c55e; color:#052e16; border-radius:6px; display:none; text-align:center; font-weight:bold;"></div>
    </div>

    <div id="main-area">
        <div id="mobile-header">
            <button id="menu-toggle" onclick="toggleMenu()">â˜° Menu</button>
            <span style="font-weight:900;">Plan De Classe</span>
            <div style="width:30px;"></div> </div>

        <div id="grid-container">
            <div id="classroom"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI", authDomain: "devoirs-pse.firebaseapp.com", projectId: "devoirs-pse", storageBucket: "devoirs-pse.firebasestorage.app", messagingSenderId: "614730413904", appId: "1:614730413904:web:a5dd478af5de30f6bede55" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GESTION MOBILE ---
        window.toggleMenu = () => {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('visible');
        };
        // Afficher le bouton fermer seulement sur mobile
        if(window.innerWidth <= 768) {
            document.querySelector('.mobile-close').style.display = 'block';
        }

        // --- LOGIQUE PLAN DE CLASSE ---
        let state = {
            students: [], // Liste complÃ¨te
            placements: {}, // { "0-0": "Nom", "0-1": null }
            structure: {}, // { "0-0": 1 (normal), "0-1": 0 (vide/mur) }
            editMode: false
        };

        window.buildGrid = () => {
            const rows = parseInt(document.getElementById('nbRows').value);
            const cols = parseInt(document.getElementById('nbCols').value);
            const boardPos = document.getElementById('boardPos').value;
            const container = document.getElementById('classroom');
            
            container.style.gridTemplateColumns = `repeat(${cols}, auto)`;
            container.innerHTML = "";

            // Tableau
            if(boardPos === 'top') {
                const board = document.createElement('div'); board.className = 'board-indicator'; board.innerText = "TABLEAU"; board.style.textAlign='center'; board.style.color='#0f5132'; board.style.fontSize='0.7rem'; board.style.fontWeight='bold';
                container.appendChild(board);
            }

            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    const idx = r*cols + c;
                    const cellId = `${r}-${c}`;
                    
                    // Init structure si nouvelle
                    if(state.structure[idx] === undefined) state.structure[idx] = 1;

                    const cell = document.createElement('div');
                    cell.className = 'desk';
                    cell.id = 'desk-'+idx;
                    
                    // Gestion Type de case
                    if(state.structure[idx] === 0) {
                        cell.classList.add('wall');
                    } else if (state.structure[idx] === 2) {
                        cell.classList.add('prof');
                        cell.innerText = "PROF";
                    } else {
                        // Place Ã©lÃ¨ve
                        const studentName = state.placements[idx];
                        if(studentName) {
                            cell.classList.add('filled');
                            cell.innerText = studentName;
                            cell.draggable = true;
                            cell.ondragstart = (e) => dragStudent(e, studentName, idx);
                        } else {
                            cell.innerText = "";
                            cell.ondragover = allowDrop;
                            cell.ondrop = (e) => dropToDesk(e, idx);
                        }
                    }

                    // Clic pour mode Ã©dition
                    cell.onclick = () => handleCellClick(idx);

                    container.appendChild(cell);
                }
            }

            // Tableau bas
            if(boardPos === 'bottom') {
                const board = document.createElement('div'); board.className = 'board-indicator'; board.style.marginTop='10px';
                container.appendChild(board);
            }
            
            renderPools();
        };

        window.renderPools = () => {
            const pool = document.getElementById('studentPool');
            pool.innerHTML = "";
            const placed = Object.values(state.placements);
            
            state.students.forEach(s => {
                if(!placed.includes(s)) {
                    const tag = document.createElement('div');
                    tag.className = 'student-tag';
                    tag.innerText = s;
                    tag.draggable = true;
                    tag.ondragstart = (e) => dragStudent(e, s, -1); // -1 = vient du pool
                    
                    // Support tactile basique (click to place serait mieux pour mobile pur, mais drag desktop OK)
                    tag.onclick = () => {
                        if(window.innerWidth <= 768) {
                            // Sur mobile, clic = mettre dans la premiÃ¨re case libre
                            const emptyIdx = Object.keys(state.structure).find(k => state.structure[k]===1 && !state.placements[k]);
                            if(emptyIdx) {
                                state.placements[emptyIdx] = s;
                                buildGrid();
                            }
                        }
                    };
                    
                    pool.appendChild(tag);
                }
            });
        };

        // --- DRAG & DROP ---
        window.allowDrop = (e) => e.preventDefault();
        window.dragStudent = (e, name, fromIdx) => {
            e.dataTransfer.setData("name", name);
            e.dataTransfer.setData("fromIdx", fromIdx);
        };
        window.dropToDesk = (e, toIdx) => {
            e.preventDefault();
            const name = e.dataTransfer.getData("name");
            const fromIdx = parseInt(e.dataTransfer.getData("fromIdx"));

            if(state.structure[toIdx] !== 1) return; // Pas sur un mur

            // Si vient d'une autre table, on vide l'ancienne
            if(fromIdx !== -1) delete state.placements[fromIdx];
            
            // Si la table cible est occupÃ©e, on Ã©change (swap)
            if(state.placements[toIdx]) {
                if(fromIdx !== -1) state.placements[fromIdx] = state.placements[toIdx];
                // Si vient du pool, l'occupant retourne au pool (automatique car Ã©crasÃ©)
            }

            state.placements[toIdx] = name;
            buildGrid();
        };
        window.dropToPool = (e) => {
            e.preventDefault();
            const fromIdx = parseInt(e.dataTransfer.getData("fromIdx"));
            if(fromIdx !== -1) {
                delete state.placements[fromIdx];
                buildGrid();
            }
        };

        // --- EDIT MODE (Murs/Vides) ---
        window.toggleEditMode = () => {
            state.editMode = !state.editMode;
            showNotif(state.editMode ? "ðŸ§± Mode Construction ACTIF : Cliquez sur les cases" : "âœ… Mode Placement ACTIF");
        };

        window.handleCellClick = (idx) => {
            if(!state.editMode) {
                // Sur mobile, clic sur une case vide = retirer l'Ã©lÃ¨ve
                if(window.innerWidth <= 768 && state.placements[idx]) {
                    if(confirm("Retirer " + state.placements[idx] + " ?")) {
                        delete state.placements[idx];
                        buildGrid();
                    }
                }
                return; 
            }
            
            // Cycle : 1 (Table) -> 0 (Mur/Vide) -> 2 (Bureau Prof) -> 1
            let s = state.structure[idx];
            s = (s === 1) ? 0 : (s === 0 ? 2 : 1);
            state.structure[idx] = s;
            
            // Si on transforme en mur, on vire l'Ã©lÃ¨ve
            if(s !== 1) delete state.placements[idx];
            
            buildGrid();
        };

        // --- DATA & FIREBASE ---
        window.addStudentManual = () => {
            const input = document.getElementById('newStudentName');
            const val = input.value.trim();
            if(val && !state.students.includes(val)) {
                state.students.push(val);
                input.value = "";
                renderPools();
            }
        };

        window.loadClass = async (className) => {
            if(!className) return;
            // Ici on simule une liste. IdÃ©alement, charger depuis Firebase 'classes_listes'
            // Pour l'exemple, on met des faux Ã©lÃ¨ves si la liste est vide
            if(state.students.length === 0) {
                state.students = ["LÃ©o", "Mia", "Tom", "LÃ©a", "NoÃ©", "ZoÃ©", "Ben", "Eva", "Sam", "Ana", "Luc", "Ines"];
            }
            // Reset placements
            state.placements = {};
            buildGrid();
        };

        window.autoPlace = () => {
            // MÃ©langer les Ã©lÃ¨ves restants
            const placed = Object.values(state.placements);
            const available = state.students.filter(s => !placed.includes(s));
            
            // MÃ©lange Fisher-Yates
            for (let i = available.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [available[i], available[j]] = [available[j], available[i]];
            }

            const total = document.getElementById('nbRows').value * document.getElementById('nbCols').value;
            for(let i=0; i<total; i++) {
                if(!state.placements[i] && state.structure[i] === 1 && available.length > 0) {
                    const r = Math.floor(Math.random() * available.length);
                    state.placements[i] = available[r]; available.splice(r, 1);
                }
            }
            buildGrid(); renderPools();
        };

        window.resetPlacements = () => {
            if(confirm("Tout vider ?")) {
                state.placements = {};
                buildGrid();
            }
        };

        window.pushToScreen = async () => {
            const cls = document.getElementById('classSelect').value;
            const r = document.getElementById('nbRows').value;
            const c = document.getElementById('nbCols').value;
            const bPos = document.getElementById('boardPos').value;

            // Sauvegarde Cloud
            await setDoc(doc(db, "classe_etat", "config"), {
                className: cls, rows: parseInt(r), cols: parseInt(c),
                placements: state.placements, structure: state.structure, boardPos: bPos, timestamp: Date.now()
            });

            // Sauvegarde Historique (Optionnel)
            if(cls) {
                await addDoc(collection(db, "classe_historique"), {
                    className: cls, rows: parseInt(r), cols: parseInt(c),
                    placements: state.placements, date: new Date().toISOString(), timestamp: Date.now(), structure: state.structure 
                });
            }
            showNotif("ðŸš€ Plan EnvoyÃ© & SauvegardÃ© !");
            
            // Ouvrir l'Ã©cran de projection si sur PC
            if(window.innerWidth > 768) {
                window.open('ecran_plan.html', 'projection_salle');
            }
        };

        function showNotif(msg) {
            const n = document.getElementById('notif');
            n.innerText = msg; n.style.display = 'block';
            setTimeout(() => n.style.display='none', 3000);
        }

        // Init
        buildGrid();

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Tableau de Bord - Cockpit PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data_modules.js"></script>
    <script src="data_eleves.js"></script>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Tableau de Bord - Cockpit PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data_modules.js"></script>
    <script src="data_eleves.js"></script>
    
    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --primary: #8b5cf6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #dc2626;
            --border: #e2e8f0;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* === HEADER === */
        .header {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-light {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .btn-light:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* === FILTRES === */
        .filters {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: var(--muted);
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
        }
        
        .btn-search {
            background: var(--primary);
            color: white;
            width: 100%;
        }
        
        /* === STATS === */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: var(--card);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--primary);
        }
        
        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.danger { color: var(--danger); }
        
        .note-badge.absent { background: #fef3c7; color: #92400e; }
        
        .stat-label {
            font-size: 0.8em;
            color: var(--muted);
            margin-top: 5px;
        }
        
        /* === TABLEAU === */
        .table-container {
            background: var(--card);
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: #f8fafc;
            font-weight: 700;
            font-size: 0.8em;
            text-transform: uppercase;
            color: var(--muted);
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .code-badge {
            font-weight: 700;
            background: #eff6ff;
            color: #3b82f6;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .classe-badge {
            font-size: 0.85em;
            color: var(--muted);
        }
        
        .note-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.9em;
        }
        
        .note-badge.excellent { background: #dcfce7; color: #166534; }
        .note-badge.good { background: #dbeafe; color: #1e40af; }
        .note-badge.average { background: #fef3c7; color: #92400e; }
        .note-badge.poor { background: #fee2e2; color: #991b1b; }
        .note-badge.none { background: #f1f5f9; color: #64748b; }
        
        .vu-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .vu-badge.oui { background: #dcfce7; color: #166534; }
        .vu-badge.non { background: #fee2e2; color: #991b1b; }
        
        .date-consultation {
            font-size: 0.85em;
            color: var(--muted);
        }
        
        .visites-count {
            background: #eff6ff;
            color: #3b82f6;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        /* === EMPTY STATE === */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        /* === LOGIN === */
        .login-screen {
            max-width: 400px;
            margin: 60px auto;
            text-align: center;
        }
        
        .login-card {
            background: var(--card);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .login-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .btn-google {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 14px 28px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .btn-google:hover {
            background: #3367d6;
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .filters-grid { grid-template-columns: 1fr; }
            .stats-bar { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* === BILAN CLASSE === */
        .bilan-section {
            margin-top: 30px;
            display: none;
        }
        
        .bilan-section.active {
            display: block;
        }
        
        .bilan-header {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px 25px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .bilan-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .bilan-tab {
            padding: 12px 24px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bilan-tab:hover {
            border-color: var(--primary);
        }
        
        .bilan-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .bilan-content {
            display: none;
        }
        
        .bilan-content.active {
            display: block;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-bar-container {
            margin-bottom: 12px;
        }
        
        .chart-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .chart-bar-track {
            height: 24px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .chart-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .bar-excellent { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .bar-good { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bar-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .bar-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .bar-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        
        .top-list {
            list-style: none;
        }
        
        .top-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: #f8fafc;
        }
        
        .top-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 12px;
            font-size: 0.9em;
        }
        
        .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; }
        .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: white; }
        .rank-3 { background: linear-gradient(135deg, #f97316, #ea580c); color: white; }
        
        .top-name {
            flex: 1;
            font-weight: 600;
        }
        
        .top-value {
            font-weight: 700;
            color: var(--primary);
        }
        
        .alert-list {
            list-style: none;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        
        .alert-item.danger {
            background: #fee2e2;
            border-left-color: #dc2626;
        }
        
        .bilan-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        
        .bilan-table th {
            background: #f1f5f9;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
        }
        
        .bilan-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .bilan-table tr:hover {
            background: #f8fafc;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .badge-success { background: #dcfce7; color: #16a34a; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        
        .export-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .donut-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .donut-value {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--text);
        }
        
        .donut-label {
            font-size: 0.8em;
            color: var(--muted);
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- √âCRAN LOGIN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-icon">üîê</div>
            <h2>Tableau de Bord</h2>
            <p style="color: var(--muted); margin-top: 10px;">Acc√®s r√©serv√© au professeur</p>
            <button class="btn-google" onclick="connexionGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#fff"/>
                </svg>
                Connexion avec Google
            </button>
        </div>
    </div>
    
    <!-- √âCRAN PRINCIPAL -->
    <div id="mainScreen" style="display: none;">
        
        <!-- HEADER -->
        <div class="header">
            <h1>üìä Tableau de Bord</h1>
            <div class="header-actions">
                <a href="suivi.html" class="btn btn-light">‚ûï Saisie</a>
                <a href="historique-suivi.html" class="btn btn-light">üìã Historique</a>
                <a href="index.html" class="btn btn-light">üè† Cockpit</a>
            </div>
        </div>
        
        <!-- FILTRES -->
        <div class="filters">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Classe</label>
                    <select id="filterClasse" onchange="chargerDonnees()">
                        <option value="">Toutes les classes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Statut consultation</label>
                    <select id="filterVu" onchange="filtrerAffichage()">
                        <option value="">Tous</option>
                        <option value="oui">üëÅÔ∏è A consult√©</option>
                        <option value="non">‚ùå Pas encore vu</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-search" onclick="chargerDonnees()">üîç Actualiser</button>
                </div>
            </div>
        </div>
        
        <!-- STATS -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">√âl√®ves</div>
            </div>
            <div class="stat-item">
                <div class="stat-value success" id="statVu">0</div>
                <div class="stat-label">üëÅÔ∏è Ont consult√©</div>
            </div>
            <div class="stat-item">
                <div class="stat-value danger" id="statPasVu">0</div>
                <div class="stat-label">‚ùå Pas vu</div>
            </div>
            <div class="stat-item">
                <div class="stat-value warning" id="statPourcent">0%</div>
                <div class="stat-label">Taux consultation</div>
            </div>
        </div>
        
        <!-- TABLEAU -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>√âl√®ve</th>
                        <th>Classe</th>
                        <th>Derni√®re note</th>
                        <th>üëÅÔ∏è Vu</th>
                        <th>Visites</th>
                        <th>Derni√®re consultation</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <p>S√©lectionnez une classe pour afficher le tableau de bord</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- SECTION BILAN CLASSE -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="bilan-section" id="bilanSection">
            <div class="bilan-header">
                <div>
                    <h2 style="margin: 0; font-size: 1.4em;">üìä Bilan Comportement - <span id="bilanClasseNom">--</span></h2>
                    <p style="margin: 5px 0 0; opacity: 0.9;" id="bilanPeriode">--</p>
                </div>
                <button class="export-btn" onclick="exporterBilan()">üìã Copier pour Pronote</button>
            </div>
            
            <!-- ONGLETS -->
            <div class="bilan-tabs">
                <button class="bilan-tab active" onclick="switchBilanTab('global')">üìä Vue Globale</button>
                <button class="bilan-tab" onclick="switchBilanTab('tops')">üèÜ Tops & Alertes</button>
                <button class="bilan-tab" onclick="switchBilanTab('detail')">üìã D√©tail √âl√®ves</button>
            </div>
            
            <!-- CONTENU GLOBAL -->
            <div class="bilan-content active" id="bilanGlobal">
                <div class="charts-grid">
                    <!-- Travail -->
                    <div class="chart-card">
                        <div class="chart-title">üìù Travail en classe</div>
                        <div id="chartTravail"></div>
                    </div>
                    
                    <!-- Participation -->
                    <div class="chart-card">
                        <div class="chart-title">üó£Ô∏è Participation orale</div>
                        <div id="chartOral"></div>
                    </div>
                    
                    <!-- Attention -->
                    <div class="chart-card">
                        <div class="chart-title">üëÅÔ∏è Attention</div>
                        <div id="chartAttention"></div>
                    </div>
                    
                    <!-- Bavardage -->
                    <div class="chart-card">
                        <div class="chart-title">üí¨ Bavardage</div>
                        <div id="chartBavardage"></div>
                    </div>
                    
                    <!-- T√©l√©phone -->
                    <div class="chart-card">
                        <div class="chart-title">üì± T√©l√©phone</div>
                        <div id="chartTelephone"></div>
                    </div>
                    
                    <!-- Moyenne g√©n√©rale -->
                    <div class="chart-card">
                        <div class="chart-title">‚≠ê Moyenne de suivi</div>
                        <div style="text-align: center;">
                            <div class="donut-chart" id="donutMoyenne"></div>
                            <div id="moyenneDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CONTENU TOPS -->
            <div class="bilan-content" id="bilanTops">
                <div class="charts-grid">
                    <!-- Top Participation -->
                    <div class="chart-card">
                        <div class="chart-title">üèÜ Top Participation Orale</div>
                        <ul class="top-list" id="topOral"></ul>
                    </div>
                    
                    <!-- Top Travail -->
                    <div class="chart-card">
                        <div class="chart-title">üèÜ Top Travail</div>
                        <ul class="top-list" id="topTravail"></ul>
                    </div>
                    
                    <!-- Top Attention -->
                    <div class="chart-card">
                        <div class="chart-title">üèÜ Top Attention</div>
                        <ul class="top-list" id="topAttention"></ul>
                    </div>
                    
                    <!-- Top Notes -->
                    <div class="chart-card">
                        <div class="chart-title">‚≠ê Meilleures moyennes</div>
                        <ul class="top-list" id="topNotes"></ul>
                    </div>
                    
                    <!-- Alertes Bavardage -->
                    <div class="chart-card">
                        <div class="chart-title">‚ö†Ô∏è Alertes Bavardage</div>
                        <ul class="alert-list" id="alertBavardage"></ul>
                    </div>
                    
                    <!-- Alertes T√©l√©phone -->
                    <div class="chart-card">
                        <div class="chart-title">‚ö†Ô∏è Alertes T√©l√©phone</div>
                        <ul class="alert-list" id="alertTelephone"></ul>
                    </div>
                </div>
            </div>
            
            <!-- CONTENU DETAIL -->
            <div class="bilan-content" id="bilanDetail">
                <div class="chart-card" style="overflow-x: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="chart-title" style="margin: 0;">üìã Tableau d√©taill√© par √©l√®ve</div>
                        <button class="export-btn" onclick="copierTableau()" style="font-size: 0.85em; padding: 8px 16px;">üìã Copier</button>
                    </div>
                    <table class="bilan-table" id="bilanTableDetail">
                        <thead>
                            <tr>
                                <th>√âl√®ve</th>
                                <th>S√©ances</th>
                                <th>Moyenne</th>
                                <th>Travail</th>
                                <th>Oral</th>
                                <th>Attention</th>
                                <th>Bavardage</th>
                                <th>T√©l√©phone</th>
                            </tr>
                        </thead>
                        <tbody id="bilanTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </div>
    
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.appspot.com",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    
    let currentUser = null;
    let allData = [];
    
    // V√©rifier l'√©tat de connexion
    onAuthStateChanged(auth, (user) => {
        if (user && user.email === "ennealyon@gmail.com") {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            initClasses();
        } else if (user) {
            alert("Acc√®s non autoris√©");
            signOut(auth);
        }
    });
    
    // Connexion Google
    window.connexionGoogle = async function() {
        try {
            await signInWithPopup(auth, googleProvider);
        } catch (error) {
            if (error.code === 'auth/popup-blocked') {
                await signInWithRedirect(auth, googleProvider);
            } else {
                console.error("Erreur connexion:", error);
                alert("Erreur: " + error.message);
            }
        }
    };
    
    // G√©rer retour redirect
    getRedirectResult(auth).catch(console.error);
    
    // Initialiser les classes dans le select
    function initClasses() {
        const select = document.getElementById('filterClasse');
        
        // D√©finir les groupes
        const groupes = [
            { nom: "BTAGO (group√©)", classes: ["BTAGO1", "BTAGO2"] },
            { nom: "BTMELEC (group√©)", classes: ["BTMELEC"] },
            { nom: "B1AGO (group√©)", classes: ["B1AGO1", "B1AGO2"] },
            { nom: "B2GATL (group√©)", classes: ["B2GATL1", "B2GATL2"] }
        ];
        
        // Ajouter les groupes
        groupes.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.classes.join(',');
            opt.textContent = g.nom;
            select.appendChild(opt);
        });
        
        // Ajouter un s√©parateur
        const sep = document.createElement('option');
        sep.disabled = true;
        sep.textContent = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
        select.appendChild(sep);
        
        // Ajouter les classes individuelles
        const classes = [...new Set((window.BDD_ELEVES || []).map(e => e.classe))].sort();
        classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            select.appendChild(opt);
        });
        
        console.log("‚úÖ Classes charg√©es:", classes.length);
    }
    
    // Charger les donn√©es
    window.chargerDonnees = async function() {
        const filterClasse = document.getElementById('filterClasse').value;
        const tbody = document.getElementById('tableBody');
        
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px;">‚è≥ Chargement...</td></tr>';
        
        try {
            // R√©cup√©rer les √©l√®ves
            let eleves = window.BDD_ELEVES || [];
            if (filterClasse) {
                // G√©rer les groupes (valeur = "BTAGO1,BTAGO2")
                const classesFiltre = filterClasse.split(',');
                eleves = eleves.filter(e => classesFiltre.includes(e.classe));
            }
            
            if (eleves.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üìä</div><p>Aucun √©l√®ve dans cette classe</p></div></td></tr>';
                return;
            }
            
            // R√©cup√©rer les consultations
            const consultationsMap = {};
            try {
                const consultationsSnap = await getDocs(collection(db, "consultations"));
                consultationsSnap.forEach(doc => {
                    consultationsMap[doc.id] = doc.data();
                });
            } catch (err) {
                console.log("‚ö†Ô∏è Pas de donn√©es consultations (collection peut-√™tre vide)");
            }
            
            // R√©cup√©rer les derni√®res notes
            const notesMap = {};
            for (const eleve of eleves) {
                try {
                    const suiviRef = collection(db, "resultats", eleve.userCode, "suivi");
                    const suiviSnap = await getDocs(suiviRef);
                    let derniereNote = null;
                    let derniereDate = null;
                    let dernierAbsent = false;
                    
                    suiviSnap.forEach(docSnap => {
                        const data = docSnap.data();
                        if (!derniereDate || data.date > derniereDate) {
                            derniereDate = data.date;
                            derniereNote = data.noteSur20;
                            dernierAbsent = data.absent === true;
                        }
                    });
                    
                    if (derniereDate) {
                        // On stocke un objet avec note et statut absent
                        notesMap[eleve.userCode] = {
                            note: derniereNote,
                            absent: dernierAbsent
                        };
                    }
                } catch (err) {
                    // Ignorer les erreurs individuelles
                }
            }
            
            // Construire les donn√©es
            allData = eleves.map(e => {
                const consultation = consultationsMap[e.userCode];
                const noteData = notesMap[e.userCode];
                return {
                    code: e.userCode,
                    classe: e.classe,
                    derniereNote: noteData ? noteData.note : null,
                    estAbsent: noteData ? noteData.absent : false,
                    vu: !!consultation,
                    visites: consultation?.nombreVisites || 0,
                    derniereConsultation: consultation?.derniereConsultation || null
                };
            });
            
            // Trier par classe puis code
            allData.sort((a, b) => {
                if (a.classe !== b.classe) return a.classe.localeCompare(b.classe);
                return a.code.localeCompare(b.code);
            });
            
            filtrerAffichage();
            
        } catch (error) {
            console.error("Erreur chargement:", error);
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px; color: #dc2626;">‚ùå Erreur de chargement</td></tr>';
        }
    };
    
    // Filtrer et afficher
    window.filtrerAffichage = function() {
        const filterVu = document.getElementById('filterVu').value;
        
        let data = allData;
        if (filterVu === 'oui') {
            data = data.filter(d => d.vu);
        } else if (filterVu === 'non') {
            data = data.filter(d => !d.vu);
        }
        
        // Stats
        const total = allData.length;
        const vu = allData.filter(d => d.vu).length;
        const pasVu = total - vu;
        const pourcent = total > 0 ? Math.round((vu / total) * 100) : 0;
        
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statVu').textContent = vu;
        document.getElementById('statPasVu').textContent = pasVu;
        document.getElementById('statPourcent').textContent = pourcent + '%';
        
        // Tableau
        const tbody = document.getElementById('tableBody');
        
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>Aucun √©l√®ve trouv√©</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = data.map(d => {
            let noteClass = 'none';
            let noteDisplay = '--';
            
            if (d.estAbsent) {
                noteClass = 'absent';
                noteDisplay = 'ABS';
            } else if (d.derniereNote !== null) {
                noteDisplay = d.derniereNote + '/20';
                if (d.derniereNote >= 16) noteClass = 'excellent';
                else if (d.derniereNote >= 12) noteClass = 'good';
                else if (d.derniereNote >= 8) noteClass = 'average';
                else noteClass = 'poor';
            }
            
            const vuBadge = d.vu 
                ? '<span class="vu-badge oui">üëÅÔ∏è Oui</span>'
                : '<span class="vu-badge non">‚ùå Non</span>';
            
            const visitesDisplay = d.visites > 0 
                ? `<span class="visites-count">${d.visites}</span>`
                : '-';
            
            const dateDisplay = d.derniereConsultation 
                ? formatDate(d.derniereConsultation)
                : '<span style="color: #94a3b8;">Jamais</span>';
            
            return `
                <tr>
                    <td><span class="code-badge">${d.code}</span></td>
                    <td><span class="classe-badge">${d.classe}</span></td>
                    <td><span class="note-badge ${noteClass}">${noteDisplay}</span></td>
                    <td>${vuBadge}</td>
                    <td>${visitesDisplay}</td>
                    <td class="date-consultation">${dateDisplay}</td>
                </tr>
            `;
        }).join('');
    };
    
    function formatDate(isoString) {
        if (!isoString) return '';
        const d = new Date(isoString);
        return d.toLocaleDateString('fr-FR', { 
            day: '2-digit', 
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BILAN CLASSE - STATISTIQUES COMPORTEMENT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    let bilanData = [];
    let currentClasseForBilan = '';
    
    window.switchBilanTab = function(tabId) {
        document.querySelectorAll('.bilan-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.bilan-content').forEach(c => c.classList.remove('active'));
        
        document.querySelector(`.bilan-tab[onclick*="${tabId}"]`).classList.add('active');
        document.getElementById('bilan' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active');
    };
    
    async function chargerBilanClasse(classeId) {
        if (!classeId) {
            document.getElementById('bilanSection').classList.remove('active');
            return;
        }
        
        currentClasseForBilan = classeId;
        const classesEffectives = window.getClassesFromGroupe ? window.getClassesFromGroupe(classeId) : [classeId];
        const eleves = window.ELEVES_DATA ? window.ELEVES_DATA.filter(e => classesEffectives.includes(e.classe)) : [];
        
        if (eleves.length === 0) return;
        
        bilanData = [];
        
        // Charger les donn√©es de suivi pour chaque √©l√®ve
        for (const eleve of eleves) {
            try {
                const suiviRef = collection(db, "resultats", eleve.code, "suivi");
                const suiviSnap = await getDocs(suiviRef);
                
                const suivis = [];
                suiviSnap.forEach(doc => {
                    const data = doc.data();
                    if (!data.absent) suivis.push(data);
                });
                
                if (suivis.length > 0) {
                    bilanData.push({
                        code: eleve.code,
                        classe: eleve.classe,
                        suivis: suivis
                    });
                }
            } catch (err) {
                console.log("Erreur chargement", eleve.code, err);
            }
        }
        
        if (bilanData.length === 0) {
            document.getElementById('bilanSection').classList.remove('active');
            return;
        }
        
        // Afficher la section et calculer les stats
        document.getElementById('bilanSection').classList.add('active');
        document.getElementById('bilanClasseNom').textContent = classeId;
        
        // Trouver la p√©riode
        let minDate = null, maxDate = null;
        bilanData.forEach(e => {
            e.suivis.forEach(s => {
                if (s.date) {
                    if (!minDate || s.date < minDate) minDate = s.date;
                    if (!maxDate || s.date > maxDate) maxDate = s.date;
                }
            });
        });
        
        const nbSeances = bilanData.length > 0 ? Math.max(...bilanData.map(e => e.suivis.length)) : 0;
        document.getElementById('bilanPeriode').textContent = 
            `${bilanData.length} √©l√®ves ‚Ä¢ ${nbSeances} s√©ance(s) max ‚Ä¢ ${minDate || '?'} au ${maxDate || '?'}`;
        
        // Calculer et afficher les stats
        calculerStatsGlobales();
        calculerTopsEtAlertes();
        genererTableauDetail();
    }
    
    function calculerStatsGlobales() {
        // Statistiques globales
        let travailStats = { tresbien: 0, fait: 0, partiel: 0, insuffisant: 0, total: 0 };
        let oralStats = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, total: 0 };
        let attentionStats = { bonne: 0, moyenne: 0, insuffisante: 0, total: 0 };
        let bavardageStats = { aucun: 0, rappel1: 0, rappel2: 0, rappel3: 0, retenu: 0, total: 0 };
        let telephoneStats = { ok: 0, rappel1: 0, rappel2: 0, rappel3: 0, confisque: 0, total: 0 };
        let notesTotal = 0, notesSum = 0;
        
        bilanData.forEach(eleve => {
            eleve.suivis.forEach(s => {
                // Travail
                if (s.travail && s.travail !== 'ne') {
                    travailStats[s.travail] = (travailStats[s.travail] || 0) + 1;
                    travailStats.total++;
                }
                // Oral
                if (s.oral !== undefined && s.oral !== null && s.oral !== 'ne') {
                    oralStats[s.oral] = (oralStats[s.oral] || 0) + 1;
                    oralStats.total++;
                }
                // Attention
                if (s.attention && s.attention !== 'ne') {
                    attentionStats[s.attention] = (attentionStats[s.attention] || 0) + 1;
                    attentionStats.total++;
                }
                // Bavardage
                if (s.bavardage) {
                    bavardageStats[s.bavardage] = (bavardageStats[s.bavardage] || 0) + 1;
                    bavardageStats.total++;
                }
                // T√©l√©phone
                if (s.telephone) {
                    telephoneStats[s.telephone] = (telephoneStats[s.telephone] || 0) + 1;
                    telephoneStats.total++;
                }
                // Notes
                if (s.noteSur20 !== null && s.noteSur20 !== undefined) {
                    notesSum += s.noteSur20;
                    notesTotal++;
                }
            });
        });
        
        // Afficher les graphiques
        afficherBarChart('chartTravail', [
            { label: 'Tr√®s bien', value: travailStats.tresbien, total: travailStats.total, class: 'bar-excellent' },
            { label: 'Fait', value: travailStats.fait, total: travailStats.total, class: 'bar-good' },
            { label: 'Partiel', value: travailStats.partiel, total: travailStats.total, class: 'bar-warning' },
            { label: 'Non fait', value: travailStats.insuffisant, total: travailStats.total, class: 'bar-danger' }
        ]);
        
        afficherBarChart('chartOral', [
            { label: '4 - Excellente', value: oralStats[4], total: oralStats.total, class: 'bar-excellent' },
            { label: '3 - Bonne', value: oralStats[3], total: oralStats.total, class: 'bar-good' },
            { label: '2 - Correcte', value: oralStats[2], total: oralStats.total, class: 'bar-warning' },
            { label: '1 - Faible', value: oralStats[1], total: oralStats.total, class: 'bar-warning' },
            { label: '0 - Aucune', value: oralStats[0], total: oralStats.total, class: 'bar-danger' }
        ]);
        
        afficherBarChart('chartAttention', [
            { label: 'Bonne', value: attentionStats.bonne, total: attentionStats.total, class: 'bar-excellent' },
            { label: 'Moyenne', value: attentionStats.moyenne, total: attentionStats.total, class: 'bar-warning' },
            { label: 'Insuffisante', value: attentionStats.insuffisante, total: attentionStats.total, class: 'bar-danger' }
        ]);
        
        afficherBarChart('chartBavardage', [
            { label: 'Aucun', value: bavardageStats.aucun, total: bavardageStats.total, class: 'bar-excellent' },
            { label: 'Rappel 1', value: bavardageStats.rappel1, total: bavardageStats.total, class: 'bar-warning' },
            { label: 'Rappel 2', value: bavardageStats.rappel2, total: bavardageStats.total, class: 'bar-warning' },
            { label: 'Rappel 3', value: bavardageStats.rappel3, total: bavardageStats.total, class: 'bar-danger' },
            { label: 'Retenu', value: bavardageStats.retenu, total: bavardageStats.total, class: 'bar-danger' }
        ]);
        
        afficherBarChart('chartTelephone', [
            { label: 'OK', value: telephoneStats.ok, total: telephoneStats.total, class: 'bar-excellent' },
            { label: 'Rappel 1', value: telephoneStats.rappel1, total: telephoneStats.total, class: 'bar-warning' },
            { label: 'Rappel 2', value: telephoneStats.rappel2, total: telephoneStats.total, class: 'bar-warning' },
            { label: 'Rappel 3', value: telephoneStats.rappel3, total: telephoneStats.total, class: 'bar-danger' },
            { label: 'Confisqu√©', value: telephoneStats.confisque, total: telephoneStats.total, class: 'bar-danger' }
        ]);
        
        // Moyenne g√©n√©rale
        const moyenne = notesTotal > 0 ? (notesSum / notesTotal).toFixed(1) : '--';
        const moyenneColor = moyenne >= 14 ? '#22c55e' : moyenne >= 10 ? '#f59e0b' : '#ef4444';
        const pct = Math.min(100, (moyenne / 20) * 100);
        
        document.getElementById('donutMoyenne').style.background = 
            `conic-gradient(${moyenneColor} 0% ${pct}%, #e2e8f0 ${pct}% 100%)`;
        document.getElementById('donutMoyenne').innerHTML = `
            <div class="donut-center">
                <div class="donut-value">${moyenne}</div>
                <div class="donut-label">/20</div>
            </div>
        `;
        
        document.getElementById('moyenneDetails').innerHTML = `
            <p style="color: var(--muted); font-size: 0.9em;">${notesTotal} notes ‚Ä¢ ${bilanData.length} √©l√®ves</p>
        `;
    }
    
    function afficherBarChart(containerId, data) {
        const container = document.getElementById(containerId);
        container.innerHTML = data.map(item => {
            const pct = item.total > 0 ? Math.round((item.value / item.total) * 100) : 0;
            return `
                <div class="chart-bar-container">
                    <div class="chart-bar-label">
                        <span>${item.label}</span>
                        <span>${item.value} (${pct}%)</span>
                    </div>
                    <div class="chart-bar-track">
                        <div class="chart-bar-fill ${item.class}" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function calculerTopsEtAlertes() {
        // Calculer les moyennes par √©l√®ve
        const elevesStats = bilanData.map(eleve => {
            let oralSum = 0, oralCount = 0;
            let travailOk = 0, travailTotal = 0;
            let attentionOk = 0, attentionTotal = 0;
            let bavardageRappels = 0;
            let telephoneRappels = 0;
            let noteSum = 0, noteCount = 0;
            
            eleve.suivis.forEach(s => {
                if (s.oral !== undefined && s.oral !== null && s.oral !== 'ne') {
                    oralSum += parseInt(s.oral);
                    oralCount++;
                }
                if (s.travail && s.travail !== 'ne') {
                    if (s.travail === 'tresbien' || s.travail === 'fait') travailOk++;
                    travailTotal++;
                }
                if (s.attention && s.attention !== 'ne') {
                    if (s.attention === 'bonne') attentionOk++;
                    attentionTotal++;
                }
                if (s.bavardage && s.bavardage !== 'aucun' && s.bavardage !== 'ne') bavardageRappels++;
                if (s.telephone && s.telephone !== 'ok' && s.telephone !== 'ne') telephoneRappels++;
                if (s.noteSur20 !== null && s.noteSur20 !== undefined) {
                    noteSum += s.noteSur20;
                    noteCount++;
                }
            });
            
            return {
                code: eleve.code,
                oralMoy: oralCount > 0 ? (oralSum / oralCount).toFixed(1) : 0,
                travailPct: travailTotal > 0 ? Math.round((travailOk / travailTotal) * 100) : 0,
                attentionPct: attentionTotal > 0 ? Math.round((attentionOk / attentionTotal) * 100) : 0,
                bavardageRappels: bavardageRappels,
                telephoneRappels: telephoneRappels,
                noteMoy: noteCount > 0 ? (noteSum / noteCount).toFixed(1) : 0,
                nbSeances: eleve.suivis.length
            };
        });
        
        // Top Oral
        const topOral = [...elevesStats].sort((a, b) => b.oralMoy - a.oralMoy).slice(0, 5);
        document.getElementById('topOral').innerHTML = topOral.map((e, i) => `
            <li class="top-item">
                <span class="top-rank rank-${i + 1}">${i + 1}</span>
                <span class="top-name">${e.code}</span>
                <span class="top-value">${e.oralMoy}/4</span>
            </li>
        `).join('');
        
        // Top Travail
        const topTravail = [...elevesStats].sort((a, b) => b.travailPct - a.travailPct).slice(0, 5);
        document.getElementById('topTravail').innerHTML = topTravail.map((e, i) => `
            <li class="top-item">
                <span class="top-rank rank-${i + 1}">${i + 1}</span>
                <span class="top-name">${e.code}</span>
                <span class="top-value">${e.travailPct}%</span>
            </li>
        `).join('');
        
        // Top Attention
        const topAttention = [...elevesStats].sort((a, b) => b.attentionPct - a.attentionPct).slice(0, 5);
        document.getElementById('topAttention').innerHTML = topAttention.map((e, i) => `
            <li class="top-item">
                <span class="top-rank rank-${i + 1}">${i + 1}</span>
                <span class="top-name">${e.code}</span>
                <span class="top-value">${e.attentionPct}%</span>
            </li>
        `).join('');
        
        // Top Notes
        const topNotes = [...elevesStats].filter(e => e.noteMoy > 0).sort((a, b) => b.noteMoy - a.noteMoy).slice(0, 5);
        document.getElementById('topNotes').innerHTML = topNotes.map((e, i) => `
            <li class="top-item">
                <span class="top-rank rank-${i + 1}">${i + 1}</span>
                <span class="top-name">${e.code}</span>
                <span class="top-value">${e.noteMoy}/20</span>
            </li>
        `).join('');
        
        // Alertes Bavardage
        const alertsBav = [...elevesStats].filter(e => e.bavardageRappels > 0).sort((a, b) => b.bavardageRappels - a.bavardageRappels);
        document.getElementById('alertBavardage').innerHTML = alertsBav.length > 0 ? alertsBav.map(e => `
            <li class="alert-item ${e.bavardageRappels >= 3 ? 'danger' : ''}">
                <span style="flex: 1; font-weight: 600;">${e.code}</span>
                <span style="font-weight: 700; color: ${e.bavardageRappels >= 3 ? '#dc2626' : '#d97706'};">${e.bavardageRappels} rappel(s)</span>
            </li>
        `).join('') : '<li class="top-item" style="color: #22c55e;">‚úÖ Aucune alerte</li>';
        
        // Alertes T√©l√©phone
        const alertsTel = [...elevesStats].filter(e => e.telephoneRappels > 0).sort((a, b) => b.telephoneRappels - a.telephoneRappels);
        document.getElementById('alertTelephone').innerHTML = alertsTel.length > 0 ? alertsTel.map(e => `
            <li class="alert-item ${e.telephoneRappels >= 2 ? 'danger' : ''}">
                <span style="flex: 1; font-weight: 600;">${e.code}</span>
                <span style="font-weight: 700; color: ${e.telephoneRappels >= 2 ? '#dc2626' : '#d97706'};">${e.telephoneRappels} rappel(s)</span>
            </li>
        `).join('') : '<li class="top-item" style="color: #22c55e;">‚úÖ Aucune alerte</li>';
    }
    
    function genererTableauDetail() {
        const elevesStats = bilanData.map(eleve => {
            let oralSum = 0, oralCount = 0;
            let travailOk = 0, travailTotal = 0;
            let attentionOk = 0, attentionTotal = 0;
            let bavardageRappels = 0;
            let telephoneRappels = 0;
            let noteSum = 0, noteCount = 0;
            
            eleve.suivis.forEach(s => {
                if (s.oral !== undefined && s.oral !== null && s.oral !== 'ne') {
                    oralSum += parseInt(s.oral);
                    oralCount++;
                }
                if (s.travail && s.travail !== 'ne') {
                    if (s.travail === 'tresbien' || s.travail === 'fait') travailOk++;
                    travailTotal++;
                }
                if (s.attention && s.attention !== 'ne') {
                    if (s.attention === 'bonne') attentionOk++;
                    attentionTotal++;
                }
                if (s.bavardage && s.bavardage !== 'aucun' && s.bavardage !== 'ne') bavardageRappels++;
                if (s.telephone && s.telephone !== 'ok' && s.telephone !== 'ne') telephoneRappels++;
                if (s.noteSur20 !== null && s.noteSur20 !== undefined) {
                    noteSum += s.noteSur20;
                    noteCount++;
                }
            });
            
            return {
                code: eleve.code,
                nbSeances: eleve.suivis.length,
                noteMoy: noteCount > 0 ? (noteSum / noteCount).toFixed(1) : '--',
                travailPct: travailTotal > 0 ? Math.round((travailOk / travailTotal) * 100) : '--',
                oralMoy: oralCount > 0 ? (oralSum / oralCount).toFixed(1) : '--',
                attentionPct: attentionTotal > 0 ? Math.round((attentionOk / attentionTotal) * 100) : '--',
                bavardageRappels: bavardageRappels,
                telephoneRappels: telephoneRappels
            };
        }).sort((a, b) => a.code.localeCompare(b.code));
        
        const tbody = document.getElementById('bilanTableBody');
        tbody.innerHTML = elevesStats.map(e => {
            const noteBadge = e.noteMoy === '--' ? '' : 
                e.noteMoy >= 14 ? 'badge-success' : e.noteMoy >= 10 ? 'badge-warning' : 'badge-danger';
            const travailBadge = e.travailPct === '--' ? '' :
                e.travailPct >= 80 ? 'badge-success' : e.travailPct >= 50 ? 'badge-warning' : 'badge-danger';
            const attentionBadge = e.attentionPct === '--' ? '' :
                e.attentionPct >= 70 ? 'badge-success' : e.attentionPct >= 40 ? 'badge-warning' : 'badge-danger';
            const bavBadge = e.bavardageRappels === 0 ? 'badge-success' : 
                e.bavardageRappels <= 2 ? 'badge-warning' : 'badge-danger';
            const telBadge = e.telephoneRappels === 0 ? 'badge-success' : 
                e.telephoneRappels <= 1 ? 'badge-warning' : 'badge-danger';
            
            return `
                <tr>
                    <td><strong>${e.code}</strong></td>
                    <td>${e.nbSeances}</td>
                    <td><span class="badge ${noteBadge}">${e.noteMoy}</span></td>
                    <td><span class="badge ${travailBadge}">${e.travailPct}${e.travailPct !== '--' ? '%' : ''}</span></td>
                    <td>${e.oralMoy}${e.oralMoy !== '--' ? '/4' : ''}</td>
                    <td><span class="badge ${attentionBadge}">${e.attentionPct}${e.attentionPct !== '--' ? '%' : ''}</span></td>
                    <td><span class="badge ${bavBadge}">${e.bavardageRappels}</span></td>
                    <td><span class="badge ${telBadge}">${e.telephoneRappels}</span></td>
                </tr>
            `;
        }).join('');
    }
    
    window.exporterBilan = function() {
        const classe = currentClasseForBilan;
        let texte = `üìä BILAN COMPORTEMENT - ${classe}\n`;
        texte += `${'‚ïê'.repeat(40)}\n\n`;
        
        // Calculer les stats
        const elevesStats = bilanData.map(eleve => {
            let oralSum = 0, oralCount = 0;
            let travailOk = 0, travailTotal = 0;
            let attentionOk = 0, attentionTotal = 0;
            let bavardageRappels = 0;
            let telephoneRappels = 0;
            let noteSum = 0, noteCount = 0;
            
            eleve.suivis.forEach(s => {
                if (s.oral !== undefined && s.oral !== null && s.oral !== 'ne') {
                    oralSum += parseInt(s.oral);
                    oralCount++;
                }
                if (s.travail && s.travail !== 'ne') {
                    if (s.travail === 'tresbien' || s.travail === 'fait') travailOk++;
                    travailTotal++;
                }
                if (s.attention && s.attention !== 'ne') {
                    if (s.attention === 'bonne') attentionOk++;
                    attentionTotal++;
                }
                if (s.bavardage && s.bavardage !== 'aucun' && s.bavardage !== 'ne') bavardageRappels++;
                if (s.telephone && s.telephone !== 'ok' && s.telephone !== 'ne') telephoneRappels++;
                if (s.noteSur20 !== null && s.noteSur20 !== undefined) {
                    noteSum += s.noteSur20;
                    noteCount++;
                }
            });
            
            return {
                code: eleve.code,
                nbSeances: eleve.suivis.length,
                noteMoy: noteCount > 0 ? (noteSum / noteCount).toFixed(1) : '--',
                travailPct: travailTotal > 0 ? Math.round((travailOk / travailTotal) * 100) : 0,
                oralMoy: oralCount > 0 ? (oralSum / oralCount).toFixed(1) : 0,
                attentionPct: attentionTotal > 0 ? Math.round((attentionOk / attentionTotal) * 100) : 0,
                bavardageRappels: bavardageRappels,
                telephoneRappels: telephoneRappels
            };
        }).sort((a, b) => a.code.localeCompare(b.code));
        
        texte += `√âl√®ve\tS√©ances\tMoyenne\tTravail%\tOral/4\tAttention%\tBavardage\tT√©l√©phone\n`;
        elevesStats.forEach(e => {
            texte += `${e.code}\t${e.nbSeances}\t${e.noteMoy}\t${e.travailPct}%\t${e.oralMoy}\t${e.attentionPct}%\t${e.bavardageRappels}\t${e.telephoneRappels}\n`;
        });
        
        navigator.clipboard.writeText(texte).then(() => {
            alert("‚úÖ Bilan copi√© ! Vous pouvez le coller dans Pronote ou Excel.");
        }).catch(err => {
            console.error("Erreur copie:", err);
            prompt("Copiez ce texte :", texte);
        });
    };
    
    window.copierTableau = function() {
        const table = document.getElementById('bilanTableDetail');
        let texte = '';
        
        // Headers
        const headers = table.querySelectorAll('thead th');
        texte += Array.from(headers).map(th => th.textContent).join('\t') + '\n';
        
        // Rows
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            texte += Array.from(cells).map(td => td.textContent.trim()).join('\t') + '\n';
        });
        
        navigator.clipboard.writeText(texte).then(() => {
            alert("‚úÖ Tableau copi√© !");
        }).catch(err => {
            prompt("Copiez ce texte :", texte);
        });
    };
    
    // Modifier la fonction chargerDonnees existante pour appeler aussi le bilan
    const originalChargerDonnees = window.chargerDonnees;
    window.chargerDonnees = async function() {
        await originalChargerDonnees();
        const classeId = document.getElementById('selectClasse').value;
        await chargerBilanClasse(classeId);
    };
    
    console.log("‚úÖ Dashboard pr√™t");
</script>

</body>
</html>

    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --primary: #8b5cf6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #dc2626;
            --border: #e2e8f0;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* === HEADER === */
        .header {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-light {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .btn-light:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* === FILTRES === */
        .filters {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: var(--muted);
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
        }
        
        .btn-search {
            background: var(--primary);
            color: white;
            width: 100%;
        }
        
        /* === STATS === */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: var(--card);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--primary);
        }
        
        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.danger { color: var(--danger); }
        
        .note-badge.absent { background: #fef3c7; color: #92400e; }
        
        .stat-label {
            font-size: 0.8em;
            color: var(--muted);
            margin-top: 5px;
        }
        
        /* === TABLEAU === */
        .table-container {
            background: var(--card);
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: #f8fafc;
            font-weight: 700;
            font-size: 0.8em;
            text-transform: uppercase;
            color: var(--muted);
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .code-badge {
            font-weight: 700;
            background: #eff6ff;
            color: #3b82f6;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .classe-badge {
            font-size: 0.85em;
            color: var(--muted);
        }
        
        .note-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.9em;
        }
        
        .note-badge.excellent { background: #dcfce7; color: #166534; }
        .note-badge.good { background: #dbeafe; color: #1e40af; }
        .note-badge.average { background: #fef3c7; color: #92400e; }
        .note-badge.poor { background: #fee2e2; color: #991b1b; }
        .note-badge.none { background: #f1f5f9; color: #64748b; }
        
        .vu-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .vu-badge.oui { background: #dcfce7; color: #166534; }
        .vu-badge.non { background: #fee2e2; color: #991b1b; }
        
        .date-consultation {
            font-size: 0.85em;
            color: var(--muted);
        }
        
        .visites-count {
            background: #eff6ff;
            color: #3b82f6;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        /* === EMPTY STATE === */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        /* === LOGIN === */
        .login-screen {
            max-width: 400px;
            margin: 60px auto;
            text-align: center;
        }
        
        .login-card {
            background: var(--card);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .login-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .btn-google {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 14px 28px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .btn-google:hover {
            background: #3367d6;
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .filters-grid { grid-template-columns: 1fr; }
            .stats-bar { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- √âCRAN LOGIN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-icon">üîê</div>
            <h2>Tableau de Bord</h2>
            <p style="color: var(--muted); margin-top: 10px;">Acc√®s r√©serv√© au professeur</p>
            <button class="btn-google" onclick="connexionGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#fff"/>
                </svg>
                Connexion avec Google
            </button>
        </div>
    </div>
    
    <!-- √âCRAN PRINCIPAL -->
    <div id="mainScreen" style="display: none;">
        
        <!-- HEADER -->
        <div class="header">
            <h1>üìä Tableau de Bord</h1>
            <div class="header-actions">
                <a href="suivi.html" class="btn btn-light">‚ûï Saisie</a>
                <a href="historique-suivi.html" class="btn btn-light">üìã Historique</a>
                <a href="index.html" class="btn btn-light">üè† Cockpit</a>
            </div>
        </div>
        
        <!-- FILTRES -->
        <div class="filters">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Classe</label>
                    <select id="filterClasse" onchange="chargerDonnees()">
                        <option value="">Toutes les classes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Statut consultation</label>
                    <select id="filterVu" onchange="filtrerAffichage()">
                        <option value="">Tous</option>
                        <option value="oui">üëÅÔ∏è A consult√©</option>
                        <option value="non">‚ùå Pas encore vu</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-search" onclick="chargerDonnees()">üîç Actualiser</button>
                </div>
            </div>
        </div>
        
        <!-- STATS -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">√âl√®ves</div>
            </div>
            <div class="stat-item">
                <div class="stat-value success" id="statVu">0</div>
                <div class="stat-label">üëÅÔ∏è Ont consult√©</div>
            </div>
            <div class="stat-item">
                <div class="stat-value danger" id="statPasVu">0</div>
                <div class="stat-label">‚ùå Pas vu</div>
            </div>
            <div class="stat-item">
                <div class="stat-value warning" id="statPourcent">0%</div>
                <div class="stat-label">Taux consultation</div>
            </div>
        </div>
        
        <!-- TABLEAU -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>√âl√®ve</th>
                        <th>Classe</th>
                        <th>Derni√®re note</th>
                        <th>üëÅÔ∏è Vu</th>
                        <th>Visites</th>
                        <th>Derni√®re consultation</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <p>S√©lectionnez une classe pour afficher le tableau de bord</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
    </div>
    
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.appspot.com",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    
    let currentUser = null;
    let allData = [];
    
    // V√©rifier l'√©tat de connexion
    onAuthStateChanged(auth, (user) => {
        if (user && user.email === "ennealyon@gmail.com") {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            initClasses();
        } else if (user) {
            alert("Acc√®s non autoris√©");
            signOut(auth);
        }
    });
    
    // Connexion Google
    window.connexionGoogle = async function() {
        try {
            await signInWithPopup(auth, googleProvider);
        } catch (error) {
            if (error.code === 'auth/popup-blocked') {
                await signInWithRedirect(auth, googleProvider);
            } else {
                console.error("Erreur connexion:", error);
                alert("Erreur: " + error.message);
            }
        }
    };
    
    // G√©rer retour redirect
    getRedirectResult(auth).catch(console.error);
    
    // Initialiser les classes dans le select
    function initClasses() {
        const select = document.getElementById('filterClasse');
        
        // D√©finir les groupes
        const groupes = [
            { nom: "BTAGO (group√©)", classes: ["BTAGO1", "BTAGO2"] },
            { nom: "BTMELEC (group√©)", classes: ["BTMELEC"] },
            { nom: "B1AGO (group√©)", classes: ["B1AGO1", "B1AGO2"] },
            { nom: "B2GATL (group√©)", classes: ["B2GATL1", "B2GATL2"] }
        ];
        
        // Ajouter les groupes
        groupes.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.classes.join(',');
            opt.textContent = g.nom;
            select.appendChild(opt);
        });
        
        // Ajouter un s√©parateur
        const sep = document.createElement('option');
        sep.disabled = true;
        sep.textContent = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
        select.appendChild(sep);
        
        // Ajouter les classes individuelles
        const classes = [...new Set((window.BDD_ELEVES || []).map(e => e.classe))].sort();
        classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            select.appendChild(opt);
        });
        
        console.log("‚úÖ Classes charg√©es:", classes.length);
    }
    
    // Charger les donn√©es
    window.chargerDonnees = async function() {
        const filterClasse = document.getElementById('filterClasse').value;
        const tbody = document.getElementById('tableBody');
        
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px;">‚è≥ Chargement...</td></tr>';
        
        try {
            // R√©cup√©rer les √©l√®ves
            let eleves = window.BDD_ELEVES || [];
            if (filterClasse) {
                // G√©rer les groupes (valeur = "BTAGO1,BTAGO2")
                const classesFiltre = filterClasse.split(',');
                eleves = eleves.filter(e => classesFiltre.includes(e.classe));
            }
            
            if (eleves.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üìä</div><p>Aucun √©l√®ve dans cette classe</p></div></td></tr>';
                return;
            }
            
            // R√©cup√©rer les consultations
            const consultationsMap = {};
            try {
                const consultationsSnap = await getDocs(collection(db, "consultations"));
                consultationsSnap.forEach(doc => {
                    consultationsMap[doc.id] = doc.data();
                });
            } catch (err) {
                console.log("‚ö†Ô∏è Pas de donn√©es consultations (collection peut-√™tre vide)");
            }
            
            // R√©cup√©rer les derni√®res notes
            const notesMap = {};
            for (const eleve of eleves) {
                try {
                    const suiviRef = collection(db, "resultats", eleve.userCode, "suivi");
                    const suiviSnap = await getDocs(suiviRef);
                    let derniereNote = null;
                    let derniereDate = null;
                    let dernierAbsent = false;
                    
                    suiviSnap.forEach(docSnap => {
                        const data = docSnap.data();
                        if (!derniereDate || data.date > derniereDate) {
                            derniereDate = data.date;
                            derniereNote = data.noteSur20;
                            dernierAbsent = data.absent === true;
                        }
                    });
                    
                    if (derniereDate) {
                        // On stocke un objet avec note et statut absent
                        notesMap[eleve.userCode] = {
                            note: derniereNote,
                            absent: dernierAbsent
                        };
                    }
                } catch (err) {
                    // Ignorer les erreurs individuelles
                }
            }
            
            // Construire les donn√©es
            allData = eleves.map(e => {
                const consultation = consultationsMap[e.userCode];
                const noteData = notesMap[e.userCode];
                return {
                    code: e.userCode,
                    classe: e.classe,
                    derniereNote: noteData ? noteData.note : null,
                    estAbsent: noteData ? noteData.absent : false,
                    vu: !!consultation,
                    visites: consultation?.nombreVisites || 0,
                    derniereConsultation: consultation?.derniereConsultation || null
                };
            });
            
            // Trier par classe puis code
            allData.sort((a, b) => {
                if (a.classe !== b.classe) return a.classe.localeCompare(b.classe);
                return a.code.localeCompare(b.code);
            });
            
            filtrerAffichage();
            
        } catch (error) {
            console.error("Erreur chargement:", error);
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px; color: #dc2626;">‚ùå Erreur de chargement</td></tr>';
        }
    };
    
    // Filtrer et afficher
    window.filtrerAffichage = function() {
        const filterVu = document.getElementById('filterVu').value;
        
        let data = allData;
        if (filterVu === 'oui') {
            data = data.filter(d => d.vu);
        } else if (filterVu === 'non') {
            data = data.filter(d => !d.vu);
        }
        
        // Stats
        const total = allData.length;
        const vu = allData.filter(d => d.vu).length;
        const pasVu = total - vu;
        const pourcent = total > 0 ? Math.round((vu / total) * 100) : 0;
        
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statVu').textContent = vu;
        document.getElementById('statPasVu').textContent = pasVu;
        document.getElementById('statPourcent').textContent = pourcent + '%';
        
        // Tableau
        const tbody = document.getElementById('tableBody');
        
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>Aucun √©l√®ve trouv√©</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = data.map(d => {
            let noteClass = 'none';
            let noteDisplay = '--';
            
            if (d.estAbsent) {
                noteClass = 'absent';
                noteDisplay = 'ABS';
            } else if (d.derniereNote !== null) {
                noteDisplay = d.derniereNote + '/20';
                if (d.derniereNote >= 16) noteClass = 'excellent';
                else if (d.derniereNote >= 12) noteClass = 'good';
                else if (d.derniereNote >= 8) noteClass = 'average';
                else noteClass = 'poor';
            }
            
            const vuBadge = d.vu 
                ? '<span class="vu-badge oui">üëÅÔ∏è Oui</span>'
                : '<span class="vu-badge non">‚ùå Non</span>';
            
            const visitesDisplay = d.visites > 0 
                ? `<span class="visites-count">${d.visites}</span>`
                : '-';
            
            const dateDisplay = d.derniereConsultation 
                ? formatDate(d.derniereConsultation)
                : '<span style="color: #94a3b8;">Jamais</span>';
            
            return `
                <tr>
                    <td><span class="code-badge">${d.code}</span></td>
                    <td><span class="classe-badge">${d.classe}</span></td>
                    <td><span class="note-badge ${noteClass}">${noteDisplay}</span></td>
                    <td>${vuBadge}</td>
                    <td>${visitesDisplay}</td>
                    <td class="date-consultation">${dateDisplay}</td>
                </tr>
            `;
        }).join('');
    };
    
    function formatDate(isoString) {
        if (!isoString) return '';
        const d = new Date(isoString);
        return d.toLocaleDateString('fr-FR', { 
            day: '2-digit', 
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    console.log("‚úÖ Dashboard pr√™t");
</script>

</body>
</html>

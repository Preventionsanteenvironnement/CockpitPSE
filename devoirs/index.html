<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Devoirs ‚Äî Cockpit PSE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{--primary:#4f46e5;--bg:#f3f4f6;--card:#fff;}
    body{font-family:'Segoe UI',sans-serif;background:var(--bg);margin:0;padding:20px;color:#111827}
    #login-screen{position:fixed;inset:0;background:#1e1e2f;display:flex;justify-content:center;align-items:center;z-index:9999}
    .login-box{text-align:center;padding:30px;background:white;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.5);width:320px}
    .login-box input{width:100%;padding:12px;margin:15px 0;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
    .login-box button{width:100%;padding:12px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:1rem}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;background:white;padding:18px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    h1{margin:0;color:var(--primary);font-size:1.25rem}
    .sub{color:#6b7280;font-size:.9rem;margin-top:6px}
    button.refresh{background:#e0e7ff;color:#4338ca;border:none;padding:8px 14px;border-radius:20px;cursor:pointer;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-bottom:12px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,.05);border:1px solid #e5e7eb}
    .big{font-size:2rem;font-weight:800;color:var(--primary)}
    .label{color:#6b7280;font-size:.85rem}
    .table-container{overflow-x:auto}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th{padding:10px;background:#f9fafb;color:#4b5563;font-size:.8rem;text-transform:uppercase}
    td{padding:10px;border-bottom:1px solid #f3f4f6;font-size:.92rem;vertical-align:top}
    tr:hover{background:#f9fafb}
    .btn{padding:6px 10px;border-radius:10px;border:1px solid #d1d5db;background:white;cursor:pointer;font-weight:700}
    .btn.primary{border-color:#c7d2fe;background:#eef2ff;color:#3730a3}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:800;font-size:.75rem}
    .muted{color:#6b7280}
    /* modal */
    #modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9998}
    #modal .box{width:min(980px,92vw);max-height:86vh;background:white;border-radius:14px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,.4)}
    #modal header{margin:0;border-radius:0;box-shadow:none;border-bottom:1px solid #e5e7eb}
    #modal pre{margin:0;padding:14px;overflow:auto;max-height:calc(86vh - 70px);background:#0b1020;color:#d1e7ff;font-size:12px}
  </style>
</head>
<body>

<div id="login-screen">
  <div class="login-box">
    <h2 style="margin-top:0;">üîí Zone Professeur</h2>
    <p style="color:#666;font-size:0.9rem;">Entrez votre code d'acc√®s</p>
    <input type="password" id="password-input" placeholder="Mot de passe...">
    <button onclick="verifierMotDePasse()">Acc√©der</button>
  </div>
</div>

<div id="app" style="display:none;max-width:1250px;margin:0 auto;">
  <header>
    <div>
      <h1>üìù Devoirs ‚Äî Rendus √©l√®ves</h1>
      <div class="sub">Collection : <strong>devoirs_rendus</strong></div>
    </div>
    <button class="refresh" onclick="charger()">üîÑ Actualiser</button>
  </header>

  <div class="grid">
    <div class="card">
      <div class="label">Copies re√ßues</div>
      <div class="big" id="nb">--</div>
      <div class="muted">Total rendus</div>
    </div>
    <div class="card">
      <div class="label">Dernier rendu</div>
      <div class="big" id="last">--</div>
      <div class="muted">date</div>
    </div>
    <div class="card">
      <div class="label">Devoirs (types)</div>
      <div class="big" id="types">--</div>
      <div class="muted">devoirId distincts</div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
      <span class="pill">Filtres</span>
      <input id="fClasse" placeholder="Classe (ex: C2 MELEC)" style="padding:10px;border-radius:10px;border:1px solid #d1d5db;min-width:220px">
      <input id="fDevoir" placeholder="DevoirId (ex: CAP_A3_...)" style="padding:10px;border-radius:10px;border:1px solid #d1d5db;min-width:240px">
      <button class="btn primary" onclick="charger()">Appliquer</button>
      <button class="btn" onclick="resetFiltres()">Reset</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>√âl√®ve</th>
            <th>Classe</th>
            <th>Devoir</th>
            <th>Titre</th>
            <th>Auto</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" style="text-align:center;color:#999">En attente‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="modal">
  <div class="box">
    <header style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:white">
      <div style="font-weight:900;color:#111827" id="modalTitle">Copie</div>
      <button class="btn" onclick="closeModal()">Fermer</button>
    </header>
    <pre id="modalPre"></pre>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (s)=>document.querySelector(s);

  // stockage en m√©moire pour √©viter les gros onclick
  window._devoirDocs = {};

  window.verifierMotDePasse = function(){
    const pass = $("#password-input").value;
    if(pass === "profpse"){
      $("#login-screen").style.display="none";
      $("#app").style.display="block";
      charger();
    } else {
      alert("Mot de passe incorrect ‚õî");
    }
  }

  window.resetFiltres = function(){
    $("#fClasse").value="";
    $("#fDevoir").value="";
    charger();
  }

  function fmtDate(doc){
    const iso = doc.createdAtISO;
    if(iso) return new Date(iso).toLocaleString("fr-FR");
    const ts = doc.createdAt;
    if(ts && ts.seconds) return new Date(ts.seconds*1000).toLocaleString("fr-FR");
    return "-";
  }

  function autoScore(doc){
    const s = doc?.resultat_auto?.score;
    const m = doc?.resultat_auto?.maxScore;
    if(s==null && m==null) return "-";
    if(m!=null) return `${s ?? 0}/${m}`;
    return String(s ?? "-");
  }

  function safeName(doc){
    const e = doc.eleve || {};
    const parts = [];
    if(e.code) parts.push(e.code);
    if(e.nom || e.prenom) parts.push(`${e.nom||""} ${e.prenom||""}`.trim());
    return parts.join(" ‚Äî ") || "?";
  }

  function matchesFilter(doc){
    const fC = ($("#fClasse").value || "").trim().toLowerCase();
    const fD = ($("#fDevoir").value || "").trim().toLowerCase();
    const classe = (doc?.eleve?.classe || doc?.eleve?.classeCode || "").toString().toLowerCase();
    const devoirId = (doc?.devoirId || "").toString().toLowerCase();
    if(fC && !classe.includes(fC)) return false;
    if(fD && !devoirId.includes(fD)) return false;
    return true;
  }

  window.openModalById = function(id){
    const obj = window._devoirDocs[id];
    if(!obj) return;
    $("#modalTitle").textContent = `${obj.devoirId || "Devoir"} ‚Äî ${safeName(obj)}`;
    $("#modalPre").textContent = JSON.stringify(obj, null, 2);
    $("#modal").style.display="flex";
  }

  window.downloadById = function(id){
    const obj = window._devoirDocs[id];
    if(!obj) return;
    const classeStr = (obj?.eleve?.classe || obj?.eleve?.classeCode || "");
    const fn = `devoir_${(classeStr||"").replace(/\s+/g,"_")}_${(obj?.eleve?.code||"")}_${(obj?.devoirId||"")}.json`
      .replace(/[^\w\-.]+/g,"_").slice(0,120);

    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download=fn;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  window.closeModal = function(){ $("#modal").style.display="none"; }

  window.charger = async function(){
    const tbody = $("#tbody");
    tbody.innerHTML = "<tr><td colspan='7' style='text-align:center;color:#999'>Chargement‚Ä¶</td></tr>";
    window._devoirDocs = {};

    const q = query(collection(db, "devoirs_rendus"), orderBy("createdAtISO","desc"));
    const snap = await getDocs(q);

    $("#nb").textContent = snap.size;

    let last = "--";
    let ids = new Set();
    const rows = [];

    snap.forEach(d=>{
      const doc = d.data();
      if(!matchesFilter(doc)) return;

      ids.add(doc.devoirId || "?");
      if(last==="--") last = fmtDate(doc);

      const fullObj = { id: d.id, ...doc };
      window._devoirDocs[d.id] = fullObj;

      rows.push(`<tr>
        <td>${fmtDate(doc)}</td>
        <td><strong>${safeName(doc)}</strong></td>
        <td>${(doc?.eleve?.classe || doc?.eleve?.classeCode || doc?.classe || "")}</td>
        <td>${doc.devoirId || ""}</td>
        <td>${doc.titre || ""}</td>
        <td>${autoScore(doc)}</td>
        <td>
          <button class="btn primary" onclick="openModalById('${d.id}')">Voir</button>
          <button class="btn" onclick="downloadById('${d.id}')">T√©l√©charger</button>
        </td>
      </tr>`);
    });

    $("#last").textContent = last;
    $("#types").textContent = ids.size || 0;

    tbody.innerHTML = rows.length ? rows.join("") : "<tr><td colspan='7' style='text-align:center'>Aucune copie (avec ces filtres).</td></tr>";
  }
</script>

</body>
</html>

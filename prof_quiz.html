<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSE Quiz Live ‚Äî Prof</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a; color: white; height: 100vh; display: flex; overflow: hidden;
        }

        /* === SIDEBAR === */
        #sidebar {
            width: 360px; min-width: 360px; background: #1e293b; display: flex; flex-direction: column;
            border-right: 1px solid #334155; overflow-y: auto;
        }
        #sidebar::-webkit-scrollbar { width: 4px; }
        #sidebar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .sidebar-header {
            padding: 16px; border-bottom: 1px solid #334155; display: flex;
            align-items: center; justify-content: space-between;
        }
        .sidebar-header h2 { font-size: 1.1rem; }
        .sidebar-section {
            padding: 14px; border-bottom: 1px solid #334155;
        }
        .sidebar-section label {
            font-size: 0.7rem; color: #64748b; text-transform: uppercase;
            letter-spacing: 1px; display: block; margin-bottom: 8px;
        }

        /* Session bar */
        #session-bar { background: #1a1a2e; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .session-btns { display: flex; gap: 6px; margin-top: 6px; }
        .session-btns button {
            flex: 1; padding: 8px; border: none; border-radius: 6px;
            font-weight: 700; cursor: pointer; font-size: 0.8rem; color: white;
        }
        #session-code-display {
            text-align: center; margin-top: 10px; font-size: 2rem; font-weight: 900;
            color: #f59e0b; letter-spacing: 4px; display: none;
        }
        #session-id-display { font-size: 0.65rem; color: #475569; text-align: center; margin-top: 4px; }
        #qr-section { text-align: center; margin-top: 10px; display: none; }
        #qr-code { width: 100px; height: 100px; border-radius: 8px; background: white; padding: 3px; }
        #qr-label { font-size: 0.6rem; color: #64748b; margin-top: 4px; }

        /* Quiz selector */
        .quiz-select {
            width: 100%; padding: 8px; background: #0f172a; color: white;
            border: 1px solid #475569; border-radius: 6px; font-size: 0.85rem;
        }
        .quiz-select:focus { border-color: #3b82f6; outline: none; }
        .quiz-info { font-size: 0.7rem; color: #64748b; margin-top: 6px; font-style: italic; }

        /* Controls */
        .ctrl-btn {
            width: 100%; padding: 10px; border: none; border-radius: 8px;
            font-weight: 700; cursor: pointer; font-size: 0.9rem; margin-bottom: 6px;
            transition: opacity 0.2s;
        }
        .ctrl-btn:hover { opacity: 0.85; }
        .ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .ctrl-launch { background: #22c55e; color: white; }
        .ctrl-next { background: #3b82f6; color: white; }
        .ctrl-end { background: #ef4444; color: white; }

        /* timer input is styled inline */

        /* Mode toggle */
        .mode-toggle { display: flex; gap: 6px; margin-bottom: 10px; }
        .mode-btn {
            flex: 1; padding: 8px; border: none; border-radius: 8px;
            font-weight: 700; cursor: pointer; font-size: 0.8rem;
            transition: all 0.2s;
        }
        .mode-btn.active { background: #3b82f6; color: white; }
        .mode-btn.inactive { background: #1e293b; color: #64748b; border: 1px solid #475569; }

        /* Presence list */
        .presence-list { max-height: 200px; overflow-y: auto; }
        .presence-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 8px; background: #0f172a; border-radius: 6px; margin-bottom: 4px;
            font-size: 0.85rem;
        }
        .presence-pseudo { font-weight: 700; }
        .presence-num { color: #64748b; font-size: 0.75rem; }

        /* === MAIN AREA === */
        #main {
            flex: 1; display: flex; flex-direction: column; padding: 30px;
            overflow-y: auto; align-items: center; justify-content: center;
        }

        /* Lobby */
        #main-lobby { text-align: center; display: flex; flex-direction: column; align-items: center; }
        #main-lobby h1 { font-size: 3rem; margin-bottom: 10px; }
        #main-lobby .code-giant {
            font-size: 5rem; font-weight: 900; color: #f59e0b;
            letter-spacing: 10px; margin: 20px 0;
        }
        .lobby-counter { font-size: 1.3rem; color: #94a3b8; margin-top: 10px; }

        /* Question display */
        #main-question { width: 100%; max-width: 900px; display: none; flex-direction: column; align-items: center; }
        .main-q-text {
            font-size: 1.8rem; font-weight: 800; text-align: center;
            background: #1e293b; padding: 30px 40px; border-radius: 20px;
            margin-bottom: 24px; width: 100%; line-height: 1.4;
        }
        .main-q-num { color: #64748b; font-size: 0.9rem; margin-bottom: 12px; }
        .main-choices {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            width: 100%; margin-bottom: 24px;
        }
        .main-choice {
            padding: 20px; border-radius: 16px; color: white;
            font-size: 1.2rem; font-weight: 700; text-align: center;
            position: relative; overflow: hidden;
        }
        .main-choice-a { background: #3b82f6; }
        .main-choice-b { background: #f59e0b; }
        .main-choice-c { background: #22c55e; }
        .main-choice-d { background: #ef4444; }
        .main-choice .bar-fill {
            position: absolute; bottom: 0; left: 0; height: 4px;
            background: rgba(255,255,255,0.5); transition: width 0.5s ease-out;
            width: 0;
        }
        .main-choice .pct { font-size: 2rem; font-weight: 900; display: none; }
        .main-choice.correct-answer { border: 4px solid #fff; box-shadow: 0 0 30px rgba(34,197,94,0.5); }
        .main-choice .correct-badge {
            display: none; position: absolute; top: 8px; right: 12px; font-size: 1.5rem;
        }
        .main-choice.correct-answer .correct-badge { display: block; }

        /* Mot type info */
        .main-mot-info {
            text-align: center; font-size: 1.3rem; color: #94a3b8; font-weight: 600;
            background: #1e293b; padding: 24px; border-radius: 16px; width: 100%;
            margin-bottom: 24px;
        }

        .response-counter {
            font-size: 1.5rem; color: #94a3b8; font-weight: 700;
            margin-bottom: 20px;
        }
        .main-timer {
            font-size: 4rem; font-weight: 900; color: #22c55e;
            margin-bottom: 16px;
        }
        .main-timer.warn { color: #f59e0b; }
        .main-timer.danger { color: #ef4444; animation: pulse 0.5s infinite; }

        /* Summary */
        #main-summary { display: none; text-align: center; }
        .summary-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 20px; }
        .summary-global { font-size: 1.5rem; color: #94a3b8; margin-bottom: 30px; }
        .summary-bars { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 600px; }
        .summary-bar-row { display: flex; align-items: center; gap: 12px; }
        .summary-bar-label { width: 30px; font-weight: 700; color: #64748b; text-align: center; }
        .summary-bar-track { flex: 1; height: 32px; background: #1e293b; border-radius: 8px; overflow: hidden; }
        .summary-bar-fill { height: 100%; border-radius: 8px; transition: width 1s ease-out; display: flex; align-items: center; padding-left: 12px; font-weight: 700; font-size: 0.9rem; }

        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes fadeIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

        /* Game mode toggle */
        .game-mode-toggle { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
        .game-mode-btn {
            flex: 1; min-width: 70px; padding: 6px 4px; border: 2px solid #475569; border-radius: 8px;
            background: transparent; color: #94a3b8; font-size: 0.7rem; font-weight: 700;
            cursor: pointer; text-align: center; transition: 0.2s;
        }
        .game-mode-btn.active { border-color: #f59e0b; color: #f59e0b; background: rgba(245,158,11,0.1); }
        .game-mode-btn:hover { border-color: #f59e0b; }

        /* Teams section */
        .team-card {
            background: #0f172a; border-radius: 8px; padding: 8px 10px; margin-bottom: 6px;
            border-left: 4px solid #475569;
        }
        .team-card-header { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-weight: 700; font-size: 0.85rem; }
        .team-card-members { display: flex; flex-wrap: wrap; gap: 4px; }
        .team-member-badge {
            font-size: 0.65rem; padding: 2px 6px; border-radius: 4px;
            background: rgba(255,255,255,0.1); color: #e2e8f0;
        }
        .team-chip {
            padding: 8px 12px; border-radius: 10px;
            border: 1px solid rgba(139,92,246,.4);
            background: rgba(139,92,246,.12);
            color: #e2e8f0; font-weight: 700; font-size: 0.82rem;
            cursor: pointer; transition: all .15s;
        }
        .team-chip:hover { background: rgba(139,92,246,.25); }
        .team-chip.active { background: #8b5cf6; color: white; border-color: #8b5cf6; }

        /* Team scores in main area */
        .team-score-strip { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 16px; }
        .team-score-pill {
            padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 1rem;
            display: flex; align-items: center; gap: 6px; color: white;
        }
        /* Battle tug of war */
        .tug-container { width: 80%; max-width: 600px; margin: 20px auto; }
        .tug-labels { display: flex; justify-content: space-between; margin-bottom: 6px; font-weight: 900; font-size: 1.2rem; }
        .tug-track { height: 40px; background: #1e293b; border-radius: 20px; overflow: hidden; position: relative; border: 2px solid rgba(255,255,255,0.15); }
        .tug-fill-a { position: absolute; top: 0; left: 0; height: 100%; background: #3b82f6; transition: width 0.8s ease-out; border-radius: 20px 0 0 20px; }
        .tug-fill-b { position: absolute; top: 0; right: 0; height: 100%; background: #ef4444; transition: width 0.8s ease-out; border-radius: 0 20px 20px 0; }
        .tug-score { text-align: center; margin-top: 8px; font-size: 1.5rem; font-weight: 900; }

        /* Team podium in summary */
        .team-podium { display: flex; gap: 12px; justify-content: center; margin-bottom: 24px; flex-wrap: wrap; }
        .podium-card {
            background: #1e293b; border-radius: 12px; padding: 16px 20px; text-align: center;
            min-width: 120px; border: 2px solid transparent;
        }
        .podium-card.gold { border-color: #f59e0b; background: rgba(245,158,11,0.1); }
        .podium-rank { font-size: 1.5rem; font-weight: 900; }
        .podium-name { font-size: 0.9rem; font-weight: 700; margin: 4px 0; }
        .podium-score { font-size: 1.1rem; color: #94a3b8; }

        /* === HAMBURGER MENU INFRASTRUCTURE === */
        .menu-overlay { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.55); backdrop-filter:blur(2px); z-index:999; }
        .menu-btn { display:none; border:none; background:#1e293b; color:#fff; width:44px; height:44px; border-radius:12px; font-size:20px; cursor:pointer; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
        body.menu-open #sidebar { transform:translateX(0); }
        body.menu-open .menu-overlay { display:block; }
        .close-sidebar-btn { display:none; }

        /* === MOBILE 768px === */
        @media (max-width:768px) {
            body { height:auto; overflow:auto; display:block; }
            #sidebar { position:fixed; top:0; left:0; bottom:0; height:100vh; width:min(86vw,360px); min-width:0; transform:translateX(-110%); transition:transform 0.25s ease; z-index:1000; overflow-y:auto; }
            #main { padding:16px; min-height:100vh; }
            .menu-btn { display:inline-flex; margin-bottom:12px; }
            .close-sidebar-btn { display:block; position:absolute; top:15px; right:15px; background:none; border:none; color:white; font-size:24px; cursor:pointer; z-index:1002; }
            .code-giant { font-size:2.5rem !important; }
            .summary-bars { gap:8px; }
        }

        /* === MEDIA QUESTION === */
        .q-media-container { width: 100%; max-width: 700px; margin: 0 auto 16px auto; text-align: center; }
        .q-media-container img { max-width: 100%; max-height: 260px; border-radius: 12px; object-fit: contain; }
        .q-media-container iframe { width: 100%; max-width: 560px; height: 315px; border: none; border-radius: 12px; }
        .q-media-container .media-texte { background: #1e293b; border-left: 4px solid #3b82f6; padding: 16px 20px; border-radius: 0 12px 12px 0; color: #e2e8f0; font-style: italic; line-height: 1.6; text-align: left; white-space: pre-wrap; font-size: 1rem; }

        /* === PHONE 480px === */
        @media (max-width:480px) {
            #main { padding:10px; }
            .code-giant { font-size:2rem !important; }
            .q-media-container iframe { height: 200px; }
        }
    </style>
</head>
<body>

<!-- Menu overlay -->
<div id="menuOverlay" class="menu-overlay" onclick="closeMenu()"></div>

<!-- SIDEBAR -->
<div id="sidebar">
    <button class="close-sidebar-btn" onclick="closeMenu()">‚úï</button>
    <div class="sidebar-header">
        <h2>üéØ Quiz Live ‚Äî Prof</h2>
    </div>

    <!-- Session -->
    <div class="sidebar-section">
        <div id="session-bar">
            <label style="font-size:0.7rem; color:#888; text-transform:uppercase; letter-spacing:1px;">Session</label>
            <div class="session-btns">
                <button onclick="newSession()" style="background:#2ecc71;">üÜï Nouvelle</button>
                <button onclick="resetSession()" style="background:#e74c3c;">üóëÔ∏è Reset</button>
            </div>
            <div id="session-code-display"></div>
            <div id="session-id-display"></div>
            <div id="qr-section">
                <img id="qr-code" src="" alt="QR">
                <div id="qr-label">üì± mapse.fr/eleve_quiz.html</div>
            </div>
        </div>
    </div>

    <!-- Ouvrir l'ecran -->
    <div class="sidebar-section" style="padding:10px 14px;">
        <button onclick="openWall()" class="ctrl-btn" style="background:#8b5cf6; color:white; margin-bottom:0;">üì∫ Ouvrir l'ecran (videoprojecteur)</button>
    </div>

    <!-- Quiz selector -->
    <div class="sidebar-section">
        <label>Quiz</label>
        <select class="quiz-select" id="quiz-select" onchange="onQuizSelect()">
            <option value="demo">üéÆ Questions demo (5 QCM)</option>
        </select>
        <div class="quiz-info" id="quiz-info"></div>
    </div>

    <!-- Mode de jeu -->
    <div class="sidebar-section">
        <label>Mode de jeu</label>
        <div class="game-mode-toggle">
            <button class="game-mode-btn active" id="gm-solo" onclick="setGameMode('solo')">üë§ Solo</button>
            <button class="game-mode-btn" id="gm-equipe" onclick="setGameMode('equipe')">üë• Equipe</button>
            <button class="game-mode-btn" id="gm-battle" onclick="setGameMode('battle')">‚öîÔ∏è Battle</button>
            <button class="game-mode-btn" id="gm-duo" onclick="setGameMode('duo')">ü§ù Duo</button>
        </div>
        <!-- Team formation (hidden by default) -->
        <div id="team-section" style="display:none;">
            <div id="team-player-count" style="font-size:0.8rem;color:#94a3b8;margin-bottom:6px;">
                <span id="team-count-num" style="font-weight:700;color:#a78bfa;">0</span> eleve(s) connecte(s)
            </div>
            <div id="team-options" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;"></div>
            <div id="team-fixed-info" style="display:none;margin-bottom:8px;font-size:0.85rem;color:#e2e8f0;font-weight:700;"></div>
            <button class="ctrl-btn" id="btn-form-teams" style="background:#8b5cf6; color:white;" onclick="formTeams()">üé≤ Former les equipes</button>
            <button class="ctrl-btn" id="btn-reshuffle" style="display:none;background:#6366f1;color:white;margin-top:4px;" onclick="formTeams()">üîÑ Remelanger</button>
            <div id="teams-display" style="margin-top:8px;"></div>
        </div>
    </div>

    <!-- Controles -->
    <div class="sidebar-section" id="controls-section">
        <label>Mode</label>
        <div class="mode-toggle">
            <button id="mode-auto" onclick="setMode('auto')" class="mode-btn active">‚è±Ô∏è Auto</button>
            <button id="mode-manual" onclick="setMode('manual')" class="mode-btn inactive">‚úã Manuel</button>
        </div>
        <div id="timer-row" style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <span style="font-size:0.85rem; color:#94a3b8;">‚è±Ô∏è Question</span>
            <input type="number" id="timer-input" value="15" min="5" max="120" step="5" style="width:60px; padding:8px; background:#0f172a; color:white; border:1px solid #475569; border-radius:6px; font-size:0.95rem; font-weight:700; text-align:center;">
            <span style="font-size:0.85rem; color:#94a3b8;">sec</span>
        </div>
        <div id="results-timer-row" style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
            <span style="font-size:0.85rem; color:#94a3b8;">‚úÖ Resultats</span>
            <input type="number" id="results-timer-input" value="6" min="2" max="30" step="1" style="width:60px; padding:8px; background:#0f172a; color:white; border:1px solid #475569; border-radius:6px; font-size:0.95rem; font-weight:700; text-align:center;">
            <span style="font-size:0.85rem; color:#94a3b8;">sec</span>
        </div>
        <div id="shuffle-row" style="display:flex; align-items:center; gap:8px; margin-bottom:10px; padding:8px 10px; background:#0f172a; border-radius:8px; cursor:pointer;" onclick="toggleShuffle()">
            <div id="shuffle-toggle" style="width:40px; height:22px; border-radius:11px; background:#475569; position:relative; transition:0.3s; flex-shrink:0;">
                <div id="shuffle-dot" style="width:18px; height:18px; border-radius:50%; background:white; position:absolute; top:2px; left:2px; transition:0.3s;"></div>
            </div>
            <span style="font-size:0.8rem; color:#94a3b8;" id="shuffle-label">üîÄ Melanger les reponses (anti-triche)</span>
        </div>
        <label style="margin-top:4px;">Actions</label>
        <button class="ctrl-btn ctrl-launch" id="btn-launch" onclick="launchQuestion()">‚ñ∂Ô∏è Lancer le quiz</button>
        <button class="ctrl-btn" id="btn-pause" onclick="togglePause()" disabled style="background:#f59e0b; color:white; display:none;">‚è∏Ô∏è Pause</button>
        <div style="display:flex; gap:6px;">
            <button class="ctrl-btn" id="btn-prev" onclick="prevQuestion()" disabled style="flex:1; background:#6366f1; color:white;">‚óÄÔ∏è Prec.</button>
            <button class="ctrl-btn ctrl-next" id="btn-next" onclick="nextQuestion()" disabled style="flex:1;">‚è≠Ô∏è Suivante</button>
        </div>
        <button class="ctrl-btn" id="btn-results" onclick="showResultsManual()" disabled style="background:#8b5cf6; color:white;">üìä Voir resultats</button>
        <button class="ctrl-btn" id="btn-restart" onclick="restartQuiz()" disabled style="background:#64748b; color:white;">üîÑ Recommencer</button>
        <button class="ctrl-btn ctrl-end" id="btn-end" onclick="endQuiz()" disabled>üèÅ Terminer</button>
    </div>

    <!-- Question en cours -->
    <div class="sidebar-section">
        <label>Question en cours</label>
        <div id="sidebar-q-info" style="color:#94a3b8; font-size:0.85rem;">Aucune ‚Äî Lance le quiz</div>
    </div>

    <!-- Presence -->
    <div class="sidebar-section">
        <label>Eleves connectes (<span id="presence-count">0</span>)</label>
        <div class="presence-list" id="presence-list"></div>
    </div>
</div>

<!-- MAIN -->
<div id="main">
    <button id="menuBtn" class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <!-- Lobby -->
    <div id="main-lobby">
        <h1>üéØ Quiz Live</h1>
        <p style="color:#64748b; margin-bottom:20px;">Cree une session pour commencer</p>
        <div class="code-giant" id="main-code" style="display:none;"></div>
        <div class="lobby-counter" id="main-counter"></div>
    </div>

    <!-- Question -->
    <div id="main-question">
        <div class="main-q-num" id="main-q-num"></div>
        <div class="main-timer" id="main-timer"></div>
        <div class="q-media-container" id="main-q-media"></div>
        <div class="main-q-text" id="main-q-text"></div>
        <div class="response-counter" id="main-resp-counter"></div>
        <div class="main-choices" id="main-choices"></div>
        <div class="main-mot-info" id="main-mot-info" style="display:none;"></div>
    </div>

    <!-- Summary -->
    <div id="main-summary">
        <div class="summary-title">üèÅ Quiz termine !</div>
        <div class="summary-global" id="summary-global"></div>
        <div class="summary-bars" id="summary-bars"></div>
    </div>
</div>

<script>
function toggleMenu(){ document.body.classList.toggle('menu-open'); }
function closeMenu(){ document.body.classList.remove('menu-open'); }
</script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDocs, writeBatch, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.firebasestorage.app",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // === CODES SESSION LISIBLES ===
    const SESSION_CODES = [
        "LION","TIGRE","PANDA","AIGLE","LOUP","REQUIN","PHENIX","DRAGON",
        "FLASH","TORNADE","VOLCAN","NINJA","ROBOT","GALAXY","FUSEE","SOLEIL",
        "COMETE","ECLAIR","ETOILE","PIRATE","ATLAS","COSMOS","TURBO","OXYGEN",
        "PRISME","VORTEX","PLASMA","QUASAR","NEBULA","ZENITH"
    ];

    // === QUESTIONS DE DEMO ===
    const DEFAULT_DEMO = [
        {
            type: "qcm",
            question: "Que signifie PSE ?",
            choices: ["Prevention Sante Environnement", "Protection Sociale Europeenne", "Programme Scolaire Educatif", "Projet Sante Etudiant"],
            correct: 0
        },
        {
            type: "qcm",
            question: "Quel numero appeler pour le SAMU ?",
            choices: ["17", "15", "18", "112"],
            correct: 1
        },
        {
            type: "qcm",
            question: "Le bruit au travail est un risque de type :",
            choices: ["Mecanique", "Chimique", "Physique", "Biologique"],
            correct: 2
        },
        {
            type: "qcm",
            question: "SST signifie :",
            choices: ["Service de Sante au Travail", "Sauveteur Secouriste du Travail", "Systeme de Securite Totale", "Securite et Sante des Travailleurs"],
            correct: 1
        },
        {
            type: "qcm",
            question: "Quel organisme gere les risques professionnels ?",
            choices: ["INRS", "INSEE", "INSERM", "INRA"],
            correct: 0
        }
    ];

    // === STATE ===
    let ACTIVE_QUESTIONS = [...DEFAULT_DEMO]; // mutable copy
    let currentSessionId = null;
    let currentSessionCode = null;
    let currentQuestionIndex = -1;
    let timerInterval = null;
    let unsubPresence = null;
    let unsubReponses = null;
    let playerCount = 0;
    let responsesData = [];
    let currentMode = 'auto';
    let isPaused = false;
    let pausedTimeRemaining = 0;
    let presenceSnapshotData = [];
    let currentPhase = 'lobby';
    let shuffleEnabled = false;
    let autoAdvanceTimer = null; // timer for auto-advance after results

    // === GAME MODE (Solo / Equipe / Battle / Duo) ===
    let gameMode = 'solo';
    let teams = [];

    const TEAM_IDENTITIES = [
        { name: "Requins", emoji: "ü¶à", color: "#3b82f6" },
        { name: "Phoenix", emoji: "üî•", color: "#ef4444" },
        { name: "Pandas", emoji: "üêº", color: "#22c55e" },
        { name: "Dragons", emoji: "üêâ", color: "#f59e0b" },
        { name: "Loups", emoji: "üê∫", color: "#8b5cf6" },
        { name: "Aigles", emoji: "ü¶Ö", color: "#06b6d4" },
        { name: "Tigres", emoji: "üêØ", color: "#f97316" },
        { name: "Lions", emoji: "ü¶Å", color: "#eab308" }
    ];

    var selectedNumTeams = null;

    function getTeamOptions(n) {
        var options = [];
        for (var numTeams = 2; numTeams <= Math.floor(n / 2); numTeams++) {
            var baseSize = Math.floor(n / numTeams);
            var remainder = n % numTeams;
            if (baseSize < 2) break;
            var label = remainder === 0
                ? numTeams + ' \u00d7 ' + baseSize
                : numTeams + ' \u00d7 ' + baseSize + '-' + (baseSize + 1);
            options.push({ numTeams: numTeams, baseSize: baseSize, remainder: remainder, label: label });
        }
        return options;
    }

    function updateTeamOptions() {
        var n = presenceSnapshotData.length;
        var countEl = document.getElementById('team-count-num');
        if (countEl) countEl.textContent = n;

        var optionsContainer = document.getElementById('team-options');
        var fixedInfo = document.getElementById('team-fixed-info');
        var btnForm = document.getElementById('btn-form-teams');
        var btnReshuffle = document.getElementById('btn-reshuffle');
        if (!optionsContainer) return;

        if (gameMode === 'battle') {
            optionsContainer.style.display = 'none';
            fixedInfo.style.display = 'block';
            fixedInfo.innerHTML = '\u2694\ufe0f 2 equipes de ' + Math.ceil(n / 2);
            selectedNumTeams = 2;
            btnForm.style.display = n >= 2 ? 'block' : 'none';
        } else if (gameMode === 'duo') {
            optionsContainer.style.display = 'none';
            fixedInfo.style.display = 'block';
            fixedInfo.innerHTML = '\ud83e\udd1d ' + Math.ceil(n / 2) + ' duos';
            selectedNumTeams = Math.ceil(n / 2);
            btnForm.style.display = n >= 2 ? 'block' : 'none';
        } else if (gameMode === 'equipe') {
            fixedInfo.style.display = 'none';
            optionsContainer.style.display = 'flex';
            optionsContainer.innerHTML = '';
            if (n < 2) {
                optionsContainer.innerHTML = '<span style="color:#94a3b8;font-size:0.8rem;">En attente d\'eleves...</span>';
                btnForm.style.display = 'none';
                return;
            }
            var opts = getTeamOptions(n);
            opts.forEach(function(opt) {
                var chip = document.createElement('button');
                chip.className = 'team-chip' + (selectedNumTeams === opt.numTeams ? ' active' : '');
                chip.textContent = opt.label;
                chip.onclick = function() {
                    selectedNumTeams = opt.numTeams;
                    optionsContainer.querySelectorAll('.team-chip').forEach(function(c) { c.classList.remove('active'); });
                    chip.classList.add('active');
                    formTeams();
                };
                optionsContainer.appendChild(chip);
            });
            // Hide main button for equipe ‚Äî chips trigger directly
            btnForm.style.display = 'none';
        }
    }

    window.setGameMode = function(mode) {
        gameMode = mode;
        teams = [];
        selectedNumTeams = null;
        ['solo','equipe','battle','duo'].forEach(function(m) {
            document.getElementById('gm-' + m).className = 'game-mode-btn' + (m === mode ? ' active' : '');
        });
        var teamSection = document.getElementById('team-section');
        if (mode !== 'solo') {
            teamSection.style.display = 'block';
            updateTeamOptions();
        } else {
            teamSection.style.display = 'none';
        }
        document.getElementById('teams-display').innerHTML = '';
        document.getElementById('btn-reshuffle').style.display = 'none';
    };

    window.formTeams = function() {
        if (presenceSnapshotData.length < 2) {
            alert("Il faut au moins 2 eleves connectes !");
            return;
        }
        const shuffled = [...presenceSnapshotData].sort(() => Math.random() - 0.5);
        teams = [];

        let numTeams, teamSize;
        if (gameMode === 'battle') {
            numTeams = 2;
            teamSize = Math.ceil(shuffled.length / 2);
        } else if (gameMode === 'duo') {
            numTeams = Math.ceil(shuffled.length / 2);
            teamSize = 2;
        } else {
            // Mode equipe : utiliser selectedNumTeams (chips) ou fallback
            if (selectedNumTeams) {
                numTeams = selectedNumTeams;
            } else {
                numTeams = Math.min(4, Math.floor(shuffled.length / 2));
            }
            teamSize = Math.ceil(shuffled.length / numTeams);
        }

        for (let i = 0; i < numTeams; i++) {
            const identity = TEAM_IDENTITIES[i % TEAM_IDENTITIES.length];
            teams.push({
                teamId: 'team_' + i,
                teamName: gameMode === 'duo' ? 'Duo ' + (i + 1) : (gameMode === 'battle' ? (i === 0 ? 'Equipe Bleue' : 'Equipe Rouge') : identity.name),
                teamEmoji: gameMode === 'battle' ? (i === 0 ? 'üîµ' : 'üî¥') : identity.emoji,
                teamColor: gameMode === 'battle' ? (i === 0 ? '#3b82f6' : '#ef4444') : identity.color,
                members: []
            });
        }

        // Distribute students round-robin
        shuffled.forEach((student, idx) => {
            const teamIdx = idx % numTeams;
            teams[teamIdx].members.push({
                visitorId: student.visitorId,
                pseudo: student.pseudo
            });
        });

        // For duo mode, name duos with member pseudos
        if (gameMode === 'duo') {
            teams.forEach((t, i) => {
                const names = t.members.map(m => m.pseudo.split(' ')[0]).join(' + ');
                t.teamName = names;
                t.teamEmoji = t.members.length === 2 ? 'ü§ù' : 'üë•';
                t.teamColor = TEAM_IDENTITIES[i % TEAM_IDENTITIES.length].color;
            });
        }

        renderTeamsInSidebar();
        // Show reshuffle, hide form button
        document.getElementById('btn-reshuffle').style.display = 'block';
        document.getElementById('btn-form-teams').style.display = 'none';
        // Write teams to config so students and wall can read them
        if (currentSessionId) {
            setDoc(doc(db, "quiz_live_config", "global"), { teams: teams, gameMode: gameMode }, { merge: true });
        }
    };

    function renderTeamsInSidebar() {
        const container = document.getElementById('teams-display');
        container.innerHTML = '';
        teams.forEach(t => {
            const card = document.createElement('div');
            card.className = 'team-card';
            card.style.borderLeftColor = t.teamColor;
            const membersHtml = t.members.map(m => '<span class="team-member-badge">' + m.pseudo + '</span>').join('');
            card.innerHTML = '<div class="team-card-header" style="color:' + t.teamColor + ';">' + t.teamEmoji + ' ' + t.teamName + ' <span style="font-size:0.65rem;color:#64748b;">(' + t.members.length + ')</span></div>' +
                '<div class="team-card-members">' + membersHtml + '</div>';
            container.appendChild(card);
        });
    }

    function getTeamForVisitor(visitorId) {
        return teams.find(t => t.members.some(m => m.visitorId === visitorId)) || null;
    }

    function computeTeamScores(questionIndex) {
        if (!teams.length) return [];
        const qResponses = questionIndex >= 0
            ? responsesData.filter(r => r.questionIndex === questionIndex)
            : responsesData; // all responses for summary

        return teams.map(t => {
            const memberIds = t.members.map(m => m.visitorId);
            const teamResp = qResponses.filter(r => memberIds.includes(r.visitorId));
            const correct = teamResp.filter(r => r.correct).length;
            const total = t.members.length;
            const pct = total > 0 ? Math.round((correct / total) * 100) : 0;
            return { ...t, correct, total, pct, answered: teamResp.length };
        });
    }

    function computeTeamCumulativeScores() {
        if (!teams.length) return [];
        const maxQ = Math.min(currentQuestionIndex + 1, ACTIVE_QUESTIONS.length);
        return teams.map(t => {
            const memberIds = t.members.map(m => m.visitorId);
            let totalCorrect = 0, totalPossible = 0;
            for (let i = 0; i < maxQ; i++) {
                const qResp = responsesData.filter(r => r.questionIndex === i && memberIds.includes(r.visitorId));
                totalCorrect += qResp.filter(r => r.correct).length;
                totalPossible += t.members.length;
            }
            const pct = totalPossible > 0 ? Math.round((totalCorrect / totalPossible) * 100) : 0;
            return { ...t, totalCorrect, totalPossible, pct };
        }).sort((a, b) => b.pct - a.pct);
    }

    // === TOGGLE SHUFFLE ===
    window.toggleShuffle = function() {
        shuffleEnabled = !shuffleEnabled;
        const toggle = document.getElementById('shuffle-toggle');
        const dot = document.getElementById('shuffle-dot');
        const label = document.getElementById('shuffle-label');
        if (shuffleEnabled) {
            toggle.style.background = '#22c55e';
            dot.style.left = '20px';
            label.style.color = '#22c55e';
        } else {
            toggle.style.background = '#475569';
            dot.style.left = '2px';
            label.style.color = '#94a3b8';
        }
    };

    // === NORMALIZE QUESTIONS FOR LIVE ===
    // V/F -> QCM with 2 choices, "mot" stays as-is with type marker
    function normalizeQuestionsForLive(questions) {
        return questions.map(q => {
            const type = q.type || 'qcm';
            const media = q.media || null;
            if (type === 'vf') {
                // Convert to QCM with 2 choices
                const out = {
                    type: 'qcm',
                    originalType: 'vf',
                    question: q.question,
                    choices: ['Vrai', 'Faux'],
                    correct: q.correct === true ? 0 : 1
                };
                if (media) out.media = media;
                return out;
            } else if (type === 'mot') {
                const out = {
                    type: 'mot',
                    question: q.question,
                    reponse: q.reponse
                };
                if (media) out.media = media;
                return out;
            } else {
                // QCM ‚Äî ensure type is set
                return { ...q, type: 'qcm' };
            }
        });
    }

    // === RENDER MEDIA HTML ===
    function renderMediaHtml(media) {
        if (!media || !media.type || !media.content) return '';
        if (media.type === 'image') {
            return '<img src="' + media.content + '" alt="Media" onerror="this.style.display=\'none\'">';
        } else if (media.type === 'video') {
            const vid = extractYouTubeId(media.content);
            if (!vid) return '';
            return '<iframe src="https://www.youtube-nocookie.com/embed/' + vid + '" allowfullscreen></iframe>';
        } else if (media.type === 'texte') {
            return '<div class="media-texte">' + media.content.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
        }
        return '';
    }

    function extractYouTubeId(url) {
        if (!url) return null;
        const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|shorts\/))([a-zA-Z0-9_-]{11})/);
        return m ? m[1] : null;
    }

    // === QUIZ SELECTOR ===
    // Load quizzes from Firebase
    const qBanque = query(collection(db, "quiz_banque"), orderBy("updatedAt", "desc"));
    onSnapshot(qBanque, (snap) => {
        const sel = document.getElementById('quiz-select');
        // Keep demo option
        sel.innerHTML = '<option value="demo">üéÆ Questions demo (5 QCM)</option>';
        snap.forEach(d => {
            const data = d.data();
            const opt = document.createElement('option');
            opt.value = d.id;
            const qCount = data.questions ? data.questions.length : 0;
            let typeTag = '[Form]';
            if (data.type === 'diagnostique') typeTag = '[Diag]';
            else if (data.type === 'sommatif') typeTag = '[Somm]';
            else if (data.type && data.type.startsWith('autre:')) typeTag = '[' + data.type.substring(6) + ']';
            else if (data.type === 'autre') typeTag = '[Autre]';
            opt.textContent = typeTag + ' ' + (data.titre || 'Sans titre') + ' (' + qCount + ' Q)';
            opt.dataset.quizData = JSON.stringify(data);
            sel.appendChild(opt);
        });
    });

    window.onQuizSelect = function() {
        const sel = document.getElementById('quiz-select');
        const val = sel.value;
        const info = document.getElementById('quiz-info');

        if (val === 'demo') {
            ACTIVE_QUESTIONS = [...DEFAULT_DEMO];
            info.textContent = '5 questions QCM de demonstration';
        } else {
            const opt = sel.selectedOptions[0];
            try {
                const data = JSON.parse(opt.dataset.quizData);
                ACTIVE_QUESTIONS = normalizeQuestionsForLive(data.questions || []);
                const types = {};
                ACTIVE_QUESTIONS.forEach(q => { types[q.type || 'qcm'] = (types[q.type || 'qcm'] || 0) + 1; });
                const parts = [];
                if (types.qcm) parts.push(types.qcm + ' QCM');
                if (types.mot) parts.push(types.mot + ' Reponse courte');
                info.textContent = ACTIVE_QUESTIONS.length + ' questions : ' + parts.join(', ');
            } catch(e) {
                info.textContent = 'Erreur chargement';
                ACTIVE_QUESTIONS = [...DEFAULT_DEMO];
            }
        }

        // If quiz already started, warn
        if (currentQuestionIndex >= 0) {
            info.textContent += ' (redemarrez le quiz pour appliquer)';
        }
    };

    // === MODE TOGGLE ===
    window.setMode = function(mode) {
        currentMode = mode;
        document.getElementById('mode-auto').className = 'mode-btn ' + (mode === 'auto' ? 'active' : 'inactive');
        document.getElementById('mode-manual').className = 'mode-btn ' + (mode === 'manual' ? 'active' : 'inactive');
        document.getElementById('timer-row').style.display = mode === 'auto' ? 'flex' : 'none';
        document.getElementById('results-timer-row').style.display = mode === 'auto' ? 'flex' : 'none';
        updateButtons();
    };

    // === BUTTON STATE MANAGEMENT ===
    function updateButtons() {
        const hasSession = !!currentSessionId;
        const inLobby = currentPhase === 'lobby';
        const inQuestion = currentPhase === 'question';
        const inResults = currentPhase === 'results';
        const inSummary = currentPhase === 'summary';
        const isManual = currentMode === 'manual';
        const hasMoreQ = currentQuestionIndex < ACTIVE_QUESTIONS.length - 1;
        const quizStarted = currentQuestionIndex >= 0;

        // LANCER : accessible en lobby, ou en r√©sultats pour passer √† la suite
        const canLaunch = hasSession && (inLobby || inResults);
        document.getElementById('btn-launch').disabled = !canLaunch;
        if (inLobby) {
            document.getElementById('btn-launch').textContent = '‚ñ∂Ô∏è Lancer le quiz';
        } else if (inResults && hasMoreQ) {
            document.getElementById('btn-launch').textContent = '‚ñ∂Ô∏è Question suivante';
        } else if (inResults) {
            document.getElementById('btn-launch').textContent = 'üèÅ Voir le bilan';
        } else {
            document.getElementById('btn-launch').textContent = '‚ñ∂Ô∏è Lancer le quiz';
        }

        // PAUSE : seulement en mode Auto pendant une question
        document.getElementById('btn-pause').style.display = (!isManual && (inQuestion || isPaused)) ? 'block' : 'none';
        document.getElementById('btn-pause').disabled = !inQuestion && !isPaused;
        document.getElementById('btn-pause').textContent = isPaused ? '‚ñ∂Ô∏è Reprendre' : '‚è∏Ô∏è Pause';

        // PRECEDENT : accessible d√®s qu'on est sur une question ou r√©sultats, et qu'il y a une question avant
        if (isManual) {
            document.getElementById('btn-prev').disabled = !(hasSession && currentQuestionIndex > 0 && (inQuestion || inResults));
        } else {
            document.getElementById('btn-prev').disabled = !(hasSession && currentQuestionIndex > 0 && inResults);
        }

        // SUIVANT : en mode Manuel, accessible d√®s qu'on est sur une question ou r√©sultats et qu'il y a une suite
        if (isManual) {
            document.getElementById('btn-next').disabled = !(hasSession && (inQuestion || inResults) && hasMoreQ);
        } else {
            document.getElementById('btn-next').disabled = !(hasSession && inResults && hasMoreQ);
        }

        // VOIR RESULTATS : seulement en mode Manuel, pendant une question
        document.getElementById('btn-results').style.display = isManual ? 'block' : 'none';
        document.getElementById('btn-results').disabled = !(inQuestion && !isPaused);

        document.getElementById('btn-restart').disabled = !(hasSession && quizStarted);
        document.getElementById('btn-end').disabled = !(hasSession && quizStarted && !inSummary);
    }

    // === OUVRIR L'ECRAN ===
    window.openWall = function() {
        const code = currentSessionCode || '';
        const url = 'wall_quiz.html' + (code ? '?code=' + code : '');
        window.open(url, 'quiz_wall', 'width=1280,height=720');
    };

    // === SHUFFLE MAP (anti-triche) ===
    function generateShuffleMap(q) {
        const map = {};
        // For "mot" type, no shuffle needed
        if (q && q.type === 'mot') return null;
        const numChoices = (q && q.choices) ? q.choices.length : 4;
        presenceSnapshotData.forEach(p => {
            const arr = [];
            for (let i = 0; i < numChoices; i++) arr.push(i);
            // Fisher-Yates
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            map[p.visitorId] = arr;
        });
        return map;
    }

    // === HELPER: build config object ===
    function buildConfig(overrides) {
        return {
            sessionId: currentSessionId,
            sessionCode: currentSessionCode,
            questions: ACTIVE_QUESTIONS,
            timer: currentMode === 'manual' ? 0 : parseInt(document.getElementById('timer-input').value) || 15,
            mode: currentMode,
            gameMode: gameMode,
            teams: teams,
            ...overrides
        };
    }

    // === SESSION ===
    function generateSessionId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 4);
    }

    window.newSession = async function() {
        currentSessionId = generateSessionId();
        currentSessionCode = SESSION_CODES[Math.floor(Math.random() * SESSION_CODES.length)];
        currentQuestionIndex = -1;
        responsesData = [];
        currentPhase = 'lobby';
        isPaused = false;

        localStorage.setItem('quiz_live_sessionId', currentSessionId);

        await setDoc(doc(db, "quiz_live_config", "global"), buildConfig({
            phase: 'lobby',
            currentQuestionIndex: -1,
            isOpen: false,
            showResults: false,
            paused: false,
            shuffleMap: null
        }));

        document.getElementById('session-code-display').textContent = currentSessionCode;
        document.getElementById('session-code-display').style.display = 'block';
        document.getElementById('session-id-display').textContent = 'üîë ' + currentSessionId;

        const url = 'https://mapse.fr/eleve_quiz.html';
        document.getElementById('qr-code').src = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=0&color=0f172a&bgcolor=ffffff&data=' + encodeURIComponent(url);
        document.getElementById('qr-section').style.display = 'block';

        document.getElementById('main-code').textContent = currentSessionCode;
        document.getElementById('main-code').style.display = 'block';
        document.getElementById('main-lobby').querySelector('p').textContent = 'Les eleves rejoignent avec le code :';

        showMainScreen('lobby');
        updateButtons();
        setupListeners();
    };

    window.resetSession = async function() {
        if (!currentSessionId) return;
        if (!confirm("Effacer toutes les donnees de cette session ?")) return;

        if (timerInterval) clearInterval(timerInterval);
        if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; }

        const batch = writeBatch(db);
        for (const col of ['quiz_live_reponses', 'quiz_live_presence']) {
            const q = query(collection(db, col), where("sessionId", "==", currentSessionId));
            const snap = await getDocs(q);
            snap.forEach(d => batch.delete(d.ref));
        }
        await batch.commit();

        currentQuestionIndex = -1;
        responsesData = [];
        currentPhase = 'lobby';
        isPaused = false;

        await setDoc(doc(db, "quiz_live_config", "global"), buildConfig({
            phase: 'lobby',
            currentQuestionIndex: -1,
            isOpen: false,
            showResults: false,
            paused: false,
            shuffleMap: null
        }));

        showMainScreen('lobby');
        document.getElementById('sidebar-q-info').textContent = 'Aucune ‚Äî Lance le quiz';
        updateButtons();
    };

    // === LISTENERS ===
    function setupListeners() {
        if (!currentSessionId) return;
        if (unsubPresence) unsubPresence();
        if (unsubReponses) unsubReponses();

        const qPres = query(collection(db, "quiz_live_presence"), where("sessionId", "==", currentSessionId));
        unsubPresence = onSnapshot(qPres, (snap) => {
            playerCount = snap.size;
            document.getElementById('presence-count').textContent = playerCount;
            document.getElementById('main-counter').textContent = playerCount + ' eleve(s) connecte(s)';

            presenceSnapshotData = [];
            const list = document.getElementById('presence-list');
            list.innerHTML = '';
            snap.forEach(d => {
                const data = d.data();
                presenceSnapshotData.push(data);
                const item = document.createElement('div');
                item.className = 'presence-item';
                const switches = data.tabSwitches || 0;
                const alertBadge = switches > 0 ? ' <span style="color:#ef4444;font-size:0.7rem;" title="' + switches + ' sortie(s) de page">‚ö†Ô∏è' + switches + '</span>' : '';
                const team = getTeamForVisitor(data.visitorId);
                const teamBadge = team ? '<span style="font-size:0.6rem;padding:1px 4px;border-radius:3px;background:' + team.teamColor + ';color:white;margin-left:4px;">' + team.teamEmoji + '</span>' : '';
                item.innerHTML = '<span class="presence-pseudo">' + data.pseudo + teamBadge + alertBadge + '</span><span class="presence-num">n¬∞' + data.numero + '</span>';
                list.appendChild(item);
            });
            // Update team options chips when students connect/disconnect
            if (gameMode !== 'solo') { updateTeamOptions(); }
        });

        const qResp = query(collection(db, "quiz_live_reponses"), where("sessionId", "==", currentSessionId));
        unsubReponses = onSnapshot(qResp, (snap) => {
            responsesData = [];
            snap.forEach(d => responsesData.push(d.data()));
            updateResponseDisplay();
        });
    }

    function updateResponseDisplay() {
        if (currentQuestionIndex < 0) return;
        const currentResponses = responsesData.filter(r => r.questionIndex === currentQuestionIndex);
        document.getElementById('main-resp-counter').textContent = currentResponses.length + ' / ' + playerCount + ' ont repondu';
    }

    // === LANCER QUESTION ===
    window.launchQuestion = async function() {
        if (!currentSessionId) { alert("Cree d'abord une session !"); return; }

        // Cancel any pending auto-advance
        if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; }

        currentQuestionIndex++;
        if (currentQuestionIndex >= ACTIVE_QUESTIONS.length) {
            endQuiz();
            return;
        }

        isPaused = false;
        currentPhase = 'question';

        const q = ACTIVE_QUESTIONS[currentQuestionIndex];
        const timer = currentMode === 'manual' ? 0 : parseInt(document.getElementById('timer-input').value) || 15;
        const shuffleMap = shuffleEnabled ? generateShuffleMap(q) : null;

        await setDoc(doc(db, "quiz_live_config", "global"), buildConfig({
            phase: 'question',
            currentQuestionIndex: currentQuestionIndex,
            isOpen: true,
            showResults: false,
            paused: false,
            shuffleMap: shuffleMap
        }));

        // Clean up previous team display
        const oldTeamStrip = document.getElementById('team-results-strip');
        if (oldTeamStrip) oldTeamStrip.remove();

        showMainScreen('question');
        displayQuestion(currentQuestionIndex, timer);
        updateButtons();

        document.getElementById('sidebar-q-info').textContent = 'Q' + (currentQuestionIndex + 1) + '/' + ACTIVE_QUESTIONS.length + ' ‚Äî En cours...';

        if (currentMode === 'auto') {
            startProfTimer(timer);
        } else {
            document.getElementById('main-timer').textContent = '‚úã';
            document.getElementById('main-timer').className = 'main-timer';
        }
    };

    function displayQuestion(index, timer) {
        const q = ACTIVE_QUESTIONS[index];
        const qType = q.type || 'qcm';

        document.getElementById('main-q-num').textContent = 'Question ' + (index + 1) + ' / ' + ACTIVE_QUESTIONS.length;
        // Media
        const mediaEl = document.getElementById('main-q-media');
        mediaEl.innerHTML = q.media ? renderMediaHtml(q.media) : '';
        mediaEl.style.display = q.media ? 'block' : 'none';
        document.getElementById('main-q-text').textContent = q.question;
        if (currentMode === 'auto') {
            document.getElementById('main-timer').textContent = timer + 's';
            document.getElementById('main-timer').className = 'main-timer';
        }
        document.getElementById('main-resp-counter').textContent = '0 / ' + playerCount + ' ont repondu';

        const grid = document.getElementById('main-choices');
        const motInfo = document.getElementById('main-mot-info');
        grid.innerHTML = '';

        if (qType === 'mot') {
            // Short answer: show info to prof
            grid.style.display = 'none';
            motInfo.style.display = 'block';
            motInfo.innerHTML = '‚úèÔ∏è Les eleves tapent leur reponse...<br><span style="font-size:0.85rem; color:#64748b;">Reponse attendue : <strong style="color:#22c55e;">' + q.reponse + '</strong></span>';
        } else {
            // QCM (including converted V/F)
            grid.style.display = 'grid';
            motInfo.style.display = 'none';

            const letters = ['A', 'B', 'C', 'D'];
            const colors = ['main-choice-a', 'main-choice-b', 'main-choice-c', 'main-choice-d'];
            const numChoices = q.choices.length;

            // Adjust grid for 2 choices (V/F)
            grid.style.gridTemplateColumns = numChoices <= 2 ? '1fr 1fr' : '1fr 1fr';

            for (let i = 0; i < numChoices; i++) {
                const div = document.createElement('div');
                div.className = 'main-choice ' + colors[i];
                div.id = 'main-choice-' + i;
                div.innerHTML = '<span style="font-size:1.5rem;font-weight:900;margin-right:10px;">' + letters[i] + '</span> ' + q.choices[i] +
                    '<div class="bar-fill" id="bar-' + i + '"></div>' +
                    '<div class="pct" id="pct-' + i + '"></div>' +
                    '<div class="correct-badge">‚úÖ</div>';
                grid.appendChild(div);
            }
        }
    }

    function startProfTimer(seconds) {
        if (timerInterval) clearInterval(timerInterval);
        let remaining = seconds;
        pausedTimeRemaining = seconds;
        const el = document.getElementById('main-timer');

        timerInterval = setInterval(async () => {
            remaining--;
            pausedTimeRemaining = remaining;
            if (remaining <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                el.textContent = '0s';
                await showResults();
                return;
            }
            el.textContent = remaining + 's';
            if (remaining <= 3) el.className = 'main-timer danger';
            else if (remaining <= Math.floor(seconds * 0.3)) el.className = 'main-timer warn';
        }, 1000);
    }

    // === PAUSE ===
    window.togglePause = async function() {
        // Cancel any pending auto-advance
        if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; }

        if (isPaused) {
            isPaused = false;
            await setDoc(doc(db, "quiz_live_config", "global"), buildConfig({
                phase: 'question',
                currentQuestionIndex: currentQuestionIndex,
                isOpen: true,
                showResults: false,
                paused: false,
                shuffleMap: null
            }));

            if (currentMode === 'auto' && pausedTimeRemaining > 0) {
                startProfTimer(pausedTimeRemaining);
            }

            currentPhase = 'question';
            updateButtons();
            document.getElementById('sidebar-q-info').textContent = 'Q' + (currentQuestionIndex + 1) + '/' + ACTIVE_QUESTIONS.length + ' ‚Äî En cours...';
        } else {
            isPaused = true;
            if (currentMode === 'auto' && timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            await setDoc(doc(db, "quiz_live_config", "global"), buildConfig({
                phase: 'question',
                currentQuestionIndex: currentQuestionIndex,
                isOpen: true,
                showResults: false,
                paused: true,
                shuffleMap: null
            }));

            document.getElementById('main-timer').textContent = '‚è∏Ô∏è';
            document.getElementById('main-timer').className = 'main-timer warn';
            document.getElementById('sidebar-q-info').textContent = 'Q' + (currentQuestionIndex + 1) + '/' + ACTIVE_QUESTIONS.length + ' ‚Äî En pause';
            updateButtons();
        }
    };

    // === SHOW RESULTS ===
    async function showResults() {
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        isPaused = false;
        currentPhase = 'results';

        await setDoc(doc(db, "quiz_live_config", "global"), buildConfig({
            phase: 'results',
            currentQuestionIndex: currentQuestionIndex,
            isOpen: false,
            showResults: true,
            paused: false,
            shuffleMap: null
        }));

        const q = ACTIVE_QUESTIONS[currentQuestionIndex];
        const qType = q.type || 'qcm';
        const currentResponses = responsesData.filter(r => r.questionIndex === currentQuestionIndex);

        const grid = document.getElementById('main-choices');
        const motInfo = document.getElementById('main-mot-info');

        if (qType === 'mot') {
            // Show results for short answer
            grid.style.display = 'none';
            motInfo.style.display = 'block';
            const correctCount = currentResponses.filter(r => r.correct).length;
            motInfo.innerHTML = '‚úÖ Reponse : <strong style="color:#22c55e; font-size:1.5rem;">' + q.reponse + '</strong>' +
                '<br><br><span style="font-size:1.1rem;">' + correctCount + ' / ' + currentResponses.length + ' bonnes reponses</span>';
            document.getElementById('main-resp-counter').textContent = correctCount + ' / ' + currentResponses.length + ' bonnes reponses';
        } else {
            // QCM / V/F results
            grid.style.display = 'grid';
            motInfo.style.display = 'none';

            const total = currentResponses.length || 1;
            const numChoices = q.choices.length;
            const counts = new Array(numChoices).fill(0);
            currentResponses.forEach(r => { if (r.answer >= 0 && r.answer < numChoices) counts[r.answer]++; });

            for (let i = 0; i < numChoices; i++) {
                const pct = Math.round((counts[i] / total) * 100);
                const bar = document.getElementById('bar-' + i);
                const pctEl = document.getElementById('pct-' + i);
                const choiceEl = document.getElementById('main-choice-' + i);
                if (bar) bar.style.width = pct + '%';
                if (pctEl) { pctEl.textContent = pct + '%'; pctEl.style.display = 'block'; }
                if (i === q.correct && choiceEl) choiceEl.classList.add('correct-answer');
            }

            const correctCount = currentResponses.filter(r => r.correct).length;
            document.getElementById('main-resp-counter').textContent = correctCount + ' / ' + currentResponses.length + ' bonnes reponses';
        }

        document.getElementById('sidebar-q-info').textContent = 'Q' + (currentQuestionIndex + 1) + '/' + ACTIVE_QUESTIONS.length + ' ‚Äî Resultats';
        document.getElementById('main-timer').textContent = '‚úÖ';
        document.getElementById('main-timer').className = 'main-timer';

        // === TEAM SCORES IN RESULTS ===
        displayTeamScoresForQuestion();

        updateButtons();

        // === AUTO-ADVANCE : en mode Auto, passe √† la question suivante apr√®s 4s ===
        if (currentMode === 'auto') {
            if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; }
            const hasMoreQ = currentQuestionIndex < ACTIVE_QUESTIONS.length - 1;
            const delaySeconds = parseInt(document.getElementById('results-timer-input').value) || 6;
            let countdown = delaySeconds;
            document.getElementById('main-timer').textContent = hasMoreQ ? '‚è≠Ô∏è ' + countdown + 's' : 'üèÅ ' + countdown + 's';
            document.getElementById('main-timer').className = 'main-timer warn';

            // Countdown display during results
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    return;
                }
                document.getElementById('main-timer').textContent = hasMoreQ ? '‚è≠Ô∏è ' + countdown + 's' : 'üèÅ ' + countdown + 's';
            }, 1000);

            autoAdvanceTimer = setTimeout(() => {
                clearInterval(countdownInterval);
                autoAdvanceTimer = null;
                if (hasMoreQ) {
                    launchQuestion(); // next question
                } else {
                    endQuiz(); // last question done, show summary
                }
            }, delaySeconds * 1000);
        }
    }

    window.showResultsManual = async function() {
        if (currentPhase !== 'question') return;
        await showResults();
    };

    window.nextQuestion = function() { launchQuestion(); };

    window.prevQuestion = async function() {
        if (currentQuestionIndex <= 0) return;
        currentQuestionIndex -= 2;
        await launchQuestion();
    };

    // === RESTART ===
    window.restartQuiz = async function() {
        if (!currentSessionId) return;
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; }
        isPaused = false;

        const qResp = query(collection(db, "quiz_live_reponses"), where("sessionId", "==", currentSessionId));
        const snap = await getDocs(qResp);
        if (snap.size > 0) {
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
        }

        currentQuestionIndex = -1;
        responsesData = [];
        currentPhase = 'lobby';

        await setDoc(doc(db, "quiz_live_config", "global"), buildConfig({
            phase: 'lobby',
            currentQuestionIndex: -1,
            isOpen: false,
            showResults: false,
            paused: false,
            shuffleMap: null
        }));

        showMainScreen('lobby');
        document.getElementById('sidebar-q-info').textContent = 'Aucune ‚Äî Lance le quiz';
        document.getElementById('main-code').textContent = currentSessionCode;
        document.getElementById('main-code').style.display = 'block';
        document.getElementById('main-lobby').querySelector('p').textContent = 'Les eleves rejoignent avec le code :';
        updateButtons();
    };

    // === END QUIZ ===
    window.endQuiz = async function() {
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; }
        isPaused = false;
        currentPhase = 'summary';

        await setDoc(doc(db, "quiz_live_config", "global"), buildConfig({
            phase: 'summary',
            currentQuestionIndex: currentQuestionIndex,
            isOpen: false,
            showResults: false,
            paused: false,
            shuffleMap: null
        }));

        showMainScreen('summary');
        displaySummary();
        updateButtons();
    };

    function displaySummary() {
        let totalCorrect = 0;
        let totalAnswered = 0;
        const barsContainer = document.getElementById('summary-bars');
        barsContainer.innerHTML = '';

        // Team podium if in team mode
        if (gameMode !== 'solo' && teams.length > 0) {
            const cumulative = computeTeamCumulativeScores();
            let podiumHtml = '<div class="team-podium">';
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            cumulative.forEach((t, i) => {
                podiumHtml += '<div class="podium-card' + (i === 0 ? ' gold' : '') + '" style="border-color:' + (i === 0 ? t.teamColor : 'transparent') + ';">' +
                    '<div class="podium-rank">' + (medals[i] || '#' + (i + 1)) + '</div>' +
                    '<div class="podium-name" style="color:' + t.teamColor + ';">' + t.teamEmoji + ' ' + t.teamName + '</div>' +
                    '<div class="podium-score">' + t.pct + '%</div></div>';
            });
            podiumHtml += '</div>';
            barsContainer.insertAdjacentHTML('beforebegin', podiumHtml);
        }

        const maxQ = Math.min(currentQuestionIndex + 1, ACTIVE_QUESTIONS.length);
        for (let i = 0; i < maxQ; i++) {
            const qResponses = responsesData.filter(r => r.questionIndex === i);
            const correct = qResponses.filter(r => r.correct).length;
            const total = qResponses.length || 1;
            const pct = Math.round((correct / total) * 100);
            totalCorrect += correct;
            totalAnswered += qResponses.length;

            const row = document.createElement('div');
            row.className = 'summary-bar-row';
            row.style.animation = 'fadeIn 0.5s ease ' + (i * 0.15) + 's both';

            let barColor = pct >= 60 ? '#22c55e' : pct >= 40 ? '#f59e0b' : '#ef4444';
            const qType = ACTIVE_QUESTIONS[i].type || 'qcm';
            const typeIcon = qType === 'mot' ? '‚úèÔ∏è' : qType === 'vf' || ACTIVE_QUESTIONS[i].originalType === 'vf' ? '‚úîÔ∏è' : 'üìã';

            row.innerHTML = '<div class="summary-bar-label">' + typeIcon + ' Q' + (i + 1) + '</div>' +
                '<div class="summary-bar-track"><div class="summary-bar-fill" style="width:0;background:' + barColor + ';">' + pct + '%</div></div>';
            barsContainer.appendChild(row);

            setTimeout(() => {
                row.querySelector('.summary-bar-fill').style.width = pct + '%';
            }, 300 + i * 150);
        }

        const globalPct = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
        document.getElementById('summary-global').textContent = 'Taux de reussite global : ' + globalPct + '%';
        document.getElementById('sidebar-q-info').textContent = 'Quiz termine ‚Äî ' + globalPct + '% de reussite';
    }

    // === TEAM SCORE DISPLAY (after each question result) ===
    function displayTeamScoresForQuestion() {
        // Remove previous team display
        const old = document.getElementById('team-results-strip');
        if (old) old.remove();

        if (gameMode === 'solo' || !teams.length) return;

        const teamScores = computeTeamScores(currentQuestionIndex);
        const cumulative = computeTeamCumulativeScores();
        const container = document.createElement('div');
        container.id = 'team-results-strip';
        container.style.cssText = 'margin-top:16px; width:100%;';

        if (gameMode === 'battle' && teams.length === 2) {
            // TUG OF WAR display
            const a = cumulative.find(t => t.teamId === teams[0].teamId) || { pct: 0 };
            const b = cumulative.find(t => t.teamId === teams[1].teamId) || { pct: 0 };
            const qA = teamScores.find(t => t.teamId === teams[0].teamId) || { pct: 0 };
            const qB = teamScores.find(t => t.teamId === teams[1].teamId) || { pct: 0 };
            const total = (a.pct + b.pct) || 1;
            const pctA = Math.round((a.pct / total) * 100);

            container.innerHTML = '<div class="tug-container">' +
                '<div class="tug-labels"><span style="color:' + teams[0].teamColor + ';">' + teams[0].teamEmoji + ' ' + teams[0].teamName + ' <span style="font-size:0.8rem;">(+' + qA.pct + '%)</span></span>' +
                '<span style="color:' + teams[1].teamColor + ';">' + teams[1].teamEmoji + ' ' + teams[1].teamName + ' <span style="font-size:0.8rem;">(+' + qB.pct + '%)</span></span></div>' +
                '<div class="tug-track"><div class="tug-fill-a" style="width:' + pctA + '%;"></div><div class="tug-fill-b" style="width:' + (100 - pctA) + '%;"></div></div>' +
                '<div class="tug-score">' + a.pct + '% vs ' + b.pct + '%</div></div>';
        } else {
            // TEAM SCORE PILLS (equipe / duo)
            const sorted = [...teamScores].sort((a, b) => b.pct - a.pct);
            let html = '<div class="team-score-strip">';
            sorted.forEach(t => {
                const cum = cumulative.find(c => c.teamId === t.teamId);
                html += '<div class="team-score-pill" style="background:' + t.teamColor + ';">' +
                    t.teamEmoji + ' ' + t.teamName + ' <strong>' + t.pct + '%</strong>' +
                    '<span style="font-size:0.65rem; opacity:0.7;">(cumul: ' + (cum ? cum.pct : 0) + '%)</span></div>';
            });
            html += '</div>';
            container.innerHTML = html;
        }

        document.getElementById('main-question').appendChild(container);
    }

    // === AFFICHAGE ===
    function showMainScreen(name) {
        document.getElementById('main-lobby').style.display = name === 'lobby' ? 'flex' : 'none';
        document.getElementById('main-question').style.display = name === 'question' ? 'flex' : 'none';
        document.getElementById('main-summary').style.display = name === 'summary' ? 'block' : 'none';
    }
</script>
</body>
</html>

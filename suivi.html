<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suivi de S√©ance - PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data_modules.js"></script>
    <script src="data_eleves.js"></script>

    <!-- ‚≠ê MODULE MES √âL√àVES ‚≠ê -->
    <script>
    (function() {
        const CLE_ELEVES = 'cockpit_eleves_noms';
        window.getNomEleve = function(code) {
            if (!code) return null;
            const eleves = JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}');
            return eleves[code.toUpperCase()] || null;
        };
        window.afficherAvecNom = function(code) {
            if (!code) return code || '';
            const nom = window.getNomEleve(code);
            return nom ? code + ' (' + nom + ')' : code;
        };
        window.hasElevesCharges = function() {
            return Object.keys(JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}')).length > 0;
        };
        window.getNbElevesCharges = function() {
            return Object.keys(JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}')).length;
        };
        console.log('Module Mes eleves charge (' + window.getNbElevesCharges() + ' en memoire)');
    })();
    </script>
    
    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --primary: #3b82f6;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #dc2626;
            --border: #e2e8f0;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 100px;
        }
        
        .container { max-width: 500px; margin: 0 auto; }
        
        /* === HEADER === */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 1.4em;
            color: var(--primary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .header .date {
            color: var(--muted);
            font-size: 0.85em;
        }
        
        /* === CARDS === */
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        }
        .card-title {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* === FORM === */
        label.field-label {
            display: block;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
            margin-bottom: 15px;
            background: white;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
        }
        select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* === CHECKBOXES CRIT√àRES === */
        .criteres-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .critere-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .critere-item:has(input:checked) {
            background: #eff6ff;
            border-color: var(--primary);
        }
        .critere-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }
        .critere-item span {
            font-size: 0.9em;
            font-weight: 500;
        }
        
        /* === BOUTONS === */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
            box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
        }
        .btn-secondary {
            background: #e2e8f0;
            color: var(--text);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* === √âL√àVE HEADER === */
        .eleve-banner {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .eleve-code {
            font-size: 2.5em;
            font-weight: 800;
            letter-spacing: 2px;
        }
        .eleve-info {
            text-align: right;
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        /* === SECTIONS SAISIE === */
        .section-saisie {
            margin-bottom: 20px;
        }
        .section-saisie h3 {
            font-size: 0.85em;
            color: var(--muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* === OPTIONS BOUTONS === */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .options-grid.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        .options-grid.cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .opt-btn {
            padding: 16px 8px;
            border: 3px solid var(--border);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .opt-btn:active {
            transform: scale(0.95);
        }
        .opt-btn .emoji {
            font-size: 1.6em;
            display: block;
            margin-bottom: 4px;
        }
        .opt-btn .label {
            font-size: 0.7em;
            font-weight: 600;
            color: var(--muted);
        }
        .opt-btn.selected {
            border-color: var(--success);
            background: #f0fdf4;
            transform: scale(1.02);
        }
        .opt-btn.selected .label {
            color: var(--success);
        }
        
        /* Couleurs sp√©cifiques */
        .opt-btn[data-value="tresbien"].selected,
        .opt-btn[data-value="bonne"].selected,
        .opt-btn[data-value="ok"].selected,
        .opt-btn[data-value="2"].selected { 
            border-color: #16a34a; 
            background: #f0fdf4; 
        }
        .opt-btn[data-value="fait"].selected { 
            border-color: #22c55e; 
            background: #f0fdf4; 
        }
        .opt-btn[data-value="partiel"].selected,
        .opt-btn[data-value="moyenne"].selected,
        .opt-btn[data-value="1"].selected { 
            border-color: #f59e0b; 
            background: #fffbeb; 
        }
        .opt-btn[data-value="insuffisant"].selected,
        .opt-btn[data-value="insuffisante"].selected,
        .opt-btn[data-value="oubli"].selected,
        .opt-btn[data-value="0"].selected { 
            border-color: #dc2626; 
            background: #fef2f2; 
        }
        
        /* === BOUTONS COMPORTEMENT === */
        .opt-btn.good {
            border-color: #bbf7d0;
            background: #f0fdf4;
        }
        .opt-btn.good.selected {
            border-color: #22c55e;
            background: #dcfce7;
            color: #166534;
        }
        .opt-btn.warning {
            border-color: #fde68a;
            background: #fffbeb;
        }
        .opt-btn.warning.selected {
            border-color: #f59e0b;
            background: #fef3c7;
            color: #92400e;
        }
        .opt-btn.danger {
            border-color: #fecaca;
            background: #fef2f2;
        }
        .opt-btn.danger.selected {
            border-color: #ef4444;
            background: #fee2e2;
            color: #dc2626;
        }
        .opt-btn.danger-max {
            border-color: #fca5a5;
            background: #fee2e2;
        }
        .opt-btn.danger-max.selected {
            border-color: #dc2626;
            background: #dc2626;
            color: white;
        }
        .options-grid.cols-5 {
            grid-template-columns: repeat(5, 1fr);
        }
        @media (max-width: 600px) {
            .options-grid.cols-5 {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* === NOTE PREVIEW === */
        .note-box {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .note-box .value {
            font-size: 3em;
            font-weight: 800;
            color: var(--success);
        }
        .note-box .label {
            font-size: 0.85em;
            color: var(--muted);
            margin-top: 5px;
        }
        
        /* === COMMENTAIRES === */
        .comment-section {
            margin-bottom: 20px;
        }
        .comment-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .comment-tag {
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }
        .comment-tag.positif {
            background: #dcfce7;
            color: #166534;
        }
        .comment-tag.encouragement {
            background: #fef3c7;
            color: #92400e;
        }
        .comment-tag.alerte {
            background: #fee2e2;
            color: #991b1b;
        }
        .comment-tag:active {
            transform: scale(0.95);
        }
        
        .comment-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.95em;
            font-family: inherit;
            resize: none;
            min-height: 60px;
        }
        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* === DISTRIBUTION COURS === */
        .cours-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .cours-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
            color: #475569;
        }
        .cours-option:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
        }
        .cours-option:has(input:checked) {
            border-color: #3b82f6;
            background: #dbeafe;
            color: #1e40af;
        }
        .cours-option.complet {
            border-color: #bbf7d0;
            background: #f0fdf4;
            color: #166534;
        }
        .cours-option.complet:has(input:checked) {
            border-color: #16a34a;
            background: #dcfce7;
            color: #166534;
        }
        .cours-option input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
        }
        
        /* === LISTE √âL√àVES === */
        .eleves-list {
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid var(--border);
            border-radius: 12px;
        }
        .eleve-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .eleve-row:last-child { border-bottom: none; }
        .eleve-row:active { background: #f1f5f9; }
        .eleve-row.current { background: #eff6ff; }
        .eleve-row.done { background: #f0fdf4; }
        .eleve-row .code {
            font-weight: 700;
            font-size: 1.1em;
        }
        .eleve-row .status {
            font-size: 0.9em;
            font-weight: 600;
        }
        .eleve-row .status.done { color: var(--success); }
        .eleve-row .status.pending { color: var(--muted); }
        .eleve-row .status.absent { color: #92400e; }
        .eleve-row.absent { background: #fef3c7; }
        
        /* === ACTIONS === */
        .actions-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }
        
        /* === TOAST === */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success);
            color: white;
            padding: 16px 30px;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* === √âCRANS === */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* === √âCRAN LOGIN === */
        .login-screen {
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        .login-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        .login-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 10px;
        }
        .login-subtitle {
            color: var(--muted);
            margin-bottom: 30px;
            font-size: 0.95em;
        }
        .btn-google {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 14px 28px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }
        .btn-google:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        .btn-google:active {
            transform: scale(0.98);
        }
        
        /* === NAVIGATION === */
        .nav-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .nav-btn {
            padding: 8px 14px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .nav-btn.active {
            background: var(--primary);
            color: white;
        }
        .nav-btn:not(.active) {
            background: var(--card);
            color: var(--text);
            border: 2px solid var(--border);
        }
        .nav-btn:not(.active):hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .login-info {
            margin-top: 30px;
            padding: 15px;
            background: #fef3c7;
            border-radius: 12px;
            color: #92400e;
            font-size: 0.85em;
            max-width: 300px;
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 400px) {
            body { padding: 10px; }
            .card { padding: 15px; }
            .eleve-code { font-size: 2em; }
            .opt-btn { padding: 12px 6px; }
            .opt-btn .emoji { font-size: 1.3em; }
            .options-grid { gap: 6px; }
            .note-box .value { font-size: 2.5em; }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- √âCRAN 0 : CONNEXION PROF -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="screenLogin" class="screen active">
            <div class="login-screen">
                <div class="login-icon">üîê</div>
                <div class="login-title">Acc√®s Professeur</div>
                <div class="login-subtitle">Connectez-vous pour acc√©der au suivi</div>
                
                <button class="btn-google" onclick="connexionGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#fff"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#fff"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#fff"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#fff"/>
                    </svg>
                    Connexion avec Google
                </button>
                
                <div class="login-info">
                    üîí Seul le professeur peut acc√©der au suivi de classe pour saisir les √©valuations.
                </div>
            </div>
        </div>
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- √âCRAN 1 : CONFIGURATION -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="screenConfig" class="screen">
            
            <!-- NAVIGATION -->
            <nav class="nav-bar">
                <a href="suivi.html" class="nav-btn active">üìù Suivi</a>
                <a href="dashboard.html" class="nav-btn">üìä Dashboard</a>
                <a href="historique-suivi.html" class="nav-btn">üìã Historique</a>
                <a href="index.html" class="nav-btn">üè† Cockpit</a>
            </nav>
            
            <div class="header">
                <h1>üìã Suivi de S√©ance</h1>
                <div class="date" id="dateJour"></div>
                <div id="authBadge" style="margin-top: 10px; font-size: 0.8em; color: #16a34a; display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
                    <span id="userEmail">--</span>
                    <button onclick="deconnexion()" style="background: #fee2e2; color: #991b1b; border: none; padding: 4px 10px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">D√©connexion</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">‚öôÔ∏è Configuration</div>
                
                <label class="field-label">Classe / Groupe</label>
                <select id="selectClasse" onchange="onClasseChange()">
                    <option value="">-- S√©lectionner --</option>
                </select>
                
                <label class="field-label">Module</label>
                <select id="selectModule">
                    <option value="">-- S√©lectionner --</option>
                </select>
                
                <label class="field-label">Comp√©tences travaill√©es (optionnel)</label>
                <div class="criteres-grid" id="competencesGrid" style="margin-bottom: 15px;">
                    <!-- Rempli dynamiquement -->
                </div>
                
                <label class="field-label">Crit√®res √† √©valuer</label>
                <div class="criteres-grid">
                    <label class="critere-item">
                        <input type="checkbox" id="checkTravail" checked>
                        <span>üìù Travail</span>
                    </label>
                    <label class="critere-item">
                        <input type="checkbox" id="checkOral" checked>
                        <span>üó£Ô∏è Oral</span>
                    </label>
                    <label class="critere-item">
                        <input type="checkbox" id="checkAttention" checked>
                        <span>üß† Attention</span>
                    </label>
                    <label class="critere-item">
                        <input type="checkbox" id="checkPorteVue">
                        <span>üìÅ Porte-vue</span>
                    </label>
                </div>
                
                <label class="critere-item" style="margin-bottom: 20px;">
                    <input type="checkbox" id="checkCommentaire">
                    <span>üí¨ Appr√©ciation</span>
                </label>
                
                <label class="field-label">üìÑ Cours distribu√© aujourd'hui</label>
                <select id="selectCoursDefaut" style="margin-bottom: 20px;">
                    <option value="aucun">Aucun cours distribu√©</option>
                    <option value="seance1">S√©ance 1</option>
                    <option value="seance2">S√©ance 2</option>
                    <option value="seance3">S√©ance 3</option>
                    <option value="seance4">S√©ance 4</option>
                    <option value="complet">üìö Cours complet</option>
                </select>
                
                <button class="btn btn-primary" onclick="demarrerSeance()">
                    üöÄ D√©marrer la s√©ance
                </button>
            </div>
        </div>
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- √âCRAN 2 : SAISIE -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="screenSaisie" class="screen">
            
            <div class="eleve-banner">
                <div>
                    <div class="eleve-code" id="eleveCode">--</div>
                    <div id="eleveClasse">--</div>
                </div>
                <div class="eleve-info">
                    <div id="eleveHeure">--:--</div>
                    <div id="eleveModule">--</div>
                </div>
            </div>
            
            <!-- TRAVAIL -->
            <div class="section-saisie" id="sectionTravail">
                <h3>üìù Travail</h3>
                <div class="options-grid">
                    <div class="opt-btn" data-critere="travail" data-value="tresbien" onclick="selectOption(this)">
                        <span class="emoji">‚úì‚úì</span>
                        <span class="label">Tr√®s bien</span>
                    </div>
                    <div class="opt-btn" data-critere="travail" data-value="fait" onclick="selectOption(this)">
                        <span class="emoji">‚úì</span>
                        <span class="label">Fait</span>
                    </div>
                    <div class="opt-btn" data-critere="travail" data-value="partiel" onclick="selectOption(this)">
                        <span class="emoji">‚ö†Ô∏è</span>
                        <span class="label">Partiel</span>
                    </div>
                    <div class="opt-btn" data-critere="travail" data-value="insuffisant" onclick="selectOption(this)">
                        <span class="emoji">‚ùå</span>
                        <span class="label">Non fait</span>
                    </div>
                </div>
            </div>
            
            <!-- ORAL -->
            <div class="section-saisie" id="sectionOral">
                <h3>üó£Ô∏è Participation orale</h3>
                <div class="options-grid cols-3">
                    <div class="opt-btn" data-critere="oral" data-value="0" onclick="selectOption(this)">
                        <span class="emoji">0</span>
                        <span class="label">Aucune</span>
                    </div>
                    <div class="opt-btn" data-critere="oral" data-value="1" onclick="selectOption(this)">
                        <span class="emoji">1</span>
                        <span class="label">Bien</span>
                    </div>
                    <div class="opt-btn" data-critere="oral" data-value="2" onclick="selectOption(this)">
                        <span class="emoji">2</span>
                        <span class="label">Tr√®s bien</span>
                    </div>
                </div>
            </div>
            
            <!-- ATTENTION -->
            <div class="section-saisie" id="sectionAttention">
                <h3>üß† Attention / Concentration</h3>
                <div class="options-grid cols-3">
                    <div class="opt-btn" data-critere="attention" data-value="bonne" onclick="selectOption(this)">
                        <span class="emoji">üòä</span>
                        <span class="label">Bonne</span>
                    </div>
                    <div class="opt-btn" data-critere="attention" data-value="moyenne" onclick="selectOption(this)">
                        <span class="emoji">üòê</span>
                        <span class="label">Moyenne</span>
                    </div>
                    <div class="opt-btn" data-critere="attention" data-value="insuffisante" onclick="selectOption(this)">
                        <span class="emoji">üòï</span>
                        <span class="label">Insuffisante</span>
                    </div>
                </div>
            </div>
            
            <!-- PORTE-VUE -->
            <div class="section-saisie" id="sectionPorteVue">
                <h3>üìÅ Porte-vue</h3>
                <div class="options-grid cols-2">
                    <div class="opt-btn" data-critere="porteVue" data-value="ok" onclick="selectOption(this)">
                        <span class="emoji">‚úÖ</span>
                        <span class="label">OK</span>
                    </div>
                    <div class="opt-btn" data-critere="porteVue" data-value="oubli" onclick="selectOption(this)">
                        <span class="emoji">‚ùå</span>
                        <span class="label">Oubli√©</span>
                    </div>
                </div>
            </div>
            
            <!-- BAVARDAGE -->
            <div class="section-saisie" id="sectionBavardage">
                <h3>üí¨ Bavardage <span style="font-weight: 400; font-size: 0.75em; color: #dc2626;">(plafonne la note)</span></h3>
                <div class="options-grid cols-5">
                    <div class="opt-btn good" data-critere="bavardage" data-value="aucun" onclick="selectOption(this)">
                        <span class="emoji">üòä</span>
                        <span class="label">Aucun</span>
                    </div>
                    <div class="opt-btn warning" data-critere="bavardage" data-value="rappel1" onclick="selectOption(this)">
                        <span class="emoji">1Ô∏è‚É£</span>
                        <span class="label">Rappel 1</span>
                    </div>
                    <div class="opt-btn warning" data-critere="bavardage" data-value="rappel2" onclick="selectOption(this)">
                        <span class="emoji">2Ô∏è‚É£</span>
                        <span class="label">Rappel 2</span>
                    </div>
                    <div class="opt-btn danger" data-critere="bavardage" data-value="rappel3" onclick="selectOption(this)">
                        <span class="emoji">3Ô∏è‚É£</span>
                        <span class="label">Rappel 3</span>
                    </div>
                    <div class="opt-btn danger-max" data-critere="bavardage" data-value="retenu" onclick="selectOption(this)">
                        <span class="emoji">üö®</span>
                        <span class="label">Retenu</span>
                    </div>
                </div>
            </div>
            
            <!-- T√âL√âPHONE -->
            <div class="section-saisie" id="sectionTelephone">
                <h3>üì± T√©l√©phone <span style="font-weight: 400; font-size: 0.75em; color: #f59e0b;">(malus)</span></h3>
                <div class="options-grid cols-5">
                    <div class="opt-btn good" data-critere="telephone" data-value="ok" onclick="selectOption(this)">
                        <span class="emoji">‚úÖ</span>
                        <span class="label">OK</span>
                    </div>
                    <div class="opt-btn warning" data-critere="telephone" data-value="rappel1" onclick="selectOption(this)">
                        <span class="emoji">1Ô∏è‚É£</span>
                        <span class="label">Rappel 1</span>
                    </div>
                    <div class="opt-btn warning" data-critere="telephone" data-value="rappel2" onclick="selectOption(this)">
                        <span class="emoji">2Ô∏è‚É£</span>
                        <span class="label">Rappel 2</span>
                    </div>
                    <div class="opt-btn danger" data-critere="telephone" data-value="rappel3" onclick="selectOption(this)">
                        <span class="emoji">3Ô∏è‚É£</span>
                        <span class="label">Rappel 3</span>
                    </div>
                    <div class="opt-btn danger-max" data-critere="telephone" data-value="confisque" onclick="selectOption(this)">
                        <span class="emoji">üö´</span>
                        <span class="label">Confisqu√©</span>
                    </div>
                </div>
            </div>
            
            <!-- COMMENTAIRE -->
            <div class="section-saisie" id="sectionCommentaire">
                <h3>üí¨ Appr√©ciation</h3>
                <div class="comment-tags" id="commentTags"></div>
                <textarea class="comment-input" id="inputCommentaire" placeholder="Ajouter un commentaire..."></textarea>
            </div>
            
            <!-- DISTRIBUTION COURS -->
            <div class="section-saisie" id="sectionCours">
                <h3>üìÑ Distribution cours</h3>
                <div class="cours-options">
                    <label class="cours-option">
                        <input type="radio" name="coursDistrib" value="aucun" checked>
                        <span>Aucun</span>
                    </label>
                    <label class="cours-option">
                        <input type="radio" name="coursDistrib" value="seance1">
                        <span>S√©ance 1</span>
                    </label>
                    <label class="cours-option">
                        <input type="radio" name="coursDistrib" value="seance2">
                        <span>S√©ance 2</span>
                    </label>
                    <label class="cours-option">
                        <input type="radio" name="coursDistrib" value="seance3">
                        <span>S√©ance 3</span>
                    </label>
                    <label class="cours-option">
                        <input type="radio" name="coursDistrib" value="seance4">
                        <span>S√©ance 4</span>
                    </label>
                    <label class="cours-option complet">
                        <input type="radio" name="coursDistrib" value="complet">
                        <span>üìö Cours complet</span>
                    </label>
                </div>
            </div>
            
            <!-- NOTE -->
            <div class="note-box">
                <div class="label">Note de la s√©ance</div>
                <div class="value" id="notePreview">--/20</div>
            </div>
            
            <!-- ACTIONS -->
            <div class="actions-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <button class="btn btn-secondary" onclick="retourConfig()">‚Üê Retour</button>
                <button class="btn btn-absent" onclick="marquerAbsent()" style="background: #fef3c7; color: #92400e; border: 2px solid #fbbf24;">üö´ Absent</button>
                <button class="btn btn-success" onclick="validerSaisie()">‚úì Valider</button>
            </div>
            
            <!-- LISTE √âL√àVES -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">üë• √âl√®ves (<span id="compteurEleves">0</span>)</div>
                <div class="eleves-list" id="listeEleves"></div>
            </div>
            
        </div>
        
    </div>
    
    <!-- TOAST -->
    <div class="toast" id="toast">‚úÖ Enregistr√© !</div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- SCRIPTS -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script type="module">
        console.log("üîÑ Chargement du module Firebase...");
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        
        console.log("‚úÖ Imports Firebase OK");
        
        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.appspot.com",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONNEXION GOOGLE (optimis√© pour Safari iOS)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.connexionGoogle = async function() {
            try {
                // Toujours essayer popup d'abord (plus fiable sur iOS 16.4+)
                console.log("üîê Tentative connexion popup...");
                const result = await signInWithPopup(auth, googleProvider);
                console.log("‚úÖ Connect√© via popup:", result.user.email);
                afficherEcranConfig();
            } catch (error) {
                console.log("‚ö†Ô∏è Popup √©chou√©e, tentative redirect...", error.code);
                
                // Si popup bloqu√©e ou √©chou√©e, essayer redirect
                if (error.code === 'auth/popup-blocked' || 
                    error.code === 'auth/popup-closed-by-user' ||
                    error.code === 'auth/cancelled-popup-request' ||
                    error.code === 'auth/internal-error') {
                    try {
                        // Sauvegarder l'√©l√®ve en attente avant redirect
                        const urlParams = new URLSearchParams(window.location.search);
                        const eleveCode = urlParams.get('eleve');
                        if (eleveCode) {
                            sessionStorage.setItem('pendingEleve', eleveCode);
                        }
                        await signInWithRedirect(auth, googleProvider);
                    } catch (redirectError) {
                        console.error("‚ùå Erreur redirect:", redirectError);
                        alert("Erreur de connexion. Essayez d'ouvrir le lien dans Safari directement.");
                    }
                } else {
                    console.error("‚ùå Erreur connexion:", error);
                    alert("Erreur de connexion: " + error.message);
                }
            }
        };
        
        console.log("‚úÖ Fonction connexionGoogle d√©finie");
        
        function afficherEcranConfig() {
            document.getElementById('screenLogin').classList.remove('active');
            document.getElementById('screenConfig').classList.add('active');
            
            // Afficher l'email
            if (currentUser) {
                document.getElementById('userEmail').textContent = '‚úÖ ' + currentUser.email;
            }
            
            // V√©rifier si scan QR en attente
            checkQRScan();
            
            // V√©rifier si √©l√®ve en attente depuis sessionStorage (apr√®s redirect)
            const pendingEleve = sessionStorage.getItem('pendingEleve');
            if (pendingEleve) {
                window.pendingEleveFromQR = pendingEleve;
                sessionStorage.removeItem('pendingEleve');
                console.log("üì± √âl√®ve r√©cup√©r√© apr√®s redirect:", pendingEleve);
            }
        }
        
        window.deconnexion = async function() {
            await signOut(auth);
            currentUser = null;
            document.getElementById('screenLogin').classList.add('active');
            document.getElementById('screenConfig').classList.remove('active');
            document.getElementById('screenSaisie').classList.remove('active');
        };
        
        // G√©rer le retour de redirection (mobile)
        getRedirectResult(auth).then((result) => {
            if (result && result.user) {
                console.log("‚úÖ Connect√© via redirection:", result.user.email);
                afficherEcranConfig();
            }
        }).catch((error) => {
            if (error.code !== 'auth/popup-closed-by-user') {
                console.error("‚ùå Erreur retour redirection:", error);
            }
        });
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VARIABLES GLOBALES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let currentUser = null;
        let seanceConfig = {
            classe: null,
            classesEffectives: [],
            module: null,
            competence: null,
            criteres: { travail: true, oral: true, attention: true, porteVue: false, commentaire: false },
            dateDebut: null
        };
        let currentEleve = null;
        let saisie = { travail: null, oral: null, attention: null, porteVue: null, bavardage: null, telephone: null };
        let elevesSeance = []; // { code, classe, done, note }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INITIALISATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.addEventListener('DOMContentLoaded', () => {
            // Date
            const now = new Date();
            document.getElementById('dateJour').textContent = now.toLocaleDateString('fr-FR', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
            
            // Liste des classes/groupes
            const select = document.getElementById('selectClasse');
            const liste = window.getListeClassesPourAffichage ? window.getListeClassesPourAffichage() : [];
            liste.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item.label;
                select.appendChild(opt);
            });
            
            // Banque de commentaires
            renderCommentTags();
            
            // Auth - V√©rifier si d√©j√† connect√©
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    console.log("‚úÖ Connect√©:", user.email);
                    // D√©j√† connect√© ‚Üí afficher √©cran config
                    afficherEcranConfig();
                } else {
                    console.log("üîí Non connect√©");
                    // Pas connect√© ‚Üí afficher √©cran login
                    document.getElementById('screenLogin').classList.add('active');
                    document.getElementById('screenConfig').classList.remove('active');
                    document.getElementById('screenSaisie').classList.remove('active');
                }
            });
        });
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SCAN QR CODE - Mode rapide
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function checkQRScan() {
            const params = new URLSearchParams(window.location.search);
            const eleveCode = params.get('eleve');
            const reprendre = params.get('reprendre');
            
            // Mode REPRENDRE une s√©ance depuis l'historique
            if (reprendre === 'true') {
                console.log("üîÑ Mode reprendre s√©ance d√©tect√©");
                
                const classe = params.get('classe');
                const module = params.get('module');
                const elevesNotesStr = params.get('elevesNotes') || '';
                const elevesNotes = elevesNotesStr ? elevesNotesStr.split(',') : [];
                
                // Stocker les √©l√®ves d√©j√† not√©s pour les marquer
                window.elevesDejaNotes = elevesNotes;
                
                // Pr√©-remplir la classe
                if (classe) {
                    const selectClasse = document.getElementById('selectClasse');
                    selectClasse.value = classe;
                    onClasseChange();
                    
                    // Pr√©-remplir le module apr√®s un petit d√©lai (pour laisser le temps au select de se remplir)
                    setTimeout(() => {
                        if (module) {
                            const selectModule = document.getElementById('selectModule');
                            selectModule.value = module;
                        }
                    }, 100);
                }
                
                showToast("üìã Reprise de s√©ance - " + elevesNotes.length + " √©l√®ve(s) d√©j√† not√©(s)", 3000);
                return;
            }
            
            // Mode SCAN QR CODE √©l√®ve
            if (!eleveCode) return;
            
            console.log("üì± Scan QR d√©tect√©:", eleveCode);
            
            // Chercher l'√©l√®ve dans data_eleves.js
            if (!window.ELEVES_DATA) {
                alert("Donn√©es √©l√®ves non charg√©es !");
                return;
            }
            
            const eleve = window.ELEVES_DATA.find(e => e.code === eleveCode.toUpperCase());
            if (!eleve) {
                alert("√âl√®ve non trouv√©: " + eleveCode);
                return;
            }
            
            console.log("‚úÖ √âl√®ve trouv√©:", eleve);
            
            // Pr√©-remplir la classe
            const selectClasse = document.getElementById('selectClasse');
            selectClasse.value = eleve.classe;
            onClasseChange();
            
            // Stocker l'√©l√®ve √† s√©lectionner apr√®s d√©marrage
            window.pendingEleveFromQR = eleveCode.toUpperCase();
            
            // Afficher un message
            showToast("üì± " + eleve.prenom + " " + eleve.nom + " (" + eleve.classe + ")", 3000);
        }
        
        // Toast notification
        function showToast(message, duration = 2000) {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #1e293b;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 12px;
                    font-weight: 600;
                    z-index: 9999;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, duration);
        }
        
        function renderCommentTags() {
            const container = document.getElementById('commentTags');
            if (!window.BANQUE_COMMENTAIRES) return;
            
            let html = '';
            ['positif', 'encouragement', 'alerte'].forEach(cat => {
                (window.BANQUE_COMMENTAIRES[cat] || []).forEach(txt => {
                    html += `<button type="button" class="comment-tag ${cat}" onclick="addComment('${txt.replace(/'/g, "\\'")}')">${txt}</button>`;
                });
            });
            container.innerHTML = html;
        }
        
        window.addComment = function(txt) {
            const input = document.getElementById('inputCommentaire');
            if (input.value) {
                input.value += ' ' + txt;
            } else {
                input.value = txt;
            }
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DISTRIBUTION COURS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function getCoursDistrib() {
            const selected = document.querySelector('input[name="coursDistrib"]:checked');
            return selected ? selected.value : 'aucun';
        }
        
        function resetCoursDistrib() {
            const aucun = document.querySelector('input[name="coursDistrib"][value="aucun"]');
            if (aucun) aucun.checked = true;
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIGURATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.onClasseChange = function() {
            const classeId = document.getElementById('selectClasse').value;
            const selectModule = document.getElementById('selectModule');
            const competencesGrid = document.getElementById('competencesGrid');
            
            // Reset
            selectModule.innerHTML = '<option value="">-- S√©lectionner --</option>';
            competencesGrid.innerHTML = '';
            
            if (!classeId) return;
            
            // Trouver une classe du groupe pour avoir le niveau
            const classes = window.getClassesFromGroupe ? window.getClassesFromGroupe(classeId) : [classeId];
            const firstClasse = classes[0];
            
            // Modules
            const modules = window.getModulesForClasse ? window.getModulesForClasse(firstClasse) : [];
            modules.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = `${m.id} - ${m.titre}`;
                selectModule.appendChild(opt);
            });
            
            // Comp√©tences (checkboxes multiples)
            const competences = window.getCompetencesForClasse ? window.getCompetencesForClasse(firstClasse) : [];
            competencesGrid.innerHTML = competences.map(c => `
                <label class="critere-item">
                    <input type="checkbox" name="competences" value="${c.id}">
                    <span>${c.id}</span>
                </label>
            `).join('');
        };
        
        window.demarrerSeance = function() {
            const classeId = document.getElementById('selectClasse').value;
            const moduleId = document.getElementById('selectModule').value;
            
            // R√©cup√©rer les comp√©tences coch√©es
            const competencesChecked = Array.from(document.querySelectorAll('input[name="competences"]:checked')).map(cb => cb.value);
            
            // R√©cup√©rer le cours par d√©faut
            const coursDefaut = document.getElementById('selectCoursDefaut').value;
            
            if (!classeId) return alert("S√©lectionnez une classe !");
            if (!moduleId) return alert("S√©lectionnez un module !");
            
            // R√©cup√©rer les classes effectives (groupe ou simple)
            const classesEffectives = window.getClassesFromGroupe ? window.getClassesFromGroupe(classeId) : [classeId];
            
            // Trouver le titre du module
            const modules = window.getModulesForClasse ? window.getModulesForClasse(classesEffectives[0]) : [];
            const moduleObj = modules.find(m => m.id === moduleId);
            
            seanceConfig = {
                classe: classeId,
                classesEffectives: classesEffectives,
                module: moduleId,
                moduleTitre: moduleObj ? moduleObj.titre : moduleId,
                competences: competencesChecked, // Tableau de comp√©tences
                coursDefaut: coursDefaut, // Cours distribu√© par d√©faut pour tous
                criteres: {
                    travail: document.getElementById('checkTravail').checked,
                    oral: document.getElementById('checkOral').checked,
                    attention: document.getElementById('checkAttention').checked,
                    porteVue: document.getElementById('checkPorteVue').checked,
                    commentaire: document.getElementById('checkCommentaire').checked
                },
                dateDebut: new Date()
            };
            
            // Afficher/masquer sections
            document.getElementById('sectionTravail').style.display = seanceConfig.criteres.travail ? 'block' : 'none';
            document.getElementById('sectionOral').style.display = seanceConfig.criteres.oral ? 'block' : 'none';
            document.getElementById('sectionAttention').style.display = seanceConfig.criteres.attention ? 'block' : 'none';
            document.getElementById('sectionPorteVue').style.display = seanceConfig.criteres.porteVue ? 'block' : 'none';
            document.getElementById('sectionCommentaire').style.display = seanceConfig.criteres.commentaire ? 'block' : 'none';
            
            // Charger √©l√®ves
            chargerEleves();
            
            // Changer d'√©cran
            document.getElementById('screenConfig').classList.remove('active');
            document.getElementById('screenSaisie').classList.add('active');
            
            // ‚≠ê S√©lectionner l'√©l√®ve du QR code OU le premier √©l√®ve
            if (window.pendingEleveFromQR) {
                const qrEleve = elevesSeance.find(e => e.code === window.pendingEleveFromQR);
                if (qrEleve) {
                    selectionnerEleve(qrEleve.code);
                    showToast("üì± " + qrEleve.code + " s√©lectionn√©", 2000);
                } else if (elevesSeance.length > 0) {
                    selectionnerEleve(elevesSeance[0].code);
                }
                window.pendingEleveFromQR = null; // Reset
            } else if (elevesSeance.length > 0) {
                selectionnerEleve(elevesSeance[0].code);
            }
            
            console.log("üöÄ S√©ance d√©marr√©e:", seanceConfig);
        };
        
        function chargerEleves() {
            elevesSeance = [];
            const eleves = window.BDD_ELEVES || [];
            
            // R√©cup√©rer les √©l√®ves d√©j√† not√©s (si on reprend une s√©ance)
            const elevesDejaNotesListe = window.elevesDejaNotes || [];
            
            seanceConfig.classesEffectives.forEach(classe => {
                eleves.filter(e => e.classe === classe).forEach(e => {
                    const dejaNotes = elevesDejaNotesListe.includes(e.userCode);
                    elevesSeance.push({
                        code: e.userCode,
                        classe: e.classe,
                        done: dejaNotes,
                        absent: false,
                        note: dejaNotes ? '‚úì' : null,
                        dejaNotePrecedemment: dejaNotes // Marqueur sp√©cial
                    });
                });
            });
            
            // Trier : d'abord les non-not√©s, puis les not√©s
            elevesSeance.sort((a, b) => {
                if (a.dejaNotePrecedemment && !b.dejaNotePrecedemment) return 1;
                if (!a.dejaNotePrecedemment && b.dejaNotePrecedemment) return -1;
                return a.code.localeCompare(b.code);
            });
            
            document.getElementById('compteurEleves').textContent = elevesSeance.length;
            renderListeEleves();
        }
        
        function renderListeEleves() {
            const container = document.getElementById('listeEleves');
            container.innerHTML = elevesSeance.map(e => {
                let statusClass = 'pending';
                let statusText = '‚è≥';
                
                if (e.absent) {
                    statusClass = 'absent';
                    statusText = 'üö´ ABS';
                } else if (e.dejaNotePrecedemment && !e.modifieCetteSesssion) {
                    // √âl√®ve not√© dans une session pr√©c√©dente
                    statusClass = 'done';
                    statusText = '‚úÖ d√©j√†';
                } else if (e.done) {
                    statusClass = 'done';
                    statusText = '‚úÖ ' + e.note + '/20';
                }
                
                return `
                <div class="eleve-row ${statusClass} ${currentEleve === e.code ? 'current' : ''}" 
                     onclick="selectionnerEleve('${e.code}')"
                     title="${e.dejaNotePrecedemment ? 'D√©j√† not√© - Cliquer pour modifier' : (e.done || e.absent ? 'Cliquer pour modifier' : 'Cliquer pour √©valuer')}">
                    <span class="code">${window.afficherAvecNom(e.code)}</span>
                    <span class="status ${statusClass}">
                        ${statusText}
                    </span>
                </div>
            `}).join('');
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SAISIE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.selectionnerEleve = async function(code) {
            currentEleve = code;
            saisie = { travail: null, oral: null, attention: null, porteVue: null, bavardage: null, telephone: null };
            
            // Reset boutons
            document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
            
            // Reset commentaire
            document.getElementById('inputCommentaire').value = '';
            
            // Appliquer le cours par d√©faut (si d√©fini dans la config)
            if (seanceConfig.coursDefaut && seanceConfig.coursDefaut !== 'aucun') {
                const radio = document.querySelector(`input[name="coursDistrib"][value="${seanceConfig.coursDefaut}"]`);
                if (radio) radio.checked = true;
            } else {
                resetCoursDistrib();
            }
            
            // Afficher infos
            const eleveObj = elevesSeance.find(e => e.code === code);
            document.getElementById('eleveCode').textContent = window.afficherAvecNom(code);
            document.getElementById('eleveClasse').textContent = eleveObj ? eleveObj.classe : seanceConfig.classe;
            document.getElementById('eleveHeure').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('eleveModule').textContent = seanceConfig.module;
            
            // Si √©l√®ve d√©j√† not√© pr√©c√©demment, charger ses donn√©es
            if (eleveObj && eleveObj.dejaNotePrecedemment) {
                console.log("üìÇ Chargement donn√©es existantes pour", code);
                await chargerDonneesEleve(code);
            }
            
            updateNotePreview();
            renderListeEleves();
        };
        
        // Fonction pour charger les donn√©es d'un √©l√®ve depuis Firebase
        async function chargerDonneesEleve(code) {
            try {
                const dateSeance = seanceConfig.date || new Date().toISOString().split('T')[0];
                const suiviRef = collection(db, "resultats", code, "suivi");
                const suiviSnap = await getDocs(suiviRef);
                
                let donneesTrouvees = null;
                suiviSnap.forEach(docSnap => {
                    const data = docSnap.data();
                    // Chercher la saisie de la m√™me date et module
                    if (data.date === dateSeance && data.module === seanceConfig.module) {
                        donneesTrouvees = { id: docSnap.id, ...data };
                    }
                });
                
                if (donneesTrouvees) {
                    console.log("‚úÖ Donn√©es trouv√©es:", donneesTrouvees);
                    preremplirFormulaire(donneesTrouvees);
                } else {
                    console.log("‚ö†Ô∏è Pas de donn√©es trouv√©es pour cette date/module");
                }
            } catch (error) {
                console.error("‚ùå Erreur chargement donn√©es √©l√®ve:", error);
            }
        }
        
        // Pr√©-remplir le formulaire avec les donn√©es existantes
        function preremplirFormulaire(data) {
            // Travail
            if (data.travail) {
                const btnTravail = document.querySelector(`.opt-btn[data-critere="travail"][data-value="${data.travail}"]`);
                if (btnTravail) {
                    btnTravail.classList.add('selected');
                    saisie.travail = data.travail;
                }
            }
            
            // Oral
            if (data.oral !== undefined && data.oral !== null) {
                const btnOral = document.querySelector(`.opt-btn[data-critere="oral"][data-value="${data.oral}"]`);
                if (btnOral) {
                    btnOral.classList.add('selected');
                    saisie.oral = data.oral;
                }
            }
            
            // Attention
            if (data.attention) {
                const btnAttention = document.querySelector(`.opt-btn[data-critere="attention"][data-value="${data.attention}"]`);
                if (btnAttention) {
                    btnAttention.classList.add('selected');
                    saisie.attention = data.attention;
                }
            }
            
            // Porte-vue
            if (data.porteVue) {
                const btnPorteVue = document.querySelector(`.opt-btn[data-critere="porteVue"][data-value="${data.porteVue}"]`);
                if (btnPorteVue) {
                    btnPorteVue.classList.add('selected');
                    saisie.porteVue = data.porteVue;
                }
            }
            
            // Bavardage
            if (data.bavardage) {
                const btnBavardage = document.querySelector(`.opt-btn[data-critere="bavardage"][data-value="${data.bavardage}"]`);
                if (btnBavardage) {
                    btnBavardage.classList.add('selected');
                    saisie.bavardage = data.bavardage;
                }
            }
            
            // T√©l√©phone
            if (data.telephone) {
                const btnTelephone = document.querySelector(`.opt-btn[data-critere="telephone"][data-value="${data.telephone}"]`);
                if (btnTelephone) {
                    btnTelephone.classList.add('selected');
                    saisie.telephone = data.telephone;
                }
            }
            
            // Commentaire
            if (data.commentaire) {
                document.getElementById('inputCommentaire').value = data.commentaire;
            }
            
            // Cours distribu√©
            if (data.coursDistrib) {
                const radio = document.querySelector(`input[name="coursDistrib"][value="${data.coursDistrib}"]`);
                if (radio) radio.checked = true;
            }
            
            // Mettre √† jour l'aper√ßu de la note
            updateNotePreview();
            
            // Afficher un toast
            showToast(`üìã Donn√©es charg√©es - Note: ${data.noteSur20}/20`, 2000);
        }
        
        window.selectOption = function(btn) {
            const critere = btn.dataset.critere;
            const value = btn.dataset.value;
            
            // D√©s√©lectionner autres du m√™me crit√®re
            document.querySelectorAll(`.opt-btn[data-critere="${critere}"]`).forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            // Enregistrer
            if (critere === 'oral') {
                saisie[critere] = parseInt(value);
            } else {
                saisie[critere] = value;
            }
            
            updateNotePreview();
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // NOUVEAU CALCUL DE NOTE AVEC BAVARDAGE/T√âL√âPHONE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Plafonds bavardage
        const PLAFOND_BAVARDAGE = {
            'aucun': 20,
            'rappel1': 14,
            'rappel2': 10,
            'rappel3': 6,
            'retenu': 4
        };
        
        // Malus t√©l√©phone
        const MALUS_TELEPHONE = {
            'ok': 0,
            'rappel1': 1,
            'rappel2': 2,
            'rappel3': 3,
            'confisque': 5
        };
        
        function calculerNoteAvecComportement(saisieData, criteres) {
            // 1. Calcul de base (ancien syst√®me)
            let points = 0;
            let maxPoints = 0;
            
            // Travail (0-4 pts)
            if (criteres?.travail !== false && saisieData.travail) {
                maxPoints += 4;
                if (saisieData.travail === 'tresbien') points += 4;
                else if (saisieData.travail === 'fait') points += 3;
                else if (saisieData.travail === 'partiel') points += 1.5;
                else if (saisieData.travail === 'insuffisant') points += 0;
            }
            
            // Oral (0-2 pts)
            if (criteres?.oral !== false && saisieData.oral !== null && saisieData.oral !== undefined) {
                maxPoints += 2;
                points += parseInt(saisieData.oral) || 0;
            }
            
            // Attention (0-3 pts)
            if (criteres?.attention !== false && saisieData.attention) {
                maxPoints += 3;
                if (saisieData.attention === 'bonne') points += 3;
                else if (saisieData.attention === 'moyenne') points += 1.5;
                else if (saisieData.attention === 'insuffisante') points += 0;
            }
            
            // Porte-vue (0-1 pt)
            if (criteres?.porteVue !== false && saisieData.porteVue) {
                maxPoints += 1;
                if (saisieData.porteVue === 'ok') points += 1;
            }
            
            // 2. Convertir en note /20
            let noteBase = maxPoints > 0 ? Math.round((points / maxPoints) * 20 * 10) / 10 : 0;
            
            // 3. Appliquer le PLAFOND bavardage
            const bavardage = saisieData.bavardage || 'aucun';
            const plafond = PLAFOND_BAVARDAGE[bavardage] || 20;
            let notePlafonnee = Math.min(noteBase, plafond);
            
            // 4. Appliquer le MALUS t√©l√©phone
            const telephone = saisieData.telephone || 'ok';
            const malus = MALUS_TELEPHONE[telephone] || 0;
            let noteFinale = Math.max(0, notePlafonnee - malus);
            
            // Arrondir √† 0.5
            noteFinale = Math.round(noteFinale * 2) / 2;
            
            return {
                points: points,
                maxPoints: maxPoints,
                noteBase: noteBase,
                plafond: plafond,
                malus: malus,
                noteSur20: noteFinale,
                bavardage: bavardage,
                telephone: telephone
            };
        }
        
        function updateNotePreview() {
            const result = calculerNoteAvecComportement(saisie, seanceConfig.criteres);
            const hasValue = Object.values(saisie).some(v => v !== null);
            
            const noteEl = document.getElementById('notePreview');
            if (!hasValue) {
                noteEl.textContent = '--/20';
                noteEl.style.color = '#22c55e';
                return;
            }
            
            // Afficher la note avec indication si plafonn√©e
            let display = result.noteSur20 + '/20';
            
            // Changer la couleur selon le plafond
            if (result.bavardage === 'retenu') {
                noteEl.style.color = '#dc2626'; // Rouge vif
                display += ' üö®';
            } else if (result.bavardage === 'rappel3') {
                noteEl.style.color = '#dc2626';
                display += ' ‚ö†Ô∏è';
            } else if (result.bavardage === 'rappel2' || result.bavardage === 'rappel1') {
                noteEl.style.color = '#f59e0b'; // Orange
            } else if (result.malus > 0) {
                noteEl.style.color = '#f59e0b';
            } else {
                noteEl.style.color = '#22c55e'; // Vert
            }
            
            noteEl.textContent = display;
        }
        
        window.validerSaisie = async function() {
            if (!currentEleve) return alert("Aucun √©l√®ve s√©lectionn√© !");
            
            // V√©rifier qu'au moins un crit√®re est rempli
            const hasValue = Object.entries(saisie).some(([k, v]) => seanceConfig.criteres[k] && v !== null);
            if (!hasValue) return alert("Remplissez au moins un crit√®re !");
            
            const result = calculerNoteAvecComportement(saisie, seanceConfig.criteres);
            const commentaire = document.getElementById('inputCommentaire').value.trim();
            const coursDistrib = getCoursDistrib();
            
            const data = {
                date: new Date().toISOString().split('T')[0],
                heure: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                classe: seanceConfig.classe,
                module: seanceConfig.module,
                moduleTitre: seanceConfig.moduleTitre,
                competences: seanceConfig.competences,
                // Crit√®res classiques
                travail: saisie.travail,
                oral: saisie.oral,
                attention: saisie.attention,
                porteVue: saisie.porteVue,
                // NOUVEAUX CRIT√àRES COMPORTEMENT
                bavardage: saisie.bavardage || 'aucun',
                telephone: saisie.telephone || 'ok',
                // Commentaire et cours
                commentaire: commentaire || null,
                coursDistrib: coursDistrib,
                // Calcul
                criteresActifs: seanceConfig.criteres,
                points: result.points,
                maxPoints: result.maxPoints,
                noteBase: result.noteBase,      // Note avant plafond/malus
                plafond: result.plafond,        // Plafond appliqu√©
                malus: result.malus,            // Malus appliqu√©
                noteSur20: result.noteSur20,    // Note finale
                absent: false,
                createdAt: serverTimestamp(),
                createdBy: currentUser?.email || "anonyme"
            };
            
            try {
                // Enregistrer
                const docId = `${data.date}_${seanceConfig.module}_${Date.now()}`;
                await setDoc(doc(db, "resultats", currentEleve, "suivi", docId), data);
                
                // Mettre √† jour stats
                await updateStats(currentEleve, result.noteSur20, saisie);
                
                // Marquer fait (et enlever absent si c'√©tait le cas)
                const idx = elevesSeance.findIndex(e => e.code === currentEleve);
                if (idx !== -1) {
                    elevesSeance[idx].done = true;
                    elevesSeance[idx].absent = false;
                    elevesSeance[idx].note = result.noteSur20;
                }
                renderListeEleves();
                
                // Toast avec indication comportement
                let toastMsg = "‚úÖ " + currentEleve + " - " + result.noteSur20 + "/20";
                if (result.bavardage !== 'aucun') toastMsg += " (bavardage)";
                if (result.telephone !== 'ok') toastMsg += " (üì±)";
                showToast(toastMsg);
                
                // √âl√®ve suivant (non fait ET non absent)
                const next = elevesSeance.find(e => !e.done && !e.absent);
                if (next) {
                    setTimeout(() => selectionnerEleve(next.code), 300);
                }
                
                console.log("‚úÖ Enregistr√©:", data);
                
            } catch (err) {
                console.error("‚ùå Erreur:", err);
                alert("Erreur: " + err.message);
            }
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MARQUER ABSENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.marquerAbsent = async function() {
            if (!currentEleve) return alert("Aucun √©l√®ve s√©lectionn√© !");
            
            const coursDistrib = getCoursDistrib(); // R√©cup√©rer le cours distribu√© ce jour
            
            const data = {
                date: new Date().toISOString().split('T')[0],
                heure: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                classe: seanceConfig.classe,
                module: seanceConfig.module,
                moduleTitre: seanceConfig.moduleTitre,
                competences: seanceConfig.competences,
                absent: true,
                noteSur20: null,
                // Distribution cours - absent donc non re√ßu mais on note ce qui a √©t√© distribu√©
                coursDistrib: coursDistrib, // Ce qui a √©t√© distribu√© ce jour
                coursRecu: false, // L'√©l√®ve n'a pas re√ßu le cours (absent)
                createdAt: serverTimestamp(),
                createdBy: currentUser?.email || "anonyme"
            };
            
            try {
                // Enregistrer l'absence
                const docId = `${data.date}_${seanceConfig.module}_${Date.now()}`;
                await setDoc(doc(db, "resultats", currentEleve, "suivi", docId), data);
                
                // Mettre √† jour stats (incr√©menter nbAbsences)
                await updateStatsAbsence(currentEleve);
                
                // Marquer absent
                const idx = elevesSeance.findIndex(e => e.code === currentEleve);
                if (idx !== -1) {
                    elevesSeance[idx].absent = true;
                    elevesSeance[idx].done = false;
                    elevesSeance[idx].note = null;
                }
                renderListeEleves();
                
                // Toast
                showToast("üö´ " + currentEleve + " - Absent");
                
                // √âl√®ve suivant
                const next = elevesSeance.find(e => !e.done && !e.absent);
                if (next) {
                    setTimeout(() => selectionnerEleve(next.code), 300);
                }
                
                console.log("üö´ Absence enregistr√©e:", currentEleve);
                
            } catch (err) {
                console.error("‚ùå Erreur:", err);
                alert("Erreur: " + err.message);
            }
        };
        
        async function updateStatsAbsence(eleveCode) {
            try {
                const ref = doc(db, "resultats", eleveCode, "stats", "suivi");
                const snap = await getDoc(ref);
                
                if (snap.exists()) {
                    const current = snap.data();
                    await updateDoc(ref, {
                        nbAbsences: (current.nbAbsences || 0) + 1,
                        lastUpdate: serverTimestamp()
                    });
                } else {
                    await setDoc(ref, {
                        nbSeances: 0,
                        nbAbsences: 1,
                        totalNotes: 0,
                        lastUpdate: serverTimestamp()
                    });
                }
            } catch (err) {
                console.error("Erreur stats absence:", err);
            }
        }
        
        async function updateStats(eleveCode, note, saisieData) {
            try {
                const ref = doc(db, "resultats", eleveCode, "stats", "suivi");
                const snap = await getDoc(ref);
                
                let stats = snap.exists() ? snap.data() : {
                    totalNotes: 0,
                    nombreSeances: 0,
                    moyenne: 0,
                    travail: { tresbien: 0, fait: 0, partiel: 0, insuffisant: 0 },
                    oral: { 0: 0, 1: 0, 2: 0 },
                    attention: { bonne: 0, moyenne: 0, insuffisante: 0 },
                    porteVue: { ok: 0, oubli: 0 }
                };
                
                // Mise √† jour
                stats.totalNotes += note;
                stats.nombreSeances += 1;
                stats.moyenne = Math.round((stats.totalNotes / stats.nombreSeances) * 10) / 10;
                
                // Compteurs d√©taill√©s
                if (saisieData.travail && stats.travail[saisieData.travail] !== undefined) {
                    stats.travail[saisieData.travail]++;
                }
                if (saisieData.oral !== null && stats.oral[saisieData.oral] !== undefined) {
                    stats.oral[saisieData.oral]++;
                }
                if (saisieData.attention && stats.attention[saisieData.attention] !== undefined) {
                    stats.attention[saisieData.attention]++;
                }
                if (saisieData.porteVue && stats.porteVue[saisieData.porteVue] !== undefined) {
                    stats.porteVue[saisieData.porteVue]++;
                }
                
                stats.lastUpdate = serverTimestamp();
                
                await setDoc(ref, stats);
                console.log("üìä Stats:", stats);
                
            } catch (err) {
                console.error("‚ùå Stats error:", err);
            }
        }
        
        window.retourConfig = function() {
            if (elevesSeance.some(e => e.done)) {
                if (!confirm("Quitter la s√©ance ? Les donn√©es enregistr√©es sont conserv√©es.")) return;
            }
            document.getElementById('screenSaisie').classList.remove('active');
            document.getElementById('screenConfig').classList.add('active');
        };
        
        console.log("‚úÖ Suivi PSE v2 pr√™t");
    </script>
</body>
</html>

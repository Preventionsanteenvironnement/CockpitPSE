<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grille de Correction - Cockpit</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; padding: 20px; color: #1e293b; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #0f172a; margin-bottom: 30px; }
        .score-box { background: #f8fafc; border: 2px solid #e2e8f0; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .score-val { font-size: 2.5em; font-weight: 900; color: #2563eb; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #cbd5e1; padding: 12px; text-align: left; }
        th { background: #f1f5f9; font-weight: 800; }
        .rep-eleve { color: #1e293b; font-weight: 600; }
        .rep-corrige { color: #16a34a; font-size: 0.9em; margin-top: 5px; font-style: italic; }
        .status-ok { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .status-ko { background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .loading { text-align: center; padding: 50px; color: #64748b; font-size: 1.2em; }
        .error { color: #dc2626; background: #fee2e2; padding: 20px; border-radius: 8px; text-align: center; font-weight: bold; }
        .debug-info { font-size: 0.8em; color: #64748b; margin-top: 10px; font-family: monospace; word-break: break-all; }
    </style>
</head>
<body>

<div class="container">
    <div id="loader" class="loading">Chargement de la copie...</div>
    <div id="content" style="display:none;">
        <h1 id="titre-devoir">Correction</h1>
        <div class="score-box">
            <div>Note Finale</div>
            <div class="score-val"><span id="note-finale">--</span> / 20</div>
            <div id="eleve-info" style="margin-top:10px; color:#64748b;"></div>
        </div>
        <table id="grille-table">
            <thead>
                <tr><th>Question</th><th>Réponse Élève / Corrigé</th><th>Barème</th><th>Résultat</th></tr>
            </thead>
            <tbody id="grille-body"></tbody>
        </table>
    </div>
    <div id="error-msg" class="error" style="display:none;"></div>
</div>

<script>
    const rawData = localStorage.getItem("cockpit_transfert");
    
    async function init() {
        if (!rawData) { showError("Aucune donnée reçue. Passez par le Cockpit."); return; }

        try {
            const copy = JSON.parse(rawData);
            console.log("Copie chargée :", copy);

            // --- C'EST ICI LA CLÉ DE L'ARCHITECTURE ---
            // On vise le Site A (PSE) depuis le Site B (Cockpit)
            // L'URL de base est fixe : c'est votre dossier devoirs sur le site PSE
            const baseUrl = "https://preventionsanteenvironnement.github.io/PSE/devoirs/";
            
            // On construit le nom du fichier
            const fileName = copy.devoirId + "_blueprint.json";
            const blueprintUrl = baseUrl + fileName;
            
            console.log("Tentative de chargement :", blueprintUrl);
            
            const resp = await fetch(blueprintUrl);
            
            if (!resp.ok) { 
                // Si ça échoue, on affiche le lien exact pour vérifier
                throw new Error(`Fichier introuvable sur le site PSE.<br><div class="debug-info">Lien testé : <a href="${blueprintUrl}" target="_blank">${blueprintUrl}</a></div>`); 
            }
            
            const blueprint = await resp.json();
            renderCorrection(copy, blueprint);

        } catch (e) { 
            // On affiche l'erreur brute pour comprendre "String did not match" si ça revient
            showError("Erreur technique : " + e.message); 
            console.error(e);
        }
    }

    function renderCorrection(copy, blueprint) {
        document.getElementById("loader").style.display = "none";
        document.getElementById("content").style.display = "block";
        document.getElementById("titre-devoir").innerText = blueprint.titre || "Devoir";
        document.getElementById("eleve-info").innerText = `${copy.eleve?.prenom || ''} ${copy.eleve?.nom || ''} (${copy.eleve?.classe || '?'})`;

        const tbody = document.getElementById("grille-body");
        let totalScore = 0; let totalMax = 0;

        blueprint.questions.forEach(q => {
            const qid = q.qid;
            let repEleve = copy.reponses[qid];
            if(repEleve === undefined) repEleve = "Non répondu";
            
            let points = 0;
            if (q.reponseAttendue && repEleve === q.reponseAttendue) { points = q.bareme; }
            else if (repEleve !== "Non répondu" && !q.reponseAttendue) { points = 0; }

            totalScore += points; totalMax += q.bareme;

            const row = document.createElement("tr");
            row.innerHTML = `
                <td><strong>${q.label}</strong><br><small>${q.competence}</small></td>
                <td><div class="rep-eleve">${repEleve}</div>${q.reponseAttendue ? `<div class="rep-corrige">Attendu : ${q.reponseAttendue}</div>` : ''}</td>
                <td style="text-align:center;">${q.bareme}</td>
                <td style="text-align:center;"><span class="${points > 0 ? 'status-ok' : 'status-ko'}">${points}</span></td>
            `;
            tbody.appendChild(row);
        });

        let note20 = 0;
        if(totalMax > 0) { note20 = (totalScore / totalMax) * 20; }
        document.getElementById("note-finale").innerText = Math.round(note20 * 10) / 10;
    }

    function showError(msg) {
        document.getElementById("loader").style.display = "none";
        const box = document.getElementById("error-msg");
        box.style.display = "block";
        box.innerHTML = msg; // innerHTML pour autoriser les liens
    }

    init();
</script>
</body>
</html>

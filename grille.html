<!DOCTYPE html>
<html lang="fr"><head>
  <meta charset="UTF-8">
  <title>√âvaluation PSE - Mod√®le Source</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* --- STYLE GENERAL --- */
    * { box-sizing: border-box; }
    body { margin: 0; padding: 1rem; font-family: 'Segoe UI', system-ui, sans-serif; background: #f3f4f6; color: #1f2937; padding-bottom: 250px; }
    
    .card { background: #fff; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 1.5rem; border: 1px solid #e5e7eb; }
    
    /* INPUTS & TEXTAREAS */
    label { font-weight: 600; color: #374151; margin-right: 5px; white-space: nowrap; }
    input, select, textarea { font-size: 0.9rem; border: 1px solid #d1d5db; border-radius: 4px; padding: 6px 8px; font-family: inherit; background-color: #fff; }
    input:focus, select:focus, textarea:focus { outline: 2px solid #2563eb; border-color: #2563eb; }
    textarea { width: 100%; resize: none; overflow: hidden; min-height: 30px; line-height: 1.3; display: block; }
    
    /* EN-TETES EDITABLES */
    .th-input {
        width: 100%; text-align: center; font-weight: 700; color: #334155;
        border: none; background: transparent; padding: 4px; margin: 0;
        resize: none; overflow: hidden; font-size: 0.85rem;
        text-transform: uppercase; letter-spacing: 0.05em;
        white-space: pre-wrap;
    }
    .th-input:focus { outline: none; background: #e2e8f0; border-radius: 4px; }

    /* TITRES EDITABLES */
    .title-main {
        width: 100%; text-align: center; font-size: 1.6rem; font-weight: 800;
        color: #1e293b; border: none; background: transparent;
        margin-bottom: 1rem; resize: none; overflow: hidden; min-height: 40px;
    }
    .title-section {
        width: 100%; font-size: 1.2rem; font-weight: 700;
        color: #334155; border: none; border-bottom: 2px solid #e2e8f0;
        background: transparent; padding: 5px 0; margin-bottom: 15px; margin-top: 10px;
        resize: none; overflow: hidden; min-height: 35px;
    }
    .title-main:focus, .title-section:focus { outline: none; border-bottom-color: #2563eb; background: #f8fafc; }

    /* NOTE INPUT (EN NOIR PAR DEFAUT, MAIS CHANGEANT) */
    .bareme-total-input { width: 60px; font-weight: 800; color: #000; border: none; border-bottom: 2px solid #000; text-align: center; background: transparent; font-size: 1.3rem; }

    /* TABLEAU */
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; background: #fff; }
    th, td { border: 1px solid #cbd5e1; padding: 6px; text-align: center; vertical-align: top; }
    th { background: #f8fafc; vertical-align: middle; }
    .left { text-align: left; }
    
    /* PERSONNALISATION POLICE TABLEAU */
    #table-questions, 
    #table-questions input, 
    #table-questions select, 
    #table-questions textarea,
    #table-questions .corrige-div {
        font-family: 'Segoe UI', system-ui, sans-serif;
        font-size: 14px; 
    }
    
    /* STYLE DES DIVS RICHES (Word-like) */
    .corrige-div {
        width: 100%;
        min-height: 30px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 6px 8px;
        background-color: #fff;
        text-align: left;
        white-space: pre-wrap;
        cursor: text;
    }
    .corrige-div:focus {
        outline: 2px solid #2563eb;
        border-color: #2563eb;
        background-color: #feffff;
    }

    /* LIGNE DES OUTILS (RESET) */
    .tools-row th { background: #f1f5f9; padding: 2px; height: 25px; }
    .btn-col-clear {
        background: none; border: none; cursor: pointer; color: #94a3b8; font-size: 0.8rem;
        width: 100%; height: 100%; display: block; border-radius: 4px;
    }
    .btn-col-clear:hover { background: #fee2e2; color: #dc2626; }

    /* NOMS COMPETENCES EDITABLES (BILAN) */
    .comp-name-input {
        text-align: left; font-weight: 600; border: none; background: transparent; padding: 2px; width: 100%;
        white-space: pre-wrap;
        overflow-wrap: anywhere;
    }
    .comp-name-input:focus { background: #f1f5f9; }

    /* COULEURS LIGNES */
    tr.comp-C1 td, tr[data-comp="C1"] td { background-color: #ffffff; }
    tr.comp-C2 td, tr[data-comp="C2"] td { background-color: #f0f9ff; }
    tr.comp-C3 td, tr[data-comp="C3"] td { background-color: #fdf2f8; }
    tr.comp-C4 td, tr[data-comp="C4"] td { background-color: #f0fdf4; }
    tr.comp-C5 td, tr[data-comp="C5"] td { background-color: #fffbeb; }
    tr.comp-C6 td, tr[data-comp="C6"] td { background-color: #f5f3ff; }

    /* BOUTONS NIVEAU */
    .btn-group-level { display: flex; gap: 4px; width: 100%; }
    .btn-level { border: 1px solid #cbd5e1; background: #fff; font-size: 0.75rem; padding: 6px 0; flex: 1; cursor: pointer; border-radius: 4px; font-weight: 600; color: #64748b; transition: all 0.1s; }
    .btn-level:hover { background: #f1f5f9; }
    .btn-level.active[data-val="NT"] { background: #94a3b8; color: white; border-color: #64748b; }
    .btn-level.active[data-val="I"] { background: #ef4444; color: white; border-color: #dc2626; }
    .btn-level.active[data-val="A"] { background: #eab308; color: white; border-color: #ca8a04; }
    .btn-level.active[data-val="M"] { background: #22c55e; color: white; border-color: #16a34a; }

    /* SELECT METHODE C2 */
    .comp-wrapper { display: flex; flex-direction: column; gap: 4px; }
    .method-select { font-size: 0.7rem; color: #2563eb; background-color: #eff6ff; display: none; margin-top: 2px; }
    .comp-wrapper.show-method .method-select { display: block; }

    /* CONTROLES */
    .controls { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; align-items: center; }
    button { border: none; border-radius: 6px; padding: 0.6rem 1rem; cursor: pointer; color: #fff; font-size: 0.9rem; font-weight: 500; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    
    .btn-add { background: #2563eb; } 
    .btn-del { background: #dc2626; } 
    .btn-clear { background: #4b5563; } 
    
    /* Nouveaux boutons JSON */
    .btn-json-export { background: #d97706; } /* Orange */
    .btn-json-import { background: #0891b2; } /* Cyan */
    
    
    .btn-json-subject { background: #16a34a; } /* Vert */
    .btn-print { background: #4f46e5; }

    /* AIDE FLOTTANTE */
    #criteria-helper { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; color: #f8fafc; padding: 15px; z-index: 2000; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); font-size: 0.95rem; text-align: center; border-top: 4px solid #3b82f6; transform: translateY(120%); transition: transform 0.3s; }
    #criteria-helper.visible { transform: translateY(0); }
    .criteria-title { display: block; font-size: 0.8rem; color: #93c5fd; text-transform: uppercase; margin-bottom: 4px; font-weight: bold; }

    /* BARRES PROGRESSION */
    .progress-cell { vertical-align: middle; padding: 0 8px; width: 120px; }
    .progress { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; width: 100%; margin-bottom: 4px; }
    .progress-bar { height: 100%; background: #22c55e; width: 0%; transition: width 0.5s ease; }
    .progress-text { font-size: 0.7rem; color: #64748b; font-weight: 700; text-align: right; }

    /* BANQUE COMMENTAIRES */
    .bank-card { border-top: 4px solid #8b5cf6; }
    .bank-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .bank-tag { background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 20px; padding: 4px 12px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .bank-tag:hover { background: #ede9fe; border-color: #8b5cf6; color: #5b21b6; transform: translateY(-1px); }
    .bank-del { width: 18px; height: 18px; border-radius: 50%; background: #cbd5e1; color: white; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; }
    .bank-del:hover { background: #ef4444; }

    .bank-restore { width: 18px; height: 18px; border-radius: 50%; background: #94a3b8; color: white; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; cursor:pointer; }
    .bank-restore:hover { background: #22c55e; }
    .bank-input-group { display: flex; gap: 8px; }

    /* LEGENDE POUR IMPRESSION */
    #print-legend { display: none; }

    /* --- RESPONSIVE --- */
    @media (max-width: 800px) {
        table { font-size: 0.75rem; }
        th, td { padding: 4px 2px; }
        #table-questions { display: block; overflow-x: auto; white-space: nowrap; }
        #table-questions thead th:first-child, #table-questions thead th:first-child,
        #table-questions tbody td:first-child { 
            position: sticky; left: 0; z-index: 20; border-right: 2px solid #ccc; 
        }
        /* Sticky Backgrounds */
        tr.comp-C1 td:first-child { background: #fff; } tr.comp-C2 td:first-child { background: #f0f9ff; }
        tr.comp-C3 td:first-child { background: #fdf2f8; } tr.comp-C4 td:first-child { background: #f0fdf4; }
        tr.comp-C5 td:first-child { background: #fffbeb; } tr.comp-C6 td:first-child { background: #f5f3ff; }
    }

    /* --- IMPRESSION (CLEAN) --- */
    @media print {
        @page { size: A4; margin: 12mm; }
        body { background: white; padding: 0; font-size: 11pt; font-family: serif; color: black; }
        
        /* Cacher interface */
        .controls, .bank-card, #criteria-helper, .method-select, .btn-group-level, .tools-row { display: none !important; }
        .card { box-shadow: none; border: none; padding: 0; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid; }
        
        .title-main { font-size: 18pt; font-weight: bold; text-align: center; margin-bottom: 20px; border: none; height: auto !important; }
        .title-section { font-size: 14pt; font-weight: bold; background: #eee; padding: 5px; margin-top: 20px; border: 1px solid #000; height: auto !important; }
        
        /* Headers en texte */
        .th-input { font-weight: bold; text-align: center; border: none; background: transparent; padding: 0; height: auto !important; overflow: visible; font-size: 10pt; }

        input, select, textarea { 
            border: none; background: transparent; padding: 0; margin: 0; 
            font-weight: bold; font-family: inherit; width: auto; 
            -webkit-appearance: none; appearance: none; 
        }
        
        textarea.corrige-text, textarea#commentGlobal, .corrige-div { display: none; }
        
        /* Note en noir (mais garde la couleur visuelle si possible, sinon noir) */
        .bareme-total-input { color: #000 !important; border-bottom: none !important; text-align: left; }
        #note-header { color: #000; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        table { width: 100%; border: 1px solid #000; border-collapse: collapse; page-break-inside: auto; }
        /* AJOUT IMPRESSION : Emp√™cher la coupure des lignes */
        tr { page-break-inside: avoid; break-inside: avoid; }
        
        th, td { border: 1px solid #000; padding: 4px; font-size: 10pt; vertical-align: middle !important; }
        th { background: #eee !important; color: #000; font-weight: bold; }
        
        .progress-cell { vertical-align: middle !important; }
        .progress { margin-top: 4px; margin-bottom: 4px; }
        
        tr.comp-C1 td { background-color: #fff !important; }
        tr.comp-C2 td { background-color: #f0f9ff !important; }
        tr.comp-C3 td { background-color: #fdf2f8 !important; }
        tr.comp-C4 td { background-color: #f0fdf4 !important; }
        tr.comp-C5 td { background-color: #fffbeb !important; }
        tr.comp-C6 td { background-color: #f5f3ff !important; }

        /* Cacher les lignes de bilan non utilis√©es */
        tr.hidden-row { display: none !important; }

        #print-legend { display: block !important; page-break-before: auto; }
        #print-legend table { font-size: 9pt; }
        
        /* Affichage sp√©cifique pour impression Rich Text */
        .print-replace-rich { 
            display: block !important; 
            font-family: inherit; 
            text-align: left;
            border: 1px solid #000;
            padding: 4px;
        }
    }
  
:root{
  --resp-font-size: 14px;
  --resp-color: #111827;
  --resp-line-height: 1.35;
}
/* Apply global typography to response / expected answer areas */
.expected[contenteditable="true"],
#commentaireGlobal,
#commentaireEnseignant,
.comment-bank-text {
  font-size: var(--resp-font-size) !important;
  color: var(--resp-color) !important;
  line-height: var(--resp-line-height) !important;
}


select.mini{
  padding:6px 8px;
  border:1px solid #d1d5db;
  border-radius:10px;
  font-size:12px;
  background:#fff;
}


/* --- Rem√©diation + QR --- */
#remediationCard .grid-2{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap:16px;
}
#remediationCard .field{ margin-bottom:10px; }
#remediationCard input[type="text"]{ width:100%; }
.qr-box{
  border:1px dashed #d1d5db;
  border-radius:14px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:center;
  justify-content:flex-start;
}
.qr-title{
  font-weight:700;
}
.qr-wrap{
  width:170px;
  max-width:100%;
}
.qr-svg{
  width:100%;
  height:auto;
  display:block;
}
.qr-url{
  width:100%;
  border-top:1px solid #e5e7eb;
  padding-top:8px;
  font-size:12px;
}
.qr-url-label{ font-weight:700; margin-bottom:2px; }
.qr-url-value{
  word-break:break-all;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}
@media (max-width: 900px){
  #remediationCard .grid-2{ grid-template-columns: 1fr; }
  .qr-wrap{ width:200px; margin:0 auto; }
}
@media print{
  .print-hide{ display:none !important; }
  #remediationCard{ break-inside:avoid; page-break-inside:avoid; }
  .qr-box{ border:1px solid #999 !important; }
}


/* Multi-line fields in header / remediation should look like inputs */
#nom, #prenomEleve, #classe, #bank-input, #rem-conseil{
  resize: none;
  overflow: hidden;
}
#nom, #prenomEleve{
  font-weight: bold;
  min-width: 150px;
}
#classe{
  min-width: 80px;
}


/* v29 : alignement identit√© (Nom/Pr√©nom/Classe) + impression inline */
.id-field{display:flex; gap:8px; align-items:flex-start;}
.id-field label{margin:0;}
/* override global textarea display:block */
#nom, #prenomEleve, #classe{
  display:inline-block !important;
  width: 190px !important;
  max-width: 260px;
  vertical-align: top;
  line-height: 1.25;
}
#classe{ width: 230px !important; }

@media print{
  .id-field{display:inline-flex; gap:6px; align-items:baseline;}
  #nom, #prenomEleve, #classe{
    display:inline-block !important;
    width:auto !important;
    max-width: 260px !important;
    white-space: pre-wrap !important;
  }
}

/* v31 : champs identit√© + rem√©diation vraiment auto-hauteur */
#nom, #prenomEleve, #classe, #rem-conseil{
  box-sizing: border-box;
  height: auto;
  min-height: 36px;
  padding: 6px 10px;
  line-height: 1.25;
}
#rem-conseil{
  width: 100% !important;
  display: block !important;
}


  /* === AJOUT (2025-12-30) : Colonnes Question + R√©ponse √©l√®ve === */
  th.col-question-texte, td.col-question-texte { min-width: 220px; background:#f8fafc; }
  th.col-reponse-eleve, td.col-reponse-eleve { min-width: 260px; background:#f1f5f9; }

  .question-texte-div{
    min-height: 38px;
    padding: 6px 8px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: #fff;
    white-space: pre-wrap;
    outline: none;
  }

  .reponse-eleve-textarea{
    width: 100%;
    min-height: 38px;
    padding: 6px 8px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: #fff;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.35;
    resize: none;
    overflow: hidden;
  }

  @media print {
    th.col-question-texte, td.col-question-texte,
    th.col-reponse-eleve, td.col-reponse-eleve { background: transparent !important; }
    .question-texte-div, .reponse-eleve-textarea { border: 1px solid #ddd !important; }
  }

</style>

<style>
  /* Rem√©diation bank: extra color */
  .bank-item.comp-REV{ background:#ecfeff; }
  @media print{
    #rembankCard{ display:none !important; }
  }
</style>

</head>
<body>

<div id="respStyleTools" class="tools print-hide" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;">
  <div class="pill" style="display:flex; gap:8px; align-items:center;">
    <strong style="font-size:12px; opacity:.8;">Style zones de r√©ponse</strong>
    <label style="display:flex; gap:6px; align-items:center; font-size:12px;">
      Taille
      <select id="respFontSize" class="mini">
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14" selected>14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="18">18</option>
        <option value="20">20</option>
      </select>
      px
    </label>
    <label style="display:flex; gap:6px; align-items:center; font-size:12px;">
      Couleur
      <input id="respColor" type="color" value="#111827" style="width:34px; height:22px; padding:0; border:1px solid #d1d5db; border-radius:6px;">
    </label>
    <label style="display:flex; gap:6px; align-items:center; font-size:12px;">
      Interligne
      <select id="respLineHeight" class="mini">
        <option value="1.2">1.2</option>
        <option value="1.35" selected>1.35</option>
        <option value="1.5">1.5</option>
        <option value="1.7">1.7</option>
      </select>
    </label>
    <button id="respStyleReset" class="btn small" type="button">R√©initialiser</button>
  </div>
</div>


<div id="criteria-helper" class=""><div id="criteria-text"></div></div>

<div class="card">
  <textarea id="titreEval" class="title-main auto-save" data-key="titreEval" rows="1" placeholder="Titre de l'√©valuation">√âvaluation PSE</textarea>
  
  <div style="display:flex; flex-wrap:wrap; gap:1.5rem; align-items: center;">
    <div class="id-field"><label>Nom :</label> <textarea id="nom" class="auto-save auto-resize" style="font-weight:bold; min-width:150px;" data-key="nom" rows="1"></textarea></div>
    <div class="id-field"><label>Pr√©nom :</label> <textarea id="prenomEleve" class="auto-save auto-resize" style="font-weight:bold; min-width:150px;" data-key="prenomEleve" rows="1"></textarea></div>
    <div class="id-field"><label>Classe :</label> <textarea id="classe" class="auto-save auto-resize" style="width:80px;" data-key="classe" rows="1"></textarea></div>
    <div><label>Date :</label> <input type="date" id="dateEval" class="auto-save" data-key="dateEval"></div>
    <div style="margin-left:auto; font-size:1.2rem;">
        <label style="color:#000;">NOTE :</label> 
        <span id="note-header" style="font-weight:800; color:#000;">0</span> / 
        <input type="number" id="noteMaxInput" class="bareme-total-input auto-save" value="20" data-key="noteMaxInput">
    </div>
  </div>
</div>

<div class="card">
  <textarea class="title-section auto-save" data-key="title_grille" rows="1">Grille d‚Äô√©valuation d√©taill√©e</textarea>
  
  <table id="table-questions">
    <thead>
      <tr style="color:#1f2937; text-transform:none;">
        <th class="col-question-texte" style="background:#e5e7eb; font-weight:800;">Question (√©nonc√©)</th>
        <th class="col-reponse-eleve" style="background:#e5e7eb; font-weight:800;">R√©ponse de l‚Äô√©l√®ve</th>
        <th style="width:80px; background:#e5e7eb; font-weight:800;">Questions</th>
        <th style="width:130px; background:#e5e7eb; font-weight:800;">Comp√©tences</th>
        <th style="width:140px; background:#e5e7eb; font-weight:800;">
            <div>Niveau</div>
            <div style="font-size:0.7em; font-weight:normal; margin-top:2px; color:#4b5563;"></div>
        </th>
        <th style="width:90px; background:#e5e7eb; font-weight:800; line-height:1.2;">
            Bar√®me
        </th> 
        <th style="width:90px; background:#e5e7eb; font-weight:800; line-height:1.2;">
            Note
        </th> 
        <th style="background:#e5e7eb; font-weight:800;">√âl√©ments de r√©ponse attendus </th>
      </tr>
      <tr class="tools-row">
        <th></th>
        <th></th>
        <th><button class="btn-col-clear" onclick="clearColumn('qnum-select')" title="Vider">üóë</button></th>
        <th><button class="btn-col-clear" onclick="clearColumn('comp-select')" title="Vider">üóë</button></th>
        <th><button class="btn-col-clear" onclick="clearColumn('level-select')" title="Vider">üóë</button></th>
        <th><button class="btn-col-clear" onclick="clearColumn('bareme-input')" title="Vider">üóë</button></th>
        <th><button class="btn-col-clear" onclick="clearColumn('points-input')" title="Vider">üóë</button></th>
        <th><button class="btn-col-clear" onclick="clearColumn('corrige-div')" title="Vider">üóë</button></th>
      </tr>
    </thead>
    <tbody id="tbody-questions"></tbody>
    <tfoot>
        <tr style="background:#f8fafc; font-weight:bold;">
            <td></td>
            <td></td>
            <td id="nbQuestionsDisplay">0</td>
            <td colspan="2" style="text-align:right;">TOTAL</td>
            <td id="sumBareme">0</td>
            <td id="sumPoints" style="color:#000;">0</td>
            <td></td>
        </tr>
    </tfoot>
  </table>

  <div style="font-style: italic; color: #4b5563; font-size: 0.85rem; margin-top: 8px; margin-left: 4px;">
    L√©gende : NT = Non Trait√©, I = Insuffisant, A = Acquis, M = Ma√Ætris√©
  </div>
  
  <div class="controls">
    <button type="button" class="btn-add" id="btn-add-row">+ Question</button>
    <button type="button" class="btn-del" id="btn-del-row">- Suppr.</button>
    
    <div style="width:1px; height:25px; background:#ccc; margin:0 10px;"></div>
    <button type="button" onclick="telechargerPageRemplie()" style="background:#10b981;">üíæ Enregistrer mon travail</button>

    <div style="width:1px; height:25px; background:#ccc; margin:0 10px;"></div> <button type="button" class="btn-json-export" id="btn-export-json">üíæ Sauvegarder Projet (JSON)</button>
    <button type="button" class="btn-json-import" id="btn-import-json">üìÇ Ouvrir Projet (JSON)</button>
    <button type="button" class="btn-json-subject" id="btn-import-subject">üß© Importer Sujet (JSON)</button>
    <label id="plain-paste-wrap" style="display:flex;align-items:center;gap:6px;background:#f3f4f6;border:1px solid #e5e7eb;padding:6px 10px;border-radius:999px;font-size:.85rem;color:#374151;user-select:none;">
      <input type="checkbox" id="plain-paste-toggle" checked style="transform:translateY(1px);">
      Coller sans mise en forme
    </label>

    <input type="file" id="file-input" accept=".json" style="display:none">
    <input type="file" id="file-input-subject" accept=".json" style="display:none">
    
    <div style="width:1px; height:25px; background:#ccc; margin:0 10px;"></div> <button type="button" class="btn-print" id="btn-print">üñ®Ô∏è Imprimer PDF</button>
    <button type="button" class="btn-clear" id="btn-clear" style="margin-left:auto;">Tout Effacer</button>
  </div>
</div>

<div class="card">
  <textarea class="title-section auto-save" data-key="title_bilan" rows="1">Bilan des comp√©tences</textarea>

  <table>
    <thead><tr><th>Comp√©tences</th><th>Questions</th><th>Bar√®me</th><th>NT</th><th>I</th><th>A</th><th>M</th><th>Points

    </th><th>%</th></tr></thead>
    <tbody id="tbody-resume">
      <tr id="row-C1" data-comp="C1"><td><textarea class="auto-save comp-name-input" rows="1" data-key="compName_C1">C1 ‚Äì Traiter l'information</textarea></td><td id="C1_q">‚Äì</td><td id="C1_b">0</td><td id="C1_NT">0</td><td id="C1_I">0</td><td id="C1_A">0</td><td id="C1_M">0</td><td><input type="number" id="C1_pts" class="comp-points-input auto-save" readonly></td><td class="progress-cell"><div class="progress"><div class="progress-bar" id="C1_bar"></div></div><div class="progress-text" id="C1_pct">0%</div></td></tr>
      <tr id="row-C2" data-comp="C2"><td><textarea class="auto-save comp-name-input" rows="1" data-key="compName_C2">C2 ‚Äì Appliquer une d√©marche d‚Äôanalyse dans une situation donn√©e</textarea></td><td id="C2_q">‚Äì</td><td id="C2_b">0</td><td id="C2_NT">0</td><td id="C2_I">0</td><td id="C2_A">0</td><td id="C2_M">0</td><td><input type="number" id="C2_pts" class="comp-points-input auto-save" readonly></td><td class="progress-cell"><div class="progress"><div class="progress-bar" id="C2_bar"></div></div><div class="progress-text" id="C2_pct">0%</div></td></tr>
      <tr id="row-C3" data-comp="C3"><td><textarea class="auto-save comp-name-input" rows="1" data-key="compName_C3">C3 ‚Äì Expliquer un ph√©nom√®ne physiologique, un enjeu environnemental, une disposition r√©glementaire, en lien avec une mesure de pr√©vention</textarea></td><td id="C3_q">‚Äì</td><td id="C3_b">0</td><td id="C3_NT">0</td><td id="C3_I">0</td><td id="C3_A">0</td><td id="C3_M">0</td><td><input type="number" id="C3_pts" class="comp-points-input auto-save" readonly></td><td class="progress-cell"><div class="progress"><div class="progress-bar" id="C3_bar"></div></div><div class="progress-text" id="C3_pct">0%</div></td></tr>
      <tr id="row-C4" data-comp="C4"><td><textarea class="auto-save comp-name-input" rows="1" data-key="compName_C4">C4 ‚Äì Proposer une solution pour r√©soudre un probl√®me</textarea></td><td id="C4_q">‚Äì</td><td id="C4_b">0</td><td id="C4_NT">0</td><td id="C4_I">0</td><td id="C4_A">0</td><td id="C4_M">0</td><td><input type="number" id="C4_pts" class="comp-points-input auto-save" readonly></td><td class="progress-cell"><div class="progress"><div class="progress-bar" id="C4_bar"></div></div><div class="progress-text" id="C4_pct">0%</div></td></tr>
      <tr id="row-C5" data-comp="C5"><td><textarea class="auto-save comp-name-input" rows="1" data-key="compName_C5">C5 ‚Äì Argumenter un choix</textarea></td><td id="C5_q">‚Äì</td><td id="C5_b">0</td><td id="C5_NT">0</td><td id="C5_I">0</td><td id="C5_A">0</td><td id="C5_M">0</td><td><input type="number" id="C5_pts" class="comp-points-input auto-save" readonly></td><td class="progress-cell"><div class="progress"><div class="progress-bar" id="C5_bar"></div></div><div class="progress-text" id="C5_pct">0%</div></td></tr>
      <tr id="row-C6" data-comp="C6"><td><textarea class="auto-save comp-name-input" rows="1" data-key="compName_C6">C6 ‚Äì Communication √† l‚Äô√©crit et √† l‚Äôoral avec une syntaxe claire et adapt√©e</textarea></td><td id="C6_q">‚Äì</td><td id="C6_b">0</td><td id="C6_NT">0</td><td id="C6_I">0</td><td id="C6_A">0</td><td id="C6_M">0</td><td><input type="number" id="C6_pts" class="comp-points-input auto-save" readonly></td><td class="progress-cell"><div class="progress"><div class="progress-bar" id="C6_bar"></div></div><div class="progress-text" id="C6_pct">0%</div></td></tr>
    </tbody>
  </table>
  <div style="margin-top:10px; font-size:1rem; text-align:right;">
      Note finale : <strong><span id="note20_resume">0 / 20</span></strong>
  </div>
</div>

<div class="card">
  <textarea class="title-section auto-save" data-key="title_commentaire" rows="1">Commentaire</textarea>
  <textarea id="commentGlobal" class="auto-save" placeholder="Appr√©ciation g√©n√©rale de la copie..." data-key="commentGlobal"></textarea>
</div>

<div id="print-legend" class="card">
    <h2>L√©gende des crit√®res d'√©valuation</h2>
    <table>
        <tbody><tr><th width="15%">Comp√©tence</th><th width="28%">Insuffisant (I)</th><th width="28%">Acceptable (A)</th><th width="29%">Ma√Ætris√© (M)</th></tr>
        <tr id="legend-C1" style="display: none;"><td><strong>C1</strong> Traiter l'info</td><td>Moins de 50% des infos relev√©es.</td><td>Majorit√© des infos (&gt;50%) relev√©es.</td><td>Toutes infos relev√©es et synth√©tis√©es.</td></tr>
        <tr id="legend-C2"><td><strong>C2</strong> Analyse</td><td>Probl√®me mal identifi√©, peu d'√©l√©ments.</td><td>Probl√®me identifi√©, majorit√© √©l√©ments li√©s.</td><td>Analyse pr√©cise, liens complets.</td></tr>
        <tr id="legend-C3"><td><strong>C3</strong> Expliquer</td><td>Explication partielle, lien flou.</td><td>Explication correcte, lien √©tabli.</td><td>Explication compl√®te, vocabulaire scientifique.</td></tr>
        <tr id="legend-C4"><td><strong>C4</strong> Solution</td><td>Solution inadapt√©e ou hors-sujet.</td><td>Solution adapt√©e au probl√®me.</td><td>Solution r√©aliste, compl√®te et hi√©rarchis√©e.</td></tr>
        <tr id="legend-C5"><td><strong>C5</strong> Argumenter</td><td>Argument non pertinent.</td><td>Argument pertinent en lien avec le choix.</td><td>Arguments multiples, preuves, conclusion.</td></tr>
        <tr id="legend-C6"><td><strong>C6</strong> Communiquer</td><td>Syntaxe fragile, vocabulaire pauvre.</td><td>Syntaxe correcte, vocabulaire adapt√©.</td><td>Fluide, pr√©cis, vocabulaire professionnel.</td></tr>
    </tbody></table>
</div>

<style id="bank-plus-styles">
  .bank-card .bank-input-group{ gap:.5rem; align-items:flex-start; flex-wrap:wrap; }
  .bank-comp-select{
    min-width: 110px;
    height: 44px;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    padding: 0 .6rem;
    font-weight: 700;
    background: #fff;
  }
  .bank-plus-toolbar{
    display:flex; gap:.75rem; align-items:center; justify-content:space-between;
    flex-wrap:wrap;
    margin:.75rem 0 .5rem;
  }
  .bank-filters{ display:flex; gap:.4rem; flex-wrap:wrap; align-items:center; }
  .bank-filter{
    border:1px solid #d1d5db;
    background:#fff;
    border-radius:999px;
    padding:.35rem .65rem;
    font-weight:700;
    cursor:pointer;
    user-select:none;
  }
  .bank-filter.active{ outline:2px solid rgba(59,130,246,.25); }
  .bank-filter[data-comp="C1"]{ background:#fff; }
  .bank-filter[data-comp="C2"]{ background:#f0f9ff; }
  .bank-filter[data-comp="C3"]{ background:#fdf2f8; }
  .bank-filter[data-comp="C4"]{ background:#f0fdf4; }
  .bank-filter[data-comp="C5"]{ background:#fffbeb; }
  .bank-filter[data-comp="C6"]{ background:#f5f3ff; }
  .bank-filter[data-comp="GEN"]{ background:#f8fafc; }

  .bank-search{
    flex: 1 1 260px;
    min-width: 220px;
    height: 44px;
    border: 1px solid #d1d5db;
    border-radius: 12px;
    padding: 0 .8rem;
    font-size: 15px;
    background: #fff;
  }

  .bank-plus-container{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: .6rem;
    margin-top:.5rem;
  }

  .bank-item{
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:.65rem .75rem;
    box-shadow: 0 2px 8px rgba(0,0,0,.04);
    cursor:pointer;
    position:relative;
    display:flex;
    gap:.65rem;
    align-items:flex-start;
  }
  .bank-item:hover{ box-shadow: 0 6px 16px rgba(0,0,0,.08); }
  .bank-item .bank-pill{
    font-weight:800;
    font-size:12px;
    border-radius:999px;
    padding:.15rem .45rem;
    border:1px solid rgba(0,0,0,.08);
    white-space:nowrap;
    height: fit-content;
  }
  .bank-item .bank-text{
    flex:1;
    font-size: 14px;
    line-height:1.35;
    white-space: pre-wrap;
  }
  .bank-item .bank-actions{
    display:flex;
    gap:.35rem;
    align-items:center;
    margin-left:auto;
  }
  .bank-mini{
    border:1px solid #d1d5db;
    background:#fff;
    border-radius:10px;
    padding:.1rem .45rem;
    font-weight:900;
    cursor:pointer;
  }
  .bank-mini.danger{ border-color: rgba(239,68,68,.35); }
  .bank-mini.success{ border-color: rgba(34,197,94,.45); color:#15803d; background: rgba(34,197,94,.08); }
  .bank-mini:active{ transform: translateY(1px); }

  .bank-item.comp-C1{ background:#fff; }
  .bank-item.comp-C2{ background:#f0f9ff; }
  .bank-item.comp-C3{ background:#fdf2f8; }
  .bank-item.comp-C4{ background:#f0fdf4; }
  .bank-item.comp-C5{ background:#fffbeb; }
  .bank-item.comp-C6{ background:#f5f3ff; }
  .bank-item.comp-GEN{ background:#f8fafc; }

  details.bank-raw{ margin-top:.75rem; }
  details.bank-raw > summary{ cursor:pointer; font-weight:800; }

  .bank-hint{
    margin: .25rem 0 .5rem;
    font-size: 14px;
    color: #475569;
    font-weight: 600;
  }

  .bank-filter{
    border-width: 2px;
    color:#111827;
  }
  .bank-filter.active{
    outline: 3px solid rgba(59,130,246,.35);
    box-shadow: 0 0 0 2px rgba(59,130,246,.08);
  }
  .bank-filter[data-comp="C1"]{ border-color:#cbd5e1; }
  .bank-filter[data-comp="C2"]{ border-color:#93c5fd; }
  .bank-filter[data-comp="C3"]{ border-color:#f9a8d4; }
  .bank-filter[data-comp="C4"]{ border-color:#86efac; }
  .bank-filter[data-comp="C5"]{ border-color:#fcd34d; }
  .bank-filter[data-comp="C6"]{ border-color:#c4b5fd; }
  .bank-filter[data-comp="GEN"]{ border-color:#94a3b8; }

  .bank-pill{
    border: 2px solid rgba(148,163,184,.55);
    background: rgba(255,255,255,.85);
  }

  /* Rem√©diation : pastilles visibles */
  #rembank-filters .bank-pill{
    padding: .45rem .85rem;
    border-radius: 999px;
    font-weight: 800;
    font-size: 14px;
    color: #111827;
  }
  #rembank-filters .bank-pill.active{
    box-shadow: 0 0 0 4px rgba(99,102,241,.18);
  }
  #rembank-filters .bank-pill[data-filter="C1"]{ border-color:#93c5fd; }
  #rembank-filters .bank-pill[data-filter="C2"]{ border-color:#93c5fd; }
  #rembank-filters .bank-pill[data-filter="C3"]{ border-color:#f9a8d4; }
  #rembank-filters .bank-pill[data-filter="C4"]{ border-color:#86efac; }
  #rembank-filters .bank-pill[data-filter="C5"]{ border-color:#fde047; }
  #rembank-filters .bank-pill[data-filter="C6"]{ border-color:#c4b5fd; }
  #rembank-filters .bank-pill[data-filter="REV"]{ border-color:#94a3b8; }

  .bank-raw-actions{
    margin:.5rem 0 .25rem;
    display:flex;
    justify-content:flex-end;
  }

  .bank-undo{
    margin-top:.75rem;
    display:flex;
    gap:.6rem;
    align-items:center;
    justify-content:flex-end;
    border:1px solid #d1d5db;
    border-radius: 12px;
    padding: .5rem .75rem;
    background:#fff;
  }
  .bank-undo-btn{
    border: 1px solid #d1d5db;
    border-radius: 10px;
    padding: .25rem .6rem;
    font-weight: 800;
    background: #fff;
    cursor: pointer;
  }
  .bank-undo-btn:active{ transform: translateY(1px); }

</style>

<div class="card bank-card">
    <h2>Banque de commentaires</h2>

    <div class="bank-hint">Clique sur une carte pour l‚Äôajouter au champ Commentaire.</div>

    <div class="bank-input-group">
        <select id="bank-comp" class="bank-comp-select" title="Comp√©tence">
            <option value="AUTO">Auto</option>
            <option value="C1">C1</option>
            <option value="C2">C2</option>
            <option value="C3">C3</option>
            <option value="C4">C4</option>
            <option value="C5">C5</option>
            <option value="C6">C6</option>
            <option value="GEN">G√©n√©ral</option>
        </select>

        <textarea id="bank-input" placeholder="Ajouter un commentaire..." style="flex:1;" class="auto-resize" rows="2"></textarea>

        <button class="btn-add" id="btn-bank-add">Ajouter √† la banque</button>
        <button class="btn-add" id="btn-bank-update" style="display:none;">Mettre √† jour</button>
        <button class="btn-danger-light" id="btn-bank-cancel" style="display:none;">Annuler</button>

        <button class="btn-danger-light" id="btn-bank-clear" type="button">Vider le champ</button>
    </div>

    <div class="bank-plus-toolbar">
        <div class="bank-filters" id="bank-filters">
            <button class="bank-filter active" data-comp="ALL">Tous</button>
            <button class="bank-filter" data-comp="C1">C1</button>
            <button class="bank-filter" data-comp="C2">C2</button>
            <button class="bank-filter" data-comp="C3">C3</button>
            <button class="bank-filter" data-comp="C4">C4</button>
            <button class="bank-filter" data-comp="C5">C5</button>
            <button class="bank-filter" data-comp="C6">C6</button>
            <button class="bank-filter" data-comp="GEN">G√©n√©ral</button>
        </div>

        <input id="bank-search" class="bank-search" placeholder="Recherche dans la banque..." />
    </div>

    <div id="bank-plus-container" class="bank-plus-container"></div>

    <details class="bank-raw" id="bank-raw-details">
        <summary>Voir la liste brute</summary>
        <div class="bank-raw-actions"><button type="button" class="btn-danger-light" id="btn-bank-reset">R√©initialiser la banque</button></div>
        <div id="bank-container" class="bank-container"></div>
    </details>

    <details class="bank-raw" id="bank-trash-details">
        <summary>Voir la corbeille</summary>
        <div class="bank-raw-actions" style="gap:8px;">
            <button type="button" class="btn-add" id="btn-bank-trash-restoreall">Restaurer tout</button>
            <button type="button" class="btn-danger-light" id="btn-bank-trash-clear">Vider la corbeille</button>
        </div>
        <div id="bank-trash-container" class="bank-container"></div>
    </details>

</div>

<script>
  /* --- 1. CRITERES --- */
  const CRITERIA = {
      "C1": { "default": { "NT": "Info fausse/absente", "I": "Infos partielles (<50%)", "A": "Majorit√© infos (>50%)", "M": "Toutes infos + Synth√®se" } },
      "C2": { 
          "default": { "NT": "Non identifi√©", "I": "Mal formul√© / Peu d'√©l√©ments", "A": "Correct / Majorit√© √©l√©ments", "M": "Pr√©cis / Complet / Liens" },
          "diagramme": { "NT": "Incomplet", "I": "1 cause + 1 conseq", "A": "Plusieurs causes", "M": "Diagramme complet" },
          "itamami": { "NT": "Vide", "I": "2 parties OK", "A": "3 parties OK", "M": "4 parties OK" },
          "5m": { "NT": "Vide", "I": "3M OK", "A": "4M OK", "M": "5M + Cons√©quence" },
          "qqoqcp": { "NT": "Vide", "I": "3 items OK", "A": "4 items OK", "M": "5 items OK" },
          "risques": { "NT": "Erreur", "I": "2 √©l√©ments li√©s", "A": "3 √©l√©ments li√©s", "M": "Tous √©l√©ments li√©s" },
          "travail": { "NT": "Erreur", "I": "1 det + 1 effet", "A": "Det + Effets identifi√©s", "M": "Complet avec liens" }
      },
      "C3": { "default": { "NT": "Rien", "I": "Partiel / Lien flou", "A": "Correct / Lien √©tabli", "M": "Complet / Vocab. scientifique" } },
      "C4": { "default": { "NT": "Rien", "I": "Inadapt√©", "A": "Adapt√©", "M": "R√©aliste / Hi√©rarchis√©" } },
      "C5": { "default": { "NT": "Rien", "I": "Non pertinent", "A": "Pertinent", "M": "Justifi√© avec preuves" } },
      "C6": { "default": { "NT": "Incompr√©hensible", "I": "Syntaxe fragile", "A": "Syntaxe correcte", "M": "Fluide / Pro" } }
  };

  /* --- STOCKAGE --- */
  const STORE_KEY_V17 = "grille_data_v17";
  const STORE_KEY_V16 = "grille_data_v16";


  /* --- 2. VARS & UTILS --- */
  const tbody = document.getElementById("tbody-questions");
  const noteMaxInput = document.getElementById("noteMaxInput");
  const criteriaHelper = document.getElementById("criteria-helper");
  const criteriaText = document.getElementById("criteria-text");
  
  let commentBank = [];
  const bankInput = document.getElementById("bank-input");
  const bankContainer = document.getElementById("bank-container");
  let lastFocusedInput = document.getElementById("commentGlobal");

  const commentGlobalEl = document.getElementById("commentGlobal");
  function insertIntoCommentGlobal(t){
    const target = commentGlobalEl;
    if(!target) return;
    let text = String(t || "").trim();
    // Dans le champ "Commentaire" : on ne garde pas le pr√©fixe "G√©n√©ral :"
    text = text.replace(/^g[√©e]n[√©e]ral\s*:\s*/i, "");
    if(!text) return;

    const sep = (target.value && target.value.trim()) ? " " : "";
    target.value = (target.value || "") + sep + text;

    target.dispatchEvent(new Event("input", { bubbles: true }));
    try{ target.focus(); }catch(_){}
    try{ target.scrollIntoView({ block: "center" }); }catch(_){}
  }

  function formatNumber(x){ return Number.isInteger(x) ? x.toString() : x.toString().replace(/\.0+$/,''); }

  // Auto-resize textarea
  function bindAutoResize(textarea) {
    if (!textarea || textarea.tagName !== 'TEXTAREA' || textarea.dataset.bound) return;
    textarea.dataset.bound = "1";
    textarea.addEventListener("input", function(){ this.style.height="auto"; this.style.height = this.scrollHeight + "px"; });
    textarea.addEventListener("focus", function(){ lastFocusedInput = this; });
    setTimeout(() => { textarea.style.height="auto"; textarea.style.height = textarea.scrollHeight + "px"; }, 10);
  }

  // Bind auto-resize on all relevant textareas (useful after importing a subject)
  function bindAllAutoResize(){
    document.querySelectorAll(".title-main, .title-section, .th-input, .comp-name-input, #commentGlobal, #nom, #prenomEleve, #classe, #bank-input, #rem-conseil, .reponse-eleve-textarea").forEach(bindAutoResize);
    // Ensure competence names expand correctly
    setTimeout(() => { try{ adjustCompNameHeights(); }catch(_){} }, 10);
  }

  // Legacy safety: older localStorage versions may exist; avoid breaking the whole script
  function restoreLegacyFromV16(_legacy){
    try{ localStorage.removeItem(STORE_KEY_V16); }catch(_){}
    // We don't have a reliable field mapping for V16 -> V17; start clean instead of crashing.
    initRows(1);
    try{ computeAll(); }catch(_){}
  }


  function adjustCompNameHeights() {
      document.querySelectorAll('textarea.comp-name-input').forEach(ta => {
          // If hidden (row display:none), scrollHeight is unreliable
          if (ta.offsetParent === null) {
              ta.style.height = 'auto';
              ta.style.overflow = 'hidden';
              ta.style.resize = 'none';
              return;
          }
          ta.style.height = 'auto';
          ta.style.overflow = 'hidden';
          ta.style.resize = 'none';
          ta.style.height = ta.scrollHeight + 'px';
      });
  }
  
  function bindRichEdit(div) {
      if(!div || div.dataset.bound) return;
      div.dataset.bound = "1";
      div.addEventListener("focus", function(){ lastFocusedInput = this; });
  }

  function fillQuestionSelect(sel) {
    if(sel.options.length > 1) return;
    const arr = [""];
    for(let i=1;i<=30;i++) { 
        arr.push(String(i)); 
        for(let j=1;j<=25;j++) arr.push(i+"."+j); 
    }
    arr.forEach(v => { const opt = document.createElement("option"); opt.value=v; opt.textContent=v; sel.appendChild(opt); });
  }

  /* --- 3. AIDE CONTEXTUELLE --- */
  function showCriteria(comp, level, method) {
      if(!comp || !level || !CRITERIA[comp]) { criteriaHelper.classList.remove("visible"); return; }
      let m = (comp === "C2" && method && CRITERIA["C2"][method]) ? method : "default";
      const txt = CRITERIA[comp][m] ? CRITERIA[comp][m][level] : "";
      if(txt) { 
          criteriaText.innerHTML = `<strong>${comp} ${level} :</strong> ${txt}`; 
          criteriaHelper.classList.add("visible"); 
      } else { criteriaHelper.classList.remove("visible"); }
  }

  /* --- 4. ROWS --- */
  function createRow() {
    const tr = document.createElement("tr");
    tr.className = "question-row";
    tr.innerHTML = `
      <td class="col-question-texte"><div class="question-texte-div" contenteditable="true"></div></td>
      <td class="col-reponse-eleve"><textarea class="reponse-eleve-textarea"></textarea></td>
      <td><select class="qnum-select auto-save"></select></td>
      <td>
        <div class="comp-wrapper">
            <select class="comp-select auto-save">
              <option value="">‚Äì</option><option value="C1">C1</option><option value="C2">C2</option><option value="C3">C3</option><option value="C4">C4</option><option value="C5">C5</option><option value="C6">C6</option>
            </select>
            <select class="method-select auto-save">
                <option value="default">G√©n√©ral</option><option value="diagramme">Causes-Effets</option><option value="itamami">ITaMaMi</option><option value="5m">5M</option><option value="qqoqcp">QQOQCP</option><option value="risques">Risques</option><option value="travail">Travail</option>
            </select>
        </div>
      </td>
      <td>
        <div class="btn-group-level">
            <input type="hidden" class="level-select auto-save">
            <div class="btn-level" data-val="NT">NT</div><div class="btn-level" data-val="I">I</div><div class="btn-level" data-val="A">A</div><div class="btn-level" data-val="M">M</div>
        </div>
        <span class="print-level-text" style="display:none; font-weight:bold;"></span>
      </td>
      <td><input type="number" class="bareme-input auto-save" step="0.5" style="width:60px;"></td>
      <td><input type="number" class="points-input auto-save" step="0.5" style="width:60px;"></td>
      <td class="left"><div class="corrige-div auto-save" contenteditable="true"></div></td>
    `;
    fillQuestionSelect(tr.querySelector(".qnum-select"));
    bindRichEdit(tr.querySelector(".corrige-div"));
    
    // Listeners classiques
    const compSel = tr.querySelector(".comp-select");
    const methodSel = tr.querySelector(".method-select");
    const wrapper = tr.querySelector(".comp-wrapper");
    const hidden = tr.querySelector(".level-select");
    const btns = tr.querySelectorAll(".btn-level");
    const ptsInput = tr.querySelector(".points-input");
    const barInput = tr.querySelector(".bareme-input");

    compSel.addEventListener("change", () => {
        if(compSel.value === "C2") wrapper.classList.add("show-method");
        else { wrapper.classList.remove("show-method"); methodSel.value = "default"; }
        computeAll();
    });

    methodSel.addEventListener("change", () => {
        computeAll();
        if(hidden.value) showCriteria(compSel.value, hidden.value, methodSel.value);
    });
    
    ptsInput.addEventListener("input", computeAll);
    barInput.addEventListener("input", computeAll);

    btns.forEach(btn => {
        btn.addEventListener("click", () => {
            btns.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            hidden.value = btn.dataset.val;
            tr.querySelector(".print-level-text").textContent = btn.dataset.val;
            computeAll();
            showCriteria(compSel.value, btn.dataset.val, methodSel.value);
        });
        btn.addEventListener("mouseenter", () => showCriteria(compSel.value, btn.dataset.val, methodSel.value));
        btn.addEventListener("mouseleave", () => criteriaHelper.classList.remove("visible"));
    });

    return tr;
  }

  /* --- 5. CALCULS DYNAMIQUES --- */
  
  function updateTotalFromBilan() {
      let total = 0;
      const comps = ["C1","C2","C3","C4","C5","C6"];
      comps.forEach(c => {
          const val = parseFloat(document.getElementById(c+"_pts").value) || 0;
          total += val;
      });
      const max = parseFloat(noteMaxInput.value) || 20;
      
      // Mise √† jour affichage Note + COULEUR
      const noteHeader = document.getElementById("note-header");
      const noteResume = document.getElementById("note20_resume");
      
      const formattedTotal = formatNumber(total);
      noteHeader.textContent = formattedTotal;
      noteResume.textContent = formattedTotal + " / " + formatNumber(max);

            // Couleur dynamique (proportionnelle √† la note max)
      const denom = (max > 0) ? max : 20;
      const ratio = total / denom;

      if (ratio < 0.5) {
          noteHeader.style.color = "#dc2626"; // Rouge
          noteResume.style.color = "#dc2626";
      } else if (ratio < 0.7) {
          noteHeader.style.color = "#d97706"; // Orange
          noteResume.style.color = "#d97706";
      } else {
          noteHeader.style.color = "#16a34a"; // Vert
          noteResume.style.color = "#16a34a";
      }
  }

  function computeAll() {
    const rows = document.querySelectorAll("#tbody-questions .question-row");
    document.getElementById("nbQuestionsDisplay").textContent = rows.length;
    let sumB = 0, sumP = 0;
    
    const stats = {};
    const comps = ["C1","C2","C3","C4","C5","C6"];
    comps.forEach(c => {
        stats[c] = { used: false, b:0, p:0, q:[], cnt:{NT:0,I:0,A:0,M:0} };
    });
    
    rows.forEach(row => {
        const c = row.querySelector(".comp-select").value;
        const qNum = row.querySelector(".qnum-select").value;
        const b = parseFloat(row.querySelector(".bareme-input").value) || 0;
        const p = parseFloat(row.querySelector(".points-input").value) || 0;
        const lvl = row.querySelector(".level-select").value;
        const pInput = row.querySelector(".points-input");
        
        if(p > b) { pInput.style.color = "red"; pInput.style.fontWeight = "bold"; pInput.style.backgroundColor="#fee2e2"; }
        else { pInput.style.color = ""; pInput.style.fontWeight = ""; pInput.style.backgroundColor=""; }

        sumB += b; sumP += p;
        
        if(c && stats[c]) { 
            stats[c].used = true;
            stats[c].b += b; 
            stats[c].p += p; 
            if(qNum) stats[c].q.push(qNum);
            if(lvl && stats[c].cnt[lvl] !== undefined) stats[c].cnt[lvl]++;
        }
        
        row.className = "question-row"; if(c) row.classList.add("comp-"+c);
    });

    document.getElementById("sumBareme").textContent = formatNumber(sumB);
    document.getElementById("sumPoints").textContent = formatNumber(sumP);

    // Update Bilan
    for (const c in stats) {
        const row = document.getElementById("row-"+c);
        const legendRow = document.getElementById("legend-"+c);
        
        if (stats[c].used) {
            row.style.display = ""; 
            row.classList.remove("hidden-row");
            if(legendRow) legendRow.style.display = ""; 
        } else {
            row.style.display = "none";
            row.classList.add("hidden-row");
            if(legendRow) legendRow.style.display = "none";
        }

        document.getElementById(c+"_b").textContent = formatNumber(stats[c].b);
        document.getElementById(c+"_q").textContent = stats[c].q.length ? stats[c].q.join(", ") : "‚Äì";
        
        document.getElementById(c+"_NT").textContent = stats[c].cnt.NT;
        document.getElementById(c+"_I").textContent = stats[c].cnt.I;
        document.getElementById(c+"_A").textContent = stats[c].cnt.A;
        document.getElementById(c+"_M").textContent = stats[c].cnt.M;

        document.getElementById(c+"_pts").value = stats[c].p > 0 ? formatNumber(stats[c].p) : (stats[c].used ? "0" : "");

        let pct = (stats[c].b > 0) ? (stats[c].p / stats[c].b)*100 : 0;
        document.getElementById(c+"_pct").textContent = pct.toFixed(0) + "%";
        document.getElementById(c+"_bar").style.width = Math.min(100, pct) + "%";
    }
    
    // Ensure competence names fit when rows become visible
    try{ requestAnimationFrame(adjustCompNameHeights); }catch(_){ }
    updateTotalFromBilan();
    try{ updateRemediationAuto(); }catch(_){ }
    saveAutoData();
  }

  /* --- 6. BANQUE DE COMMENTAIRES --- */
  
function loadBank() {
  try {
    const raw = localStorage.getItem("grille_bank");
    if(!raw) {
      commentBank = ["Excellent travail : copie tr√®s soign√©e, r√©ponses pr√©cises et bien justifi√©es.", "Tr√®s bon travail : ensemble solide, bonne compr√©hension du cours et des documents.", "Bon travail : r√©sultats satisfaisants, quelques points restent √† consolider.", "Travail correct : l‚Äôessentiel est compris, mais il faut gagner en pr√©cision et en m√©thode.", "Travail s√©rieux : tu t‚Äôinvestis, continue en am√©liorant la rigueur et la justification.", "Bonne progression : des progr√®s visibles, il faut poursuivre les efforts pour stabiliser les acquis.", "Travail in√©gal : certaines r√©ponses sont r√©ussies, d‚Äôautres sont √† reprendre plus s√©rieusement.", "Copie soign√©e mais fragile : pr√©sentation correcte, mais des notions du cours sont √† retravailler.", "Manque de rigueur : attention aux consignes et √† la qualit√© des r√©ponses, relis-toi.", "Copie incompl√®te : plusieurs questions non trait√©es, il faut terminer et revoir la m√©thode.", "Travail insuffisant : plusieurs notions ne sont pas acquises, un temps de r√©vision est n√©cessaire.", "Manque d‚Äôimplication : r√©ponses trop courtes ou incompl√®tes, il faut davantage d√©velopper.", "C1 (Traiter l‚Äôinformation) : tu as rep√©r√© les informations essentielles et tu les as utilis√©es correctement.", "C1 (Traiter l‚Äôinformation) : des informations importantes manquent ; relis le document et rep√®re les mots-cl√©s.", "C1 (Traiter l‚Äôinformation) : tu as relev√© trop d‚Äôinformations sans trier ; s√©lectionne l‚Äôessentiel.", "C1 (Traiter l‚Äôinformation) : les informations sont relev√©es mais pas assez organis√©es ; structure ta r√©ponse.", "C1 (Traiter l‚Äôinformation) : bonne utilisation des documents ; tu t‚Äôappuies sur des √©l√©ments pr√©cis.", "C2 (Analyse) : tu identifies correctement le probl√®me et tu justifies ton analyse.", "C2 (Analyse) : le probl√®me est rep√©r√©, mais il manque des causes ou des cons√©quences.", "C2 (Analyse) : ton analyse reste trop g√©n√©rale ; appuie-toi sur des faits du document.", "C2 (Analyse) : analyse coh√©rente, mais il manque la hi√©rarchisation des √©l√©ments.", "C2 (Analyse) : tu confonds constat et solution ; commence par analyser avant de proposer.", "C3 (Expliquer) : explication claire et compl√®te, avec un vocabulaire adapt√©.", "C3 (Expliquer) : l‚Äôexplication est partielle ; il manque une √©tape ou un lien cause ‚Üí effet.", "C3 (Expliquer) : vocabulaire pas assez pr√©cis ; revois les notions du cours.", "C3 (Expliquer) : explication correcte, mais ajoute un exemple pour illustrer.", "C3 (Expliquer) : lien avec la pr√©vention √† pr√©ciser ; indique le risque et la mesure.", "C4 (Solution) : solution pertinente et adapt√©e √† la situation.", "C4 (Solution) : solution int√©ressante mais trop vague ; pr√©cise comment la mettre en ≈ìuvre.", "C4 (Solution) : solution propos√©e mais elle ne r√©pond pas au probl√®me identifi√©.", "C4 (Solution) : bonne id√©e, mais il manque une justification de ton choix.", "C4 (Solution) : propose plusieurs solutions puis choisis la plus efficace.", "C5 (Argumenter) : choix clair, argument√© et coh√©rent avec la situation.", "C5 (Argumenter) : choix donn√©, mais les arguments manquent ou sont trop faibles.", "C5 (Argumenter) : arguments pr√©sents, mais pas assez reli√©s au document.", "C5 (Argumenter) : compare mieux : avantages et limites de chaque option.", "C5 (Argumenter) : utilise des connecteurs logiques (parce que, donc, en cons√©quence).", "C6 (Communication) : r√©ponse claire, phrases compl√®tes, pr√©sentation soign√©e.", "C6 (Communication) : id√©es pertinentes mais expression √† clarifier ; reformule simplement.", "C6 (Communication) : attention √† la syntaxe et √† l‚Äôorthographe ; relis-toi avant de rendre.", "C6 (Communication) : r√©ponse trop courte ; d√©veloppe avec 2 √† 3 phrases.", "C6 (Communication) : structure : une id√©e par phrase, avec des retours √† la ligne si besoin.", "Pour progresser rapidement, utilise le parcours de r√©vision en ligne indiqu√© sur la grille.", "Pour renforcer ta m√©thode, consulte les fiches comp√©tences sur l‚Äôespace de r√©vision en ligne.", "Pour t‚Äôam√©liorer, reprends les fiches et exercices de r√©vision accessibles via le lien / QR du sujet.", "Je t‚Äôinvite √† utiliser l‚Äôespace de r√©vision en ligne indiqu√© sur le document (lien / QR) pour progresser.", "Tu peux refaire les auto-√©valuations en ligne (lien / QR) pour v√©rifier tes acquis et gagner en confiance."].slice();
    } else {
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) {
        // Ancien format (tableau). Si c'√©tait l'ancienne mini-banque, on bascule sur les nouveaux d√©fauts.
        commentBank = (parsed.length < 10) ? ["Excellent travail : copie tr√®s soign√©e, r√©ponses pr√©cises et bien justifi√©es.", "Tr√®s bon travail : ensemble solide, bonne compr√©hension du cours et des documents.", "Bon travail : r√©sultats satisfaisants, quelques points restent √† consolider.", "Travail correct : l‚Äôessentiel est compris, mais il faut gagner en pr√©cision et en m√©thode.", "Travail s√©rieux : tu t‚Äôinvestis, continue en am√©liorant la rigueur et la justification.", "Bonne progression : des progr√®s visibles, il faut poursuivre les efforts pour stabiliser les acquis.", "Travail in√©gal : certaines r√©ponses sont r√©ussies, d‚Äôautres sont √† reprendre plus s√©rieusement.", "Copie soign√©e mais fragile : pr√©sentation correcte, mais des notions du cours sont √† retravailler.", "Manque de rigueur : attention aux consignes et √† la qualit√© des r√©ponses, relis-toi.", "Copie incompl√®te : plusieurs questions non trait√©es, il faut terminer et revoir la m√©thode.", "Travail insuffisant : plusieurs notions ne sont pas acquises, un temps de r√©vision est n√©cessaire.", "Manque d‚Äôimplication : r√©ponses trop courtes ou incompl√®tes, il faut davantage d√©velopper.", "C1 (Traiter l‚Äôinformation) : tu as rep√©r√© les informations essentielles et tu les as utilis√©es correctement.", "C1 (Traiter l‚Äôinformation) : des informations importantes manquent ; relis le document et rep√®re les mots-cl√©s.", "C1 (Traiter l‚Äôinformation) : tu as relev√© trop d‚Äôinformations sans trier ; s√©lectionne l‚Äôessentiel.", "C1 (Traiter l‚Äôinformation) : les informations sont relev√©es mais pas assez organis√©es ; structure ta r√©ponse.", "C1 (Traiter l‚Äôinformation) : bonne utilisation des documents ; tu t‚Äôappuies sur des √©l√©ments pr√©cis.", "C2 (Analyse) : tu identifies correctement le probl√®me et tu justifies ton analyse.", "C2 (Analyse) : le probl√®me est rep√©r√©, mais il manque des causes ou des cons√©quences.", "C2 (Analyse) : ton analyse reste trop g√©n√©rale ; appuie-toi sur des faits du document.", "C2 (Analyse) : analyse coh√©rente, mais il manque la hi√©rarchisation des √©l√©ments.", "C2 (Analyse) : tu confonds constat et solution ; commence par analyser avant de proposer.", "C3 (Expliquer) : explication claire et compl√®te, avec un vocabulaire adapt√©.", "C3 (Expliquer) : l‚Äôexplication est partielle ; il manque une √©tape ou un lien cause ‚Üí effet.", "C3 (Expliquer) : vocabulaire pas assez pr√©cis ; revois les notions du cours.", "C3 (Expliquer) : explication correcte, mais ajoute un exemple pour illustrer.", "C3 (Expliquer) : lien avec la pr√©vention √† pr√©ciser ; indique le risque et la mesure.", "C4 (Solution) : solution pertinente et adapt√©e √† la situation.", "C4 (Solution) : solution int√©ressante mais trop vague ; pr√©cise comment la mettre en ≈ìuvre.", "C4 (Solution) : solution propos√©e mais elle ne r√©pond pas au probl√®me identifi√©.", "C4 (Solution) : bonne id√©e, mais il manque une justification de ton choix.", "C4 (Solution) : propose plusieurs solutions puis choisis la plus efficace.", "C5 (Argumenter) : choix clair, argument√© et coh√©rent avec la situation.", "C5 (Argumenter) : choix donn√©, mais les arguments manquent ou sont trop faibles.", "C5 (Argumenter) : arguments pr√©sents, mais pas assez reli√©s au document.", "C5 (Argumenter) : compare mieux : avantages et limites de chaque option.", "C5 (Argumenter) : utilise des connecteurs logiques (parce que, donc, en cons√©quence).", "C6 (Communication) : r√©ponse claire, phrases compl√®tes, pr√©sentation soign√©e.", "C6 (Communication) : id√©es pertinentes mais expression √† clarifier ; reformule simplement.", "C6 (Communication) : attention √† la syntaxe et √† l‚Äôorthographe ; relis-toi avant de rendre.", "C6 (Communication) : r√©ponse trop courte ; d√©veloppe avec 2 √† 3 phrases.", "C6 (Communication) : structure : une id√©e par phrase, avec des retours √† la ligne si besoin.", "Pour progresser rapidement, utilise le parcours de r√©vision en ligne indiqu√© sur la grille.", "Pour renforcer ta m√©thode, consulte les fiches comp√©tences sur l‚Äôespace de r√©vision en ligne.", "Pour t‚Äôam√©liorer, reprends les fiches et exercices de r√©vision accessibles via le lien / QR du sujet.", "Je t‚Äôinvite √† utiliser l‚Äôespace de r√©vision en ligne indiqu√© sur le document (lien / QR) pour progresser.", "Tu peux refaire les auto-√©valuations en ligne (lien / QR) pour v√©rifier tes acquis et gagner en confiance."].slice() : parsed;
      } else if(parsed && Array.isArray(parsed.items)) {
        const v = parsed.version || "legacy";
        const items = parsed.items || [];
        commentBank = (items.length === 0 || (v !== "v2025-12-25" && items.length < 10)) ? ["Excellent travail : copie tr√®s soign√©e, r√©ponses pr√©cises et bien justifi√©es.", "Tr√®s bon travail : ensemble solide, bonne compr√©hension du cours et des documents.", "Bon travail : r√©sultats satisfaisants, quelques points restent √† consolider.", "Travail correct : l‚Äôessentiel est compris, mais il faut gagner en pr√©cision et en m√©thode.", "Travail s√©rieux : tu t‚Äôinvestis, continue en am√©liorant la rigueur et la justification.", "Bonne progression : des progr√®s visibles, il faut poursuivre les efforts pour stabiliser les acquis.", "Travail in√©gal : certaines r√©ponses sont r√©ussies, d‚Äôautres sont √† reprendre plus s√©rieusement.", "Copie soign√©e mais fragile : pr√©sentation correcte, mais des notions du cours sont √† retravailler.", "Manque de rigueur : attention aux consignes et √† la qualit√© des r√©ponses, relis-toi.", "Copie incompl√®te : plusieurs questions non trait√©es, il faut terminer et revoir la m√©thode.", "Travail insuffisant : plusieurs notions ne sont pas acquises, un temps de r√©vision est n√©cessaire.", "Manque d‚Äôimplication : r√©ponses trop courtes ou incompl√®tes, il faut davantage d√©velopper.", "C1 (Traiter l‚Äôinformation) : tu as rep√©r√© les informations essentielles et tu les as utilis√©es correctement.", "C1 (Traiter l‚Äôinformation) : des informations importantes manquent ; relis le document et rep√®re les mots-cl√©s.", "C1 (Traiter l‚Äôinformation) : tu as relev√© trop d‚Äôinformations sans trier ; s√©lectionne l‚Äôessentiel.", "C1 (Traiter l‚Äôinformation) : les informations sont relev√©es mais pas assez organis√©es ; structure ta r√©ponse.", "C1 (Traiter l‚Äôinformation) : bonne utilisation des documents ; tu t‚Äôappuies sur des √©l√©ments pr√©cis.", "C2 (Analyse) : tu identifies correctement le probl√®me et tu justifies ton analyse.", "C2 (Analyse) : le probl√®me est rep√©r√©, mais il manque des causes ou des cons√©quences.", "C2 (Analyse) : ton analyse reste trop g√©n√©rale ; appuie-toi sur des faits du document.", "C2 (Analyse) : analyse coh√©rente, mais il manque la hi√©rarchisation des √©l√©ments.", "C2 (Analyse) : tu confonds constat et solution ; commence par analyser avant de proposer.", "C3 (Expliquer) : explication claire et compl√®te, avec un vocabulaire adapt√©.", "C3 (Expliquer) : l‚Äôexplication est partielle ; il manque une √©tape ou un lien cause ‚Üí effet.", "C3 (Expliquer) : vocabulaire pas assez pr√©cis ; revois les notions du cours.", "C3 (Expliquer) : explication correcte, mais ajoute un exemple pour illustrer.", "C3 (Expliquer) : lien avec la pr√©vention √† pr√©ciser ; indique le risque et la mesure.", "C4 (Solution) : solution pertinente et adapt√©e √† la situation.", "C4 (Solution) : solution int√©ressante mais trop vague ; pr√©cise comment la mettre en ≈ìuvre.", "C4 (Solution) : solution propos√©e mais elle ne r√©pond pas au probl√®me identifi√©.", "C4 (Solution) : bonne id√©e, mais il manque une justification de ton choix.", "C4 (Solution) : propose plusieurs solutions puis choisis la plus efficace.", "C5 (Argumenter) : choix clair, argument√© et coh√©rent avec la situation.", "C5 (Argumenter) : choix donn√©, mais les arguments manquent ou sont trop faibles.", "C5 (Argumenter) : arguments pr√©sents, mais pas assez reli√©s au document.", "C5 (Argumenter) : compare mieux : avantages et limites de chaque option.", "C5 (Argumenter) : utilise des connecteurs logiques (parce que, donc, en cons√©quence).", "C6 (Communication) : r√©ponse claire, phrases compl√®tes, pr√©sentation soign√©e.", "C6 (Communication) : id√©es pertinentes mais expression √† clarifier ; reformule simplement.", "C6 (Communication) : attention √† la syntaxe et √† l‚Äôorthographe ; relis-toi avant de rendre.", "C6 (Communication) : r√©ponse trop courte ; d√©veloppe avec 2 √† 3 phrases.", "C6 (Communication) : structure : une id√©e par phrase, avec des retours √† la ligne si besoin.", "Pour progresser rapidement, utilise le parcours de r√©vision en ligne indiqu√© sur la grille.", "Pour renforcer ta m√©thode, consulte les fiches comp√©tences sur l‚Äôespace de r√©vision en ligne.", "Pour t‚Äôam√©liorer, reprends les fiches et exercices de r√©vision accessibles via le lien / QR du sujet.", "Je t‚Äôinvite √† utiliser l‚Äôespace de r√©vision en ligne indiqu√© sur le document (lien / QR) pour progresser.", "Tu peux refaire les auto-√©valuations en ligne (lien / QR) pour v√©rifier tes acquis et gagner en confiance."].slice() : items;
      } else {
        commentBank = ["Excellent travail : copie tr√®s soign√©e, r√©ponses pr√©cises et bien justifi√©es.", "Tr√®s bon travail : ensemble solide, bonne compr√©hension du cours et des documents.", "Bon travail : r√©sultats satisfaisants, quelques points restent √† consolider.", "Travail correct : l‚Äôessentiel est compris, mais il faut gagner en pr√©cision et en m√©thode.", "Travail s√©rieux : tu t‚Äôinvestis, continue en am√©liorant la rigueur et la justification.", "Bonne progression : des progr√®s visibles, il faut poursuivre les efforts pour stabiliser les acquis.", "Travail in√©gal : certaines r√©ponses sont r√©ussies, d‚Äôautres sont √† reprendre plus s√©rieusement.", "Copie soign√©e mais fragile : pr√©sentation correcte, mais des notions du cours sont √† retravailler.", "Manque de rigueur : attention aux consignes et √† la qualit√© des r√©ponses, relis-toi.", "Copie incompl√®te : plusieurs questions non trait√©es, il faut terminer et revoir la m√©thode.", "Travail insuffisant : plusieurs notions ne sont pas acquises, un temps de r√©vision est n√©cessaire.", "Manque d‚Äôimplication : r√©ponses trop courtes ou incompl√®tes, il faut davantage d√©velopper.", "C1 (Traiter l‚Äôinformation) : tu as rep√©r√© les informations essentielles et tu les as utilis√©es correctement.", "C1 (Traiter l‚Äôinformation) : des informations importantes manquent ; relis le document et rep√®re les mots-cl√©s.", "C1 (Traiter l‚Äôinformation) : tu as relev√© trop d‚Äôinformations sans trier ; s√©lectionne l‚Äôessentiel.", "C1 (Traiter l‚Äôinformation) : les informations sont relev√©es mais pas assez organis√©es ; structure ta r√©ponse.", "C1 (Traiter l‚Äôinformation) : bonne utilisation des documents ; tu t‚Äôappuies sur des √©l√©ments pr√©cis.", "C2 (Analyse) : tu identifies correctement le probl√®me et tu justifies ton analyse.", "C2 (Analyse) : le probl√®me est rep√©r√©, mais il manque des causes ou des cons√©quences.", "C2 (Analyse) : ton analyse reste trop g√©n√©rale ; appuie-toi sur des faits du document.", "C2 (Analyse) : analyse coh√©rente, mais il manque la hi√©rarchisation des √©l√©ments.", "C2 (Analyse) : tu confonds constat et solution ; commence par analyser avant de proposer.", "C3 (Expliquer) : explication claire et compl√®te, avec un vocabulaire adapt√©.", "C3 (Expliquer) : l‚Äôexplication est partielle ; il manque une √©tape ou un lien cause ‚Üí effet.", "C3 (Expliquer) : vocabulaire pas assez pr√©cis ; revois les notions du cours.", "C3 (Expliquer) : explication correcte, mais ajoute un exemple pour illustrer.", "C3 (Expliquer) : lien avec la pr√©vention √† pr√©ciser ; indique le risque et la mesure.", "C4 (Solution) : solution pertinente et adapt√©e √† la situation.", "C4 (Solution) : solution int√©ressante mais trop vague ; pr√©cise comment la mettre en ≈ìuvre.", "C4 (Solution) : solution propos√©e mais elle ne r√©pond pas au probl√®me identifi√©.", "C4 (Solution) : bonne id√©e, mais il manque une justification de ton choix.", "C4 (Solution) : propose plusieurs solutions puis choisis la plus efficace.", "C5 (Argumenter) : choix clair, argument√© et coh√©rent avec la situation.", "C5 (Argumenter) : choix donn√©, mais les arguments manquent ou sont trop faibles.", "C5 (Argumenter) : arguments pr√©sents, mais pas assez reli√©s au document.", "C5 (Argumenter) : compare mieux : avantages et limites de chaque option.", "C5 (Argumenter) : utilise des connecteurs logiques (parce que, donc, en cons√©quence).", "C6 (Communication) : r√©ponse claire, phrases compl√®tes, pr√©sentation soign√©e.", "C6 (Communication) : id√©es pertinentes mais expression √† clarifier ; reformule simplement.", "C6 (Communication) : attention √† la syntaxe et √† l‚Äôorthographe ; relis-toi avant de rendre.", "C6 (Communication) : r√©ponse trop courte ; d√©veloppe avec 2 √† 3 phrases.", "C6 (Communication) : structure : une id√©e par phrase, avec des retours √† la ligne si besoin.", "Pour progresser rapidement, utilise le parcours de r√©vision en ligne indiqu√© sur la grille.", "Pour renforcer ta m√©thode, consulte les fiches comp√©tences sur l‚Äôespace de r√©vision en ligne.", "Pour t‚Äôam√©liorer, reprends les fiches et exercices de r√©vision accessibles via le lien / QR du sujet.", "Je t‚Äôinvite √† utiliser l‚Äôespace de r√©vision en ligne indiqu√© sur le document (lien / QR) pour progresser.", "Tu peux refaire les auto-√©valuations en ligne (lien / QR) pour v√©rifier tes acquis et gagner en confiance."].slice();
      }
    }
  } catch(e) {
    commentBank = ["Excellent travail : copie tr√®s soign√©e, r√©ponses pr√©cises et bien justifi√©es.", "Tr√®s bon travail : ensemble solide, bonne compr√©hension du cours et des documents.", "Bon travail : r√©sultats satisfaisants, quelques points restent √† consolider.", "Travail correct : l‚Äôessentiel est compris, mais il faut gagner en pr√©cision et en m√©thode.", "Travail s√©rieux : tu t‚Äôinvestis, continue en am√©liorant la rigueur et la justification.", "Bonne progression : des progr√®s visibles, il faut poursuivre les efforts pour stabiliser les acquis.", "Travail in√©gal : certaines r√©ponses sont r√©ussies, d‚Äôautres sont √† reprendre plus s√©rieusement.", "Copie soign√©e mais fragile : pr√©sentation correcte, mais des notions du cours sont √† retravailler.", "Manque de rigueur : attention aux consignes et √† la qualit√© des r√©ponses, relis-toi.", "Copie incompl√®te : plusieurs questions non trait√©es, il faut terminer et revoir la m√©thode.", "Travail insuffisant : plusieurs notions ne sont pas acquises, un temps de r√©vision est n√©cessaire.", "Manque d‚Äôimplication : r√©ponses trop courtes ou incompl√®tes, il faut davantage d√©velopper.", "C1 (Traiter l‚Äôinformation) : tu as rep√©r√© les informations essentielles et tu les as utilis√©es correctement.", "C1 (Traiter l‚Äôinformation) : des informations importantes manquent ; relis le document et rep√®re les mots-cl√©s.", "C1 (Traiter l‚Äôinformation) : tu as relev√© trop d‚Äôinformations sans trier ; s√©lectionne l‚Äôessentiel.", "C1 (Traiter l‚Äôinformation) : les informations sont relev√©es mais pas assez organis√©es ; structure ta r√©ponse.", "C1 (Traiter l‚Äôinformation) : bonne utilisation des documents ; tu t‚Äôappuies sur des √©l√©ments pr√©cis.", "C2 (Analyse) : tu identifies correctement le probl√®me et tu justifies ton analyse.", "C2 (Analyse) : le probl√®me est rep√©r√©, mais il manque des causes ou des cons√©quences.", "C2 (Analyse) : ton analyse reste trop g√©n√©rale ; appuie-toi sur des faits du document.", "C2 (Analyse) : analyse coh√©rente, mais il manque la hi√©rarchisation des √©l√©ments.", "C2 (Analyse) : tu confonds constat et solution ; commence par analyser avant de proposer.", "C3 (Expliquer) : explication claire et compl√®te, avec un vocabulaire adapt√©.", "C3 (Expliquer) : l‚Äôexplication est partielle ; il manque une √©tape ou un lien cause ‚Üí effet.", "C3 (Expliquer) : vocabulaire pas assez pr√©cis ; revois les notions du cours.", "C3 (Expliquer) : explication correcte, mais ajoute un exemple pour illustrer.", "C3 (Expliquer) : lien avec la pr√©vention √† pr√©ciser ; indique le risque et la mesure.", "C4 (Solution) : solution pertinente et adapt√©e √† la situation.", "C4 (Solution) : solution int√©ressante mais trop vague ; pr√©cise comment la mettre en ≈ìuvre.", "C4 (Solution) : solution propos√©e mais elle ne r√©pond pas au probl√®me identifi√©.", "C4 (Solution) : bonne id√©e, mais il manque une justification de ton choix.", "C4 (Solution) : propose plusieurs solutions puis choisis la plus efficace.", "C5 (Argumenter) : choix clair, argument√© et coh√©rent avec la situation.", "C5 (Argumenter) : choix donn√©, mais les arguments manquent ou sont trop faibles.", "C5 (Argumenter) : arguments pr√©sents, mais pas assez reli√©s au document.", "C5 (Argumenter) : compare mieux : avantages et limites de chaque option.", "C5 (Argumenter) : utilise des connecteurs logiques (parce que, donc, en cons√©quence).", "C6 (Communication) : r√©ponse claire, phrases compl√®tes, pr√©sentation soign√©e.", "C6 (Communication) : id√©es pertinentes mais expression √† clarifier ; reformule simplement.", "C6 (Communication) : attention √† la syntaxe et √† l‚Äôorthographe ; relis-toi avant de rendre.", "C6 (Communication) : r√©ponse trop courte ; d√©veloppe avec 2 √† 3 phrases.", "C6 (Communication) : structure : une id√©e par phrase, avec des retours √† la ligne si besoin.", "Pour progresser rapidement, utilise le parcours de r√©vision en ligne indiqu√© sur la grille.", "Pour renforcer ta m√©thode, consulte les fiches comp√©tences sur l‚Äôespace de r√©vision en ligne.", "Pour t‚Äôam√©liorer, reprends les fiches et exercices de r√©vision accessibles via le lien / QR du sujet.", "Je t‚Äôinvite √† utiliser l‚Äôespace de r√©vision en ligne indiqu√© sur le document (lien / QR) pour progresser.", "Tu peux refaire les auto-√©valuations en ligne (lien / QR) pour v√©rifier tes acquis et gagner en confiance."].slice();
  }
  renderBank();
}

function saveBank() {
  try {
    localStorage.setItem("grille_bank", JSON.stringify({version:"v2025-12-25", items: commentBank}));
  } catch(e) {}
  renderBank();
}

  function renderBank() {
      bankContainer.innerHTML = "";
      commentBank.forEach((t, i) => {
          const d = document.createElement("div"); d.className = "bank-tag";
          d.innerHTML = `<span>${t}</span><div class="bank-del" onclick="delBank(event, ${i})">√ó</div>`;
          d.onclick = (e) => {
              if(e.target.classList.contains("bank-del")) return;
              insertIntoCommentGlobal(t);
          };
          bankContainer.appendChild(d);
      });
  }
  
  // --- Banque: suppression s√©curis√©e + annulation ---
  const bankUndoEl = document.getElementById("bank-undo");
  const bankUndoBtn = document.getElementById("bank-undo-btn");
  const btnBankClear = document.getElementById("btn-bank-clear");
  const btnBankReset = document.getElementById("btn-bank-reset");

  let bankUndoTimer = null;
  let lastDeleted = null;

  const BANK_TRASH_KEY = "grille_bank_trash_v1";
  let bankTrash = [];

  function loadTrash(){
    try{
      const raw = localStorage.getItem(BANK_TRASH_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      bankTrash = Array.isArray(parsed) ? parsed : [];
    }catch(_){ bankTrash = []; }
  }
  function saveTrash(){
    try{ localStorage.setItem(BANK_TRASH_KEY, JSON.stringify(bankTrash)); }catch(_){}
    renderTrash();
  }
  function renderTrash(){
    const box = document.getElementById("bank-trash-container");
    if(!box) return;
    box.innerHTML = "";
    if(!bankTrash.length){
      const empty = document.createElement("div");
      empty.style.cssText = "padding:.5rem .25rem;color:#6b7280;font-size:.95rem;";
      empty.textContent = "Corbeille vide.";
      box.appendChild(empty);
      return;
    }
    bankTrash.forEach((it, idx) => {
      const t = (it && it.text) ? it.text : String(it || "");
      const d = document.createElement("div"); d.className = "bank-tag";
      const span = document.createElement("span"); span.textContent = t;
      const actions = document.createElement("div"); actions.style.display="flex"; actions.style.gap="6px"; actions.style.alignItems="center";

      const restore = document.createElement("div");
      restore.className = "bank-restore";
      restore.title = "Restaurer";
      restore.textContent = "‚Ü©";
      restore.onclick = (e) => {
        e.stopPropagation();
        commentBank.push(t);
        // retire de la corbeille
        bankTrash.splice(idx, 1);
        saveBank();
        saveTrash();
      };

      const del = document.createElement("div");
      del.className = "bank-del";
      del.title = "Supprimer d√©finitivement";
      del.textContent = "√ó";
      del.onclick = (e) => {
        e.stopPropagation();
        bankTrash.splice(idx, 1);
        saveTrash();
      };

      actions.appendChild(restore);
      actions.appendChild(del);

      d.appendChild(span);
      d.appendChild(actions);
      box.appendChild(d);
    });
  }

  function hideBankUndo(){
    if(bankUndoTimer){ clearTimeout(bankUndoTimer); bankUndoTimer = null; }
    if(bankUndoEl) bankUndoEl.style.display = "none";
    lastDeleted = null;
  }

  function showBankUndo(){
    if(!bankUndoEl) return;
    bankUndoEl.style.display = "flex";
    if(bankUndoTimer) clearTimeout(bankUndoTimer);
    bankUndoTimer = setTimeout(hideBankUndo, 12000);
  }

  function softDeleteBank(index){
    if(index == null || index < 0 || index >= commentBank.length) return;
    loadTrash();
    const removedText = commentBank[index];
    const id = Date.now();
    bankTrash.unshift({ id, text: removedText, at: id });
    saveTrash();

    lastDeleted = { text: removedText, index, trashId: id };
    commentBank.splice(index, 1);
    saveBank();
    showBankUndo();
  }

  if(bankUndoBtn){
    bankUndoBtn.onclick = () => {
      if(!lastDeleted) return;
      const { text, index, trashId } = lastDeleted;
      commentBank.splice(Math.min(index, commentBank.length), 0, text);
      saveBank();

      // retire de la corbeille si pr√©sent
      try{
        loadTrash();
        const k = bankTrash.findIndex(x => x && x.id === trashId);
        if(k >= 0){ bankTrash.splice(k, 1); saveTrash(); }
        else { renderTrash(); }
      }catch(_){}

      hideBankUndo();
    };
  }

  // Compat: utilis√© par la liste brute
  window.delBank = (e, i) => { e.stopPropagation(); softDeleteBank(i); };

  // R√©initialisation volontaire (remet la banque par d√©faut)
  window.resetBank = () => {
    if(!confirm("R√©initialiser la banque de commentaires ? (Tu perdras tes ajouts personnalis√©s)")) return;
    try{ localStorage.removeItem("grille_bank"); }catch(_){}
    loadBank();
    saveBank();
    hideBankUndo();
  };

  if(btnBankClear){
    btnBankClear.onclick = () => { bankInput.value = ""; bankInput.focus(); };
  }
  if(btnBankReset){
    btnBankReset.onclick = () => { window.resetBank(); };
  }

  const btnTrashClear = document.getElementById("btn-bank-trash-clear");
  const btnTrashRestoreAll = document.getElementById("btn-bank-trash-restoreall");

  if(btnTrashClear){
    btnTrashClear.onclick = () => {
      loadTrash();
      if(!bankTrash.length) return;
      if(!confirm("Vider la corbeille ?")) return;
      bankTrash = [];
      saveTrash();
    };
  }
  if(btnTrashRestoreAll){
    btnTrashRestoreAll.onclick = () => {
      loadTrash();
      if(!bankTrash.length) return;
      // restaure tout dans la banque (en gardant l'ordre)
      const items = bankTrash.map(x => (x && x.text) ? x.text : String(x || ""));
      commentBank = commentBank.concat(items);
      bankTrash = [];
      saveBank();
      saveTrash();
    };
  }

  // premier rendu corbeille
  try{ loadTrash(); renderTrash(); }catch(_){}

  // Ajout (dans la banque) : on √©vite les doublons exacts
  document.getElementById("btn-bank-add").onclick = () => {
      const v = bankInput.value.trim();
      if(!v) return;
      if(!commentBank.includes(v)) {
          commentBank.push(v);
          saveBank();
          bankInput.value = "";
      } else {
          alert("D√©j√† pr√©sent dans la banque. Clique sur la carte pour l‚Äôins√©rer dans Commentaire.");
      }
  };


  /* --- 6bis. BANQUE DE COMMENTAIRES (rep√©rage rapide / filtres / modification) --- */
  (function(){
      const bankPlusContainer = document.getElementById("bank-plus-container");
      const bankFilters = document.getElementById("bank-filters");
      const bankSearchEl = document.getElementById("bank-search");
      const bankCompSel = document.getElementById("bank-comp");
      const btnUpdate = document.getElementById("btn-bank-update");
      const btnCancel = document.getElementById("btn-bank-cancel");
      const btnAdd = document.getElementById("btn-bank-add");

      if(!bankPlusContainer || !bankFilters || !bankSearchEl || !bankCompSel || !btnUpdate || !btnCancel || !btnAdd) return;

      let filterComp = "ALL";
      let search = "";
      let editIndex = null;

      function detectComp(t){
          const s = String(t || "").trim();
          let m = s.match(/^\s*(?:\[(C[1-6])\]|(C[1-6])\b)/i);
          if(m) return (m[1] || m[2]).toUpperCase();

          m = s.match(/^\s*C([1-6])\s*\(/i);
          if(m) return ("C" + m[1]).toUpperCase();

          m = s.match(/^\s*C([1-6])\s*[:\-‚Äì]/i);
          if(m) return ("C" + m[1]).toUpperCase();

          if(/^\s*g[√©e]n[√©e]ral\s*[:\-‚Äì]/i.test(s) || /^\s*general\s*[:\-‚Äì]/i.test(s)) return "GEN";
          return "GEN";
      }

      function normalize(s){ return String(s || "").toLowerCase(); }

      function itemMatches(t){
          if(filterComp !== "ALL"){
              const c = detectComp(t);
              if(filterComp === "GEN") { if(c !== "GEN") return false; }
              else { if(c !== filterComp) return false; }
          }
          if(search){
              return normalize(t).includes(normalize(search));
          }
          return true;
      }

      function pillLabel(c){ return c === "GEN" ? "G√©n√©ral" : c; }
      function compClass(c){ return c === "GEN" ? "comp-GEN" : ("comp-" + c); }

      function renderBankPlus(){
          bankPlusContainer.innerHTML = "";
          const list = Array.isArray(commentBank) ? commentBank : [];
          const filtered = [];
          for(let i=0; i<list.length; i++){
              const t = list[i];
              if(itemMatches(t)) filtered.push({i, t, c: detectComp(t)});
          }

          filtered.forEach(({i, t, c}) => {
              const card = document.createElement("div");
              card.className = "bank-item " + compClass(c);

              const pill = document.createElement("div");
              pill.className = "bank-pill";
              pill.textContent = pillLabel(c);

              const txt = document.createElement("div");
              txt.className = "bank-text";
              txt.textContent = t;

              const actions = document.createElement("div");
              actions.className = "bank-actions";

              const bEdit = document.createElement("button");
              bEdit.type = "button";
              bEdit.className = "bank-mini success";
              bEdit.textContent = "‚úì";
              bEdit.title = "Modifier";
              bEdit.onclick = (e) => {
                  e.stopPropagation();
                  editIndex = i;
                  bankInput.value = t;
                  const dc = detectComp(t);
                  bankCompSel.value = (dc === "GEN" ? "GEN" : dc);
                  btnUpdate.style.display = "";
                  btnCancel.style.display = "";
                  btnAdd.style.display = "none";
                  bankInput.focus();
              };

              const bDel = document.createElement("button");
              bDel.type = "button";
              bDel.className = "bank-mini danger";
              bDel.textContent = "√ó";
              bDel.title = "Supprimer";
              bDel.onclick = (e) => {
                  e.stopPropagation();
                  softDeleteBank(i);
              };

              actions.appendChild(bEdit);
              actions.appendChild(bDel);

              card.appendChild(pill);
              card.appendChild(txt);
              card.appendChild(actions);

              card.onclick = () => {
                  insertIntoCommentGlobal(t);
              };

              bankPlusContainer.appendChild(card);
          });
      }

      // wrap renderBank so the "bank+" view stays synced
      try{
          const _rb = renderBank;
          renderBank = function(){ _rb(); try{ renderBankPlus(); }catch(_){} };
      }catch(_){}

      // filters
      bankFilters.querySelectorAll(".bank-filter").forEach(btn => {
          btn.onclick = () => {
              bankFilters.querySelectorAll(".bank-filter").forEach(b => b.classList.remove("active"));
              btn.classList.add("active");
              filterComp = btn.dataset.comp || "ALL";
              renderBankPlus();
          };
      });

      bankSearchEl.addEventListener("input", () => {
          search = bankSearchEl.value || "";
          renderBankPlus();
      });

      // add override: prefix based on selected competence (without breaking existing behavior)
      const oldAdd = btnAdd.onclick;
      btnAdd.onclick = () => {
          const sel = bankCompSel.value || "AUTO";
          let v = bankInput.value.trim();
          if(!v) return oldAdd ? oldAdd() : undefined;

          if(sel !== "AUTO"){
              if(sel === "GEN"){
                  if(!/^\s*g[√©e]n[√©e]ral\s*[:\-‚Äì]/i.test(v)){
                      // if already starts with Cx, keep; otherwise prefix G√©n√©ral
                      if(!/^\s*C[1-6]\b/i.test(v)) v = "G√©n√©ral : " + v;
                  }
              } else {
                  if(!/^\s*C[1-6]\b/i.test(v)) v = sel + " : " + v;
              }
              bankInput.value = v;
          }
          return oldAdd ? oldAdd() : undefined;
      };

      // update / cancel
      btnCancel.onclick = () => {
          editIndex = null;
          bankInput.value = "";
          btnUpdate.style.display = "none";
          btnCancel.style.display = "none";
          btnAdd.style.display = "";
      };

      btnUpdate.onclick = () => {
          if(editIndex === null) return;
          let v = bankInput.value.trim();
          if(!v) return;

          const sel = bankCompSel.value || "AUTO";
          if(sel !== "AUTO"){
              if(sel === "GEN"){
                  if(!/^\s*g[√©e]n[√©e]ral\s*[:\-‚Äì]/i.test(v)){
                      if(!/^\s*C[1-6]\b/i.test(v)) v = "G√©n√©ral : " + v;
                  }
              } else {
                  if(!/^\s*C[1-6]\b/i.test(v)) v = sel + " : " + v;
              }
          }

          commentBank[editIndex] = v;
          editIndex = null;

          // Ajoute aussi dans le champ "Commentaire" (en haut)
          try{ insertIntoCommentGlobal(v); }catch(_){}

          bankInput.value = "";
          btnUpdate.style.display = "none";
          btnCancel.style.display = "none";
          btnAdd.style.display = "";

          saveBank();
          try{ renderBankPlus(); }catch(_){}
      };

      try{ renderBankPlus(); }catch(_){}
  })();

  /* --- 8. SAUVEGARDE ET CHARGEMENT --- */

  // Nettoyage HTML minimal (anti-injection) : conserve quelques balises simples, supprime tous les attributs
  function sanitizeRichHTML(html){
      if(html == null) return "";
      const tpl = document.createElement("template");
      tpl.innerHTML = String(html);
      const allowed = new Set(["B","STRONG","I","EM","U","BR","P","UL","OL","LI","SPAN","DIV"]);
      const nodes = [];
      const walker = document.createTreeWalker(tpl.content, NodeFilter.SHOW_ELEMENT, null);
      while(walker.nextNode()) nodes.push(walker.currentNode);
      nodes.forEach(el => {
          const tag = el.tagName;
          if(tag === "SCRIPT" || tag === "STYLE") {
              el.remove();
              return;
          }
          if(!allowed.has(tag)){
              const parent = el.parentNode;
              while(el.firstChild) parent.insertBefore(el.firstChild, el);
              parent.removeChild(el);
              return;
          }
          // Supprimer tous les attributs (style, on*, href/src, etc.)
          [...el.attributes].forEach(a => el.removeAttribute(a.name));
      });
      return tpl.innerHTML;
  }

  function saveAutoData() {
      const data = { fixed: {}, questions: [] };

      // Champs fixes (stables)
      document.querySelectorAll("[data-key]").forEach(el => {
          const k = el.dataset.key;
          data.fixed[k] = (el.tagName === "DIV") ? sanitizeRichHTML(el.innerHTML) : el.value;
      });

      adjustCompNameHeights();

      // Lignes questions
      document.querySelectorAll("#tbody-questions .question-row").forEach(tr => {
          data.questions.push({
              qnum: tr.querySelector(".qnum-select")?.value || "",
              
              questionTexte: (tr.querySelector(".question-texte-div")?.textContent || ""),
              reponseEleve: (tr.querySelector(".reponse-eleve-textarea")?.value || ""),
              comp: tr.querySelector(".comp-select")?.value || "",
              method: tr.querySelector(".method-select")?.value || "default",
              level: tr.querySelector(".level-select")?.value || "",
              bareme: tr.querySelector(".bareme-input")?.value || "",
              points: tr.querySelector(".points-input")?.value || "",
              corrige: sanitizeRichHTML(tr.querySelector(".corrige-div")?.innerHTML || "")
          });
      });

      try{ localStorage.setItem(STORE_KEY_V17, JSON.stringify(data)); }catch(_){ }
  }
  
  function loadAutoData() {
      // SECURITE : V√©rifier si le fichier est d√©j√† rempli
      const rows = document.querySelectorAll("#tbody-questions .question-row");
      if(rows.length > 0 || (document.getElementById("nom").value !== "" && document.getElementById("nom").value !== undefined)) {
          reattachListeners();
          try{ bindAllAutoResize(); }catch(_){ }
          computeAll();
          return; // ON STOPPE ICI SI FICHIER REMPLI
      }

      const rawV17 = localStorage.getItem(STORE_KEY_V17);
      if(rawV17) {
          try {
              const d = JSON.parse(rawV17);
              restoreDataFromObject(d);
              try{ bindAllAutoResize(); }catch(_){ }
              return;
          } catch(e) {}
      }

      const rawV16 = localStorage.getItem(STORE_KEY_V16);
      if(rawV16) {
          try {
              const d = JSON.parse(rawV16);
              restoreLegacyFromV16(d);
              try{ bindAllAutoResize(); }catch(_){ }
              return;
          } catch(e) {}
      }

      initRows(1);
  }
  
  function reattachListeners() {
      document.querySelectorAll(".question-row").forEach(tr => {
          const compSel = tr.querySelector(".comp-select");
          const methodSel = tr.querySelector(".method-select");
          const wrapper = tr.querySelector(".comp-wrapper");
          const hidden = tr.querySelector(".level-select");
          const btns = tr.querySelectorAll(".btn-level");
          const ptsInput = tr.querySelector(".points-input");
          const barInput = tr.querySelector(".bareme-input");
          const corrigeDiv = tr.querySelector(".corrige-div");
               const qTextDiv = tr.querySelector(".question-texte-div");
               const repTA = tr.querySelector(".reponse-eleve-textarea");
                   try{ bindAutoResize(repTA); repTA.dispatchEvent(new Event("input")); }catch(_){ }
          
          bindRichEdit(corrigeDiv);
          
          compSel.addEventListener("change", () => {
              if(compSel.value === "C2") wrapper.classList.add("show-method");
              else { wrapper.classList.remove("show-method"); methodSel.value = "default"; }
              computeAll();
          });

          methodSel.addEventListener("change", () => {
              computeAll();
              if(hidden.value) showCriteria(compSel.value, hidden.value, methodSel.value);
          });
          
          ptsInput.addEventListener("input", computeAll);
          barInput.addEventListener("input", computeAll);

          btns.forEach(btn => {
              btn.addEventListener("click", () => {
                  btns.forEach(b => b.classList.remove("active"));
                  btn.classList.add("active");
                  hidden.value = btn.dataset.val;
                  tr.querySelector(".print-level-text").textContent = btn.dataset.val;
                  computeAll();
                  showCriteria(compSel.value, btn.dataset.val, methodSel.value);
              });
              btn.addEventListener("mouseenter", () => showCriteria(compSel.value, btn.dataset.val, methodSel.value));
              btn.addEventListener("mouseleave", () => criteriaHelper.classList.remove("visible"));
          });
      });
  }

  function restoreDataFromObject(d) {
      const questions = Array.isArray(d.questions) ? d.questions : [];
      initRows(questions.length || 1);

      // Champs fixes
      const fixed = d.fixed || {};
      document.querySelectorAll("[data-key]").forEach(el => {
          const k = el.dataset.key;
          if(fixed[k] !== undefined) {
              if(el.tagName === "DIV") el.innerHTML = sanitizeRichHTML(fixed[k]);
              else el.value = fixed[k];
          }
      });

      adjustCompNameHeights();

      // Lignes questions
      setTimeout(() => {
          const rows = document.querySelectorAll("#tbody-questions .question-row");
          questions.forEach((q, i) => {
              const tr = rows[i];
              if(!tr) return;

              const qnumSel = tr.querySelector(".qnum-select");
              const compSel = tr.querySelector(".comp-select");
              const methodSel = tr.querySelector(".method-select");
              const wrapper = tr.querySelector(".comp-wrapper");
              const hidden = tr.querySelector(".level-select");
              const barInput = tr.querySelector(".bareme-input");
              const ptsInput = tr.querySelector(".points-input");
              const corrigeDiv = tr.querySelector(".corrige-div");
              const btns = tr.querySelectorAll(".btn-level");
              const qTextDiv = tr.querySelector(".question-texte-div");
              const repTA = tr.querySelector(".reponse-eleve-textarea");

              if(qnumSel) qnumSel.value = q.qnum || "";
              if(compSel) compSel.value = q.comp || "";
              if(methodSel) methodSel.value = q.method || "default";

              if(compSel && wrapper) {
                  if(compSel.value === "C2") wrapper.classList.add("show-method");
                  else wrapper.classList.remove("show-method");
              }

              if(hidden) hidden.value = q.level || "";
              tr.querySelector(".print-level-text").textContent = q.level || "";

              btns.forEach(b => {
                  if((q.level || "") === b.dataset.val) b.classList.add("active");
                  else b.classList.remove("active");
              });

              if(barInput) barInput.value = q.bareme ?? "";
              if(ptsInput) ptsInput.value = q.points ?? "";
              if(corrigeDiv) corrigeDiv.innerHTML = sanitizeRichHTML(q.corrige || "");
               if(qTextDiv) qTextDiv.textContent = (q.questionTexte ?? q.intitule ?? "");
               if(repTA) repTA.value = (q.reponseEleve ?? "");
          });

          reattachListeners();
          computeAll();
          adjustCompNameHeights();
      }, 0);
  }
  
  function initRows(n) { tbody.innerHTML=""; for(let i=0; i<n; i++) tbody.appendChild(createRow()); }
  
  window.clearColumn = (cls) => { 
      if(confirm("Vider la colonne ?")) { 
          document.querySelectorAll("."+cls).forEach(e => { 
              if(e.tagName === "DIV") e.innerHTML = ""; else e.value=""; 
              if(cls.includes("level")) { e.closest("tr").querySelectorAll(".active").forEach(b=>b.classList.remove("active")); e.closest("tr").querySelector(".print-level-text").textContent=""; }
          }); 
          computeAll(); 
      }
  };
  
  document.getElementById("btn-add-row").onclick = () => { tbody.appendChild(createRow()); computeAll(); };
  document.getElementById("btn-del-row").onclick = () => { if(tbody.children.length>0) tbody.removeChild(tbody.lastChild); computeAll(); };
  document.getElementById("btn-clear").onclick = () => { if(confirm("Tout effacer ?")) { localStorage.removeItem(STORE_KEY_V17); localStorage.removeItem(STORE_KEY_V16); location.reload(); }};
  
  /* --- 9. EXPORT & PRINT --- */
  
  function collectProjectData(){
      // Prefer the canonical object we already store in localStorage
      let dataObj = null;
      try{
          const raw = localStorage.getItem(STORE_KEY_V17);
          if(raw) dataObj = JSON.parse(raw);
      }catch(_){}
      if(!dataObj || typeof dataObj !== "object" || !Array.isArray(dataObj.questions)){
          // Fallback: build from DOM (same structure as saveAutoData)
          dataObj = { fixed: {}, questions: [] };
          document.querySelectorAll("[data-key]").forEach(el => {
              const k = el.dataset.key;
              dataObj.fixed[k] = (el.tagName === "DIV") ? sanitizeRichHTML(el.innerHTML) : el.value;
          });
          document.querySelectorAll("#tbody-questions .question-row").forEach(tr => {
              dataObj.questions.push({
                  qnum: tr.querySelector(".qnum-select")?.value || "",
                  
              questionTexte: (tr.querySelector(".question-texte-div")?.textContent || ""),
              reponseEleve: (tr.querySelector(".reponse-eleve-textarea")?.value || ""),
              comp: tr.querySelector(".comp-select")?.value || "",
                  method: tr.querySelector(".method-select")?.value || "default",
                  level: tr.querySelector(".level-select")?.value || "",
                  bareme: tr.querySelector(".bareme-input")?.value || "",
                  points: tr.querySelector(".points-input")?.value || "",
                  corrige: sanitizeRichHTML(tr.querySelector(".corrige-div")?.innerHTML || "")
              });
          });
      }
      return {
          type: "projet_pse",
          version: 25,
          exportedAt: new Date().toISOString(),
          data: dataObj
      };
  }

  function downloadJSON(obj, filename){
      const jsonStr = JSON.stringify(obj, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }

  function safeFilenamePart(s){
      return String(s || "").trim().replace(/[^a-z0-9]/gi, '_').replace(/_+/g,'_').replace(/^_+|_+$/g,'') || "";
  }

  document.getElementById("btn-export-json").addEventListener("click", () => {
      try{ saveAutoData(); }catch(_){}
      const obj = collectProjectData();
      const nom = safeFilenamePart(document.getElementById("nom")?.value) || "Eleve";
      const prenom = safeFilenamePart(document.getElementById("prenomEleve")?.value);
      const classe = safeFilenamePart(document.getElementById("classe")?.value);
      const parts = ["Eval_PSE", classe, prenom, nom].filter(Boolean);
      const filename = parts.join("_") + ".json";
      downloadJSON(obj, filename);
  });

  

  // === IMPORT JSON √âL√àVE (r√©ponses) ===
  // Objectif : remplir uniquement la colonne "R√©ponse de l‚Äô√©l√®ve" + identit√© (si pr√©sente)
  // Sans toucher : attendus, bar√®mes, comp√©tences, structure, etc.
  function importStudentJSON(obj){
      try{
          // Identit√© √©l√®ve (tol√©rant)
          const nom = obj.nom ?? obj.name ?? obj.lastName ?? obj.lastname;
          const prenom = obj.prenom ?? obj.pr√©nom ?? obj.firstName ?? obj.firstname ?? obj.prenomEleve;
          const classe = obj.classe ?? obj.class ?? obj.classeEleve ?? obj.group;

          if(nom != null && document.getElementById("nom")) document.getElementById("nom").value = String(nom);
          if(prenom != null && document.getElementById("prenomEleve")) document.getElementById("prenomEleve").value = String(prenom);
          if(classe != null && document.getElementById("classe")) document.getElementById("classe").value = String(classe);

          // Construire la map des r√©ponses
          let rep = {};
          if(obj.reponses && typeof obj.reponses === "object") rep = obj.reponses;
          else if(obj.answers && typeof obj.answers === "object") rep = obj.answers;
          else if(obj.responses && typeof obj.responses === "object") rep = obj.responses;
          else {
              Object.keys(obj).forEach(k => {
                  if(/^q?\d+$/i.test(k)) rep[k] = obj[k];
              });
          }

          const rows = Array.from(document.querySelectorAll("#tbody-questions .question-row"));
          rows.forEach((tr, idx) => {
              const qnumSel = tr.querySelector(".qnum-select");
              const qnum = (qnumSel && qnumSel.value) ? String(qnumSel.value).trim() : String(idx+1);

              const ta = tr.querySelector(".reponse-eleve-textarea");
              if(!ta) return;

              // essayer plusieurs cl√©s : "1", 1, "q1"
              const keys = [qnum, String(Number(qnum)), "q"+qnum, "Q"+qnum];
              let val = null;
              for(const k of keys){
                  if(rep && Object.prototype.hasOwnProperty.call(rep, k)){
                      val = rep[k];
                      break;
                  }
              }
              if(val != null){
                  ta.value = String(val);
              } else {
                  // si pas de r√©ponse fournie, on laisse vide
                  ta.value = "";
              }

              // Nettoyer correction pr√©c√©dente (recommand√©) : on ne touche PAS aux attendus
              const pts = tr.querySelector(".points-input");
              if(pts) pts.value = "";
              const hidden = tr.querySelector(".level-select");
              if(hidden) hidden.value = "";
              const btns = tr.querySelectorAll(".btn-level");
              btns.forEach(b => b.classList.remove("active"));
              const pl = tr.querySelector(".print-level-text");
              if(pl) pl.textContent = "";
          });

          bindAllAutoResize();
          computeAll();
          saveAutoData();
          alert("R√©ponses √©l√®ve import√©es (sans modifier tes attendus).");

      }catch(err){
          alert("Erreur : JSON √©l√®ve non import√©");
      }
  }

document.getElementById("btn-import-json").addEventListener("click", () => {
      document.getElementById("file-input").click();
  });

  document.getElementById("file-input").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
          try {
              const obj = JSON.parse(ev.target.result);

              // --- JSON √âL√àVE (r√©ponses) : ne remplace pas le sujet ---
              const looksLikeStudent = (() => {
                  if(!obj || typeof obj !== "object") return false;
                  if(obj.reponses && typeof obj.reponses === "object") return true;
                  if(obj.answers && typeof obj.answers === "object") return true;
                  if(obj.responses && typeof obj.responses === "object") return true;
                  // cl√©s q1, q2, 1, 2, etc.
                  const keys = Object.keys(obj);
                  const qKeys = keys.filter(k => /^q?\d+$/i.test(k));
                  return qKeys.length >= 1;
              })();

              if(looksLikeStudent){
                  importStudentJSON(obj);
                  e.target.value = "";
                  return;
              }


              // Formats accept√©s :
              // 1) Nouveau : { type:"projet_pse", data:{ fixed, questions } }
              // 2) Ancien : { fixed, questions } (sans type)
              // 3) Direct typ√© : { type:"projet_pse", fixed, questions }
              const isWrappedProject = (obj && obj.type === "projet_pse" && obj.data && obj.data.fixed && Array.isArray(obj.data.questions));
              const isDirectTyped = (obj && obj.type === "projet_pse" && obj.fixed && Array.isArray(obj.questions));
              const isLegacyProject = (obj && !obj.type && obj.fixed && Array.isArray(obj.questions));

              if(!isWrappedProject && !isDirectTyped && !isLegacyProject){
                  alert("Format JSON de projet non reconnu.");
                  return;
              }

              const payload = isWrappedProject ? obj.data : obj;

              if(confirm("Charger ce projet ? (Cela remplacera l'√©tat actuel)")) {
                  restoreDataFromObject(payload);
                  try{ localStorage.setItem(STORE_KEY_V17, JSON.stringify(payload)); }catch(_){}
              }
          } catch (err) {
              alert("Erreur de lecture du fichier JSON");
          }
      };
      reader.readAsText(file);
      e.target.value = '';
  });



// --- Import Sujet (JSON) ---
  function importSubjectJSON(obj){
      if(!obj || typeof obj !== "object") throw new Error("Format invalide");
      if(obj.type !== "sujet_pse") throw new Error("Ce JSON n'est pas un sujet (type=sujet_pse)");
      // Titres / note max
      if(obj.titre && document.getElementById("titreEval")) {
          document.getElementById("titreEval").value = String(obj.titre);
      }
      if(obj.noteMax && document.getElementById("noteMaxInput")) {
          document.getElementById("noteMaxInput").value = Number(obj.noteMax) || document.getElementById("noteMaxInput").value;
      }

      // M√©tadonn√©es du sujet pour la rem√©diation
      window.__subjectMeta = {
          module: (obj.module || obj.titre || "").toString(),
          remediation_by_comp: (obj.remediation_by_comp && typeof obj.remediation_by_comp === "object") ? obj.remediation_by_comp : {}
      };
      const qt = document.getElementById("qrTitle");
      if(qt){
          const mod = window.__subjectMeta.module ? (" : " + window.__subjectMeta.module) : "";
          qt.textContent = "Scanne pour r√©viser" + mod;
      }


      // Nettoyer les questions actuelles
      const tbody = document.getElementById("tbody-questions");
      tbody.innerHTML = "";

      // Recr√©er les lignes
      const qs = Array.isArray(obj.questions) ? obj.questions : [];
      qs.forEach(q => {
          const tr = createRow();
          tbody.appendChild(tr);

          const qnumSel = tr.querySelector(".qnum-select");
          const compSel = tr.querySelector(".comp-select");
          const methodSel = tr.querySelector(".method-select");
          const barInput = tr.querySelector(".bareme-input");
          const ptsInput = tr.querySelector(".points-input");
          const corrDiv = tr.querySelector(".corrige-div");
          const hiddenLevel = tr.querySelector(".level-select");

                    const qTextDiv = tr.querySelector(".question-texte-div");
          const repTA = tr.querySelector(".reponse-eleve-textarea");
if(q && q.qnum != null) qnumSel.value = String(q.qnum).trim();
          if(q && q.comp != null) compSel.value = String(q.comp).trim();
          // M√©thode uniquement utile pour C2 ; sinon on laisse "G√©n√©ral"
          if(q && q.method != null) methodSel.value = String(q.method).trim();
          if(q && q.bareme != null) barInput.value = Number(q.bareme) || "";
          // Par d√©faut on ne met pas de points ni de niveau (correction ensuite)
          ptsInput.value = (q && q.points != null) ? (Number(q.points) || "") : "";
          hiddenLevel.value = (q && q.level != null) ? String(q.level).trim() : "";
          // Attendu / corrig√©
          const attendu = (q && (q.attendu != null)) ? String(q.attendu) : "";
          const intitule = (q && (q.intitule != null)) ? String(q.intitule) : "";
          corrDiv.textContent = (attendu || "");

          // √ânonc√© (si pr√©sent dans le projet/sujet)
          if(qTextDiv){
              const qt = (q && (q.questionTexte != null)) ? String(q.questionTexte) : (intitule || "");
              if(qt && !qTextDiv.textContent.trim()) qTextDiv.textContent = qt;
          }

          // R√©ponse √©l√®ve (si pr√©sent dans un projet sauvegard√©)
          if(repTA && q && (q.reponseEleve != null)) repTA.value = String(q.reponseEleve);


          // Appliquer l'affichage m√©thode si besoin
          const wrap = tr.querySelector(".comp-wrapper");
          if(wrap){
              if(compSel.value === "C2") wrap.classList.add("show-method");
              else { wrap.classList.remove("show-method"); methodSel.value = "default"; }
          }
      });

      bindAllAutoResize();
      computeAll();
      saveAutoData();
      alert("Sujet import√© : " + (qs.length || 0) + " question(s).");
  }

  document.getElementById("btn-import-subject").addEventListener("click", () => {
      document.getElementById("file-input-subject").click();
  });

  document.getElementById("file-input-subject").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
          try{
              const obj = JSON.parse(ev.target.result);
              if(confirm("Importer ce sujet (cela remplacera les questions actuelles) ?")){
                  importSubjectJSON(obj);
              }
          }catch(err){
              alert("Erreur de lecture du sujet JSON");
          }
      };
      reader.readAsText(file);
      e.target.value = "";
  });

document.getElementById("btn-print").addEventListener("click", () => {
      // 1. Titres
      const textareas = document.querySelectorAll("textarea.title-main, textarea.title-section, textarea.th-input, textarea.comp-name-input, textarea#commentGlobal, textarea#nom, textarea#prenomEleve, textarea#classe, textarea#bank-input, textarea#rem-conseil, textarea.reponse-eleve-textarea");
      textareas.forEach(ta => {
          const div = document.createElement("div");
          div.textContent = ta.value;
          div.style.whiteSpace = "pre-wrap";
          div.className = "print-replace";

          if(ta.classList.contains("title-main")) {
              div.style.fontSize = "18pt"; div.style.textAlign = "center"; div.style.fontWeight = "bold";
          } else if(ta.classList.contains("title-section")) {
              div.style.fontSize = "12pt"; div.style.textAlign = "left"; div.style.fontWeight = "bold";
          } else if(ta.classList.contains("th-input")) {
              div.style.fontWeight = "bold"; div.style.textAlign = "center";
          } else if(ta.classList.contains("comp-name-input")) {
              div.style.textAlign = "left";
          } else {
              div.style.textAlign = "left"; div.style.border = "1px solid #ddd"; div.style.padding = "4px";
          }

          // Remplace le textarea par un div (√©vite les doublons √† l‚Äôimpression)
          window.__printSwap = window.__printSwap || [];
          window.__printSwap.push({ parent: ta.parentNode, textarea: ta, div: div });
          ta.parentNode.replaceChild(div, ta);
      });

      // 2. Rich Text Divs
      document.querySelectorAll(".corrige-div").forEach(d => {
           const printDiv = document.createElement("div");
           printDiv.innerHTML = d.innerHTML; 
           printDiv.className = "print-replace-rich"; 
           d.style.display = "none";
           d.parentNode.appendChild(printDiv);
      });


      // 2bis. Question (√©nonc√©) ‚Äì affichage propre √† l‚Äôimpression
      document.querySelectorAll(".question-texte-div").forEach(d => {
           const printDiv = document.createElement("div");
           printDiv.textContent = d.textContent;
           printDiv.className = "print-replace-question";
           printDiv.style.whiteSpace = "pre-wrap";
           printDiv.style.textAlign = "left";
           printDiv.style.border = "1px solid #ddd";
           printDiv.style.padding = "4px";
           printDiv.style.borderRadius = "4px";
           d.style.display = "none";
           d.parentNode.appendChild(printDiv);
      });

      // 3. Niveaux
      document.querySelectorAll(".level-select").forEach(input => {
          const row = input.closest("tr");
          const span = row.querySelector(".print-level-text");
          if(span) { span.textContent = input.value || "-"; span.style.display = "inline-block"; }
      });

      window.print();

      // RESET
      document.querySelectorAll(".print-level-text").forEach(s => s.style.display = "none");
      // Restaure les textarea remplac√©s
      (window.__printSwap || []).forEach(item => {
        if(item && item.div && item.div.parentNode) item.div.parentNode.replaceChild(item.textarea, item.div);
      });
      window.__printSwap = [];
      document.querySelectorAll(".print-replace-rich").forEach(div => div.remove());
      document.querySelectorAll(".print-replace-question").forEach(div => div.remove());
      document.querySelectorAll(".question-texte-div").forEach(d => d.style.display = "block");
      document.querySelectorAll(".corrige-div").forEach(d => d.style.display = "block");
  });

  function telechargerPageRemplie() {
      const NOM_BASE = "Eval_PSE"; // Nom court
      const prenomInput = document.getElementById("prenomEleve");
      const classeInput = document.getElementById("classe");
      
      let suffixe = "";
      if(classeInput && classeInput.value) suffixe += "_" + classeInput.value.trim();
      if(prenomInput && prenomInput.value) suffixe += "_" + prenomInput.value.trim();
      if(suffixe === "") suffixe = "_Eleve";
      
      const filename = `${NOM_BASE}${suffixe}.html`;

      document.querySelectorAll("input").forEach(input => {
          if (input.type === "checkbox" || input.type === "radio") {
              if (input.checked) input.setAttribute("checked", "checked");
              else input.removeAttribute("checked");
          } else {
              input.setAttribute("value", input.value);
          }
      });
      document.querySelectorAll("textarea").forEach(area => { area.textContent = area.value; });
      document.querySelectorAll("select").forEach(sel => {
          const options = sel.querySelectorAll("option");
          options.forEach(opt => {
              if (opt.selected) opt.setAttribute("selected", "selected");
              else opt.removeAttribute("selected");
          });
      });
      
      const docClone = document.documentElement.cloneNode(true);
      const htmlContent = "<!DOCTYPE html>\n" + docClone.outerHTML;
      const blob = new Blob([htmlContent], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
  }

  /* --- INIT --- */
  loadBank();
  loadAutoData();
  
  // Auto-resize for all multi-line fields (header, remediation, table, etc.)
  try{ bindAllAutoResize(); }catch(_){}
  document.querySelectorAll(".comp-points-input").forEach(input => {
      input.addEventListener("input", updateTotalFromBilan);
  });

  document.getElementById("tbody-questions").addEventListener("input", function(e) {
      if(e.target.classList.contains("corrige-div")) saveAutoData();
  });
  
  document.getElementById("commentGlobal").addEventListener("input", saveAutoData);
  
  ["nom","prenomEleve","classe","dateEval","noteMaxInput"].forEach(id => document.getElementById(id).addEventListener("input", computeAll));

  /* --- 9. COLLAGE SANS MISE EN FORME (contenteditable) --- */
  const PLAIN_PASTE_KEY = "plain_paste_v1";
  function getPlainPasteEnabled(){
      const v = localStorage.getItem(PLAIN_PASTE_KEY);
      return v === null ? true : v === "1";
  }
  function setPlainPasteEnabled(enabled){
      localStorage.setItem(PLAIN_PASTE_KEY, enabled ? "1" : "0");
  }
  function insertTextAtCursor(text){
      // Prefer execCommand when available (better undo behavior)
      try{
          if (document.execCommand && document.execCommand("insertText", false, text)) return;
      } catch(e){}
      const sel = window.getSelection ? window.getSelection() : null;
      if (!sel || !sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      range.deleteContents();
      range.insertNode(document.createTextNode(text));
      range.collapse(false);
      sel.removeAllRanges();
      sel.addRange(range);
  }

  const plainToggle = document.getElementById("plain-paste-toggle");
  if (plainToggle) {
      plainToggle.checked = getPlainPasteEnabled();
      plainToggle.addEventListener("change", () => setPlainPasteEnabled(plainToggle.checked));
  }

  document.addEventListener("paste", function(e){
      if (!getPlainPasteEnabled()) return;
      const t = e.target;
      if (!t) return;
      if (!(t.isContentEditable || (t.getAttribute && t.getAttribute("contenteditable") === "true"))) return;
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData("text/plain");
      insertTextAtCursor(text);
      // Recalcul + sauvegarde (l√©ger)
      try { saveAutoData(); } catch(_) {}
      try { computeAll(); } catch(_) {}
  }, true);


// ---- Global style for response areas (font size / color / line-height) ----
const RESP_STYLE_KEY = "grille_resp_style_v1";
function applyRespStyle(s){
  const root = document.documentElement;
  root.style.setProperty("--resp-font-size", (s.fontSize || 14) + "px");
  root.style.setProperty("--resp-color", s.color || "#111827");
  root.style.setProperty("--resp-line-height", String(s.lineHeight || 1.35));
  const sizeSel = document.getElementById("respFontSize");
  const colorInp = document.getElementById("respColor");
  const lhSel = document.getElementById("respLineHeight");
  if(sizeSel) sizeSel.value = String(s.fontSize || 14);
  if(colorInp) colorInp.value = s.color || "#111827";
  if(lhSel) lhSel.value = String(s.lineHeight || 1.35);
}
function loadRespStyle(){
  try{
    const raw = localStorage.getItem(RESP_STYLE_KEY);
    if(!raw) return {fontSize:14,color:"#111827",lineHeight:1.35};
    const s = JSON.parse(raw);
    return {fontSize:Number(s.fontSize)||14, color:s.color||"#111827", lineHeight:Number(s.lineHeight)||1.35};
  }catch(e){
    return {fontSize:14,color:"#111827",lineHeight:1.35};
  }
}
function saveRespStyle(s){
  localStorage.setItem(RESP_STYLE_KEY, JSON.stringify(s));
}
function bindRespStyleUI(){
  const sizeSel = document.getElementById("respFontSize");
  const colorInp = document.getElementById("respColor");
  const lhSel = document.getElementById("respLineHeight");
  const resetBtn = document.getElementById("respStyleReset");
  if(!sizeSel || !colorInp || !lhSel || !resetBtn) return;

  const s0 = loadRespStyle();
  applyRespStyle(s0);

  const onChange = () => {
    const s = {
      fontSize: Number(sizeSel.value)||14,
      color: String(colorInp.value||"#111827"),
      lineHeight: Number(lhSel.value)||1.35
    };
    applyRespStyle(s);
    saveRespStyle(s);
  };
  sizeSel.addEventListener("change", onChange);
  colorInp.addEventListener("input", onChange);
  lhSel.addEventListener("change", onChange);

  resetBtn.addEventListener("click", () => {
    const s = {fontSize:14,color:"#111827",lineHeight:1.35};
    applyRespStyle(s);
    saveRespStyle(s);
  });
}
document.addEventListener("DOMContentLoaded", bindRespStyleUI);


// ---- Rem√©diation (l√©ger, contr√¥lable) ----
function _parsePctFromEl(el){
  if(!el) return NaN;
  // supports <input> (value) and <div>/<span> (textContent)
  const raw = (typeof el.value === "string" && el.value !== "") ? el.value : (el.textContent || el.innerText || "");
  const cleaned = String(raw).replace(/%/g,"").trim().replace(",",".");
  const v = parseFloat(cleaned);
  return isNaN(v) ? NaN : v;
}
function _isAssessedComp(comp){
  const qEl = document.getElementById(comp+"_q");
  if(!qEl) return false;
  const t = String(qEl.textContent || "").trim();
  // Not assessed markers can be "-", "‚Äî" (em dash), or "‚Äì" (en dash)
  return t && t !== "-" && t !== "‚Äî" && t !== "‚Äì";
}
function getWeakestComps(){
  const comps = ["C1","C2","C3","C4","C5","C6"];
  const scored = [];
  comps.forEach(c=>{
    if(!_isAssessedComp(c)) return;
    const pctEl = document.getElementById(c+"_pct");
    const pct = _parsePctFromEl(pctEl);
    if(isNaN(pct)) return;
    scored.push({comp:c, pct:pct});
  });
  scored.sort((a,b)=>a.pct-b.pct);

  // R√®gle v31 :
  // - si >=3 comp√©tences <=50% : prendre les 3 plus faibles
  // - si 2 comp√©tences <=50% : prendre ces 2
  // - si 1 comp√©tence <=50% : prendre celle-ci + la suivante
  // - sinon : prendre les 2 plus faibles
  const failing = scored.filter(x => x.pct <= 50);
  let pick = [];
  if(failing.length >= 3){
    pick = failing.slice(0,3).map(x=>x.comp);
  }else if(failing.length === 2){
    pick = failing.slice(0,2).map(x=>x.comp);
  }else if(failing.length === 1){
    pick = [failing[0].comp];
    const next = scored.find(x=>x.comp !== failing[0].comp);
    if(next) pick.push(next.comp);
  }else{
    pick = scored.slice(0,2).map(x=>x.comp);
  }
  if(!pick.length) pick = ["C1"];
  return { list: pick, scored, failing };
}
function pickNotionForComp(comp){
  const meta = window.__subjectMeta || {};
  const map = meta.remediation_by_comp || {};
  const arr = Array.isArray(map[comp]) ? map[comp] : [];
  if(arr.length) return String(arr[0]);
  // fallback: module name
  if(meta.module) return String(meta.module);
  return "";
}

function getCompPct(comp){
  const el = document.getElementById(comp + "_pct");
  if(!el) return null;
  const raw = (el.textContent || "").trim().replace("%","").replace(",",".");
  const v = parseFloat(raw);
  return Number.isFinite(v) ? v : null;
}
function compIsUsed(comp){
  const q = document.getElementById(comp + "_q");
  if(!q) return true;
  const t = (q.textContent || "").trim();
  return t && t !== "-" && t !== "‚Äî";
}
function pickTopWeakest(n=2){
  const comps = ["C1","C2","C3","C4","C5","C6"];
  const arr = [];
  comps.forEach(c=>{
    if(!compIsUsed(c)) return;
    const pct = getCompPct(c);
    if(pct === null) return;
    arr.push({comp:c, pct});
  });
  arr.sort((a,b)=>a.pct-b.pct);
  return arr.slice(0,n).map(x=>x.comp);
}
function formatConseil(list){
  if(list.length >= 2) return `Travailler les comp√©tences ${list[0]} et ${list[1]}.`;
  if(list.length === 1) return `Travailler la comp√©tence ${list[0]}.`;
  return "";
}
function updateRemediationAuto(){
  const ta = document.getElementById("rem-conseil");
  if(!ta) return;
  const comps = pickTopWeakest(2);
  const auto = formatConseil(comps);
  const current = (ta.value || "").trim();
  const prevAuto = ta.dataset.autoValue || "";
  if(!current || current === prevAuto){
    ta.value = auto;
    ta.dataset.autoValue = auto;
    try{ bindAutoResize(ta); ta.dispatchEvent(new Event("input")); }catch(_){ }
    saveAutoData();
  }
}
document.addEventListener("DOMContentLoaded", () => {
  const ta = document.getElementById("rem-conseil");
  if(ta){
    ta.addEventListener("input", () => {
      // si l'utilisateur modifie manuellement, on ne r√©√©crase pas au prochain calcul
      const current = (ta.value || "").trim();
      if(current && current !== (ta.dataset.autoValue || "")){
        ta.dataset.manual = "1";
      }
    });
  }
  // Remplissage initial (sans forcer si d√©j√† saisi)
  updateRemediationAuto();
});
</script>

<section class="card" id="remediationCard">
  <div class="card-head">
    <h2>Rem√©diation</h2>
    </div>

  <div class="grid-2">
    <div>
      
      <div class="field">
        <label>Conseil</label>
        <textarea id="rem-conseil" class="auto-save auto-resize" placeholder="" data-key="remConseil" rows="2"></textarea>
      </div>

</div>

    <div class="qr-box">
      <div class="qr-title" id="qrTitle">Scanne le code QR ou utilise le lien pour r√©viser sur le site</div>
      <div class="qr-wrap">
        <svg class="qr-svg" version="1.1" xmlns="http://www.w3.org/2000/svg"><rect x="2mm" y="2mm" width="1mm" height="1mm"/><rect x="3mm" y="2mm" width="1mm" height="1mm"/><rect x="4mm" y="2mm" width="1mm" height="1mm"/><rect x="5mm" y="2mm" width="1mm" height="1mm"/><rect x="6mm" y="2mm" width="1mm" height="1mm"/><rect x="7mm" y="2mm" width="1mm" height="1mm"/><rect x="8mm" y="2mm" width="1mm" height="1mm"/><rect x="10mm" y="2mm" width="1mm" height="1mm"/><rect x="18mm" y="2mm" width="1mm" height="1mm"/><rect x="21mm" y="2mm" width="1mm" height="1mm"/><rect x="22mm" y="2mm" width="1mm" height="1mm"/><rect x="25mm" y="2mm" width="1mm" height="1mm"/><rect x="28mm" y="2mm" width="1mm" height="1mm"/><rect x="29mm" y="2mm" width="1mm" height="1mm"/><rect x="30mm" y="2mm" width="1mm" height="1mm"/><rect x="31mm" y="2mm" width="1mm" height="1mm"/><rect x="32mm" y="2mm" width="1mm" height="1mm"/><rect x="33mm" y="2mm" width="1mm" height="1mm"/><rect x="34mm" y="2mm" width="1mm" height="1mm"/><rect x="2mm" y="3mm" width="1mm" height="1mm"/><rect x="8mm" y="3mm" width="1mm" height="1mm"/><rect x="10mm" y="3mm" width="1mm" height="1mm"/><rect x="13mm" y="3mm" width="1mm" height="1mm"/><rect x="16mm" y="3mm" width="1mm" height="1mm"/><rect x="18mm" y="3mm" width="1mm" height="1mm"/><rect x="19mm" y="3mm" width="1mm" height="1mm"/><rect x="22mm" y="3mm" width="1mm" height="1mm"/><rect x="25mm" y="3mm" width="1mm" height="1mm"/><rect x="26mm" y="3mm" width="1mm" height="1mm"/><rect x="28mm" y="3mm" width="1mm" height="1mm"/><rect x="34mm" y="3mm" width="1mm" height="1mm"/><rect x="2mm" y="4mm" width="1mm" height="1mm"/><rect x="4mm" y="4mm" width="1mm" height="1mm"/><rect x="5mm" y="4mm" width="1mm" height="1mm"/><rect x="6mm" y="4mm" width="1mm" height="1mm"/><rect x="8mm" y="4mm" width="1mm" height="1mm"/><rect x="11mm" y="4mm" width="1mm" height="1mm"/><rect x="12mm" y="4mm" width="1mm" height="1mm"/><rect x="13mm" y="4mm" width="1mm" height="1mm"/><rect x="15mm" y="4mm" width="1mm" height="1mm"/><rect x="16mm" y="4mm" width="1mm" height="1mm"/><rect x="17mm" y="4mm" width="1mm" height="1mm"/><rect x="20mm" y="4mm" width="1mm" height="1mm"/><rect x="22mm" y="4mm" width="1mm" height="1mm"/><rect x="26mm" y="4mm" width="1mm" height="1mm"/><rect x="28mm" y="4mm" width="1mm" height="1mm"/><rect x="30mm" y="4mm" width="1mm" height="1mm"/><rect x="31mm" y="4mm" width="1mm" height="1mm"/><rect x="32mm" y="4mm" width="1mm" height="1mm"/><rect x="34mm" y="4mm" width="1mm" height="1mm"/><rect x="2mm" y="5mm" width="1mm" height="1mm"/><rect x="4mm" y="5mm" width="1mm" height="1mm"/><rect x="5mm" y="5mm" width="1mm" height="1mm"/><rect x="6mm" y="5mm" width="1mm" height="1mm"/><rect x="8mm" y="5mm" width="1mm" height="1mm"/><rect x="10mm" y="5mm" width="1mm" height="1mm"/><rect x="11mm" y="5mm" width="1mm" height="1mm"/><rect x="14mm" y="5mm" width="1mm" height="1mm"/><rect x="20mm" y="5mm" width="1mm" height="1mm"/><rect x="21mm" y="5mm" width="1mm" height="1mm"/><rect x="24mm" y="5mm" width="1mm" height="1mm"/><rect x="26mm" y="5mm" width="1mm" height="1mm"/><rect x="28mm" y="5mm" width="1mm" height="1mm"/><rect x="30mm" y="5mm" width="1mm" height="1mm"/><rect x="31mm" y="5mm" width="1mm" height="1mm"/><rect x="32mm" y="5mm" width="1mm" height="1mm"/><rect x="34mm" y="5mm" width="1mm" height="1mm"/><rect x="2mm" y="6mm" width="1mm" height="1mm"/><rect x="4mm" y="6mm" width="1mm" height="1mm"/><rect x="5mm" y="6mm" width="1mm" height="1mm"/><rect x="6mm" y="6mm" width="1mm" height="1mm"/><rect x="8mm" y="6mm" width="1mm" height="1mm"/><rect x="12mm" y="6mm" width="1mm" height="1mm"/><rect x="14mm" y="6mm" width="1mm" height="1mm"/><rect x="15mm" y="6mm" width="1mm" height="1mm"/><rect x="18mm" y="6mm" width="1mm" height="1mm"/><rect x="19mm" y="6mm" width="1mm" height="1mm"/><rect x="20mm" y="6mm" width="1mm" height="1mm"/><rect x="23mm" y="6mm" width="1mm" height="1mm"/><rect x="26mm" y="6mm" width="1mm" height="1mm"/><rect x="28mm" y="6mm" width="1mm" height="1mm"/><rect x="30mm" y="6mm" width="1mm" height="1mm"/><rect x="31mm" y="6mm" width="1mm" height="1mm"/><rect x="32mm" y="6mm" width="1mm" height="1mm"/><rect x="34mm" y="6mm" width="1mm" height="1mm"/><rect x="2mm" y="7mm" width="1mm" height="1mm"/><rect x="8mm" y="7mm" width="1mm" height="1mm"/><rect x="11mm" y="7mm" width="1mm" height="1mm"/><rect x="12mm" y="7mm" width="1mm" height="1mm"/><rect x="14mm" y="7mm" width="1mm" height="1mm"/><rect x="16mm" y="7mm" width="1mm" height="1mm"/><rect x="17mm" y="7mm" width="1mm" height="1mm"/><rect x="18mm" y="7mm" width="1mm" height="1mm"/><rect x="20mm" y="7mm" width="1mm" height="1mm"/><rect x="23mm" y="7mm" width="1mm" height="1mm"/><rect x="28mm" y="7mm" width="1mm" height="1mm"/><rect x="34mm" y="7mm" width="1mm" height="1mm"/><rect x="2mm" y="8mm" width="1mm" height="1mm"/><rect x="3mm" y="8mm" width="1mm" height="1mm"/><rect x="4mm" y="8mm" width="1mm" height="1mm"/><rect x="5mm" y="8mm" width="1mm" height="1mm"/><rect x="6mm" y="8mm" width="1mm" height="1mm"/><rect x="7mm" y="8mm" width="1mm" height="1mm"/><rect x="8mm" y="8mm" width="1mm" height="1mm"/><rect x="10mm" y="8mm" width="1mm" height="1mm"/><rect x="12mm" y="8mm" width="1mm" height="1mm"/><rect x="14mm" y="8mm" width="1mm" height="1mm"/><rect x="16mm" y="8mm" width="1mm" height="1mm"/><rect x="18mm" y="8mm" width="1mm" height="1mm"/><rect x="20mm" y="8mm" width="1mm" height="1mm"/><rect x="22mm" y="8mm" width="1mm" height="1mm"/><rect x="24mm" y="8mm" width="1mm" height="1mm"/><rect x="26mm" y="8mm" width="1mm" height="1mm"/><rect x="28mm" y="8mm" width="1mm" height="1mm"/><rect x="29mm" y="8mm" width="1mm" height="1mm"/><rect x="30mm" y="8mm" width="1mm" height="1mm"/><rect x="31mm" y="8mm" width="1mm" height="1mm"/><rect x="32mm" y="8mm" width="1mm" height="1mm"/><rect x="33mm" y="8mm" width="1mm" height="1mm"/><rect x="34mm" y="8mm" width="1mm" height="1mm"/><rect x="10mm" y="9mm" width="1mm" height="1mm"/><rect x="11mm" y="9mm" width="1mm" height="1mm"/><rect x="16mm" y="9mm" width="1mm" height="1mm"/><rect x="17mm" y="9mm" width="1mm" height="1mm"/><rect x="18mm" y="9mm" width="1mm" height="1mm"/><rect x="19mm" y="9mm" width="1mm" height="1mm"/><rect x="21mm" y="9mm" width="1mm" height="1mm"/><rect x="26mm" y="9mm" width="1mm" height="1mm"/><rect x="2mm" y="10mm" width="1mm" height="1mm"/><rect x="4mm" y="10mm" width="1mm" height="1mm"/><rect x="5mm" y="10mm" width="1mm" height="1mm"/><rect x="7mm" y="10mm" width="1mm" height="1mm"/><rect x="8mm" y="10mm" width="1mm" height="1mm"/><rect x="9mm" y="10mm" width="1mm" height="1mm"/><rect x="16mm" y="10mm" width="1mm" height="1mm"/><rect x="17mm" y="10mm" width="1mm" height="1mm"/><rect x="18mm" y="10mm" width="1mm" height="1mm"/><rect x="19mm" y="10mm" width="1mm" height="1mm"/><rect x="20mm" y="10mm" width="1mm" height="1mm"/><rect x="23mm" y="10mm" width="1mm" height="1mm"/><rect x="25mm" y="10mm" width="1mm" height="1mm"/><rect x="28mm" y="10mm" width="1mm" height="1mm"/><rect x="31mm" y="10mm" width="1mm" height="1mm"/><rect x="33mm" y="10mm" width="1mm" height="1mm"/><rect x="34mm" y="10mm" width="1mm" height="1mm"/><rect x="2mm" y="11mm" width="1mm" height="1mm"/><rect x="3mm" y="11mm" width="1mm" height="1mm"/><rect x="5mm" y="11mm" width="1mm" height="1mm"/><rect x="6mm" y="11mm" width="1mm" height="1mm"/><rect x="10mm" y="11mm" width="1mm" height="1mm"/><rect x="14mm" y="11mm" width="1mm" height="1mm"/><rect x="15mm" y="11mm" width="1mm" height="1mm"/><rect x="18mm" y="11mm" width="1mm" height="1mm"/><rect x="19mm" y="11mm" width="1mm" height="1mm"/><rect x="20mm" y="11mm" width="1mm" height="1mm"/><rect x="21mm" y="11mm" width="1mm" height="1mm"/><rect x="22mm" y="11mm" width="1mm" height="1mm"/><rect x="24mm" y="11mm" width="1mm" height="1mm"/><rect x="25mm" y="11mm" width="1mm" height="1mm"/><rect x="28mm" y="11mm" width="1mm" height="1mm"/><rect x="29mm" y="11mm" width="1mm" height="1mm"/><rect x="31mm" y="11mm" width="1mm" height="1mm"/><rect x="32mm" y="11mm" width="1mm" height="1mm"/><rect x="34mm" y="11mm" width="1mm" height="1mm"/><rect x="3mm" y="12mm" width="1mm" height="1mm"/><rect x="4mm" y="12mm" width="1mm" height="1mm"/><rect x="5mm" y="12mm" width="1mm" height="1mm"/><rect x="7mm" y="12mm" width="1mm" height="1mm"/><rect x="8mm" y="12mm" width="1mm" height="1mm"/><rect x="9mm" y="12mm" width="1mm" height="1mm"/><rect x="10mm" y="12mm" width="1mm" height="1mm"/><rect x="14mm" y="12mm" width="1mm" height="1mm"/><rect x="15mm" y="12mm" width="1mm" height="1mm"/><rect x="20mm" y="12mm" width="1mm" height="1mm"/><rect x="23mm" y="12mm" width="1mm" height="1mm"/><rect x="24mm" y="12mm" width="1mm" height="1mm"/><rect x="25mm" y="12mm" width="1mm" height="1mm"/><rect x="29mm" y="12mm" width="1mm" height="1mm"/><rect x="30mm" y="12mm" width="1mm" height="1mm"/><rect x="31mm" y="12mm" width="1mm" height="1mm"/><rect x="33mm" y="12mm" width="1mm" height="1mm"/><rect x="34mm" y="12mm" width="1mm" height="1mm"/><rect x="6mm" y="13mm" width="1mm" height="1mm"/><rect x="10mm" y="13mm" width="1mm" height="1mm"/><rect x="11mm" y="13mm" width="1mm" height="1mm"/><rect x="17mm" y="13mm" width="1mm" height="1mm"/><rect x="18mm" y="13mm" width="1mm" height="1mm"/><rect x="19mm" y="13mm" width="1mm" height="1mm"/><rect x="21mm" y="13mm" width="1mm" height="1mm"/><rect x="25mm" y="13mm" width="1mm" height="1mm"/><rect x="26mm" y="13mm" width="1mm" height="1mm"/><rect x="29mm" y="13mm" width="1mm" height="1mm"/><rect x="31mm" y="13mm" width="1mm" height="1mm"/><rect x="2mm" y="14mm" width="1mm" height="1mm"/><rect x="5mm" y="14mm" width="1mm" height="1mm"/><rect x="6mm" y="14mm" width="1mm" height="1mm"/><rect x="8mm" y="14mm" width="1mm" height="1mm"/><rect x="10mm" y="14mm" width="1mm" height="1mm"/><rect x="11mm" y="14mm" width="1mm" height="1mm"/><rect x="14mm" y="14mm" width="1mm" height="1mm"/><rect x="16mm" y="14mm" width="1mm" height="1mm"/><rect x="17mm" y="14mm" width="1mm" height="1mm"/><rect x="18mm" y="14mm" width="1mm" height="1mm"/><rect x="26mm" y="14mm" width="1mm" height="1mm"/><rect x="27mm" y="14mm" width="1mm" height="1mm"/><rect x="29mm" y="14mm" width="1mm" height="1mm"/><rect x="30mm" y="14mm" width="1mm" height="1mm"/><rect x="31mm" y="14mm" width="1mm" height="1mm"/><rect x="33mm" y="14mm" width="1mm" height="1mm"/><rect x="34mm" y="14mm" width="1mm" height="1mm"/><rect x="5mm" y="15mm" width="1mm" height="1mm"/><rect x="11mm" y="15mm" width="1mm" height="1mm"/><rect x="13mm" y="15mm" width="1mm" height="1mm"/><rect x="14mm" y="15mm" width="1mm" height="1mm"/><rect x="16mm" y="15mm" width="1mm" height="1mm"/><rect x="19mm" y="15mm" width="1mm" height="1mm"/><rect x="22mm" y="15mm" width="1mm" height="1mm"/><rect x="27mm" y="15mm" width="1mm" height="1mm"/><rect x="29mm" y="15mm" width="1mm" height="1mm"/><rect x="33mm" y="15mm" width="1mm" height="1mm"/><rect x="3mm" y="16mm" width="1mm" height="1mm"/><rect x="5mm" y="16mm" width="1mm" height="1mm"/><rect x="6mm" y="16mm" width="1mm" height="1mm"/><rect x="8mm" y="16mm" width="1mm" height="1mm"/><rect x="9mm" y="16mm" width="1mm" height="1mm"/><rect x="10mm" y="16mm" width="1mm" height="1mm"/><rect x="12mm" y="16mm" width="1mm" height="1mm"/><rect x="16mm" y="16mm" width="1mm" height="1mm"/><rect x="20mm" y="16mm" width="1mm" height="1mm"/><rect x="21mm" y="16mm" width="1mm" height="1mm"/><rect x="22mm" y="16mm" width="1mm" height="1mm"/><rect x="28mm" y="16mm" width="1mm" height="1mm"/><rect x="29mm" y="16mm" width="1mm" height="1mm"/><rect x="31mm" y="16mm" width="1mm" height="1mm"/><rect x="2mm" y="17mm" width="1mm" height="1mm"/><rect x="5mm" y="17mm" width="1mm" height="1mm"/><rect x="6mm" y="17mm" width="1mm" height="1mm"/><rect x="10mm" y="17mm" width="1mm" height="1mm"/><rect x="11mm" y="17mm" width="1mm" height="1mm"/><rect x="13mm" y="17mm" width="1mm" height="1mm"/><rect x="14mm" y="17mm" width="1mm" height="1mm"/><rect x="15mm" y="17mm" width="1mm" height="1mm"/><rect x="16mm" y="17mm" width="1mm" height="1mm"/><rect x="17mm" y="17mm" width="1mm" height="1mm"/><rect x="21mm" y="17mm" width="1mm" height="1mm"/><rect x="22mm" y="17mm" width="1mm" height="1mm"/><rect x="23mm" y="17mm" width="1mm" height="1mm"/><rect x="25mm" y="17mm" width="1mm" height="1mm"/><rect x="26mm" y="17mm" width="1mm" height="1mm"/><rect x="27mm" y="17mm" width="1mm" height="1mm"/><rect x="28mm" y="17mm" width="1mm" height="1mm"/><rect x="31mm" y="17mm" width="1mm" height="1mm"/><rect x="32mm" y="17mm" width="1mm" height="1mm"/><rect x="2mm" y="18mm" width="1mm" height="1mm"/><rect x="6mm" y="18mm" width="1mm" height="1mm"/><rect x="8mm" y="18mm" width="1mm" height="1mm"/><rect x="14mm" y="18mm" width="1mm" height="1mm"/><rect x="16mm" y="18mm" width="1mm" height="1mm"/><rect x="18mm" y="18mm" width="1mm" height="1mm"/><rect x="20mm" y="18mm" width="1mm" height="1mm"/><rect x="21mm" y="18mm" width="1mm" height="1mm"/><rect x="22mm" y="18mm" width="1mm" height="1mm"/><rect x="23mm" y="18mm" width="1mm" height="1mm"/><rect x="24mm" y="18mm" width="1mm" height="1mm"/><rect x="25mm" y="18mm" width="1mm" height="1mm"/><rect x="26mm" y="18mm" width="1mm" height="1mm"/><rect x="27mm" y="18mm" width="1mm" height="1mm"/><rect x="28mm" y="18mm" width="1mm" height="1mm"/><rect x="30mm" y="18mm" width="1mm" height="1mm"/><rect x="31mm" y="18mm" width="1mm" height="1mm"/><rect x="32mm" y="18mm" width="1mm" height="1mm"/><rect x="2mm" y="19mm" width="1mm" height="1mm"/><rect x="3mm" y="19mm" width="1mm" height="1mm"/><rect x="14mm" y="19mm" width="1mm" height="1mm"/><rect x="17mm" y="19mm" width="1mm" height="1mm"/><rect x="22mm" y="19mm" width="1mm" height="1mm"/><rect x="23mm" y="19mm" width="1mm" height="1mm"/><rect x="24mm" y="19mm" width="1mm" height="1mm"/><rect x="25mm" y="19mm" width="1mm" height="1mm"/><rect x="26mm" y="19mm" width="1mm" height="1mm"/><rect x="28mm" y="19mm" width="1mm" height="1mm"/><rect x="30mm" y="19mm" width="1mm" height="1mm"/><rect x="31mm" y="19mm" width="1mm" height="1mm"/><rect x="33mm" y="19mm" width="1mm" height="1mm"/><rect x="34mm" y="19mm" width="1mm" height="1mm"/><rect x="2mm" y="20mm" width="1mm" height="1mm"/><rect x="6mm" y="20mm" width="1mm" height="1mm"/><rect x="8mm" y="20mm" width="1mm" height="1mm"/><rect x="11mm" y="20mm" width="1mm" height="1mm"/><rect x="12mm" y="20mm" width="1mm" height="1mm"/><rect x="13mm" y="20mm" width="1mm" height="1mm"/><rect x="14mm" y="20mm" width="1mm" height="1mm"/><rect x="16mm" y="20mm" width="1mm" height="1mm"/><rect x="17mm" y="20mm" width="1mm" height="1mm"/><rect x="18mm" y="20mm" width="1mm" height="1mm"/><rect x="20mm" y="20mm" width="1mm" height="1mm"/><rect x="22mm" y="20mm" width="1mm" height="1mm"/><rect x="24mm" y="20mm" width="1mm" height="1mm"/><rect x="27mm" y="20mm" width="1mm" height="1mm"/><rect x="29mm" y="20mm" width="1mm" height="1mm"/><rect x="30mm" y="20mm" width="1mm" height="1mm"/><rect x="32mm" y="20mm" width="1mm" height="1mm"/><rect x="33mm" y="20mm" width="1mm" height="1mm"/><rect x="2mm" y="21mm" width="1mm" height="1mm"/><rect x="3mm" y="21mm" width="1mm" height="1mm"/><rect x="4mm" y="21mm" width="1mm" height="1mm"/><rect x="6mm" y="21mm" width="1mm" height="1mm"/><rect x="7mm" y="21mm" width="1mm" height="1mm"/><rect x="11mm" y="21mm" width="1mm" height="1mm"/><rect x="12mm" y="21mm" width="1mm" height="1mm"/><rect x="14mm" y="21mm" width="1mm" height="1mm"/><rect x="15mm" y="21mm" width="1mm" height="1mm"/><rect x="16mm" y="21mm" width="1mm" height="1mm"/><rect x="19mm" y="21mm" width="1mm" height="1mm"/><rect x="20mm" y="21mm" width="1mm" height="1mm"/><rect x="21mm" y="21mm" width="1mm" height="1mm"/><rect x="22mm" y="21mm" width="1mm" height="1mm"/><rect x="24mm" y="21mm" width="1mm" height="1mm"/><rect x="25mm" y="21mm" width="1mm" height="1mm"/><rect x="26mm" y="21mm" width="1mm" height="1mm"/><rect x="28mm" y="21mm" width="1mm" height="1mm"/><rect x="30mm" y="21mm" width="1mm" height="1mm"/><rect x="33mm" y="21mm" width="1mm" height="1mm"/><rect x="34mm" y="21mm" width="1mm" height="1mm"/><rect x="3mm" y="22mm" width="1mm" height="1mm"/><rect x="4mm" y="22mm" width="1mm" height="1mm"/><rect x="5mm" y="22mm" width="1mm" height="1mm"/><rect x="6mm" y="22mm" width="1mm" height="1mm"/><rect x="7mm" y="22mm" width="1mm" height="1mm"/><rect x="8mm" y="22mm" width="1mm" height="1mm"/><rect x="9mm" y="22mm" width="1mm" height="1mm"/><rect x="10mm" y="22mm" width="1mm" height="1mm"/><rect x="11mm" y="22mm" width="1mm" height="1mm"/><rect x="14mm" y="22mm" width="1mm" height="1mm"/><rect x="16mm" y="22mm" width="1mm" height="1mm"/><rect x="17mm" y="22mm" width="1mm" height="1mm"/><rect x="18mm" y="22mm" width="1mm" height="1mm"/><rect x="21mm" y="22mm" width="1mm" height="1mm"/><rect x="31mm" y="22mm" width="1mm" height="1mm"/><rect x="32mm" y="22mm" width="1mm" height="1mm"/><rect x="2mm" y="23mm" width="1mm" height="1mm"/><rect x="3mm" y="23mm" width="1mm" height="1mm"/><rect x="4mm" y="23mm" width="1mm" height="1mm"/><rect x="5mm" y="23mm" width="1mm" height="1mm"/><rect x="7mm" y="23mm" width="1mm" height="1mm"/><rect x="9mm" y="23mm" width="1mm" height="1mm"/><rect x="13mm" y="23mm" width="1mm" height="1mm"/><rect x="15mm" y="23mm" width="1mm" height="1mm"/><rect x="17mm" y="23mm" width="1mm" height="1mm"/><rect x="18mm" y="23mm" width="1mm" height="1mm"/><rect x="21mm" y="23mm" width="1mm" height="1mm"/><rect x="24mm" y="23mm" width="1mm" height="1mm"/><rect x="25mm" y="23mm" width="1mm" height="1mm"/><rect x="28mm" y="23mm" width="1mm" height="1mm"/><rect x="31mm" y="23mm" width="1mm" height="1mm"/><rect x="34mm" y="23mm" width="1mm" height="1mm"/><rect x="4mm" y="24mm" width="1mm" height="1mm"/><rect x="5mm" y="24mm" width="1mm" height="1mm"/><rect x="6mm" y="24mm" width="1mm" height="1mm"/><rect x="8mm" y="24mm" width="1mm" height="1mm"/><rect x="10mm" y="24mm" width="1mm" height="1mm"/><rect x="13mm" y="24mm" width="1mm" height="1mm"/><rect x="15mm" y="24mm" width="1mm" height="1mm"/><rect x="16mm" y="24mm" width="1mm" height="1mm"/><rect x="17mm" y="24mm" width="1mm" height="1mm"/><rect x="19mm" y="24mm" width="1mm" height="1mm"/><rect x="20mm" y="24mm" width="1mm" height="1mm"/><rect x="25mm" y="24mm" width="1mm" height="1mm"/><rect x="26mm" y="24mm" width="1mm" height="1mm"/><rect x="28mm" y="24mm" width="1mm" height="1mm"/><rect x="30mm" y="24mm" width="1mm" height="1mm"/><rect x="31mm" y="24mm" width="1mm" height="1mm"/><rect x="32mm" y="24mm" width="1mm" height="1mm"/><rect x="33mm" y="24mm" width="1mm" height="1mm"/><rect x="34mm" y="24mm" width="1mm" height="1mm"/><rect x="3mm" y="25mm" width="1mm" height="1mm"/><rect x="4mm" y="25mm" width="1mm" height="1mm"/><rect x="6mm" y="25mm" width="1mm" height="1mm"/><rect x="7mm" y="25mm" width="1mm" height="1mm"/><rect x="9mm" y="25mm" width="1mm" height="1mm"/><rect x="12mm" y="25mm" width="1mm" height="1mm"/><rect x="14mm" y="25mm" width="1mm" height="1mm"/><rect x="17mm" y="25mm" width="1mm" height="1mm"/><rect x="20mm" y="25mm" width="1mm" height="1mm"/><rect x="21mm" y="25mm" width="1mm" height="1mm"/><rect x="22mm" y="25mm" width="1mm" height="1mm"/><rect x="26mm" y="25mm" width="1mm" height="1mm"/><rect x="27mm" y="25mm" width="1mm" height="1mm"/><rect x="29mm" y="25mm" width="1mm" height="1mm"/><rect x="31mm" y="25mm" width="1mm" height="1mm"/><rect x="34mm" y="25mm" width="1mm" height="1mm"/><rect x="2mm" y="26mm" width="1mm" height="1mm"/><rect x="5mm" y="26mm" width="1mm" height="1mm"/><rect x="7mm" y="26mm" width="1mm" height="1mm"/><rect x="8mm" y="26mm" width="1mm" height="1mm"/><rect x="9mm" y="26mm" width="1mm" height="1mm"/><rect x="15mm" y="26mm" width="1mm" height="1mm"/><rect x="16mm" y="26mm" width="1mm" height="1mm"/><rect x="19mm" y="26mm" width="1mm" height="1mm"/><rect x="22mm" y="26mm" width="1mm" height="1mm"/><rect x="24mm" y="26mm" width="1mm" height="1mm"/><rect x="26mm" y="26mm" width="1mm" height="1mm"/><rect x="27mm" y="26mm" width="1mm" height="1mm"/><rect x="28mm" y="26mm" width="1mm" height="1mm"/><rect x="29mm" y="26mm" width="1mm" height="1mm"/><rect x="30mm" y="26mm" width="1mm" height="1mm"/><rect x="31mm" y="26mm" width="1mm" height="1mm"/><rect x="10mm" y="27mm" width="1mm" height="1mm"/><rect x="11mm" y="27mm" width="1mm" height="1mm"/><rect x="13mm" y="27mm" width="1mm" height="1mm"/><rect x="15mm" y="27mm" width="1mm" height="1mm"/><rect x="17mm" y="27mm" width="1mm" height="1mm"/><rect x="18mm" y="27mm" width="1mm" height="1mm"/><rect x="21mm" y="27mm" width="1mm" height="1mm"/><rect x="25mm" y="27mm" width="1mm" height="1mm"/><rect x="26mm" y="27mm" width="1mm" height="1mm"/><rect x="30mm" y="27mm" width="1mm" height="1mm"/><rect x="31mm" y="27mm" width="1mm" height="1mm"/><rect x="2mm" y="28mm" width="1mm" height="1mm"/><rect x="3mm" y="28mm" width="1mm" height="1mm"/><rect x="4mm" y="28mm" width="1mm" height="1mm"/><rect x="5mm" y="28mm" width="1mm" height="1mm"/><rect x="6mm" y="28mm" width="1mm" height="1mm"/><rect x="7mm" y="28mm" width="1mm" height="1mm"/><rect x="8mm" y="28mm" width="1mm" height="1mm"/><rect x="10mm" y="28mm" width="1mm" height="1mm"/><rect x="13mm" y="28mm" width="1mm" height="1mm"/><rect x="16mm" y="28mm" width="1mm" height="1mm"/><rect x="18mm" y="28mm" width="1mm" height="1mm"/><rect x="19mm" y="28mm" width="1mm" height="1mm"/><rect x="20mm" y="28mm" width="1mm" height="1mm"/><rect x="21mm" y="28mm" width="1mm" height="1mm"/><rect x="24mm" y="28mm" width="1mm" height="1mm"/><rect x="25mm" y="28mm" width="1mm" height="1mm"/><rect x="26mm" y="28mm" width="1mm" height="1mm"/><rect x="28mm" y="28mm" width="1mm" height="1mm"/><rect x="30mm" y="28mm" width="1mm" height="1mm"/><rect x="2mm" y="29mm" width="1mm" height="1mm"/><rect x="8mm" y="29mm" width="1mm" height="1mm"/><rect x="10mm" y="29mm" width="1mm" height="1mm"/><rect x="12mm" y="29mm" width="1mm" height="1mm"/><rect x="13mm" y="29mm" width="1mm" height="1mm"/><rect x="14mm" y="29mm" width="1mm" height="1mm"/><rect x="15mm" y="29mm" width="1mm" height="1mm"/><rect x="18mm" y="29mm" width="1mm" height="1mm"/><rect x="19mm" y="29mm" width="1mm" height="1mm"/><rect x="20mm" y="29mm" width="1mm" height="1mm"/><rect x="21mm" y="29mm" width="1mm" height="1mm"/><rect x="22mm" y="29mm" width="1mm" height="1mm"/><rect x="23mm" y="29mm" width="1mm" height="1mm"/><rect x="25mm" y="29mm" width="1mm" height="1mm"/><rect x="26mm" y="29mm" width="1mm" height="1mm"/><rect x="30mm" y="29mm" width="1mm" height="1mm"/><rect x="31mm" y="29mm" width="1mm" height="1mm"/><rect x="32mm" y="29mm" width="1mm" height="1mm"/><rect x="34mm" y="29mm" width="1mm" height="1mm"/><rect x="2mm" y="30mm" width="1mm" height="1mm"/><rect x="4mm" y="30mm" width="1mm" height="1mm"/><rect x="5mm" y="30mm" width="1mm" height="1mm"/><rect x="6mm" y="30mm" width="1mm" height="1mm"/><rect x="8mm" y="30mm" width="1mm" height="1mm"/><rect x="12mm" y="30mm" width="1mm" height="1mm"/><rect x="14mm" y="30mm" width="1mm" height="1mm"/><rect x="15mm" y="30mm" width="1mm" height="1mm"/><rect x="16mm" y="30mm" width="1mm" height="1mm"/><rect x="18mm" y="30mm" width="1mm" height="1mm"/><rect x="19mm" y="30mm" width="1mm" height="1mm"/><rect x="20mm" y="30mm" width="1mm" height="1mm"/><rect x="21mm" y="30mm" width="1mm" height="1mm"/><rect x="22mm" y="30mm" width="1mm" height="1mm"/><rect x="24mm" y="30mm" width="1mm" height="1mm"/><rect x="25mm" y="30mm" width="1mm" height="1mm"/><rect x="26mm" y="30mm" width="1mm" height="1mm"/><rect x="27mm" y="30mm" width="1mm" height="1mm"/><rect x="28mm" y="30mm" width="1mm" height="1mm"/><rect x="29mm" y="30mm" width="1mm" height="1mm"/><rect x="30mm" y="30mm" width="1mm" height="1mm"/><rect x="32mm" y="30mm" width="1mm" height="1mm"/><rect x="33mm" y="30mm" width="1mm" height="1mm"/><rect x="2mm" y="31mm" width="1mm" height="1mm"/><rect x="4mm" y="31mm" width="1mm" height="1mm"/><rect x="5mm" y="31mm" width="1mm" height="1mm"/><rect x="6mm" y="31mm" width="1mm" height="1mm"/><rect x="8mm" y="31mm" width="1mm" height="1mm"/><rect x="10mm" y="31mm" width="1mm" height="1mm"/><rect x="11mm" y="31mm" width="1mm" height="1mm"/><rect x="12mm" y="31mm" width="1mm" height="1mm"/><rect x="14mm" y="31mm" width="1mm" height="1mm"/><rect x="16mm" y="31mm" width="1mm" height="1mm"/><rect x="18mm" y="31mm" width="1mm" height="1mm"/><rect x="19mm" y="31mm" width="1mm" height="1mm"/><rect x="21mm" y="31mm" width="1mm" height="1mm"/><rect x="22mm" y="31mm" width="1mm" height="1mm"/><rect x="23mm" y="31mm" width="1mm" height="1mm"/><rect x="26mm" y="31mm" width="1mm" height="1mm"/><rect x="29mm" y="31mm" width="1mm" height="1mm"/><rect x="31mm" y="31mm" width="1mm" height="1mm"/><rect x="34mm" y="31mm" width="1mm" height="1mm"/><rect x="2mm" y="32mm" width="1mm" height="1mm"/><rect x="4mm" y="32mm" width="1mm" height="1mm"/><rect x="5mm" y="32mm" width="1mm" height="1mm"/><rect x="6mm" y="32mm" width="1mm" height="1mm"/><rect x="8mm" y="32mm" width="1mm" height="1mm"/><rect x="10mm" y="32mm" width="1mm" height="1mm"/><rect x="12mm" y="32mm" width="1mm" height="1mm"/><rect x="14mm" y="32mm" width="1mm" height="1mm"/><rect x="17mm" y="32mm" width="1mm" height="1mm"/><rect x="18mm" y="32mm" width="1mm" height="1mm"/><rect x="19mm" y="32mm" width="1mm" height="1mm"/><rect x="22mm" y="32mm" width="1mm" height="1mm"/><rect x="24mm" y="32mm" width="1mm" height="1mm"/><rect x="26mm" y="32mm" width="1mm" height="1mm"/><rect x="27mm" y="32mm" width="1mm" height="1mm"/><rect x="28mm" y="32mm" width="1mm" height="1mm"/><rect x="29mm" y="32mm" width="1mm" height="1mm"/><rect x="32mm" y="32mm" width="1mm" height="1mm"/><rect x="2mm" y="33mm" width="1mm" height="1mm"/><rect x="8mm" y="33mm" width="1mm" height="1mm"/><rect x="19mm" y="33mm" width="1mm" height="1mm"/><rect x="21mm" y="33mm" width="1mm" height="1mm"/><rect x="22mm" y="33mm" width="1mm" height="1mm"/><rect x="24mm" y="33mm" width="1mm" height="1mm"/><rect x="26mm" y="33mm" width="1mm" height="1mm"/><rect x="29mm" y="33mm" width="1mm" height="1mm"/><rect x="30mm" y="33mm" width="1mm" height="1mm"/><rect x="31mm" y="33mm" width="1mm" height="1mm"/><rect x="34mm" y="33mm" width="1mm" height="1mm"/><rect x="2mm" y="34mm" width="1mm" height="1mm"/><rect x="3mm" y="34mm" width="1mm" height="1mm"/><rect x="4mm" y="34mm" width="1mm" height="1mm"/><rect x="5mm" y="34mm" width="1mm" height="1mm"/><rect x="6mm" y="34mm" width="1mm" height="1mm"/><rect x="7mm" y="34mm" width="1mm" height="1mm"/><rect x="8mm" y="34mm" width="1mm" height="1mm"/><rect x="10mm" y="34mm" width="1mm" height="1mm"/><rect x="12mm" y="34mm" width="1mm" height="1mm"/><rect x="16mm" y="34mm" width="1mm" height="1mm"/><rect x="19mm" y="34mm" width="1mm" height="1mm"/><rect x="20mm" y="34mm" width="1mm" height="1mm"/><rect x="21mm" y="34mm" width="1mm" height="1mm"/><rect x="23mm" y="34mm" width="1mm" height="1mm"/><rect x="25mm" y="34mm" width="1mm" height="1mm"/><rect x="27mm" y="34mm" width="1mm" height="1mm"/><rect x="30mm" y="34mm" width="1mm" height="1mm"/><rect x="32mm" y="34mm" width="1mm" height="1mm"/></svg>
      </div>
      <div class="qr-url">
        <div class="qr-url-label">Lien :</div>
        <div class="qr-url-value">https://preventionsanteenvironnement.github.io/PSE/</div>
      </div>
    </div>
  </div>

  <div class="card bank-card rembank-card" id="rembankCard" style="margin-top:14px;">
    <h2>Banque de rem√©diation</h2>

    <div class="bank-hint">Clique sur une carte pour l‚Äôajouter au champ Conseil.</div>

    <div class="bank-input-group">
      <select id="rembank-comp" class="bank-comp-select" title="Cat√©gorie">
        <option value="AUTO">Auto</option>
        <option value="C1">C1</option>
        <option value="C2">C2</option>
        <option value="C3">C3</option>
        <option value="C4">C4</option>
        <option value="C5">C5</option>
        <option value="C6">C6</option>
        <option value="REV">R√©vision</option>
      </select>

      <input id="rembank-input" class="bank-input" type="text" placeholder="Ajouter une rem√©diation..." />

      <button id="rembank-add" class="btn primary" type="button">Ajouter √† la banque</button>
      <button id="rembank-update" class="btn" type="button" disabled>Mettre √† jour</button>
      <button id="rembank-cancel" class="btn" type="button" disabled>Annuler</button>
      <button id="rembank-clear" class="btn" type="button">Vider le champ</button>
    </div>

    <div class="bank-plus-toolbar">
      <div class="bank-filters" id="rembank-filters">
        <button class="bank-pill active" data-filter="ALL" type="button">Tous</button>
        <button class="bank-pill" data-filter="C1" type="button">C1</button>
        <button class="bank-pill" data-filter="C2" type="button">C2</button>
        <button class="bank-pill" data-filter="C3" type="button">C3</button>
        <button class="bank-pill" data-filter="C4" type="button">C4</button>
        <button class="bank-pill" data-filter="C5" type="button">C5</button>
        <button class="bank-pill" data-filter="C6" type="button">C6</button>
        <button class="bank-pill" data-filter="REV" type="button">R√©vision</button>
      </div>

      <input id="rembank-search" class="bank-search" type="search" placeholder="Recherche dans la banque..." />
    </div>

    <div id="rembank-list" class="bank-list"></div>

    <details class="bank-raw" id="rembank-raw">
      <summary>Voir la liste brute</summary>
      <pre id="rembank-raw-pre" style="white-space:pre-wrap; margin:10px 0 0;"></pre>
    </details>

    <details class="bank-raw" id="rembank-trash">
      <summary>Voir la corbeille (<span id="rembank-trash-count">0</span>)</summary>
      <div id="rembank-trash-list" class="bank-list" style="margin-top:10px;"></div>
    </details>

    <div style="display:flex; justify-content:flex-end; margin-top:12px;">
      <button id="rembank-reset" class="btn" type="button">R√©initialiser la banque</button>
    </div>
  </div>

</section>


<script>
/* --- BANQUE DE REM√âDIATION (MANUELLE) --- */
(function(){
  // D√©sactive la rem√©diation automatique bas√©e sur les r√©sultats
  if(typeof window.updateRemediationAuto === "function"){
    window.updateRemediationAuto = function(){ /* d√©sactiv√© */ };
  }

  const KEY_BANK = "grille_rem_bank_v1";
  const KEY_TRASH = "grille_rem_trash_v1";

  const DEFAULT_BANK = [
    // C1
    {id:"c1_1", comp:"C1", text:"Relire la consigne et rep√©rer exactement ce qui est demand√© (C1)"},
    {id:"c1_2", comp:"C1", text:"Relever les informations utiles dans les documents (C1)"},
    {id:"c1_3", comp:"C1", text:"Surligner les mots-cl√©s et les donn√©es chiffr√©es (C1)"},
    {id:"c1_4", comp:"C1", text:"V√©rifier unit√©s, dates, pourcentages, sources (C1)"},
    {id:"c1_5", comp:"C1", text:"Classer les infos par th√®mes (danger, cause, cons√©quence, pr√©vention) (C1)"},
    {id:"c1_6", comp:"C1", text:"Reformuler l‚Äôinformation avec ses propres mots (C1)"},
    {id:"c1_7", comp:"C1", text:"Compl√©ter un tableau / sch√©ma √† partir des documents (C1)"},
    {id:"c1_8", comp:"C1", text:"√âliminer les informations hors sujet (C1)"},

    // C2
    {id:"c2_1", comp:"C2", text:"Faire le QQOQCCP (qui, quoi, o√π, quand, comment, combien, pourquoi) (C2)"},
    {id:"c2_2", comp:"C2", text:"Utiliser ITAMaMi (Individu, T√¢che, Activit√©, Mat√©riel, Milieu) (C2)"},
    {id:"c2_3", comp:"C2", text:"R√©aliser un PAD (processus d‚Äôapparition d‚Äôun dommage) (C2)"},
    {id:"c2_4", comp:"C2", text:"Utiliser Ishikawa / 5M (Main-d‚Äô≈ìuvre, Mat√©riel, M√©thode, Milieu, Mati√®re) (C2)"},
    {id:"c2_5", comp:"C2", text:"Identifier danger, √©v√©nement d√©clencheur, dommage (C2)"},
    {id:"c2_6", comp:"C2", text:"Rep√©rer causes et cons√©quences (cause ‚Üí effet) (C2)"},
    {id:"c2_7", comp:"C2", text:"Lister facteurs aggravants et facteurs protecteurs (C2)"},
    {id:"c2_8", comp:"C2", text:"Prioriser les risques (plus grave / plus probable) (C2)"},

    // C3
    {id:"c3_1", comp:"C3", text:"D√©finir les notions avec un vocabulaire scientifique et pr√©cis (C3)"},
    {id:"c3_2", comp:"C3", text:"Expliquer le lien cause ‚Üí cons√©quence (C3)"},
    {id:"c3_3", comp:"C3", text:"Citer la r√®gle ou la consigne de s√©curit√© attendue (C3)"},
    {id:"c3_4", comp:"C3", text:"Relier la r√®gle √† un risque concret (ce que √ßa √©vite) (C3)"},
    {id:"c3_5", comp:"C3", text:"Donner un exemple concret li√© √† la situation (C3)"},
    {id:"c3_6", comp:"C3", text:"Expliquer le r√¥le de la pr√©vention (avant / pendant / apr√®s) (C3)"},
    {id:"c3_7", comp:"C3", text:"Distinguer danger, risque, dommage (C3)"},

    // C4
    {id:"c4_1", comp:"C4", text:"Proposer au moins 2 mesures de pr√©vention (C4)"},
    {id:"c4_2", comp:"C4", text:"Classer les mesures (collectives avant individuelles) (C4)"},
    {id:"c4_3", comp:"C4", text:"Adapter la solution √† la situation (r√©aliste, applicable) (C4)"},
    {id:"c4_4", comp:"C4", text:"Pr√©ciser qui fait quoi et avec quel mat√©riel (C4)"},
    {id:"c4_5", comp:"C4", text:"V√©rifier l‚Äôefficacit√© attendue (ce que √ßa r√©duit) (C4)"},
    {id:"c4_6", comp:"C4", text:"Pr√©voir une action de contr√¥le (v√©rifier, entretenir, former) (C4)"},
    {id:"c4_7", comp:"C4", text:"Utiliser la logique √©viter ‚Üí r√©duire ‚Üí prot√©ger (C4)"},

    // C5
    {id:"c5_1", comp:"C5", text:"Justifier le choix avec 2 crit√®res minimum (s√©curit√©, co√ªt, efficacit√©, faisabilit√©) (C5)"},
    {id:"c5_2", comp:"C5", text:"Comparer avantages / limites de plusieurs solutions (C5)"},
    {id:"c5_3", comp:"C5", text:"Appuyer l‚Äôargumentation sur la situation et les documents (C5)"},
    {id:"c5_4", comp:"C5", text:"Utiliser des connecteurs logiques (car, donc, cependant, ainsi) (C5)"},
    {id:"c5_5", comp:"C5", text:"Conclure clairement (je choisis‚Ä¶ parce que‚Ä¶) (C5)"},
    {id:"c5_6", comp:"C5", text:"V√©rifier la coh√©rence entre solution propos√©e et risque identifi√© (C5)"},

    // C6
    {id:"c6_1", comp:"C6", text:"R√©pondre √† toutes les questions (ne rien laisser vide) (C6)"},
    {id:"c6_2", comp:"C6", text:"Si une question n‚Äôest pas comprise, reformuler ce qui est demand√© puis r√©pondre (C6)"},
    {id:"c6_3", comp:"C6", text:"R√©pondre dans l‚Äôordre des questions (C6)"},
    {id:"c6_4", comp:"C6", text:"√âcrire des phrases compl√®tes (sujet + verbe + compl√©ment) (C6)"},
    {id:"c6_5", comp:"C6", text:"A√©rer la r√©ponse (lignes, tirets, mots-cl√©s) (C6)"},
    {id:"c6_6", comp:"C6", text:"Utiliser un vocabulaire professionnel adapt√© (C6)"},
    {id:"c6_7", comp:"C6", text:"Soigner l‚Äôorthographe des mots-cl√©s PSE (C6)"},
    {id:"c6_8", comp:"C6", text:"√âviter les r√©ponses trop vagues (√™tre pr√©cis) (C6)"},
    {id:"c6_9", comp:"C6", text:"Se relire et corriger avant de rendre (C6)"},

    // R√©vision
    {id:"rev_1", comp:"REV", text:"Scanner le code QR ou utiliser le lien internet de r√©vision indiqu√© sur la fiche pour vous exercer selon la comp√©tence cibl√©e"}];

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const ta = $("#rem-conseil");
  const compSel = $("#rembank-comp");
  const input = $("#rembank-input");
  const btnAdd = $("#rembank-add");
  const btnUpd = $("#rembank-update");
  const btnCancel = $("#rembank-cancel");
  const btnClear = $("#rembank-clear");
  const btnReset = $("#rembank-reset");
  const listEl = $("#rembank-list");
  const searchEl = $("#rembank-search");
  const rawPre = $("#rembank-raw-pre");
  const trashCountEl = $("#rembank-trash-count");
  const trashListEl = $("#rembank-trash-list");

  if(!ta || !compSel || !input || !btnAdd || !listEl) return;

  let bank = [];
  let trash = [];
  let activeFilter = "ALL";
  let editingId = null;

  function save(){
    try{ localStorage.setItem(KEY_BANK, JSON.stringify(bank)); }catch(_){}
    try{ localStorage.setItem(KEY_TRASH, JSON.stringify(trash)); }catch(_){}
  }
  function load(){
    try{
      const b = JSON.parse(localStorage.getItem(KEY_BANK) || "null");
      const t = JSON.parse(localStorage.getItem(KEY_TRASH) || "null");
      bank = Array.isArray(b) ? b : DEFAULT_BANK.slice();
      trash = Array.isArray(t) ? t : [];
    }catch(_){
      bank = DEFAULT_BANK.slice();
      trash = [];
    }
    if(!bank.length) bank = DEFAULT_BANK.slice();
    save();
  }

  function normalize(s){
    return (s||"").toLowerCase().trim().replace(/\s+/g," ");
  }

  function inferComp(text){
    const x = (text||"").trim();
    const m = x.match(/^(C[1-6]|REV|R√©vision|GENERAL|G√©n√©ral)\b/i);
    if(!m) return null;
    let c = m[1].toUpperCase();
    if(c === "R√âVISION") c="REV";
    if(c === "GENERAL" || c === "G√âN√âRAL") c="GEN";
    return c;
  }

  function labelComp(comp){
    if(comp === "REV") return "R√©vision";
    return comp;
  }

  function render(){
    // pills active
    $$("#rembank-filters .bank-pill").forEach(p=>{
      const f = p.dataset.filter;
      if(f === activeFilter) p.classList.add("active");
      else p.classList.remove("active");
    });

    const q = normalize(searchEl.value);
    const items = bank.filter(it=>{
      if(activeFilter !== "ALL" && it.comp !== activeFilter) return false;
      if(q && normalize(it.text).indexOf(q) === -1 && normalize(labelComp(it.comp)).indexOf(q) === -1) return false;
      return true;
    });

    listEl.innerHTML = "";
    items.forEach(it=>{
      const card = document.createElement("div");
      card.className = "bank-item comp-" + it.comp;
      card.tabIndex = 0;

      const badge = document.createElement("span");
      badge.className = "bank-badge";
      badge.textContent = (it.comp === "REV") ? "REV" : it.comp;

      const txt = document.createElement("div");
      txt.className = "bank-text";
      txt.textContent = it.text;

      const actions = document.createElement("div");
      actions.className = "bank-actions";

      const btnOk = document.createElement("button");
      btnOk.className = "bank-mini success";
      btnOk.type = "button";
      btnOk.title = "Ajouter au conseil";
      btnOk.textContent = "‚úì";

      const btnEdit = document.createElement("button");
      btnEdit.className = "bank-mini";
      btnEdit.type = "button";
      btnEdit.title = "Modifier";
      btnEdit.textContent = "‚úé";

      const btnDel = document.createElement("button");
      btnDel.className = "bank-mini danger";
      btnDel.type = "button";
      btnDel.title = "Supprimer (corbeille)";
      btnDel.textContent = "√ó";

      actions.appendChild(btnOk);
      actions.appendChild(btnEdit);
      actions.appendChild(btnDel);

      card.appendChild(badge);
      card.appendChild(txt);
      card.appendChild(actions);

      function insert(){
        const line = it.text.trim();
        if(!line) return;
        const cur = (ta.value||"").trim();
        const add = (cur ? "\n" : "") + "‚Ä¢ " + line;
        ta.value = (cur ? (cur + add) : ("‚Ä¢ " + line));
        try{ ta.dispatchEvent(new Event("input")); }catch(_){}
        try{
          if(typeof window.bindAutoResize === "function") window.bindAutoResize(ta);
        }catch(_){}
      }

      card.addEventListener("click", (e)=>{ 
        if(e.target && e.target.closest(".bank-actions")) return;
        insert();
      });
      btnOk.addEventListener("click", (e)=>{ e.stopPropagation(); insert(); });

      btnEdit.addEventListener("click", (e)=>{
        e.stopPropagation();
        editingId = it.id;
        input.value = it.text;
        compSel.value = it.comp;
        btnUpd.disabled = false;
        btnCancel.disabled = false;
        btnAdd.disabled = true;
        input.focus();
      });

      btnDel.addEventListener("click", (e)=>{
        e.stopPropagation();
        // move to trash
        bank = bank.filter(x=>x.id !== it.id);
        trash.unshift(it);
        save();
        render();
        renderTrash();
        renderRaw();
      });

      listEl.appendChild(card);
    });

    renderRaw();
  }

  function renderTrash(){
    trashCountEl.textContent = String(trash.length);
    trashListEl.innerHTML = "";
    trash.forEach(it=>{
      const card = document.createElement("div");
      card.className = "bank-item comp-" + it.comp;

      const badge = document.createElement("span");
      badge.className = "bank-badge";
      badge.textContent = (it.comp === "REV") ? "REV" : it.comp;

      const txt = document.createElement("div");
      txt.className = "bank-text";
      txt.textContent = it.text;

      const actions = document.createElement("div");
      actions.className = "bank-actions";

      const btnRestore = document.createElement("button");
      btnRestore.className = "bank-mini success";
      btnRestore.type = "button";
      btnRestore.title = "Restaurer";
      btnRestore.textContent = "‚Ü©";

      const btnDelete = document.createElement("button");
      btnDelete.className = "bank-mini danger";
      btnDelete.type = "button";
      btnDelete.title = "Supprimer d√©finitivement";
      btnDelete.textContent = "√ó";

      actions.appendChild(btnRestore);
      actions.appendChild(btnDelete);

      card.appendChild(badge);
      card.appendChild(txt);
      card.appendChild(actions);

      btnRestore.addEventListener("click", ()=>{
        trash = trash.filter(x=>x.id !== it.id);
        bank.unshift(it);
        save();
        render();
        renderTrash();
        renderRaw();
      });
      btnDelete.addEventListener("click", ()=>{
        trash = trash.filter(x=>x.id !== it.id);
        save();
        renderTrash();
      });

      trashListEl.appendChild(card);
    });
  }

  function renderRaw(){
    const lines = bank.map(it=>`[${it.comp}] ${it.text}`);
    rawPre.textContent = lines.join("\n");
  }

  function addOrUpdate(){
    const raw = (input.value||"").trim();
    if(!raw) return;

    let comp = compSel.value;
    if(comp === "AUTO"){
      comp = inferComp(raw) || activeFilter;
      if(comp === "ALL") comp = "C1";
    }
    if(comp === "GEN") comp = "REV"; // not used here
    const text = raw.replace(/^(C[1-6]|REV|R√©vision)\s*[:\-‚Äì]\s*/i,"").trim();

    const isDup = bank.some(it => it.comp === comp && normalize(it.text) === normalize(text) && it.id !== editingId);
    if(isDup){ alert("Cet √©l√©ment existe d√©j√† !"); return; }

    if(editingId){
      bank = bank.map(it => it.id === editingId ? ({...it, comp, text}) : it);
      editingId = null;
      btnUpd.disabled = true;
      btnCancel.disabled = true;
      btnAdd.disabled = false;
    }else{
      const id = "u_" + Math.random().toString(36).slice(2,9) + "_" + Date.now();
      bank.unshift({id, comp, text});
    }
    input.value = "";
    save();
    render();
  }

  btnAdd.addEventListener("click", addOrUpdate);
  btnUpd.addEventListener("click", addOrUpdate);

  btnCancel.addEventListener("click", ()=>{
    editingId = null;
    input.value = "";
    btnUpd.disabled = true;
    btnCancel.disabled = true;
    btnAdd.disabled = false;
  });

  btnClear.addEventListener("click", ()=>{ input.value=""; input.focus(); });

  $$("#rembank-filters .bank-pill").forEach(p=>{
    p.addEventListener("click", ()=>{
      activeFilter = p.dataset.filter || "ALL";
      // sync select to filter
      if(activeFilter !== "ALL") compSel.value = activeFilter;
      render();
    });
  });

  searchEl.addEventListener("input", render);

  btnReset.addEventListener("click", ()=>{
    if(!confirm("R√©initialiser la banque de rem√©diation (cela efface vos ajouts/modifications) ?")) return;
    bank = DEFAULT_BANK.slice();
    trash = [];
    save();
    render();
    renderTrash();
  });

  // Init
  load();
  render();
  renderTrash();
})();
</script>

</body></html>
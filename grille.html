<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Grille √âvaluation PSE - Expert Connect√©</title>
    
    <script src="data_eleves.js"></script>
    <script src="data_commentaires_competences.js"></script>
    <script src="data_appreciation.js"></script>

    <style>
        /* --- OPTIMISATION A4 ET IMPRESSION --- */
        @page { size: A4; margin: 10mm; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 210mm; margin: 0 auto; padding: 10px 20px; background-color: #fff; color: #333; font-size: 0.9em; }

        /* BOUTONS FLOTTANTS */
        .tools-container { position: fixed; top: 10px; right: 10px; z-index: 1000; display: flex; gap: 10px; }
        .action-btn { background: rgba(255, 255, 255, 0.9); border: 1px solid #ccc; font-size: 1.1em; cursor: pointer; padding: 5px 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #saveMessage { position: fixed; bottom: 10px; right: 10px; background: #333; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.7em; opacity: 0; transition: opacity 0.5s; }

        h1 { text-align: center; color: #d9534f; margin: 0 0 10px 0; border-bottom: 2px solid #d9534f; padding-bottom: 5px; font-size: 1.5em; }
        
        .header-row { display: flex; gap: 10px; margin-bottom: 10px; background-color: #f8f9fa; padding: 8px 15px; border-radius: 6px; border: 1px solid #ddd; }
        .input-group { display: flex; flex-direction: column; flex-grow: 1; }
        .input-group label { font-size: 0.8em; color: #666; font-weight: bold; }
        .input-group input { padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }

        .appreciation-box { margin-bottom: 10px; }
        .appreciation-box label { font-weight: bold; color: #2e7bb6; cursor: pointer; text-decoration: underline; font-size: 0.9em; }
        .appreciation-box textarea { width: 100%; height: 60px; padding: 8px; border: 2px solid #2e7bb6; border-radius: 4px; background-color: #f0f8ff; resize: none; font-family: inherit; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        .thead-dark { background-color: #333; color: white; }
        .thead-light { background-color: #f4f4f4; color: #333; font-weight: bold; font-size: 0.8em; }
        .correction-th { background-color: #d9534f; color: white; cursor: pointer; }

        .badge { display: inline-block; color: white; padding: 3px 0; width: 30px; text-align: center; border-radius: 4px; font-weight: bold; font-size: 0.85em; }
        .c1 { background-color: #7f8c8d; } .c2 { background-color: #66a5ad; } .c3 { background-color: #b03052; } 
        .c4 { background-color: #2e7bb6; } .c5 { background-color: #5cb85c; } .c6 { background-color: #f0c05a; }

        .rep-eleve-box { background:#f0f9ff; padding:8px; border-radius:6px; border-left:4px solid #3498db; margin-bottom:4px; color:#0f172a; text-align: left; }
        .rep-prof-box { color:#64748b; font-size:0.85em; padding:2px; font-style:italic; text-align: left; }
        
        .level-btn { border: 1px solid #ddd; background: #f9f9f9; font-size: 0.75em; padding: 2px 5px; cursor: pointer; border-radius: 3px; font-weight: bold; color: #aaa; }
        .level-btn.active { border: 2px solid #333; color: #fff; }
        .level-btn.active.nt { background: #7f8c8d; } .level-btn.active.i { background: #d9534f; }
        .level-btn.active.a { background: #f0c05a; } .level-btn.active.m { background: #5cb85c; }

        .editable-div { min-height: 20px; text-align: left; outline: none; padding: 4px; font-size: 0.95em; border: 1px dashed transparent; cursor: text; }
        .editable-div:focus { background-color: #fff; border-color: #2e7bb6; }

        .final-grade-cell { background-color: #fffef0; color: #d9534f; font-weight: bold; vertical-align: middle; }
        .final-grade-text { font-size: 1.8em; display: block; line-height: 1; }

        /* MODALE BANQUE */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 600px; max-width: 90%; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 80vh; }
        .modal-header { padding: 10px 15px; border-bottom: 1px solid #eee; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 0; overflow-y: auto; }
        .comment-item { padding: 10px 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 0.95em; }
        .comment-item:hover { background-color: #f0f8ff; color: #2e7bb6; }

        @media print {
            .no-print { display: none !important; }
            body { padding: 0; margin: 0; }
            .rep-prof-box { display: none; }
            .header-row { background: none; border: none; padding: 0; }
            .input-group input { border: none; border-bottom: 1px solid #000; }
            textarea { border: 1px solid #000 !important; background: transparent !important; }
        }
    </style>
</head>
<body>

    <div class="tools-container no-print">
        <button class="action-btn" onclick="resetNewStudent()">‚ôªÔ∏è Nouveau</button>
        <button class="action-btn" onclick="window.print()">üñ®Ô∏è Imprimer</button>
    </div>
    
    <div id="saveMessage">Enregistr√©</div>

    <div id="commentModal" class="modal-overlay no-print">
        <div class="modal-box">
            <div class="modal-header"><span id="modalTitle">Banque</span><span style="cursor:pointer" onclick="closeModal()">‚úñ</span></div>
            <div id="modalList" class="modal-body"></div>
        </div>
    </div>

    <h1 id="docTitle">Correction Devoir</h1>

    <div class="header-row">
        <div class="input-group"><label>Nom :</label><input type="text" id="inputNom"></div>
        <div class="input-group"><label>Pr√©nom :</label><input type="text" id="inputPrenom"></div>
        <div class="input-group" style="width:80px;"><label>Classe :</label><input type="text" id="inputClasse"></div>
        <div class="input-group" style="width:110px;"><label>Date :</label><input type="date" id="inputDate"></div>
    </div>

    <div class="appreciation-box">
        <label onclick="openAppreciationBank()">üìù Appr√©ciation G√©n√©rale (cliquez pour la banque) :</label>
        <textarea id="appreciationArea"></textarea>
    </div>

    <table>
        <thead>
            <tr class="thead-dark">
                <th rowspan="2" style="width:40px;">C</th>
                <th rowspan="2">Questions</th>
                <th colspan="4" class="thead-light">Ma√Ætrise</th>
                <th rowspan="2" style="width:60px; background:#fff; color:#333;">Pts</th>
                <th rowspan="2" style="width:80px; background:#fff; color:#333;">Note</th>
            </tr>
            <tr class="thead-light">
                <th>NT</th><th>I</th><th>A</th><th>M</th>
            </tr>
        </thead>
        <tbody id="gradingBody"></tbody>
    </table>

    <table id="correctionTable">
        <thead>
            <tr>
                <th class="correction-th" onclick="sortTable(0)">Q¬∞ ‚áÖ</th>
                <th class="correction-th" onclick="sortTable(1)">C ‚áÖ</th>
                <th class="correction-th" onclick="sortTable(2)">Niveau ‚áÖ</th>
                <th class="correction-th">R√©ponse √âl√®ve / Corrig√©</th>
                <th class="correction-th" style="width:30%;">Commentaires</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

<script>
    let CURRENT_TARGET_DIV = null;
    let CURRENT_BLUEPRINT = null;

    // --- 1. INITIALISATION ---
    window.addEventListener('load', async function() {
        initSummary();
        const rawData = localStorage.getItem("cockpit_transfert");
        
        if (rawData) {
            try {
                const copy = JSON.parse(rawData);
                // Remplir infos
                document.getElementById('inputNom').value = copy.eleve?.nom || copy.eleve?.code || "";
                document.getElementById('inputPrenom').value = copy.eleve?.prenom || "";
                document.getElementById('inputClasse').value = copy.eleve?.classe || "";
                document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];

                // Charger Blueprint local (Racine)
                const idClean = (copy.devoirId || "").trim();
                const resp = await fetch(`${idClean}_blueprint.json`);
                if (!resp.ok) throw new Error("Fichier JSON non trouv√© √† la racine");
                
                CURRENT_BLUEPRINT = await resp.json();
                document.getElementById('docTitle').innerText = CURRENT_BLUEPRINT.titre || "Correction";
                
                renderCorrection(CURRENT_BLUEPRINT, copy.reponses);
            } catch (e) { alert("Erreur chargement : " + e.message); }
        }
    });

    function initSummary() {
        const tbody = document.getElementById('gradingBody');
        tbody.innerHTML = "";
        ['C1','C2','C3','C4','C5','C6'].forEach((c, idx) => {
            let tr = `<tr>
                <td><span class="badge ${c.toLowerCase()}">${c}</span></td>
                <td id="q_list_${c}"></td>
                <td><input type="radio" name="r_${c}" disabled></td><td><input type="radio" name="r_${c}" disabled></td>
                <td><input type="radio" name="r_${c}" disabled></td><td><input type="radio" name="r_${c}" disabled></td>
                <td><span id="pts_${c}">0</span> / <span id="max_${c}">0</span></td>`;
            if(idx === 0) tr += `<td rowspan="6" class="final-grade-cell"><span id="finalNote" class="final-grade-text">--</span></td>`;
            tr += `</tr>`;
            tbody.innerHTML += tr;
        });
    }

    function renderCorrection(blueprint, reponses) {
        const tbody = document.getElementById('correctionTable').querySelector('tbody');
        tbody.innerHTML = "";
        let maxMap = {}; let qMap = {};

        blueprint.questions.forEach(q => {
            maxMap[q.competence] = (maxMap[q.competence] || 0) + q.bareme;
            qMap[q.competence] = qMap[q.competence] || [];
            qMap[q.competence].push(q.label);

            const row = tbody.insertRow();
            row.dataset.ptsEleve = 0;
            row.dataset.max = q.bareme;
            row.dataset.comp = q.competence;

            row.innerHTML = `
                <td style="font-weight:bold">${q.label}</td>
                <td><span class="badge ${q.competence.toLowerCase()}">${q.competence}</span></td>
                <td>
                    <div style="display:flex; gap:2px; justify-content:center;">
                        <span class="level-btn nt" onclick="setNote(this, 0, 'NT')">NT</span>
                        <span class="level-btn i" onclick="setNote(this, ${q.bareme*0.3}, 'I')">I</span>
                        <span class="level-btn a" onclick="setNote(this, ${q.bareme*0.7}, 'A')">A</span>
                        <span class="level-btn m" onclick="setNote(this, ${q.bareme}, 'M')">M</span>
                    </div>
                </td>
                <td style="text-align:left">
                    <div class="rep-eleve-box">${reponses[q.qid] || "<i>Non r√©pondu</i>"}</div>
                    <div class="rep-prof-box">üéØ Corrig√© : ${q.reponseAttendue || "N/A"}</div>
                </td>
                <td><div class="editable-div" contenteditable="true" oninput="showSave()"></div></td>
            `;
        });

        // Maj r√©sum√©
        for(let c in maxMap) {
            if(document.getElementById(`max_${c}`)) document.getElementById(`max_${c}`).innerText = maxMap[c];
            if(document.getElementById(`q_list_${c}`)) document.getElementById(`q_list_${c}`).innerText = qMap[c].join(", ");
        }
    }

    // --- 2. LOGIQUE DE NOTATION & BANQUE ---
    function setNote(btn, pts, level) {
        const row = btn.closest('tr');
        Array.from(btn.parentNode.children).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        row.dataset.ptsEleve = pts;
        row.dataset.level = level;
        
        calculate();
        showSave();

        // Ouvrir banque auto
        openCommentBank(row.dataset.comp, level, row.querySelector('.editable-div'));
    }

    function calculate() {
        let scores = {}; let gTotal = 0; let gMax = 0;
        document.querySelectorAll('#correctionTable tbody tr').forEach(r => {
            const p = parseFloat(r.dataset.ptsEleve) || 0;
            const m = parseFloat(r.dataset.max) || 0;
            scores[r.dataset.comp] = (scores[r.dataset.comp] || 0) + p;
            gTotal += p; gMax += m;
        });
        for(let c in scores) { if(document.getElementById(`pts_${c}`)) document.getElementById(`pts_${c}`).innerText = scores[c].toFixed(1); }
        if(gMax > 0) document.getElementById('finalNote').innerText = ((gTotal/gMax)*20).toFixed(1) + "/20";
    }

    // --- 3. BANQUES DE TEXTES ---
    function openCommentBank(comp, level, target) {
        CURRENT_TARGET_DIV = target;
        const list = document.getElementById('modalList');
        list.innerHTML = "";
        document.getElementById('modalTitle').innerText = `Commentaires ${comp} (${level})`;
        
        // On cherche dans data_commentaires_competences.js
        const phrases = window.DATA_COMMENTAIRES_COMPETENCES?.[comp]?.["G√©n√©ral"]?.[level] || [];
        
        if(phrases.length === 0) { phrases.push("Bon travail", "√Ä approfondir", "Non trait√©"); }

        phrases.forEach(txt => {
            const d = document.createElement('div'); d.className = "comment-item"; d.innerText = txt;
            d.onclick = () => { 
                CURRENT_TARGET_DIV.innerText = txt; 
                closeModal(); 
            };
            list.appendChild(d);
        });
        document.getElementById('commentModal').style.display = "flex";
    }

    function openAppreciationBank() {
        CURRENT_TARGET_DIV = document.getElementById('appreciationArea');
        const list = document.getElementById('modalList');
        list.innerHTML = "";
        document.getElementById('modalTitle').innerText = "Appr√©ciations Globales";
        
        const phrases = window.DATA_APPRECIATION?.["Global"] || [];
        phrases.forEach(txt => {
            const d = document.createElement('div'); d.className = "comment-item"; d.innerText = txt;
            d.onclick = () => { 
                CURRENT_TARGET_DIV.value = txt; 
                closeModal(); 
            };
            list.appendChild(d);
        });
        document.getElementById('commentModal').style.display = "flex";
    }

    function closeModal() { document.getElementById('commentModal').style.display = "none"; }

    // --- 4. TRI & OUTILS ---
    function sortTable(n) {
        const table = document.getElementById("correctionTable");
        let rows = Array.from(table.rows).slice(1);
        rows.sort((a, b) => {
            let t1 = a.cells[n].innerText, t2 = b.cells[n].innerText;
            return isNaN(t1) ? t1.localeCompare(t2) : t1 - t2;
        });
        rows.forEach(r => table.appendChild(r));
    }

    function showSave() {
        const msg = document.getElementById('saveMessage');
        msg.style.opacity = 1; setTimeout(() => msg.style.opacity = 0, 1000);
    }

    function resetNewStudent() { if(confirm("Vider la grille ?")) location.reload(); }
</script>
</body>
</html>

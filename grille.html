<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grille de Correction - CoqPilot</title>

  <script src="data_eleves.js"></script>
  <script src="data_commentaires_competences.js"></script>
  <script src="data_appreciation.js"></script>

  <style>
    @page { size: A4; margin: 10mm; }

    * { box-sizing: border-box; }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      width: 100%;
      max-width: 210mm;
      margin: 0 auto;
      padding: 10px 20px;
      background-color: #fff;
      color: #333;
    }

    .tools-container {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }
    .action-btn {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ccc;
      font-size: 1.05em;
      cursor: pointer;
      opacity: 0.9;
      padding: 6px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.12);
      transition: all 0.2s;
      user-select: none;
      white-space: nowrap;
    }
    .action-btn:hover { opacity: 1; transform: scale(1.03); background: #fff; }

    #saveMessage {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #333;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.85em;
      opacity: 0;
      transition: opacity 0.35s;
      pointer-events: none;
      z-index: 1500;
    }

    h1 {
      text-align: center;
      color: #d9534f;
      margin: 0 0 10px 0;
      border-bottom: 2px solid #d9534f;
      padding-bottom: 6px;
      font-size: 1.55em;
    }

    .header-row {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
      align-items: flex-end;
      background-color: #f8f9fa;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      flex-wrap: wrap;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      position: relative;
      min-width: 160px;
      flex: 1 1 160px;
    }
    .input-group.grow { flex: 2 1 220px; min-width: 220px; }
    .input-group label {
      font-size: 0.8em;
      color: #666;
      font-weight: 700;
      margin-bottom: 3px;
    }
    .input-group input {
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      width: 100%;
    }

    .suggestions-list {
      position: absolute;
      top: calc(100% + 2px);
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 0 0 6px 6px;
      max-height: 180px;
      overflow-y: auto;
      z-index: 1200;
      display: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }
    .suggestion-item {
      padding: 8px 10px;
      cursor: pointer;
      font-size: 0.95em;
    }
    .suggestion-item:hover { background: #f0f6ff; }

    .appreciation-box { margin-bottom: 10px; position: relative; }
    .appreciation-box label {
      font-weight: 800;
      color: #2e7bb6;
      display: inline-block;
      margin-bottom: 6px;
      font-size: 0.95em;
      cursor: pointer;
      text-decoration: underline;
    }
    .appreciation-box textarea {
      width: 100%;
      min-height: 60px;
      padding: 10px;
      border: 2px solid #2e7bb6;
      border-radius: 6px;
      font-family: inherit;
      resize: vertical;
      background-color: #f0f8ff;
    }

    .table-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 8px;
    }

    table { width: 100%; border-collapse: collapse; margin-bottom: 6px; min-width: 860px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; vertical-align: middle; }
    .thead-dark { background-color: #333; color: #fff; }
    .thead-light { background-color: #f4f4f4; color: #333; font-size: 0.9em; font-weight: 800; }
    .correction-th { background-color: #d9534f; color: #fff; text-align: left; }

    .badge {
      display: inline-block;
      color: #fff;
      padding: 4px 0;
      width: 34px;
      text-align: center;
      border-radius: 6px;
      font-weight: 800;
      font-size: 0.85em;
    }
    .c1 { background-color: #7f8c8d; }
    .c2 { background-color: #66a5ad; }
    .c3 { background-color: #b03052; }
    .c4 { background-color: #2e7bb6; }
    .c5 { background-color: #5cb85c; }
    .c6 { background-color: #f0c05a; color: #2b2b2b; }

    .q-display {
      width: 100%;
      border: none;
      background: #f9f9f9;
      text-align: center;
      font-style: italic;
      color: #555;
      font-weight: 800;
      padding: 4px 6px;
      border-radius: 6px;
    }

    .level-btn {
      border: 1px solid #ddd;
      background: #f9f9f9;
      font-size: 0.75em;
      padding: 2px 6px;
      cursor: pointer;
      border-radius: 4px;
      margin: 0 2px;
      font-weight: 900;
      color: #999;
      transition: all 0.15s;
      user-select: none;
      display: inline-block;
      min-width: 28px;
    }
    .level-btn:hover { background-color: #eee; color: #333; }
    .level-btn.active { border: 2px solid #555; transform: scale(1.03); }
    .level-btn.active.nt { background: #ffebeb; color: #c00; border-color: #c00; }
    .level-btn.active.i  { background: #fff5e6; color: #d9534f; border-color: #d9534f; }
    .level-btn.active.a  { background: #e6f7ff; color: #2e7bb6; border-color: #2e7bb6; }
    .level-btn.active.m  { background: #e6fffa; color: #2a8c64; border-color: #2a8c64; }

    .editable-div {
      min-height: 22px;
      text-align: left;
      outline: none;
      padding: 6px;
      font-size: 0.95em;
      cursor: text;
      white-space: pre-wrap;
      border-radius: 6px;
    }
    .editable-div:empty::before { content: attr(placeholder); color: #aaa; font-style: italic; }
    .editable-div:focus { background-color: #e8f0fe; }

    .comment-bank-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1.05em;
      padding: 2px 6px;
      float: right;
      opacity: 0.85;
    }
    .comment-bank-btn:hover { opacity: 1; }

    .final-grade-cell { background-color: #fffef0; color: #d9534f; font-weight: 900; vertical-align: middle; }
    .final-grade-text { font-size: 1.9em; display: block; line-height: 1; }

    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }
    .modal-box {
      background: #fff;
      width: 780px;
      max-width: 98vw;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      max-height: 82vh;
      overflow: hidden;
    }
    .modal-header {
      padding: 10px 14px;
      border-bottom: 1px solid #eee;
      background: #f8f9fa;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .modal-title { font-weight: 900; color: #333; }
    .modal-close { cursor: pointer; font-size: 1.6em; border: none; background: none; color: #888; }
    .modal-body { padding: 0; overflow-y: auto; }
    .modal-section-title {
      background: #eee;
      padding: 6px 14px;
      font-weight: 900;
      font-size: 0.9em;
      color: #555;
      border-bottom: 1px solid #ddd;
      margin: 0;
    }
    .comment-item {
      padding: 10px 14px;
      border-bottom: 1px solid #f2f2f2;
      cursor: pointer;
      font-size: 0.98em;
    }
    .comment-item:hover { background-color: #f0f8ff; color: #2e7bb6; }

    @media (max-width: 980px) {
      body { padding: 10px 12px; }
      table { min-width: 860px; }
    }

    @media print {
      .no-print { display: none !important; }
      body { padding: 0; margin: 0; max-width: 100%; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>

<body>
  <div class="tools-container no-print">
    <button class="action-btn" id="btnPrint">Imprimer</button>
  </div>

  <div id="saveMessage">Sauvegard√©</div>

  <h1 id="docTitle">Correction</h1>

  <div class="header-row">
    <div class="input-group grow">
      <label>Nom :</label>
      <input type="text" id="inputNom" autocomplete="off" />
      <div id="suggestions" class="suggestions-list"></div>
    </div>

    <div class="input-group grow">
      <label>Pr√©nom :</label>
      <input type="text" id="inputPrenom" autocomplete="off" />
    </div>

    <div class="input-group">
      <label>Classe :</label>
      <input type="text" id="inputClasse" autocomplete="off" />
    </div>

    <div class="input-group" style="max-width: 180px;">
      <label>Date :</label>
      <input type="date" id="inputDate" />
    </div>
  </div>

  <div class="appreciation-box">
    <label id="appreciationLabel">Appr√©ciation g√©n√©rale :</label>
    <textarea id="appreciationArea"></textarea>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr class="thead-dark">
          <th rowspan="2" style="width: 46px;">C</th>
          <th rowspan="2">Questions</th>
          <th colspan="4" class="thead-light">Ma√Ætrise</th>
          <th rowspan="2" style="width: 140px; background:#fff; color:#333;">Pts</th>
          <th rowspan="2" style="width: 110px; background:#fff; color:#333;">Note</th>
        </tr>
        <tr class="thead-light">
          <th style="width: 40px;">NT</th>
          <th style="width: 40px;">I</th>
          <th style="width: 40px;">A</th>
          <th style="width: 40px;">M</th>
        </tr>
      </thead>
      <tbody id="gradingBody"></tbody>
    </table>
  </div>

  <h3 style="margin-top:20px; color:#555;">D√©tail de la correction</h3>

  <div class="table-wrap">
    <table id="correctionTable">
      <thead>
        <tr>
          <th class="correction-th" style="width: 60px;">Q¬∞</th>
          <th class="correction-th" style="width: 46px;">C</th>
          <th class="correction-th" style="width: 140px;">Niveau</th>
          <th class="correction-th">R√©ponse √âl√®ve / Corrig√©</th>
          <th class="correction-th" style="width: 30%;">Commentaires</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="modalOverlay" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Banque</div>
        <button class="modal-close" id="modalClose" aria-label="Fermer">√ó</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

<script>
  const comps = [
    { id: "c1", name: "C1", color: "c1" },
    { id: "c2", name: "C2", color: "c2" },
    { id: "c3", name: "C3", color: "c3" },
    { id: "c4", name: "C4", color: "c4" },
    { id: "c5", name: "C5", color: "c5" },
    { id: "c6", name: "C6", color: "c6" }
  ];

  let CURRENT = {
    copie: null,
    blueprint: null,
    idClean: "",
    saveKey: ""
  };

  const LEVELS = ["NT", "I", "A", "M"];
  const LEVEL_CLASS = { "NT":"nt", "I":"i", "A":"a", "M":"m" };

  function escapeHTML(value) {
    const s = (value === null || value === undefined) ? "" : String(value);
    return s
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function formatNumber(x) {
    const n = Number(x);
    if (!isFinite(n)) return "0";
    if (Math.abs(n - Math.round(n)) < 1e-9) return String(Math.round(n));
    let s = n.toFixed(2);
    s = s.replace(/\.?0+$/, "");
    return s;
  }

  function showSaved() {
    const el = document.getElementById("saveMessage");
    el.style.opacity = "1";
    setTimeout(() => { el.style.opacity = "0"; }, 900);
  }

  let saveTimer = null;
  function scheduleSave() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(saveState, 300);
  }

  function saveState() {
    if (!CURRENT.saveKey) return;

    const state = {
      meta: {
        title: document.getElementById("docTitle").innerText || "",
        nom: document.getElementById("inputNom").value || "",
        prenom: document.getElementById("inputPrenom").value || "",
        classe: document.getElementById("inputClasse").value || "",
        date: document.getElementById("inputDate").value || ""
      },
      appreciation: document.getElementById("appreciationArea").value || "",
      rows: {}
    };

    document.querySelectorAll(".score-val").forEach(input => {
      const qid = input.getAttribute("data-qid") || "";
      if (!qid) return;
      const level = input.getAttribute("data-level") || "";
      const points = parseFloat(input.value) || 0;
      const max = parseFloat(input.getAttribute("data-max")) || 0;

      const commentDiv = document.querySelector(`.editable-div[data-qid="${CSS.escape(qid)}"]`);
      const comment = commentDiv ? commentDiv.innerText.trim() : "";

      state.rows[qid] = { level, points, max, comment };
    });

    try {
      localStorage.setItem(CURRENT.saveKey, JSON.stringify(state));
      showSaved();
    } catch (e) {}
  }

  function loadState() {
    if (!CURRENT.saveKey) return null;
    try {
      const raw = localStorage.getItem(CURRENT.saveKey);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (e) {
      return null;
    }
  }

  function applyState(state) {
    if (!state) return;

    if (state.meta) {
      if (state.meta.nom !== undefined) document.getElementById("inputNom").value = state.meta.nom;
      if (state.meta.prenom !== undefined) document.getElementById("inputPrenom").value = state.meta.prenom;
      if (state.meta.classe !== undefined) document.getElementById("inputClasse").value = state.meta.classe;
      if (state.meta.date !== undefined) document.getElementById("inputDate").value = state.meta.date;
    }

    if (state.appreciation !== undefined) {
      document.getElementById("appreciationArea").value = state.appreciation;
    }

    if (!state.rows) return;

    Object.entries(state.rows).forEach(([qid, data]) => {
      const input = document.querySelector(`.score-val[data-qid="${CSS.escape(qid)}"]`);
      if (!input) return;

      const level = data.level || "";
      const points = parseFloat(data.points) || 0;

      input.value = points;
      input.setAttribute("data-level", level);

      const btnWrap = input.closest("td") ? input.closest("td").querySelector(".lvl-wrap") : null;
      if (btnWrap) {
        btnWrap.querySelectorAll(".level-btn").forEach(b => {
          b.classList.remove("active", "nt", "i", "a", "m");
          if (b.innerText === level) {
            b.classList.add("active", LEVEL_CLASS[level] || "");
          }
        });
      }

      const commentDiv = document.querySelector(`.editable-div[data-qid="${CSS.escape(qid)}"]`);
      if (commentDiv && data.comment !== undefined) {
        commentDiv.innerText = data.comment;
      }
    });

    recalculerTout();
  }

  function initGradingTable() {
    const tbody = document.getElementById("gradingBody");
    tbody.innerHTML = "";

    comps.forEach((c, idx) => {
      const tr = document.createElement("tr");

      let html = `
        <td><span class="badge ${c.color}">${c.name}</span></td>
        <td><input type="text" id="q_list_${c.id}" class="q-display" readonly></td>
        <td><input type="radio" name="rad_${c.id}" disabled></td>
        <td><input type="radio" name="rad_${c.id}" disabled></td>
        <td><input type="radio" name="rad_${c.id}" disabled></td>
        <td><input type="radio" name="rad_${c.id}" disabled></td>
        <td><span id="pts_${c.id}">0</span> / <span id="max_${c.id}">0</span></td>
      `;

      if (idx === 0) {
        html += `<td rowspan="6" class="final-grade-cell"><span id="finalNoteDisplay" class="final-grade-text">--</span></td>`;
      }

      tr.innerHTML = html;
      tbody.appendChild(tr);
    });
  }

  async function fetchBlueprintSmart(idClean) {
    const candidates = [
      `${idClean}_blueprint.json`,
      `./devoirs/${idClean}_blueprint.json`,
      `./data/${idClean}_blueprint.json`,
    ];

    const urlSiteEleve = (typeof window.URL_SITE_ELEVE === "string") ? window.URL_SITE_ELEVE : "";
    if (urlSiteEleve) {
      candidates.push(`${urlSiteEleve}${idClean}_blueprint.json`);
      candidates.push(`${urlSiteEleve}devoirs/${idClean}_blueprint.json`);
    }

    for (const url of candidates) {
      try {
        const r = await fetch(url, { cache: "no-store" });
        if (r.ok) return await r.json();
      } catch (e) {}
    }

    throw new Error("Blueprint introuvable");
  }

  function buildSaveKey(idClean, copie) {
    const code = (copie && copie.eleve && (copie.eleve.code || copie.eleve.nom)) ? (copie.eleve.code || copie.eleve.nom) : "";
    const date = document.getElementById("inputDate").value || "";
    return `grille_save_${idClean || "manual"}_${code || "x"}_${date || "x"}`;
  }

  function getRandomFromArray(arr) {
    if (!Array.isArray(arr) || arr.length === 0) return "";
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function suggestComment(compKey, levelKey) {
    const data = window.DATA_COMMENTAIRES_COMPETENCES;
    if (!data || !data[compKey] || !data[compKey]["G√©n√©ral"] || !data[compKey]["G√©n√©ral"][levelKey]) return "";
    return getRandomFromArray(data[compKey]["G√©n√©ral"][levelKey]);
  }

  function openModal(title, sections, onPick) {
    const overlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const body = document.getElementById("modalBody");

    modalTitle.innerText = title;
    body.innerHTML = "";

    sections.forEach(sec => {
      const h = document.createElement("h4");
      h.className = "modal-section-title";
      h.innerText = sec.title;
      body.appendChild(h);

      sec.items.forEach(txt => {
        const div = document.createElement("div");
        div.className = "comment-item";
        div.innerText = txt;
        div.addEventListener("click", () => {
          try { onPick(txt); } catch(e) {}
          overlay.style.display = "none";
        });
        body.appendChild(div);
      });
    });

    overlay.style.display = "flex";
  }

  function openCommentBank(compKey, targetDiv) {
    const data = window.DATA_COMMENTAIRES_COMPETENCES;
    if (!data || !data[compKey]) return;

    const compObj = data[compKey];
    const sections = [];

    Object.keys(compObj).forEach(sectionName => {
      const section = compObj[sectionName];
      const items = [];

      LEVELS.forEach(lvl => {
        const a = section && section[lvl];
        if (Array.isArray(a)) a.forEach(t => items.push(`${lvl} : ${t}`));
      });

      if (items.length) sections.push({ title: sectionName, items });
    });

    openModal(`Banque commentaires ${compKey}`, sections, (txt) => {
      const clean = txt.replace(/^([A-Z]{1,2})\s:\s/, "");
      const current = targetDiv.innerText.trim();
      targetDiv.innerText = current ? (current + "\n" + clean) : clean;
      scheduleSave();
    });
  }

  function openAppreciationBank() {
    const data = window.DATA_APPRECIATION;
    if (!data || !Array.isArray(data.Global)) return;

    openModal(
      "Banque appr√©ciations",
      [{ title: "Global", items: data.Global }],
      (txt) => {
        const ta = document.getElementById("appreciationArea");
        ta.value = ta.value.trim() ? (ta.value.trim() + "\n" + txt) : txt;
        scheduleSave();
      }
    );
  }

  function setNote(btn, points, max, compName, qid) {
    const parent = btn.parentNode;

    parent.querySelectorAll(".level-btn").forEach(b => {
      b.classList.remove("active", "nt", "i", "a", "m");
    });

    btn.classList.add("active", LEVEL_CLASS[btn.innerText] || "");

    const td = parent.closest("td");
    const hiddenInput = td.querySelector(".score-val");
    hiddenInput.value = points;
    hiddenInput.setAttribute("data-comp", compName);
    hiddenInput.setAttribute("data-level", btn.innerText);
    hiddenInput.setAttribute("data-max", String(max));
    hiddenInput.setAttribute("data-qid", qid);

    const row = btn.closest("tr");
    const commentDiv = row.querySelector(".editable-div");
    if (commentDiv && !commentDiv.innerText.trim()) {
      const s = suggestComment(compName, btn.innerText);
      if (s) commentDiv.innerText = s;
    }

    recalculerTout();
    scheduleSave();
  }

  function recalculerTout() {
    const scores = {};
    comps.forEach(c => scores[c.name] = 0);

    let totalGeneral = 0;
    let totalMaxGeneral = 0;

    document.querySelectorAll(".score-val").forEach(input => {
      const val = parseFloat(input.value) || 0;
      const comp = input.getAttribute("data-comp");
      if (scores[comp] !== undefined) scores[comp] += val;
      totalGeneral += val;
    });

    comps.forEach(c => {
      const spanPts = document.getElementById(`pts_${c.id}`);
      const spanMax = document.getElementById(`max_${c.id}`);

      if (spanPts) spanPts.innerText = formatNumber(scores[c.name]);

      const max = parseFloat(spanMax ? spanMax.innerText : 0) || 0;
      totalMaxGeneral += max;
    });

    const noteEl = document.getElementById("finalNoteDisplay");
    if (totalMaxGeneral > 0) {
      const note20 = (totalGeneral / totalMaxGeneral) * 20;
      noteEl.innerText = `${note20.toFixed(1)} / 20`;
    } else {
      noteEl.innerText = "--";
    }
  }

  function construireGrille(blueprint, reponsesEleve) {
    const tbody = document.getElementById("correctionTable").querySelector("tbody");
    tbody.innerHTML = "";

    const compMap = {};
    comps.forEach(c => compMap[c.name] = { max: 0, qList: [] });

    (blueprint.questions || []).forEach((q) => {
      const row = document.createElement("tr");

      const qid = q.qid || q.label || String(Math.random());
      const label = (q.label !== undefined) ? String(q.label) : "";
      const bareme = Number(q.bareme || 0);
      const compKey = String(q.competence || "").toUpperCase();

      const repEleveRaw = (reponsesEleve && reponsesEleve[q.qid] !== undefined) ? reponsesEleve[q.qid] : "(Non r√©pondu)";
      const repProfRaw = q.reponseAttendue || "(Pas de corrig√© type d√©fini)";

      const repEleve = escapeHTML(repEleveRaw);
      const repProf = escapeHTML(repProfRaw);

      if (compMap[compKey]) {
        compMap[compKey].max += bareme;
        compMap[compKey].qList.push(label);
      }

      row.innerHTML = `
        <td style="font-weight:900;">${escapeHTML(label)}</td>
        <td><span class="badge ${String(q.competence || "c1").toLowerCase()}">${escapeHTML(String(q.competence || ""))}</span></td>
        <td>
          <div class="lvl-wrap" style="display:flex; gap:2px; justify-content:center;">
            <span class="level-btn" onclick="setNote(this, 0, ${bareme}, '${compKey}', '${escapeHTML(qid)}')">NT</span>
            <span class="level-btn" onclick="setNote(this, ${bareme * 0.25}, ${bareme}, '${compKey}', '${escapeHTML(qid)}')">I</span>
            <span class="level-btn" onclick="setNote(this, ${bareme * 0.5}, ${bareme}, '${compKey}', '${escapeHTML(qid)}')">A</span>
            <span class="level-btn" onclick="setNote(this, ${bareme}, ${bareme}, '${compKey}', '${escapeHTML(qid)}')">M</span>
          </div>
          <input type="hidden" class="score-val" value="0" data-comp="${escapeHTML(compKey)}" data-level="" data-max="${bareme}" data-qid="${escapeHTML(qid)}">
        </td>
        <td style="text-align:left; vertical-align:top;">
          <div style="background:#f0f9ff; padding:10px; border-radius:8px; border-left:4px solid #3498db; margin-bottom:8px; color:#0f172a;">
            <strong>√âl√®ve :</strong> ${repEleve}
          </div>
          <div style="color:#64748b; font-size:0.92em; padding:6px; border-top:1px dashed #cbd5e1; font-style:italic;">
            <strong>Corrig√© :</strong> ${repProf}
          </div>
        </td>
        <td style="vertical-align:top;">
          <div class="editable-div" contenteditable="true" placeholder="Votre commentaire..." data-qid="${escapeHTML(qid)}"></div>
          <button class="comment-bank-btn no-print" type="button" title="Banque" onclick="openCommentBank('${compKey}', this.parentNode.querySelector('.editable-div'))">üí¨</button>
        </td>
      `;

      tbody.appendChild(row);
    });

    for (const [name, data] of Object.entries(compMap)) {
      const id = name.toLowerCase();
      const qInput = document.getElementById(`q_list_${id}`);
      const maxSpan = document.getElementById(`max_${id}`);

      if (qInput) qInput.value = data.qList.join(", ");
      if (maxSpan) maxSpan.innerText = formatNumber(data.max);
    }

    recalculerTout();
  }

  function attachStudentSuggestions() {
    const inputNom = document.getElementById("inputNom");
    const list = document.getElementById("suggestions");

    const data = window.DATA_ELEVES || window.DATA_ELEVE || window.eleves || null;
    if (!data) return;

    const all = Array.isArray(data) ? data : (Array.isArray(data.eleves) ? data.eleves : null);
    if (!all) return;

    function render(items) {
      list.innerHTML = "";
      if (!items.length) { list.style.display = "none"; return; }

      items.slice(0, 12).forEach(el => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        const nom = el.nom || el.code || "";
        const prenom = el.prenom || "";
        const classe = el.classe || "";
        div.innerText = `${nom} ${prenom} - ${classe}`.trim();

        div.addEventListener("click", () => {
          document.getElementById("inputNom").value = nom;
          document.getElementById("inputPrenom").value = prenom;
          document.getElementById("inputClasse").value = classe;
          list.style.display = "none";
          CURRENT.saveKey = buildSaveKey(CURRENT.idClean, CURRENT.copie);
          scheduleSave();
        });

        list.appendChild(div);
      });

      list.style.display = "block";
    }

    inputNom.addEventListener("input", () => {
      const q = inputNom.value.trim().toLowerCase();
      if (!q) { list.style.display = "none"; return; }

      const found = all.filter(el => {
        const nom = String(el.nom || el.code || "").toLowerCase();
        const prenom = String(el.prenom || "").toLowerCase();
        const classe = String(el.classe || "").toLowerCase();
        return nom.includes(q) || prenom.includes(q) || classe.includes(q);
      });

      render(found);
    });

    document.addEventListener("click", (e) => {
      if (!list.contains(e.target) && e.target !== inputNom) list.style.display = "none";
    });
  }

  window.addEventListener("load", async () => {
    document.getElementById("btnPrint").addEventListener("click", () => window.print());

    const overlay = document.getElementById("modalOverlay");
    const closeBtn = document.getElementById("modalClose");
    closeBtn.addEventListener("click", () => overlay.style.display = "none");
    overlay.addEventListener("click", (e) => { if (e.target === overlay) overlay.style.display = "none"; });

    document.getElementById("appreciationLabel").addEventListener("click", openAppreciationBank);

    initGradingTable();
    attachStudentSuggestions();

    const rawData = localStorage.getItem("cockpit_transfert");
    if (!rawData) {
      CURRENT.idClean = "manual";
      CURRENT.saveKey = buildSaveKey(CURRENT.idClean, null);
      const state = loadState();
      if (state) applyState(state);
      return;
    }

    try {
      const copie = JSON.parse(rawData);
      CURRENT.copie = copie;

      if (copie && copie.eleve) {
        document.getElementById("inputNom").value = copie.eleve.nom || copie.eleve.code || "";
        document.getElementById("inputPrenom").value = copie.eleve.prenom || "";
        document.getElementById("inputClasse").value = copie.eleve.classe || "";
      }

      if (copie && copie.date) {
        const d = new Date(copie.date.seconds ? copie.date.seconds * 1000 : copie.date);
        if (!isNaN(d.getTime())) document.getElementById("inputDate").value = d.toISOString().split("T")[0];
      }

      const idClean = String((copie.idExercice || copie.devoirId || copie.idDevoir || "")).replace(".html", "").replace("_eleve", "");
      CURRENT.idClean = idClean || "unknown";

      CURRENT.saveKey = buildSaveKey(CURRENT.idClean, copie);

      const blueprint = await fetchBlueprintSmart(CURRENT.idClean);
      CURRENT.blueprint = blueprint;

      document.getElementById("docTitle").innerText = "Correction : " + (blueprint.titre || CURRENT.idClean);

      construireGrille(blueprint, copie.reponses || {});

      const state = loadState();
      if (state) applyState(state);

      const ta = document.getElementById("appreciationArea");
      if (!ta.value.trim() && window.DATA_APPRECIATION && Array.isArray(window.DATA_APPRECIATION.Global)) {
        const a = getRandomFromArray(window.DATA_APPRECIATION.Global);
        if (a) { ta.value = a; scheduleSave(); }
      }

    } catch (e) {
      CURRENT.idClean = "manual";
      CURRENT.saveKey = buildSaveKey(CURRENT.idClean, null);
    }

    document.body.addEventListener("input", scheduleSave);
    document.body.addEventListener("click", () => setTimeout(scheduleSave, 120));
  });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Grille PSE - V13 (Sauvegarde Firebase)</title>

    <script src="data_eleves.js"></script>
    <script src="data_commentaires_competences.js"></script>
    <script src="data_appreciation.js"></script>

    <style>
        @page { size: A4; margin: 8mm; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 210mm; margin: 0 auto; padding: 10px 15px; background-color: #fff; color: #333; font-size: 0.9em; }

        .tools-container { position: fixed; top: 10px; right: 10px; z-index: 1000; display: flex; gap: 10px; }
        .action-btn { background: rgba(255, 255, 255, 0.9); border: 1px solid #ccc; font-size: 1.1em; cursor: pointer; padding: 5px 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .action-btn:hover { background: #f0f0f0; }
        .action-btn.save-btn { background: #dcfce7; border-color: #16a34a; color: #166534; }
        .action-btn.save-btn:hover { background: #bbf7d0; }
        
        #saveMessage { position: fixed; bottom: 10px; right: 10px; background: #16a34a; color: white; padding: 8px 15px; border-radius: 6px; font-size: 0.85em; opacity: 0; transition: opacity 0.5s; font-weight: bold; }

        /* Bandeau de statut */
        .status-banner { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 8px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; }
        .status-banner.saved { background: #dcfce7; border-color: #16a34a; color: #166534; }
        .status-banner.not-saved { background: #fee2e2; border-color: #dc2626; color: #991b1b; }

        h1 { text-align: center; color: #d9534f; margin: 0 0 5px 0; border-bottom: 2px solid #d9534f; padding-bottom: 5px; font-size: 1.4em; }

        .header-row { display: flex; gap: 10px; margin-bottom: 10px; background-color: #f8f9fa; padding: 5px 10px; border-radius: 6px; border: 1px solid #ddd; }
        .input-group { display: flex; flex-direction: column; flex-grow: 1; }
        .input-group label { font-size: 0.75em; color: #666; font-weight: bold; }
        .input-group input { padding: 3px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95em; font-weight: bold; color: #0f172a; }

        .appreciation-box { margin-bottom: 10px; position: relative; }
        .appreciation-box label { font-weight: bold; color: #2e7bb6; cursor: pointer; text-decoration: underline; font-size: 0.85em; display:flex; align-items:center; gap:5px; margin-bottom: 3px;}
        .appreciation-box textarea { width: 100%; min-height: 50px; padding: 8px; border: 2px solid #2e7bb6; border-radius: 4px; background-color: #f0f8ff; resize: none; font-family: inherit; font-size: 0.9em; overflow-y: hidden; box-sizing: border-box; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
        th, td { border: 1px solid #ccc; padding: 3px 5px; text-align: center; vertical-align: middle; }
        .thead-dark { background-color: #333; color: white; }
        .thead-light { background-color: #f4f4f4; color: #333; font-weight: bold; font-size: 0.8em; }
        .correction-th { background-color: #d9534f; color: white; cursor: pointer; user-select: none; font-size: 0.85em; }

        .badge { display: inline-block; color: white; padding: 2px 0; width: 25px; text-align: center; border-radius: 4px; font-weight: bold; font-size: 0.8em; }
        .c1 { background-color: #7f8c8d; } .c2 { background-color: #66a5ad; } .c3 { background-color: #b03052; }
        .c4 { background-color: #2e7bb6; } .c5 { background-color: #5cb85c; } .c6 { background-color: #f0c05a; }

        .stat-counters { font-size: 0.75em; color: #666; margin-top: 3px; display: flex; justify-content: center; gap: 8px; background: #f9f9f9; padding: 2px; border-radius: 4px; }
        .score-input { width: 40px; text-align: center; font-weight: bold; border: 1px solid #ccc; padding: 2px; border-radius: 3px; font-size: 1em; background: #fff; }
        .max-input { width: 35px; text-align: center; border: none; font-weight:bold; color: #666; font-size: 0.9em; background: transparent; }
        input[type="radio"] { transform: scale(1.1); cursor: pointer; }

        tfoot { border-top: 2px solid #333; background-color: #fffef0; }
        .total-label { text-align: right; font-weight: bold; font-size: 1.1em; padding-right: 15px; }
        .total-points { font-weight: bold; text-align: center; width: 120px; vertical-align: middle; }
        
        /* ‚úÖ CSS CORRIG√â POUR LA NOTE */
        .total-note { 
            font-weight: 900; 
            font-size: 1.4em; 
            color: #d9534f; 
            display: block;
            line-height: 1.2;
        }

        .rep-eleve-box { background:#f0f9ff; padding:5px; border-radius:4px; border-left:3px solid #3498db; margin-bottom:3px; color:#0f172a; text-align: left; font-size: 0.9em; }
        .rep-prof-box { color:#166534; font-size:0.85em; padding:2px; font-style:italic; text-align: left; border-top: 1px dashed #ccc; margin-top:2px; }

        .level-btn { border: 1px solid #ddd; background: #f9f9f9; font-size: 0.7em; padding: 3px 6px; cursor: pointer; border-radius: 3px; font-weight: bold; color: #aaa; transition:0.2s; }
        .level-btn:hover { background: #eee; color:#333; }
        .level-btn.active { border: 2px solid #333; color: #fff; transform: scale(1.1); }
        .level-btn.active.nt { background: #7f8c8d; border-color: #7f8c8d; }
        .level-btn.active.i { background: #d9534f; border-color: #d9534f; }
        .level-btn.active.a { background: #f0c05a; border-color: #f0c05a; }
        .level-btn.active.m { background: #5cb85c; border-color: #5cb85c; }

        .editable-div { min-height: 25px; text-align: left; outline: none; padding: 4px; font-size: 0.9em; border: 1px dashed #ccc; cursor: text; background: #fff; border-radius: 4px; }
        .editable-div:focus { background-color: #e8f0fe; border-color: #2e7bb6; border-style: solid; }
        .editable-div:empty::before { content: attr(placeholder); color: #ccc; font-style: italic; }

        .bottom-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .legend-box { font-size: 0.75em; color: #555; font-style: italic; }

        .revision-box { display: flex; align-items: center; gap: 10px; background: #f8fafc; border: 1px dashed #94a3b8; border-radius: 8px; padding: 5px 10px; }
        .revision-text { font-size: 0.75em; color: #475569; text-align: right; line-height: 1.2; }
        .qr-img { height: 40px; width: 40px; mix-blend-mode: multiply; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 650px; max-width: 95%; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 85vh; }
        .modal-header { padding: 10px 15px; border-bottom: 1px solid #eee; background: #f8f9fa; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #2e7bb6; }
        .modal-body { padding: 0; overflow-y: auto; }
        .bank-title { background: #f1f5f9; padding: 5px 15px; font-size: 0.8em; font-weight: bold; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border-top: 1px solid #eee; }
        .comment-item { padding: 8px 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 0.9em; transition: background 0.1s; }
        .comment-item:hover { background-color: #e0f2fe; color: #0284c7; }

        @media print {
            .no-print { display: none !important; }
            body { padding: 0; margin: 0; background: white; }
            .status-banner { display: none !important; }
            .rep-prof-box { display: none; }
            .header-row, .revision-box { border: 1px solid #eee; }
            .input-group input { border: none; border-bottom: 1px solid #333; border-radius: 0; padding: 0; }
            textarea { border: 1px solid #333 !important; background: transparent !important; }
            .editable-div { border: none; }
            .score-input, .max-input { border: none; text-align: right; width: auto; font-weight: bold; }
            tr[style*="display: none"] { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="tools-container no-print">
        <button class="action-btn save-btn" onclick="saveToFirebase()">üíæ Enregistrer</button>
        <button class="action-btn" onclick="window.print()">üñ®Ô∏è Imprimer</button>
        <button class="action-btn" onclick="resetNewStudent()">‚ôªÔ∏è Autre copie</button>
    </div>

    <div id="saveMessage">‚úÖ Correction enregistr√©e !</div>

    <!-- Bandeau de statut -->
    <div id="statusBanner" class="status-banner no-print">
        <span id="statusText">‚è≥ Chargement...</span>
        <span id="statusDate"></span>
    </div>

    <div id="commentModal" class="modal-overlay no-print">
        <div class="modal-box">
            <div class="modal-header"><span id="modalTitle">Banque</span><span style="cursor:pointer; font-size:1.5em;" onclick="closeModal()">√ó</span></div>
            <div id="modalList" class="modal-body"></div>
        </div>
    </div>

    <h1 id="docTitle">Correction</h1>

    <div class="header-row">
        <div class="input-group grow"><label>Nom :</label><input type="text" id="inputNom"></div>
        <div class="input-group grow"><label>Pr√©nom :</label><input type="text" id="inputPrenom"></div>
        <div class="input-group" style="width:80px;"><label>Classe :</label><input type="text" id="inputClasse"></div>
        <div class="input-group" style="width:110px;"><label>Date :</label><input type="date" id="inputDate"></div>
    </div>

    <div class="appreciation-box">
        <label onclick="openAppreciationBank()">üìù Appr√©ciation G√©n√©rale (cliquez pour ouvrir la banque)</label>
        <textarea id="appreciationArea" oninput="autoResize(this); markUnsaved();"></textarea>
    </div>

    <table id="summaryTable">
        <thead>
            <tr class="thead-dark">
                <th rowspan="2" style="width:30px;">C</th>
                <th rowspan="2">Comp√©tences √©valu√©es</th>
                <th colspan="4" class="thead-light">Niveau</th>
                <th rowspan="2" style="width:120px; background:#fff; color:#333;">Pts / Max</th>
            </tr>
            <tr class="thead-light">
                <th style="width:25px;">NT</th><th style="width:25px;">I</th><th style="width:25px;">A</th><th style="width:25px;">M</th>
            </tr>
        </thead>
        <tbody id="gradingBody"></tbody>
        <tfoot>
            <tr>
                <td colspan="6" class="total-label">NOTE :</td>
                <td class="total-points"><span id="finalNote" class="total-note">-- / 20</span></td>
            </tr>
        </tfoot>
    </table>

    <div class="bottom-container">
        <div class="legend-box">* NT : Non Trait√© &nbsp; I : Insuffisant &nbsp; A : Acceptable &nbsp; M : Ma√Ætris√©</div>
        <div class="revision-box">
            <div class="revision-text">Pour r√©viser :<br><b>preventionsanteenvironnement.github.io/PSE/</b></div>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://preventionsanteenvironnement.github.io/PSE/" alt="QR" class="qr-img">
        </div>
    </div>

    <h3 style="margin-top:10px; color:#555; border-bottom:1px solid #eee; padding-bottom:5px;">D√©tail de l'√©valuation</h3>

    <table id="correctionTable">
        <thead>
            <tr>
                <th class="correction-th" onclick="sortTable(0)" style="width:40px;">Q¬∞ ‚áÖ</th>
                <th class="correction-th" onclick="sortTable(1)" style="width:40px;">C ‚áÖ</th>
                <th class="correction-th" onclick="sortTable(2)" style="width:100px;">Niveau ‚áÖ</th>
                <th class="correction-th">R√©ponse √âl√®ve / Corrig√©</th>
                <th class="correction-th" style="width:30%;">Commentaires</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

<!-- ========== FIREBASE ========== -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.appspot.com",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables globales
    let CURRENT_TARGET_DIV = null;
    let CURRENT_BLUEPRINT = null;
    let CURRENT_DOC_ID = null;
    let CURRENT_COPY = null;
    let IS_SAVED = true;
    let QUESTIONS_MAP = {}; // Pour retrouver les qid
    const comps = ['C1','C2','C3','C4','C5','C6'];

    // Exposer les fonctions au scope global
    window.autoResize = autoResize;
    window.openAppreciationBank = openAppreciationBank;
    window.closeModal = closeModal;
    window.sortTable = sortTable;
    window.markUnsaved = markUnsaved;
    window.resetNewStudent = resetNewStudent;
    window.setNoteVisual = setNoteVisual;
    window.calculateTotal = calculateTotal;
    window.saveToFirebase = saveToFirebase;

    // ========== FONCTIONS UTILITAIRES ==========

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = (el.scrollHeight) + 'px';
    }

    function markUnsaved() {
        IS_SAVED = false;
        updateStatusBanner();
    }

    function updateStatusBanner() {
        const banner = document.getElementById('statusBanner');
        const text = document.getElementById('statusText');
        const date = document.getElementById('statusDate');
        
        banner.classList.remove('saved', 'not-saved');
        
        if (IS_SAVED && CURRENT_COPY?.correction?.savedAt) {
            banner.classList.add('saved');
            text.innerHTML = '‚úÖ Correction enregistr√©e';
            const d = new Date(CURRENT_COPY.correction.savedAt);
            date.textContent = 'le ' + d.toLocaleDateString('fr-FR') + ' √† ' + d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
        } else if (!IS_SAVED) {
            banner.classList.add('not-saved');
            text.innerHTML = '‚ö†Ô∏è Modifications non enregistr√©es';
            date.textContent = '';
        } else {
            text.innerHTML = 'üìù Nouvelle correction';
            date.textContent = '';
        }
    }

    function showSaveMessage(success = true) {
        const msg = document.getElementById('saveMessage');
        msg.textContent = success ? '‚úÖ Correction enregistr√©e !' : '‚ùå Erreur de sauvegarde';
        msg.style.background = success ? '#16a34a' : '#dc2626';
        msg.style.opacity = 1;
        setTimeout(() => msg.style.opacity = 0, 2000);
    }

    function extractQuestionsFromBlueprint(blueprint) {
        if (Array.isArray(blueprint?.questions)) return blueprint.questions;
        const questions = [];
        function walk(blocks) {
            if (!Array.isArray(blocks)) return;
            blocks.forEach(b => {
                if (b && b.type === "question") questions.push(b);
                if (b && b.content) walk(b.content);
            });
        }
        walk(blueprint?.content);
        return questions;
    }

    // ========== SAUVEGARDE FIREBASE ==========

    async function saveToFirebase() {
        if (!CURRENT_DOC_ID) {
            alert("Erreur : Aucune copie charg√©e.");
            return;
        }

        try {
            // Collecter les donn√©es de correction
            const correction = {
                savedAt: new Date().toISOString(),
                appreciation: document.getElementById('appreciationArea').value || "",
                note_finale: parseFloat(document.getElementById('finalNote').textContent) || 0,
                competences: {},
                questions: {}
            };

            // Collecter les points par comp√©tence
            comps.forEach(c => {
                const ptsEl = document.getElementById(`pts_${c}`);
                const maxEl = document.getElementById(`max_${c}`);
                if (ptsEl && maxEl) {
                    correction.competences[c] = {
                        pts: parseFloat(ptsEl.value) || 0,
                        max: parseFloat(maxEl.value) || 0
                    };
                }
            });

            // Collecter les niveaux et commentaires par question
            document.querySelectorAll('#correctionTable tbody tr').forEach((row, idx) => {
                const qid = row.dataset.qid || `q_${idx}`;
                const level = row.dataset.level || "";
                const commentDiv = row.querySelector('.editable-div');
                const comment = commentDiv ? commentDiv.innerText.trim() : "";
                
                correction.questions[qid] = { level, comment };
            });

            console.log("üíæ Sauvegarde:", correction);

            // Mettre √† jour Firestore
            const docRef = doc(db, "devoirs_rendus", CURRENT_DOC_ID);
            await updateDoc(docRef, { correction });

            // Mettre √† jour l'√©tat local
            CURRENT_COPY.correction = correction;
            IS_SAVED = true;
            updateStatusBanner();
            showSaveMessage(true);

            console.log("‚úÖ Sauvegarde r√©ussie !");

        } catch (e) {
            console.error("‚ùå Erreur sauvegarde:", e);
            showSaveMessage(false);
            alert("Erreur de sauvegarde:\n" + e.message);
        }
    }

    // ========== CHARGEMENT D'UNE CORRECTION EXISTANTE ==========

    function loadExistingCorrection(correction) {
        if (!correction) return;

        console.log("üìÇ Chargement correction existante:", correction);

        // Appr√©ciation
        if (correction.appreciation) {
            document.getElementById('appreciationArea').value = correction.appreciation;
            autoResize(document.getElementById('appreciationArea'));
        }

        // Points par comp√©tence
        if (correction.competences) {
            for (const c in correction.competences) {
                const ptsEl = document.getElementById(`pts_${c}`);
                if (ptsEl && correction.competences[c].pts !== undefined) {
                    ptsEl.value = correction.competences[c].pts;
                }
            }
        }

        // Niveaux et commentaires par question
        if (correction.questions) {
            document.querySelectorAll('#correctionTable tbody tr').forEach((row, idx) => {
                const qid = row.dataset.qid || `q_${idx}`;
                const qData = correction.questions[qid];
                
                if (qData) {
                    // Niveau
                    if (qData.level) {
                        row.dataset.level = qData.level;
                        const btn = row.querySelector(`.level-btn.${qData.level.toLowerCase()}`);
                        if (btn) btn.classList.add('active');
                    }
                    
                    // Commentaire
                    if (qData.comment) {
                        const commentDiv = row.querySelector('.editable-div');
                        if (commentDiv) commentDiv.innerText = qData.comment;
                    }
                }
            });
        }

        // Recalculer les compteurs
        comps.forEach(c => updateCounters(c));
        calculateTotal();

        IS_SAVED = true;
    }

    // ========== RENDU DE LA GRILLE ==========

    function initSummary(activeComps, maxMap) {
        const tbody = document.getElementById('gradingBody');
        tbody.innerHTML = "";
        comps.forEach((c) => {
            const isVisible = activeComps.includes(c) || c === 'C6';
            const displayStyle = isVisible ? "" : "display:none;";
            const initialMax = maxMap[c] || 0;
            tbody.innerHTML += `<tr id="row_${c}" style="${displayStyle}">
                <td><span class="badge ${c.toLowerCase()}">${c}</span></td>
                <td>
                    <input type="text" id="q_list_${c}" style="width:100%; border:none; text-align:center; font-size:0.85em; color:#666;" readonly>
                    <div id="stats_${c}" class="stat-counters">üî¥ 0 | üü† 0 | üîµ 0 | üü¢ 0</div>
                </td>
                <td><input type="radio" name="r_${c}" value="NT"></td>
                <td><input type="radio" name="r_${c}" value="I"></td>
                <td><input type="radio" name="r_${c}" value="A"></td>
                <td><input type="radio" name="r_${c}" value="M"></td>
                <td style="white-space:nowrap;">
                    <input type="number" id="pts_${c}" class="score-input" step="0.25" placeholder="0" oninput="calculateTotal(); markUnsaved();"> /
                    <input type="number" id="max_${c}" class="max-input" step="0.5" value="${initialMax}" oninput="calculateTotal(); markUnsaved();">
                </td>
            </tr>`;
        });
        setTimeout(calculateTotal, 100);
    }

    function renderCorrection(blueprint, reponses) {
        const tbody = document.getElementById('correctionTable').querySelector('tbody');
        tbody.innerHTML = "";
        let maxMap = {};
        let qMap = {};
        let activeComps = [];
        QUESTIONS_MAP = {};

        const list = Array.isArray(blueprint?.questions) ? blueprint.questions : [];
        list.forEach((q, idx) => {
            const competence = (q && q.competence && /^C[1-6]$/.test(q.competence)) ? q.competence : "C6";
            const bareme = Number(q?.bareme) || 0;
            const label = q?.label || ("Q" + (idx + 1));
            const qid = q?.qid || q?.id || q?.name || `q_${idx}`;

            QUESTIONS_MAP[qid] = q;

            if(!activeComps.includes(competence)) activeComps.push(competence);
            maxMap[competence] = (maxMap[competence] || 0) + bareme;
            qMap[competence] = qMap[competence] || [];
            qMap[competence].push(label);

            const row = tbody.insertRow();
            row.dataset.comp = competence;
            row.dataset.level = "";
            row.dataset.qid = qid;

            row.innerHTML = `
                <td style="font-weight:bold">${label}</td>
                <td><span class="badge ${competence.toLowerCase()}">${competence}</span></td>
                <td>
                    <div style="display:flex; gap:2px; justify-content:center;">
                        <span class="level-btn nt" onclick="setNoteVisual(this, 'NT')">NT</span>
                        <span class="level-btn i" onclick="setNoteVisual(this, 'I')">I</span>
                        <span class="level-btn a" onclick="setNoteVisual(this, 'A')">A</span>
                        <span class="level-btn m" onclick="setNoteVisual(this, 'M')">M</span>
                    </div>
                </td>
                <td style="text-align:left">
                    <div class="rep-eleve-box">
                        <strong>üë§ √âl√®ve :</strong> ${ (reponses && (reponses[qid] ?? reponses[q?.qid])) || "<i>Non r√©pondu</i>"}
                    </div>
                    <div class="rep-prof-box">üéØ ${q?.reponseAttendue || "N/A"}</div>
                </td>
                <td><div class="editable-div" contenteditable="true" placeholder="üí° Votre conseil / commentaire..." oninput="markUnsaved()"></div></td>
            `;
        });

        if(!maxMap['C6']) maxMap['C6'] = 2;
        initSummary(activeComps, maxMap);
        for(let c in qMap) {
            const el = document.getElementById(`q_list_${c}`);
            if(el) el.value = qMap[c].join(", ");
        }
    }

    function setNoteVisual(btn, level) {
        const row = btn.closest('tr');
        Array.from(btn.parentNode.children).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        row.dataset.level = level;
        updateCounters(row.dataset.comp);
        markUnsaved();
        openCommentBank(row.dataset.comp, level, row.querySelector('.editable-div'));
    }

    function updateCounters(comp) {
        let counts = { NT:0, I:0, A:0, M:0 };
        document.querySelectorAll('#correctionTable tbody tr').forEach(r => {
            if(r.dataset.comp === comp && r.dataset.level) counts[r.dataset.level]++;
        });
        const statBox = document.getElementById(`stats_${comp}`);
        if(statBox) statBox.innerHTML = `üî¥ ${counts.NT} | üü† ${counts.I} | üîµ ${counts.A} | üü¢ ${counts.M}`;
    }

    function calculateTotal() {
        let totalPts = 0, totalMax = 0;
        comps.forEach(c => {
            const row = document.getElementById(`row_${c}`);
            if(row && row.style.display !== 'none') {
                const p = parseFloat(document.getElementById(`pts_${c}`).value) || 0;
                const m = parseFloat(document.getElementById(`max_${c}`).value) || 0;
                totalPts += p;
                totalMax += m;
            }
        });
        const elNote = document.getElementById('finalNote');
        if(totalMax > 0) {
            const note20 = (totalPts / totalMax) * 20;
            elNote.innerText = note20.toFixed(1) + " / 20";
            elNote.style.color = note20 < 10 ? "#d9534f" : "#16a34a";
        } else {
            elNote.innerText = "-- / 20";
            elNote.style.color = "#d9534f";
        }
    }

    // ========== BANQUES DE COMMENTAIRES ==========

    function openCommentBank(comp, level, target) {
        CURRENT_TARGET_DIV = target;
        const list = document.getElementById('modalList');
        list.innerHTML = "";
        document.getElementById('modalTitle').innerText = `Banque ${comp} (${level})`;
        const compData = window.DATA_COMMENTAIRES_COMPETENCES?.[comp];
        if (!compData) {
            list.innerHTML = "<div style='padding:20px; text-align:center;'>Pas de donn√©es trouv√©es.</div>";
        } else {
            for (const [catName, levelsObj] of Object.entries(compData)) {
                const phrases = levelsObj[level];
                if (phrases && phrases.length > 0) {
                    const h = document.createElement("div");
                    h.className = "bank-title";
                    h.innerText = catName;
                    list.appendChild(h);
                    phrases.forEach(txt => {
                        const d = document.createElement('div');
                        d.className = "comment-item";
                        d.innerText = txt;
                        d.onclick = () => {
                            let prev = CURRENT_TARGET_DIV.innerText;
                            if(prev && !prev.includes("Votre conseil")) CURRENT_TARGET_DIV.innerText += " " + txt;
                            else CURRENT_TARGET_DIV.innerText = txt;
                            closeModal(); markUnsaved();
                        };
                        list.appendChild(d);
                    });
                }
            }
        }
        document.getElementById('commentModal').style.display = "flex";
    }

    function openAppreciationBank() {
        CURRENT_TARGET_DIV = document.getElementById('appreciationArea');
        const list = document.getElementById('modalList');
        list.innerHTML = "";
        document.getElementById('modalTitle').innerText = "Appr√©ciations";
        const apprData = window.DATA_APPRECIATION || {};
        if(Object.keys(apprData).length === 0) {
            list.innerHTML = "<div style='padding:20px; text-align:center;'>Banque vide ou non charg√©e.</div>";
        }
        for (const [catName, data] of Object.entries(apprData)) {
            const h = document.createElement("div");
            h.className = "bank-title";
            h.innerText = catName;
            list.appendChild(h);
            if(Array.isArray(data)) {
                data.forEach(txt => {
                    const d = document.createElement('div');
                    d.className = "comment-item";
                    d.innerText = txt;
                    d.onclick = () => { insertText(txt, true); };
                    list.appendChild(d);
                });
            } else if (typeof data === 'object') {
                for (const [comp, phrases] of Object.entries(data)) {
                    phrases.forEach(txt => {
                        const d = document.createElement('div');
                        d.className = "comment-item";
                        d.innerHTML = `<strong>(${comp})</strong> ${txt}`;
                        d.onclick = () => { insertText(`(${comp}) ${txt}`, true); };
                        list.appendChild(d);
                    });
                }
            }
        }
        document.getElementById('commentModal').style.display = "flex";
    }

    function insertText(text, newLine) {
        if(CURRENT_TARGET_DIV) {
            const sep = (CURRENT_TARGET_DIV.value.length > 0 && newLine) ? "\n" : " ";
            CURRENT_TARGET_DIV.value += sep + text;
            autoResize(CURRENT_TARGET_DIV);
        }
        closeModal();
        markUnsaved();
    }

    function closeModal() { document.getElementById('commentModal').style.display = "none"; }

    function sortTable(n) {
        const table = document.getElementById("correctionTable");
        let rows = Array.from(table.rows).slice(1);
        rows.sort((a, b) => {
            let t1 = a.cells[n].innerText.toLowerCase();
            let t2 = b.cells[n].innerText.toLowerCase();
            if(n===0) return parseFloat(t1)-parseFloat(t2);
            return t1.localeCompare(t2);
        });
        rows.forEach(r => table.appendChild(r));
    }

    function resetNewStudent() { 
        if (!IS_SAVED) {
            if (!confirm("‚ö†Ô∏è Modifications non enregistr√©es !\n\nQuitter quand m√™me ?")) {
                return;
            }
        }
        window.close();
    }

    // ========== CHARGEMENT AU D√âMARRAGE ==========

    async function init() {
        initSummary([], {});

        // R√©cup√©rer les donn√©es depuis localStorage
        const rawData = localStorage.getItem("cockpit_transfert");
        
        if (!rawData) {
            document.getElementById('docTitle').innerText = "‚ö†Ô∏è Aucune copie s√©lectionn√©e";
            document.getElementById('statusText').innerHTML = "‚ùå Aucune copie";
            alert("Aucune copie √† corriger.\n\nUtilisez le bouton '‚úçÔ∏è Grille' depuis le Cockpit.");
            return;
        }

        // Supprimer imm√©diatement
        localStorage.removeItem("cockpit_transfert");

        try {
            const copy = JSON.parse(rawData);
            CURRENT_DOC_ID = copy.id;
            CURRENT_COPY = copy;
            
            console.log("‚úÖ Copie charg√©e:", copy);
            console.log("üìÑ Document ID:", CURRENT_DOC_ID);

            // Remplir les infos √©l√®ve
            document.getElementById('inputNom').value = copy.eleve?.nom || copy.eleve?.code || copy.identifiant || "";
            document.getElementById('inputPrenom').value = copy.eleve?.prenom || "";
            document.getElementById('inputClasse').value = copy.eleve?.classe || copy.classe || "";
            document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];

            // Charger le blueprint
            const idClean = String(copy.devoirId || "").trim().replace(/[^a-zA-Z0-9_-]/g, "");
            if (!idClean) throw new Error("devoirId vide ou invalide");

            console.log("üìÇ Chargement du blueprint:", idClean);

            const resp = await fetch(`${idClean}_blueprint.json?ts=${Date.now()}`, { cache: "no-store" });
            if (!resp.ok) throw new Error("Fichier blueprint non trouv√©: " + idClean + "_blueprint.json");

            CURRENT_BLUEPRINT = await resp.json();
            document.getElementById('docTitle').innerText = "Correction : " + (CURRENT_BLUEPRINT.titre || idClean);

            const questions = extractQuestionsFromBlueprint(CURRENT_BLUEPRINT);
            renderCorrection({ questions }, copy.reponses || {});

            // Charger la correction existante si elle existe
            if (copy.correction) {
                loadExistingCorrection(copy.correction);
            } else {
                IS_SAVED = false;
            }
            
            updateStatusBanner();
            console.log("‚úÖ Grille pr√™te !");

        } catch (e) {
            document.getElementById('statusText').innerHTML = "‚ùå Erreur";
            alert("Erreur de chargement:\n\n" + e.message);
            console.error(e);
        }
    }

    // Avertir avant de fermer si non sauvegard√©
    window.addEventListener('beforeunload', (e) => {
        if (!IS_SAVED) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // D√©marrage
    init();
</script>
</body>
</html>

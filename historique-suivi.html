<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã Historique Suivi - Cockpit PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data_modules.js"></script>
    <script src="data_eleves.js"></script>

    <!-- ‚≠ê MODULE MES √âL√àVES ‚≠ê -->
    <script>
    (function() {
        const CLE_ELEVES = 'cockpit_eleves_noms';
        window.getNomEleve = function(code) {
            if (!code) return null;
            const eleves = JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}');
            return eleves[code.toUpperCase()] || null;
        };
        window.afficherAvecNom = function(code) {
            if (!code) return code || '';
            const nom = window.getNomEleve(code);
            return nom ? code + ' (' + nom + ')' : code;
        };
        window.hasElevesCharges = function() {
            return Object.keys(JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}')).length > 0;
        };
        window.getNbElevesCharges = function() {
            return Object.keys(JSON.parse(localStorage.getItem(CLE_ELEVES) || '{}')).length;
        };
    })();
    </script>
    
    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --primary: #8b5cf6;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #dc2626;
            --border: #e2e8f0;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* === NAVIGATION === */
        .nav-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .nav-btn {
            padding: 10px 18px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .nav-btn.active {
            background: var(--primary);
            color: white;
        }
        .nav-btn:not(.active) {
            background: var(--card);
            color: var(--text);
            border: 2px solid var(--border);
        }
        .nav-btn:not(.active):hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* === HEADER === */
        .header {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.5em; margin-bottom: 5px; }
        
        /* === FILTRES === */
        .filters {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: var(--muted);
        }
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
        }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.9em; }
        .btn-search { background: var(--primary); color: white; width: 100%; }
        .btn-search:hover { background: #7c3aed; }
        
        /* === STATS === */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: var(--card);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-value { font-size: 1.6em; font-weight: 800; color: var(--primary); }
        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }
        .stat-label { font-size: 0.75em; color: var(--muted); margin-top: 3px; }
        
        /* === ALERTES === */
        .alert-doublons {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .alert-doublons-icon { font-size: 1.5em; }
        .alert-doublons-text { flex: 1; }
        .alert-doublons strong { color: #92400e; }
        
        /* === S√âANCE EN COURS === */
        .seance-encours {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 2px solid #22c55e;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .seance-info { display: flex; align-items: center; gap: 10px; }
        .seance-info-icon { font-size: 1.3em; }
        .btn-completer {
            background: #16a34a;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }
        .btn-completer:hover { background: #15803d; }
        
        /* === TABLE === */
        .table-container {
            background: var(--card);
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f8fafc; font-weight: 700; font-size: 0.75em; text-transform: uppercase; color: var(--muted); }
        tr:hover { background: #f8fafc; }
        tr.doublon { background: #fef3c7 !important; }
        
        .code-badge { font-weight: 700; background: #eff6ff; color: #3b82f6; padding: 4px 10px; border-radius: 6px; font-size: 0.85em; }
        .classe-badge { background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; }
        .module-badge { font-size: 0.85em; color: var(--muted); }
        
        .note-badge { padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 0.85em; }
        .note-badge.excellent { background: #dcfce7; color: #166534; }
        .note-badge.good { background: #dbeafe; color: #1e40af; }
        .note-badge.average { background: #fef3c7; color: #92400e; }
        .note-badge.poor { background: #fee2e2; color: #991b1b; }
        .note-badge.absent { background: #f3e8ff; color: #7c3aed; }
        
        .bav-badge, .tel-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 700;
        }
        .bav-badge { background: #fef3c7; color: #92400e; }
        .tel-badge { background: #fee2e2; color: #991b1b; }
        .bav-badge.ok, .tel-badge.ok { background: #dcfce7; color: #166534; }
        
        .cours-badge { font-size: 0.85em; }
        .cours-badge.oui { color: var(--success); }
        .cours-badge.non { color: var(--muted); }
        
        .actions-cell { display: flex; gap: 8px; }
        .btn-action {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-edit { background: #fef3c7; }
        .btn-edit:hover { background: #fde68a; }
        .btn-delete { background: #fee2e2; }
        .btn-delete:hover { background: #fecaca; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
        .empty-state-icon { font-size: 4em; margin-bottom: 15px; }
        
        /* === MODAL === */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            max-width: 550px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 1.2em; }
        .modal-close { background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--muted); }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95em;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .btn-cancel { background: #f1f5f9; color: var(--text); }
        .btn-save { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        /* === LOGIN === */
        .login-screen { max-width: 400px; margin: 60px auto; text-align: center; }
        .login-card { background: var(--card); padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .login-icon { font-size: 4em; margin-bottom: 20px; }
        .btn-google {
            display: inline-flex; align-items: center; gap: 12px;
            padding: 14px 28px; background: #4285f4; color: white;
            border: none; border-radius: 12px; font-size: 1em; font-weight: 600; cursor: pointer; margin-top: 20px;
        }
        .btn-google:hover { background: #3367d6; }
        
        /* === CHECKBOX COURS === */
        .cours-checks { display: flex; flex-wrap: wrap; gap: 10px; }
        .cours-check {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 12px; background: #f8fafc; border-radius: 8px; cursor: pointer;
        }
        .cours-check input { width: auto; margin: 0; }
        .cours-check.checked { background: #dbeafe; }
        
        @media (max-width: 768px) {
            .filters-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .nav-bar { justify-content: center; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- √âCRAN LOGIN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-icon">üîê</div>
            <h2>Acc√®s Professeur</h2>
            <p style="color: var(--muted); margin-top: 10px;">Connectez-vous pour acc√©der √† l'historique</p>
            <button class="btn-google" onclick="connexionGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#fff"/>
                </svg>
                Connexion avec Google
            </button>
        </div>
    </div>
    
    <!-- √âCRAN PRINCIPAL -->
    <div id="mainScreen" style="display: none;">
        
        <!-- NAVIGATION -->
        <nav class="nav-bar">
            <a href="suivi.html" class="nav-btn">üìù Suivi de Classe</a>
            <a href="dashboard.html" class="nav-btn">üìä Tableau de Bord</a>
            <a href="historique-suivi.html" class="nav-btn active">üìã Historique</a>
            <a href="index.html" class="nav-btn">üè† Cockpit</a>
        </nav>
        
        <!-- HEADER -->
        <div class="header">
            <h1>üìã Historique du Suivi</h1>
        </div>
        
        <!-- FILTRES -->
        <div class="filters">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Classe</label>
                    <select id="filterClasse">
                        <option value="">-- S√©lectionner --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date</label>
                    <input type="date" id="filterDate">
                </div>
                <div class="filter-group">
                    <label>√âl√®ve (optionnel)</label>
                    <input type="text" id="filterEleve" placeholder="Code √©l√®ve...">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-search" onclick="chargerHistorique()">üîç Rechercher</button>
                </div>
            </div>
        </div>
        
        <!-- ALERTE DOUBLONS (cach√©e par d√©faut) -->
        <div class="alert-doublons" id="alertDoublons" style="display: none;">
            <span class="alert-doublons-icon">‚ö†Ô∏è</span>
            <div class="alert-doublons-text">
                <strong><span id="nbDoublons">0</span> doublon(s) d√©tect√©(s) !</strong><br>
                <small>M√™me √©l√®ve + m√™me date + m√™me module. Les lignes concern√©es sont surlign√©es en orange.</small>
            </div>
        </div>
        
        <!-- STATS -->
        <div class="stats-bar">
            <div class="stat-item"><div class="stat-value" id="statSaisies">0</div><div class="stat-label">Saisies</div></div>
            <div class="stat-item"><div class="stat-value success" id="statPresents">0</div><div class="stat-label">Pr√©sents</div></div>
            <div class="stat-item"><div class="stat-value warning" id="statAbsents">0</div><div class="stat-label">Absents</div></div>
            <div class="stat-item"><div class="stat-value" id="statMoyenne">--</div><div class="stat-label">Moyenne</div></div>
        </div>
        
        <!-- S√âANCE EN COURS (cach√©e par d√©faut) -->
        <div class="seance-encours" id="seanceEncours" style="display: none;">
            <div class="seance-info">
                <span class="seance-info-icon">üìù</span>
                <div>
                    <strong>S√©ance en cours</strong><br>
                    <span id="seanceInfo">--</span>
                </div>
            </div>
            <button class="btn-completer" onclick="completerSeance()">+ Compl√©ter cette s√©ance</button>
        </div>
        
        <!-- TABLEAU -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>√âl√®ve</th>
                        <th>Classe</th>
                        <th>Module</th>
                        <th>Note</th>
                        <th>üí¨</th>
                        <th>üì±</th>
                        <th>Cours</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>S√©lectionnez une classe et cliquez sur Rechercher</p></div></td></tr>
                </tbody>
            </table>
        </div>
        
    </div>
    
</div>

<!-- MODAL √âDITION COMPLET -->
<div class="modal-overlay" id="modalEdit">
    <div class="modal">
        <div class="modal-header">
            <h2>‚úèÔ∏è Modifier la saisie</h2>
            <button class="modal-close" onclick="fermerModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>√âl√®ve</label>
                <input type="text" id="editEleve" readonly style="background: #f8fafc;">
            </div>
            
            <div class="form-group">
                <label>üìÖ Date de la s√©ance</label>
                <input type="date" id="editDate">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Note sur 20</label>
                    <input type="number" id="editNote" min="0" max="20" step="0.5">
                </div>
                <div class="form-group">
                    <label>Statut</label>
                    <select id="editStatut">
                        <option value="present">Pr√©sent (avec note)</option>
                        <option value="absent">Absent</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üìù Travail</label>
                    <select id="editTravail">
                        <option value="ne">-- Non √©valu√© --</option>
                        <option value="tresbien">‚úÖ Tr√®s bien</option>
                        <option value="fait">üëç Fait</option>
                        <option value="partiel">‚ö†Ô∏è Partiel</option>
                        <option value="insuffisant">‚ùå Insuffisant/Non fait</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üó£Ô∏è Participation orale</label>
                    <select id="editOral">
                        <option value="ne">-- Non √©valu√© --</option>
                        <option value="4">4 - Excellente</option>
                        <option value="3">3 - Bonne</option>
                        <option value="2">2 - Correcte</option>
                        <option value="1">1 - Faible</option>
                        <option value="0">0 - Aucune</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üëÅÔ∏è Attention</label>
                    <select id="editAttention">
                        <option value="ne">-- Non √©valu√© --</option>
                        <option value="bonne">‚úÖ Bonne</option>
                        <option value="moyenne">‚ö†Ô∏è Moyenne</option>
                        <option value="insuffisante">‚ùå Insuffisante</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üìÇ Porte-vue</label>
                    <select id="editPorteVue">
                        <option value="ne">-- Non √©valu√© --</option>
                        <option value="ok">‚úÖ OK</option>
                        <option value="incomplet">‚ö†Ô∏è Incomplet</option>
                        <option value="absent">‚ùå Absent</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üìñ Cours √† jour</label>
                    <select id="editCoursJour">
                        <option value="ne">-- Non √©valu√© --</option>
                        <option value="oui">‚úÖ Oui</option>
                        <option value="partiel">‚ö†Ô∏è Partiel</option>
                        <option value="non">‚ùå Non</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üéØ Autonomie</label>
                    <select id="editAutonomie">
                        <option value="ne">-- Non √©valu√© --</option>
                        <option value="bonne">‚úÖ Bonne</option>
                        <option value="moyenne">‚ö†Ô∏è Moyenne</option>
                        <option value="faible">‚ùå Faible</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üí° Initiative</label>
                    <select id="editInitiative">
                        <option value="ne">-- Non √©valu√© --</option>
                        <option value="oui">‚úÖ Oui</option>
                        <option value="non">‚ùå Non</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üõ°Ô∏è Respect du cadre</label>
                    <select id="editSecurite">
                        <option value="ne">-- Non √©valu√© --</option>
                        <option value="oui">‚úÖ Oui</option>
                        <option value="partiel">‚ö†Ô∏è Partiel</option>
                        <option value="non">‚ùå Non</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üí¨ Bavardage (plafonne la note)</label>
                    <select id="editBavardage">
                        <option value="aucun">‚úÖ Aucun</option>
                        <option value="rappel1">‚ö†Ô∏è Rappel 1 (max 14/20)</option>
                        <option value="rappel2">‚ö†Ô∏è Rappel 2 (max 10/20)</option>
                        <option value="rappel3">üö´ Rappel 3 (max 6/20)</option>
                        <option value="retenu">üö® Retenu (max 4/20)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üì± T√©l√©phone (malus)</label>
                    <select id="editTelephone">
                        <option value="ok">‚úÖ OK</option>
                        <option value="rappel1">‚ö†Ô∏è Rappel 1 (-1 pt)</option>
                        <option value="rappel2">‚ö†Ô∏è Rappel 2 (-2 pts)</option>
                        <option value="rappel3">üö´ Rappel 3 (-3 pts)</option>
                        <option value="confisque">üö´ Confisqu√© (-5 pts)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>üí¨ Commentaire</label>
                <textarea id="editCommentaire" rows="2" placeholder="Optionnel..."></textarea>
            </div>
            
            <div class="form-group">
                <label>üìÑ Cours distribu√©s / Actions</label>
                <div class="cours-checks" id="coursChecks">
                    <label class="cours-check"><input type="checkbox" id="checkS1" value="S1"> S1</label>
                    <label class="cours-check"><input type="checkbox" id="checkS2" value="S2"> S2</label>
                    <label class="cours-check"><input type="checkbox" id="checkS3" value="S3"> S3</label>
                    <label class="cours-check"><input type="checkbox" id="checkS4" value="S4"> S4</label>
                    <label class="cours-check"><input type="checkbox" id="checkComplet" value="complet"> üìö Complet</label>
                    <label class="cours-check"><input type="checkbox" id="checkCorrection" value="correction"> ‚úèÔ∏è Correction</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="fermerModal()">Annuler</button>
            <button class="btn btn-save" onclick="sauvegarderModification()">üíæ Sauvegarder</button>
        </div>
    </div>
</div>

<!-- MODAL SUPPRESSION -->
<div class="modal-overlay" id="modalDelete">
    <div class="modal">
        <div class="modal-header">
            <h2>üóëÔ∏è Supprimer cette saisie</h2>
            <button class="modal-close" onclick="fermerModalDelete()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Voulez-vous vraiment supprimer <strong>uniquement cette saisie</strong> ?</p>
            <p style="margin-top: 15px; padding: 15px; background: #fee2e2; border-radius: 8px; color: #991b1b;">
                <strong id="deleteInfo">--</strong>
            </p>
            <p style="margin-top: 15px; font-size: 0.9em; color: var(--muted);">
                ‚ö†Ô∏è Cette action est irr√©versible. Seule cette ligne sera supprim√©e.
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="fermerModalDelete()">Annuler</button>
            <button class="btn btn-danger" onclick="confirmerSuppression()">üóëÔ∏è Supprimer</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.appspot.com",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    
    let currentUser = null;
    let editingDoc = null;
    let deletingDoc = null;
    window.allSuivis = [];
    
    // Auth
    onAuthStateChanged(auth, (user) => {
        if (user && user.email === "ennealyon@gmail.com") {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            initClasses();
        } else if (user) {
            alert("Acc√®s non autoris√©");
            signOut(auth);
        }
    });
    
    window.connexionGoogle = async function() {
        try {
            await signInWithPopup(auth, googleProvider);
        } catch (error) {
            if (error.code === 'auth/popup-blocked') {
                await signInWithRedirect(auth, googleProvider);
            }
        }
    };
    
    getRedirectResult(auth).catch(console.error);
    
    // Init classes
    function initClasses() {
        const select = document.getElementById('filterClasse');
        const groupes = [
            { nom: "BTAGO (group√©)", classes: ["BTAGO1", "BTAGO2"] },
            { nom: "BTMELEC", classes: ["BTMELEC"] },
            { nom: "B1AGO (group√©)", classes: ["B1AGO1", "B1AGO2"] },
            { nom: "B2GATL (group√©)", classes: ["B2GATL1", "B2GATL2"] }
        ];
        groupes.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.classes.join(',');
            opt.textContent = g.nom;
            select.appendChild(opt);
        });
        const sep = document.createElement('option');
        sep.disabled = true;
        sep.textContent = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
        select.appendChild(sep);
        const classes = [...new Set((window.BDD_ELEVES || []).map(e => e.classe))].sort();
        classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            select.appendChild(opt);
        });
        
        // Date par d√©faut = aujourd'hui
        document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
    }
    
    // Charger historique
    window.chargerHistorique = async function() {
        const filterClasse = document.getElementById('filterClasse').value;
        const filterDate = document.getElementById('filterDate').value;
        const filterEleve = document.getElementById('filterEleve').value.trim().toUpperCase();
        const tbody = document.getElementById('tableBody');
        
        if (!filterClasse) {
            tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>S√©lectionnez une classe</p></div></td></tr>';
            return;
        }
        
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 40px;">‚è≥ Chargement...</td></tr>';
        
        try {
            const classesFiltre = filterClasse.split(',');
            const bdd = window.BDD_ELEVES || [];
            let elevesToSearch = [];
            
            if (filterEleve) {
                elevesToSearch = [filterEleve];
            } else {
                elevesToSearch = bdd.filter(e => classesFiltre.includes(e.classe)).map(e => e.userCode);
            }
            
            window.allSuivis = [];
            
            for (const code of elevesToSearch) {
                try {
                    const suiviRef = collection(db, "resultats", code, "suivi");
                    const suiviSnap = await getDocs(suiviRef);
                    suiviSnap.forEach(docSnap => {
                        const data = docSnap.data();
                        // Filtrer par date si sp√©cifi√©e
                        if (!filterDate || data.date === filterDate) {
                            window.allSuivis.push({
                                id: docSnap.id,
                                eleveCode: code,
                                ...data
                            });
                        }
                    });
                } catch (err) {}
            }
            
            // Tri par date d√©croissante puis par code
            window.allSuivis.sort((a, b) => {
                if (a.date !== b.date) return b.date.localeCompare(a.date);
                return a.eleveCode.localeCompare(b.eleveCode);
            });
            
            // D√©tection des doublons
            const doublonKeys = new Set();
            const compteur = {};
            window.allSuivis.forEach(s => {
                const key = `${s.eleveCode}_${s.date}_${s.module || 'C11'}`;
                compteur[key] = (compteur[key] || 0) + 1;
                if (compteur[key] > 1) doublonKeys.add(key);
            });
            
            // Afficher alerte doublons
            const nbDoublons = doublonKeys.size;
            if (nbDoublons > 0) {
                document.getElementById('alertDoublons').style.display = 'flex';
                document.getElementById('nbDoublons').textContent = nbDoublons;
            } else {
                document.getElementById('alertDoublons').style.display = 'none';
            }
            
            // Stats
            const presents = window.allSuivis.filter(s => !s.absent);
            const absents = window.allSuivis.filter(s => s.absent);
            const notes = presents.filter(s => s.noteSur20 !== null && s.noteSur20 !== undefined).map(s => s.noteSur20);
            const moyenne = notes.length > 0 ? (notes.reduce((a,b) => a+b, 0) / notes.length).toFixed(1) : '--';
            
            document.getElementById('statSaisies').textContent = window.allSuivis.length;
            document.getElementById('statPresents').textContent = presents.length;
            document.getElementById('statAbsents').textContent = absents.length;
            document.getElementById('statMoyenne').textContent = moyenne;
            
            // S√©ance en cours
            if (filterDate) {
                const classesEffectives = classesFiltre;
                const elevesClasse = bdd.filter(e => classesEffectives.includes(e.classe));
                const elevesNotes = window.allSuivis.map(s => s.eleveCode);
                const elevesRestants = elevesClasse.filter(e => !elevesNotes.includes(e.userCode));
                
                if (elevesRestants.length > 0 && window.allSuivis.length > 0) {
                    document.getElementById('seanceEncours').style.display = 'flex';
                    document.getElementById('seanceInfo').textContent = 
                        `${window.allSuivis.length} √©l√®ves not√©s sur ${elevesClasse.length} ‚Äî ${elevesRestants.length} restant(s)`;
                    window.elevesRestantsSeance = elevesRestants.map(e => e.userCode);
                } else {
                    document.getElementById('seanceEncours').style.display = 'none';
                }
            } else {
                document.getElementById('seanceEncours').style.display = 'none';
            }
            
            // Afficher tableau
            if (window.allSuivis.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>Aucune saisie trouv√©e</p></div></td></tr>';
                return;
            }
            
            tbody.innerHTML = window.allSuivis.map((s, idx) => {
                const key = `${s.eleveCode}_${s.date}_${s.module || 'C11'}`;
                const isDoublon = doublonKeys.has(key);
                
                const noteClass = s.absent ? 'absent' : getNoteClass(s.noteSur20);
                const noteDisplay = s.absent ? 'ABS' : (s.noteSur20 !== null ? s.noteSur20 + '/20' : '--');
                
                const bavCount = getBavCount(s.bavardage);
                const telCount = getTelCount(s.telephone);
                
                const coursDisplay = getCoursDisplay(s);
                
                return `<tr class="${isDoublon ? 'doublon' : ''}" data-idx="${idx}">
                    <td>${isDoublon ? '‚ö†Ô∏è ' : ''}${formatDate(s.date)} ${s.heure || ''}</td>
                    <td><span class="code-badge">${window.afficherAvecNom(s.eleveCode)}</span></td>
                    <td><span class="classe-badge">${s.classe || '--'}</span></td>
                    <td><span class="module-badge">${s.module || 'C11'}</span></td>
                    <td><span class="note-badge ${noteClass}">${noteDisplay}</span></td>
                    <td>${bavCount !== null ? '<span class="bav-badge' + (bavCount === 0 ? ' ok' : '') + '">' + (bavCount || '‚úì') + '</span>' : '-'}</td>
                    <td>${telCount !== null ? '<span class="tel-badge' + (telCount === 0 ? ' ok' : '') + '">' + (telCount || '‚úì') + '</span>' : '-'}</td>
                    <td><span class="cours-badge ${s.coursRecu ? 'oui' : 'non'}">${coursDisplay}</span></td>
                    <td class="actions-cell">
                        <button class="btn-action btn-edit" onclick="ouvrirModalEdit(${idx})" title="Modifier">‚úèÔ∏è</button>
                        <button class="btn-action btn-delete" onclick="ouvrirModalDelete(${idx})" title="Supprimer">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
            
        } catch (error) {
            console.error("Erreur:", error);
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 40px; color: #dc2626;">‚ùå Erreur de chargement</td></tr>';
        }
    };
    
    function getNoteClass(note) {
        if (note === null || note === undefined) return '';
        if (note >= 16) return 'excellent';
        if (note >= 12) return 'good';
        if (note >= 8) return 'average';
        return 'poor';
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return '--';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    }
    
    function getBavCount(bav) {
        const map = { 'aucun': 0, 'rappel1': 1, 'rappel2': 2, 'rappel3': 3, 'retenu': 4 };
        return bav ? (map[bav] ?? null) : null;
    }
    
    function getTelCount(tel) {
        const map = { 'ok': 0, 'rappel1': 1, 'rappel2': 2, 'rappel3': 3, 'confisque': 4 };
        return tel ? (map[tel] ?? null) : null;
    }
    
    function getCoursDisplay(s) {
        if (!s.coursRecu && !s.coursDistrib && !s.S1 && !s.S2 && !s.S3 && !s.S4) return '-';
        const parts = [];
        // G√©rer les nouveaux champs S1, S2, etc.
        if (s.S1) parts.push('S1');
        if (s.S2) parts.push('S2');
        if (s.S3) parts.push('S3');
        if (s.S4) parts.push('S4');
        if (s.coursComplet) parts.push('üìö');
        if (s.correction) parts.push('‚úèÔ∏è');
        // Ancien format coursDistrib
        if (s.coursDistrib && typeof s.coursDistrib === 'string') {
            if (s.coursDistrib === 'complet') parts.push('üìö');
            else if (s.coursDistrib.includes('seance')) {
                const num = s.coursDistrib.replace('seance', '');
                if (num && !parts.includes('S' + num)) parts.push('S' + num);
            }
        }
        return parts.length > 0 ? '‚úÖ ' + parts.join(' ') : '-';
    }
    
    // Compl√©ter s√©ance
    window.completerSeance = function() {
        const filterClasse = document.getElementById('filterClasse').value;
        const filterDate = document.getElementById('filterDate').value;
        const premier = window.allSuivis[0];
        const module = premier ? premier.module : 'C11';
        
        // R√©cup√©rer les codes des √©l√®ves d√©j√† not√©s
        const elevesNotes = window.allSuivis.map(s => s.eleveCode).join(',');
        
        // Rediriger vers suivi.html avec les param√®tres (reprendre=true pour garder la date)
        window.location.href = `suivi.html?classe=${encodeURIComponent(filterClasse)}&date=${filterDate}&module=${module}&reprendre=true&elevesNotes=${encodeURIComponent(elevesNotes)}`;
    };
    
    // === MODAL √âDITION ===
    window.ouvrirModalEdit = function(idx) {
        const s = window.allSuivis[idx];
        editingDoc = s;
        
        document.getElementById('editEleve').value = window.afficherAvecNom(s.eleveCode) + ' - ' + (s.classe || '');
        document.getElementById('editDate').value = s.date || '';
        document.getElementById('editNote').value = s.noteSur20 ?? '';
        document.getElementById('editStatut').value = s.absent ? 'absent' : 'present';
        document.getElementById('editCommentaire').value = s.commentaire || '';
        
        // Champs complets
        document.getElementById('editTravail').value = s.travail || 'ne';
        document.getElementById('editOral').value = s.oral !== undefined && s.oral !== null ? String(s.oral) : 'ne';
        document.getElementById('editAttention').value = s.attention || 'ne';
        document.getElementById('editPorteVue').value = s.porteVue || 'ne';
        document.getElementById('editCoursJour').value = s.coursJour || 'ne';
        document.getElementById('editAutonomie').value = s.autonomie || 'ne';
        document.getElementById('editInitiative').value = s.initiative || 'ne';
        document.getElementById('editSecurite').value = s.securite || 'ne';
        
        document.getElementById('editBavardage').value = s.bavardage || 'aucun';
        document.getElementById('editTelephone').value = s.telephone || 'ok';
        
        // Checkboxes cours
        document.getElementById('checkS1').checked = s.S1 || (s.coursDistrib === 'seance1');
        document.getElementById('checkS2').checked = s.S2 || (s.coursDistrib === 'seance2');
        document.getElementById('checkS3').checked = s.S3 || (s.coursDistrib === 'seance3');
        document.getElementById('checkS4').checked = s.S4 || (s.coursDistrib === 'seance4');
        document.getElementById('checkComplet').checked = s.coursComplet || (s.coursDistrib === 'complet');
        document.getElementById('checkCorrection').checked = s.correction || false;
        
        document.getElementById('modalEdit').classList.add('active');
    };
    
    window.fermerModal = function() {
        document.getElementById('modalEdit').classList.remove('active');
        editingDoc = null;
    };
    
    // Plafonds et malus
    const PLAFOND_BAVARDAGE = { 'aucun': 20, 'rappel1': 14, 'rappel2': 10, 'rappel3': 6, 'retenu': 4 };
    const MALUS_TELEPHONE = { 'ok': 0, 'rappel1': 1, 'rappel2': 2, 'rappel3': 3, 'confisque': 5 };
    
    window.sauvegarderModification = async function() {
        if (!editingDoc) return;
        
        const newDate = document.getElementById('editDate').value;
        const oldDate = editingDoc.date;
        const dateChanged = newDate !== oldDate;
        
        const statut = document.getElementById('editStatut').value;
        let note = parseFloat(document.getElementById('editNote').value) || 0;
        const commentaire = document.getElementById('editCommentaire').value.trim();
        
        const bavardage = document.getElementById('editBavardage').value;
        const telephone = document.getElementById('editTelephone').value;
        
        // Recalculer note
        const plafond = PLAFOND_BAVARDAGE[bavardage] || 20;
        const malus = MALUS_TELEPHONE[telephone] || 0;
        let noteFinale = Math.min(note, plafond);
        noteFinale = Math.max(0, noteFinale - malus);
        noteFinale = Math.round(noteFinale * 2) / 2;
        
        // R√©cup√©rer tous les champs
        const updateData = {
            date: newDate,
            absent: statut === 'absent',
            noteSur20: statut === 'absent' ? null : noteFinale,
            bavardage: bavardage,
            telephone: telephone,
            plafond: plafond,
            malus: malus,
            commentaire: commentaire || null,
            travail: document.getElementById('editTravail').value,
            oral: document.getElementById('editOral').value === 'ne' ? null : parseInt(document.getElementById('editOral').value),
            attention: document.getElementById('editAttention').value,
            porteVue: document.getElementById('editPorteVue').value,
            coursJour: document.getElementById('editCoursJour').value,
            autonomie: document.getElementById('editAutonomie').value,
            initiative: document.getElementById('editInitiative').value,
            securite: document.getElementById('editSecurite').value,
            S1: document.getElementById('checkS1').checked,
            S2: document.getElementById('checkS2').checked,
            S3: document.getElementById('checkS3').checked,
            S4: document.getElementById('checkS4').checked,
            coursComplet: document.getElementById('checkComplet').checked,
            correction: document.getElementById('checkCorrection').checked,
            coursRecu: document.getElementById('checkS1').checked || document.getElementById('checkS2').checked || 
                       document.getElementById('checkS3').checked || document.getElementById('checkS4').checked ||
                       document.getElementById('checkComplet').checked
        };
        
        try {
            if (dateChanged) {
                // IMPORTANT: Si la date change, supprimer l'ancien doc et cr√©er un nouveau
                const oldRef = doc(db, "resultats", editingDoc.eleveCode, "suivi", editingDoc.id);
                await deleteDoc(oldRef);
                
                // Cr√©er nouveau doc avec nouvel ID bas√© sur la date
                const newId = newDate + '_' + (editingDoc.module || 'C11') + '_' + Date.now();
                const newRef = doc(db, "resultats", editingDoc.eleveCode, "suivi", newId);
                await setDoc(newRef, {
                    ...updateData,
                    classe: editingDoc.classe,
                    module: editingDoc.module || 'C11',
                    heure: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})
                });
                
                alert("‚úÖ Modification enregistr√©e ! (Date chang√©e: ancien document supprim√©)");
            } else {
                // Date inchang√©e: simple mise √† jour
                const ref = doc(db, "resultats", editingDoc.eleveCode, "suivi", editingDoc.id);
                await updateDoc(ref, updateData);
                alert("‚úÖ Modification enregistr√©e ! Note finale: " + noteFinale + "/20");
            }
            
            fermerModal();
            chargerHistorique();
            
        } catch (err) {
            console.error("Erreur modification:", err);
            alert("Erreur: " + err.message);
        }
    };
    
    // === MODAL SUPPRESSION ===
    window.ouvrirModalDelete = function(idx) {
        const s = window.allSuivis[idx];
        deletingDoc = s;
        
        document.getElementById('deleteInfo').textContent = 
            `${window.afficherAvecNom(s.eleveCode)} - ${formatDate(s.date)} - ${s.absent ? 'Absent' : s.noteSur20 + '/20'}`;
        
        document.getElementById('modalDelete').classList.add('active');
    };
    
    window.fermerModalDelete = function() {
        document.getElementById('modalDelete').classList.remove('active');
        deletingDoc = null;
    };
    
    // CORRECTION: Suppression d'UNE SEULE ligne
    window.confirmerSuppression = async function() {
        if (!deletingDoc) return;
        
        try {
            // Supprimer UNIQUEMENT ce document sp√©cifique
            const ref = doc(db, "resultats", deletingDoc.eleveCode, "suivi", deletingDoc.id);
            await deleteDoc(ref);
            
            alert("‚úÖ Saisie supprim√©e !");
            fermerModalDelete();
            chargerHistorique();
            
        } catch (err) {
            console.error("Erreur suppression:", err);
            alert("Erreur: " + err.message);
        }
    };
    
    console.log("‚úÖ Historique Suivi v2 pr√™t (correction doublons + formulaire complet)");
</script>

</body>
</html>

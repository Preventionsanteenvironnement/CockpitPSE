<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Page prof – Résultats exercices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f4f4f5;
      margin:0;
      padding:0;
    }
    .page{
      max-width:1000px;
      margin:0 auto;
      padding:20px 16px 60px;
    }
    h1{
      font-size:1.6rem;
      margin:0 0 .35rem;
    }
    p{
      font-size:.95rem;
      color:#4b5563;
      margin:.2rem 0 0;
    }
    .card{
      margin-top:16px;
      background:#fff;
      border-radius:12px;
      padding:16px 18px;
      box-shadow:0 8px 18px rgba(15,23,42,.08);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.92rem;
    }
    th,td{
      padding:10px 8px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
      vertical-align:top;
    }
    th{
      background:#f3f4f6;
      font-weight:700;
    }
    tr:hover td{
      background:#f9fafb;
    }
    .btn{
      padding:7px 12px;
      border-radius:999px;
      border:0;
      font-size:.85rem;
      font-weight:700;
      cursor:pointer;
      background:#2563eb;
      color:#fff;
      white-space:nowrap;
    }
    .btn-refresh{
      background:#6b7280;
    }
    .btn-reset{
      background:#0f172a;
    }
    .status{
      margin-top:10px;
      font-size:.9rem;
    }
    .ok{color:#16a34a;}
    .err{color:#dc2626;}
    .muted{color:#6b7280;}
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .pill{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      background:#eef2ff;
      color:#3730a3;
      font-weight:700;
      font-size:.78rem;
    }
    .filters{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .filters input,
    .filters select{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      font-size:.85rem;
      min-width:160px;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Page prof – Résultats exercices</h1>
    <p>
      Liste des résultats envoyés par les exercices.
      Les nouvelles versions utilisent identifiant élève et classe (dans meta).
    </p>

    <div class="card">
      <div class="row">
        <button class="btn btn-refresh" id="refresh-btn">Actualiser</button>
        <div id="status" class="status muted"></div>
      </div>

      <div class="filters">
        <input id="filter-identifiant" type="text" placeholder="Filtrer par identifiant…" />
        <select id="filter-classe">
          <option value="">Toutes les classes</option>
        </select>
        <button class="btn btn-reset" id="clear-filters-btn" type="button">Réinitialiser les filtres</button>
      </div>

      <div style="overflow-x:auto;margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Identifiant</th>
              <th>Classe</th>
              <th>Exercice</th>
              <th>Score</th>
              <th>Lien</th>
              <th>JSON</th>
            </tr>
          </thead>
          <tbody id="body">
            <tr><td colspan="8">Chargement…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.firebasestorage.app",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tbody = document.getElementById("body");
    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refresh-btn");

    const filterIdInput = document.getElementById("filter-identifiant");
    const filterClasseSelect = document.getElementById("filter-classe");
    const clearFiltersBtn = document.getElementById("clear-filters-btn");

    let allRows = [];

    function setStatus(text, cls="muted"){
      statusEl.className = "status " + cls;
      statusEl.textContent = text;
    }

    function asDate(iso){
      if(!iso) return "—";
      const d = new Date(iso);
      if(String(d) === "Invalid Date") return iso;
      return d.toLocaleString("fr-FR");
    }

    // Normalisation d’un document Firestore
    function normalize(docSnap){
      const data = docSnap.data() || {};
      const meta = data.meta || {};
      const res  = data.resultat || {};

      const createdAt   = meta.createdAt || data.createdAt || "";
      const identifiant = meta.nom || data.identifiant || "";
      const classe      = meta.classe || data.classe || "";
      const support     = meta.support || data.exercice || "";
      const score       = res.score || data.score || "";
      const url         = res.url || data.url || "";

      return {
        id: docSnap.id,
        raw: data,
        createdAt,
        identifiant,
        classe,
        exercice: support,
        score,
        url
      };
    }

    function downloadJSON(row){
      const blob = new Blob([JSON.stringify(row.raw, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);

      const safeSupport = (row.exercice || "exercice").replace(/[^\w\-]+/g,"_").slice(0,60);
      const safeId = (row.identifiant || "eleve").replace(/[^\w\-]+/g,"_").slice(0,40);
      const safeDate = (row.createdAt || "").replace(/[^\w\-]+/g,"_").slice(0,30);

      const filename = "exo_" + safeSupport + "_" + safeId + "_" + safeDate + ".json";

      const a = document.createElement("a");
      a.href = url;
      a.download = filename || "exercice.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function buildClasseOptions(){
      if(!filterClasseSelect) return;
      const classes = Array.from(new Set(allRows.map(r => r.classe).filter(Boolean))).sort();
      filterClasseSelect.innerHTML = '<option value="">Toutes les classes</option>';
      classes.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        filterClasseSelect.appendChild(opt);
      });
    }

    function renderTable(){
      if(!tbody) return;

      let rows = allRows.slice();

      const idFilter = (filterIdInput?.value || "").trim().toLowerCase();
      const classeFilter = (filterClasseSelect?.value || "").trim();

      if(idFilter){
        rows = rows.filter(r => (r.identifiant || "").toLowerCase().includes(idFilter));
      }
      if(classeFilter){
        rows = rows.filter(r => (r.classe || "") === classeFilter);
      }

      tbody.innerHTML = "";

      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="8">Aucun résultat avec ces filtres.</td></tr>`;
      } else {
        rows.forEach((row, i)=>{
          const tr = document.createElement("tr");

          const linkCell = document.createElement("td");
          if(row.url){
            const a = document.createElement("a");
            a.href = row.url;
            a.target = "_blank";
            a.rel = "noopener";
            a.textContent = "Ouvrir";
            a.className = "pill";
            linkCell.appendChild(a);
          }else{
            linkCell.textContent = "—";
            linkCell.className = "muted";
          }

          const jsonCell = document.createElement("td");
          const b = document.createElement("button");
          b.className = "btn";
          b.textContent = "Télécharger";
          b.type = "button";
          b.addEventListener("click", ()=> downloadJSON(row));
          jsonCell.appendChild(b);

          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${asDate(row.createdAt)}</td>
            <td>${row.identifiant || "—"}</td>
            <td>${row.classe || "—"}</td>
            <td>${row.exercice || "—"}</td>
            <td>${row.score || "—"}</td>
          `;
          tr.appendChild(linkCell);
          tr.appendChild(jsonCell);
          tbody.appendChild(tr);
        });
      }

      setStatus(`${rows.length} résultat(s) affiché(s) sur ${allRows.length}.`, "ok");
    }

    async function load(){
      try{
        setStatus("Chargement…");
        tbody.innerHTML = `<tr><td colspan="8">Chargement…</td></tr>`;

        const snap = await getDocs(collection(db, "exercices"));
        const rows = [];
        snap.forEach(d => rows.push(normalize(d)));

        if(!rows.length){
          allRows = [];
          tbody.innerHTML = `<tr><td colspan="8">Aucun résultat pour l’instant.</td></tr>`;
          setStatus("0 résultat.", "ok");
          return;
        }

        rows.sort((a,b)=> String(b.createdAt||"").localeCompare(String(a.createdAt||"")));
        allRows = rows;

        buildClasseOptions();
        renderTable();
      }catch(e){
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="8">Erreur technique.</td></tr>`;
        setStatus("Erreur Firebase : " + e.message, "err");
      }
    }

    refreshBtn.addEventListener("click", () => {
      if(filterIdInput) filterIdInput.value = "";
      if(filterClasseSelect) filterClasseSelect.value = "";
      load();
    });

    if(filterIdInput){
      filterIdInput.addEventListener("input", renderTable);
    }
    if(filterClasseSelect){
      filterClasseSelect.addEventListener("change", renderTable);
    }
    if(clearFiltersBtn){
      clearFiltersBtn.addEventListener("click", () => {
        if(filterIdInput) filterIdInput.value = "";
        if(filterClasseSelect) filterClasseSelect.value = "";
        renderTable();
      });
    }

    load();
  </script>
</body>
</html>

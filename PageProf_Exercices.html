<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Page prof ‚Äì Exercices (anonymes)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f4f4f5;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#e5e7eb;
      --brand:#2563eb;
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#f59e0b;
      --radius:14px;
      --shadow:0 10px 24px rgba(15,23,42,.08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:22px 16px 60px;
    }
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    h1{
      margin:0;
      font-size:1.35rem;
      letter-spacing:.2px;
    }
    .sub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:.95rem;
      line-height:1.35;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin-top:14px;
    }
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .left, .right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:1px solid transparent;
      background:var(--brand);
      color:#fff;
      padding:9px 12px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      font-size:.92rem;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .btn.secondary{
      background:#64748b;
    }
    .btn.ghost{
      background:#fff;
      border-color:var(--border);
      color:var(--text);
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fff;
      font-weight:800;
      font-size:.9rem;
      color:var(--text);
      white-space:nowrap;
    }
    .pill input[type="checkbox"]{ transform:scale(1.05); }
    .input{
      border:1px solid var(--border);
      border-radius:999px;
      padding:9px 12px;
      background:#fff;
      font-weight:700;
      font-size:.92rem;
      min-width:220px;
      outline:none;
    }
    .select{
      border:1px solid var(--border);
      border-radius:999px;
      padding:9px 12px;
      background:#fff;
      font-weight:800;
      font-size:.92rem;
      outline:none;
    }
    .status{
      margin-top:10px;
      font-size:.9rem;
      font-weight:800;
    }
    .status.ok{ color:var(--ok); }
    .status.err{ color:var(--bad); }
    .status.warn{ color:var(--warn); }

    .tbl-wrap{
      margin-top:12px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:.92rem;
      min-width:900px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:1;
      background:#f8fafc;
      text-align:left;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-weight:900;
      color:#0f172a;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid #f1f5f9;
      vertical-align:middle;
      color:#0f172a;
    }
    tbody tr:hover td{ background:#f8fafc; }
    .muted{ color:var(--muted); font-weight:700; }
    .mono{
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.10);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      background:#fff;
    }
    .chip.ok{ background:rgba(34,197,94,.14); color:#15803d; border-color:rgba(34,197,94,.22); }
    .chip.mid{ background:rgba(245,158,11,.14); color:#b45309; border-color:rgba(245,158,11,.22); }
    .chip.bad{ background:rgba(239,68,68,.12); color:#b91c1c; border-color:rgba(239,68,68,.22); }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .link{
      color:var(--brand);
      font-weight:900;
      text-decoration:none;
    }
    .link:hover{ text-decoration:underline; }

    @media (max-width: 720px){
      header{ align-items:flex-start; flex-direction:column; }
      .input{ min-width: 180px; }
      table{ min-width: 860px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <h1>Page prof ‚Äì Exercices (anonymes)</h1>
        <div class="sub">
          Cette page liste les r√©sultats envoy√©s depuis les exercices (sans nom ni classe).<br>
          Elle lit une collection Firestore d√©di√©e : <span class="mono" id="colName"></span>
        </div>
      </div>
      <div class="pill mono" title="Derni√®re mise √† jour">
        ‚è±Ô∏è <span id="lastUpdate">‚Äî</span>
      </div>
    </header>

    <div class="card">
      <div class="toolbar">
        <div class="left">
          <button class="btn secondary" id="refreshBtn">üîÑ Actualiser</button>

          <label class="pill" title="Rafra√Æchir automatiquement toutes les 10 secondes">
            <input type="checkbox" id="autoChk" />
            Auto 10s
          </label>

          <select class="select" id="limitSel" title="Nombre max d'entr√©es">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
            <option value="500">500</option>
          </select>

          <input class="input" id="searchInput" placeholder="Rechercher (activit√©, score, url, type...)" />
        </div>

        <div class="right">
          <button class="btn ghost" id="exportAllJsonBtn">‚¨áÔ∏è Tout JSON</button>
          <button class="btn ghost" id="exportAllCsvBtn">‚¨áÔ∏è Tout CSV</button>
        </div>
      </div>

      <div id="status" class="status"></div>

      <div class="tbl-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Activit√©</th>
              <th>Score</th>
              <th>Type</th>
              <th>URL</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" class="muted">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      orderBy,
      limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const EXERCISES_COLLECTION = "exercices";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.firebasestorage.app",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55",
      measurementId: "G-7R9N0JL6GG"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const colNameEl = document.getElementById("colName");
    const tbody = document.getElementById("tbody");
    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refreshBtn");
    const autoChk = document.getElementById("autoChk");
    const limitSel = document.getElementById("limitSel");
    const searchInput = document.getElementById("searchInput");
    const lastUpdateEl = document.getElementById("lastUpdate");
    const exportAllJsonBtn = document.getElementById("exportAllJsonBtn");
    const exportAllCsvBtn = document.getElementById("exportAllCsvBtn");

    colNameEl.textContent = EXERCISES_COLLECTION;

    let cacheRows = [];
    let autoTimer = null;

    function setStatus(msg, type = "") {
      statusEl.textContent = msg;
      statusEl.className = "status";
      if (type) statusEl.classList.add(type);
    }

    function nowLabel(){
      return new Date().toLocaleString("fr-FR", { weekday:"short", day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" });
    }

    function parseDateAny(v){
      if(!v) return null;

      if (typeof v === "string") {
        const d = new Date(v);
        return isNaN(d.getTime()) ? null : d;
      }

      if (typeof v === "number") {
        const d = new Date(v);
        return isNaN(d.getTime()) ? null : d;
      }

      if (typeof v === "object") {
        // Firestore Timestamp-like
        if (typeof v.toDate === "function") {
          const d = v.toDate();
          return d && !isNaN(d.getTime()) ? d : null;
        }
        if (typeof v.seconds === "number") {
          const d = new Date(v.seconds * 1000);
          return isNaN(d.getTime()) ? null : d;
        }
      }

      return null;
    }

    function scoreChip(scoreStr){
      const s = (scoreStr || "").toString().trim();
      const m = s.match(/(\d+)\s*\/\s*(\d+)/);
      if(!m) return `<span class="chip mid mono">${escapeHtml(s || "‚Äî")}</span>`;
      const got = Number(m[1]);
      const tot = Number(m[2] || 0) || 0;
      if(!tot) return `<span class="chip mid mono">${escapeHtml(s)}</span>`;
      const pct = got / tot;
      const cls = pct >= 0.8 ? "ok" : (pct >= 0.5 ? "mid" : "bad");
      return `<span class="chip ${cls} mono">${escapeHtml(s)}</span>`;
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalize(str){
      return (str ?? "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function rowToExport(row){
      // Format souple : on garde ce qui est utile, sans imposer nom/classe
      return {
        id: row.id || "",
        createdAt: row.createdAt || row.meta?.createdAt || row.timestamp || "",
        exercice: row.exercice || row.activity || row.titre || row.title || row.meta?.title || "",
        score: row.score || row.resultat || row.note || "",
        type: row.type || row.kind || row.meta?.type || "exercice",
        url: row.url || row.meta?.url || row.sourceUrl || "",
        payload: row.payload || row.reponses || row.data || row.meta?.payload || null,
        meta: row.meta || null
      };
    }

    function downloadFile(content, mime, filename){
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportAllJSON(rows){
      const out = rows.map(rowToExport);
      downloadFile(JSON.stringify(out, null, 2), "application/json", "exercices_anonymes.json");
    }

    function exportAllCSV(rows){
      const out = rows.map(rowToExport);
      const headers = ["id","createdAt","exercice","score","type","url"];
      const lines = [headers.join(",")];
      out.forEach(o => {
        const line = headers.map(h => {
          const v = (o[h] ?? "").toString().replaceAll('"','""');
          return `"${v}"`;
        }).join(",");
        lines.push(line);
      });
      downloadFile(lines.join("\n"), "text/csv", "exercices_anonymes.csv");
    }

    function downloadOneJSON(row){
      const obj = rowToExport(row);
      const safeTitle = normalize(obj.exercice || "exercice").slice(0, 28).replace(/[^\w\-]+/g, "_") || "exercice";
      const filename = `exercice_${safeTitle}_${(row.id || "").slice(0,8) || "id"}.json`;
      downloadFile(JSON.stringify(obj, null, 2), "application/json", filename);
    }

    function applySearchAndRender(){
      const q = normalize(searchInput.value);
      const filtered = !q ? cacheRows : cacheRows.filter(r => {
        const d = parseDateAny(r.createdAt || r.meta?.createdAt || r.timestamp);
        const dateTxt = d ? d.toLocaleString("fr-FR") : "";
        const hay = normalize([
          r.exercice, r.activity, r.titre, r.title,
          r.score, r.type, r.url, r.kind,
          dateTxt,
          r.id
        ].filter(Boolean).join(" "));
        return hay.includes(q);
      });
      renderRows(filtered);
      setStatus(`${filtered.length} r√©sultat(s) affich√©(s)${q ? " (filtr√©)" : ""}.`, "ok");
    }

    function renderRows(rows){
      tbody.innerHTML = "";
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="7" class="muted">Aucun r√©sultat pour l‚Äôinstant.</td></tr>`;
        return;
      }

      rows.forEach((row, idx) => {
        const d = parseDateAny(row.createdAt || row.meta?.createdAt || row.timestamp);
        const dateStr = d ? d.toLocaleString("fr-FR") : "‚Äî";
        const exercice = row.exercice || row.activity || row.titre || row.title || "‚Äî";
        const score = row.score || "‚Äî";
        const type = row.type || row.kind || row.meta?.type || "exercice";
        const url = row.url || row.meta?.url || row.sourceUrl || "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${idx + 1}</td>
          <td class="mono">${escapeHtml(dateStr)}</td>
          <td><b>${escapeHtml(exercice)}</b></td>
          <td>${scoreChip(score)}</td>
          <td><span class="chip mono">${escapeHtml(type)}</span></td>
          <td>
            ${url ? `<a class="link" href="${escapeHtml(url)}" target="_blank" rel="noopener">ouvrir</a>` : `<span class="muted">‚Äî</span>`}
          </td>
          <td class="actions"></td>
        `;
        const actionsTd = tr.querySelector(".actions");
        const btnJson = document.createElement("button");
        btnJson.className = "btn";
        btnJson.type = "button";
        btnJson.textContent = "JSON";
        btnJson.addEventListener("click", () => downloadOneJSON(row));
        actionsTd.appendChild(btnJson);

        tbody.appendChild(tr);
      });
    }

    async function loadRows(){
      try{
        refreshBtn.disabled = true;
        setStatus("Chargement‚Ä¶");

        const lim = Number(limitSel.value || 100) || 100;

        // Tentative de tri par createdAt si le champ existe, sinon fallback sans tri
        let snap;
        try{
          const qy = query(
            collection(db, EXERCISES_COLLECTION),
            orderBy("createdAt", "desc"),
            limit(lim)
          );
          snap = await getDocs(qy);
        }catch(_){
          const qy2 = query(
            collection(db, EXERCISES_COLLECTION),
            limit(lim)
          );
          snap = await getDocs(qy2);
        }

        const rows = [];
        snap.forEach(docSnap => rows.push({ id: docSnap.id, ...docSnap.data() }));

        // Tri robuste : createdAt / meta.createdAt / timestamp
        rows.sort((a,b) => {
          const da = parseDateAny(a.createdAt || a.meta?.createdAt || a.timestamp);
          const dbv = parseDateAny(b.createdAt || b.meta?.createdAt || b.timestamp);
          const ta = da ? da.getTime() : 0;
          const tb = dbv ? dbv.getTime() : 0;
          return tb - ta;
        });

        cacheRows = rows;

        lastUpdateEl.textContent = nowLabel();

        if(!rows.length){
          tbody.innerHTML = `<tr><td colspan="7" class="muted">Aucun r√©sultat pour l‚Äôinstant.</td></tr>`;
          setStatus("0 r√©sultat.", "warn");
          return;
        }

        applySearchAndRender();
      }catch(err){
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="7" class="muted">Erreur technique.</td></tr>`;
        setStatus("Erreur Firebase : " + (err?.message || err), "err");
      }finally{
        refreshBtn.disabled = false;
      }
    }

    function setAuto(on){
      if(autoTimer) clearInterval(autoTimer);
      autoTimer = null;
      if(on){
        autoTimer = setInterval(loadRows, 10000);
      }
    }

    refreshBtn.addEventListener("click", loadRows);
    limitSel.addEventListener("change", loadRows);
    searchInput.addEventListener("input", applySearchAndRender);
    autoChk.addEventListener("change", () => setAuto(autoChk.checked));

    exportAllJsonBtn.addEventListener("click", () => exportAllJSON(cacheRows));
    exportAllCsvBtn.addEventListener("click", () => exportAllCSV(cacheRows));

    loadRows();
  </script>
</body>
</html>
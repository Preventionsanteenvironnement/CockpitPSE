<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Page prof – Résultats exercices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f4f4f5;margin:0;padding:0}
    .page{max-width:1000px;margin:0 auto;padding:20px 16px 60px}
    h1{font-size:1.6rem;margin:0 0 .35rem}
    p{font-size:.95rem;color:#4b5563;margin:.2rem 0 0}
    .card{margin-top:16px;background:#fff;border-radius:12px;padding:16px 18px;box-shadow:0 8px 18px rgba(15,23,42,.08)}
    table{width:100%;border-collapse:collapse;font-size:.92rem}
    th,td{padding:10px 8px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    th{background:#f3f4f6;font-weight:700}
    tr:hover td{background:#f9fafb}
    .btn{padding:7px 12px;border-radius:999px;border:0;font-size:.85rem;font-weight:700;cursor:pointer;background:#2563eb;color:#fff;white-space:nowrap}
    .btn-refresh{background:#6b7280}
    .btn-del{background:#dc2626}
    .status{margin-top:10px;font-size:.9rem}
    .ok{color:#16a34a}
    .err{color:#dc2626}
    .muted{color:#6b7280}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:.78rem}
  </style>
</head>
<body>
  <div class="page">
    <h1>Page prof – Résultats exercices</h1>
    <p>Résultats envoyés par les élèves. Identifiant + classe + thème + score. Bouton JSON pour archiver. Possibilité de supprimer.</p>

    <div class="card">
      <div class="row">
        <button class="btn btn-refresh" id="refresh-btn">Actualiser</button>
        <div id="status" class="status muted"></div>
      </div>

      <div style="overflow-x:auto;margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Identifiant</th>
              <th>Classe</th>
              <th>Thème / Support</th>
              <th>Score</th>
              <th>Lien</th>
              <th>JSON</th>
              <th>Suppr.</th>
            </tr>
          </thead>
          <tbody id="body">
            <tr><td colspan="9">Chargement…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
  authDomain: "devoirs-pse.firebaseapp.com",
  projectId: "devoirs-pse",
  storageBucket: "devoirs-pse.firebasestorage.app",
  messagingSenderId: "614730413904",
  appId: "1:614730413904:web:a5dd478af5de30f6bede55"
};

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const db = getFirestore(app);

const tbody = document.getElementById("body");
const statusEl = document.getElementById("status");
const refreshBtn = document.getElementById("refresh-btn");

function setStatus(text, cls="muted"){
  statusEl.className = "status " + cls;
  statusEl.textContent = text;
}

function asDate(iso){
  if(!iso) return "—";
  const d = new Date(iso);
  if(String(d) === "Invalid Date") return iso;
  return d.toLocaleString("fr-FR");
}

function downloadJSON(row){
  const obj = {
    type: row.meta?.type || "exercice",
    createdAt: row.meta?.createdAt || "",
    identifiant: row.meta?.nom || "",
    classe: row.meta?.classe || "",
    support: row.meta?.support || "",
    score: row.resultat?.score || "",
    url: row.resultat?.url || "",
    titre: row.resultat?.titre || ""
  };
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const safe = (row.meta?.support || "exercice").replace(/[^\w\-]+/g,"_").slice(0,60);
  const filename = "exercice_" + safe + "_" + (row.meta?.createdAt || "").replace(/[^\w\-]+/g,"_").slice(0,30) + ".json";
  const a = document.createElement("a");
  a.href = url;
  a.download = filename || "exercice.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function deleteEntry(id){
  if(!confirm("Supprimer définitivement cette entrée ?")) return;
  try{
    await deleteDoc(doc(db, "exercices", id));
    load();
  }catch(e){
    alert("Erreur suppression : " + e.message);
  }
}

async function load(){
  try{
    setStatus("Chargement…");
    tbody.innerHTML = `<tr><td colspan="9">Chargement…</td></tr>`;

    const snap = await getDocs(collection(db, "exercices"));
    const rows = [];
    snap.forEach(d => rows.push({ id: d.id, ...d.data() }));

    if(!rows.length){
      tbody.innerHTML = `<tr><td colspan="9">Aucun résultat pour l’instant.</td></tr>`;
      setStatus("0 résultat.");
      return;
    }

    rows.sort((a,b)=> String(b.meta?.createdAt||"").localeCompare(String(a.meta?.createdAt||"")));

    tbody.innerHTML = "";
    rows.forEach((row, i)=>{
      const tr = document.createElement("tr");

      const linkCell = document.createElement("td");
      if(row.resultat?.url){
        const a = document.createElement("a");
        a.href = row.resultat.url;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = "Ouvrir";
        a.className = "pill";
        linkCell.appendChild(a);
      }else{
        linkCell.textContent = "—";
        linkCell.className = "muted";
      }

      const jsonCell = document.createElement("td");
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = "JSON";
      b.type = "button";
      b.addEventListener("click", ()=> downloadJSON(row));
      jsonCell.appendChild(b);

      const delCell = document.createElement("td");
      const del = document.createElement("button");
      del.className = "btn btn-del";
      del.textContent = "X";
      del.addEventListener("click", ()=> deleteEntry(row.id));
      delCell.appendChild(del);

      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${asDate(row.meta?.createdAt)}</td>
        <td>${row.meta?.nom || "—"}</td>
        <td>${row.meta?.classe || "—"}</td>
        <td>${row.meta?.support || "—"}</td>
        <td>${row.resultat?.score || "—"}</td>
      `;
      tr.appendChild(linkCell);
      tr.appendChild(jsonCell);
      tr.appendChild(delCell);
      tbody.appendChild(tr);
    });

    setStatus(rows.length + " résultat(s).", "ok");
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="9">Erreur technique.</td></tr>`;
    setStatus("Erreur Firebase : " + e.message, "err");
  }
}

refreshBtn.addEventListener("click", load);
load();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi Exercices & Comp√©tences</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; --card: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1f2937; }
        
        /* LOGIN SCREEN */
        #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:#1e1e2f; display:flex; justify-content:center; align-items:center; z-index:9999; }
        .login-box { text-align:center; padding:30px; background:white; border-radius:10px; box-shadow:0 10px 25px rgba(0,0,0,0.5); width: 300px; }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; }
        button.refresh { background: #e0e7ff; color: #4338ca; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; }
        button.refresh:hover { background: #c7d2fe; }

        /* GRID DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
        .card h3 { margin-top: 0; color: #6b7280; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        
        .big-number { font-size: 3rem; font-weight: 800; color: var(--primary); }
        .stat-label { color: #6b7280; font-size: 0.9rem; }

        /* TABLEAU */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 12px; background: #f9fafb; color: #4b5563; font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.95rem; }
        tr:hover { background: #f9fafb; }
        
        /* PASTILLES */
        .pill { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; margin-right: 4px; display: inline-block; }
        .pill-green { background: #dcfce7; color: #166534; }
        .pill-orange { background: #ffedd5; color: #9a3412; }
        .pill-red { background: #fee2e2; color: #991b1b; }
        .pill-blue { background: #dbeafe; color: #1e40af; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="margin-top:0;">üîí Zone Professeur</h2>
            <p style="color:#666; font-size:0.9rem;">Entrez votre code d'acc√®s</p>
            <input type="password" id="password-input" placeholder="Mot de passe...">
            <button onclick="verifierMotDePasse()">Acc√©der</button>
        </div>
    </div>

    <div id="app-content" style="display:none; max-width: 1200px; margin: 0 auto;">
        
        <header>
            <div>
                <h1>‚úàÔ∏è Suivi Exercices & Comp√©tences</h1>
                <div style="color:#6b7280; font-size:0.9rem; margin-top:5px;">Base de donn√©es : <strong>evaluations_competences</strong></div>
            </div>
            <button class="refresh" onclick="chargerDonnees()">üîÑ Actualiser les donn√©es</button>
        </header>

        <div class="dashboard-grid">
            <div class="card" style="text-align:center;">
                <h3>Copies Re√ßues</h3>
                <div class="big-number" id="nb-copies">--</div>
                <div class="stat-label">Total Exercices</div>
            </div>
            <div class="card" style="text-align:center;">
                <h3>Moyenne Classe</h3>
                <div class="big-number" id="moyenne-globale">--</div>
                <div class="stat-label">Sur 20 points</div>
            </div>
            <div class="card" style="text-align:center;">
                <h3>Vues (Stats Usage)</h3>
                <div class="big-number" id="nb-vues" style="color:#9ca3af">--</div>
                <div class="stat-label">Consultations</div>
            </div>
        </div>

        <div class="card" style="margin-bottom:20px;">
            <h3>üìä Radar Moyen des Comp√©tences (Classe)</h3>
            <div style="height: 350px; display: flex; justify-content: center;">
                <canvas id="radarChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>üìù Derni√®res √âvaluations</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>√âl√®ve</th>
                            <th>Classe</th>
                            <th>Exercice</th>
                            <th>Note</th>
                            <th>D√©tail Comp√©tences</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-eleves">
                        <tr><td colspan="6" style="text-align:center; color:#999;">En attente de chargement...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // TA CONFIGURATION FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.appspot.com",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let myRadarChart = null;

        // --- S√âCURIT√â ---
        window.verifierMotDePasse = function() {
            const pass = document.getElementById('password-input').value;
            if(pass === "profpse") { // TON MOT DE PASSE
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                chargerDonnees();
            } else {
                alert("Mot de passe incorrect ‚õî");
            }
        }

        // --- CHARGEMENT ---
        window.chargerDonnees = async function() {
            console.log("Chargement...");
            
            // 1. STATS VUES
            try {
                const statsSnap = await getDocs(collection(db, "statistiques_usage"));
                document.getElementById("nb-vues").innerText = statsSnap.size;
            } catch(e) { console.log("Pas de stats"); }

            // 2. NOTES
            const q = query(collection(db, "evaluations_competences"), orderBy("date", "desc"));
            const evalSnap = await getDocs(q);
            
            document.getElementById("nb-copies").innerText = evalSnap.size;

            let totalNote = 0;
            let countNote = 0;
            let tbody = document.getElementById("tbody-eleves");
            tbody.innerHTML = "";

            // Variables Radar
            let sums = {C1:0, C2:0, C3:0, C4:0, C5:0, C6:0};
            let counts = {C1:0, C2:0, C3:0, C4:0, C5:0, C6:0};

            if (evalSnap.empty) {
                tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>Aucune donn√©e trouv√©e.</td></tr>";
                return;
            }

            evalSnap.forEach(doc => {
                const data = doc.data();
                
                // Moyenne
                if(data.note_finale !== undefined) {
                    totalNote += parseFloat(data.note_finale);
                    countNote++;
                }

                // Radar
                if(data.competences) {
                    if(data.competences.C1_Traiter_Info != null) { sums.C1 += data.competences.C1_Traiter_Info; counts.C1++; }
                    if(data.competences.C2_Analyse != null)      { sums.C2 += data.competences.C2_Analyse; counts.C2++; }
                    if(data.competences.C3_Expliquer != null)    { sums.C3 += data.competences.C3_Expliquer; counts.C3++; }
                    if(data.competences.C4_Solution != null)     { sums.C4 += data.competences.C4_Solution; counts.C4++; }
                    if(data.competences.C5_Argumenter != null)   { sums.C5 += data.competences.C5_Argumenter; counts.C5++; }
                    if(data.competences.C6_Communiquer != null)  { sums.C6 += data.competences.C6_Communiquer; counts.C6++; }
                }

                // Tableau HTML
                let dateStr = data.date ? new Date(data.date.seconds * 1000).toLocaleDateString("fr-FR") : "-";
                let badges = "";
                if(data.competences) {
                    badges += makeBadge("C1", data.competences.C1_Traiter_Info);
                    badges += makeBadge("C2", data.competences.C2_Analyse);
                    badges += makeBadge("C3", data.competences.C3_Expliquer);
                    badges += makeBadge("C4", data.competences.C4_Solution);
                    badges += makeBadge("C5", data.competences.C5_Argumenter);
                    badges += makeBadge("C6", data.competences.C6_Communiquer);
                }

                let row = `<tr>
                    <td>${dateStr}</td>
                    <td><strong>${data.identifiant || "?"}</strong></td>
                    <td>${data.classe || ""}</td>
                    <td>${data.exercice_titre || ""}</td>
                    <td style="color:#4f46e5; font-weight:bold;">${data.note_finale}/20</td>
                    <td>${badges}</td>
                </tr>`;
                tbody.innerHTML += row;
            });

            // Affichage Moyenne
            if(countNote > 0) {
                document.getElementById("moyenne-globale").innerText = (totalNote / countNote).toFixed(1);
            }

            // Affichage Radar
            updateRadar(
                counts.C1 ? sums.C1/counts.C1 : 0,
                counts.C2 ? sums.C2/counts.C2 : 0,
                counts.C3 ? sums.C3/counts.C3 : 0,
                counts.C4 ? sums.C4/counts.C4 : 0,
                counts.C5 ? sums.C5/counts.C5 : 0,
                counts.C6 ? sums.C6/counts.C6 : 0
            );
        }

        function makeBadge(name, level) {
            if(level === undefined || level === null) return "";
            let c = "pill-red";
            if(level >= 1) c = "pill-orange";
            if(level >= 2) c = "pill-green";
            if(level === 3) c = "pill-blue";
            return `<span class="pill ${c}">${name}:${level}</span>`;
        }

        function updateRadar(c1, c2, c3, c4, c5, c6) {
            const ctx = document.getElementById('radarChart');
            if(myRadarChart) myRadarChart.destroy();
            myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['C1 Info', 'C2 Analyse', 'C3 Expliquer', 'C4 Solution', 'C5 Arg', 'C6 Com'],
                    datasets: [{
                        label: 'Niveau Classe (Moyenne)',
                        data: [c1, c2, c3, c4, c5, c6],
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        borderColor: '#4f46e5',
                        pointBackgroundColor: '#4f46e5'
                    }]
                },
                options: {
                    scales: { r: { suggestedMin: 0, suggestedMax: 3 } },
                    maintainAspectRatio: false
                }
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>PageProf ‚Äì Scores exercices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#0f172a;
      --bg-soft:#020617;
      --card:#020617;
      --card-soft:#020617;
      --card-alt:#0b1220;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,.18);
      --danger:#f97373;
      --danger-soft:rgba(248,113,113,.15);
      --good:#4ade80;
      --good-soft:rgba(74,222,128,.14);
      --warn:#facc15;
      --warn-soft:rgba(250,204,21,.14);
      --shadow:0 18px 40px rgba(15,23,42,.9);
      --radius-xl:22px;
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Inter",sans-serif;
      background:radial-gradient(circle at top,left,#0f172a 0,#020617 45%,#000 100%);
      color:var(--text);
      min-height:100vh;
      padding:20px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }
    .app{
      width:100%;
      max-width:1200px;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.18),transparent 55%),
                 radial-gradient(circle at 100% 0,rgba(74,222,128,.18),transparent 55%),
                 var(--bg-soft);
      border-radius:32px;
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,.35);
      padding:20px 20px 24px;
      position:relative;
      overflow:hidden;
    }
    .app::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top,rgba(15,23,42,.75),transparent 55%);
      opacity:.9;
      pointer-events:none;
    }
    .app-inner{position:relative;z-index:1}
    header{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .title-block h1{
      font-size:1.35rem;
      letter-spacing:.05em;
      text-transform:uppercase;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .title-pill{
      font-size:.7rem;
      text-transform:uppercase;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      color:var(--muted);
    }
    .title-sub{
      margin-top:6px;
      font-size:.8rem;
      color:var(--muted);
      max-width:360px;
    }
    .badge-strip{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 11px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      font-size:.75rem;
      background:rgba(15,23,42,.9);
      backdrop-filter:blur(10px);
    }
    .chip span.icon{font-size:.9rem}
    .chip strong{color:#e5e7eb}

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:14px;
      align-items:flex-end;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:130px;
      flex:1 1 140px;
    }
    .field label{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted);
    }
    select,input[type="search"]{
      background:rgba(15,23,42,.9);
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      padding:7px 12px;
      font-size:.82rem;
      color:var(--text);
      outline:none;
      appearance:none;
    }
    select:focus,input[type="search"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,.5);
    }
    .field.compact{flex:0 0 auto;min-width:100px}
    .btn{
      border-radius:999px;
      border:none;
      font-size:.82rem;
      padding:8px 16px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:600;
      white-space:nowrap;
    }
    .btn-solid{
      background:linear-gradient(120deg,#38bdf8,#6366f1);
      color:#0b1120;
      box-shadow:0 8px 18px rgba(56,189,248,.35);
    }
    .btn-solid:disabled{
      opacity:.5;
      cursor:default;
      box-shadow:none;
    }
    .btn-ghost{
      background:rgba(15,23,42,.8);
      color:var(--muted);
      border:1px solid rgba(148,163,184,.6);
    }

    .summary-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:10px;
      font-size:.78rem;
      color:var(--muted);
      align-items:center;
      justify-content:space-between;
    }
    .summary-left{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .pill{
      border-radius:999px;
      padding:4px 10px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill-dot{
      width:8px;height:8px;border-radius:999px;
    }
    .dot-nm{background:#f97373}
    .dot-im{background:#facc15}
    .dot-m{background:#4ade80}
    .dot-bm{background:#22c55e}

    .table-card{
      background:radial-gradient(circle at top left,rgba(56,189,248,.18),transparent 55%),
                 radial-gradient(circle at bottom right,rgba(74,222,128,.16),transparent 55%),
                 rgba(15,23,42,.96);
      border-radius:var(--radius-xl);
      border:1px solid rgba(148,163,184,.5);
      padding:12px 0 4px;
      box-shadow:0 16px 32px rgba(15,23,42,.9);
      position:relative;
    }
    .table-wrap{
      max-height:60vh;
      overflow:auto;
      padding:0 6px 4px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.78rem;
      min-width:820px;
    }
    thead{
      position:sticky;
      top:0;
      z-index:2;
      background:linear-gradient(to bottom,rgba(15,23,42,1),rgba(15,23,42,.9));
      box-shadow:0 1px 0 rgba(51,65,85,.9);
    }
    th,td{
      padding:8px 10px;
      text-align:left;
      border-bottom:1px solid rgba(30,41,59,.9);
      white-space:nowrap;
    }
    th{
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted);
      font-weight:600;
      position:relative;
      user-select:none;
    }
    th.sortable{
      cursor:pointer;
    }
    th.sortable::after{
      content:"";
      position:absolute;
      right:4px;
      top:50%;
      transform:translateY(-50%);
      font-size:.6rem;
      color:var(--muted);
    }
    th.sortable.sort-asc::after{content:"‚ñ≤"}
    th.sortable.sort-desc::after{content:"‚ñº"}
    tbody tr{
      transition:background .15s ease;
    }
    tbody tr:hover{
      background:rgba(15,23,42,.8);
    }
    td{
      color:#e5e7eb;
    }
    td span.sub{
      display:block;
      font-size:.68rem;
      color:var(--muted);
    }
    .badge-lvl{
      font-size:.7rem;
      padding:3px 7px;
      border-radius:999px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:4px;
      border:1px solid transparent;
    }
    .lvl-nm{
      background:var(--danger-soft);
      color:var(--danger);
      border-color:rgba(248,113,113,.7);
    }
    .lvl-im{
      background:var(--warn-soft);
      color:var(--warn);
      border-color:rgba(250,204,21,.65);
    }
    .lvl-m{
      background:var(--good-soft);
      color:var(--good);
      border-color:rgba(74,222,128,.7);
    }
    .lvl-bm{
      background:rgba(34,197,94,.18);
      color:#bbf7d0;
      border-color:rgba(34,197,94,.8);
    }
    .score-strong{
      font-weight:700;
    }

    .tag{
      font-size:.65rem;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .btn-table{
      border-radius:999px;
      border:none;
      padding:4px 9px;
      font-size:.72rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .btn-open{
      background:rgba(56,189,248,.12);
      color:#7dd3fc;
      border:1px solid rgba(56,189,248,.7);
    }
    .btn-del{
      background:var(--danger-soft);
      color:var(--danger);
      border:1px solid rgba(248,113,113,.7);
    }

    .empty{
      text-align:center;
      padding:18px 10px;
      color:var(--muted);
      font-size:.8rem;
    }

    .status-bar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding:8px 12px 4px;
      font-size:.72rem;
      color:var(--muted);
      align-items:center;
      justify-content:space-between;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:#22c55e;
    }
    .status-left{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .loading-overlay{
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top,rgba(15,23,42,.95),rgba(15,23,42,.98));
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-size:.8rem;
      color:var(--muted);
      z-index:3;
    }
    .spinner{
      width:26px;height:26px;
      border-radius:999px;
      border:3px solid rgba(148,163,184,.4);
      border-top-color:var(--accent);
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{
      to{transform:rotate(360deg)}
    }

    @media(max-width:900px){
      body{padding:10px;}
      .app{border-radius:20px;padding:14px 12px 16px;}
      header{flex-direction:column;gap:10px;}
      .title-block h1{font-size:1.1rem;}
      .title-sub{max-width:100%;}
      .toolbar{flex-direction:column;align-items:stretch;}
      .field{width:100%;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-inner">
      <header>
        <div class="title-block">
          <h1>
            üìä Scores exercices
            <span class="title-pill">PageProf ‚Ä¢ Firebase</span>
          </h1>
          <div class="title-sub">
            Vue globale des exercices envoy√©s par les √©l√®ves (CAP / Bac Pro) avec tri, filtres et niveaux par comp√©tence C1 √† C6.
          </div>
        </div>
        <div class="badge-strip">
          <div class="chip">
            <span class="icon">üéØ</span>
            <span><strong id="chipCount">0</strong> copies charg√©es</span>
          </div>
          <div class="chip">
            <span class="icon">üìà</span>
            <span>Score moyen <strong id="chipAvgScore">‚Äì</strong></span>
          </div>
          <div class="chip">
            <span class="icon">‚è±Ô∏è</span>
            <span>Temps moyen <strong id="chipAvgTime">‚Äì</strong></span>
          </div>
        </div>
      </header>

      <section class="toolbar">
        <div class="field">
          <label for="filterSearch">Recherche √©l√®ve / exercice</label>
          <input id="filterSearch" type="search" placeholder="Nom, identifiant ou support‚Ä¶" />
        </div>
        <div class="field">
          <label for="filterClass">Classe</label>
          <select id="filterClass">
            <option value="">Toutes les classes</option>
          </select>
        </div>
        <div class="field">
          <label for="filterSupport">Support</label>
          <select id="filterSupport">
            <option value="">Tous les supports</option>
          </select>
        </div>
        <div class="field">
          <label for="filterGlobal">Niveau global</label>
          <select id="filterGlobal">
            <option value="">Tous</option>
            <option value="NM">NM ‚Äì Non ma√Ætris√©</option>
            <option value="IM">IM ‚Äì Insuffisant</option>
            <option value="M">M ‚Äì Ma√Ætris√©</option>
            <option value="BM">BM ‚Äì Bien ma√Ætris√©</option>
          </select>
        </div>
        <div class="field compact">
          <label for="filterComp">Comp√©tence</label>
          <select id="filterComp">
            <option value="">C1‚ÄìC6 (aucun filtre)</option>
            <option value="C1">C1</option>
            <option value="C2">C2</option>
            <option value="C3">C3</option>
            <option value="C4">C4</option>
            <option value="C5">C5</option>
            <option value="C6">C6</option>
          </select>
        </div>
        <div class="field compact">
          <label for="filterCompMin">Niveau min Cx</label>
          <select id="filterCompMin">
            <option value="">Tous</option>
            <option value="NM">‚â• NM</option>
            <option value="IM">‚â• IM</option>
            <option value="M">‚â• M</option>
            <option value="BM">BM uniquement</option>
          </select>
        </div>
        <div class="field compact" style="flex:0 0 auto;min-width:auto;">
          <button class="btn btn-ghost" type="button" id="btnClear">
            üîÅ R√©initialiser
          </button>
        </div>
        <div class="field compact" style="flex:0 0 auto;min-width:auto;">
          <button class="btn btn-solid" type="button" id="btnRefresh">
            üîÑ Actualiser
          </button>
        </div>
      </section>

      <section class="summary-row">
        <div class="summary-left">
          <span class="pill">
            <span class="pill-dot dot-nm"></span> NM
          </span>
          <span class="pill">
            <span class="pill-dot dot-im"></span> IM
          </span>
          <span class="pill">
            <span class="pill-dot dot-m"></span> M
          </span>
          <span class="pill">
            <span class="pill-dot dot-bm"></span> BM
          </span>
          <span class="pill" id="pillDistrib">
            Distribution : ‚Äì
          </span>
        </div>
        <div>
          <span class="pill" id="pillSelection">
            0 lignes affich√©es (0 filtr√©es)
          </span>
        </div>
      </section>

      <section class="table-card">
        <div class="loading-overlay" id="loadingOverlay">
          <div class="spinner"></div>
          <div>Connexion √† Firestore‚Ä¶</div>
        </div>

        <div class="table-wrap">
          <table id="scoresTable">
            <thead>
              <tr>
                <th class="sortable sort-desc" data-field="dateValue">Date d‚Äôenvoi</th>
                <th class="sortable" data-field="nom">Nom √©l√®ve</th>
                <th class="sortable" data-field="classe">Classe</th>
                <th class="sortable" data-field="support">Exercice</th>
                <th class="sortable" data-field="scoreNum">Score</th>
                <th class="sortable" data-field="niveauGlobal">Niv. global</th>
                <th>C1</th>
                <th>C2</th>
                <th>C3</th>
                <th>C4</th>
                <th>C5</th>
                <th>C6</th>
                <th class="sortable" data-field="tentatives">Tentatives</th>
                <th class="sortable" data-field="tempsPasse">Temps (min)</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="scoresBody">
              <tr><td colspan="15" class="empty">En attente de connexion Firestore‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="status-bar">
          <div class="status-left">
            <span class="dot"></span>
            <span id="statusText">Pr√™t</span>
          </div>
          <div id="statusLastUpdate"></div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    // ‚öôÔ∏è CONFIG FIREBASE ‚Äì √Ä COMPL√âTER AVEC TES PROPRES CL√âS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // üëâ Remplacer ces valeurs par ta config r√©elle Firebase
    const firebaseConfig = {
  apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
  authDomain: "devoirs-pse.firebaseapp.com",
  projectId: "devoirs-pse",
  storageBucket: "devoirs-pse.appspot.com",
  messagingSenderId: "614730413904",
  appId: "1:614730413904:web:a5dd478af5de30f6bede55"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COL_NAME = "exercices";

    const $ = (id)=>document.getElementById(id);

    let rawRows = [];
    let filteredRows = [];
    let currentSort = { field:"dateValue", dir:"desc" };

    const levelOrder = { NM:0, IM:1, M:2, BM:3 };

    function parseScore(scoreStr){
      if(!scoreStr) return 0;
      const m = String(scoreStr).match(/^(\d+(\.\d+)?)/);
      return m ? parseFloat(m[1]) : 0;
    }

    function safeLvl(v){
      if(!v) return "";
      const up = String(v).toUpperCase().trim();
      if(["NM","IM","M","BM"].includes(up)) return up;
      return "";
    }

    function transformDoc(d){
      const data = d.data();
      const meta = data.meta || {};
      const res = data.resultat || {};

      const createdAt = meta.createdAt ? new Date(meta.createdAt) : new Date();
      const nom = meta.nom || "";
      const classe = meta.classe || "";
      const support = meta.support || "";
      const scoreStr = res.score || "";
      const scoreNum = parseScore(scoreStr);
      const niveauGlobal = safeLvl(res.niveauGlobal || "");
      const comps = (res.competences || {});
      const tentatives = typeof res.tentatives === "number" ? res.tentatives : 1;
      const tempsPasse = typeof res.tempsPasse === "number" ? res.tempsPasse : 0;
      const url = res.url || "";
      const titre = res.titre || support || "Exercice";

      return {
        id: d.id,
        nom,
        classe,
        support,
        scoreStr,
        scoreNum,
        niveauGlobal,
        C1: safeLvl(comps.C1),
        C2: safeLvl(comps.C2),
        C3: safeLvl(comps.C3),
        C4: safeLvl(comps.C4),
        C5: safeLvl(comps.C5),
        C6: safeLvl(comps.C6),
        tentatives,
        tempsPasse,
        dateValue: createdAt.getTime(),
        dateLabel: createdAt.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),
        url,
        titre,
        metaType: meta.type || "",
      };
    }

    function updateStatus(text){
      $("statusText").textContent = text;
    }
    function updateLastUpdate(){
      const now = new Date();
      $("statusLastUpdate").textContent =
        "Derni√®re mise √† jour : " +
        now.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
    }

    async function loadData(){
      $("loadingOverlay").style.display = "flex";
      updateStatus("Chargement des copies‚Ä¶");
      try{
        const snap = await getDocs(collection(db, COL_NAME));
        rawRows = snap.docs.map(transformDoc);
        applyFilters();
        feedFilterOptions();
        updateSummaryBadges();
        updateStatus("Chargement termin√©");
        updateLastUpdate();
      }catch(e){
        console.error(e);
        $("scoresBody").innerHTML =
          '<tr><td colspan="15" class="empty">Erreur de connexion √† Firestore. V√©rifie la configuration Firebase.</td></tr>';
        updateStatus("Erreur de connexion Firebase");
      }finally{
        $("loadingOverlay").style.display = "none";
      }
    }

    function feedFilterOptions(){
      const classSet = new Set();
      const supportSet = new Set();
      rawRows.forEach(r=>{
        if(r.classe) classSet.add(r.classe);
        if(r.support) supportSet.add(r.support);
      });
      const classSelect = $("filterClass");
      const supportSelect = $("filterSupport");
      const prevClass = classSelect.value;
      const prevSupport = supportSelect.value;

      classSelect.innerHTML = '<option value="">Toutes les classes</option>' +
        Array.from(classSet).sort().map(c=>`<option value="${c}">${c}</option>`).join("");
      supportSelect.innerHTML = '<option value="">Tous les supports</option>' +
        Array.from(supportSet).sort().map(s=>`<option value="${s}">${s}</option>`).join("");

      if(prevClass) classSelect.value = prevClass;
      if(prevSupport) supportSelect.value = prevSupport;
    }

    function applyFilters(){
      const q = $("filterSearch").value.trim().toLowerCase();
      const fClass = $("filterClass").value;
      const fSupport = $("filterSupport").value;
      const fGlobal = $("filterGlobal").value;
      const fComp = $("filterComp").value;
      const fCompMin = $("filterCompMin").value;

      filteredRows = rawRows.filter(r=>{
        if(q){
          const hay = (r.nom + " " + r.support + " " + r.classe).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        if(fClass && r.classe !== fClass) return false;
        if(fSupport && r.support !== fSupport) return false;
        if(fGlobal && r.niveauGlobal !== fGlobal) return false;

        if(fComp){
          const lvlVal = r[fComp] || "";
          if(!lvlVal) return false;
          if(fCompMin){
            const lvlDoc = levelOrder[lvlVal] ?? -1;
            const lvlMin = levelOrder[fCompMin] ?? 0;
            if(lvlDoc < lvlMin) return false;
          }
        }
        return true;
      });

      sortAndRender();
      updateSummaryBadges();
    }

    function sortAndRender(){
      const {field,dir} = currentSort;
      const rows = [...filteredRows];
      rows.sort((a,b)=>{
        let va = a[field];
        let vb = b[field];

        if(field === "niveauGlobal"){
          va = levelOrder[a[field]] ?? -1;
          vb = levelOrder[b[field]] ?? -1;
        }

        if(typeof va === "string") va = va.toLowerCase();
        if(typeof vb === "string") vb = vb.toLowerCase();

        if(va < vb) return dir === "asc" ? -1 : 1;
        if(va > vb) return dir === "asc" ? 1 : -1;
        return 0;
      });

      renderTable(rows);

      const total = rawRows.length;
      const shown = rows.length;
      $("pillSelection").textContent = `${shown} lignes affich√©es (${total} au total)`;
    }

    function levelClass(lvl){
      if(lvl === "NM") return "lvl-nm";
      if(lvl === "IM") return "lvl-im";
      if(lvl === "M") return "lvl-m";
      if(lvl === "BM") return "lvl-bm";
      return "";
    }

    function renderLvlCell(lvl){
      if(!lvl) return "";
      const txtMap = { NM:"NM", IM:"IM", M:"M", BM:"BM" };
      return `<span class="badge-lvl ${levelClass(lvl)}">${txtMap[lvl]||lvl}</span>`;
    }

    function renderTable(rows){
      const tbody = $("scoresBody");
      if(!rows.length){
        tbody.innerHTML =
          '<tr><td colspan="15" class="empty">Aucune copie ne correspond aux filtres actuels.</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map(r=>`
        <tr data-id="${r.id}">
          <td>
            ${r.dateLabel}
          </td>
          <td>
            ${r.nom || "‚Äî"}
          </td>
          <td>${r.classe || "‚Äî"}</td>
          <td>
            ${r.support || "‚Äî"}
            <span class="sub">${r.titre || ""}</span>
          </td>
          <td>
            <span class="score-strong">${r.scoreStr || "‚Äî"}</span>
          </td>
          <td>${renderLvlCell(r.niveauGlobal)}</td>
          <td>${renderLvlCell(r.C1)}</td>
          <td>${renderLvlCell(r.C2)}</td>
          <td>${renderLvlCell(r.C3)}</td>
          <td>${renderLvlCell(r.C4)}</td>
          <td>${renderLvlCell(r.C5)}</td>
          <td>${renderLvlCell(r.C6)}</td>
          <td>${r.tentatives ?? "‚Äî"}</td>
          <td>${r.tempsPasse ? Math.round(r.tempsPasse/60) : 0}</td>
          <td>
            <div style="display:flex;gap:4px;">
              <button class="btn-table btn-open" data-action="open">Ouvrir</button>
              <button class="btn-table btn-del" data-action="delete">Supprimer</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    function updateSummaryBadges(){
      const total = rawRows.length;
      $("chipCount").textContent = total;

      if(!filteredRows.length){
        $("chipAvgScore").textContent = "‚Äì";
        $("chipAvgTime").textContent = "‚Äì";
        $("pillDistrib").textContent = "Distribution : ‚Äì";
        return;
      }

      const avgScore = filteredRows.reduce((s,r)=>s + (r.scoreNum || 0),0)/filteredRows.length;
      $("chipAvgScore").textContent = avgScore.toFixed(1) + " / 20";

      const avgTimeSec = filteredRows.reduce((s,r)=>s + (r.tempsPasse || 0),0)/filteredRows.length;
      const avgMin = Math.round(avgTimeSec/60);
      $("chipAvgTime").textContent = (avgMin || 0) + " min";

      let nm=0,im=0,m=0,bm=0;
      filteredRows.forEach(r=>{
        if(r.niveauGlobal === "NM") nm++;
        else if(r.niveauGlobal === "IM") im++;
        else if(r.niveauGlobal === "M") m++;
        else if(r.niveauGlobal === "BM") bm++;
      });
      const parts = [];
      if(nm) parts.push(`${nm} NM`);
      if(im) parts.push(`${im} IM`);
      if(m) parts.push(`${m} M`);
      if(bm) parts.push(`${bm} BM`);
      $("pillDistrib").textContent = parts.length
        ? "Distribution : " + parts.join(" ‚Ä¢ ")
        : "Distribution : ‚Äì";
    }

    function onHeaderClick(e){
      const th = e.target.closest("th.sortable");
      if(!th) return;
      const field = th.dataset.field;
      if(!field) return;

      if(currentSort.field === field){
        currentSort.dir = currentSort.dir === "asc" ? "desc" : "asc";
      }else{
        currentSort.field = field;
        currentSort.dir = field === "dateValue" ? "desc" : "asc";
      }

      document.querySelectorAll("th.sortable").forEach(el=>{
        el.classList.remove("sort-asc","sort-desc");
      });
      th.classList.add(currentSort.dir === "asc" ? "sort-asc" : "sort-desc");

      sortAndRender();
    }

    async function onTableClick(e){
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;
      const tr = e.target.closest("tr[data-id]");
      if(!tr) return;
      const id = tr.dataset.id;
      const row = rawRows.find(r=>r.id === id);
      if(!row) return;

      const action = btn.dataset.action;
      if(action === "open"){
        if(row.url){
          window.open(row.url,"_blank");
        }else{
          alert("Aucune URL enregistr√©e pour cet exercice.");
        }
      }
      else if(action === "delete"){
        const ok = confirm("Supprimer d√©finitivement cette copie de Firestore ?");
        if(!ok) return;
        try{
          updateStatus("Suppression en cours‚Ä¶");
          await deleteDoc(doc(db, COL_NAME, id));
          rawRows = rawRows.filter(r=>r.id !== id);
          applyFilters();
          updateStatus("Copie supprim√©e");
          updateLastUpdate();
        }catch(err){
          console.error(err);
          updateStatus("Erreur lors de la suppression");
          alert("Erreur lors de la suppression dans Firestore.");
        }
      }
    }

    function resetFilters(){
      $("filterSearch").value = "";
      $("filterClass").value = "";
      $("filterSupport").value = "";
      $("filterGlobal").value = "";
      $("filterComp").value = "";
      $("filterCompMin").value = "";
      applyFilters();
    }

    function wireEvents(){
      $("scoresTable").addEventListener("click", onHeaderClick);
      $("scoresBody").addEventListener("click", onTableClick);
      $("filterSearch").addEventListener("input", applyFilters);
      $("filterClass").addEventListener("change", applyFilters);
      $("filterSupport").addEventListener("change", applyFilters);
      $("filterGlobal").addEventListener("change", applyFilters);
      $("filterComp").addEventListener("change", applyFilters);
      $("filterCompMin").addEventListener("change", applyFilters);
      $("btnClear").addEventListener("click", resetFilters);
      $("btnRefresh").addEventListener("click", loadData);
    }

    wireEvents();
    loadData();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editeur d'Exercices ‚Äî PSE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a; color: white; height: 100vh; display: flex; overflow: hidden;
        }

        /* === SIDEBAR === */
        #sidebar {
            width: 320px; min-width: 320px; background: #1e293b; display: flex; flex-direction: column;
            border-right: 1px solid #334155; overflow-y: auto;
        }
        #sidebar::-webkit-scrollbar { width: 4px; }
        #sidebar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .sidebar-header {
            padding: 16px; border-bottom: 1px solid #334155; display: flex;
            align-items: center; justify-content: space-between;
        }
        .sidebar-header h2 { font-size: 1.05rem; }
        .sidebar-header a { color: #94a3b8; text-decoration: none; font-size: 0.8rem; }
        .sidebar-header a:hover { color: white; }

        .sidebar-section { padding: 14px; border-bottom: 1px solid #334155; }
        .sidebar-section label {
            font-size: 0.7rem; color: #64748b; text-transform: uppercase;
            letter-spacing: 1px; display: block; margin-bottom: 8px;
        }

        #btn-new-exo {
            width: 100%; padding: 12px; background: #22c55e; color: white;
            border: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem;
            cursor: pointer; transition: opacity 0.2s;
        }
        #btn-new-exo:hover { opacity: 0.85; }

        .exo-list { display: flex; flex-direction: column; gap: 4px; }
        .exo-list-item {
            padding: 10px 12px; background: #0f172a; border-radius: 8px;
            cursor: pointer; transition: 0.2s; border: 2px solid transparent; position: relative;
        }
        .exo-list-item:hover { border-color: #475569; }
        .exo-list-item.active { border-color: #3b82f6; background: #1e3a5f; }
        .exo-list-item .ei-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 2px; padding-right: 28px; }
        .exo-list-item .ei-meta { font-size: 0.7rem; color: #64748b; }
        .exo-list-item .ei-del {
            position: absolute; top: 8px; right: 8px;
            background: transparent; border: none; color: #64748b;
            font-size: 0.85rem; cursor: pointer; padding: 2px 5px; border-radius: 4px;
            opacity: 0; transition: 0.2s;
        }
        .exo-list-item:hover .ei-del { opacity: 1; }
        .exo-list-item .ei-del:hover { color: #ef4444; background: rgba(239,68,68,0.15); }
        .ei-badge {
            display: inline-block; padding: 2px 6px; border-radius: 4px;
            font-size: 0.65rem; font-weight: 700; margin-right: 4px;
        }
        .badge-pub { background: #dcfce7; color: #166534; }
        .badge-draft { background: #fef3c7; color: #92400e; }
        .badge-texte_trous { background: #dbeafe; color: #1e40af; }
        .badge-relier { background: #dcfce7; color: #166534; }
        .badge-ordre { background: #ffedd5; color: #9a3412; }
        .badge-intrus { background: #fce7f3; color: #9d174d; }
        .badge-pendu { background: #fef3c7; color: #92400e; }
        .badge-mots_croises { background: #e0e7ff; color: #3730a3; }
        .badge-swipe_vf { background: #d1fae5; color: #065f46; }
        .badge-qcm_image { background: #fce7f3; color: #be185d; }
        .badge-tableau { background: #f1f5f9; color: #475569; }
        .badge-etude_cas { background: #ede9fe; color: #5b21b6; }
        .badge-pad { background: #fef3c7; color: #b45309; }
        .badge-prevention { background: #d1fae5; color: #065f46; }
        .badge-pictogramme { background: #fef9c3; color: #854d0e; }
        .badge-facile { background: #d1fae5; color: #065f46; }
        .badge-moyen { background: #fef3c7; color: #92400e; }
        .badge-difficile { background: #fee2e2; color: #991b1b; }

        /* === MAIN === */
        #main {
            flex: 1; display: flex; flex-direction: column; overflow-y: auto;
            padding: 30px; background: #0f172a;
        }
        #main-empty {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; flex: 1; text-align: center; color: #64748b;
        }
        #main-empty .big-icon { font-size: 4rem; margin-bottom: 16px; }
        #main-editor { display: none; flex-direction: column; gap: 20px; max-width: 850px; width: 100%; margin: 0 auto; }

        /* Form elements */
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .form-input, .form-textarea {
            padding: 10px 14px; background: #1e293b; border: 1px solid #475569;
            border-radius: 8px; color: white; font-size: 0.95rem; outline: none; font-family: inherit;
        }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-input:focus, .form-textarea:focus { border-color: #3b82f6; }
        .form-input::placeholder, .form-textarea::placeholder { color: #64748b; }
        .form-select {
            padding: 10px 14px; background: #1e293b; border: 1px solid #475569;
            border-radius: 8px; color: white; font-size: 0.95rem; outline: none; cursor: pointer;
        }
        .form-select:focus { border-color: #3b82f6; }
        .form-row { display: flex; gap: 12px; }
        .form-row > * { flex: 1; }

        /* Class pills */
        .classes-pills-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .class-pill {
            padding: 5px 14px; border-radius: 20px; border: 2px solid #334155;
            background: #1e293b; color: #94a3b8; cursor: pointer; font-size: 0.8rem;
            font-weight: 600; transition: all 0.2s; user-select: none;
        }
        .class-pill:hover { border-color: #3b82f6; color: #e2e8f0; }
        .class-pill.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .class-pill.pill-all { font-style: italic; }

        /* Difficulty toggle */
        .diff-toggle { display: flex; gap: 6px; }
        .diff-btn {
            flex: 1; padding: 8px; border: 2px solid #334155; border-radius: 8px;
            background: #1e293b; color: #94a3b8; cursor: pointer; font-weight: 700;
            font-size: 0.85rem; text-align: center; transition: 0.2s;
        }
        .diff-btn.active-facile { border-color: #22c55e; color: #22c55e; background: rgba(34,197,94,0.1); }
        .diff-btn.active-moyen { border-color: #f59e0b; color: #f59e0b; background: rgba(245,158,11,0.1); }
        .diff-btn.active-difficile { border-color: #ef4444; color: #ef4444; background: rgba(239,68,68,0.1); }

        /* Meta card */
        .meta-card {
            background: #1e293b; border-radius: 12px; padding: 20px;
            border: 1px solid #334155;
        }
        .meta-card h3 { font-size: 1rem; margin-bottom: 16px; color: #e2e8f0; }

        /* Content card */
        .content-card {
            background: #1e293b; border-radius: 12px; padding: 20px;
            border: 1px solid #334155;
        }
        .content-card h3 { font-size: 1rem; margin-bottom: 16px; color: #e2e8f0; }
        .content-type-section { display: none; }
        .content-type-section.active { display: block; }

        /* Dynamic list (paires, items, etc.) */
        .dyn-list { display: flex; flex-direction: column; gap: 8px; }
        .dyn-row {
            display: flex; gap: 8px; align-items: center; background: #0f172a;
            padding: 10px; border-radius: 8px;
        }
        .dyn-row input { flex: 1; }
        .dyn-row .dyn-arrow { color: #64748b; font-weight: 700; flex-shrink: 0; }
        .dyn-row-actions { display: flex; gap: 4px; flex-shrink: 0; }
        .dyn-row-actions button {
            width: 30px; height: 30px; border: none; border-radius: 6px;
            background: #334155; color: #94a3b8; cursor: pointer; font-size: 0.85rem;
            display: flex; align-items: center; justify-content: center;
        }
        .dyn-row-actions button:hover { background: #475569; color: white; }
        .dyn-row-actions .btn-del:hover { background: rgba(239,68,68,0.2); color: #ef4444; }
        .btn-add-row {
            padding: 8px 16px; background: #334155; color: #94a3b8; border: 2px dashed #475569;
            border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem;
            transition: 0.2s; text-align: center;
        }
        .btn-add-row:hover { border-color: #3b82f6; color: white; }

        /* Series (intrus) */
        .serie-card {
            background: #0f172a; border-radius: 10px; padding: 14px;
            border: 1px solid #334155; margin-bottom: 10px;
        }
        .serie-card h4 { font-size: 0.8rem; color: #64748b; margin-bottom: 8px; }
        .serie-items { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .serie-item-input { width: calc(50% - 3px); }

        /* Preview */
        .preview-box {
            background: #0f172a; border: 1px solid #334155; border-radius: 8px;
            padding: 14px; margin-top: 10px; min-height: 60px;
            color: #e2e8f0; font-size: 0.9rem; line-height: 1.6;
        }
        .preview-box .trou { display: inline-block; border-bottom: 2px solid #3b82f6; min-width: 80px; padding: 2px 4px; color: #3b82f6; font-weight: 700; }

        /* Bottom actions */
        .bottom-actions { display: flex; gap: 12px; padding-top: 10px; }
        .btn-save { padding: 12px 24px; background: #22c55e; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem; cursor: pointer; flex: 1; }
        .btn-save:hover { opacity: 0.85; }
        .btn-publish { padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem; cursor: pointer; }
        .btn-publish:hover { opacity: 0.85; }
        .btn-unpublish { padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem; cursor: pointer; display: none; }
        .btn-unpublish:hover { opacity: 0.85; }
        .btn-delete { padding: 12px 24px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem; cursor: pointer; display: none; }
        .btn-delete:hover { opacity: 0.85; }
        .btn-import {
            padding: 10px 20px; background: #334155; color: #e2e8f0; border: 2px solid #475569;
            border-radius: 8px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.2s;
        }
        .btn-import:hover { border-color: #3b82f6; color: white; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #1e293b; border-radius: 16px; padding: 24px; width: 90%; max-width: 650px;
            max-height: 85vh; overflow-y: auto; border: 1px solid #334155;
        }
        .modal h3 { margin-bottom: 12px; }
        .modal .json-guide {
            background: #0f172a; border-radius: 8px; padding: 12px; margin-bottom: 12px;
            font-size: 0.8rem; color: #94a3b8; white-space: pre-wrap; font-family: monospace;
            max-height: 200px; overflow-y: auto; border: 1px solid #334155;
        }
        .modal .prompt-guide {
            background: #1a1a2e; border-radius: 8px; padding: 12px; margin-bottom: 12px;
            font-size: 0.8rem; color: #a78bfa; border-left: 3px solid #7c3aed;
        }
        .modal-actions { display: flex; gap: 10px; margin-top: 12px; }
        .modal-actions button { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; background: #22c55e; color: white;
            border-radius: 10px; font-weight: 700; font-size: 0.95rem;
            z-index: 3000; display: none; box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        /* === HAMBURGER === */
        .menu-overlay { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.55); backdrop-filter:blur(2px); z-index:999; }
        .menu-btn { display:none; border:none; background:#1e293b; color:#fff; width:44px; height:44px; border-radius:12px; font-size:20px; cursor:pointer; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
        body.menu-open #sidebar { transform:translateX(0); }
        body.menu-open .menu-overlay { display:block; }
        .close-sidebar-btn { display:none; }

        @media (max-width:768px) {
            body { height:auto; overflow:auto; display:block; }
            #sidebar { position:fixed; top:0; left:0; bottom:0; height:100vh; width:min(86vw,320px); min-width:0; transform:translateX(-110%); transition:transform 0.25s ease; z-index:1000; overflow-y:auto; }
            #main { padding:16px; min-height:100vh; }
            .menu-btn { display:inline-flex; margin-bottom:12px; }
            .close-sidebar-btn { display:block; position:absolute; top:15px; right:15px; background:none; border:none; color:white; font-size:24px; cursor:pointer; z-index:1002; }
            .form-row { flex-direction:column; gap:10px; }
            .bottom-actions { flex-direction:column; gap:8px; }
            .bottom-actions button { width:100%; text-align:center; }
            .dyn-row { flex-direction: column; gap: 6px; }
            .dyn-row input { width: 100%; }
        }
        @media (max-width:480px) {
            #main { padding:10px; }
        }
    </style>
</head>
<body>

<button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
<div class="menu-overlay" onclick="closeMenu()"></div>

<!-- SIDEBAR -->
<div id="sidebar">
    <button class="close-sidebar-btn" onclick="closeMenu()">‚úï</button>
    <div class="sidebar-header">
        <h2>üß© Exercices</h2>
        <a href="index.html">‚Üê Cockpit</a>
    </div>
    <div class="sidebar-section">
        <button id="btn-new-exo" onclick="newExercice()">+ Nouvel exercice</button>
    </div>
    <div class="sidebar-section">
        <label>Mes exercices (<span id="exo-count">0</span>)</label>
        <div class="exo-list" id="exo-list"></div>
    </div>
</div>

<!-- MAIN -->
<div id="main">
    <div id="main-empty">
        <div class="big-icon">üß©</div>
        <h2>Editeur d'exercices</h2>
        <p style="margin-top:8px; color:#64748b;">Selectionnez ou creez un exercice interactif</p>
    </div>

    <div id="main-editor">
        <!-- META CARD -->
        <div class="meta-card">
            <h3>Informations</h3>
            <div class="form-group" style="margin-bottom:14px;">
                <label>Titre de l'exercice</label>
                <input type="text" class="form-input" id="exo-titre" placeholder="Ex: Vocabulaire energie ‚Äî B5">
            </div>
            <div class="form-row" style="margin-bottom:14px;">
                <div class="form-group">
                    <label>Type d'exercice</label>
                    <select class="form-select" id="exo-type" onchange="onTypeChange()">
                        <option value="texte_trous">üìù Texte a trous</option>
                        <option value="relier">üîó Relier / Associer</option>
                        <option value="ordre">üìã Remettre dans l'ordre</option>
                        <option value="intrus">üîç Jeu de l'intrus</option>
                        <option value="pendu">üéØ Pendu</option>
                        <option value="mots_croises">‚úèÔ∏è Mots croises</option>
                        <option value="swipe_vf">üëÜ Swipe Vrai/Faux</option>
                        <option value="qcm_image">üñºÔ∏è QCM Image</option>
                        <option value="tableau">üìä Tableau a completer</option>
                        <option value="etude_cas">üìñ Etude de cas</option>
                        <option value="qcm_classique">üéØ QCM Classique</option>
                        <option value="quiz_chrono">‚è±Ô∏è Quiz Chrono</option>
                        <option value="categoriser">üìÇ Categoriser / Trier</option>
                        <option value="memory">üÉè Memory</option>
                        <option value="scenario">üé¨ Scenario interactif</option>
                        <option value="pad">‚ö†Ô∏è PAD (Processus d'apparition du dommage)</option>
                        <option value="prevention">üõ°Ô∏è Mesures de prevention</option>
                        <option value="estimation_risque">üìä Estimation du risque</option>
                        <option value="duerp_ligne">üìã DUERP ‚Äî Ligne unique</option>
                        <option value="duerp_mini">üìã DUERP ‚Äî Mini (4 lignes)</option>
                        <option value="pictogramme">‚ö†Ô∏è Pictogrammes de securite</option>
                        <option value="analyse_copie">üìù Analyse de copie (competences)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Difficulte</label>
                    <div class="diff-toggle">
                        <div class="diff-btn active-facile" data-diff="facile" onclick="setDifficulty('facile')">Facile</div>
                        <div class="diff-btn" data-diff="moyen" onclick="setDifficulty('moyen')">Moyen</div>
                        <div class="diff-btn" data-diff="difficile" onclick="setDifficulty('difficile')">Difficile</div>
                    </div>
                </div>
            </div>
            <div class="form-group" style="margin-bottom:14px;">
                <label>Classes</label>
                <div class="classes-pills-container" id="exo-classes-container"></div>
            </div>
            <div class="form-group">
                <label>Module</label>
                <select class="form-select" id="exo-module" disabled>
                    <option value="">‚Äî Aucun module ‚Äî</option>
                </select>
            </div>
            <div class="form-group" style="margin-top:10px;" id="categorie-group">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" id="exo-categorie-competences" onchange="onCategorieChange()">
                    <span>üìù Exercice "Competences PSE"</span>
                    <span style="font-size:0.75rem; color:#6366f1; font-weight:normal;">(apparaitra dans "Developper ses competences")</span>
                </label>
                <div id="competences-cibles-group" style="display:none; margin-top:8px; padding:8px 12px; background:#f0f0ff; border-radius:8px;">
                    <div style="font-size:0.8rem; font-weight:bold; color:#6366f1; margin-bottom:6px;">Competences ciblees :</div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        <label style="cursor:pointer;"><input type="checkbox" class="comp-cible-cb" value="C1"> C1</label>
                        <label style="cursor:pointer;"><input type="checkbox" class="comp-cible-cb" value="C2"> C2</label>
                        <label style="cursor:pointer;"><input type="checkbox" class="comp-cible-cb" value="C3"> C3</label>
                        <label style="cursor:pointer;"><input type="checkbox" class="comp-cible-cb" value="C4"> C4</label>
                        <label style="cursor:pointer;"><input type="checkbox" class="comp-cible-cb" value="C5"> C5</label>
                        <label style="cursor:pointer;"><input type="checkbox" class="comp-cible-cb" value="C6"> C6</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENT CARD -->
        <div class="content-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3 id="content-title">Contenu</h3>
                <button class="btn-import" onclick="openImportModal()">üìã Importer JSON</button>
            </div>

            <!-- TEXTE A TROUS -->
            <div class="content-type-section active" id="ct-texte_trous">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Consigne</label>
                    <input type="text" class="form-input" id="tt-consigne" placeholder="Completez le texte suivant" value="Completez le texte suivant">
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Texte (entourez les mots a deviner avec {{ }})</label>
                    <textarea class="form-textarea" id="tt-texte" rows="5" placeholder="Les energies {{renouvelables}} sont inepuisables contrairement aux energies {{fossiles}}." oninput="previewTexteTrous()"></textarea>
                </div>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:0.85rem; color:#94a3b8;">
                    <input type="checkbox" id="tt-indice"> Afficher les lettres melangees comme indice
                </label>
                <div class="form-group" style="margin-top:10px;">
                    <label style="color:#a78bfa;">üí° Explication (optionnel)</label>
                    <textarea class="form-textarea" id="tt-explication" rows="2" placeholder="Explication pedagogique affichee apres la correction..."></textarea>
                </div>
                <div class="preview-box" id="tt-preview" style="margin-top:10px;"></div>
            </div>

            <!-- RELIER -->
            <div class="content-type-section" id="ct-relier">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Consigne</label>
                    <input type="text" class="form-input" id="rel-consigne" placeholder="Reliez chaque element a sa definition" value="Reliez chaque element a sa definition">
                </div>
                <label style="font-size:0.75rem; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:8px;">Paires (gauche ‚Üî droite)</label>
                <div class="dyn-list" id="rel-list"></div>
                <button class="btn-add-row" onclick="addRelierPair()" style="margin-top:8px;">+ Ajouter une paire</button>
                <div class="form-group" style="margin-top:10px;">
                    <label style="color:#a78bfa;">üí° Explication (optionnel)</label>
                    <textarea class="form-textarea" id="rel-explication" rows="2" placeholder="Explication pedagogique affichee apres la correction..."></textarea>
                </div>
            </div>

            <!-- ORDRE -->
            <div class="content-type-section" id="ct-ordre">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Consigne</label>
                    <input type="text" class="form-input" id="ord-consigne" placeholder="Remettez dans le bon ordre" value="Remettez les etapes dans le bon ordre">
                </div>
                <label style="font-size:0.75rem; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:8px;">Elements (dans le BON ordre ‚Äî le systeme melangera)</label>
                <div class="dyn-list" id="ord-list"></div>
                <button class="btn-add-row" onclick="addOrdreItem()" style="margin-top:8px;">+ Ajouter un element</button>
                <div class="form-group" style="margin-top:10px;">
                    <label style="color:#a78bfa;">üí° Explication (optionnel)</label>
                    <textarea class="form-textarea" id="ord-explication" rows="2" placeholder="Explication pedagogique : pourquoi cet ordre..."></textarea>
                </div>
            </div>

            <!-- INTRUS -->
            <div class="content-type-section" id="ct-intrus">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Consigne</label>
                    <input type="text" class="form-input" id="int-consigne" placeholder="Trouvez l'intrus" value="Trouvez l'intrus dans chaque serie">
                </div>
                <div id="int-series"></div>
                <button class="btn-add-row" onclick="addIntrusSerie()" style="margin-top:8px;">+ Ajouter une serie</button>
            </div>

            <!-- PENDU -->
            <div class="content-type-section" id="ct-pendu">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Consigne</label>
                    <input type="text" class="form-input" id="pen-consigne" placeholder="Devinez les mots" value="Devinez les mots de la PSE">
                </div>
                <label style="font-size:0.75rem; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:8px;">Mots + indices</label>
                <div class="dyn-list" id="pen-list"></div>
                <button class="btn-add-row" onclick="addPenduMot()" style="margin-top:8px;">+ Ajouter un mot</button>
            </div>

            <!-- MOTS CROISES -->
            <div class="content-type-section" id="ct-mots_croises">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Consigne</label>
                    <input type="text" class="form-input" id="mc-consigne" placeholder="Completez la grille" value="Completez la grille de mots croises">
                </div>
                <label style="font-size:0.75rem; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:8px;">Mots + definitions</label>
                <div class="dyn-list" id="mc-list"></div>
                <button class="btn-add-row" onclick="addMotsCroisesMot()" style="margin-top:8px;">+ Ajouter un mot</button>
            </div>

            <!-- SWIPE V/F -->
            <div class="content-type-section" id="ct-swipe_vf">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Consigne</label>
                    <input type="text" class="form-input" id="svf-consigne" placeholder="Vrai ou Faux ?" value="Indiquez Vrai ou Faux pour chaque affirmation">
                </div>
                <div class="dyn-list" id="svf-list"></div>
                <button class="btn-add-row" onclick="addSwipeAffirmation()" style="margin-top:8px;">+ Ajouter une affirmation</button>
            </div>

            <!-- QCM IMAGE -->
            <div class="content-type-section" id="ct-qcm_image">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Consigne</label>
                    <input type="text" class="form-input" id="qimg-consigne" placeholder="Observez et repondez" value="Observez l'image et repondez">
                </div>
                <div id="qimg-questions"></div>
                <button class="btn-add-row" onclick="addQcmImageQuestion()" style="margin-top:8px;">+ Ajouter une question</button>
            </div>

            <!-- TABLEAU -->
            <div class="content-type-section" id="ct-tableau">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Consigne</label>
                    <input type="text" class="form-input" id="tab-consigne" placeholder="Completez le tableau" value="Completez le tableau">
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Colonnes (separees par des virgules)</label>
                    <input type="text" class="form-input" id="tab-colonnes" placeholder="Energie, Source, Renouvelable ?">
                </div>
                <label style="font-size:0.75rem; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:8px;">Lignes (cellules avec {{ }} = trous)</label>
                <div class="dyn-list" id="tab-list"></div>
                <button class="btn-add-row" onclick="addTableauLigne()" style="margin-top:8px;">+ Ajouter une ligne</button>
                <div class="form-group" style="margin-top:10px;">
                    <label style="color:#a78bfa;">üí° Explication (optionnel)</label>
                    <textarea class="form-textarea" id="tab-explication" rows="2" placeholder="Explication pedagogique : logique du classement..."></textarea>
                </div>
            </div>

            <!-- ETUDE DE CAS -->
            <div class="content-type-section" id="ct-etude_cas">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Consigne</label>
                    <input type="text" class="form-input" id="ec-consigne" placeholder="Lisez le cas et repondez" value="Lisez le cas et repondez aux questions">
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Scenario / Texte du cas</label>
                    <textarea class="form-textarea" id="ec-scenario" rows="4" placeholder="M. Dupont, 45 ans, travaille dans un atelier..."></textarea>
                </div>
                <div id="ec-questions"></div>
                <button class="btn-add-row" onclick="addEtudeCasQuestion()" style="margin-top:8px;">+ Ajouter une question</button>
            </div>

            <!-- PAD -->
            <div class="content-type-section" id="ct-pad">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Titre</label>
                    <input type="text" class="form-input" id="pad-titre" placeholder="PAD - Boucher et couteau">
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Situation professionnelle (3-5 phrases, max 500 car.)</label>
                    <textarea class="form-textarea" id="pad-situation" rows="4" maxlength="500" placeholder="Maxence travaille dans une boucherie. Il decoupe de la viande avec un couteau professionnel tres tranchant. Il ne porte pas de gant de protection..."></textarea>
                </div>
                <label style="font-size:0.75rem; color:#f59e0b; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:12px; margin-top:16px;">‚ö†Ô∏è Processus d'apparition du dommage</label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
                    <div class="form-group">
                        <label>Danger (bonne reponse, max 80 car.)</label>
                        <input type="text" class="form-input" id="pad-danger" maxlength="80" placeholder="Ex: La lame du couteau">
                    </div>
                    <div class="form-group">
                        <label>3 distracteurs danger (separes par | )</label>
                        <input type="text" class="form-input" id="pad-dist-danger" placeholder="Le froid | Le sol glissant | Le bruit">
                        <small style="color:#94a3b8; font-size:0.7rem;">Exactement 3 distracteurs separes par |</small>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
                    <div class="form-group">
                        <label>Situation dangereuse (bonne reponse, max 120 car.)</label>
                        <input type="text" class="form-input" id="pad-sitdang" maxlength="120" placeholder="Ex: Maxence decoupe la viande avec le couteau">
                    </div>
                    <div class="form-group">
                        <label>3 distracteurs situation dangereuse (separes par | )</label>
                        <input type="text" class="form-input" id="pad-dist-sitdang" placeholder="Il marche dans la chambre froide | Il porte des cartons | Il nettoie">
                        <small style="color:#94a3b8; font-size:0.7rem;">Exactement 3 distracteurs separes par |</small>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
                    <div class="form-group">
                        <label>Evenement declencheur (bonne reponse, max 120 car.)</label>
                        <input type="text" class="form-input" id="pad-event" maxlength="120" placeholder="Ex: La lame derape et touche la main">
                    </div>
                    <div class="form-group">
                        <label>3 distracteurs evenement declencheur (separes par | )</label>
                        <input type="text" class="form-input" id="pad-dist-event" placeholder="Il glisse sur le sol | Un carton tombe | Il respire des vapeurs">
                        <small style="color:#94a3b8; font-size:0.7rem;">Exactement 3 distracteurs separes par |</small>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
                    <div class="form-group">
                        <label>Dommage (bonne reponse, max 120 car.)</label>
                        <input type="text" class="form-input" id="pad-dommage" maxlength="120" placeholder="Ex: Coupure profonde a la main">
                    </div>
                    <div class="form-group">
                        <label>3 distracteurs dommage (separes par | )</label>
                        <input type="text" class="form-input" id="pad-dist-dommage" placeholder="Fracture du poignet | Brulure chimique | Lombalgie">
                        <small style="color:#94a3b8; font-size:0.7rem;">Exactement 3 distracteurs separes par |</small>
                    </div>
                </div>
                <div class="form-group" style="margin-top:10px;">
                    <label style="color:#a78bfa;">üí° Explication (optionnel)</label>
                    <textarea class="form-textarea" id="pad-explication" rows="2" placeholder="Explication pedagogique : pourquoi ces elements forment la chaine PAD..."></textarea>
                </div>
            </div>

            <!-- PREVENTION (Mesures de prevention) -->
            <div class="content-type-section" id="ct-prevention">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Titre</label>
                    <input type="text" class="form-input" id="prev-titre" placeholder="Prevention - Boucherie / couteau">
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Situation professionnelle (3-5 phrases, max 500 car.)</label>
                    <textarea class="form-textarea" id="prev-situation" rows="3" maxlength="500" placeholder="Maxence travaille dans une boucherie. Il decoupe de la viande avec un couteau professionnel tres tranchant..."></textarea>
                </div>
                <div class="form-group" style="margin-bottom:16px;">
                    <label>Danger identifie</label>
                    <input type="text" class="form-input" id="prev-danger" placeholder="La lame du couteau" maxlength="100">
                </div>
                <label style="font-size:0.75rem; color:#22c55e; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:12px;">üõ°Ô∏è 5 niveaux de prevention (du + efficace au - efficace)</label>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#22c55e; font-weight:700; display:block; margin-bottom:6px;">1Ô∏è‚É£ Supprimer le risque</label>
                    <div class="form-group" style="margin-bottom:6px;">
                        <label style="font-size:0.65rem;">Bonne reponse (max 120 car.)</label>
                        <input type="text" class="form-input" id="prev-supprimer" maxlength="120" placeholder="Ex: Remplacer la decoupe manuelle par une machine automatique">
                    </div>
                    <div class="form-group">
                        <label style="font-size:0.65rem;">3 distracteurs (separes par | )</label>
                        <input type="text" class="form-input" id="prev-dist-supprimer" placeholder="Mesure fausse 1 | Mesure fausse 2 | Mesure fausse 3">
                        <small style="color:#94a3b8; font-size:0.65rem;">Exactement 3 distracteurs separes par | ‚Äî mesures credibles mais du MAUVAIS niveau</small>
                    </div>
                </div>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#3b82f6; font-weight:700; display:block; margin-bottom:6px;">2Ô∏è‚É£ Reduire le risque a la source</label>
                    <div class="form-group" style="margin-bottom:6px;">
                        <label style="font-size:0.65rem;">Bonne reponse (max 120 car.)</label>
                        <input type="text" class="form-input" id="prev-reduire" maxlength="120" placeholder="Ex: Utiliser des couteaux a lame retractable ou protegee">
                    </div>
                    <div class="form-group">
                        <label style="font-size:0.65rem;">3 distracteurs (separes par | )</label>
                        <input type="text" class="form-input" id="prev-dist-reduire" placeholder="Mesure fausse 1 | Mesure fausse 2 | Mesure fausse 3">
                        <small style="color:#94a3b8; font-size:0.65rem;">Exactement 3 distracteurs separes par |</small>
                    </div>
                </div>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#f59e0b; font-weight:700; display:block; margin-bottom:6px;">3Ô∏è‚É£ Protection collective</label>
                    <div class="form-group" style="margin-bottom:6px;">
                        <label style="font-size:0.65rem;">Bonne reponse (max 120 car.)</label>
                        <input type="text" class="form-input" id="prev-collective" maxlength="120" placeholder="Ex: Installer un plan de travail avec butee anti-derapage">
                    </div>
                    <div class="form-group">
                        <label style="font-size:0.65rem;">3 distracteurs (separes par | )</label>
                        <input type="text" class="form-input" id="prev-dist-collective" placeholder="Mesure fausse 1 | Mesure fausse 2 | Mesure fausse 3">
                        <small style="color:#94a3b8; font-size:0.65rem;">Exactement 3 distracteurs separes par |</small>
                    </div>
                </div>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#f97316; font-weight:700; display:block; margin-bottom:6px;">4Ô∏è‚É£ Protection individuelle (EPI)</label>
                    <div class="form-group" style="margin-bottom:6px;">
                        <label style="font-size:0.65rem;">Bonne reponse (max 120 car.)</label>
                        <input type="text" class="form-input" id="prev-individuelle" maxlength="120" placeholder="Ex: Porter des gants en cotte de mailles anti-coupure">
                    </div>
                    <div class="form-group">
                        <label style="font-size:0.65rem;">3 distracteurs (separes par | )</label>
                        <input type="text" class="form-input" id="prev-dist-individuelle" placeholder="Mesure fausse 1 | Mesure fausse 2 | Mesure fausse 3">
                        <small style="color:#94a3b8; font-size:0.65rem;">Exactement 3 distracteurs separes par |</small>
                    </div>
                </div>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#ef4444; font-weight:700; display:block; margin-bottom:6px;">5Ô∏è‚É£ Information et formation</label>
                    <div class="form-group" style="margin-bottom:6px;">
                        <label style="font-size:0.65rem;">Bonne reponse (max 120 car.)</label>
                        <input type="text" class="form-input" id="prev-formation" maxlength="120" placeholder="Ex: Former Maxence aux gestes de decoupe securises">
                    </div>
                    <div class="form-group">
                        <label style="font-size:0.65rem;">3 distracteurs (separes par | )</label>
                        <input type="text" class="form-input" id="prev-dist-formation" placeholder="Mesure fausse 1 | Mesure fausse 2 | Mesure fausse 3">
                        <small style="color:#94a3b8; font-size:0.65rem;">Exactement 3 distracteurs separes par |</small>
                    </div>
                </div>
                <div class="form-group" style="margin-top:10px;">
                    <label style="color:#a78bfa;">üí° Explication (optionnel)</label>
                    <textarea class="form-textarea" id="prev-explication" rows="2" placeholder="Explication pedagogique : justification des mesures de prevention..."></textarea>
                </div>
            </div>

            <!-- ESTIMATION DU RISQUE -->
            <div class="content-type-section" id="ct-estimation_risque">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Titre</label>
                    <input type="text" class="form-input" id="est-titre" placeholder="Estimation du risque - Boucher / scie a os">
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Situation professionnelle (3-5 phrases, max 500 car.)</label>
                    <textarea class="form-textarea" id="est-situation" rows="3" maxlength="500" placeholder="Maxence, 35 ans, travaille dans une boucherie. Chaque jour, il decoupe des pieces de viande a la scie a os electrique pendant 5 heures. La lame peut happer les doigts si la main glisse..."></textarea>
                    <small style="color:#f59e0b; font-size:0.6rem;">‚ö†Ô∏è La situation DOIT contenir : un indice de frequence/duree, un element declencheur, une consequence possible</small>
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Danger identifie</label>
                    <input type="text" class="form-input" id="est-danger" placeholder="La scie a os electrique" maxlength="100">
                </div>
                <div class="form-group" style="margin-bottom:16px;">
                    <label>Dommage</label>
                    <input type="text" class="form-input" id="est-dommage" placeholder="Amputation d'un doigt" maxlength="100">
                </div>

                <label style="font-size:0.75rem; color:#8b5cf6; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:12px;">üìä Estimation du risque ‚Äî Reponses attendues</label>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#ef4444; font-weight:700; display:block; margin-bottom:6px;">1Ô∏è‚É£ Gravite du dommage</label>
                    <select class="form-select" id="est-gravite" style="width:100%;" onchange="updateEstPreview()">
                        <option value="">‚Äî Choisir ‚Äî</option>
                        <option value="1">1 - Faible (AT/MP sans arret)</option>
                        <option value="2">2 - Moyenne (AT/MP avec arret)</option>
                        <option value="3">3 - Grave (incapacite permanente)</option>
                        <option value="4">4 - Tres grave (mortel)</option>
                    </select>
                </div>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#f59e0b; font-weight:700; display:block; margin-bottom:6px;">2Ô∏è‚É£ Frequence / duree d'exposition</label>
                    <select class="form-select" id="est-exposition" style="width:100%;" onchange="updateEstPreview()">
                        <option value="">‚Äî Choisir ‚Äî</option>
                        <option value="rare_courte">Rare et/ou courte duree</option>
                        <option value="frequente_longue">Frequente et/ou longue duree</option>
                    </select>
                </div>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#3b82f6; font-weight:700; display:block; margin-bottom:6px;">3Ô∏è‚É£ Probabilite du declencheur</label>
                    <select class="form-select" id="est-declencheur" style="width:100%;" onchange="updateEstPreview()">
                        <option value="">‚Äî Choisir ‚Äî</option>
                        <option value="faible">Faible</option>
                        <option value="eleve">Elevee</option>
                    </select>
                </div>

                <div id="est-proba-result" style="background:#1e293b; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #475569; text-align:center; display:none;">
                    <span style="font-size:0.7rem; color:#94a3b8; text-transform:uppercase;">Probabilite calculee</span><br>
                    <span id="est-proba-value" style="font-size:1.4rem; font-weight:800; color:#f8fafc;"></span>
                </div>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#22c55e; font-weight:700; display:block; margin-bottom:6px;">4Ô∏è‚É£ Priorite attendue</label>
                    <select class="form-select" id="est-priorite" style="width:100%;">
                        <option value="">‚Äî Choisir ‚Äî</option>
                        <option value="prioritaire">Reduction du risque PRIORITAIRE</option>
                        <option value="non_prioritaire">Reduction du risque NON PRIORITAIRE</option>
                    </select>
                </div>

                <div id="est-matrix-preview" style="margin-top:12px; display:none;">
                    <label style="font-size:0.65rem; color:#94a3b8; text-transform:uppercase; display:block; margin-bottom:6px;">Apercu matrice</label>
                    <div style="display:grid; grid-template-columns: auto repeat(4, 1fr); grid-template-rows: repeat(5, auto); gap:2px; font-size:0.6rem; text-align:center; max-width:300px;">
                        <div></div>
                        <div style="color:#94a3b8; padding:3px;">1</div>
                        <div style="color:#94a3b8; padding:3px;">2</div>
                        <div style="color:#94a3b8; padding:3px;">3</div>
                        <div style="color:#94a3b8; padding:3px;">4</div>
                        <div style="color:#94a3b8; padding:3px; text-align:right;">4</div>
                        <div class="est-prev-cell" data-g="4" data-p="1" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="4" data-p="2" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="4" data-p="3" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="4" data-p="4" style="padding:4px; border-radius:4px;"></div>
                        <div style="color:#94a3b8; padding:3px; text-align:right;">3</div>
                        <div class="est-prev-cell" data-g="3" data-p="1" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="3" data-p="2" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="3" data-p="3" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="3" data-p="4" style="padding:4px; border-radius:4px;"></div>
                        <div style="color:#94a3b8; padding:3px; text-align:right;">2</div>
                        <div class="est-prev-cell" data-g="2" data-p="1" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="2" data-p="2" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="2" data-p="3" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="2" data-p="4" style="padding:4px; border-radius:4px;"></div>
                        <div style="color:#94a3b8; padding:3px; text-align:right;">1</div>
                        <div class="est-prev-cell" data-g="1" data-p="1" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="1" data-p="2" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="1" data-p="3" style="padding:4px; border-radius:4px;"></div>
                        <div class="est-prev-cell" data-g="1" data-p="4" style="padding:4px; border-radius:4px;"></div>
                    </div>
                </div>
            </div>

            <!-- DUERP LIGNE -->
            <div class="content-type-section" id="ct-duerp_ligne">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Titre</label>
                    <input type="text" class="form-input" id="duerp-l-titre" placeholder="DUERP - Preparateur de commandes / manutention">
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Unite de travail</label>
                    <input type="text" class="form-input" id="duerp-l-unite" placeholder="Entrepot - preparation de commandes">
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Situation professionnelle (3-5 phrases, max 500 car.)</label>
                    <textarea class="form-textarea" id="duerp-l-situation" rows="3" maxlength="500" placeholder="Ahmed, preparateur de commandes, souleve et deplace des colis de 15 a 25 kg pendant 7 heures par jour..."></textarea>
                    <small style="color:#f59e0b; font-size:0.6rem;">‚ö†Ô∏è La situation DOIT contenir des indices de frequence/duree, de declencheur, et de gravite</small>
                </div>

                <label style="font-size:0.75rem; color:#ef4444; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:12px;">‚ö†Ô∏è Danger ‚Äî QCM 4 choix</label>
                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <div class="form-group" style="margin-bottom:6px;">
                        <label style="font-size:0.65rem;">Bonne reponse (max 100 car.)</label>
                        <input type="text" class="form-input" id="duerp-l-danger" maxlength="100" placeholder="Les manutentions manuelles repetees">
                    </div>
                    <div class="form-group">
                        <label style="font-size:0.65rem;">3 distracteurs (separes par | )</label>
                        <input type="text" class="form-input" id="duerp-l-dist-danger" placeholder="Le bruit des chariots | L'eclairage insuffisant | La temperature ambiante">
                        <small style="color:#94a3b8; font-size:0.65rem;">Exactement 3 distracteurs plausibles dans le meme metier</small>
                    </div>
                </div>

                <label style="font-size:0.75rem; color:#f97316; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:12px;">ü©π Dommage ‚Äî QCM 4 choix</label>
                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <div class="form-group" style="margin-bottom:6px;">
                        <label style="font-size:0.65rem;">Bonne reponse (max 100 car.)</label>
                        <input type="text" class="form-input" id="duerp-l-dommage" maxlength="100" placeholder="Lombalgie chronique avec arret de travail">
                    </div>
                    <div class="form-group">
                        <label style="font-size:0.65rem;">3 distracteurs (separes par | )</label>
                        <input type="text" class="form-input" id="duerp-l-dist-dommage" placeholder="Fatigue visuelle | Stress professionnel | Deshydratation">
                        <small style="color:#94a3b8; font-size:0.65rem;">Exactement 3 distracteurs plausibles</small>
                    </div>
                </div>

                <label style="font-size:0.75rem; color:#8b5cf6; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-bottom:12px;">üìä Estimation du risque ‚Äî Reponses attendues</label>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#ef4444; font-weight:700; display:block; margin-bottom:6px;">1Ô∏è‚É£ Gravite du dommage</label>
                    <select class="form-select" id="duerp-l-gravite" style="width:100%;" onchange="updateDuerpLPreview()">
                        <option value="">‚Äî Choisir ‚Äî</option>
                        <option value="1">1 - Faible (AT/MP sans arret)</option>
                        <option value="2">2 - Moyenne (AT/MP avec arret)</option>
                        <option value="3">3 - Grave (incapacite permanente)</option>
                        <option value="4">4 - Tres grave (mortel)</option>
                    </select>
                </div>
                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#f59e0b; font-weight:700; display:block; margin-bottom:6px;">2Ô∏è‚É£ Frequence / duree d'exposition</label>
                    <select class="form-select" id="duerp-l-exposition" style="width:100%;" onchange="updateDuerpLPreview()">
                        <option value="">‚Äî Choisir ‚Äî</option>
                        <option value="rare_courte">Rare et/ou courte duree</option>
                        <option value="frequente_longue">Frequente et/ou longue duree</option>
                    </select>
                </div>
                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#3b82f6; font-weight:700; display:block; margin-bottom:6px;">3Ô∏è‚É£ Probabilite du declencheur</label>
                    <select class="form-select" id="duerp-l-declencheur" style="width:100%;" onchange="updateDuerpLPreview()">
                        <option value="">‚Äî Choisir ‚Äî</option>
                        <option value="faible">Faible</option>
                        <option value="eleve">Elevee</option>
                    </select>
                </div>

                <div id="duerp-l-proba-result" style="background:#1e293b; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #475569; text-align:center; display:none;">
                    <span style="font-size:0.7rem; color:#94a3b8; text-transform:uppercase;">Probabilite calculee</span><br>
                    <span id="duerp-l-proba-value" style="font-size:1.4rem; font-weight:800; color:#f8fafc;"></span>
                    <br><span id="duerp-l-prio-value" style="font-size:0.8rem; font-weight:700;"></span>
                </div>

                <div id="duerp-l-matrix-preview" style="margin-top:12px; display:none;">
                    <label style="font-size:0.65rem; color:#94a3b8; text-transform:uppercase; display:block; margin-bottom:6px;">Apercu matrice</label>
                    <div style="display:grid; grid-template-columns: auto repeat(4, 1fr); grid-template-rows: repeat(5, auto); gap:2px; font-size:0.6rem; text-align:center; max-width:300px;">
                        <div></div><div style="color:#94a3b8; padding:3px;">1</div><div style="color:#94a3b8; padding:3px;">2</div><div style="color:#94a3b8; padding:3px;">3</div><div style="color:#94a3b8; padding:3px;">4</div>
                        <div style="color:#94a3b8; padding:3px; text-align:right;">4</div><div class="duerp-l-prev-cell" data-g="4" data-p="1" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="4" data-p="2" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="4" data-p="3" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="4" data-p="4" style="padding:4px; border-radius:4px;"></div>
                        <div style="color:#94a3b8; padding:3px; text-align:right;">3</div><div class="duerp-l-prev-cell" data-g="3" data-p="1" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="3" data-p="2" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="3" data-p="3" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="3" data-p="4" style="padding:4px; border-radius:4px;"></div>
                        <div style="color:#94a3b8; padding:3px; text-align:right;">2</div><div class="duerp-l-prev-cell" data-g="2" data-p="1" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="2" data-p="2" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="2" data-p="3" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="2" data-p="4" style="padding:4px; border-radius:4px;"></div>
                        <div style="color:#94a3b8; padding:3px; text-align:right;">1</div><div class="duerp-l-prev-cell" data-g="1" data-p="1" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="1" data-p="2" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="1" data-p="3" style="padding:4px; border-radius:4px;"></div><div class="duerp-l-prev-cell" data-g="1" data-p="4" style="padding:4px; border-radius:4px;"></div>
                    </div>
                </div>

                <label style="font-size:0.75rem; color:#22c55e; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; display:block; margin-top:16px; margin-bottom:12px;">üõ°Ô∏è Mesure principale (optionnel) ‚Äî QCM 5 choix</label>
                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <div class="form-group" style="margin-bottom:6px;">
                        <label style="font-size:0.65rem;">Bonne reponse (laisser vide si pas de mesure)</label>
                        <input type="text" class="form-input" id="duerp-l-mesure" maxlength="150" placeholder="Mettre a disposition des aides a la manutention (transpalette electrique)">
                    </div>
                    <div class="form-group">
                        <label style="font-size:0.65rem;">4 distracteurs (separes par | )</label>
                        <input type="text" class="form-input" id="duerp-l-dist-mesure" placeholder="Afficher des consignes | Distribuer des bouteilles d'eau | Organiser une reunion | Fournir des chaussures">
                        <small style="color:#94a3b8; font-size:0.65rem;">Exactement 4 distracteurs si mesure presente (5 choix total)</small>
                    </div>
                </div>
            </div>

            <!-- DUERP MINI -->
            <div class="content-type-section" id="ct-duerp_mini">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Titre</label>
                    <input type="text" class="form-input" id="duerp-m-titre" placeholder="Mini DUERP - Restaurant Le Bon Gout">
                </div>
                <div class="form-group" style="margin-bottom:16px;">
                    <label>Nom de l'entreprise</label>
                    <input type="text" class="form-input" id="duerp-m-entreprise" placeholder="Restaurant Le Bon Gout">
                </div>

                <div id="duerp-m-lignes-container">
                    <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:14px; border:1px solid #334155;">
                        <label style="font-size:0.85rem; color:#3b82f6; font-weight:800; display:block; margin-bottom:10px;">üìå Ligne 1</label>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Unite de travail</label><input type="text" class="form-input" id="duerp-m-L1-unite" placeholder="Cuisine"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Situation (max 500 car.)</label><textarea class="form-textarea" id="duerp-m-L1-situation" rows="2" maxlength="500"></textarea></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Danger (bonne reponse)</label><input type="text" class="form-input" id="duerp-m-L1-danger" maxlength="100"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Danger (3 distracteurs |)</label><input type="text" class="form-input" id="duerp-m-L1-dist-danger"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Dommage (bonne reponse)</label><input type="text" class="form-input" id="duerp-m-L1-dommage" maxlength="100"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Dommage (3 distracteurs |)</label><input type="text" class="form-input" id="duerp-m-L1-dist-dommage"></div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <div style="flex:1; min-width:100px;"><label style="font-size:0.65rem;">Gravite</label><select class="form-select" id="duerp-m-L1-gravite" style="width:100%;"><option value="">‚Äî</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                            <div style="flex:1; min-width:120px;"><label style="font-size:0.65rem;">Exposition</label><select class="form-select" id="duerp-m-L1-exposition" style="width:100%;"><option value="">‚Äî</option><option value="rare_courte">Rare/courte</option><option value="frequente_longue">Freq./longue</option></select></div>
                            <div style="flex:1; min-width:100px;"><label style="font-size:0.65rem;">Declencheur</label><select class="form-select" id="duerp-m-L1-declencheur" style="width:100%;"><option value="">‚Äî</option><option value="faible">Faible</option><option value="eleve">Elevee</option></select></div>
                        </div>
                    </div>

                    <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:14px; border:1px solid #334155;">
                        <label style="font-size:0.85rem; color:#f59e0b; font-weight:800; display:block; margin-bottom:10px;">üìå Ligne 2</label>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Unite de travail</label><input type="text" class="form-input" id="duerp-m-L2-unite" placeholder="Salle"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Situation (max 500 car.)</label><textarea class="form-textarea" id="duerp-m-L2-situation" rows="2" maxlength="500"></textarea></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Danger (bonne reponse)</label><input type="text" class="form-input" id="duerp-m-L2-danger" maxlength="100"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Danger (3 distracteurs |)</label><input type="text" class="form-input" id="duerp-m-L2-dist-danger"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Dommage (bonne reponse)</label><input type="text" class="form-input" id="duerp-m-L2-dommage" maxlength="100"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Dommage (3 distracteurs |)</label><input type="text" class="form-input" id="duerp-m-L2-dist-dommage"></div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <div style="flex:1; min-width:100px;"><label style="font-size:0.65rem;">Gravite</label><select class="form-select" id="duerp-m-L2-gravite" style="width:100%;"><option value="">‚Äî</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                            <div style="flex:1; min-width:120px;"><label style="font-size:0.65rem;">Exposition</label><select class="form-select" id="duerp-m-L2-exposition" style="width:100%;"><option value="">‚Äî</option><option value="rare_courte">Rare/courte</option><option value="frequente_longue">Freq./longue</option></select></div>
                            <div style="flex:1; min-width:100px;"><label style="font-size:0.65rem;">Declencheur</label><select class="form-select" id="duerp-m-L2-declencheur" style="width:100%;"><option value="">‚Äî</option><option value="faible">Faible</option><option value="eleve">Elevee</option></select></div>
                        </div>
                    </div>

                    <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:14px; border:1px solid #334155;">
                        <label style="font-size:0.85rem; color:#22c55e; font-weight:800; display:block; margin-bottom:10px;">üìå Ligne 3</label>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Unite de travail</label><input type="text" class="form-input" id="duerp-m-L3-unite" placeholder="Plonge"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Situation (max 500 car.)</label><textarea class="form-textarea" id="duerp-m-L3-situation" rows="2" maxlength="500"></textarea></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Danger (bonne reponse)</label><input type="text" class="form-input" id="duerp-m-L3-danger" maxlength="100"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Danger (3 distracteurs |)</label><input type="text" class="form-input" id="duerp-m-L3-dist-danger"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Dommage (bonne reponse)</label><input type="text" class="form-input" id="duerp-m-L3-dommage" maxlength="100"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Dommage (3 distracteurs |)</label><input type="text" class="form-input" id="duerp-m-L3-dist-dommage"></div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <div style="flex:1; min-width:100px;"><label style="font-size:0.65rem;">Gravite</label><select class="form-select" id="duerp-m-L3-gravite" style="width:100%;"><option value="">‚Äî</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                            <div style="flex:1; min-width:120px;"><label style="font-size:0.65rem;">Exposition</label><select class="form-select" id="duerp-m-L3-exposition" style="width:100%;"><option value="">‚Äî</option><option value="rare_courte">Rare/courte</option><option value="frequente_longue">Freq./longue</option></select></div>
                            <div style="flex:1; min-width:100px;"><label style="font-size:0.65rem;">Declencheur</label><select class="form-select" id="duerp-m-L3-declencheur" style="width:100%;"><option value="">‚Äî</option><option value="faible">Faible</option><option value="eleve">Elevee</option></select></div>
                        </div>
                    </div>

                    <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:14px; border:1px solid #334155;">
                        <label style="font-size:0.85rem; color:#ef4444; font-weight:800; display:block; margin-bottom:10px;">üìå Ligne 4</label>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Unite de travail</label><input type="text" class="form-input" id="duerp-m-L4-unite" placeholder="Reserve / stockage"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Situation (max 500 car.)</label><textarea class="form-textarea" id="duerp-m-L4-situation" rows="2" maxlength="500"></textarea></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Danger (bonne reponse)</label><input type="text" class="form-input" id="duerp-m-L4-danger" maxlength="100"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Danger (3 distracteurs |)</label><input type="text" class="form-input" id="duerp-m-L4-dist-danger"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Dommage (bonne reponse)</label><input type="text" class="form-input" id="duerp-m-L4-dommage" maxlength="100"></div>
                        <div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.65rem;">Dommage (3 distracteurs |)</label><input type="text" class="form-input" id="duerp-m-L4-dist-dommage"></div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <div style="flex:1; min-width:100px;"><label style="font-size:0.65rem;">Gravite</label><select class="form-select" id="duerp-m-L4-gravite" style="width:100%;"><option value="">‚Äî</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                            <div style="flex:1; min-width:120px;"><label style="font-size:0.65rem;">Exposition</label><select class="form-select" id="duerp-m-L4-exposition" style="width:100%;"><option value="">‚Äî</option><option value="rare_courte">Rare/courte</option><option value="frequente_longue">Freq./longue</option></select></div>
                            <div style="flex:1; min-width:100px;"><label style="font-size:0.65rem;">Declencheur</label><select class="form-select" id="duerp-m-L4-declencheur" style="width:100%;"><option value="">‚Äî</option><option value="faible">Faible</option><option value="eleve">Elevee</option></select></div>
                        </div>
                    </div>
                </div>

                <div style="background:#0f172a; border-radius:10px; padding:14px; margin-bottom:10px; border:1px solid #334155;">
                    <label style="font-size:0.75rem; color:#8b5cf6; font-weight:700; display:block; margin-bottom:6px;">üéØ Mission finale ‚Äî Nb de risques prioritaires a selectionner</label>
                    <input type="number" class="form-input" id="duerp-m-nb-prio" value="2" min="1" max="4" style="width:80px;">
                    <small style="color:#94a3b8; font-size:0.65rem; display:block; margin-top:4px;">L'eleve devra cocher les N risques qu'il considere prioritaires</small>
                </div>
            </div>
        </div>

        <!-- ====== QCM CLASSIQUE ====== -->
        <div class="content-type-section" id="ct-qcm_classique">
            <div class="form-group"><label>Titre</label><input type="text" class="form-input" id="qcmc-titre" placeholder="QCM - Les risques electriques"></div>
            <div class="form-group"><label>Question</label><textarea class="form-textarea" id="qcmc-question" rows="3" placeholder="Quelle est la premiere action a effectuer..."></textarea></div>
            <div class="form-group"><label>Bonne(s) reponse(s) (une par ligne si multiple)</label><textarea class="form-textarea" id="qcmc-reponse" rows="2" placeholder="Couper le courant"></textarea></div>
            <div class="form-group"><label>Distracteurs (separ√©s par |)</label><input type="text" class="form-input" id="qcmc-distracteurs" placeholder="Toucher la victime | Appeler les pompiers | Arroser d'eau"></div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="qcmc-multiple"> <label for="qcmc-multiple" style="margin:0;">Plusieurs bonnes reponses (QCM multiple)</label>
            </div>
            <div class="form-group"><label>Explication (optionnel)</label><textarea class="form-textarea" id="qcmc-explication" rows="2" placeholder="Il faut toujours couper le courant avant..."></textarea></div>
        </div>

        <!-- ====== QUIZ CHRONO ====== -->
        <div class="content-type-section" id="ct-quiz_chrono">
            <div class="form-group"><label>Titre</label><input type="text" class="form-input" id="chrono-titre" placeholder="Quiz Chrono - Gestes de secours"></div>
            <div class="form-group"><label>Temps par question (secondes)</label><input type="number" class="form-input" id="chrono-temps" value="15" min="5" max="120" style="width:100px;"></div>
            <div id="chrono-questions"></div>
            <button type="button" class="btn-save" style="background:#0ea5e9; margin-top:8px;" onclick="addChronoQuestion()">+ Ajouter une question</button>
        </div>

        <!-- ====== CATEGORISER ====== -->
        <div class="content-type-section" id="ct-categoriser">
            <div class="form-group"><label>Titre</label><input type="text" class="form-input" id="cat-titre" placeholder="Categoriser - Types de risques"></div>
            <div class="form-group"><label>Consigne</label><input type="text" class="form-input" id="cat-consigne" value="Classez chaque element dans la bonne categorie"></div>
            <div class="form-group"><label>Categories (separees par |)</label><input type="text" class="form-input" id="cat-categories" placeholder="Risques physiques | Risques chimiques | Risques biologiques" oninput="updateCatSelects()"></div>
            <div id="cat-items-list"></div>
            <button type="button" class="btn-save" style="background:#22c55e; margin-top:8px;" onclick="addCatItem()">+ Ajouter un item</button>
        </div>

        <!-- ====== MEMORY ====== -->
        <div class="content-type-section" id="ct-memory">
            <div class="form-group"><label>Titre</label><input type="text" class="form-input" id="mem-titre" placeholder="Memory - Vocabulaire SST"></div>
            <div id="mem-list"></div>
            <button type="button" class="btn-save" style="background:#a855f7; margin-top:8px;" onclick="addMemoryPair()">+ Ajouter une paire</button>
        </div>

        <!-- ====== SCENARIO ====== -->
        <div class="content-type-section" id="ct-scenario">
            <div class="form-group"><label>Titre</label><input type="text" class="form-input" id="scen-titre" placeholder="Scenario - Accident du travail"></div>
            <div id="scen-etapes"></div>
            <button type="button" class="btn-save" style="background:#f97316; margin-top:8px;" onclick="addScenEtape()">+ Ajouter une etape</button>
        </div>

        <!-- PICTOGRAMME -->
        <div class="content-type-section" id="ct-pictogramme">
            <div class="form-group" style="margin-bottom:10px;">
                <label>Consigne</label>
                <input type="text" class="form-input" id="picto-consigne" placeholder="Identifie les pictogrammes de securite" value="Identifie les pictogrammes de securite">
            </div>
            <div class="form-group" style="margin-bottom:10px;">
                <label>Mode d'exercice</label>
                <select class="form-select" id="picto-mode" onchange="onPictoModeChange()">
                    <option value="quiz_image">üñºÔ∏è Quiz : Image ‚Üí Nom (4 choix)</option>
                    <option value="nom_vers_image">üî§ Quiz : Nom ‚Üí Image (4 choix)</option>
                    <option value="categoriser">üìÇ Trier par categorie</option>
                    <option value="memory">üÉè Memory (image ‚Üî nom)</option>
                    <option value="speed">‚ö° Speed Challenge (chrono 60s)</option>
                    <option value="escape_game">üîê Escape Game (epreuves enchainees)</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom:10px;">
                <label>Nombre de pictogrammes</label>
                <input type="number" class="form-input" id="picto-nb" placeholder="8" value="8" min="4" max="81" style="width:80px;">
                <span style="font-size:0.75rem; color:#94a3b8; margin-left:8px;">Sur 81 disponibles (min 4, max 81)</span>
            </div>
            <div class="form-group" style="margin-bottom:10px;">
                <label>Categories a inclure</label>
                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:4px;">
                    <label style="display:flex; align-items:center; gap:4px; font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="picto-cat-cb" value="obligation" checked> üîµ Obligation (12)
                    </label>
                    <label style="display:flex; align-items:center; gap:4px; font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="picto-cat-cb" value="interdiction" checked> üî¥ Interdiction (8)
                    </label>
                    <label style="display:flex; align-items:center; gap:4px; font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="picto-cat-cb" value="danger" checked> ‚ö†Ô∏è Danger (20)
                    </label>
                    <label style="display:flex; align-items:center; gap:4px; font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="picto-cat-cb" value="incendie" checked> üî• Incendie (14)
                    </label>
                    <label style="display:flex; align-items:center; gap:4px; font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="picto-cat-cb" value="secours" checked> üü¢ Secours (18)
                    </label>
                    <label style="display:flex; align-items:center; gap:4px; font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="picto-cat-cb" value="sgh" checked> ‚ò£Ô∏è Produits chimiques SGH (9)
                    </label>
                </div>
            </div>
            <div class="form-group" style="margin-top:10px;">
                <label style="color:#a78bfa;">üí° Explication (optionnel)</label>
                <textarea class="form-textarea" id="picto-explication" rows="2" placeholder="Explication pedagogique affichee apres la correction..."></textarea>
            </div>
        </div>

        <div class="content-type-section" id="ct-analyse_copie">
            <div style="background:#f5f3ff; border:2px solid #c4b5fd; border-radius:10px; padding:16px; margin-bottom:14px;">
                <div style="font-weight:700; color:#6366f1; margin-bottom:8px;">üìù Analyse de copie ‚Äî Import JSON</div>
                <p style="font-size:0.85rem; color:#64748b; margin-bottom:10px;">Collez le JSON genere par ChatGPT ci-dessous. L'exercice sera importe automatiquement.</p>
                <textarea class="form-textarea" id="ac-json-input" rows="8" placeholder='{"consigne":"...","contexte":"...","items":[...]}'></textarea>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button class="btn-small" onclick="acImportJson()" style="background:#6366f1; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600;">üì• Importer le JSON</button>
                    <button class="btn-small" onclick="acCopyPrompt()" style="background:#e2e8f0; color:#475569; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600;">üìã Copier le prompt ChatGPT</button>
                </div>
                <div id="ac-import-status" style="margin-top:8px; font-size:0.85rem; display:none;"></div>
            </div>
        </div>

        <!-- ACTIONS -->
        <div class="bottom-actions">
            <button class="btn-save" onclick="saveExercice()">üíæ Sauvegarder</button>
            <button class="btn-publish" id="btn-publish" onclick="publishExercice()">üöÄ Publier</button>
            <button class="btn-unpublish" id="btn-unpublish" onclick="unpublishExercice()">‚è∏Ô∏è Depublier</button>
            <button class="btn-delete" id="btn-delete" onclick="deleteExercice()">üóëÔ∏è Supprimer</button>
        </div>
    </div>
</div>

<!-- IMPORT JSON MODAL -->
<div class="modal-overlay" id="import-modal">
    <div class="modal">
        <h3>üìã Importer du JSON</h3>
        <p style="font-size:0.85rem; color:#94a3b8; margin-bottom:12px;">Collez le JSON genere par ChatGPT / Claude ci-dessous.</p>
        <div class="prompt-guide" id="import-prompt-guide"></div>
        <div class="json-guide" id="import-json-guide"></div>
        <textarea class="form-textarea" id="import-json-input" rows="8" placeholder="Collez votre JSON ici..."></textarea>
        <div id="import-error" style="color:#ef4444; font-size:0.85rem; margin-top:6px; display:none;"></div>
        <div class="modal-actions">
            <button onclick="closeImportModal()" style="background:#334155; color:white;">Annuler</button>
            <button onclick="doImportJSON()" style="background:#3b82f6; color:white;">Importer</button>
        </div>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script src="data_modules.js"></script>
<script>
    function toggleMenu(){ document.body.classList.toggle('menu-open'); }
    function closeMenu(){ document.body.classList.remove('menu-open'); }

    // Current difficulty
    var currentDifficulty = 'facile';

    window.setDifficulty = function(d) {
        currentDifficulty = d;
        document.querySelectorAll('.diff-btn').forEach(b => {
            b.className = 'diff-btn';
            if (b.dataset.diff === d) b.classList.add('active-' + d);
        });
    };
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.firebasestorage.app",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentExoId = null;
    let allExercices = [];

    // ========== TYPE LABELS ==========
    const TYPE_LABELS = {
        texte_trous: 'üìù Texte a trous', relier: 'üîó Relier', ordre: 'üìã Ordre',
        intrus: 'üîç Intrus', pendu: 'üéØ Pendu', mots_croises: '‚úèÔ∏è Mots croises',
        swipe_vf: 'üëÜ Vrai/Faux', qcm_image: 'üñºÔ∏è QCM Image', tableau: 'üìä Tableau',
        etude_cas: 'üìñ Etude de cas',
        qcm_classique: 'üéØ QCM Classique',
        quiz_chrono: '‚è±Ô∏è Quiz Chrono',
        categoriser: 'üìÇ Categoriser',
        memory: 'üÉè Memory',
        scenario: 'üé¨ Scenario',
        pad: '‚ö†Ô∏è PAD',
        prevention: 'üõ°Ô∏è Prevention',
        estimation_risque: 'üìä Estimation',
        duerp_ligne: 'üìã DUERP Ligne',
        duerp_mini: 'üìã DUERP Mini',
        pictogramme: '‚ö†Ô∏è Pictogrammes',
        analyse_copie: 'üìù Analyse copie'
    };

    // ========== CLASS PILLS ==========
    function renderClassPills() {
        const container = document.getElementById('exo-classes-container');
        container.innerHTML = '';
        const classes = window.getListeClassesPourAffichage ? window.getListeClassesPourAffichage() : [];
        const allPill = document.createElement('span');
        allPill.className = 'class-pill pill-all active';
        allPill.dataset.classeId = '';
        allPill.textContent = 'Toutes les classes';
        allPill.onclick = () => toggleClassPill(allPill);
        container.appendChild(allPill);
        classes.forEach(c => {
            const pill = document.createElement('span');
            pill.className = 'class-pill';
            pill.dataset.classeId = c.id;
            pill.textContent = c.label;
            pill.title = c.niveau.replace(/_/g, ' ');
            pill.onclick = () => toggleClassPill(pill);
            container.appendChild(pill);
        });
    }

    function toggleClassPill(el) {
        const isAllPill = el.dataset.classeId === '';
        const container = document.getElementById('exo-classes-container');
        const allPills = container.querySelectorAll('.class-pill');
        const allPillEl = container.querySelector('.pill-all');
        if (isAllPill) {
            allPills.forEach(p => p.classList.remove('active'));
            allPillEl.classList.add('active');
        } else {
            el.classList.toggle('active');
            allPillEl.classList.remove('active');
            const activeClasses = container.querySelectorAll('.class-pill.active:not(.pill-all)');
            if (activeClasses.length === 0) allPillEl.classList.add('active');
        }
        updateModuleFromPills();
    }

    function getSelectedClasseIds() {
        const container = document.getElementById('exo-classes-container');
        const allPillEl = container.querySelector('.pill-all');
        if (allPillEl && allPillEl.classList.contains('active')) return [];
        const ids = [];
        container.querySelectorAll('.class-pill.active:not(.pill-all)').forEach(p => ids.push(p.dataset.classeId));
        return ids;
    }

    function setClassPillsActive(ids) {
        const container = document.getElementById('exo-classes-container');
        container.querySelectorAll('.class-pill').forEach(p => p.classList.remove('active'));
        if (!ids || ids.length === 0) {
            container.querySelector('.pill-all').classList.add('active');
        } else {
            ids.forEach(id => {
                const pill = container.querySelector('.class-pill[data-classe-id="' + id + '"]');
                if (pill) pill.classList.add('active');
            });
        }
        updateModuleFromPills();
    }

    function populateModuleDropdown(modSel, classeId) {
        modSel.disabled = false;
        modSel.innerHTML = '<option value="">‚Äî Aucun module ‚Äî</option>';
        const classesInGroup = window.getClassesFromGroupe ? window.getClassesFromGroupe(classeId) : [classeId];
        const firstClass = classesInGroup[0];
        const groups = window.getModulesForRevision
            ? window.getModulesForRevision(firstClass)
            : [{ niveauLabel: '', modules: window.getModulesForClasse ? window.getModulesForClasse(firstClass) : [] }];
        const isMultiYear = groups.length > 1;
        groups.forEach(group => {
            let currentTheme = '';
            group.modules.forEach(m => {
                if (m.theme !== currentTheme) {
                    currentTheme = m.theme;
                    const optGroup = document.createElement('optgroup');
                    optGroup.label = isMultiYear ? group.niveauLabel + ' ‚Äî Theme ' + m.theme : 'Theme ' + m.theme;
                    modSel.appendChild(optGroup);
                }
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.id + ' ‚Äî ' + m.titre;
                const lastGroup = modSel.querySelector('optgroup:last-of-type');
                if (lastGroup) lastGroup.appendChild(opt);
                else modSel.appendChild(opt);
            });
        });
    }

    function updateModuleFromPills() {
        const ids = getSelectedClasseIds();
        const modSel = document.getElementById('exo-module');
        modSel.innerHTML = '';
        if (ids.length === 0) {
            modSel.disabled = false;
            modSel.innerHTML = '<option value="">‚Äî Aucun module ‚Äî</option>';
            return;
        }
        // Verifier si toutes les classes partagent le meme niveau
        const niveauxSet = new Set();
        ids.forEach(id => {
            const cig = window.getClassesFromGroupe ? window.getClassesFromGroupe(id) : [id];
            const niv = window.getNiveauClasse ? window.getNiveauClasse(cig[0]) : null;
            if (niv) niveauxSet.add(niv);
        });
        if (niveauxSet.size === 1) {
            // Meme niveau ‚Üí activer dropdown et remplir avec les modules partages
            populateModuleDropdown(modSel, ids[0]);
        } else {
            // Niveaux differents ‚Üí desactiver
            modSel.disabled = true;
            modSel.innerHTML = '<option value="">‚Äî Niveaux diff√©rents ‚Äî</option>';
        }
    }

    renderClassPills();

    // ========== TYPE CHANGE ==========
    const TRANSVERSAL_TYPES = ['pad', 'prevention', 'estimation_risque', 'duerp_ligne', 'duerp_mini'];
    const AUTO_COMPETENCES_TYPES = ['analyse_copie'];

    window.onTypeChange = function() {
        const type = document.getElementById('exo-type').value;
        document.querySelectorAll('.content-type-section').forEach(s => s.classList.remove('active'));
        const section = document.getElementById('ct-' + type);
        if (section) section.classList.add('active');
        document.getElementById('content-title').textContent = 'Contenu ‚Äî ' + (TYPE_LABELS[type] || type);

        const modSel = document.getElementById('exo-module');
        const catCheckbox = document.getElementById('exo-categorie-competences');
        const catGroup = document.getElementById('categorie-group');

        var compCiblesGroup = document.getElementById('competences-cibles-group');

        if (AUTO_COMPETENCES_TYPES.includes(type)) {
            // analyse_copie : toujours competences, checkbox cochee + grisee
            catCheckbox.checked = true;
            catCheckbox.disabled = true;
            catGroup.style.display = '';
            if (compCiblesGroup) compCiblesGroup.style.display = '';
            modSel.innerHTML = '<option value="TRANSVERSAL">Transversal (toutes classes)</option>';
            modSel.value = 'TRANSVERSAL';
            modSel.disabled = true;
        } else if (TRANSVERSAL_TYPES.includes(type)) {
            // PAD, Prevention, etc. : checkbox masquee, module = TRANSVERSAL
            catCheckbox.checked = false;
            catCheckbox.disabled = false;
            catGroup.style.display = 'none';
            if (compCiblesGroup) compCiblesGroup.style.display = 'none';
            modSel.innerHTML = '<option value="TRANSVERSAL">Transversal (toutes classes)</option>';
            modSel.value = 'TRANSVERSAL';
            modSel.disabled = true;
        } else {
            // Types normaux : checkbox visible et activable
            catCheckbox.disabled = false;
            catGroup.style.display = '';
            if (compCiblesGroup) compCiblesGroup.style.display = catCheckbox.checked ? '' : 'none';
            if (!catCheckbox.checked && modSel.disabled && modSel.value === 'TRANSVERSAL') {
                updateModuleFromPills();
            }
            // Si checkbox deja cochee, garder module TRANSVERSAL
            if (catCheckbox.checked) {
                modSel.innerHTML = '<option value="TRANSVERSAL">Transversal (toutes classes)</option>';
                modSel.value = 'TRANSVERSAL';
                modSel.disabled = true;
            }
        }
    };

    function getSelectedCompetences() {
        var cbs = document.querySelectorAll('.comp-cible-cb');
        var result = [];
        cbs.forEach(function(cb) { if (cb.checked) result.push(cb.value); });
        return result;
    }

    window.onCategorieChange = function() {
        const type = document.getElementById('exo-type').value;
        const catCheckbox = document.getElementById('exo-categorie-competences');
        const modSel = document.getElementById('exo-module');
        const compCiblesGroup = document.getElementById('competences-cibles-group');
        // Afficher/masquer les competences ciblees
        if (compCiblesGroup) {
            compCiblesGroup.style.display = catCheckbox.checked ? '' : 'none';
        }
        // Ne pas toucher pour les types qui gerent deja le module
        if (TRANSVERSAL_TYPES.includes(type) || AUTO_COMPETENCES_TYPES.includes(type)) return;
        if (catCheckbox.checked) {
            modSel.innerHTML = '<option value="TRANSVERSAL">Transversal (toutes classes)</option>';
            modSel.value = 'TRANSVERSAL';
            modSel.disabled = true;
        } else {
            modSel.disabled = false;
            updateModuleFromPills();
        }
    };

    // ========== PREVIEW TEXTE A TROUS ==========
    window.previewTexteTrous = function() {
        const texte = document.getElementById('tt-texte').value;
        const preview = document.getElementById('tt-preview');
        if (!texte.trim()) { preview.innerHTML = '<span style="color:#64748b; font-style:italic;">Apercu...</span>'; return; }
        const html = texte.replace(/\{\{([^}]+)\}\}/g, '<span class="trou">$1</span>');
        preview.innerHTML = html;
    };

    // ========== DYNAMIC ROW HELPERS ==========

    // --- RELIER ---
    window.addRelierPair = function(gauche, droite) {
        const list = document.getElementById('rel-list');
        const row = document.createElement('div');
        row.className = 'dyn-row';
        row.innerHTML = '<input type="text" class="form-input" placeholder="Gauche" value="' + (gauche || '') + '">' +
            '<span class="dyn-arrow">‚Üî</span>' +
            '<input type="text" class="form-input" placeholder="Droite" value="' + (droite || '') + '">' +
            '<div class="dyn-row-actions"><button class="btn-del" onclick="this.closest(\'.dyn-row\').remove()">&times;</button></div>';
        list.appendChild(row);
    };

    // --- ORDRE ---
    window.addOrdreItem = function(val) {
        const list = document.getElementById('ord-list');
        const idx = list.children.length + 1;
        const row = document.createElement('div');
        row.className = 'dyn-row';
        row.innerHTML = '<span style="color:#64748b; font-weight:700; min-width:24px;">' + idx + '.</span>' +
            '<input type="text" class="form-input" placeholder="Element" value="' + (val || '') + '">' +
            '<div class="dyn-row-actions">' +
            '<button onclick="moveRow(this,-1)" title="Monter">‚ñ≤</button>' +
            '<button onclick="moveRow(this,1)" title="Descendre">‚ñº</button>' +
            '<button class="btn-del" onclick="removeOrdreItem(this)">&times;</button></div>';
        list.appendChild(row);
    };
    window.removeOrdreItem = function(btn) {
        btn.closest('.dyn-row').remove();
        renumberOrdre();
    };
    window.moveRow = function(btn, dir) {
        const row = btn.closest('.dyn-row');
        const list = row.parentElement;
        const rows = [...list.children];
        const idx = rows.indexOf(row);
        const newIdx = idx + dir;
        if (newIdx < 0 || newIdx >= rows.length) return;
        if (dir === -1) list.insertBefore(row, rows[newIdx]);
        else list.insertBefore(rows[newIdx], row);
        renumberOrdre();
    };
    function renumberOrdre() {
        const list = document.getElementById('ord-list');
        [...list.children].forEach((row, i) => {
            row.querySelector('span').textContent = (i + 1) + '.';
        });
    }

    // --- INTRUS ---
    window.addIntrusSerie = function(items, intrusIdx, explication) {
        const container = document.getElementById('int-series');
        const num = container.children.length + 1;
        const card = document.createElement('div');
        card.className = 'serie-card';
        const itemsArr = items || ['', '', '', ''];
        let html = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><h4>Serie ' + num + '</h4>' +
            '<button style="background:none; border:none; color:#64748b; cursor:pointer; font-size:1rem;" onclick="this.closest(\'.serie-card\').remove()">&times;</button></div>';
        html += '<div class="serie-items">';
        itemsArr.forEach((it, i) => {
            html += '<input type="text" class="form-input serie-item-input" placeholder="Element ' + (i + 1) + '" value="' + (it || '') + '">';
        });
        html += '</div>';
        html += '<div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.7rem;">Index de l\'intrus (0-based)</label>' +
            '<input type="number" class="form-input" min="0" max="' + (itemsArr.length - 1) + '" value="' + (intrusIdx != null ? intrusIdx : 0) + '" style="width:80px;"></div>';
        html += '<div class="form-group"><label style="font-size:0.7rem;">Explication</label>' +
            '<input type="text" class="form-input" placeholder="Pourquoi c\'est l\'intrus ?" value="' + (explication || '') + '"></div>';
        card.innerHTML = html;
        container.appendChild(card);
    };

    // --- PENDU ---
    window.addPenduMot = function(mot, indice, explication) {
        const list = document.getElementById('pen-list');
        const row = document.createElement('div');
        row.className = 'dyn-row';
        row.style.flexWrap = 'wrap';
        row.innerHTML = '<input type="text" class="form-input" placeholder="MOT (majuscules)" value="' + (mot || '') + '" style="text-transform:uppercase; flex:1; min-width:100px;">' +
            '<input type="text" class="form-input" placeholder="Indice / Definition" value="' + (indice || '') + '" style="flex:2; min-width:150px;">' +
            '<div class="dyn-row-actions"><button class="btn-del" onclick="this.closest(\'.dyn-row\').remove()">&times;</button></div>' +
            '<input type="text" class="form-input pen-explication" placeholder="üí° Explication (optionnel)" value="' + (explication || '') + '" style="flex:1 0 100%; margin-top:4px; font-size:0.8rem; color:#a78bfa;">';
        list.appendChild(row);
    };

    // --- MOTS CROISES ---
    window.addMotsCroisesMot = function(mot, definition, explication) {
        const list = document.getElementById('mc-list');
        const row = document.createElement('div');
        row.className = 'dyn-row';
        row.style.flexWrap = 'wrap';
        row.innerHTML = '<input type="text" class="form-input" placeholder="MOT (majuscules)" value="' + (mot || '') + '" style="text-transform:uppercase; flex:1; min-width:100px;">' +
            '<input type="text" class="form-input" placeholder="Definition" value="' + (definition || '') + '" style="flex:2; min-width:150px;">' +
            '<div class="dyn-row-actions"><button class="btn-del" onclick="this.closest(\'.dyn-row\').remove()">&times;</button></div>' +
            '<input type="text" class="form-input mc-explication" placeholder="üí° Explication (optionnel)" value="' + (explication || '') + '" style="flex:1 0 100%; margin-top:4px; font-size:0.8rem; color:#a78bfa;">';
        list.appendChild(row);
    };

    // --- SWIPE V/F ---
    window.addSwipeAffirmation = function(texte, reponse, explication) {
        const list = document.getElementById('svf-list');
        const row = document.createElement('div');
        row.className = 'dyn-row';
        row.style.flexWrap = 'wrap';
        row.innerHTML = '<input type="text" class="form-input" placeholder="Affirmation" value="' + (texte || '') + '" style="flex:2; min-width:200px;">' +
            '<select class="form-select" style="width:auto; min-width:80px;"><option value="true"' + (reponse === true ? ' selected' : '') + '>Vrai</option><option value="false"' + (reponse === false ? ' selected' : '') + '>Faux</option></select>' +
            '<input type="text" class="form-input" placeholder="Explication" value="' + (explication || '') + '" style="flex:2; min-width:200px;">' +
            '<div class="dyn-row-actions"><button class="btn-del" onclick="this.closest(\'.dyn-row\').remove()">&times;</button></div>';
        list.appendChild(row);
    };

    // --- QCM IMAGE ---
    window.addQcmImageQuestion = function(data) {
        const container = document.getElementById('qimg-questions');
        const num = container.children.length + 1;
        const d = data || {};
        // Detect source type from existing data
        const isGithub = d.image && !d.image.startsWith('http');
        const githubFilename = isGithub ? d.image.replace('images/exercices/', '') : '';
        const card = document.createElement('div');
        card.className = 'serie-card';
        card.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><h4>Question ' + num + '</h4>' +
            '<button style="background:none; border:none; color:#64748b; cursor:pointer; font-size:1rem;" onclick="this.closest(\'.serie-card\').remove()">&times;</button></div>' +
            '<div style="display:flex; gap:8px; margin-bottom:6px; align-items:center; flex-wrap:wrap;">' +
            '<select class="form-select qimg-source" style="width:160px;" onchange="toggleQimgSource(this)">' +
            '<option value="url"' + (isGithub ? '' : ' selected') + '>üîó URL externe</option>' +
            '<option value="github"' + (isGithub ? ' selected' : '') + '>üìÅ Dossier GitHub</option>' +
            '</select>' +
            '<div class="qimg-url-wrap" style="flex:1; min-width:180px;' + (isGithub ? 'display:none;' : '') + '"><input type="text" class="form-input qimg-url" placeholder="https://exemple.com/image.jpg" value="' + (isGithub ? '' : (d.image || '')) + '"></div>' +
            '<div class="qimg-github-wrap" style="flex:1; min-width:180px;' + (isGithub ? '' : 'display:none;') + '"><input type="text" class="form-input qimg-github" placeholder="nom_image.jpg (dans images/exercices/)" value="' + githubFilename + '"></div>' +
            '</div>' +
            '<div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.7rem;">Question</label><input type="text" class="form-input qimg-question" value="' + (d.question || '') + '"></div>' +
            '<div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.7rem;">Choix (1 par ligne)</label><textarea class="form-textarea qimg-choix" rows="4" placeholder="Choix A\nChoix B\nChoix C\nChoix D">' + ((d.choix || []).join('\n')) + '</textarea></div>' +
            '<div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.7rem;">Index correct (0-based)</label><input type="number" class="form-input qimg-correct" min="0" value="' + (d.correct || 0) + '" style="width:80px;"></div>' +
            '<div class="form-group"><label style="font-size:0.7rem;">Explication</label><input type="text" class="form-input qimg-explication" value="' + (d.explication || '') + '"></div>';
        container.appendChild(card);
    };
    window.toggleQimgSource = function(sel) {
        const card = sel.closest('.serie-card');
        const urlWrap = card.querySelector('.qimg-url-wrap');
        const ghWrap = card.querySelector('.qimg-github-wrap');
        if (sel.value === 'url') {
            urlWrap.style.display = ''; ghWrap.style.display = 'none';
        } else {
            urlWrap.style.display = 'none'; ghWrap.style.display = '';
        }
    };

    // --- TABLEAU ---
    window.addTableauLigne = function(cellules) {
        const list = document.getElementById('tab-list');
        const row = document.createElement('div');
        row.className = 'dyn-row';
        row.innerHTML = '<input type="text" class="form-input" placeholder="Cellule1, Cellule2, {{trou}}, ..." value="' + (cellules || '') + '" style="flex:1;">' +
            '<div class="dyn-row-actions"><button class="btn-del" onclick="this.closest(\'.dyn-row\').remove()">&times;</button></div>';
        list.appendChild(row);
    };

    // --- ETUDE DE CAS ---
    window.addEtudeCasQuestion = function(data) {
        const container = document.getElementById('ec-questions');
        const num = container.children.length + 1;
        const d = data || {};
        const card = document.createElement('div');
        card.className = 'serie-card';
        card.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><h4>Question ' + num + '</h4>' +
            '<button style="background:none; border:none; color:#64748b; cursor:pointer; font-size:1rem;" onclick="this.closest(\'.serie-card\').remove()">&times;</button></div>' +
            '<div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.7rem;">Question</label><input type="text" class="form-input ec-question" value="' + (d.question || '') + '"></div>' +
            '<div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.7rem;">Type</label>' +
            '<select class="form-select ec-type" style="width:auto;" onchange="toggleEcType(this)"><option value="qcm"' + (d.type === 'texte' ? '' : ' selected') + '>QCM</option><option value="texte"' + (d.type === 'texte' ? ' selected' : '') + '>Texte libre</option></select></div>' +
            '<div class="ec-qcm-area" style="' + (d.type === 'texte' ? 'display:none;' : '') + '">' +
            '<div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.7rem;">Choix (1 par ligne)</label><textarea class="form-textarea ec-choix" rows="3">' + ((d.choix || []).join('\n')) + '</textarea></div>' +
            '<div class="form-group" style="margin-bottom:6px;"><label style="font-size:0.7rem;">Index correct (0-based)</label><input type="number" class="form-input ec-correct" min="0" value="' + (d.correct || 0) + '" style="width:80px;"></div></div>' +
            '<div class="ec-texte-area" style="' + (d.type === 'texte' ? '' : 'display:none;') + '">' +
            '<div class="form-group"><label style="font-size:0.7rem;">Reponse attendue</label><input type="text" class="form-input ec-reponse" value="' + (d.reponse || '') + '"></div></div>' +
            '<div class="form-group" style="margin-top:6px;"><label style="font-size:0.7rem; color:#a78bfa;">üí° Explication (optionnel)</label><input type="text" class="form-input ec-explication" placeholder="Pourquoi cette reponse est correcte..." value="' + (d.explication || '') + '"></div>';
        container.appendChild(card);
    };
    window.toggleEcType = function(sel) {
        const card = sel.closest('.serie-card');
        card.querySelector('.ec-qcm-area').style.display = sel.value === 'qcm' ? '' : 'none';
        card.querySelector('.ec-texte-area').style.display = sel.value === 'texte' ? '' : 'none';
    };

    // ========== GET CONTENU FROM FORM ==========
    function getContenuFromForm() {
        const type = document.getElementById('exo-type').value;
        if (type === 'texte_trous') {
            const ttObj = { consigne: document.getElementById('tt-consigne').value, texte: document.getElementById('tt-texte').value, indice: document.getElementById('tt-indice').checked };
            const ttExpl = document.getElementById('tt-explication').value.trim();
            if (ttExpl) ttObj.explication = ttExpl;
            return ttObj;
        } else if (type === 'relier') {
            const paires = [];
            document.querySelectorAll('#rel-list .dyn-row').forEach(r => {
                const inputs = r.querySelectorAll('input');
                if (inputs[0].value.trim() || inputs[1].value.trim()) paires.push({ gauche: inputs[0].value.trim(), droite: inputs[1].value.trim() });
            });
            const relObj = { consigne: document.getElementById('rel-consigne').value, paires };
            const relExpl = document.getElementById('rel-explication').value.trim();
            if (relExpl) relObj.explication = relExpl;
            return relObj;
        } else if (type === 'ordre') {
            const items = [];
            document.querySelectorAll('#ord-list .dyn-row input').forEach(inp => { if (inp.value.trim()) items.push(inp.value.trim()); });
            const ordObj = { consigne: document.getElementById('ord-consigne').value, items };
            const ordExpl = document.getElementById('ord-explication').value.trim();
            if (ordExpl) ordObj.explication = ordExpl;
            return ordObj;
        } else if (type === 'intrus') {
            const series = [];
            document.querySelectorAll('#int-series .serie-card').forEach(card => {
                const items = [...card.querySelectorAll('.serie-item-input')].map(i => i.value.trim());
                const inputs = card.querySelectorAll('.form-input');
                series.push({ items, intrus: parseInt(inputs[inputs.length - 2].value) || 0, explication: inputs[inputs.length - 1].value });
            });
            return { consigne: document.getElementById('int-consigne').value, series };
        } else if (type === 'pendu') {
            const mots = [];
            document.querySelectorAll('#pen-list .dyn-row').forEach(r => {
                const inputs = r.querySelectorAll('input');
                if (inputs[0].value.trim()) {
                    const penMot = { mot: inputs[0].value.trim().toUpperCase(), indice: inputs[1].value.trim() };
                    const penExpl = r.querySelector('.pen-explication');
                    if (penExpl && penExpl.value.trim()) penMot.explication = penExpl.value.trim();
                    mots.push(penMot);
                }
            });
            return { consigne: document.getElementById('pen-consigne').value, mots };
        } else if (type === 'mots_croises') {
            const mots = [];
            document.querySelectorAll('#mc-list .dyn-row').forEach(r => {
                const inputs = r.querySelectorAll('input');
                if (inputs[0].value.trim()) {
                    const mcMot = { mot: inputs[0].value.trim().toUpperCase(), definition: inputs[1].value.trim() };
                    const mcExpl = r.querySelector('.mc-explication');
                    if (mcExpl && mcExpl.value.trim()) mcMot.explication = mcExpl.value.trim();
                    mots.push(mcMot);
                }
            });
            return { consigne: document.getElementById('mc-consigne').value, mots };
        } else if (type === 'swipe_vf') {
            const affirmations = [];
            document.querySelectorAll('#svf-list .dyn-row').forEach(r => {
                const inputs = r.querySelectorAll('input');
                const sel = r.querySelector('select');
                if (inputs[0].value.trim()) affirmations.push({ texte: inputs[0].value.trim(), reponse: sel.value === 'true', explication: inputs[1].value.trim() });
            });
            return { consigne: document.getElementById('svf-consigne').value, affirmations };
        } else if (type === 'qcm_image') {
            const questions = [];
            document.querySelectorAll('#qimg-questions .serie-card').forEach(card => {
                const source = card.querySelector('.qimg-source').value;
                let image = '';
                if (source === 'url') {
                    image = card.querySelector('.qimg-url').value.trim();
                } else {
                    const filename = card.querySelector('.qimg-github').value.trim();
                    image = filename ? 'images/exercices/' + filename : '';
                }
                questions.push({
                    image,
                    question: card.querySelector('.qimg-question').value.trim(),
                    choix: card.querySelector('.qimg-choix').value.split('\n').map(s => s.trim()).filter(Boolean),
                    correct: parseInt(card.querySelector('.qimg-correct').value) || 0,
                    explication: card.querySelector('.qimg-explication').value.trim()
                });
            });
            return { consigne: document.getElementById('qimg-consigne').value, questions };
        } else if (type === 'tableau') {
            const colonnes = document.getElementById('tab-colonnes').value.split(',').map(s => s.trim()).filter(Boolean);
            const lignes = [];
            document.querySelectorAll('#tab-list .dyn-row input').forEach(inp => {
                const cellules = inp.value.split(',').map(s => s.trim());
                if (cellules.length > 0) lignes.push({ cellules });
            });
            const tabObj = { consigne: document.getElementById('tab-consigne').value, colonnes, lignes };
            const tabExpl = document.getElementById('tab-explication').value.trim();
            if (tabExpl) tabObj.explication = tabExpl;
            return tabObj;
        } else if (type === 'etude_cas') {
            const questions = [];
            document.querySelectorAll('#ec-questions .serie-card').forEach(card => {
                const t = card.querySelector('.ec-type').value;
                const q = { question: card.querySelector('.ec-question').value.trim(), type: t };
                if (t === 'qcm') {
                    q.choix = card.querySelector('.ec-choix').value.split('\n').map(s => s.trim()).filter(Boolean);
                    q.correct = parseInt(card.querySelector('.ec-correct').value) || 0;
                } else {
                    q.reponse = card.querySelector('.ec-reponse').value.trim();
                }
                const ecExpl = card.querySelector('.ec-explication').value.trim();
                if (ecExpl) q.explication = ecExpl;
                questions.push(q);
            });
            return { consigne: document.getElementById('ec-consigne').value, scenario: document.getElementById('ec-scenario').value, questions };
        } else if (type === 'pad') {
            const padObj = {
                titre: document.getElementById('pad-titre').value.trim(),
                situation: document.getElementById('pad-situation').value.trim(),
                danger: document.getElementById('pad-danger').value.trim(),
                distracteurs_danger: document.getElementById('pad-dist-danger').value.split('|').map(s=>s.trim()).filter(Boolean),
                situation_dangereuse: document.getElementById('pad-sitdang').value.trim(),
                distracteurs_situation_dangereuse: document.getElementById('pad-dist-sitdang').value.split('|').map(s=>s.trim()).filter(Boolean),
                evenement_declencheur: document.getElementById('pad-event').value.trim(),
                distracteurs_evenement_declencheur: document.getElementById('pad-dist-event').value.split('|').map(s=>s.trim()).filter(Boolean),
                dommage: document.getElementById('pad-dommage').value.trim(),
                distracteurs_dommage: document.getElementById('pad-dist-dommage').value.split('|').map(s=>s.trim()).filter(Boolean)
            };
            const padExpl = document.getElementById('pad-explication').value.trim();
            if (padExpl) padObj.explication = padExpl;
            return padObj;
        } else if (type === 'prevention') {
            const prevObj = {
                titre: document.getElementById('prev-titre').value.trim(),
                situation: document.getElementById('prev-situation').value.trim(),
                danger: document.getElementById('prev-danger').value.trim(),
                niveaux: [
                    {
                        niveau: 'supprimer',
                        label: 'Supprimer le risque',
                        bonne_reponse: document.getElementById('prev-supprimer').value.trim(),
                        distracteurs: document.getElementById('prev-dist-supprimer').value.split('|').map(s=>s.trim()).filter(Boolean)
                    },
                    {
                        niveau: 'reduire',
                        label: 'Reduire le risque a la source',
                        bonne_reponse: document.getElementById('prev-reduire').value.trim(),
                        distracteurs: document.getElementById('prev-dist-reduire').value.split('|').map(s=>s.trim()).filter(Boolean)
                    },
                    {
                        niveau: 'collective',
                        label: 'Protection collective',
                        bonne_reponse: document.getElementById('prev-collective').value.trim(),
                        distracteurs: document.getElementById('prev-dist-collective').value.split('|').map(s=>s.trim()).filter(Boolean)
                    },
                    {
                        niveau: 'individuelle',
                        label: 'Protection individuelle (EPI)',
                        bonne_reponse: document.getElementById('prev-individuelle').value.trim(),
                        distracteurs: document.getElementById('prev-dist-individuelle').value.split('|').map(s=>s.trim()).filter(Boolean)
                    },
                    {
                        niveau: 'formation',
                        label: 'Information et formation',
                        bonne_reponse: document.getElementById('prev-formation').value.trim(),
                        distracteurs: document.getElementById('prev-dist-formation').value.split('|').map(s=>s.trim()).filter(Boolean)
                    }
                ]
            };
            const prevExpl = document.getElementById('prev-explication').value.trim();
            if (prevExpl) prevObj.explication = prevExpl;
            return prevObj;
        } else if (type === 'estimation_risque') {
            return {
                titre: document.getElementById('est-titre').value.trim(),
                situation: document.getElementById('est-situation').value.trim(),
                danger: document.getElementById('est-danger').value.trim(),
                dommage: document.getElementById('est-dommage').value.trim(),
                gravite: parseInt(document.getElementById('est-gravite').value) || 0,
                exposition: document.getElementById('est-exposition').value,
                declencheur: document.getElementById('est-declencheur').value,
                priorite: document.getElementById('est-priorite').value
            };
        } else if (type === 'duerp_ligne') {
            const danger = document.getElementById('duerp-l-danger').value.trim();
            const dangerDist = document.getElementById('duerp-l-dist-danger').value.split('|').map(s=>s.trim()).filter(Boolean);
            const dommage = document.getElementById('duerp-l-dommage').value.trim();
            const dommageDist = document.getElementById('duerp-l-dist-dommage').value.split('|').map(s=>s.trim()).filter(Boolean);
            const mesure = document.getElementById('duerp-l-mesure').value.trim();
            const mesureDist = document.getElementById('duerp-l-dist-mesure').value.split('|').map(s=>s.trim()).filter(Boolean);
            const choix = { danger: [danger, ...dangerDist], dommage: [dommage, ...dommageDist] };
            if (mesure) choix.mesure_principale = [mesure, ...mesureDist];
            const attendus = {
                danger, dommage,
                gravite: parseInt(document.getElementById('duerp-l-gravite').value) || 0,
                exposition: document.getElementById('duerp-l-exposition').value,
                declencheur: document.getElementById('duerp-l-declencheur').value
            };
            if (mesure) attendus.mesure_principale = mesure;
            return {
                titre: document.getElementById('duerp-l-titre').value.trim(),
                unite_travail: document.getElementById('duerp-l-unite').value.trim(),
                situation: document.getElementById('duerp-l-situation').value.trim(),
                choix, attendus
            };
        } else if (type === 'duerp_mini') {
            const lignes = [];
            for (let n = 1; n <= 4; n++) {
                const pre = 'duerp-m-L' + n;
                const danger = document.getElementById(pre + '-danger').value.trim();
                const dangerDist = document.getElementById(pre + '-dist-danger').value.split('|').map(s=>s.trim()).filter(Boolean);
                const dommage = document.getElementById(pre + '-dommage').value.trim();
                const dommageDist = document.getElementById(pre + '-dist-dommage').value.split('|').map(s=>s.trim()).filter(Boolean);
                lignes.push({
                    id: 'L' + n,
                    unite_travail: document.getElementById(pre + '-unite').value.trim(),
                    situation: document.getElementById(pre + '-situation').value.trim(),
                    choix: { danger: [danger, ...dangerDist], dommage: [dommage, ...dommageDist] },
                    attendus: {
                        danger, dommage,
                        gravite: parseInt(document.getElementById(pre + '-gravite').value) || 0,
                        exposition: document.getElementById(pre + '-exposition').value,
                        declencheur: document.getElementById(pre + '-declencheur').value
                    }
                });
            }
            return {
                titre: document.getElementById('duerp-m-titre').value.trim(),
                entreprise: document.getElementById('duerp-m-entreprise').value.trim(),
                lignes,
                mission_finale: {
                    consigne: 'Selectionnez les ' + (document.getElementById('duerp-m-nb-prio').value || 2) + ' risques prioritaires a traiter en premier',
                    nb_prioritaires: parseInt(document.getElementById('duerp-m-nb-prio').value) || 2
                }
            };
        } else if (type === 'qcm_classique') {
            const isMultiple = document.getElementById('qcmc-multiple').checked;
            const repLines = document.getElementById('qcmc-reponse').value.split('\n').map(s=>s.trim()).filter(Boolean);
            const distracteurs = document.getElementById('qcmc-distracteurs').value.split('|').map(s=>s.trim()).filter(Boolean);
            const allTextes = [...repLines, ...distracteurs];
            const choix = allTextes.map((t, i) => ({ id: 'c' + (i+1), texte: t }));
            const repIds = choix.filter(c => repLines.includes(c.texte)).map(c => c.id);
            return {
                titre: document.getElementById('qcmc-titre').value.trim(),
                question: document.getElementById('qcmc-question').value.trim(),
                choix,
                reponse: isMultiple ? repIds : repIds[0],
                multiple: isMultiple,
                explication: document.getElementById('qcmc-explication').value.trim()
            };
        } else if (type === 'quiz_chrono') {
            const container = document.getElementById('chrono-questions');
            const blocs = container.querySelectorAll('.chrono-q-bloc');
            const questions = [];
            blocs.forEach((bloc, qi) => {
                const q = bloc.querySelector('.chrono-q-text').value.trim();
                const rep = bloc.querySelector('.chrono-q-rep').value.trim();
                const dist = bloc.querySelector('.chrono-q-dist').value.split('|').map(s=>s.trim()).filter(Boolean);
                const expl = bloc.querySelector('.chrono-q-expl').value.trim();
                const allT = [rep, ...dist];
                const choix = allT.map((t, i) => ({ id: 'c' + (i+1), texte: t }));
                questions.push({ question: q, choix, reponse: 'c1', explication: expl });
            });
            return {
                titre: document.getElementById('chrono-titre').value.trim(),
                temps_par_question: parseInt(document.getElementById('chrono-temps').value) || 15,
                questions
            };
        } else if (type === 'categoriser') {
            const categories = document.getElementById('cat-categories').value.split('|').map(s=>s.trim()).filter(Boolean);
            const container = document.getElementById('cat-items-list');
            const rows = container.querySelectorAll('.cat-item-row');
            const items = [];
            rows.forEach((row, i) => {
                items.push({
                    id: 'i' + (i+1),
                    label: row.querySelector('.cat-item-label').value.trim(),
                    categorie: row.querySelector('.cat-item-cat').value
                });
            });
            return {
                titre: document.getElementById('cat-titre').value.trim(),
                consigne: document.getElementById('cat-consigne').value.trim(),
                categories,
                items
            };
        } else if (type === 'memory') {
            const container = document.getElementById('mem-list');
            const rows = container.querySelectorAll('.mem-pair-row');
            const cartes = [];
            rows.forEach((row, i) => {
                cartes.push({
                    id: 'p' + (i+1),
                    a: row.querySelector('.mem-a').value.trim(),
                    b: row.querySelector('.mem-b').value.trim()
                });
            });
            return {
                titre: document.getElementById('mem-titre').value.trim(),
                cartes
            };
        } else if (type === 'scenario') {
            const container = document.getElementById('scen-etapes');
            const blocs = container.querySelectorAll('.scen-etape-bloc');
            const etapes = [];
            blocs.forEach(bloc => {
                const id = bloc.querySelector('.scen-etape-id').value.trim();
                const texte = bloc.querySelector('.scen-etape-texte').value.trim();
                const choixEls = bloc.querySelectorAll('.scen-choix-row');
                const choix = [];
                choixEls.forEach(cr => {
                    choix.push({
                        label: cr.querySelector('.scen-choix-label').value.trim(),
                        suite: cr.querySelector('.scen-choix-suite').value.trim(),
                        correct: cr.querySelector('.scen-choix-correct').checked,
                        feedback: cr.querySelector('.scen-choix-feedback').value.trim()
                    });
                });
                etapes.push({ id, texte, choix });
            });
            return {
                titre: document.getElementById('scen-titre').value.trim(),
                etapes
            };
        } else if (type === 'pictogramme') {
            const categories = [];
            document.querySelectorAll('.picto-cat-cb:checked').forEach(cb => categories.push(cb.value));
            const pictoObj = {
                consigne: document.getElementById('picto-consigne').value,
                mode: document.getElementById('picto-mode').value,
                nb: parseInt(document.getElementById('picto-nb').value) || 8,
                categories: categories
            };
            const pictoExpl = document.getElementById('picto-explication').value.trim();
            if (pictoExpl) pictoObj.explication = pictoExpl;
            // Escape game : conserver les epreuves importees
            if (pictoObj.mode === 'escape_game' && window._pictoEpreuves && window._pictoEpreuves.length > 0) {
                pictoObj.epreuves = window._pictoEpreuves;
            }
            return pictoObj;
        } else if (type === 'analyse_copie') {
            if (window._analyseCopieData) return window._analyseCopieData;
            return {};
        }
        return {};
    }

    // ========== ANALYSE COPIE FUNCTIONS ==========
    window._analyseCopieData = null;

    window.acImportJson = function() {
        var input = document.getElementById('ac-json-input');
        var status = document.getElementById('ac-import-status');
        try {
            var data = JSON.parse(input.value);
            if (!data.items || !Array.isArray(data.items) || data.items.length === 0) {
                throw new Error('Le JSON doit contenir un tableau "items" non vide');
            }
            // Validate each item
            data.items.forEach(function(item, i) {
                if (!item.question_examen) throw new Error('Item ' + (i+1) + ' : question_examen manquant');
                if (!item.reponse_eleve) throw new Error('Item ' + (i+1) + ' : reponse_eleve manquant');
                if (!item.attendus) throw new Error('Item ' + (i+1) + ' : attendus manquant');
                if (!item.attendus.verbe) throw new Error('Item ' + (i+1) + ' : attendus.verbe manquant');
                if (!item.attendus.competence) throw new Error('Item ' + (i+1) + ' : attendus.competence manquant');
                if (!item.attendus.validee) throw new Error('Item ' + (i+1) + ' : attendus.validee manquant');
            });
            window._analyseCopieData = data;
            status.style.display = '';
            status.style.color = '#16a34a';
            var nbWithExpl = data.items.filter(function(it) { return !!it.explications; }).length;
            var explInfo = nbWithExpl > 0 ? ' (dont ' + nbWithExpl + ' avec explications)' : '';
            status.textContent = '‚úÖ Import reussi : ' + data.items.length + ' item(s) detectes' + explInfo;
            showToast('‚úÖ ' + data.items.length + ' items importes avec succes' + explInfo);
        } catch (e) {
            status.style.display = '';
            status.style.color = '#ef4444';
            status.textContent = '‚ùå Erreur : ' + e.message;
        }
    };

    window.acCopyPrompt = function() {
        var prompt = PROMPTS.analyse_copie || 'Prompt non disponible';
        navigator.clipboard.writeText(prompt).then(function() {
            showToast('üìã Prompt copie dans le presse-papier !');
        });
    };

    // ========== PICTO MODE CHANGE ==========
    window.onPictoModeChange = function() {};

    // ========== ESTIMATION PREVIEW ==========
    function calcProbaEdit(expo, decl) {
        if (expo === 'rare_courte' && decl === 'faible') return 1;
        if (expo === 'rare_courte' && decl === 'eleve') return 2;
        if (expo === 'frequente_longue' && decl === 'faible') return 3;
        if (expo === 'frequente_longue' && decl === 'eleve') return 4;
        return 0;
    }
    const PROBA_LABELS = { 1: 'Tres improbable', 2: 'Improbable', 3: 'Probable', 4: 'Tres probable' };
    window.updateEstPreview = function() {
        const expo = document.getElementById('est-exposition').value;
        const decl = document.getElementById('est-declencheur').value;
        const grav = parseInt(document.getElementById('est-gravite').value) || 0;
        const proba = calcProbaEdit(expo, decl);
        const probaDiv = document.getElementById('est-proba-result');
        const probaVal = document.getElementById('est-proba-value');
        if (proba > 0) {
            probaDiv.style.display = '';
            probaVal.textContent = proba + ' ‚Äî ' + PROBA_LABELS[proba];
        } else {
            probaDiv.style.display = 'none';
        }
        // Update matrix preview
        const matrixDiv = document.getElementById('est-matrix-preview');
        document.querySelectorAll('.est-prev-cell').forEach(cell => {
            const g = parseInt(cell.dataset.g);
            const p = parseInt(cell.dataset.p);
            const isPrio = (g + p) >= 5;
            cell.style.background = isPrio ? 'rgba(239,68,68,0.3)' : 'rgba(34,197,94,0.2)';
            cell.style.border = '1px solid ' + (isPrio ? '#ef4444' : '#22c55e');
            cell.textContent = '';
            if (grav === g && proba === p) {
                cell.textContent = '‚óè';
                cell.style.background = isPrio ? '#ef4444' : '#22c55e';
                cell.style.color = '#fff';
                cell.style.fontWeight = '900';
            }
        });
        if (grav > 0 && proba > 0) { matrixDiv.style.display = ''; } else { matrixDiv.style.display = 'none'; }
    };

    // ========== DUERP LIGNE PREVIEW ==========
    window.updateDuerpLPreview = function() {
        const expo = document.getElementById('duerp-l-exposition').value;
        const decl = document.getElementById('duerp-l-declencheur').value;
        const grav = parseInt(document.getElementById('duerp-l-gravite').value) || 0;
        const proba = calcProbaEdit(expo, decl);
        const probaDiv = document.getElementById('duerp-l-proba-result');
        const probaVal = document.getElementById('duerp-l-proba-value');
        const prioVal = document.getElementById('duerp-l-prio-value');
        if (proba > 0) {
            probaDiv.style.display = '';
            probaVal.textContent = proba + ' ‚Äî ' + PROBA_LABELS[proba];
            if (grav > 0) {
                const prio = (grav + proba) >= 5 ? 'PRIORITAIRE' : 'NON PRIORITAIRE';
                const color = (grav + proba) >= 5 ? '#ef4444' : '#22c55e';
                prioVal.textContent = '‚Üí ' + prio;
                prioVal.style.color = color;
            } else { prioVal.textContent = ''; }
        } else {
            probaDiv.style.display = 'none';
        }
        // Update matrix preview
        const matrixDiv = document.getElementById('duerp-l-matrix-preview');
        document.querySelectorAll('.duerp-l-prev-cell').forEach(cell => {
            const g = parseInt(cell.dataset.g);
            const p = parseInt(cell.dataset.p);
            const isPrio = (g + p) >= 5;
            cell.style.background = isPrio ? 'rgba(239,68,68,0.3)' : 'rgba(34,197,94,0.2)';
            cell.style.border = '1px solid ' + (isPrio ? '#ef4444' : '#22c55e');
            cell.textContent = '';
            if (grav === g && proba === p) {
                cell.textContent = '‚óè';
                cell.style.background = isPrio ? '#ef4444' : '#22c55e';
                cell.style.color = '#fff';
                cell.style.fontWeight = '900';
            }
        });
        if (grav > 0 && proba > 0) { matrixDiv.style.display = ''; } else { matrixDiv.style.display = 'none'; }
    };

    // ========== DYNAMIC HELPERS : QUIZ CHRONO ==========
    window.addChronoQuestion = function(data) {
        const container = document.getElementById('chrono-questions');
        const idx = container.querySelectorAll('.chrono-q-bloc').length + 1;
        const div = document.createElement('div');
        div.className = 'chrono-q-bloc';
        div.style.cssText = 'background:#0f172a; border:1px solid #334155; border-radius:10px; padding:12px; margin-bottom:10px; position:relative;';
        div.innerHTML = '<button type="button" onclick="this.parentElement.remove()" style="position:absolute;top:6px;right:8px;background:none;border:none;color:#ef4444;font-size:1.2rem;cursor:pointer;">&times;</button>' +
            '<label style="font-size:0.75rem; color:#38bdf8; font-weight:700;">Question ' + idx + '</label>' +
            '<div class="form-group" style="margin:6px 0;"><textarea class="form-textarea chrono-q-text" rows="2" placeholder="Question...">' + (data && data.question || '') + '</textarea></div>' +
            '<div class="form-group" style="margin:6px 0;"><label style="font-size:0.65rem;">Bonne reponse</label><input type="text" class="form-input chrono-q-rep" value="' + (data && data.reponse || '') + '"></div>' +
            '<div class="form-group" style="margin:6px 0;"><label style="font-size:0.65rem;">Distracteurs (|)</label><input type="text" class="form-input chrono-q-dist" value="' + (data && data.distracteurs || '') + '"></div>' +
            '<div class="form-group" style="margin:6px 0;"><label style="font-size:0.65rem;">Explication (optionnel)</label><input type="text" class="form-input chrono-q-expl" value="' + (data && data.explication || '') + '"></div>';
        container.appendChild(div);
    };

    // ========== DYNAMIC HELPERS : CATEGORISER ==========
    window.addCatItem = function(label, categorie) {
        const container = document.getElementById('cat-items-list');
        const cats = document.getElementById('cat-categories').value.split('|').map(s=>s.trim()).filter(Boolean);
        const div = document.createElement('div');
        div.className = 'cat-item-row';
        div.style.cssText = 'display:flex; gap:8px; align-items:center; margin-bottom:6px;';
        let opts = cats.map(c => '<option value="' + c + '"' + (c === categorie ? ' selected' : '') + '>' + c + '</option>').join('');
        div.innerHTML = '<input type="text" class="form-input cat-item-label" style="flex:2;" placeholder="Label item" value="' + (label || '') + '">' +
            '<select class="form-select cat-item-cat" style="flex:1;">' + opts + '</select>' +
            '<button type="button" onclick="this.parentElement.remove()" style="background:none;border:none;color:#ef4444;font-size:1.2rem;cursor:pointer;">&times;</button>';
        container.appendChild(div);
    };
    window.updateCatSelects = function() {
        const cats = document.getElementById('cat-categories').value.split('|').map(s=>s.trim()).filter(Boolean);
        document.querySelectorAll('.cat-item-cat').forEach(sel => {
            const cur = sel.value;
            sel.innerHTML = cats.map(c => '<option value="' + c + '"' + (c === cur ? ' selected' : '') + '>' + c + '</option>').join('');
        });
    };

    // ========== DYNAMIC HELPERS : MEMORY ==========
    window.addMemoryPair = function(a, b) {
        const container = document.getElementById('mem-list');
        const idx = container.querySelectorAll('.mem-pair-row').length + 1;
        const div = document.createElement('div');
        div.className = 'mem-pair-row';
        div.style.cssText = 'display:flex; gap:8px; align-items:center; margin-bottom:6px;';
        div.innerHTML = '<span style="color:#a855f7; font-weight:700; min-width:20px;">' + idx + '</span>' +
            '<input type="text" class="form-input mem-a" style="flex:1;" placeholder="Face A (terme)" value="' + (a || '') + '">' +
            '<input type="text" class="form-input mem-b" style="flex:1;" placeholder="Face B (definition)" value="' + (b || '') + '">' +
            '<button type="button" onclick="this.parentElement.remove()" style="background:none;border:none;color:#ef4444;font-size:1.2rem;cursor:pointer;">&times;</button>';
        container.appendChild(div);
    };

    // ========== DYNAMIC HELPERS : SCENARIO ==========
    window.addScenEtape = function(data) {
        const container = document.getElementById('scen-etapes');
        const idx = container.querySelectorAll('.scen-etape-bloc').length;
        const defaultId = idx === 0 ? 'debut' : 'etape' + (idx + 1);
        const div = document.createElement('div');
        div.className = 'scen-etape-bloc';
        div.style.cssText = 'background:#0f172a; border:1px solid #334155; border-radius:10px; padding:12px; margin-bottom:10px; position:relative;';
        div.innerHTML = '<button type="button" onclick="this.parentElement.remove()" style="position:absolute;top:6px;right:8px;background:none;border:none;color:#ef4444;font-size:1.2rem;cursor:pointer;">&times;</button>' +
            '<div style="display:flex; gap:8px; margin-bottom:8px;">' +
            '<div style="flex:0 0 120px;"><label style="font-size:0.65rem;">ID etape</label><input type="text" class="form-input scen-etape-id" value="' + (data && data.id || defaultId) + '"></div>' +
            '<div style="flex:1;"><label style="font-size:0.65rem;">Texte de l\'etape</label><textarea class="form-textarea scen-etape-texte" rows="2">' + (data && data.texte || '') + '</textarea></div>' +
            '</div>' +
            '<div class="scen-choix-container"></div>' +
            '<button type="button" class="btn-save" style="background:#334155; font-size:0.7rem; padding:4px 10px; margin-top:4px;" onclick="addScenChoix(this)">+ Choix</button>';
        container.appendChild(div);
        // Populate choices if data
        if (data && data.choix) {
            data.choix.forEach(ch => addScenChoix(div.querySelector('.scen-choix-container ~ button'), ch));
        }
    };
    window.addScenChoix = function(btn, data) {
        const choixContainer = btn.previousElementSibling;
        const div = document.createElement('div');
        div.className = 'scen-choix-row';
        div.style.cssText = 'display:flex; gap:6px; align-items:center; margin-bottom:4px; flex-wrap:wrap;';
        div.innerHTML = '<input type="text" class="form-input scen-choix-label" style="flex:2; min-width:120px;" placeholder="Label du choix" value="' + (data && data.label || '') + '">' +
            '<input type="text" class="form-input scen-choix-suite" style="flex:1; min-width:80px;" placeholder="suite ‚Üí id" value="' + (data && data.suite || '') + '">' +
            '<label style="font-size:0.6rem; display:flex; align-items:center; gap:3px; white-space:nowrap;"><input type="checkbox" class="scen-choix-correct"' + (data && data.correct ? ' checked' : '') + '> Correct</label>' +
            '<input type="text" class="form-input scen-choix-feedback" style="flex:2; min-width:100px;" placeholder="Feedback (optionnel)" value="' + (data && data.feedback || '') + '">' +
            '<button type="button" onclick="this.parentElement.remove()" style="background:none;border:none;color:#ef4444;cursor:pointer;">&times;</button>';
        choixContainer.appendChild(div);
    };

    // ========== SET CONTENU IN FORM ==========
    function setContenuInForm(type, contenu) {
        if (!contenu) return;
        if (type === 'texte_trous') {
            document.getElementById('tt-consigne').value = contenu.consigne || '';
            document.getElementById('tt-texte').value = contenu.texte || '';
            document.getElementById('tt-indice').checked = !!contenu.indice;
            document.getElementById('tt-explication').value = contenu.explication || '';
            previewTexteTrous();
        } else if (type === 'relier') {
            document.getElementById('rel-consigne').value = contenu.consigne || '';
            document.getElementById('rel-explication').value = contenu.explication || '';
            document.getElementById('rel-list').innerHTML = '';
            (contenu.paires || []).forEach(p => addRelierPair(p.gauche, p.droite));
        } else if (type === 'ordre') {
            document.getElementById('ord-consigne').value = contenu.consigne || '';
            document.getElementById('ord-explication').value = contenu.explication || '';
            document.getElementById('ord-list').innerHTML = '';
            (contenu.items || []).forEach(it => addOrdreItem(it));
        } else if (type === 'intrus') {
            document.getElementById('int-consigne').value = contenu.consigne || '';
            document.getElementById('int-series').innerHTML = '';
            (contenu.series || []).forEach(s => {
                const safeIdx = Math.min(Math.max(parseInt(s.intrus) || 0, 0), (s.items || []).length - 1);
                addIntrusSerie(s.items, safeIdx, s.explication);
            });
        } else if (type === 'pendu') {
            document.getElementById('pen-consigne').value = contenu.consigne || '';
            document.getElementById('pen-list').innerHTML = '';
            (contenu.mots || []).forEach(m => addPenduMot(m.mot, m.indice, m.explication));
        } else if (type === 'mots_croises') {
            document.getElementById('mc-consigne').value = contenu.consigne || '';
            document.getElementById('mc-list').innerHTML = '';
            (contenu.mots || []).forEach(m => addMotsCroisesMot(m.mot, m.definition, m.explication));
        } else if (type === 'swipe_vf') {
            document.getElementById('svf-consigne').value = contenu.consigne || '';
            document.getElementById('svf-list').innerHTML = '';
            (contenu.affirmations || []).forEach(a => addSwipeAffirmation(a.texte, a.reponse, a.explication));
        } else if (type === 'qcm_image') {
            document.getElementById('qimg-consigne').value = contenu.consigne || '';
            document.getElementById('qimg-questions').innerHTML = '';
            (contenu.questions || []).forEach(q => addQcmImageQuestion(q));
        } else if (type === 'tableau') {
            document.getElementById('tab-consigne').value = contenu.consigne || '';
            document.getElementById('tab-colonnes').value = (contenu.colonnes || []).join(', ');
            document.getElementById('tab-explication').value = contenu.explication || '';
            document.getElementById('tab-list').innerHTML = '';
            (contenu.lignes || []).forEach(l => addTableauLigne((l.cellules || []).join(', ')));
        } else if (type === 'etude_cas') {
            document.getElementById('ec-consigne').value = contenu.consigne || '';
            document.getElementById('ec-scenario').value = contenu.scenario || '';
            document.getElementById('ec-questions').innerHTML = '';
            (contenu.questions || []).forEach(q => addEtudeCasQuestion(q));
        } else if (type === 'pad') {
            document.getElementById('pad-titre').value = contenu.titre || '';
            document.getElementById('pad-situation').value = contenu.situation || '';
            document.getElementById('pad-danger').value = contenu.danger || '';
            document.getElementById('pad-dist-danger').value = (contenu.distracteurs_danger || []).join(' | ');
            document.getElementById('pad-sitdang').value = contenu.situation_dangereuse || '';
            document.getElementById('pad-dist-sitdang').value = (contenu.distracteurs_situation_dangereuse || []).join(' | ');
            document.getElementById('pad-event').value = contenu.evenement_declencheur || '';
            document.getElementById('pad-dist-event').value = (contenu.distracteurs_evenement_declencheur || []).join(' | ');
            document.getElementById('pad-dommage').value = contenu.dommage || '';
            document.getElementById('pad-dist-dommage').value = (contenu.distracteurs_dommage || []).join(' | ');
            document.getElementById('pad-explication').value = contenu.explication || '';
        } else if (type === 'prevention') {
            document.getElementById('prev-titre').value = contenu.titre || '';
            document.getElementById('prev-situation').value = contenu.situation || '';
            document.getElementById('prev-danger').value = contenu.danger || '';
            document.getElementById('prev-explication').value = contenu.explication || '';
            const niveaux = contenu.niveaux || [];
            const fieldMap = { supprimer: 'prev-supprimer', reduire: 'prev-reduire', collective: 'prev-collective', individuelle: 'prev-individuelle', formation: 'prev-formation' };
            const distMap = { supprimer: 'prev-dist-supprimer', reduire: 'prev-dist-reduire', collective: 'prev-dist-collective', individuelle: 'prev-dist-individuelle', formation: 'prev-dist-formation' };
            niveaux.forEach(n => {
                if (fieldMap[n.niveau]) {
                    document.getElementById(fieldMap[n.niveau]).value = n.bonne_reponse || '';
                    document.getElementById(distMap[n.niveau]).value = (n.distracteurs || []).join(' | ');
                }
            });
        } else if (type === 'estimation_risque') {
            document.getElementById('est-titre').value = contenu.titre || '';
            document.getElementById('est-situation').value = contenu.situation || '';
            document.getElementById('est-danger').value = contenu.danger || '';
            document.getElementById('est-dommage').value = contenu.dommage || '';
            document.getElementById('est-gravite').value = contenu.gravite || '';
            document.getElementById('est-exposition').value = contenu.exposition || '';
            document.getElementById('est-declencheur').value = contenu.declencheur || '';
            document.getElementById('est-priorite').value = contenu.priorite || '';
            updateEstPreview();
        } else if (type === 'duerp_ligne') {
            document.getElementById('duerp-l-titre').value = contenu.titre || '';
            document.getElementById('duerp-l-unite').value = contenu.unite_travail || '';
            document.getElementById('duerp-l-situation').value = contenu.situation || '';
            const att = contenu.attendus || {};
            const ch = contenu.choix || {};
            document.getElementById('duerp-l-danger').value = att.danger || '';
            const dDist = (ch.danger || []).filter(d => d !== att.danger);
            document.getElementById('duerp-l-dist-danger').value = dDist.join(' | ');
            document.getElementById('duerp-l-dommage').value = att.dommage || '';
            const dmDist = (ch.dommage || []).filter(d => d !== att.dommage);
            document.getElementById('duerp-l-dist-dommage').value = dmDist.join(' | ');
            document.getElementById('duerp-l-gravite').value = att.gravite || '';
            document.getElementById('duerp-l-exposition').value = att.exposition || '';
            document.getElementById('duerp-l-declencheur').value = att.declencheur || '';
            document.getElementById('duerp-l-mesure').value = att.mesure_principale || '';
            const mDist = (ch.mesure_principale || []).filter(d => d !== att.mesure_principale);
            document.getElementById('duerp-l-dist-mesure').value = mDist.join(' | ');
            updateDuerpLPreview();
        } else if (type === 'duerp_mini') {
            document.getElementById('duerp-m-titre').value = contenu.titre || '';
            document.getElementById('duerp-m-entreprise').value = contenu.entreprise || '';
            const lignes = contenu.lignes || [];
            for (let n = 1; n <= 4; n++) {
                const L = lignes[n-1] || {};
                const pre = 'duerp-m-L' + n;
                const att = L.attendus || {};
                const ch = L.choix || {};
                document.getElementById(pre + '-unite').value = L.unite_travail || '';
                document.getElementById(pre + '-situation').value = L.situation || '';
                document.getElementById(pre + '-danger').value = att.danger || '';
                const dDist = (ch.danger || []).filter(d => d !== att.danger);
                document.getElementById(pre + '-dist-danger').value = dDist.join(' | ');
                document.getElementById(pre + '-dommage').value = att.dommage || '';
                const dmDist = (ch.dommage || []).filter(d => d !== att.dommage);
                document.getElementById(pre + '-dist-dommage').value = dmDist.join(' | ');
                document.getElementById(pre + '-gravite').value = att.gravite || '';
                document.getElementById(pre + '-exposition').value = att.exposition || '';
                document.getElementById(pre + '-declencheur').value = att.declencheur || '';
            }
            const mf = contenu.mission_finale || {};
            document.getElementById('duerp-m-nb-prio').value = mf.nb_prioritaires || 2;
        } else if (type === 'qcm_classique') {
            document.getElementById('qcmc-titre').value = contenu.titre || '';
            document.getElementById('qcmc-question').value = contenu.question || '';
            document.getElementById('qcmc-multiple').checked = !!contenu.multiple;
            document.getElementById('qcmc-explication').value = contenu.explication || '';
            const choix = contenu.choix || [];
            const repIds = Array.isArray(contenu.reponse) ? contenu.reponse : [contenu.reponse];
            const bonnes = choix.filter(c => repIds.includes(c.id)).map(c => c.texte);
            const distracteurs = choix.filter(c => !repIds.includes(c.id)).map(c => c.texte);
            document.getElementById('qcmc-reponse').value = bonnes.join('\n');
            document.getElementById('qcmc-distracteurs').value = distracteurs.join(' | ');
        } else if (type === 'quiz_chrono') {
            document.getElementById('chrono-titre').value = contenu.titre || '';
            document.getElementById('chrono-temps').value = contenu.temps_par_question || 15;
            document.getElementById('chrono-questions').innerHTML = '';
            (contenu.questions || []).forEach(q => {
                const choix = q.choix || [];
                const repId = q.reponse;
                const bonne = choix.find(c => c.id === repId);
                const dist = choix.filter(c => c.id !== repId).map(c => c.texte);
                addChronoQuestion({ question: q.question, reponse: bonne ? bonne.texte : '', distracteurs: dist.join(' | '), explication: q.explication || '' });
            });
        } else if (type === 'categoriser') {
            document.getElementById('cat-titre').value = contenu.titre || '';
            document.getElementById('cat-consigne').value = contenu.consigne || '';
            document.getElementById('cat-categories').value = (contenu.categories || []).join(' | ');
            document.getElementById('cat-items-list').innerHTML = '';
            (contenu.items || []).forEach(it => addCatItem(it.label, it.categorie));
        } else if (type === 'memory') {
            document.getElementById('mem-titre').value = contenu.titre || '';
            document.getElementById('mem-list').innerHTML = '';
            (contenu.cartes || []).forEach(c => addMemoryPair(c.a, c.b));
        } else if (type === 'scenario') {
            document.getElementById('scen-titre').value = contenu.titre || '';
            document.getElementById('scen-etapes').innerHTML = '';
            (contenu.etapes || []).forEach(et => addScenEtape(et));
        } else if (type === 'pictogramme') {
            document.getElementById('picto-consigne').value = contenu.consigne || 'Identifie les pictogrammes de securite';
            document.getElementById('picto-mode').value = contenu.mode || 'quiz_image';
            document.getElementById('picto-nb').value = contenu.nb || 8;
            document.getElementById('picto-explication').value = contenu.explication || '';
            var cats = contenu.categories || ['obligation', 'interdiction', 'danger', 'incendie', 'secours', 'sgh'];
            document.querySelectorAll('.picto-cat-cb').forEach(cb => { cb.checked = cats.includes(cb.value); });
            // Escape game : stocker les epreuves pour la sauvegarde
            window._pictoEpreuves = contenu.epreuves || [];
        } else if (type === 'analyse_copie') {
            window._analyseCopieData = contenu;
            var jsonInput = document.getElementById('ac-json-input');
            if (jsonInput) jsonInput.value = JSON.stringify(contenu, null, 2);
            var status = document.getElementById('ac-import-status');
            if (status) {
                var nbItems = (contenu.items || []).length;
                status.style.display = '';
                status.style.color = '#16a34a';
                status.textContent = '‚úÖ ' + nbItems + ' item(s) charges';
            }
        }
    }

    function clearAllForms() {
        document.getElementById('tt-texte').value = '';
        document.getElementById('tt-consigne').value = 'Completez le texte suivant';
        document.getElementById('tt-indice').checked = false;
        document.getElementById('tt-preview').innerHTML = '';
        document.getElementById('rel-consigne').value = 'Reliez chaque element a sa definition';
        document.getElementById('rel-list').innerHTML = '';
        document.getElementById('ord-consigne').value = 'Remettez les etapes dans le bon ordre';
        document.getElementById('ord-list').innerHTML = '';
        document.getElementById('int-consigne').value = 'Trouvez l\'intrus dans chaque serie';
        document.getElementById('int-series').innerHTML = '';
        document.getElementById('pen-consigne').value = 'Devinez les mots de la PSE';
        document.getElementById('pen-list').innerHTML = '';
        document.getElementById('mc-consigne').value = 'Completez la grille de mots croises';
        document.getElementById('mc-list').innerHTML = '';
        document.getElementById('svf-consigne').value = 'Indiquez Vrai ou Faux pour chaque affirmation';
        document.getElementById('svf-list').innerHTML = '';
        document.getElementById('qimg-consigne').value = 'Observez l\'image et repondez';
        document.getElementById('qimg-questions').innerHTML = '';
        document.getElementById('tab-consigne').value = 'Completez le tableau';
        document.getElementById('tab-colonnes').value = '';
        document.getElementById('tab-list').innerHTML = '';
        document.getElementById('ec-consigne').value = 'Lisez le cas et repondez aux questions';
        document.getElementById('ec-scenario').value = '';
        document.getElementById('ec-questions').innerHTML = '';
        document.getElementById('pad-titre').value = '';
        document.getElementById('pad-situation').value = '';
        document.getElementById('pad-danger').value = '';
        document.getElementById('pad-dist-danger').value = '';
        document.getElementById('pad-sitdang').value = '';
        document.getElementById('pad-dist-sitdang').value = '';
        document.getElementById('pad-event').value = '';
        document.getElementById('pad-dist-event').value = '';
        document.getElementById('pad-dommage').value = '';
        document.getElementById('pad-dist-dommage').value = '';
        document.getElementById('prev-titre').value = '';
        document.getElementById('prev-situation').value = '';
        document.getElementById('prev-danger').value = '';
        document.getElementById('prev-supprimer').value = '';
        document.getElementById('prev-dist-supprimer').value = '';
        document.getElementById('prev-reduire').value = '';
        document.getElementById('prev-dist-reduire').value = '';
        document.getElementById('prev-collective').value = '';
        document.getElementById('prev-dist-collective').value = '';
        document.getElementById('prev-individuelle').value = '';
        document.getElementById('prev-dist-individuelle').value = '';
        document.getElementById('prev-formation').value = '';
        document.getElementById('prev-dist-formation').value = '';
        document.getElementById('est-titre').value = '';
        document.getElementById('est-situation').value = '';
        document.getElementById('est-danger').value = '';
        document.getElementById('est-dommage').value = '';
        document.getElementById('est-gravite').value = '';
        document.getElementById('est-exposition').value = '';
        document.getElementById('est-declencheur').value = '';
        document.getElementById('est-priorite').value = '';
        document.getElementById('est-proba-result').style.display = 'none';
        document.getElementById('est-matrix-preview').style.display = 'none';
        // DUERP Ligne
        document.getElementById('duerp-l-titre').value = '';
        document.getElementById('duerp-l-unite').value = '';
        document.getElementById('duerp-l-situation').value = '';
        document.getElementById('duerp-l-danger').value = '';
        document.getElementById('duerp-l-dist-danger').value = '';
        document.getElementById('duerp-l-dommage').value = '';
        document.getElementById('duerp-l-dist-dommage').value = '';
        document.getElementById('duerp-l-gravite').value = '';
        document.getElementById('duerp-l-exposition').value = '';
        document.getElementById('duerp-l-declencheur').value = '';
        document.getElementById('duerp-l-mesure').value = '';
        document.getElementById('duerp-l-dist-mesure').value = '';
        document.getElementById('duerp-l-proba-result').style.display = 'none';
        document.getElementById('duerp-l-matrix-preview').style.display = 'none';
        // DUERP Mini
        document.getElementById('duerp-m-titre').value = '';
        document.getElementById('duerp-m-entreprise').value = '';
        for (let n = 1; n <= 4; n++) {
            const pre = 'duerp-m-L' + n;
            document.getElementById(pre + '-unite').value = '';
            document.getElementById(pre + '-situation').value = '';
            document.getElementById(pre + '-danger').value = '';
            document.getElementById(pre + '-dist-danger').value = '';
            document.getElementById(pre + '-dommage').value = '';
            document.getElementById(pre + '-dist-dommage').value = '';
            document.getElementById(pre + '-gravite').value = '';
            document.getElementById(pre + '-exposition').value = '';
            document.getElementById(pre + '-declencheur').value = '';
        }
        document.getElementById('duerp-m-nb-prio').value = '2';
        // QCM Classique
        document.getElementById('qcmc-titre').value = '';
        document.getElementById('qcmc-question').value = '';
        document.getElementById('qcmc-reponse').value = '';
        document.getElementById('qcmc-distracteurs').value = '';
        document.getElementById('qcmc-multiple').checked = false;
        document.getElementById('qcmc-explication').value = '';
        // Quiz Chrono
        document.getElementById('chrono-titre').value = '';
        document.getElementById('chrono-temps').value = '15';
        document.getElementById('chrono-questions').innerHTML = '';
        // Categoriser
        document.getElementById('cat-titre').value = '';
        document.getElementById('cat-consigne').value = 'Classez chaque element dans la bonne categorie';
        document.getElementById('cat-categories').value = '';
        document.getElementById('cat-items-list').innerHTML = '';
        // Memory
        document.getElementById('mem-titre').value = '';
        document.getElementById('mem-list').innerHTML = '';
        // Scenario
        document.getElementById('scen-titre').value = '';
        document.getElementById('scen-etapes').innerHTML = '';
        // Pictogramme
        document.getElementById('picto-consigne').value = 'Identifie les pictogrammes de securite';
        document.getElementById('picto-mode').value = 'quiz_image';
        document.getElementById('picto-nb').value = '8';
        document.getElementById('picto-explication').value = '';
        document.querySelectorAll('.picto-cat-cb').forEach(cb => { cb.checked = true; });
        window._pictoEpreuves = [];
        // Analyse copie
        var acJsonInput = document.getElementById('ac-json-input');
        if (acJsonInput) acJsonInput.value = '';
        var acStatus = document.getElementById('ac-import-status');
        if (acStatus) acStatus.style.display = 'none';
        window._analyseCopieData = null;
        // Categorie checkbox reset
        var catCb = document.getElementById('exo-categorie-competences');
        if (catCb) { catCb.checked = false; catCb.disabled = false; }
        // Competences cibles reset
        document.querySelectorAll('.comp-cible-cb').forEach(function(cb) { cb.checked = false; });
        var compCiblesGroup = document.getElementById('competences-cibles-group');
        if (compCiblesGroup) compCiblesGroup.style.display = 'none';
    }

    // ========== SIDEBAR LIST ==========
    function renderExoList() {
        const list = document.getElementById('exo-list');
        list.innerHTML = '';
        document.getElementById('exo-count').textContent = allExercices.length;
        allExercices.forEach(ex => {
            const item = document.createElement('div');
            item.className = 'exo-list-item' + (ex.id === currentExoId ? ' active' : '');
            const typeBadge = '<span class="ei-badge badge-' + ex.type + '">' + (TYPE_LABELS[ex.type] || ex.type) + '</span>';
            const pubBadge = ex.publie ? '<span class="ei-badge badge-pub">Publie</span>' : '<span class="ei-badge badge-draft">Brouillon</span>';
            const diffBadge = ex.difficulte ? '<span class="ei-badge badge-' + ex.difficulte + '">' + ex.difficulte + '</span>' : '';
            const classeBadge = ex.classeIds && ex.classeIds.length > 0 ? '<span class="ei-badge" style="background:#e0e7ff; color:#3730a3;">' + ex.classeIds.join(', ') + '</span>' : '';
            const moduleBadge = ex.moduleId ? '<span class="ei-badge" style="background:#fef3c7; color:#92400e;">' + ex.moduleId + '</span>' : '';
            item.innerHTML = '<div class="ei-title">' + (ex.titre || 'Sans titre') + '</div>' +
                '<div class="ei-meta">' + typeBadge + pubBadge + diffBadge + classeBadge + moduleBadge + '</div>' +
                '<button class="ei-del" onclick="event.stopPropagation(); deleteExerciceById(\'' + ex.id + '\')">&times;</button>';
            item.onclick = () => loadExercice(ex.id);
            list.appendChild(item);
        });
    }

    // ========== FIREBASE SNAPSHOT ==========
    const qExos = query(collection(db, "exercices_banque"), orderBy("updatedAt", "desc"));
    onSnapshot(qExos, (snap) => {
        allExercices = [];
        snap.forEach(d => { allExercices.push({ id: d.id, ...d.data() }); });
        renderExoList();
        console.log("‚úÖ Exercices charges:", allExercices.length);
    }, (error) => {
        console.warn("‚ö†Ô∏è orderBy echoue, fallback sans tri:", error.message);
        // Fallback : charger sans orderBy (evite le besoin d'un index composite)
        const qFallback = collection(db, "exercices_banque");
        onSnapshot(qFallback, (snap2) => {
            allExercices = [];
            snap2.forEach(d => { allExercices.push({ id: d.id, ...d.data() }); });
            allExercices.sort((a, b) => {
                const ta = a.updatedAt ? (a.updatedAt.seconds || 0) : 0;
                const tb = b.updatedAt ? (b.updatedAt.seconds || 0) : 0;
                return tb - ta;
            });
            renderExoList();
            console.log("‚úÖ Exercices charges (fallback):", allExercices.length);
        });
    });

    // ========== NEW / LOAD / SAVE / PUBLISH / DELETE ==========
    window.newExercice = function() {
        currentExoId = null;
        document.getElementById('exo-titre').value = '';
        document.getElementById('exo-type').value = 'texte_trous';
        setClassPillsActive([]);
        document.getElementById('exo-module').value = '';
        window.setDifficulty('facile');
        clearAllForms();
        onTypeChange();
        document.getElementById('btn-delete').style.display = 'none';
        document.getElementById('btn-unpublish').style.display = 'none';
        document.getElementById('btn-publish').style.display = '';
        document.getElementById('main-empty').style.display = 'none';
        document.getElementById('main-editor').style.display = 'flex';
        if (window.innerWidth <= 768) closeMenu();
    };

    function loadExercice(id) {
        const ex = allExercices.find(e => e.id === id);
        if (!ex) return;
        currentExoId = id;
        document.getElementById('exo-titre').value = ex.titre || '';
        document.getElementById('exo-type').value = ex.type || 'texte_trous';
        setClassPillsActive(ex.classeIds || (ex.classeId ? [ex.classeId] : []));
        setTimeout(() => { document.getElementById('exo-module').value = ex.moduleId || ''; }, 100);
        window.setDifficulty(ex.difficulte || 'facile');
        clearAllForms();
        onTypeChange();
        // 6f: restaurer checkbox categorie depuis Firebase
        if (ex.categorie === 'competences' && !AUTO_COMPETENCES_TYPES.includes(ex.type) && !TRANSVERSAL_TYPES.includes(ex.type)) {
            var catCb = document.getElementById('exo-categorie-competences');
            catCb.checked = true;
            onCategorieChange();
        }
        // Restaurer competences_cibles
        if (ex.competences_cibles && Array.isArray(ex.competences_cibles)) {
            document.querySelectorAll('.comp-cible-cb').forEach(function(cb) {
                cb.checked = ex.competences_cibles.indexOf(cb.value) !== -1;
            });
        }
        setContenuInForm(ex.type, ex.contenu);
        document.getElementById('btn-delete').style.display = 'block';
        updatePublishButtons(!!ex.publie);
        document.getElementById('main-empty').style.display = 'none';
        document.getElementById('main-editor').style.display = 'flex';
        renderExoList();
        if (window.innerWidth <= 768) closeMenu();
    }

    window.saveExercice = async function() {
        const titre = document.getElementById('exo-titre').value.trim();
        if (!titre) { alert('Donne un titre !'); return; }
        const type = document.getElementById('exo-type').value;
        const classeIds = getSelectedClasseIds();
        const classeId = classeIds.length > 0 ? classeIds[0] : null;
        const moduleId = document.getElementById('exo-module').value || null;
        let niveau = null;
        if (classeId) {
            const cig = window.getClassesFromGroupe ? window.getClassesFromGroupe(classeId) : [classeId];
            niveau = window.getNiveauClasse ? window.getNiveauClasse(cig[0]) : null;
        }
        const contenu = getContenuFromForm();
        // === VALIDATION PAD ===
        if (type === 'pad') {
            const c = contenu;
            const errors = [];
            if (!c.titre) errors.push('Le titre PAD est obligatoire');
            if (!c.situation || c.situation.length < 20) errors.push('La situation doit faire au moins 20 caracteres');
            if (c.situation && c.situation.length > 500) errors.push('La situation depasse 500 caracteres');
            const fields = [
                { key: 'danger', label: 'Danger', maxLen: 80 },
                { key: 'situation_dangereuse', label: 'Situation dangereuse', maxLen: 120 },
                { key: 'evenement_declencheur', label: 'Evenement declencheur', maxLen: 120 },
                { key: 'dommage', label: 'Dommage', maxLen: 120 }
            ];
            fields.forEach(f => {
                if (!c[f.key]) errors.push(f.label + ' est obligatoire');
                if (c[f.key] && c[f.key].length > f.maxLen) errors.push(f.label + ' depasse ' + f.maxLen + ' caracteres');
                const distKey = 'distracteurs_' + f.key;
                if (!c[distKey] || c[distKey].length !== 3) errors.push(f.label + ' : il faut exactement 3 distracteurs (separes par |)');
                if (c[distKey]) {
                    c[distKey].forEach((d, i) => {
                        if (d.length > 80) errors.push(f.label + ' distracteur ' + (i+1) + ' depasse 80 caracteres');
                        if (d.toLowerCase() === (c[f.key] || '').toLowerCase()) errors.push(f.label + ' distracteur ' + (i+1) + ' identique a la bonne reponse');
                    });
                    const unique = new Set(c[distKey].map(d => d.toLowerCase()));
                    if (unique.size < c[distKey].length) errors.push(f.label + ' : les distracteurs doivent etre tous differents');
                }
            });
            if (errors.length > 0) {
                showToast('‚ö†Ô∏è ' + errors[0]);
                return;
            }
        }
        // === VALIDATION PREVENTION ===
        if (type === 'prevention') {
            const c = contenu;
            const errors = [];
            if (!c.titre) errors.push('Le titre est obligatoire');
            if (!c.situation || c.situation.length < 20) errors.push('La situation doit faire au moins 20 caracteres');
            if (c.situation && c.situation.length > 500) errors.push('La situation depasse 500 caracteres');
            if (!c.danger) errors.push('Le danger identifie est obligatoire');
            const niveauLabels = { supprimer: 'Supprimer', reduire: 'Reduire', collective: 'Collective', individuelle: 'Individuelle', formation: 'Formation' };
            (c.niveaux || []).forEach(n => {
                const label = niveauLabels[n.niveau] || n.niveau;
                if (!n.bonne_reponse) errors.push(label + ' : la bonne reponse est obligatoire');
                if (n.bonne_reponse && n.bonne_reponse.length > 120) errors.push(label + ' : depasse 120 caracteres');
                if (!n.distracteurs || n.distracteurs.length !== 3) errors.push(label + ' : il faut exactement 3 distracteurs (separes par |)');
                if (n.distracteurs) {
                    n.distracteurs.forEach((d, i) => {
                        if (d.length > 80) errors.push(label + ' distracteur ' + (i+1) + ' depasse 80 caracteres');
                        if (d.toLowerCase() === (n.bonne_reponse || '').toLowerCase()) errors.push(label + ' distracteur ' + (i+1) + ' identique a la bonne reponse');
                    });
                    const unique = new Set(n.distracteurs.map(d => d.toLowerCase()));
                    if (unique.size < n.distracteurs.length) errors.push(label + ' : les distracteurs doivent etre tous differents');
                }
            });
            if ((c.niveaux || []).length !== 5) errors.push('Il faut exactement 5 niveaux de prevention');
            if (errors.length > 0) {
                showToast('‚ö†Ô∏è ' + errors[0]);
                return;
            }
        }
        // === VALIDATION ESTIMATION DU RISQUE ===
        if (type === 'estimation_risque') {
            const c = contenu;
            const errors = [];
            if (!c.titre) errors.push('Le titre est obligatoire');
            if (!c.situation || c.situation.length < 20) errors.push('La situation doit faire au moins 20 caracteres');
            if (c.situation && c.situation.length > 500) errors.push('La situation depasse 500 caracteres');
            if (!c.danger) errors.push('Le danger identifie est obligatoire');
            if (!c.dommage) errors.push('Le dommage est obligatoire');
            if (!c.gravite || c.gravite < 1 || c.gravite > 4) errors.push('La gravite doit etre entre 1 et 4');
            if (!c.exposition) errors.push('La frequence/duree d\'exposition est obligatoire');
            if (!c.declencheur) errors.push('La probabilite du declencheur est obligatoire');
            if (!c.priorite) errors.push('La priorite est obligatoire');
            // Verification coherence priorite
            if (c.gravite && c.exposition && c.declencheur && c.priorite) {
                const proba = calcProbaEdit(c.exposition, c.declencheur);
                const attenduPrio = (c.gravite + proba) >= 5 ? 'prioritaire' : 'non_prioritaire';
                if (c.priorite !== attenduPrio) {
                    errors.push('Incoherence : avec gravite ' + c.gravite + ' et probabilite ' + proba + ', la priorite devrait etre "' + attenduPrio + '"');
                }
            }
            if (errors.length > 0) {
                showToast('‚ö†Ô∏è ' + errors[0]);
                return;
            }
        }

        // Validation DUERP Ligne
        if (type === 'duerp_ligne') {
            const c = contenu;
            const att = c.attendus || {};
            const ch = c.choix || {};
            const errors = [];
            if (!c.titre) errors.push('Le titre est obligatoire');
            if (!c.unite_travail) errors.push('L\'unite de travail est obligatoire');
            if (!c.situation || c.situation.length < 20) errors.push('La situation doit faire au moins 20 caracteres');
            if (c.situation && c.situation.length > 500) errors.push('La situation depasse 500 caracteres');
            if (!att.danger) errors.push('Le danger (bonne reponse) est obligatoire');
            if (!ch.danger || ch.danger.length !== 4) errors.push('Il faut exactement 3 distracteurs pour le danger (4 choix total)');
            if (ch.danger && new Set(ch.danger).size !== ch.danger.length) errors.push('Les choix danger doivent etre tous differents');
            if (!att.dommage) errors.push('Le dommage (bonne reponse) est obligatoire');
            if (!ch.dommage || ch.dommage.length !== 4) errors.push('Il faut exactement 3 distracteurs pour le dommage (4 choix total)');
            if (ch.dommage && new Set(ch.dommage).size !== ch.dommage.length) errors.push('Les choix dommage doivent etre tous differents');
            if (!att.gravite || att.gravite < 1 || att.gravite > 4) errors.push('La gravite doit etre entre 1 et 4');
            if (!['rare_courte','frequente_longue'].includes(att.exposition)) errors.push('Exposition invalide (rare_courte ou frequente_longue)');
            if (!['faible','eleve'].includes(att.declencheur)) errors.push('Declencheur invalide (faible ou eleve)');
            // Mesure optionnelle mais si presente, 5 choix
            if (att.mesure_principale) {
                if (!ch.mesure_principale || ch.mesure_principale.length !== 5) errors.push('Si mesure presente, il faut exactement 4 distracteurs (5 choix total)');
                if (ch.mesure_principale && new Set(ch.mesure_principale).size !== ch.mesure_principale.length) errors.push('Les choix mesure doivent etre tous differents');
            }
            if (errors.length > 0) { showToast('‚ö†Ô∏è ' + errors[0]); return; }
        }

        // Validation DUERP Mini
        if (type === 'duerp_mini') {
            const c = contenu;
            const errors = [];
            if (!c.titre) errors.push('Le titre est obligatoire');
            if (!c.entreprise) errors.push('Le nom de l\'entreprise est obligatoire');
            const lignes = c.lignes || [];
            if (lignes.length !== 4) errors.push('Il faut exactement 4 lignes');
            for (let i = 0; i < lignes.length; i++) {
                const L = lignes[i];
                const att = L.attendus || {};
                const ch = L.choix || {};
                const ln = 'Ligne ' + (i+1) + ' : ';
                if (!L.unite_travail) errors.push(ln + 'unite de travail obligatoire');
                if (!L.situation || L.situation.length < 20) errors.push(ln + 'situation trop courte (min 20 car.)');
                if (!att.danger) errors.push(ln + 'danger obligatoire');
                if (!ch.danger || ch.danger.length !== 4) errors.push(ln + 'exactement 3 distracteurs danger');
                if (!att.dommage) errors.push(ln + 'dommage obligatoire');
                if (!ch.dommage || ch.dommage.length !== 4) errors.push(ln + 'exactement 3 distracteurs dommage');
                if (!att.gravite || att.gravite < 1 || att.gravite > 4) errors.push(ln + 'gravite 1-4');
                if (!['rare_courte','frequente_longue'].includes(att.exposition)) errors.push(ln + 'exposition invalide');
                if (!['faible','eleve'].includes(att.declencheur)) errors.push(ln + 'declencheur invalide');
            }
            // Verifier nb_prioritaires coherent
            const nbPrio = (c.mission_finale || {}).nb_prioritaires || 2;
            let nbReelPrio = 0;
            lignes.forEach(L => {
                const att = L.attendus || {};
                const p = calcProbaEdit(att.exposition, att.declencheur);
                if ((att.gravite + p) >= 5) nbReelPrio++;
            });
            if (nbPrio > nbReelPrio) errors.push('Nb prioritaires demande (' + nbPrio + ') > nb lignes reellement prioritaires (' + nbReelPrio + ')');
            if (errors.length > 0) { showToast('‚ö†Ô∏è ' + errors[0]); return; }
        }

        // Validation QCM Classique
        if (type === 'qcm_classique') {
            const c = contenu;
            const errors = [];
            if (!c.titre) errors.push('Le titre est obligatoire');
            if (!c.question) errors.push('La question est obligatoire');
            if (!c.choix || c.choix.length < 2) errors.push('Il faut au moins 2 choix');
            if (c.choix) {
                const ids = c.choix.map(x => x.id);
                if (new Set(ids).size !== ids.length) errors.push('IDs de choix en doublon');
                if (c.choix.some(x => !x.texte)) errors.push('Tous les choix doivent avoir un texte');
            }
            if (c.multiple) {
                if (!Array.isArray(c.reponse) || c.reponse.length < 2) errors.push('QCM multiple : au moins 2 bonnes reponses');
                if (Array.isArray(c.reponse) && c.choix) {
                    const ids = c.choix.map(x => x.id);
                    if (!c.reponse.every(r => ids.includes(r))) errors.push('Certaines reponses ne correspondent a aucun choix');
                }
            } else {
                if (!c.reponse) errors.push('La bonne reponse est obligatoire');
                if (c.choix && !c.choix.find(x => x.id === c.reponse)) errors.push('La reponse ne correspond a aucun choix');
            }
            if (errors.length > 0) { showToast('‚ö†Ô∏è ' + errors[0]); return; }
        }

        // Validation Quiz Chrono
        if (type === 'quiz_chrono') {
            const c = contenu;
            const errors = [];
            if (!c.titre) errors.push('Le titre est obligatoire');
            if (!c.temps_par_question || c.temps_par_question < 5) errors.push('Temps minimum : 5 secondes');
            if (!c.questions || c.questions.length < 2) errors.push('Il faut au moins 2 questions');
            (c.questions || []).forEach((q, i) => {
                const qi = 'Q' + (i+1) + ' : ';
                if (!q.question) errors.push(qi + 'texte obligatoire');
                if (!q.choix || q.choix.length < 2) errors.push(qi + 'au moins 2 choix');
                if (!q.reponse) errors.push(qi + 'reponse obligatoire');
            });
            if (errors.length > 0) { showToast('‚ö†Ô∏è ' + errors[0]); return; }
        }

        // Validation Categoriser
        if (type === 'categoriser') {
            const c = contenu;
            const errors = [];
            if (!c.titre) errors.push('Le titre est obligatoire');
            if (!c.categories || c.categories.length < 2) errors.push('Il faut au moins 2 categories');
            if (!c.items || c.items.length < 3) errors.push('Il faut au moins 3 items');
            if (c.items) {
                const ids = c.items.map(x => x.id);
                if (new Set(ids).size !== ids.length) errors.push('IDs d\'items en doublon');
                c.items.forEach((it, i) => {
                    if (!it.label) errors.push('Item ' + (i+1) + ' : label obligatoire');
                    if (c.categories && !c.categories.includes(it.categorie)) errors.push('Item "' + it.label + '" : categorie invalide');
                });
            }
            if (errors.length > 0) { showToast('‚ö†Ô∏è ' + errors[0]); return; }
        }

        // Validation Memory
        if (type === 'memory') {
            const c = contenu;
            const errors = [];
            if (!c.titre) errors.push('Le titre est obligatoire');
            if (!c.cartes || c.cartes.length < 4) errors.push('Il faut au moins 4 paires');
            if (c.cartes && c.cartes.length > 8) errors.push('Maximum 8 paires');
            if (c.cartes) {
                const ids = c.cartes.map(x => x.id);
                if (new Set(ids).size !== ids.length) errors.push('IDs de paires en doublon');
                c.cartes.forEach((p, i) => {
                    if (!p.a) errors.push('Paire ' + (i+1) + ' : face A obligatoire');
                    if (!p.b) errors.push('Paire ' + (i+1) + ' : face B obligatoire');
                });
            }
            if (errors.length > 0) { showToast('‚ö†Ô∏è ' + errors[0]); return; }
        }

        // Validation Scenario
        if (type === 'scenario') {
            const c = contenu;
            const errors = [];
            if (!c.titre) errors.push('Le titre est obligatoire');
            if (!c.etapes || c.etapes.length < 2) errors.push('Il faut au moins 2 etapes');
            if (c.etapes) {
                const allIds = c.etapes.map(e => e.id);
                if (new Set(allIds).size !== allIds.length) errors.push('IDs d\'etapes en doublon');
                let hasFin = false;
                let autoFixed = 0;
                c.etapes.forEach((et, i) => {
                    if (!et.id) errors.push('Etape ' + (i+1) + ' : ID obligatoire');
                    if (!et.texte) errors.push('Etape ' + (i+1) + ' : texte obligatoire');
                    if (!et.choix || et.choix.length === 0) {
                        // Auto-repair: bad steps must not be terminal
                        if (et.id && et.id.startsWith('bad')) {
                            let retourId = 'debut';
                            for (const other of c.etapes) {
                                if (other.choix && other.choix.some(ch => ch.suite === et.id)) {
                                    retourId = other.id;
                                    break;
                                }
                            }
                            et.choix = [{ label: 'Reessayer', suite: retourId, correct: false, feedback: '' }];
                            autoFixed++;
                        } else {
                            hasFin = true;
                        }
                    }
                    (et.choix || []).forEach((ch, j) => {
                        if (!ch.label) errors.push('Etape "' + et.id + '" choix ' + (j+1) + ' : label obligatoire');
                        if (!ch.suite) errors.push('Etape "' + et.id + '" choix ' + (j+1) + ' : suite obligatoire');
                        if (ch.suite && !allIds.includes(ch.suite)) errors.push('Etape "' + et.id + '" choix ' + (j+1) + ' : suite "' + ch.suite + '" n\'existe pas');
                    });
                });
                if (!hasFin) errors.push('Il faut au moins 1 etape finale (sans choix)');
                if (autoFixed > 0) showToast('üîß ' + autoFixed + ' etape(s) bad reparee(s) : ajout bouton Reessayer', 4000);
            }
            if (errors.length > 0) { showToast('‚ö†Ô∏è ' + errors[0]); return; }
        }

        const catCb = document.getElementById('exo-categorie-competences');
        const categorie = (catCb.checked || AUTO_COMPETENCES_TYPES.includes(type)) ? 'competences' : 'modules';
        const competences_cibles = getSelectedCompetences();
        const data = { titre, type, classeIds, classeId, moduleId, niveau, difficulte: currentDifficulty, contenu, categorie, competences_cibles, updatedAt: serverTimestamp() };
        try {
            if (currentExoId) {
                await setDoc(doc(db, "exercices_banque", currentExoId), data, { merge: true });
            } else {
                const newId = 'exo_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 4);
                data.createdAt = serverTimestamp();
                data.publie = false;
                await setDoc(doc(db, "exercices_banque", newId), data);
                currentExoId = newId;
                document.getElementById('btn-delete').style.display = 'block';
            }
            showToast('Exercice sauvegarde !');
        } catch(e) { alert('Erreur : ' + e.message); }
    };

    window.publishExercice = async function() {
        await saveExercice();
        if (currentExoId) {
            await setDoc(doc(db, "exercices_banque", currentExoId), { publie: true }, { merge: true });
            showToast('Exercice publie !');
            updatePublishButtons(true);
        }
    };
    window.unpublishExercice = async function() {
        if (!currentExoId) return;
        await setDoc(doc(db, "exercices_banque", currentExoId), { publie: false }, { merge: true });
        showToast('Exercice depublie.');
        updatePublishButtons(false);
    };
    function updatePublishButtons(isPublished) {
        document.getElementById('btn-publish').style.display = isPublished ? 'none' : '';
        document.getElementById('btn-unpublish').style.display = isPublished ? '' : 'none';
    }

    window.deleteExercice = async function() {
        if (!currentExoId) return;
        if (!confirm('Supprimer cet exercice ?')) return;
        await deleteDoc(doc(db, "exercices_banque", currentExoId));
        currentExoId = null;
        document.getElementById('main-editor').style.display = 'none';
        document.getElementById('main-empty').style.display = 'flex';
        showToast('Exercice supprime.');
    };
    window.deleteExerciceById = async function(id) {
        if (!confirm('Supprimer cet exercice ?')) return;
        await deleteDoc(doc(db, "exercices_banque", id));
        if (id === currentExoId) {
            currentExoId = null;
            document.getElementById('main-editor').style.display = 'none';
            document.getElementById('main-empty').style.display = 'flex';
        }
        showToast('Exercice supprime.');
    };

    // ========== IMPORT JSON ==========
    const PROMPTS = {
        texte_trous: 'Genere un exercice "texte a trous" pour le module PSE [MODULE] en JSON.\nFormat : { "consigne": "...", "texte": "Phrase avec {{mot}} entre doubles accolades.", "indice": false, "explication": "Explication pedagogique (optionnel)" }\nMets 5 a 10 mots entre {{ }}. Texte de 3 a 5 phrases.\nAjoute une explication pedagogique pour aider l\'eleve a comprendre ses erreurs.',
        relier: 'Genere un exercice "relier" pour le module PSE [MODULE] en JSON.\nFormat : { "consigne": "...", "paires": [{ "gauche": "Terme", "droite": "Definition" }], "explication": "Explication pedagogique (optionnel)" }\nCree 5 a 8 paires.\nAjoute une explication pedagogique pour aider l\'eleve a comprendre la logique des associations.',
        ordre: 'Genere un exercice "remettre dans l\'ordre" pour le module PSE [MODULE] en JSON.\nFormat : { "consigne": "...", "items": ["Etape 1", "Etape 2"], "explication": "Explication pedagogique (optionnel)" }\nItems dans le BON ordre. 4 a 8 etapes.\nAjoute une explication pedagogique pour aider l\'eleve a comprendre pourquoi cet ordre.',
        intrus: 'Genere un exercice "intrus" pour le module PSE [MODULE] en JSON.\nFormat : { "consigne": "...", "series": [{ "items": ["A","B","C","D"], "intrus": 2, "explication": "..." }] }\n5 a 8 series de 4 elements.\nATTENTION : "intrus" est un index 0-based. Pour 4 elements, les index valides sont 0, 1, 2, 3 (PAS 4).',
        pendu: 'Genere un exercice "pendu" pour le module PSE [MODULE] en JSON.\nFormat : { "consigne": "...", "mots": [{ "mot": "MOT_MAJUSCULES", "indice": "...", "explication": "Explication pedagogique (optionnel)" }] }\n8 a 12 mots en MAJUSCULES sans accents.\nAjoute une explication pour chaque mot pour aider l\'eleve a comprendre la notion.',
        mots_croises: 'Genere un exercice "mots croises" pour le module PSE [MODULE] en JSON.\nFormat : { "consigne": "...", "mots": [{ "mot": "MOT_MAJUSCULES", "definition": "...", "explication": "Explication pedagogique (optionnel)" }] }\n6 a 10 mots MAJUSCULES sans accents.\nAjoute une explication pour chaque mot pour aider l\'eleve a comprendre la notion.',
        swipe_vf: 'Genere un exercice "vrai/faux" pour le module PSE [MODULE] en JSON.\nFormat : { "consigne": "...", "affirmations": [{ "texte": "...", "reponse": true/false, "explication": "..." }] }\n10 a 15 affirmations.',
        qcm_image: 'Genere un exercice "QCM image" pour le module PSE [MODULE] en JSON.\n\nFormat : {\n  "consigne": "...",\n  "questions": [{\n    "image": "URL_OU_CHEMIN",\n    "question": "...",\n    "choix": ["A","B","C","D"],\n    "correct": 0,\n    "explication": "..."\n  }]\n}\n\nIMAGES ‚Äî 2 options :\n1. Si l\'utilisateur fournit des URLs d\'images ‚Üí les utiliser directement dans le champ "image"\n2. Si pas d\'URLs ‚Üí laisser "image": "" (l\'enseignant ajoutera les images apres import)\n\nLe champ "image" accepte :\n- Une URL complete (https://...)\n- Un chemin relatif GitHub (images/exercices/nom.jpg)\n\n3 a 5 questions.\nATTENTION : "correct" est un index 0-based. Pour 4 choix, les index valides sont 0, 1, 2, 3 (PAS 4).\nVocabulaire adapte CAP/Bac Pro.',
        tableau: 'Genere un exercice "tableau" pour le module PSE [MODULE] en JSON.\nFormat : { "consigne": "...", "colonnes": ["Col1","Col2"], "lignes": [{ "cellules": ["val", "{{trou}}"] }], "explication": "Explication pedagogique (optionnel)" }\nCellules entre {{ }} = trous. 4-6 lignes, 3-4 colonnes.\nAjoute une explication pedagogique pour aider l\'eleve a comprendre la logique du classement.',
        etude_cas: 'Genere une "etude de cas" pour le module PSE [MODULE] en JSON.\nFormat : { "consigne": "...", "scenario": "...", "questions": [{ "question": "...", "type": "qcm", "choix": ["A","B"], "correct": 0, "explication": "Pourquoi cette reponse..." }, { "question": "...", "type": "texte", "reponse": "...", "explication": "Explication pedagogique..." }] }\n3 a 5 questions.\nIMPORTANT : Ajoute une explication pedagogique pour chaque question. L\'explication s\'affiche a l\'eleve apres correction pour l\'aider a comprendre.',
        prevention: 'Genere un exercice "Mesures de prevention" pour le module PSE [MODULE] en JSON.\nLa situation doit decrire un professionnel expose a un danger identifie (3-5 phrases realistes, max 500 caracteres).\nLe danger est deja identifie, l\'eleve doit trouver la bonne mesure pour chaque niveau de prevention.\n\nFormat STRICT :\n{\n  "titre": "Prevention - [metier/situation]",\n  "situation": "...",\n  "danger": "...",\n  "niveaux": [\n    { "niveau": "supprimer", "label": "Supprimer le risque", "bonne_reponse": "...", "distracteurs": ["d1","d2","d3"] },\n    { "niveau": "reduire", "label": "Reduire le risque a la source", "bonne_reponse": "...", "distracteurs": ["d1","d2","d3"] },\n    { "niveau": "collective", "label": "Protection collective", "bonne_reponse": "...", "distracteurs": ["d1","d2","d3"] },\n    { "niveau": "individuelle", "label": "Protection individuelle (EPI)", "bonne_reponse": "...", "distracteurs": ["d1","d2","d3"] },\n    { "niveau": "formation", "label": "Information et formation", "bonne_reponse": "...", "distracteurs": ["d1","d2","d3"] }\n  ]\n}\n\nREGLES CRUCIALES :\n- 5 niveaux dans cet ordre : supprimer > reduire > collective > individuelle > formation\n- Exactement 3 distracteurs par niveau (tableaux JSON)\n- Les distracteurs doivent etre des VRAIES mesures de prevention mais du MAUVAIS niveau\n  Ex: pour "Supprimer", un distracteur peut etre "Porter des gants" (qui est un EPI, pas une suppression)\n- Chaque mesure max 120 caracteres, distracteurs max 80 caracteres\n- Vocabulaire simple adapte a des eleves de CAP/Bac Pro\n- Le principe cle : plus on agit a la source, plus c\'est efficace\n  Supprimer > Reduire > Collectif > Individuel > Formation\n- JAMAIS de mesure vague comme "faire attention" ou "etre vigilant"\n- Chaque mesure doit etre CONCRETE et APPLICABLE\n- Ajoute un champ "explication" (optionnel) avec une explication pedagogique globale pour aider l\'eleve a comprendre la hierarchie des mesures.',
        pad: 'Genere un exercice PAD (Processus d\'Apparition du Dommage) pour le module PSE [MODULE] en JSON.\nLa situation doit decrire un professionnel dans son activite de travail (3-5 phrases realistes, max 500 caracteres).\nFormat STRICT :\n{\n  "titre": "PAD - [metier/situation]",\n  "situation": "...",\n  "danger": "..." (max 80 car),\n  "distracteurs_danger": ["dist1", "dist2", "dist3"],\n  "situation_dangereuse": "..." (max 120 car),\n  "distracteurs_situation_dangereuse": ["dist1", "dist2", "dist3"],\n  "evenement_declencheur": "..." (max 120 car),\n  "distracteurs_evenement_declencheur": ["dist1", "dist2", "dist3"],\n  "dommage": "..." (max 120 car),\n  "distracteurs_dommage": ["dist1", "dist2", "dist3"]\n}\nREGLES :\n- Exactement 3 distracteurs par champ (tableaux JSON, pas de CSV)\n- Distracteurs credibles dans le meme univers professionnel mais faux pour CETTE situation\n- Distracteurs tous differents entre eux et differents de la bonne reponse\n- Chaque distracteur max 80 caracteres\n- Vocabulaire simple adapte a des eleves de Bac Pro\n- Coherence PAD : Danger ‚Üí exposition = Situation dangereuse ‚Üí bascule = Evenement declencheur ‚Üí consequence = Dommage\n- Ajoute un champ "explication" (optionnel) avec une explication pedagogique pour aider l\'eleve a comprendre la chaine PAD.',
        estimation_risque: 'Genere un exercice "Estimation du risque" pour le module PSE [MODULE] en JSON.\nLa situation doit decrire un professionnel expose a un danger dans son activite de travail (3-5 phrases realistes, max 500 caracteres).\nLa situation DOIT contenir des indices permettant a l\'eleve de determiner :\n- La GRAVITE du dommage (1 a 4)\n- La FREQUENCE/DUREE d\'exposition (rare/courte OU frequente/longue)\n- La PROBABILITE du declencheur (faible OU elevee)\n\nFormat STRICT :\n{\n  "titre": "Estimation du risque - [metier] / [danger]",\n  "situation": "...",\n  "danger": "..." (max 100 car),\n  "dommage": "..." (max 100 car),\n  "gravite": [1-4],\n  "exposition": "[rare_courte|frequente_longue]",\n  "declencheur": "[faible|eleve]",\n  "priorite": "[prioritaire|non_prioritaire]"\n}\n\nECHELLE DE GRAVITE :\n1 = Faible (accident/maladie SANS arret de travail)\n2 = Moyenne (accident/maladie AVEC arret de travail)\n3 = Grave (incapacite permanente, sequelles)\n4 = Tres grave (deces possible)\n\nCALCUL DE LA PROBABILITE D\'OCCURRENCE :\n- rare_courte + faible ‚Üí probabilite 1 (tres improbable)\n- rare_courte + eleve ‚Üí probabilite 2 (improbable)\n- frequente_longue + faible ‚Üí probabilite 3 (probable)\n- frequente_longue + eleve ‚Üí probabilite 4 (tres probable)\n\nREGLE DE PRIORITE :\n- Si gravite + probabilite >= 5 ‚Üí "prioritaire"\n- Sinon ‚Üí "non_prioritaire"\n\nREGLES CRUCIALES :\n- La situation doit etre realiste et issue d\'un vrai metier\n- Les indices de frequence doivent etre clairs (ex: "chaque jour pendant 6h" = frequente_longue, "une fois par trimestre" = rare_courte)\n- Les indices de declencheur doivent etre clairs (ex: "systeme de securite defaillant" = eleve, "equipement en bon etat et controle" = faible)\n- Les indices de gravite doivent etre coherents avec le dommage annonce\n- Vocabulaire simple adapte a des eleves de CAP/Bac Pro\n- La priorite DOIT correspondre au calcul : gravite + probabilite >= 5',
        duerp_ligne: 'Genere un exercice DUERP (Document Unique) ligne unique pour le module PSE [MODULE] en JSON.\nLa situation doit decrire un professionnel dans son activite (3-5 phrases realistes, max 500 car).\nLa situation DOIT contenir des indices pour : gravite, frequence/duree d\'exposition, probabilite du declencheur.\n\nFormat STRICT :\n{\n  "titre": "DUERP - [metier] / [danger]",\n  "unite_travail": "[poste ou activite]",\n  "situation": "...",\n  "choix": {\n    "danger": ["bonne reponse", "distracteur1", "distracteur2", "distracteur3"],\n    "dommage": ["bonne reponse", "distracteur1", "distracteur2", "distracteur3"],\n    "mesure_principale": ["bonne reponse", "dist1", "dist2", "dist3", "dist4"]\n  },\n  "attendus": {\n    "danger": "...",\n    "dommage": "...",\n    "gravite": [1-4],\n    "exposition": "[rare_courte|frequente_longue]",\n    "declencheur": "[faible|eleve]",\n    "mesure_principale": "..."\n  }\n}\n\nNE PAS inclure probabilite ni priorite dans le JSON (calculees automatiquement).\n\nREGLES :\n- Exactement 4 choix danger (1 correct + 3 distracteurs plausibles dans le meme metier)\n- Exactement 4 choix dommage (1 correct + 3 distracteurs)\n- Exactement 5 choix mesure (1 correct + 4 distracteurs) ‚Äî privilegier la source > collectif > EPI\n- Tous les choix doivent etre uniques et differents entre eux\n- Gravite : 1=sans arret, 2=avec arret, 3=sequelles, 4=deces\n- Exposition : rare_courte OU frequente_longue\n- Declencheur : faible OU eleve\n- Probabilite = expo x decl (rare+faible=1, rare+eleve=2, freq+faible=3, freq+eleve=4)\n- Priorite = gravite + probabilite >= 5\n- JAMAIS de mesure vague (faire attention, etre vigilant)',
        duerp_mini: 'Genere un exercice Mini DUERP (4 lignes) pour le module PSE [MODULE] en JSON.\nL\'exercice porte sur UNE SEULE entreprise avec 4 unites de travail differentes.\nChaque ligne = 1 situation professionnelle avec son danger et son dommage.\n\nFormat STRICT :\n{\n  "titre": "Mini DUERP - [entreprise]",\n  "entreprise": "[nom entreprise]",\n  "lignes": [\n    {\n      "id": "L1",\n      "unite_travail": "...",\n      "situation": "..." (3-5 phrases, max 500 car),\n      "choix": {\n        "danger": ["bonne", "dist1", "dist2", "dist3"],\n        "dommage": ["bonne", "dist1", "dist2", "dist3"]\n      },\n      "attendus": {\n        "danger": "...",\n        "dommage": "...",\n        "gravite": [1-4],\n        "exposition": "[rare_courte|frequente_longue]",\n        "declencheur": "[faible|eleve]"\n      }\n    }\n  ],\n  "mission_finale": {\n    "consigne": "Selectionnez les 2 risques prioritaires a traiter en premier",\n    "nb_prioritaires": 2\n  }\n}\n\nNE PAS inclure probabilite ni priorite.\n\nREGLES :\n- 4 lignes (L1 a L4) dans la meme entreprise\n- Varier les gravites et probabilites pour que certaines lignes soient prioritaires et d\'autres non\n- Au moins 2 lignes doivent etre prioritaires (gravite + proba >= 5)\n- Au moins 1 ligne doit etre non prioritaire\n- 4 choix danger et 4 choix dommage par ligne, tous plausibles\n- Situations realistes avec indices clairs\n- Vocabulaire CAP/Bac Pro',
        qcm_classique: 'Genere un exercice QCM classique pour le module PSE [MODULE] en JSON.\n\nFormat STRICT :\n{\n  "titre": "QCM - [theme]",\n  "question": "...",\n  "choix": [\n    { "id": "c1", "texte": "Bonne reponse" },\n    { "id": "c2", "texte": "Distracteur 1" },\n    { "id": "c3", "texte": "Distracteur 2" },\n    { "id": "c4", "texte": "Distracteur 3" }\n  ],\n  "reponse": "c1",\n  "multiple": false,\n  "explication": "Explication de la bonne reponse"\n}\n\nSi multiple: true ‚Üí "reponse": ["c1", "c3"]\n\nREGLES :\n- 4 choix minimum, chacun avec un id unique (c1, c2, c3, c4)\n- reponse = id du bon choix (pas le texte)\n- Distracteurs plausibles mais clairement faux\n- Question claire et sans ambiguite\n- Vocabulaire CAP/Bac Pro',
        quiz_chrono: 'Genere un exercice Quiz Chrono pour le module PSE [MODULE] en JSON.\n\nFormat STRICT :\n{\n  "titre": "Quiz Chrono - [theme]",\n  "temps_par_question": 15,\n  "questions": [\n    {\n      "question": "...",\n      "choix": [\n        { "id": "c1", "texte": "Bonne reponse" },\n        { "id": "c2", "texte": "Distracteur 1" },\n        { "id": "c3", "texte": "Distracteur 2" }\n      ],\n      "reponse": "c1",\n      "explication": "optionnel"\n    }\n  ]\n}\n\nREGLES :\n- 8 a 12 questions\n- 3 a 4 choix par question, IDs uniques par question (c1, c2, c3...)\n- reponse = id du bon choix\n- temps_par_question entre 10 et 20 secondes\n- Questions courtes et directes (l\'eleve a un timer)\n- Vocabulaire CAP/Bac Pro',
        categoriser: 'Genere un exercice de categorisation pour le module PSE [MODULE] en JSON.\n\nFormat STRICT :\n{\n  "titre": "Categoriser - [theme]",\n  "consigne": "Classez chaque element dans la bonne categorie",\n  "categories": ["Categorie A", "Categorie B", "Categorie C"],\n  "items": [\n    { "id": "i1", "label": "Item 1", "categorie": "Categorie A" },\n    { "id": "i2", "label": "Item 2", "categorie": "Categorie B" }\n  ]\n}\n\nREGLES :\n- 2 a 4 categories\n- 8 a 15 items avec IDs uniques (i1, i2, i3...)\n- Chaque item a un label et une categorie correspondant exactement a une des categories\n- Repartition equilibree entre categories\n- Items credibles mais clairement attribuables\n- Vocabulaire CAP/Bac Pro',
        memory: 'Genere un exercice Memory pour le module PSE [MODULE] en JSON.\n\nFormat STRICT :\n{\n  "titre": "Memory - [theme]",\n  "cartes": [\n    { "id": "p1", "a": "Terme", "b": "Definition" },\n    { "id": "p2", "a": "Terme 2", "b": "Definition 2" }\n  ]\n}\n\nREGLES :\n- 6 a 8 paires (cartes)\n- Chaque paire a un id unique (p1, p2, p3...)\n- Face "a" = terme court (1-3 mots)\n- Face "b" = definition courte (max 6-8 mots, doit tenir sur une carte)\n- Les termes doivent etre importants pour le module PSE\n- Vocabulaire CAP/Bac Pro',
        pictogramme: 'Genere un exercice sur les pictogrammes de securite pour le module PSE [MODULE] en JSON.\n\nIMPORTANT : Les images sont deja integrees dans l\'application. Tu n\'as PAS besoin de mettre les chemins d\'images dans le JSON. Le systeme lie automatiquement chaque pictogramme a son image via son ID.\n\n=== 6 CATEGORIES DISPONIBLES (81 pictogrammes) ===\n\nOBLIGATION (12) - Rond bleu :\nOB01: Port des gants obligatoire (OBLIGATION-gants.jpg)\nOB02: Port du casque obligatoire (OBLIGATION-casque.jpg)\nOB03: Chaussures de securite obligatoires (OBLIGATION-chaussures.jpg)\nOB04: Lunettes de protection obligatoires (OBLIGATION-lunettes.jpg)\nOB05: Visiere de protection obligatoire (OBLIGATION-visiere.jpg)\nOB06: Casque antibruit obligatoire (OBLIGATION-casque-antibruit.jpg)\nOB07: Protection des voies respiratoires obligatoire (OBLIGATION-protection-voies-espiratoires.jpg)\nOB08: Combinaison de protection obligatoire (OBLIGATION-combinaison.jpg)\nOB09: Harnais de securite obligatoire (OBLIGATION-harnais.jpg)\nOB10: Obligation generale (OBLIGATION-general.jpg)\nOB11: Consulter la notice obligatoire (OBLIGATION-consulter-notice.jpg)\nOB12: Passage obligatoire pour pietons (OBLIGATION-pieton.jpg)\n\nINTERDICTION (8) - Rond rouge barre :\nIN01: Interdiction de fumer (INTERDIT-fumer.jpg)\nIN02: Flamme nue interdite (INTERDIT-flamme.jpg)\nIN03: Acces interdit (INTERDIT-entrer.jpg)\nIN04: Defense de toucher (INTERDIT-toucher.jpg)\nIN05: Eau interdite sur ce materiel (INTERDIT-seau-eau.jpg)\nIN06: Interdit aux pietons (INTERDIT-pietons.jpg)\nIN07: Interdit aux chariots (INTERDIT-chariot.jpg)\nIN08: Interdiction de boire et manger (INTERDIT-boire.jpg)\n\nDANGER (20) - Triangle jaune :\nDA01: Danger electrique (DANGER-electricite.jpg)\nDA02: Danger de chute (DANGER-chute.jpg)\nDA03: Danger de trebuchement (DANGER-trebuchement.jpg)\nDA04: Danger general (DANGER-general.jpg)\nDA05: Produit inflammable (DANGER-produit-inflammable.jpg)\nDA06: Produit explosif (DANGER-produit-explosif.jpg)\nDA07: Produit toxique (DANGER-produit-toxique.jpg)\nDA08: Produit nocif / irritant (DANGER-produit-nocif.jpg)\nDA09: Produit corrosif (DANGER-produit-corrosif.jpg)\nDA10: Produit comburant (DANGER-comburant.jpg)\nDA11: Atmosphere explosive (DANGER-atmosphere-explosive.jpg)\nDA12: Risque biologique (DANGER-risque-biologique.jpg)\nDA13: Danger radioactif (DANGER-radioactivite.jpg)\nDA14: Radiations non ionisantes (DANGER-radiations-non-ionisantes.jpg)\nDA15: Danger laser (DANGER-laser.jpg)\nDA16: Charge suspendue (DANGER-charge-suspendue.jpg)\nDA17: Danger chariot (DANGER-chariot.jpg)\nDA18: Champ magnetique (DANGER-champ-magnetique.jpg)\nDA19: Danger froid / gel (DANGER-froid-gel.jpg)\nDA20: Bande de signalisation (DANGER-bande-signalisation.jpg)\n\nINCENDIE (14) - Carre rouge :\nIC01: Extincteur (INCENDIE-extincteur.jpg)\nIC02: Alarme incendie (INCENDIE-alarme.jpg)\nIC03: Lance a incendie (INCENDIE-lance.jpg)\nIC04: Echelle incendie (INCENDIE-echelle.jpg)\nIC05: Equipement incendie (INCENDIE-equipement.jpg)\nIC06: Telephone urgence incendie (INCENDIE-telephone.jpg)\nIC07-IC14: Fleches directionnelles incendie\n\nSECOURS (18) - Carre vert :\nSE01: Sortie de secours vers la droite (SECOURS-sortie-vers-droite.jpg)\nSE02: Sortie de secours vers la gauche (SECOURS-sortie-vers-gauche.jpg)\nSE03: Point de rassemblement (SECOURS-point-rassemblement.jpg)\nSE04: Defibrillateur (SECOURS-defibrillateur.jpg)\nSE05: Premiers secours (SECOURS-croix.jpg)\nSE06: Civiere (SECOURS-civiere.jpg)\nSE07: Douche de securite (SECOURS-douche-securite.jpg)\nSE08: Douche oculaire (SECOURS-douche-oeil.jpg)\nSE09: Telephone urgence secours (SECOURS-telephone-urgence.jpg)\nSE10: Refuge temporaire evacuation (SECOURS-refuge-temporaire-evacuation.jpg)\nSE11-SE18: Fleches directionnelles secours\n\nSGH - PRODUITS CHIMIQUES (9) - Losange rouge :\nSG01: Bombe explosante (SGH01_BombeExplosant.jpg)\nSG02: Flamme (SGH02_Flamme.jpg)\nSG03: Flamme sur cercle (SGH03_FlammeSurCercle.jpg)\nSG04: Bouteille de gaz (SGH04_BouteilleGaz.jpg)\nSG05: Corrosion (SGH05_Corrosion.jpg)\nSG06: Tete de mort (SGH06_TeteDeMort.jpg)\nSG07: Point d\'exclamation (SGH07_PointExclamation.jpg)\nSG08: Danger pour la sante (SGH08_DangerSante.jpg)\nSG09: Environnement (SGH09_Environnement.jpg)\n\n=== 6 MODES D\'EXERCICE ===\n\nMODE 1 - quiz_image : On montre l\'image, l\'eleve choisit le bon nom parmi 4\nMODE 2 - nom_vers_image : On donne le nom, l\'eleve choisit la bonne image parmi 4\nMODE 3 - categoriser : L\'eleve trie les pictogrammes dans les bonnes categories\nMODE 4 - memory : Retrouver les paires image/nom (jeu de memoire)\nMODE 5 - speed : Identifier un maximum de pictogrammes en 60 secondes\nMODE 6 - escape_game : Serie d\'epreuves enchainees a resoudre pour avancer\n\n=== FORMATS JSON PAR MODE ===\n\nPour les modes 1 a 5 (quiz_image, nom_vers_image, categoriser, memory, speed) :\n{\n  "consigne": "Identifie les pictogrammes de securite",\n  "mode": "quiz_image",\n  "nb": 8,\n  "categories": ["obligation", "interdiction", "danger", "incendie", "secours", "sgh"],\n  "explication": "Explication pedagogique (optionnel)"\n}\n\nPour le mode escape_game :\n{\n  "consigne": "Escape Game : Mission Securite !",\n  "mode": "escape_game",\n  "categories": ["obligation", "danger", "incendie", "sgh"],\n  "epreuves": [\n    {\n      "titre": "Epreuve 1 : Identification",\n      "type": "quiz_image",\n      "description": "Identifie ces pictogrammes pour obtenir le code",\n      "pictos": ["OB01", "DA03", "IC01", "SG06"]\n    },\n    {\n      "titre": "Epreuve 2 : Classement",\n      "type": "categoriser",\n      "description": "Trie ces pictogrammes pour deverrouiller la porte",\n      "pictos": ["OB02", "DA01", "IC02", "SE03", "SG02", "IN01"]\n    },\n    {\n      "titre": "Epreuve 3 : Memory",\n      "type": "memory",\n      "description": "Retrouve les paires pour obtenir la cle finale",\n      "pictos": ["DA05", "DA07", "SG05", "SG08", "IN02", "OB04"]\n    }\n  ],\n  "explication": "Les pictogrammes de securite sont essentiels pour prevenir les risques professionnels."\n}\n\nREGLES :\n- nb entre 4 et 81\n- categories : au moins 1 categorie parmi obligation, interdiction, danger, incendie, secours, sgh\n- Pour memory, nb recommande 6 a 10\n- Pour speed, nb recommande 15 a 30\n- Pour escape_game : 3 a 5 epreuves, chaque epreuve a un type (quiz_image, nom_vers_image, categoriser, memory) et une liste de pictos (IDs)\n- Les IDs des pictos doivent correspondre a ceux listes ci-dessus (OB01, DA03, SG06, etc.)\n- Vocabulaire CAP/Bac Pro',
        analyse_copie: 'Genere un exercice "Analyse de copie" pour le module PSE [MODULE] en JSON.\n\nCONCEPT : L\'eleve devient correcteur d\'une copie d\'examen PSE. Il doit analyser chaque reponse d\'un eleve fictif et evaluer 7 criteres.\n\n=== COMPETENCES EVALUABLES ===\nC2 ‚Äî Appliquer une demarche d\'analyse (identifier, analyser, reperer)\nC3 ‚Äî Expliquer un phenomene (expliquer, decrire, definir)\nC4 ‚Äî Proposer une solution (proposer, suggerer, recommander)\nC5 ‚Äî Argumenter un choix (argumenter, justifier, comparer)\nC6 ‚Äî Communiquer a l\'ecrit (communiquer, rediger, presenter)\n\n=== VERBES D\'ACTION ===\nidentifier, expliquer, proposer, argumenter, communiquer, appliquer\n\n=== 4 CRITERES C6 (pour les items ou competence = C6) ===\n1. Vocabulaire adapte (0 = inadapte, 1 = partiellement adapte, 2 = adapte)\n2. Syntaxe claire et correcte (0 = incomprehensible, 1 = partiellement claire, 2 = claire)\n3. Argumentation structuree (0 = absente, 1 = partiellement structuree, 2 = structuree)\n4. Mise en forme / presentation (0 = absente, 1 = partiellement soignee, 2 = soignee)\n\n=== FORMAT JSON ===\n{\n  "consigne": "Analyse cette copie d\'examen PSE et evalue chaque reponse",\n  "contexte": "Description du contexte de l\'examen (situation professionnelle, consignes...)",\n  "items": [\n    {\n      "question_examen": "La question posee a l\'eleve lors de l\'examen",\n      "reponse_eleve": "La reponse ecrite par l\'eleve fictif (peut etre bonne, partielle ou mauvaise)",\n      "verbes_proposes": ["identifier", "expliquer", "proposer", "argumenter"],\n      "attendus": {\n        "verbe": "identifier",\n        "competence": "C2",\n        "validee": "oui",\n        "niveau": 3,\n        "justification_mots_cles": ["danger", "electrique", "risque"],\n        "justification_modele": "C\'est C2 car je dois reperer et nommer le danger principal present dans la situation",\n        "c6": { "actif": false },\n        "amelioration_mots_cles": ["preciser", "source", "consequence"]\n      },\n      "explications": {\n        "resume": "Tu as bien identifie le danger mais il manque la source exacte.",\n        "attendu_pedagogique": "Le verbe identifier demande de reperer et nommer clairement un element precis dans la situation.",\n        "pourquoi_valide_ou_non": "La reponse est acceptable car l\'eleve a bien repere le danger, meme si la formulation manque de precision.",\n        "exemple_reponse_amelioree": "Le danger principal est le risque electrique lie aux cables denudes.",\n        "exemple_reponse_excellente": "Le danger identifie dans cette situation est le risque electrique cause par les cables denudes a proximite du poste de travail.",\n        "erreurs_frequentes": ["Confondre danger et risque", "Repondre par un dommage au lieu du danger", "Reponse trop vague sans nommer le danger"]\n      }\n    },\n    {\n      "question_examen": "Redige un compte-rendu des mesures de prevention",\n      "reponse_eleve": "faut mettre des gants et faire attention aux fils",\n      "verbes_proposes": ["communiquer", "rediger", "expliquer", "argumenter"],\n      "attendus": {\n        "verbe": "communiquer",\n        "competence": "C6",\n        "validee": "oui",\n        "niveau": 2,\n        "justification_mots_cles": ["communication", "redaction", "ecrit"],\n        "justification_modele": "C\'est C6 car la question demande de rediger un compte-rendu, ce qui releve de la communication ecrite",\n        "c6": {\n          "actif": true,\n          "criteres": [1, 1, 0, 0]\n        },\n        "amelioration_mots_cles": ["syntaxe", "vocabulaire", "structure", "presentation"]\n      },\n      "explications": {\n        "resume": "Le contenu est partiellement correct mais la forme ecrite est insuffisante.",\n        "attendu_pedagogique": "Le verbe communiquer demande de produire un ecrit structure, avec un vocabulaire professionnel adapte.",\n        "pourquoi_valide_ou_non": "La reponse mentionne des mesures mais la formulation est trop familiere et manque de structure.",\n        "exemple_reponse_amelioree": "Les mesures de prevention recommandees sont le port de gants isolants et la verification de l\'etat des cables.",\n        "erreurs_frequentes": ["Utiliser un langage familier", "Oublier la structure du compte-rendu", "Ne pas utiliser le vocabulaire professionnel"],\n        "explication_c6": {\n          "vocabulaire": "Le terme \'fils\' devrait etre remplace par \'cables electriques\' ou \'conducteurs\'.",\n          "syntaxe": "La phrase commence sans majuscule et manque de sujet. Ecrire des phrases completes.",\n          "argumentation": "Aucune justification des mesures proposees. Expliquer POURQUOI ces mesures.",\n          "presentation": "Pas de mise en forme : il faudrait des puces ou un tableau pour lister les mesures."\n        },\n        "exemple_reformulation": "Dans un compte-rendu professionnel, je structure mes idees avec des phrases completes et un vocabulaire technique adapte."\n      }\n    }\n  ],\n  "explication": "Explication pedagogique globale (optionnel)"\n}\n\n=== REGLES CRUCIALES ===\n1. 3 a 6 items par exercice\n2. Varier les competences : au moins 3 competences differentes, dont obligatoirement 1 item C6\n3. verbes_proposes : 4 verbes dont 1 seul est la bonne reponse\n4. validee : "oui" ou "non" (la reponse de l\'eleve est-elle acceptable ?)\n5. niveau : 1 (insuffisant), 2 (fragile), 3 (satisfaisant), 4 (excellent) ‚Äî seulement si validee="oui"\n6. justification_mots_cles : 2-4 mots-cles que l\'eleve-correcteur doit mentionner pour justifier son evaluation\n7. c6.actif : true UNIQUEMENT si competence = "C6"\n8. c6.criteres : tableau de 4 valeurs (0, 1 ou 2) correspondant aux 4 criteres C6\n9. amelioration_mots_cles : 2-4 mots-cles que l\'eleve-correcteur doit mentionner comme pistes d\'amelioration\n10. Les reponses de l\'eleve fictif doivent etre REALISTES (certaines bonnes, certaines mediocres, certaines mauvaises)\n11. Vocabulaire adapte CAP/Bac Pro\n12. Les questions d\'examen doivent etre en lien avec des situations professionnelles\n13. justification_modele (OBLIGATOIRE) : phrase modele montrant comment l\'eleve-correcteur devrait justifier son choix de competence. Commence par "C\'est CX car..."\n14. explications (OBLIGATOIRE pour chaque item) : objet contenant les champs suivants :\n    - resume (OBLIGATOIRE) : phrase courte resumant le feedback, visible directement sans ouvrir le detail\n    - attendu_pedagogique (OBLIGATOIRE) : explication de ce que le verbe d\'action demande concretement\n    - pourquoi_valide_ou_non (OBLIGATOIRE) : explication de pourquoi la reponse est jugee acceptable ou non\n    - exemple_reponse_amelioree (OBLIGATOIRE) : comment l\'eleve aurait pu mieux formuler sa reponse\n    - exemple_reponse_excellente (OPTIONNEL) : la reponse parfaite attendue, complete et exemplaire\n    - erreurs_frequentes (OBLIGATOIRE) : tableau de 2-4 erreurs typiques des eleves sur ce type de question\n15. Pour les items C6 uniquement, ajouter dans explications :\n    - explication_c6 : objet avec 4 cles (vocabulaire, syntaxe, argumentation, presentation) donnant un feedback texte pour chaque critere\n    - exemple_reformulation : phrase montrant comment reformuler correctement\n16. Le resume doit etre une phrase courte (max 15 mots) qui accroche l\'eleve\n17. Les explications doivent etre bienveillantes et constructives, adaptees a des eleves de CAP/Bac Pro\n18. Chaque explication doit etre specifique a la question et a la reponse de l\'eleve (pas de texte generique)',
        scenario: 'Genere un exercice Scenario interactif pour le module PSE [MODULE] en JSON.\n\nFormat STRICT :\n{\n  "titre": "Scenario - [situation]",\n  "etapes": [\n    {\n      "id": "debut",\n      "texte": "Description de la situation initiale...",\n      "choix": [\n        { "label": "Choix A (bon)", "suite": "etape2", "correct": true },\n        { "label": "Choix B (mauvais)", "suite": "bad1", "correct": false, "feedback": "Explication courte" }\n      ]\n    },\n    {\n      "id": "etape2",\n      "texte": "Suite de la situation...",\n      "choix": [\n        { "label": "Bon choix", "suite": "fin", "correct": true },\n        { "label": "Mauvais choix", "suite": "bad2", "correct": false, "feedback": "..." }\n      ]\n    },\n    { "id": "fin", "texte": "Bravo ! Vous avez gere la situation correctement.", "choix": [] },\n    { "id": "bad1", "texte": "Cette approche n\'est pas adaptee car [explication detaillee]. Vous pouvez reessayer.", "choix": [{ "label": "Reessayer", "suite": "debut", "correct": false }] },\n    { "id": "bad2", "texte": "Ce n\'est pas la bonne reaction car [explication]. Reessayez.", "choix": [{ "label": "Reessayer", "suite": "etape2", "correct": false }] }\n  ]\n}\n\nREGLES OBLIGATOIRES :\n- 4 a 8 etapes\n- Premiere etape id = "debut"\n- SEULE la fin reelle du scenario (bravo, reussite) a choix: []\n- Les etapes d\'erreur (bad*) NE DOIVENT PAS avoir choix: [] ! Elles doivent contenir au moins 1 choix de reprise :\n  { "label": "Reessayer", "suite": "etape_precedente", "correct": false }\n- Les explications d\'erreur doivent etre dans le champ texte de l\'etape bad (pas seulement dans feedback)\n- Le feedback des mauvais choix n\'est visible que brievement : mettre l\'essentiel dans texte de l\'etape bad\n- Chaque choix.suite pointe vers un id existant\n- Pas de boucles infinies (max 30 etapes parcourues)\n- 2-3 choix par etape\n- correct: true/false pour le scoring\n- feedback obligatoire pour les mauvais choix\n- Situation realiste et professionnelle\n- Vocabulaire CAP/Bac Pro'
    };

    window.openImportModal = function() {
        const type = document.getElementById('exo-type').value;
        document.getElementById('import-prompt-guide').textContent = 'üí° Prompt a copier dans ChatGPT/Claude :\n\n' + (PROMPTS[type] || '');
        document.getElementById('import-json-guide').textContent = 'Format JSON attendu pour "' + (TYPE_LABELS[type] || type) + '"';
        document.getElementById('import-json-input').value = '';
        document.getElementById('import-error').style.display = 'none';
        document.getElementById('import-modal').classList.add('show');
    };
    window.closeImportModal = function() {
        document.getElementById('import-modal').classList.remove('show');
    };
    // ========== VALIDATION / AUTO-REPAIR SCENARIO ==========
    function fixScenarioData(data) {
        if (!data || !Array.isArray(data.etapes)) return data;
        const warnings = [];
        const etapeIds = data.etapes.map(e => e.id);
        data.etapes.forEach(etape => {
            // Detect bad steps with empty choices (terminal errors)
            if (etape.id && etape.id.startsWith('bad') && (!etape.choix || etape.choix.length === 0)) {
                // Find which step points to this bad step ‚Üí use it as retry target
                let retourId = 'debut';
                for (const et of data.etapes) {
                    if (et.choix && et.choix.some(ch => ch.suite === etape.id)) {
                        retourId = et.id;
                        break;
                    }
                }
                etape.choix = [{ label: 'Reessayer', suite: retourId, correct: false, feedback: '' }];
                warnings.push('Etape "' + etape.id + '" avait choix:[] ‚Üí ajout bouton Reessayer vers "' + retourId + '"');
            }
            // Verify all choix.suite point to existing etape ids
            if (etape.choix) {
                etape.choix.forEach(ch => {
                    if (ch.suite && !etapeIds.includes(ch.suite)) {
                        warnings.push('Etape "' + etape.id + '" : choix "' + ch.label + '" pointe vers "' + ch.suite + '" qui n\'existe pas');
                    }
                });
            }
        });
        return { data, warnings };
    }

    window.doImportJSON = function() {
        let raw = document.getElementById('import-json-input').value.trim();
        const errorEl = document.getElementById('import-error');
        // Nettoyer les guillemets courbes (ChatGPT/Word) ‚Üí guillemets droits
        raw = raw.replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g, '"').replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g, "'");
        try {
            let data = JSON.parse(raw);
            const type = document.getElementById('exo-type').value;
            // Auto-repair scenario data if needed
            if (type === 'scenario' && data.etapes) {
                const result = fixScenarioData(data);
                data = result.data;
                if (result.warnings.length > 0) {
                    showToast('‚ö†Ô∏è Scenario repare : ' + result.warnings.length + ' correctif(s) applique(s)', 5000);
                    console.warn('Scenario auto-repair:', result.warnings);
                }
            }
            setContenuInForm(type, data);
            closeImportModal();
            showToast('JSON importe !');
        } catch(e) {
            errorEl.textContent = 'JSON invalide : ' + e.message;
            errorEl.style.display = 'block';
        }
    };

    // ========== IMPORT DEPUIS BIBLIOTHEQUE (sessionStorage) ==========
    (function checkBiblioImport() {
        const importData = sessionStorage.getItem('biblio_import');
        if (!importData) return;
        const cat = sessionStorage.getItem('biblio_categorie');
        sessionStorage.removeItem('biblio_import');
        sessionStorage.removeItem('biblio_categorie');
        if (cat !== 'exercice') return;
        try {
            const data = JSON.parse(importData);
            // Double compatibilite wrapper Firestore
            const src = data.contenu || data;
            // Detect type from JSON keys
            let type = 'prevention';
            if (src.niveaux && src.danger) type = 'prevention';
            else if (Array.isArray(src.lignes) && src.lignes.length > 0) type = 'duerp_mini';
            else if (src.unite_travail && src.choix && src.attendus) type = 'duerp_ligne';
            else if (src.exposition && src.declencheur && src.gravite) type = 'estimation_risque';
            else if (src.distracteurs_danger) type = 'pad';
            else if (Array.isArray(src.items) && src.items.length > 0 && src.items[0].attendus && src.items[0].attendus.verbe && src.items[0].attendus.competence) type = 'analyse_copie';
            else if (src.mode && Array.isArray(src.categories) && ['quiz_image','nom_vers_image','categoriser','memory','speed','escape_game'].includes(src.mode) && (typeof src.nb === 'number' || src.mode === 'escape_game')) type = 'pictogramme';
            else if (Array.isArray(src.etapes) && src.etapes[0] && typeof src.etapes[0].id === 'string') type = 'scenario';
            else if (Array.isArray(src.cartes) && src.cartes[0] && src.cartes[0].a !== undefined && src.cartes[0].b !== undefined) type = 'memory';
            else if (Array.isArray(src.categories) && Array.isArray(src.items) && src.items[0] && src.items[0].id !== undefined && src.items[0].categorie !== undefined) type = 'categoriser';
            else if (Array.isArray(src.questions) && typeof src.temps_par_question === 'number') type = 'quiz_chrono';
            else if (typeof src.question === 'string' && Array.isArray(src.choix) && src.reponse !== undefined) type = 'qcm_classique';
            else if (src.texte && src.texte.includes('{{')) type = 'texte_trous';
            else if (src.paires) type = 'relier';
            else if (src.items && !src.questions) type = 'ordre';
            else if (src.series) type = 'intrus';
            else if (src.mots && src.mots[0] && src.mots[0].indice !== undefined) type = 'pendu';
            else if (src.mots && src.mots[0] && src.mots[0].definition !== undefined) type = 'mots_croises';
            else if (src.affirmations) type = 'swipe_vf';
            else if (src.questions && src.questions[0] && src.questions[0].image !== undefined) type = 'qcm_image';
            else if (src.colonnes && src.lignes) type = 'tableau';
            else if (src.scenario) type = 'etude_cas';
            // Auto-repair scenario if needed
            if (type === 'scenario' && src.etapes) {
                const result = fixScenarioData(src);
                if (result.warnings.length > 0) {
                    console.warn('Biblio scenario auto-repair:', result.warnings);
                }
            }
            // Set type and populate form
            document.getElementById('exo-type').value = type;
            onTypeChange();
            setContenuInForm(type, src);
            showToast('üìö Import√© depuis la biblioth√®que !');
        } catch(e) { console.error('Erreur import biblio:', e); }
    })();

    // ========== TOAST ==========
    function showToast(msg, duration) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, duration || 2500);
    }
</script>
</body>
</html>

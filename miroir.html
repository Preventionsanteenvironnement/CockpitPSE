<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÑ Miroir de Copie</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .header-subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn-header {
            padding: 10px 16px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .meta-item {
            background: rgba(255,255,255,0.15);
            padding: 14px 18px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .meta-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .meta-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* Contenu copie */
        .copie-content {
            background: var(--card);
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .copie-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 24px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copie-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
        }

        .copie-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-corrected {
            background: #dcfce7;
            color: #166534;
        }

        .questions-list {
            padding: 30px;
        }

        /* Question card */
        .question-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .question-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .question-header {
            background: white;
            padding: 18px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-num {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .question-badge {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1rem;
        }

        .question-label {
            font-weight: 700;
            color: var(--text);
            font-size: 1.05rem;
        }

        .question-type {
            font-size: 0.8rem;
            color: var(--text-muted);
            background: #f1f5f9;
            padding: 4px 10px;
            border-radius: 6px;
        }

        .question-body {
            padding: 20px 24px;
        }

        /* Types de r√©ponses */
        .reponse-text {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text);
            min-height: 60px;
        }

        .reponse-text.empty {
            color: var(--text-muted);
            font-style: italic;
        }

        .reponse-choice {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .reponse-choice.selected {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .reponse-choice.correct {
            border-color: var(--success);
            background: #f0fdf4;
        }

        .reponse-choice.incorrect {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .choice-indicator {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .choice-indicator.checked {
            background: var(--primary);
            color: white;
        }

        .choice-indicator.unchecked {
            background: #f1f5f9;
            color: var(--text-muted);
        }

        .choice-text {
            flex: 1;
            font-size: 0.95rem;
        }

        /* Correction */
        .correction-box {
            margin-top: 16px;
            padding: 16px 20px;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .correction-box.positive {
            background: #f0fdf4;
            border-color: var(--success);
        }

        .correction-box.negative {
            background: #fef2f2;
            border-color: var(--danger);
        }

        .correction-box.neutral {
            background: #fef3c7;
            border-color: var(--warning);
        }

        .correction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .correction-label {
            font-weight: 700;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .correction-points {
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .correction-comment {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Section Analyse Collages */
        .collages-section {
            margin-top: 24px;
            padding: 24px 30px;
            background: #fffbeb;
            border-top: 1px solid #fcd34d;
        }

        .collages-title {
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #92400e;
        }

        .collages-empty {
            color: var(--text-muted);
            font-style: italic;
        }

        .collage-item {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .collage-external {
            border-color: #fca5a5;
            background: #fef2f2;
        }

        .collage-internal {
            border-color: #86efac;
            background: #f0fdf4;
        }

        /* Footer r√©capitulatif */
        .footer-recap {
            background: var(--card);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 24px 30px;
            margin-top: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .recap-item {
            text-align: center;
        }

        .recap-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .recap-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Print */
        @media print {
            body { background: white; padding: 0; }
            .header { box-shadow: none; }
            .btn-header { display: none; }
            .question-card:hover { border-color: var(--border); box-shadow: none; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            body { padding: 12px; }
            .header { padding: 20px; border-radius: 16px; }
            .header h1 { font-size: 1.4rem; }
            .meta-grid { grid-template-columns: 1fr 1fr; }
            .questions-list { padding: 16px; }
            .question-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .footer-recap { flex-direction: column; text-align: center; }
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            color: var(--text-muted);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Chargement de la copie...</p>
            </div>
        </div>
    </div>

    <script>
        // R√©cup√©rer les donn√©es depuis localStorage
        let copieData = null;

        function init() {
            try {
                const transfert = localStorage.getItem('cockpit_miroir');
                if (transfert) {
                    copieData = JSON.parse(transfert);
                    afficherCopie();
                } else {
                    afficherErreur("Aucune copie √† afficher. Ouvrez cette page depuis le Cockpit.");
                }
            } catch (e) {
                console.error("Erreur:", e);
                afficherErreur("Erreur lors du chargement de la copie.");
            }
        }

        function afficherErreur(message) {
            document.getElementById('content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <p>${message}</p>
                    <button onclick="window.close()" style="margin-top:20px;padding:12px 24px;background:var(--primary);color:white;border:none;border-radius:10px;cursor:pointer;font-weight:600;">
                        Fermer
                    </button>
                </div>
            `;
        }

        function afficherCopie() {
            const d = copieData;
            
            // Extraire les infos
            const identifiant = d.identifiant || d.eleveCode || d.userCode || "√âl√®ve";
            const classe = d.classe || d.eleve?.classe || "?";
            const titre = d.exercice_titre || d.titre || d.devoirId || "Devoir";
            const reponses = d.reponses || d.raw?.reponses || {};
            const pasteStats = d.pasteStats || d.raw?.pasteStats || null;
            const corrections = d.corrections || d.raw?.corrections || {};
            const noteFinale = d.note_finale ?? d.raw?.note_finale ?? null;
            const competences = d.competences || d.raw?.competences || {};
            
            // Formater la date
            let dateStr = "-";
            if (d.date instanceof Date) {
                dateStr = d.date.toLocaleString('fr-FR');
            } else if (d.date) {
                dateStr = new Date(d.date).toLocaleString('fr-FR');
            } else if (d.raw?.createdAtISO) {
                dateStr = new Date(d.raw.createdAtISO).toLocaleString('fr-FR');
            }
            
            // Temps
            let tempsStr = "-";
            if (d.temps_secondes) {
                const min = Math.floor(d.temps_secondes / 60);
                const sec = d.temps_secondes % 60;
                tempsStr = `${min}min ${sec}s`;
            }
            
            // Statut correction
            const isCorrige = noteFinale !== null && noteFinale !== "--";
            
            // Construire le HTML
            let html = `
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h1>üìÑ Copie de ${escapeHtml(identifiant)}</h1>
                            <div class="header-subtitle">${escapeHtml(titre)}</div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-header" onclick="window.print()">üñ®Ô∏è Imprimer</button>
                            <button class="btn-header" onclick="window.close()">‚úï Fermer</button>
                        </div>
                    </div>
                    <div class="meta-grid">
                        <div class="meta-item">
                            <div class="meta-label">Classe</div>
                            <div class="meta-value">${escapeHtml(classe)}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Date</div>
                            <div class="meta-value">${dateStr}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Temps</div>
                            <div class="meta-value">${tempsStr}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Note</div>
                            <div class="meta-value">${isCorrige ? noteFinale + '/20' : 'En attente'}</div>
                        </div>
                    </div>
                </div>

                <div class="copie-content">
                    <div class="copie-header">
                        <span class="copie-title">üìù R√©ponses de l'√©l√®ve</span>
                        <span class="copie-badge ${isCorrige ? 'badge-corrected' : 'badge-pending'}">
                            ${isCorrige ? '‚úÖ Corrig√©' : '‚è≥ En attente de correction'}
                        </span>
                    </div>
                    <div class="questions-list">
            `;
            
            // Trier et afficher les questions
            const questionsKeys = Object.keys(reponses).sort((a, b) => {
                // Trier Q1, Q2, Q3, Q1_a, Q1_b, etc.
                const numA = parseInt(a.replace(/\D/g, '')) || 0;
                const numB = parseInt(b.replace(/\D/g, '')) || 0;
                if (numA !== numB) return numA - numB;
                return a.localeCompare(b);
            });
            
            if (questionsKeys.length === 0) {
                html += `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <p>Aucune r√©ponse enregistr√©e</p>
                    </div>
                `;
            } else {
                questionsKeys.forEach((key, index) => {
                    const reponse = reponses[key];
                    const correction = corrections[key] || null;
                    
                    // D√©terminer le type de r√©ponse
                    const isBoolean = typeof reponse === 'boolean' || reponse === 'true' || reponse === 'false';
                    const reponseAffichee = isBoolean 
                        ? (reponse === true || reponse === 'true' ? '‚úÖ Oui / Vrai' : '‚ùå Non / Faux')
                        : (reponse || '(vide)');
                    
                    // Classe CSS pour la correction
                    let correctionClass = 'neutral';
                    if (correction) {
                        if (correction.points > 0) correctionClass = 'positive';
                        else if (correction.points === 0) correctionClass = 'negative';
                    }
                    
                    html += `
                        <div class="question-card">
                            <div class="question-header">
                                <div class="question-num">
                                    <div class="question-badge">${key.replace('Q', '').replace('_', '.')}</div>
                                    <span class="question-label">Question ${key}</span>
                                </div>
                                <span class="question-type">${isBoolean ? 'Vrai/Faux' : 'R√©ponse libre'}</span>
                            </div>
                            <div class="question-body">
                                <div class="reponse-text ${!reponse ? 'empty' : ''}">
                                    ${escapeHtml(reponseAffichee.toString())}
                                </div>
                                ${correction ? `
                                    <div class="correction-box ${correctionClass}">
                                        <div class="correction-header">
                                            <span class="correction-label">
                                                ${correctionClass === 'positive' ? '‚úÖ' : correctionClass === 'negative' ? '‚ùå' : 'üí°'} 
                                                Correction
                                            </span>
                                            <span class="correction-points" style="background:${correctionClass === 'positive' ? '#dcfce7' : correctionClass === 'negative' ? '#fee2e2' : '#fef3c7'}; color:${correctionClass === 'positive' ? '#166534' : correctionClass === 'negative' ? '#991b1b' : '#92400e'}">
                                                ${correction.points ?? '-'} pts
                                            </span>
                                        </div>
                                        ${correction.commentaire ? `<div class="correction-comment">${escapeHtml(correction.commentaire)}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `</div>`; // Fin questions-list
            
            // Section Collages
            html += `
                <div class="collages-section">
                    <div class="collages-title">üìã Analyse des collages (copier-coller)</div>
            `;
            
            if (!pasteStats || (!pasteStats.events?.length && !pasteStats.total)) {
                html += `<p class="collages-empty">‚úÖ Aucun collage d√©tect√© ou pas de donn√©es</p>`;
            } else {
                const external = pasteStats.external || 0;
                const internal = pasteStats.internal || 0;
                
                html += `
                    <div style="display:flex;gap:16px;margin-bottom:16px;">
                        <div style="background:white;padding:12px 20px;border-radius:10px;border:1px solid ${external > 0 ? '#fca5a5' : '#e2e8f0'};">
                            <div style="font-size:1.5rem;font-weight:800;color:${external > 0 ? '#dc2626' : '#10b981'};">${external}</div>
                            <div style="font-size:0.8rem;color:#64748b;">Externes</div>
                        </div>
                        <div style="background:white;padding:12px 20px;border-radius:10px;border:1px solid #e2e8f0;">
                            <div style="font-size:1.5rem;font-weight:800;color:#64748b;">${internal}</div>
                            <div style="font-size:0.8rem;color:#64748b;">Internes</div>
                        </div>
                    </div>
                `;
                
                if (pasteStats.events?.length > 0) {
                    pasteStats.events.forEach(ev => {
                        const time = ev.timestamp ? new Date(ev.timestamp).toLocaleTimeString('fr-FR') : '-';
                        const isExt = ev.isExternal;
                        html += `
                            <div class="collage-item ${isExt ? 'collage-external' : 'collage-internal'}">
                                <div>
                                    <span style="font-weight:600;">${isExt ? 'üåê Externe' : 'üìù Interne'}</span>
                                    <span style="color:#64748b;margin-left:8px;">${time}</span>
                                </div>
                                <div style="color:#64748b;">${ev.length || '?'} caract√®res</div>
                            </div>
                        `;
                    });
                }
            }
            
            html += `</div></div>`; // Fin collages-section et copie-content
            
            // Comp√©tences si disponibles
            if (Object.keys(competences).length > 0) {
                html += `
                    <div class="footer-recap">
                        <div style="font-weight:700;color:var(--text);">üéØ Comp√©tences √©valu√©es</div>
                        <div style="display:flex;gap:12px;flex-wrap:wrap;">
                `;
                for (let c in competences) {
                    const val = competences[c];
                    html += `
                        <div class="recap-item" style="background:#f1f5f9;padding:10px 16px;border-radius:10px;">
                            <div style="font-size:1.2rem;font-weight:800;color:${val >= 2 ? '#10b981' : val >= 1 ? '#f59e0b' : '#ef4444'};">${val ?? '-'}/3</div>
                            <div style="font-size:0.75rem;color:#64748b;">${c}</div>
                        </div>
                    `;
                }
                html += `</div></div>`;
            }
            
            document.getElementById('content').innerHTML = html;
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text.toString();
            return div.innerHTML;
        }

        // Initialiser
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

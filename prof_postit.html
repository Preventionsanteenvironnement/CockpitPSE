<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Post-it Manager - Prof</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Kalam:wght@700&display=swap" rel="stylesheet">
    <style>
        /* BASE & LAYOUT (Comme Nuage) */
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: white; display: flex; height: 100vh; overflow: hidden; user-select: none; }
        
        /* SIDEBAR */
        .sidebar { width: 340px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 50; flex-shrink: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
        .sidebar-header { padding: 15px; background: #0f172a; border-bottom: 1px solid #334155; display:flex; justify-content:space-between; align-items:center; }
        
        /* SECTIONS SIDEBAR */
        .sidebar-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; border-bottom: 1px solid #334155; }
        .sec-head { padding: 10px 15px; background: #162032; border-bottom: 1px solid #334155; font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .sec-list { flex: 1; overflow-y: auto; padding: 10px; }

        /* INPUTS & BOUTONS */
        .control-input { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 6px; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; margin-top: 5px; }
        .btn-blue { background: #3b82f6; color: white; } .btn-blue:hover { background: #2563eb; }
        .btn-red { background: #ef4444; color: white; } .btn-red:hover { background: #dc2626; }

        /* CARTE EN ATTENTE */
        .idea-card { background: #334155; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 5px solid #ccc; animation: slideIn 0.3s; }
        .idea-info { font-size: 0.8rem; color: #94a3b8; font-weight: bold; margin-bottom: 5px; }
        .idea-text { font-size: 1rem; color: white; margin-bottom: 8px; font-family: 'Kalam', cursive; }
        .card-actions { display: flex; gap: 5px; }
        .btn-card { border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1; color: white; }

        /* PRESENTS */
        .student-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #334155; font-size: 0.9rem; }
        .mega-btn { background: #f59e0b; border: none; border-radius: 4px; cursor: pointer; padding: 4px 8px; }

        /* MAIN BOARD */
        .board { flex-grow: 1; position: relative; overflow: hidden; background-color: #0f172a; background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 20px 20px; cursor: grab; }
        .board:active { cursor: grabbing; }

        /* QUESTION DISPLAY */
        #display-question { position: absolute; top: 80px; left: 0; right: 0; text-align: center; font-size: 2.5rem; font-weight: 800; color: rgba(255,255,255,0.1); pointer-events: none; user-select: none; z-index: 0; text-transform: uppercase; padding: 0 20px; }

        /* POST-IT STYLE */
        .postit { position: absolute; width: 180px; min-height: 150px; padding: 15px; box-shadow: 5px 5px 15px rgba(0,0,0,0.4); font-family: 'Kalam', cursive; font-size: 1.1rem; color: #1e293b; line-height: 1.2; display: flex; flex-direction: column; justify-content: center; text-align: center; transform: rotate(-1deg); transition: transform 0.2s; cursor: grab; animation: popIn 0.3s; }
        .postit:hover { transform: scale(1.05) rotate(0deg); z-index: 100 !important; box-shadow: 10px 10px 25px rgba(0,0,0,0.5); }
        .postit .author { font-family: 'Inter', sans-serif; font-size: 0.6rem; text-transform: uppercase; opacity: 0.6; margin-bottom: 5px; font-weight: bold; }
        .delete-pin { position: absolute; top: -10px; right: -10px; width: 25px; height: 25px; background: #ef4444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; opacity: 0; border: 2px solid white; transition: 0.2s; font-family: 'Inter', sans-serif; }
        .postit:hover .delete-pin { opacity: 1; }

        /* COLORS */
        .c-yellow { background: #fef08a; border-left-color: #facc15; } .postit.c-yellow { transform: rotate(1deg); }
        .c-green { background: #bbf7d0; border-left-color: #4ade80; } .postit.c-green { transform: rotate(-2deg); }
        .c-blue { background: #bfdbfe; border-left-color: #60a5fa; } .postit.c-blue { transform: rotate(2deg); }
        .c-pink { background: #fbcfe8; border-left-color: #f472b6; } .postit.c-pink { transform: rotate(-1deg); }

        /* WIDGETS */
        .btn-projection { position: absolute; top: 15px; left: 15px; z-index: 50; background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .ambient-widget { position: absolute; bottom: 20px; right: 20px; background: rgba(15, 23, 42, 0.9); padding: 10px; border-radius: 10px; display: flex; gap: 15px; align-items: center; z-index: 50; border: 1px solid #334155; }
        .chrono { font-family: monospace; font-size: 1.5rem; font-weight: bold; color: #3b82f6; cursor: pointer; width: 80px; text-align: center; }
        .chrono.alert { color: #ef4444; animation: pulse 1s infinite; }
        .sono-box { width: 100px; height: 10px; background: #334155; border-radius: 4px; overflow: hidden; }
        .sono-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #22c55e, #eab308, #ef4444); transition: width 0.1s; }

        @keyframes popIn { from { transform: scale(0) rotate(10deg); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 style="margin:0; font-size:1.1rem;">POST-IT PROF</h2>
            <button onclick="toggleLock()" id="btn-lock" style="background:none; border:1px solid #22c55e; color:#22c55e; padding:4px 10px; border-radius:4px; cursor:pointer; font-weight:bold;">üîì Ouvert</button>
        </div>
        
        <div style="padding:15px; border-bottom:1px solid #334155;">
            <input type="text" id="q-input" class="control-input" placeholder="Th√®me du brainstorming..." onchange="updateQuestion()">
            <button class="btn-action btn-blue" onclick="updateQuestion()">LANCER LE TH√àME</button>
        </div>

        <div class="sidebar-section">
            <div class="sec-head">
                <span>‚è≥ En Attente</span>
                <span onclick="clearWaiting()" style="cursor:pointer; color:#ef4444; font-size:0.7rem;">(Tout rejeter)</span>
            </div>
            <div id="waiting-room" class="sec-list"></div>
        </div>

        <div class="sidebar-section" style="flex:0.6;">
            <div class="sec-head">
                <span>üë• Pr√©sents <span id="student-count">(0)</span></span>
            </div>
            <div id="student-list" class="sec-list"></div>
        </div>

        <div style="padding:15px; border-top:1px solid #334155;">
            <button class="btn-action btn-red" onclick="resetAll()">üóëÔ∏è RESET TOTAL (VIDER)</button>
        </div>
    </div>

    <div class="board" id="board">
        <button class="btn-projection" onclick="toggleProjection()">üì∫ Mode Projection</button>
        
        <div id="display-question">...</div>

        <div class="ambient-widget">
            <div onclick="handleChronoClick()"><div class="chrono" id="chrono">00:00</div></div>
            <div style="display:flex; align-items:center;">
                <div class="sono-box"><div class="sono-bar" id="sono-bar"></div></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, setDoc, onSnapshot, query, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI", authDomain: "devoirs-pse.firebaseapp.com", projectId: "devoirs-pse", storageBucket: "devoirs-pse.firebasestorage.app", messagingSenderId: "614730413904", appId: "1:614730413904:web:a5dd478af5de30f6bede55" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let isProjection = new URLSearchParams(window.location.search).get('mode') === 'projection';
        if(isProjection) {
            document.getElementById('sidebar').style.display = 'none';
            document.querySelector('.btn-projection').style.display = 'none';
            document.getElementById('board').style.cursor = 'default';
        }

        // --- 1. CONFIG & QUESTION ---
        onSnapshot(doc(db, "postit_config", "global"), (snap) => {
            if(snap.exists()){
                const d = snap.data();
                // Affichage Question
                if(d.question) {
                    document.getElementById('display-question').innerText = d.question;
                    document.getElementById('q-input').value = d.question;
                }
                // Etat Cadenas
                if(d.isLocked !== undefined) {
                    const b = document.getElementById('btn-lock');
                    b.innerText = d.isLocked ? "üîí Ferm√©" : "üîì Ouvert";
                    b.style.color = d.isLocked ? "#ef4444" : "#22c55e";
                    b.style.borderColor = d.isLocked ? "#ef4444" : "#22c55e";
                }
            }
        });

        window.updateQuestion = async () => {
            const q = document.getElementById('q-input').value;
            await setDoc(doc(db, "postit_config", "global"), { question: q, isLocked: false }, {merge:true});
        };

        window.toggleLock = async () => {
            const currentText = document.getElementById('btn-lock').innerText;
            const isLocked = currentText.includes("Ouvert"); // Si ouvert, on verrouille
            await setDoc(doc(db, "postit_config", "global"), { isLocked: isLocked }, {merge:true});
        };

        // --- 2. GESTION DU TABLEAU (BOARD) ---
        onSnapshot(collection(db, "postit_board"), (snap) => {
            const currentIds = [];
            snap.forEach(d => {
                currentIds.push(d.id);
                const data = d.data();
                let el = document.getElementById(d.id);
                
                if(!el) {
                    el = document.createElement('div');
                    el.id = d.id;
                    el.className = `postit c-${data.color || 'yellow'}`;
                    el.innerHTML = `<div class="author">${escapeHtml(data.student)}</div><div>${escapeHtml(data.text)}</div>`;
                    
                    if(!isProjection) {
                        const del = document.createElement('div'); del.className = 'delete-pin'; del.innerText = '√ó';
                        del.onclick = (e) => { e.stopPropagation(); deletePostit(d.id); };
                        el.appendChild(del);
                        el.onmousedown = (e) => startDrag(e, el);
                    }
                    document.getElementById('board').appendChild(el);
                }
                
                // Maj position si on ne drag pas
                if(draggedItem !== el) {
                    el.style.left = data.x + '%';
                    el.style.top = data.y + '%';
                }
            });
            // Nettoyage
            document.querySelectorAll('.postit').forEach(el => { if(!currentIds.includes(el.id)) el.remove(); });
        });

        // DRAG & DROP
        let draggedItem = null;
        function startDrag(e, el) { if(e.button!==0)return; draggedItem = el; el.style.zIndex = 1000; }
        window.addEventListener('mousemove', (e) => {
            if(draggedItem) {
                e.preventDefault();
                const rect = document.getElementById('board').getBoundingClientRect();
                let x = ((e.clientX - rect.left) / rect.width) * 100;
                let y = ((e.clientY - rect.top) / rect.height) * 100;
                draggedItem.style.left = (x-5) + '%'; draggedItem.style.top = (y-5) + '%';
            }
        });
        window.addEventListener('mouseup', async () => {
            if(draggedItem) {
                const id = draggedItem.id;
                await updateDoc(doc(db, "postit_board", id), { x: parseFloat(draggedItem.style.left), y: parseFloat(draggedItem.style.top) });
                draggedItem.style.zIndex = ''; draggedItem = null;
            }
        });
        window.deletePostit = async(id) => { if(confirm("Supprimer ?")) await deleteDoc(doc(db, "postit_board", id)); };

        // --- 3. SALLE D'ATTENTE (WAITING) ---
        if(!isProjection) {
            const q = query(collection(db, "postit_ideas"), where("status", "==", "waiting"));
            onSnapshot(q, (snap) => {
                const div = document.getElementById('waiting-room');
                div.innerHTML = "";
                if(snap.empty) div.innerHTML = "<div style='text-align:center;color:#64748b;margin-top:10px;'>Vide...</div>";
                
                snap.forEach(d => {
                    const data = d.data();
                    const card = document.createElement('div');
                    card.className = `idea-card c-${data.color}`;
                    card.innerHTML = `
                        <div class="idea-info">üë§ ${escapeHtml(data.student)}</div>
                        <div class="idea-text">${escapeHtml(data.text)}</div>
                        <div class="card-actions">
                            <button class="btn-card" style="background:#22c55e;" onclick="acceptPostit('${d.id}', '${escapeHtml(data.text)}', '${data.color}', '${data.student}')">‚úî</button>
                            <button class="btn-card" style="background:#ef4444;" onclick="rejectPostit('${d.id}')">‚úï</button>
                        </div>
                    `;
                    div.appendChild(card);
                });
            });
        }

        window.acceptPostit = async (id, text, color, student) => {
            // Ajout au board (position random au centre)
            const randX = 40 + Math.random() * 20;
            const randY = 40 + Math.random() * 20;
            await addDoc(collection(db, "postit_board"), { text, color, student, x: randX, y: randY });
            await deleteDoc(doc(db, "postit_ideas", id));
        };
        window.rejectPostit = async (id) => await deleteDoc(doc(db, "postit_ideas", id));
        window.clearWaiting = async () => {
            if(!confirm("Tout rejeter ?")) return;
            const snap = await getDocs(query(collection(db, "postit_ideas"), where("status", "==", "waiting")));
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
        };

        // --- 4. GESTION PR√âSENCE ---
        if(!isProjection) {
            onSnapshot(collection(db, "postit_presence"), (snap) => {
                const list = document.getElementById('student-list'); list.innerHTML = "";
                let count = 0;
                snap.forEach(d => { count++; list.innerHTML += `<div class="student-row"><span>üë§ ${escapeHtml(d.data().name)}</span> <button class="mega-btn" onclick="call('${d.data().name}')">üì¢</button></div>`; });
                document.getElementById('student-count').innerText = `(${count})`;
            });
        }
        window.call = (name) => { setDoc(doc(db, "postit_config", "global"), { solicitedStudent: name }, { merge: true }); setTimeout(()=>setDoc(doc(db, "postit_config", "global"), { solicitedStudent: null }, { merge: true }), 5000); };

        // --- 5. RESET TOTAL ---
        window.resetAll = async () => {
            if(!confirm("‚ö†Ô∏è ATTENTION : Cela efface TOUT (Post-its, Attente, Pr√©sents).\nContinuer ?")) return;
            const batch = writeBatch(db);
            (await getDocs(collection(db, "postit_board"))).forEach(d => batch.delete(d.ref));
            (await getDocs(collection(db, "postit_ideas"))).forEach(d => batch.delete(d.ref));
            (await getDocs(collection(db, "postit_presence"))).forEach(d => batch.delete(d.ref));
            batch.set(doc(db, "postit_config", "global"), { question: "POST-IT", isLocked: false, solicitedStudent: null });
            await batch.commit();
            location.reload();
        };

        // UI UTILS
        window.toggleProjection = () => {
            const url = new URL(window.location.href); url.searchParams.set("mode", "projection"); window.open(url.toString(), "_blank");
        };
        function escapeHtml(t) { return t ? t.replace(/&/g,"&amp;").replace(/</g,"&lt;") : ""; }
        
        // WIDGETS
        let ti, ir=false, ts=0;
        window.handleChronoClick=()=>{ if(ir){clearInterval(ti);ir=false;document.getElementById('chrono').style.color="#3b82f6";return;} const i=prompt("Minuteur?"); clearInterval(ti); document.getElementById('chrono').classList.remove('alert'); if(i&&parseInt(i)>0){ ts=parseInt(i)*60; updC(ts); ti=setInterval(()=>{ ts--; updC(ts); if(ts<=0){clearInterval(ti);ir=false;document.getElementById('chrono').classList.add('alert');document.getElementById('chrono').innerText="FIN!";} },1000); } else { ts=0; updC(0); ti=setInterval(()=>{ ts++; updC(ts); },1000); } ir=true; };
        function updC(s){ document.getElementById('chrono').innerText=`${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{ const c=new(window.AudioContext||window.webkitAudioContext)(), a=c.createAnalyser(), m=c.createMediaStreamSource(s); m.connect(a); a.fftSize=256; const d=new Uint8Array(a.frequencyBinCount); function dr(){ requestAnimationFrame(dr); a.getByteFrequencyData(d); let sm=0; for(let i=0;i<d.length;i++)sm+=d[i]; document.getElementById('sono-bar').style.width=Math.min(100,(sm/d.length/50)*100)+"%"; } dr(); }).catch(()=>{});
    </script>
</body>
</html>

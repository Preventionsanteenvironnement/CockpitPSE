<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Post-it Brainstorming - Prof</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Kalam:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: white; display: flex; height: 100vh; overflow: hidden; user-select: none; }
        
        /* SIDEBAR */
        .sidebar { width: 300px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 50; flex-shrink: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
        .sidebar.hidden { display: none; }
        .sidebar-header { padding: 15px; background: #0f172a; border-bottom: 1px solid #334155; display:flex; justify-content:space-between; align-items:center; }
        .sidebar-section { flex-grow: 1; overflow-y: auto; padding: 10px; border-bottom: 1px solid #334155; }
        .section-title { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: bold; margin-bottom: 10px; display:flex; justify-content:space-between; }

        /* TABLEAU (BOARD) */
        .board { 
            flex-grow: 1; position: relative; overflow: hidden; 
            background-color: #0f172a;
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px; /* Effet grille */
            cursor: grab;
        }
        .board:active { cursor: grabbing; }

        /* POST-IT */
        .postit {
            position: absolute;
            width: 180px; min-height: 150px;
            padding: 15px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.4);
            font-family: 'Kalam', cursive; /* Police manuscrite */
            font-size: 1.1rem; color: #1e293b; line-height: 1.2;
            display: flex; flex-direction: column; justify-content: center; text-align: center;
            transform: rotate(-1deg); transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab;
            animation: popIn 0.3s;
        }
        .postit:hover { transform: scale(1.05) rotate(0deg); z-index: 100 !important; box-shadow: 10px 10px 25px rgba(0,0,0,0.5); }
        .postit:active { cursor: grabbing; }
        
        .postit .author { font-family: 'Inter', sans-serif; font-size: 0.6rem; text-transform: uppercase; opacity: 0.6; margin-bottom: 5px; font-weight: bold; }
        
        .delete-pin { 
            position: absolute; top: -10px; right: -10px; 
            width: 25px; height: 25px; background: #ef4444; color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 0.8rem; cursor: pointer; opacity: 0; transition: 0.2s; 
            font-family: 'Inter', sans-serif; border: 2px solid white;
        }
        .postit:hover .delete-pin { opacity: 1; }

        /* COULEURS */
        .color-yellow { background: #fef08a; transform: rotate(1deg); }
        .color-green { background: #bbf7d0; transform: rotate(-2deg); }
        .color-blue { background: #bfdbfe; transform: rotate(2deg); }
        .color-pink { background: #fbcfe8; transform: rotate(-1deg); }

        /* UI */
        .idea-card { background: #334155; padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9rem; border-left: 4px solid #ccc; }
        .btn-act { border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-weight:bold; margin-right:3px; }
        .btn-projection { position: absolute; top: 20px; left: 20px; z-index: 50; background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* WIDGETS */
        .ambient-widget { position: absolute; bottom: 20px; right: 20px; background: rgba(15, 23, 42, 0.9); padding: 10px; border-radius: 10px; display: flex; gap: 15px; align-items: center; z-index: 50; border: 1px solid #334155; }
        .chrono { font-family: monospace; font-size: 1.5rem; font-weight: bold; color: #3b82f6; cursor: pointer; width: 80px; text-align: center; }
        .chrono.alert { color: #ef4444; animation: pulse 1s infinite; }
        .sono-box { width: 100px; height: 10px; background: #334155; border-radius: 4px; overflow: hidden; }
        .sono-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #22c55e, #eab308, #ef4444); transition: width 0.1s; }
        
        .student-item { display: flex; justify-content: space-between; align-items: center; background: #0f172a; padding: 5px; margin-bottom: 3px; border-radius: 4px; font-size: 0.8rem; }
        .btn-call { background: #eab308; border:none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 0.7rem; }

        #debug-status { position: fixed; bottom: 0; left: 0; font-size: 0.7rem; padding: 2px; background: black; color: lime; z-index: 1000; }
        @keyframes popIn { from { transform: scale(0) rotate(10deg); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>POST-IT MANAGER</h2>
            <button onclick="toggleLock()" id="btn-lock" style="background:none; border:1px solid #22c55e; color:#22c55e; padding:3px 8px; border-radius:4px; cursor:pointer;">ðŸ”“</button>
        </div>
        
        <div class="sidebar-section" style="flex: 1;">
            <div class="section-title">En Attente <span onclick="clearAll()" style="cursor:pointer;">(Tout rejeter)</span></div>
            <div id="waiting-room"></div>
        </div>

        <div class="sidebar-section" style="height: 150px; background:#162032;">
            <div class="section-title">ðŸ‘¥ PrÃ©sents <span id="student-count">(0)</span></div>
            <div id="student-list"></div>
        </div>
        <div id="debug-status">Init...</div>
    </div>

    <div class="board" id="board">
        <button class="btn-projection" onclick="toggleProjection()">ðŸ“º Mode Projection</button>
        <div class="ambient-widget">
            <div onclick="handleChronoClick()"><div class="chrono" id="chrono">00:00</div></div>
            <div style="display:flex; align-items:center;">
                <div class="sono-box"><div class="sono-bar" id="sono-bar"></div></div>
            </div>
        </div>
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, setDoc, onSnapshot, query, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI", authDomain: "devoirs-pse.firebaseapp.com", projectId: "devoirs-pse", storageBucket: "devoirs-pse.firebasestorage.app", messagingSenderId: "614730413904", appId: "1:614730413904:web:a5dd478af5de30f6bede55" };
        
        // CORRECTION ICI : DÃ©claration propre des variables
        let app, db;
        try { 
            app = initializeApp(firebaseConfig); 
            db = getFirestore(app); 
            document.getElementById('debug-status').innerText = "ðŸŸ¢ ConnectÃ©"; 
        } catch(e) { 
            console.error(e);
            document.getElementById('debug-status').innerText = "ðŸ”´ Erreur: " + e.message; 
        }

        let isProjection = new URLSearchParams(window.location.search).get('mode') === 'projection';

        // 1. SETUP
        if(isProjection) {
            document.getElementById('sidebar').classList.add('hidden');
            document.querySelector('.btn-projection').style.display = 'none';
            document.getElementById('board').style.cursor = 'default'; // Pas de main en projection
        }

        window.toggleProjection = () => {
            const url = new URL(window.location.href);
            url.searchParams.set("mode", "projection");
            window.open(url.toString(), "_blank");
        };

        // 2. GESTION DES POST-ITS SUR LE TABLEAU (BOARD)
        onSnapshot(collection(db, "postit_board"), (snap) => {
            // Pour ne pas tout redessiner et casser le drag, on met Ã  jour intelligemment
            const currentIds = [];
            
            snap.forEach(d => {
                const data = d.data();
                currentIds.push(d.id);
                
                let el = document.getElementById(d.id);
                
                // Si n'existe pas, on crÃ©e
                if(!el) {
                    el = document.createElement('div');
                    el.id = d.id;
                    el.className = `postit color-${data.color || 'yellow'}`;
                    
                    // Contenu
                    const author = document.createElement('div'); author.className='author'; author.innerText = data.student || '?';
                    const text = document.createElement('div'); text.innerText = data.text;
                    el.appendChild(author);
                    el.appendChild(text);

                    // Bouton delete (Prof seulement)
                    if(!isProjection) {
                        const del = document.createElement('div'); del.className = 'delete-pin'; del.innerText = 'Ã—';
                        del.onclick = (e) => { e.stopPropagation(); deletePostit(d.id); };
                        el.appendChild(del);
                        
                        // Drag Events (Prof seulement)
                        el.onmousedown = (e) => startDrag(e, el);
                    }
                    
                    document.getElementById('board').appendChild(el);
                }
                
                // Mise Ã  jour position (Si on ne drag pas actuellement cet Ã©lÃ©ment)
                if(draggedItem !== el) {
                    el.style.left = data.x + '%';
                    el.style.top = data.y + '%';
                }
            });

            // Supprimer les orphelins
            document.querySelectorAll('.postit').forEach(el => {
                if(!currentIds.includes(el.id)) el.remove();
            });
        });

        // 3. LOGIQUE DRAG & DROP (SYNC)
        let draggedItem = null;
        let startX, startY;

        function startDrag(e, el) {
            if(e.button !== 0) return; // Clic gauche seulement
            draggedItem = el;
            // Z-index top
            el.style.zIndex = 1000;
        }

        window.addEventListener('mousemove', (e) => {
            if(draggedItem) {
                e.preventDefault();
                const board = document.getElementById('board');
                const rect = board.getBoundingClientRect();
                
                // Calcul en pourcentage pour que Ã§a marche sur l'Ã©cran gÃ©ant
                let x = ((e.clientX - rect.left) / rect.width) * 100;
                let y = ((e.clientY - rect.top) / rect.height) * 100;
                
                // Centrer le curseur sur le postit (approx)
                x -= 5; // MoitiÃ© largeur postit en %
                y -= 5; // MoitiÃ© hauteur postit en %

                draggedItem.style.left = x + '%';
                draggedItem.style.top = y + '%';
            }
        });

        window.addEventListener('mouseup', async () => {
            if(draggedItem) {
                draggedItem.style.zIndex = ''; // Reset z-index
                const id = draggedItem.id;
                
                // Sauvegarde Firebase
                await updateDoc(doc(db, "postit_board", id), {
                    x: parseFloat(draggedItem.style.left),
                    y: parseFloat(draggedItem.style.top)
                });
                
                draggedItem = null;
            }
        });

        window.deletePostit = async(id) => { if(confirm("Retirer ce post-it ?")) await deleteDoc(doc(db, "postit_board", id)); };

        // 4. SALLE D'ATTENTE (PROF)
        if(!isProjection) {
            const q = query(collection(db, "postit_ideas"), where("status", "==", "waiting"));
            onSnapshot(q, (snap) => {
                const div = document.getElementById('waiting-room');
                div.innerHTML = "";
                if(snap.empty) div.innerHTML = "<div style='text-align:center;color:#64748b;margin-top:10px;'>Vide...</div>";
                
                snap.forEach(d => {
                    const data = d.data();
                    const colors = {'yellow':'ðŸŸ¨','green':'ðŸŸ©','blue':'ðŸŸ¦','pink':'ðŸŸ¥'};
                    const card = document.createElement('div');
                    card.className = `idea-card`;
                    card.style.borderLeftColor = getHexColor(data.color);
                    card.innerHTML = `
                        <div style="font-size:0.8rem; color:#aaa; font-weight:bold;">${colors[data.color]||'â¬œ'} ${escapeHtml(data.student)}</div>
                        <div style="margin:5px 0;">${escapeHtml(data.text)}</div>
                        <div style="display:flex;">
                            <button class="btn-act" style="background:#22c55e;color:#064e3b;flex:1;" onclick="acceptPostit('${d.id}', '${escapeHtml(data.text)}', '${data.color}', '${data.student}')">Afficher</button>
                            <button class="btn-act" style="background:#ef4444;color:#7f1d1d;" onclick="rejectPostit('${d.id}')">X</button>
                        </div>
                    `;
                    div.appendChild(card);
                });
            });
        }

        function getHexColor(c) {
            if(c==='yellow') return '#fef08a';
            if(c==='green') return '#bbf7d0';
            if(c==='blue') return '#bfdbfe';
            if(c==='pink') return '#fbcfe8';
            return '#ccc';
        }

        // ACTIONS VALIDATION
        window.acceptPostit = async (id, text, color, student) => {
            // Ajouter au Board (au centre par dÃ©faut avec un peu de random)
            const randX = 40 + Math.random() * 20;
            const randY = 40 + Math.random() * 20;
            
            await addDoc(collection(db, "postit_board"), { 
                text, color, student, x: randX, y: randY, timestamp: Date.now() 
            });
            // Supprimer de la salle d'attente
            await deleteDoc(doc(db, "postit_ideas", id));
        };
        window.rejectPostit = async (id) => await deleteDoc(doc(db, "postit_ideas", id));
        window.clearAll = async () => {
            if(!confirm("Tout rejeter ?")) return;
            const snap = await getDocs(query(collection(db, "postit_ideas"), where("status", "==", "waiting")));
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(doc(db, "postit_ideas", d.id)));
            await batch.commit();
        };

        // GESTION ELEVES
        if(!isProjection) {
            onSnapshot(collection(db, "postit_presence"), (snap) => {
                const list = document.getElementById('student-list'); list.innerHTML = "";
                let count = 0;
                snap.forEach(d => { count++; list.innerHTML += `<div class="student-item"><span>ðŸ‘¤ ${escapeHtml(d.id)}</span> <button class="btn-call" onclick="call('${d.id}')">ðŸ“¢</button></div>`; });
                document.getElementById('student-count').innerText = `(${count})`;
            });
        }
        window.call = (name) => { setDoc(doc(db, "postit_config", "global"), { solicitedStudent: name }, { merge: true }); setTimeout(()=>setDoc(doc(db, "postit_config", "global"), { solicitedStudent: null }, { merge: true }), 5000); };

        let isLocked = false;
        window.toggleLock = async () => { isLocked = !isLocked; document.getElementById('btn-lock').innerText = isLocked ? "ðŸ”’" : "ðŸ”“"; await setDoc(doc(db, "postit_config", "global"), { isLocked: isLocked }, { merge: true }); };

        let ti, ir=false, ts=0;
        window.handleChronoClick=()=>{ if(ir){clearInterval(ti);ir=false;document.getElementById('chrono').style.color="#3b82f6";return;} const i=prompt("Minuteur?"); clearInterval(ti); document.getElementById('chrono').classList.remove('alert'); if(i&&parseInt(i)>0){ ts=parseInt(i)*60; updC(ts); ti=setInterval(()=>{ ts--; updC(ts); if(ts<=0){clearInterval(ti);ir=false;document.getElementById('chrono').classList.add('alert');document.getElementById('chrono').innerText="FIN!";} },1000); } else { ts=0; updC(0); ti=setInterval(()=>{ ts++; updC(ts); },1000); } ir=true; };
        function updC(s){ document.getElementById('chrono').innerText=`${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{ const c=new(window.AudioContext||window.webkitAudioContext)(), a=c.createAnalyser(), m=c.createMediaStreamSource(s); m.connect(a); a.fftSize=256; const d=new Uint8Array(a.frequencyBinCount); function dr(){ requestAnimationFrame(dr); a.getByteFrequencyData(d); let sm=0; for(let i=0;i<d.length;i++)sm+=d[i]; document.getElementById('sono-bar').style.width=Math.min(100,(sm/d.length/50)*100)+"%"; } dr(); }).catch(()=>{});

        function escapeHtml(t) { return t ? t.replace(/&/g,"&amp;").replace(/</g,"&lt;") : ""; }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âcran G√©ant</title>
    <style>
        body { margin: 0; background: #0f172a; color: white; font-family: 'Inter', sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-image: radial-gradient(circle at center, #1e293b 0%, #0f172a 80%); }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        /* TEXTE ADAPTATIF */
        .question-huge { font-weight: 800; text-align: center; margin-bottom: 40px; width: 90%; line-height: 1.2; font-size: clamp(2rem, 4vw, 4rem); }

        /* SONDAGE (BARRES) */
        #poll-results { width: 80%; max-width: 1000px; display: flex; flex-direction: column; gap: 15px; }
        .poll-row { display: flex; align-items: center; width: 100%; animation: slideIn 0.5s ease-out; }
        .poll-label { width: 35%; text-align: right; padding-right: 20px; font-size: 1.3rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .poll-bar-bg { flex: 1; height: 40px; background: rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden; position: relative; }
        .poll-bar-fill { height: 100%; background: #3b82f6; width: 0%; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); display: flex; align-items: center; padding-left: 15px; font-weight: bold; font-size: 1.2rem; }
        .poll-row.winner .poll-bar-fill { background: linear-gradient(90deg, #eab308, #facc15); box-shadow: 0 0 20px rgba(234, 179, 8, 0.4); color: #0f172a; }
        .poll-row.winner .poll-label { color: #facc15; font-weight: 800; transform: scale(1.05); transition: 0.3s; }

        /* HEADER & QR */
        .header { position: absolute; top: 30px; left: 40px; font-size: 1.5rem; font-weight: 800; color: #cbd5e1; text-transform: uppercase; letter-spacing: 2px; }
        .qr-box { position: absolute; top: 30px; right: 40px; background: white; padding: 10px; border-radius: 12px; text-align: center; }
        .qr-text { color: #0f172a; font-weight: 800; font-size: 0.7rem; margin-top: 5px; }

        /* NUAGE */
        #cloud-container { width: 100%; height: 60vh; display: flex; flex-wrap: wrap; justify-content: center; align-content: center; gap: 15px; }
        .bubble { padding: 12px 30px; border-radius: 50px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); font-weight: bold; font-size: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: popIn 0.5s forwards; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        
        /* OTHER STYLES */
        #options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 80%; }
        .option-card { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; font-size: 1.5rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; }
        .reveal-mode .option-card.correct { background: #16a34a; color: white; transform: scale(1.05); }
        .reveal-mode .option-card.wrong { opacity: 0.3; }
        #meteo-system { display: flex; align-items: center; justify-content: center; height: 400px; font-size: 8rem; }
        .battery-container { width: 50%; height: 30px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 20px; overflow: hidden; }
        .battery-level { height: 100%; background: linear-gradient(90deg, #ef4444, #eab308, #22c55e); width: 0%; transition: width 1s; text-align: right; padding-right: 10px; font-weight: bold; font-size: 0.9rem; line-height: 30px; }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="header" id="session-title-display">BIENVENUE</div>
    <div class="qr-box">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=0&color=0f172a&bgcolor=ffffff&data=https://preventionsanteenvironnement.github.io/PSE/cafe_mobile.html" alt="QR" width="100" height="100">
        <div class="qr-text">SCANNEZ</div>
    </div>

    <div id="view-wait" class="screen active">
        <div style="font-size: 6rem; animation: float 3s infinite;">üëã</div>
        <h1 style="font-size: 3rem; margin-top: 20px;">Installez-vous</h1>
    </div>

    <div id="view-nuage" class="screen">
        <h1 class="question-huge">Vos id√©es en direct</h1>
        <div id="cloud-container"></div>
    </div>

    <div id="view-sondage" class="screen">
        <div id="poll-question" class="question-huge">Sondage</div>
        <div id="poll-results"></div>
    </div>

    <div id="view-quiz" class="screen">
        <div id="quiz-question" class="question-huge">Question ?</div>
        <div id="options-container"></div>
    </div>

    <div id="view-meteo" class="screen">
        <h1>M√©t√©o du groupe</h1>
        <div id="meteo-system">‚òÄÔ∏è</div>
        <div class="battery-container"><div id="energy-bar" class="battery-level">0%</div></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI", authDomain: "devoirs-pse.firebaseapp.com", projectId: "devoirs-pse", storageBucket: "devoirs-pse.firebasestorage.app", messagingSenderId: "614730413904", appId: "1:614730413904:web:a5dd478af5de30f6bede55" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let activeSessionId = null;
    let currentPollOptions = [];

    onSnapshot(doc(db, "config", "live"), (snap) => {
        if(!snap.exists()) return;
        const data = snap.data();
        if(data.sessionTitle) document.getElementById('session-title-display').innerText = data.sessionTitle;
        
        if(data.activeSessionId !== activeSessionId) {
            activeSessionId = data.activeSessionId;
            if(activeSessionId) { listenToAll(activeSessionId); }
        }
        handleNavigation(data);
    });

    function handleNavigation(data) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        
        if(data.currentStep === 'meteo') {
            document.getElementById('view-meteo').classList.add('active');
        } 
        // üîß Accepte 'sondage' ET 'poll'
        else if(data.currentStep === 'sondage' || data.currentStep === 'poll') {
            document.getElementById('view-sondage').classList.add('active');
            const q = data.pollQuestion || data.quizQuestion || "Sondage";
            document.getElementById('poll-question').innerText = q;
            currentPollOptions = data.pollOptions || data.quizOptions || [];
            if(currentPollOptions.length > 0) renderPollBars({}, 0);
        } 
        else if(data.currentStep === 'quiz') {
            document.getElementById('view-quiz').classList.add('active');
            setupQuiz(data.quizQuestion, data.quizOptions, data.quizState, data.quizCorrect);
        } 
        else if(data.currentStep === 'nuage') {
            document.getElementById('view-nuage').classList.add('active');
        } 
        else {
            document.getElementById('view-wait').classList.add('active');
        }
    }

    function listenToAll(sessId) {
        onSnapshot(query(collection(db, `sessions/${sessId}/inputs`)), (snap) => {
            const votes = { word:[], poll:{}, quiz:{}, meteo:{mood:{}, energy:[]} };
            currentPollOptions.forEach(opt => votes.poll[opt] = 0);
            let totalPoll = 0;

            snap.forEach(d => {
                const data = d.data();
                if(data.type === 'word' && !data.banned) votes.word.push(data.content);
                
                // On √©coute tout ce qui ressemble √† un sondage (poll ou quiz ou sondage)
                if((data.type === 'poll' || data.type === 'quiz' || data.type === 'sondage') && data.content) {
                    let val = data.content.replace(/^"|"$/g, ''); 
                    if(votes.poll[val] !== undefined) {
                        votes.poll[val]++;
                        totalPoll++;
                    }
                }
                
                if(data.type === 'meteo_full') {
                    try { const p = JSON.parse(data.content); if(p.mood) votes.meteo.mood[p.mood] = (votes.meteo.mood[p.mood]||0)+1; if(p.energy) votes.meteo.energy.push(p.energy); } catch(e){}
                }
            });

            if(document.getElementById('view-nuage').classList.contains('active')) renderCloud(votes.word);
            if(document.getElementById('view-sondage').classList.contains('active')) renderPollBars(votes.poll, totalPoll);
            if(document.getElementById('view-meteo').classList.contains('active')) renderMeteo(votes.meteo);
        });
    }

    function renderPollBars(counts, total) {
        const container = document.getElementById('poll-results');
        container.innerHTML = "";
        let items = currentPollOptions.map(opt => ({ label: opt, count: counts[opt] || 0 }));
        items.sort((a,b) => b.count - a.count);
        const max = items.length > 0 ? items[0].count : 0;

        items.forEach((item, idx) => {
            const pct = max > 0 ? (item.count / max) * 100 : 0;
            const isWinner = (idx === 0 && item.count > 0);
            container.innerHTML += `
                <div class="poll-row ${isWinner ? 'winner' : ''}">
                    <div class="poll-label">${item.label}</div>
                    <div class="poll-bar-bg">
                        <div class="poll-bar-fill" style="width:${pct}%">
                            ${item.count > 0 ? item.count : ''}
                        </div>
                    </div>
                </div>`;
        });
    }

    function renderCloud(words) {
        const container = document.getElementById('cloud-container');
        container.innerHTML = "";
        const counts = {}; words.forEach(w => counts[w] = (counts[w] || 0)+1);
        Object.keys(counts).forEach((w, i) => {
            const div = document.createElement('div'); div.className = 'bubble'; div.innerText = w;
            div.style.fontSize = Math.min(2 + counts[w], 6) + "rem";
            
            // üé® LES COULEURS SONT ICI
            const colors = ['#ec4899', '#22c55e', '#3b82f6', '#eab308', '#8b5cf6'];
            div.style.backgroundColor = colors[i % colors.length] + "dd"; 
            div.style.borderColor = colors[i % colors.length];
            
            container.appendChild(div);
        });
    }

    function renderMeteo(data) {
        const avg = data.energy.length ? Math.round(data.energy.reduce((a,b)=>a+b,0)/data.energy.length) : 0;
        document.getElementById('energy-bar').style.width = avg + "%";
        document.getElementById('energy-bar').innerText = avg + "%";
        let maxMood = '‚òÄÔ∏è', maxC = 0; const map = {'super':'ü§©','bien':'üôÇ','bof':'ü§î','mauvais':'üò∞'};
        for(let m in data.mood) if(data.mood[m] > maxC) { maxC = data.mood[m]; maxMood = map[m]; }
        document.getElementById('meteo-system').innerText = maxC > 0 ? maxMood : "En attente...";
    }

    function setupQuiz(q, opts, state, correct) {
        document.getElementById('quiz-question').innerText = q;
        const cont = document.getElementById('options-container');
        cont.innerHTML = "";
        if(!opts) return;
        opts.forEach((o, i) => {
            const letter = String.fromCharCode(65+i);
            let cls = 'option-card';
            if(state === 'revealed') cls += (i === correct ? ' correct' : ' wrong');
            cont.innerHTML += `<div class="${cls}"><span class="opt-letter">${letter}</span> ${o}</div>`;
        });
        if(state === 'revealed') document.getElementById('options-container').classList.add('reveal-mode');
    }
</script>
</body>
</html>

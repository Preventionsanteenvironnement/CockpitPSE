<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSE Quiz Live ‚Äî Ecran</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            color: white; height: 100vh; overflow: hidden;
        }

        .screen { display: none; position: fixed; inset: 0; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
        .screen.active { display: flex; }

        /* === LOBBY === */
        #screen-lobby { text-align: center; }
        .lobby-title { font-size: clamp(2rem, 5vw, 4rem); font-weight: 900; margin-bottom: 10px; }
        .lobby-subtitle { font-size: clamp(1rem, 2vw, 1.5rem); color: #94a3b8; margin-bottom: 40px; }
        .lobby-code {
            font-size: clamp(5rem, 12vw, 10rem); font-weight: 900; color: #f59e0b;
            letter-spacing: 15px; margin-bottom: 20px;
            text-shadow: 0 0 40px rgba(245,158,11,0.3);
        }
        .lobby-qr { margin: 20px 0; }
        .lobby-qr img { width: 180px; height: 180px; border-radius: 16px; background: white; padding: 8px; }
        .lobby-qr-label { color: #64748b; font-size: 1rem; margin-top: 8px; }
        .lobby-players {
            margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center;
            gap: 12px; max-width: 800px;
        }
        .player-badge {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
            padding: 8px 16px; border-radius: 50px; font-size: 1.1rem; font-weight: 600;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .lobby-counter {
            position: fixed; top: 30px; right: 40px;
            font-size: 1.5rem; color: #94a3b8; font-weight: 700;
        }

        /* === QUESTION === */
        #screen-question { text-align: center; }
        .wall-q-num { font-size: 1.2rem; color: #64748b; margin-bottom: 10px; font-weight: 600; }
        .wall-timer {
            font-size: clamp(4rem, 10vw, 8rem); font-weight: 900; color: #22c55e;
            margin-bottom: 10px; transition: color 0.3s;
        }
        .wall-timer.warn { color: #f59e0b; }
        .wall-timer.danger { color: #ef4444; animation: pulse 0.5s infinite; }
        .wall-q-text {
            font-size: clamp(1.5rem, 3vw, 2.5rem); font-weight: 800; line-height: 1.4;
            max-width: 900px; margin-bottom: 30px;
        }
        .wall-choices {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            width: 100%; max-width: 900px;
        }
        .wall-choice {
            padding: 24px 20px; border-radius: 20px; color: white;
            font-size: clamp(1rem, 2vw, 1.4rem); font-weight: 700;
            text-align: center; position: relative; overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .wall-choice-a { background: #3b82f6; }
        .wall-choice-b { background: #f59e0b; }
        .wall-choice-c { background: #22c55e; }
        .wall-choice-d { background: #ef4444; }
        .wall-choice .letter {
            font-size: 1.8rem; font-weight: 900; margin-right: 10px;
        }
        .wall-resp-counter {
            position: fixed; top: 30px; right: 40px;
            font-size: 1.5rem; color: #94a3b8; font-weight: 700;
        }
        .wall-mot-info {
            background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15);
            border-radius: 20px; padding: 40px; width: 100%; max-width: 700px;
            font-size: clamp(1.2rem, 2.5vw, 1.8rem); color: #94a3b8; font-weight: 600;
        }

        /* === RESULTS === */
        #screen-results { text-align: center; overflow-y: auto; }
        .results-q-text {
            font-size: clamp(1.2rem, 2.5vw, 2rem); font-weight: 700;
            max-width: 800px; margin-bottom: 30px; color: #94a3b8;
        }
        .results-bars {
            display: flex; gap: 20px; align-items: flex-end;
            justify-content: center; height: 300px; width: 100%; max-width: 700px;
        }
        .result-bar-col {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            height: 100%; justify-content: flex-end;
        }
        .result-bar-pct {
            font-size: 1.8rem; font-weight: 900; margin-bottom: 8px;
        }
        .result-bar {
            width: 100%; max-width: 120px; border-radius: 16px 16px 8px 8px;
            transition: height 1s ease-out; height: 0;
            position: relative;
        }
        .result-bar-a { background: #3b82f6; }
        .result-bar-b { background: #f59e0b; }
        .result-bar-c { background: #22c55e; }
        .result-bar-d { background: #ef4444; }
        .result-bar.correct { box-shadow: 0 0 30px rgba(255,255,255,0.4); border: 3px solid white; }
        .result-bar-label {
            margin-top: 10px; font-size: 1rem; font-weight: 600; color: #94a3b8;
            text-align: center; max-width: 140px;
        }
        .result-bar-badge {
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            font-size: 2rem; display: none;
        }
        .result-bar.correct .result-bar-badge { display: block; animation: bounceIn 0.6s; }
        .results-correct-text {
            font-size: 1.5rem; color: #22c55e; font-weight: 800; margin-top: 30px;
        }
        /* Mot result */
        .results-mot-answer {
            font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 900; color: #22c55e;
            margin-bottom: 20px;
        }
        .results-mot-stat {
            font-size: 1.3rem; color: #94a3b8; font-weight: 600;
        }

        /* === SUMMARY === */
        #screen-summary { text-align: center; overflow-y: auto; }
        .sum-title { font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 900; margin-bottom: 20px; }
        .sum-global { font-size: clamp(1.2rem, 2.5vw, 2rem); color: #94a3b8; margin-bottom: 40px; }
        .sum-mini-bars {
            display: flex; gap: 16px; justify-content: center;
            flex-wrap: wrap; max-width: 800px;
        }
        .sum-mini {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
        }
        .sum-mini-bar {
            width: 60px; border-radius: 8px; transition: height 1s ease-out;
            height: 0;
        }
        .sum-mini-label { font-size: 0.9rem; color: #64748b; font-weight: 700; }
        .sum-mini-pct { font-size: 1.1rem; font-weight: 900; }
        .sum-thanks { font-size: 1.2rem; color: #475569; margin-top: 30px; }

        /* === PAUSE === */
        #screen-paused {
            text-align: center;
        }
        .pause-icon { font-size: clamp(4rem, 10vw, 8rem); margin-bottom: 20px; }
        .pause-title { font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 900; margin-bottom: 10px; }
        .pause-sub { font-size: clamp(1rem, 2vw, 1.5rem); color: #94a3b8; }

        /* === JOIN INPUT === */
        #wall-join {
            position: fixed; inset: 0; z-index: 200;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #wall-join h1 { font-size: 2.5rem; margin-bottom: 30px; }
        #wall-join-input {
            padding: 20px 30px; font-size: 2.5rem; font-weight: 900;
            text-align: center; text-transform: uppercase; letter-spacing: 8px;
            border: 3px solid #475569; border-radius: 16px; background: #1e293b;
            color: white; outline: none; width: 400px; max-width: 80vw;
        }
        #wall-join-input:focus { border-color: #f59e0b; }
        #wall-join-btn {
            margin-top: 20px; padding: 16px 50px; background: #f59e0b;
            color: #1a1a2e; font-size: 1.3rem; font-weight: 800;
            border: none; border-radius: 12px; cursor: pointer;
        }
        #wall-join-error { color: #ef4444; margin-top: 12px; font-weight: 600; min-height: 24px; }

        /* === TEAM SCORES (results) === */
        .wall-team-scores {
            display: none; width: 100%; max-width: 900px; margin-top: 24px;
        }
        .wall-team-score-strip {
            display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-bottom: 16px;
        }
        .wall-team-pill {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255,255,255,0.08); border-radius: 50px;
            padding: 8px 18px; font-weight: 700; font-size: 1.1rem;
            border: 2px solid rgba(255,255,255,0.12);
        }
        .wall-team-pill .team-emoji { font-size: 1.4rem; }
        .wall-team-pill .team-pct { font-size: 1.3rem; font-weight: 900; }
        .wall-team-pill .team-cum { font-size: 0.85rem; color: #94a3b8; margin-left: 4px; }

        /* === TUG OF WAR (battle) === */
        .wall-tug {
            display: none; width: 100%; max-width: 700px;
            margin-top: 24px; text-align: center;
        }
        .wall-tug-label {
            display: flex; justify-content: space-between; margin-bottom: 8px;
            font-weight: 800; font-size: 1.3rem;
        }
        .wall-tug-track {
            height: 40px; background: rgba(255,255,255,0.1); border-radius: 20px;
            position: relative; overflow: hidden;
        }
        .wall-tug-fill-a {
            position: absolute; top: 0; left: 0; height: 100%;
            background: #3b82f6; border-radius: 20px 0 0 20px;
            transition: width 0.8s ease; width: 50%;
        }
        .wall-tug-fill-b {
            position: absolute; top: 0; right: 0; height: 100%;
            background: #ef4444; border-radius: 0 20px 20px 0;
            transition: width 0.8s ease; width: 50%;
        }
        .wall-tug-scores {
            display: flex; justify-content: space-between; margin-top: 8px;
            font-size: 0.95rem; color: #94a3b8;
        }

        /* === TEAM PODIUM (summary) === */
        .wall-team-podium {
            display: none; width: 100%; max-width: 800px;
            margin-bottom: 30px;
        }
        .wall-podium-title {
            font-size: 1.4rem; font-weight: 800; color: #f59e0b; margin-bottom: 16px;
        }
        .wall-podium-list {
            display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;
        }
        .wall-podium-card {
            background: rgba(255,255,255,0.08); border-radius: 16px;
            padding: 16px 24px; text-align: center; min-width: 140px;
            border: 2px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.5s ease both;
        }
        .wall-podium-card.gold { border-color: #f59e0b; background: rgba(245,158,11,0.1); }
        .wall-podium-card.silver { border-color: #94a3b8; background: rgba(148,163,184,0.08); }
        .wall-podium-card.bronze { border-color: #cd7c2f; background: rgba(205,124,47,0.08); }
        .wall-podium-rank { font-size: 2rem; margin-bottom: 4px; }
        .wall-podium-name { font-size: 1.2rem; font-weight: 800; }
        .wall-podium-pct { font-size: 1.5rem; font-weight: 900; margin-top: 4px; }

        /* === TEAM LOBBY BADGES === */
        .lobby-teams-section {
            display: none; margin-top: 20px; width: 100%; max-width: 800px;
        }
        .lobby-team-group {
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 12px;
        }
        .lobby-team-header {
            font-size: 1.2rem; font-weight: 800; margin-bottom: 6px; text-align: center;
        }

        /* === MEDIA QUESTION (projecteur) === */
        .q-media-container { width: 100%; max-width: 900px; margin: 0 auto 20px auto; text-align: center; }
        .q-media-container img { max-width: 100%; max-height: 350px; border-radius: 16px; object-fit: contain; }
        .q-media-container iframe { width: 100%; max-width: 720px; height: 405px; border: none; border-radius: 16px; }
        .q-media-container .media-texte { background: rgba(255,255,255,0.08); border-left: 5px solid #3b82f6; padding: 20px 24px; border-radius: 0 16px 16px 0; color: #e2e8f0; font-style: italic; line-height: 1.7; text-align: left; white-space: pre-wrap; font-size: 1.2rem; max-width: 800px; margin: 0 auto; }

        /* === ANIMATIONS === */
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes bounceIn { 0% { transform: translateX(-50%) scale(0); } 50% { transform: translateX(-50%) scale(1.3); } 100% { transform: translateX(-50%) scale(1); } }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes fadeIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>

<!-- ECRAN JOIN -->
<div id="wall-join">
    <h1>üéØ Quiz Live ‚Äî Ecran</h1>
    <p style="color:#94a3b8; margin-bottom: 30px;">Entre le code session pour afficher le quiz</p>
    <input type="text" id="wall-join-input" placeholder="CODE" maxlength="10" autocomplete="off">
    <button id="wall-join-btn" onclick="wallJoin()">AFFICHER</button>
    <div id="wall-join-error"></div>
</div>

<!-- LOBBY -->
<div id="screen-lobby" class="screen">
    <div class="lobby-title">üéØ PSE Quiz Live</div>
    <div class="lobby-subtitle">Rejoignez avec le code :</div>
    <div class="lobby-code" id="wall-code"></div>
    <div class="lobby-qr">
        <img id="wall-qr" src="" alt="QR">
        <div class="lobby-qr-label">üì± mapse.fr/eleve_quiz.html</div>
    </div>
    <div class="lobby-players" id="wall-players"></div>
    <div class="lobby-teams-section" id="wall-lobby-teams"></div>
    <div class="lobby-counter" id="wall-counter">0 connecte(s)</div>
</div>

<!-- QUESTION -->
<div id="screen-question" class="screen">
    <div class="wall-q-num" id="wall-q-num"></div>
    <div class="wall-timer" id="wall-timer"></div>
    <div class="q-media-container" id="wall-q-media" style="display:none;"></div>
    <div class="wall-q-text" id="wall-q-text"></div>
    <div class="wall-choices" id="wall-choices"></div>
    <div class="wall-mot-info" id="wall-mot-info" style="display:none;"></div>
    <div class="wall-resp-counter" id="wall-resp-counter"></div>
</div>

<!-- RESULTS -->
<div id="screen-results" class="screen">
    <div class="wall-q-num" id="res-q-num"></div>
    <div class="q-media-container" id="res-q-media" style="display:none;"></div>
    <div class="results-q-text" id="res-q-text"></div>
    <div class="results-bars" id="res-bars"></div>
    <div class="results-correct-text" id="res-correct-text"></div>
    <div class="wall-tug" id="wall-tug">
        <div class="wall-tug-label">
            <span id="tug-label-a"></span>
            <span id="tug-label-b"></span>
        </div>
        <div class="wall-tug-track">
            <div class="wall-tug-fill-a" id="tug-fill-a"></div>
            <div class="wall-tug-fill-b" id="tug-fill-b"></div>
        </div>
        <div class="wall-tug-scores">
            <span id="tug-score-a"></span>
            <span id="tug-score-b"></span>
        </div>
    </div>
    <div class="wall-team-scores" id="wall-team-scores">
        <div class="wall-team-score-strip" id="wall-team-score-strip"></div>
    </div>
</div>

<!-- PAUSE -->
<div id="screen-paused" class="screen">
    <div class="pause-icon">‚è∏Ô∏è</div>
    <div class="pause-title">Quiz en pause</div>
    <div class="pause-sub">Le prof a mis le quiz en pause</div>
</div>

<!-- SUMMARY -->
<div id="screen-summary" class="screen">
    <div class="sum-title">üèÅ Quiz termine !</div>
    <div class="sum-global" id="sum-global"></div>
    <div class="wall-team-podium" id="wall-team-podium">
        <div class="wall-podium-title" id="wall-podium-title">üèÜ Classement des equipes</div>
        <div class="wall-podium-list" id="wall-podium-list"></div>
    </div>
    <div class="sum-mini-bars" id="sum-bars"></div>
    <div class="sum-thanks">Merci d'avoir participe ! üéâ</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.firebasestorage.app",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // === STATE ===
    let currentSessionId = null;
    let currentSessionCode = null;
    let unsubConfig = null;
    let unsubPresence = null;
    let unsubReponses = null;
    let playerCount = 0;
    let responsesData = [];
    let timerInterval = null;
    let lastPhase = '';
    let lastQIndex = -1;
    let wallGameMode = 'solo';
    let wallTeams = [];
    let wallQuestions = [];

    // === CONNEXION ===
    const urlCode = new URLSearchParams(window.location.search).get('code');
    if (urlCode) {
        document.getElementById('wall-join-input').value = urlCode;
        setTimeout(() => wallJoin(), 500);
    }

    window.wallJoin = async function() {
        const code = document.getElementById('wall-join-input').value.trim().toUpperCase();
        if (!code) { document.getElementById('wall-join-error').textContent = "Entre un code !"; return; }

        try {
            const snap = await getDoc(doc(db, "quiz_live_config", "global"));
            if (!snap.exists() || snap.data().sessionCode !== code) {
                document.getElementById('wall-join-error').textContent = "Code introuvable.";
                return;
            }
            currentSessionId = snap.data().sessionId;
            currentSessionCode = code;

            document.getElementById('wall-join').style.display = 'none';
            startWallListening();
        } catch(e) {
            document.getElementById('wall-join-error').textContent = "Erreur de connexion.";
        }
    };

    document.getElementById('wall-join-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') wallJoin();
    });

    // === LISTENERS ===
    function updateLobbyTeams() {
        const container = document.getElementById('wall-lobby-teams');
        if (wallGameMode === 'solo' || wallTeams.length === 0) {
            container.style.display = 'none';
            document.getElementById('wall-players').style.display = 'flex';
            return;
        }
        // Hide individual badges, show team groups
        document.getElementById('wall-players').style.display = 'none';
        container.style.display = 'block';
        container.innerHTML = '';

        wallTeams.forEach(t => {
            const header = document.createElement('div');
            header.className = 'lobby-team-header';
            header.style.color = t.teamColor;
            header.textContent = t.teamEmoji + ' ' + t.teamName;
            container.appendChild(header);

            const group = document.createElement('div');
            group.className = 'lobby-team-group';
            t.members.forEach(m => {
                const badge = document.createElement('div');
                badge.className = 'player-badge';
                badge.style.borderColor = t.teamColor;
                badge.textContent = m.pseudo;
                group.appendChild(badge);
            });
            container.appendChild(group);
        });
    }

    function startWallListening() {
        unsubConfig = onSnapshot(doc(db, "quiz_live_config", "global"), (snap) => {
            if (!snap.exists()) return;
            const d = snap.data();
            if (d.sessionId !== currentSessionId) return;

            // Read team config
            wallGameMode = d.gameMode || 'solo';
            wallTeams = d.teams || [];
            wallQuestions = d.questions || [];

            // Handle pause
            if (d.paused) {
                if (timerInterval) clearInterval(timerInterval);
                showWallScreen('paused');
                lastPhase = 'paused';
                return;
            }

            const phase = d.phase || 'lobby';
            const qIndex = d.currentQuestionIndex ?? -1;
            const questions = wallQuestions;
            const timer = d.timer || 15;
            const isManual = d.mode === 'manual';

            if (phase === 'lobby') {
                showWallScreen('lobby');
                document.getElementById('wall-code').textContent = currentSessionCode;
                const qrUrl = 'https://mapse.fr/eleve_quiz.html';
                document.getElementById('wall-qr').src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&margin=0&color=0f172a&bgcolor=ffffff&data=' + encodeURIComponent(qrUrl);
                updateLobbyTeams();
            } else if (phase === 'question') {
                if (qIndex !== lastQIndex || lastPhase !== 'question') {
                    lastQIndex = qIndex;
                    showWallScreen('question');
                    displayWallQuestion(questions[qIndex], qIndex, questions.length, isManual ? 0 : timer);
                }
            } else if (phase === 'results') {
                if (timerInterval) clearInterval(timerInterval);
                showWallScreen('results');
                displayWallResults(questions[qIndex], qIndex, questions.length);
            } else if (phase === 'summary') {
                if (timerInterval) clearInterval(timerInterval);
                showWallScreen('summary');
                displayWallSummary(questions);
            }
            lastPhase = phase;
        });

        // Presence
        const qPres = query(collection(db, "quiz_live_presence"), where("sessionId", "==", currentSessionId));
        unsubPresence = onSnapshot(qPres, (snap) => {
            playerCount = snap.size;
            document.getElementById('wall-counter').textContent = playerCount + ' connecte(s)';

            const container = document.getElementById('wall-players');
            container.innerHTML = '';
            snap.forEach(d => {
                const badge = document.createElement('div');
                badge.className = 'player-badge';
                badge.textContent = d.data().pseudo;
                container.appendChild(badge);
            });
        });

        // Reponses
        const qResp = query(collection(db, "quiz_live_reponses"), where("sessionId", "==", currentSessionId));
        unsubReponses = onSnapshot(qResp, (snap) => {
            responsesData = [];
            snap.forEach(d => responsesData.push(d.data()));

            if (lastPhase === 'question' && lastQIndex >= 0) {
                const current = responsesData.filter(r => r.questionIndex === lastQIndex);
                document.getElementById('wall-resp-counter').textContent = current.length + ' / ' + playerCount + ' ont repondu';
            }
        });
    }

    // === MEDIA HELPERS ===
    function extractYouTubeId(url) {
        if (!url) return null;
        const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|shorts\/))([a-zA-Z0-9_-]{11})/);
        return m ? m[1] : null;
    }
    function renderMediaHtml(media) {
        if (!media || !media.type || !media.content) return '';
        if (media.type === 'image') {
            return '<img src="' + media.content + '" alt="Media" onerror="this.style.display=\'none\'">';
        } else if (media.type === 'video') {
            const vid = extractYouTubeId(media.content);
            if (!vid) return '';
            return '<iframe src="https://www.youtube-nocookie.com/embed/' + vid + '" allowfullscreen></iframe>';
        } else if (media.type === 'texte') {
            return '<div class="media-texte">' + media.content.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
        }
        return '';
    }

    // === QUESTION ===
    function displayWallQuestion(q, index, total, timer) {
        const qType = q.type || 'qcm';

        document.getElementById('wall-q-num').textContent = 'Question ' + (index + 1) + ' / ' + total;
        // Media
        const mediaEl = document.getElementById('wall-q-media');
        if (q.media) {
            mediaEl.innerHTML = renderMediaHtml(q.media);
            mediaEl.style.display = 'block';
        } else {
            mediaEl.innerHTML = '';
            mediaEl.style.display = 'none';
        }
        document.getElementById('wall-q-text').textContent = q.question;
        document.getElementById('wall-resp-counter').textContent = '0 / ' + playerCount + ' ont repondu';

        const grid = document.getElementById('wall-choices');
        const motInfo = document.getElementById('wall-mot-info');

        if (qType === 'mot') {
            grid.style.display = 'none';
            motInfo.style.display = 'block';
            motInfo.innerHTML = '‚úèÔ∏è Les eleves tapent leur reponse...';
        } else {
            grid.style.display = 'grid';
            motInfo.style.display = 'none';
            grid.innerHTML = '';

            const letters = ['A', 'B', 'C', 'D'];
            const colors = ['wall-choice-a', 'wall-choice-b', 'wall-choice-c', 'wall-choice-d'];
            const numChoices = q.choices.length;

            for (let i = 0; i < numChoices; i++) {
                const div = document.createElement('div');
                div.className = 'wall-choice ' + colors[i];
                div.innerHTML = '<span class="letter">' + letters[i] + '</span> ' + q.choices[i];
                grid.appendChild(div);
            }
        }

        startWallTimer(timer);
    }

    function startWallTimer(seconds) {
        if (timerInterval) clearInterval(timerInterval);
        const el = document.getElementById('wall-timer');

        if (seconds <= 0) {
            el.textContent = '‚úã';
            el.className = 'wall-timer';
            return;
        }

        let remaining = seconds;
        el.textContent = remaining + 's';
        el.className = 'wall-timer';

        timerInterval = setInterval(() => {
            remaining--;
            if (remaining < 0) { clearInterval(timerInterval); return; }
            el.textContent = remaining + 's';
            if (remaining <= 3) el.className = 'wall-timer danger';
            else if (remaining <= Math.floor(seconds * 0.3)) el.className = 'wall-timer warn';
        }, 1000);
    }

    // === RESULTS ===
    function displayWallResults(q, index, total) {
        const qType = q.type || 'qcm';

        document.getElementById('res-q-num').textContent = 'Question ' + (index + 1) + ' / ' + total;
        // Media
        const resMediaEl = document.getElementById('res-q-media');
        if (q.media) {
            resMediaEl.innerHTML = renderMediaHtml(q.media);
            resMediaEl.style.display = 'block';
        } else {
            resMediaEl.innerHTML = '';
            resMediaEl.style.display = 'none';
        }
        document.getElementById('res-q-text').textContent = q.question;

        const currentResp = responsesData.filter(r => r.questionIndex === index);
        const totalR = currentResp.length || 1;
        const correctCount = currentResp.filter(r => r.correct).length;

        const container = document.getElementById('res-bars');
        container.innerHTML = '';

        if (qType === 'mot') {
            // Short answer: show the answer big + correct count
            container.innerHTML = '<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:20px;">' +
                '<div class="results-mot-answer">‚úÖ ' + q.reponse + '</div>' +
                '<div class="results-mot-stat">' + correctCount + ' / ' + currentResp.length + ' bonnes reponses</div>' +
                '</div>';
            document.getElementById('res-correct-text').textContent = '';
        } else {
            // QCM / V/F: show bars
            const numChoices = q.choices.length;
            const counts = new Array(numChoices).fill(0);
            currentResp.forEach(r => { if (r.answer >= 0 && r.answer < numChoices) counts[r.answer]++; });

            const maxCount = Math.max(...counts, 1);
            const letters = ['A', 'B', 'C', 'D'];
            const barColors = ['result-bar-a', 'result-bar-b', 'result-bar-c', 'result-bar-d'];

            for (let i = 0; i < numChoices; i++) {
                const pct = Math.round((counts[i] / totalR) * 100);
                const barHeight = Math.max(20, (counts[i] / maxCount) * 250);

                const col = document.createElement('div');
                col.className = 'result-bar-col';

                col.innerHTML = '<div class="result-bar-pct">' + pct + '%</div>' +
                    '<div class="result-bar ' + barColors[i] + (i === q.correct ? ' correct' : '') + '" id="rbar-' + i + '" style="height:0;">' +
                    '<div class="result-bar-badge">‚úÖ</div></div>' +
                    '<div class="result-bar-label"><strong>' + letters[i] + '</strong><br>' + q.choices[i] + '</div>';

                container.appendChild(col);

                setTimeout(() => {
                    document.getElementById('rbar-' + i).style.height = barHeight + 'px';
                }, 200 + i * 150);
            }

            document.getElementById('res-correct-text').textContent = '‚úÖ ' + correctCount + ' / ' + currentResp.length + ' bonnes reponses (' + Math.round((correctCount / totalR) * 100) + '%)';
        }

        // Team scores
        displayWallTeamScores(index);
    }

    // === TEAM SCORE FUNCTIONS ===
    function computeWallTeamScores(questionIndex) {
        return wallTeams.map(t => {
            const memberIds = t.members.map(m => m.visitorId);
            const teamResp = responsesData.filter(r => r.questionIndex === questionIndex && memberIds.includes(r.visitorId));
            const correct = teamResp.filter(r => r.correct).length;
            const total = teamResp.length;
            return {
                teamId: t.teamId, teamName: t.teamName, teamEmoji: t.teamEmoji, teamColor: t.teamColor,
                correct, total, pct: total > 0 ? Math.round((correct / total) * 100) : 0
            };
        });
    }

    function computeWallCumulativeScores() {
        const maxQ = wallQuestions.length;
        const cumul = {};
        wallTeams.forEach(t => { cumul[t.teamId] = { correct: 0, total: 0, teamId: t.teamId, teamName: t.teamName, teamEmoji: t.teamEmoji, teamColor: t.teamColor }; });

        for (let i = 0; i <= lastQIndex; i++) {
            const qScores = computeWallTeamScores(i);
            qScores.forEach(s => {
                cumul[s.teamId].correct += s.correct;
                cumul[s.teamId].total += s.total;
            });
        }

        return Object.values(cumul).map(c => ({
            ...c, pct: c.total > 0 ? Math.round((c.correct / c.total) * 100) : 0
        })).sort((a, b) => b.pct - a.pct);
    }

    function displayWallTeamScores(questionIndex) {
        const tugEl = document.getElementById('wall-tug');
        const teamScoresEl = document.getElementById('wall-team-scores');

        if (wallGameMode === 'solo' || wallTeams.length === 0) {
            tugEl.style.display = 'none';
            teamScoresEl.style.display = 'none';
            return;
        }

        const qScores = computeWallTeamScores(questionIndex);
        const cumulative = computeWallCumulativeScores();

        if (wallGameMode === 'battle' && wallTeams.length === 2) {
            // TUG OF WAR
            tugEl.style.display = 'block';
            teamScoresEl.style.display = 'none';

            const a = cumulative.find(t => t.teamId === wallTeams[0].teamId) || { pct: 0 };
            const b = cumulative.find(t => t.teamId === wallTeams[1].teamId) || { pct: 0 };
            const qA = qScores.find(t => t.teamId === wallTeams[0].teamId) || { pct: 0 };
            const qB = qScores.find(t => t.teamId === wallTeams[1].teamId) || { pct: 0 };

            const total = a.pct + b.pct || 1;
            const pctA = (a.pct / total) * 100;
            const pctB = (b.pct / total) * 100;

            document.getElementById('tug-label-a').innerHTML = wallTeams[0].teamEmoji + ' ' + wallTeams[0].teamName;
            document.getElementById('tug-label-a').style.color = wallTeams[0].teamColor;
            document.getElementById('tug-label-b').innerHTML = wallTeams[1].teamEmoji + ' ' + wallTeams[1].teamName;
            document.getElementById('tug-label-b').style.color = wallTeams[1].teamColor;

            document.getElementById('tug-fill-a').style.width = pctA + '%';
            document.getElementById('tug-fill-b').style.width = pctB + '%';

            document.getElementById('tug-score-a').textContent = 'Cette Q: ' + qA.pct + '% ‚Äî Total: ' + a.pct + '%';
            document.getElementById('tug-score-b').textContent = 'Cette Q: ' + qB.pct + '% ‚Äî Total: ' + b.pct + '%';
        } else {
            // TEAM PILLS
            tugEl.style.display = 'none';
            teamScoresEl.style.display = 'block';

            const strip = document.getElementById('wall-team-score-strip');
            strip.innerHTML = '';

            qScores.forEach(t => {
                const cum = cumulative.find(c => c.teamId === t.teamId);
                const pill = document.createElement('div');
                pill.className = 'wall-team-pill';
                pill.style.borderColor = t.teamColor;
                pill.innerHTML = '<span class="team-emoji">' + t.teamEmoji + '</span>' +
                    '<span style="font-weight:700;">' + t.teamName + '</span>' +
                    '<span class="team-pct" style="color:' + t.teamColor + '">' + t.pct + '%</span>' +
                    (cum ? '<span class="team-cum">(total: ' + cum.pct + '%)</span>' : '');
                strip.appendChild(pill);
            });
        }
    }

    // === SUMMARY ===
    function displayWallSummary(questions) {
        let totalCorrect = 0;
        let totalAnswered = 0;
        const container = document.getElementById('sum-bars');
        container.innerHTML = '';

        const maxQ = questions.length;
        for (let i = 0; i < maxQ; i++) {
            const qResp = responsesData.filter(r => r.questionIndex === i);
            if (qResp.length === 0) continue;
            const correct = qResp.filter(r => r.correct).length;
            const total = qResp.length;
            const pct = Math.round((correct / total) * 100);
            totalCorrect += correct;
            totalAnswered += total;

            let barColor = pct >= 60 ? '#22c55e' : pct >= 40 ? '#f59e0b' : '#ef4444';

            const mini = document.createElement('div');
            mini.className = 'sum-mini';
            mini.style.animation = 'fadeIn 0.5s ease ' + (i * 0.2) + 's both';
            mini.innerHTML = '<div class="sum-mini-pct" style="color:' + barColor + '">' + pct + '%</div>' +
                '<div class="sum-mini-bar" style="background:' + barColor + ';" id="sumbar-' + i + '"></div>' +
                '<div class="sum-mini-label">Q' + (i + 1) + '</div>';
            container.appendChild(mini);

            setTimeout(() => {
                document.getElementById('sumbar-' + i).style.height = Math.max(20, pct * 1.5) + 'px';
            }, 400 + i * 200);
        }

        const globalPct = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
        document.getElementById('sum-global').textContent = 'Taux de reussite global : ' + globalPct + '%';

        // Team podium
        displayWallTeamPodium();
    }

    function displayWallTeamPodium() {
        const podiumEl = document.getElementById('wall-team-podium');
        if (wallGameMode === 'solo' || wallTeams.length === 0) {
            podiumEl.style.display = 'none';
            return;
        }

        podiumEl.style.display = 'block';
        const cumulative = computeWallCumulativeScores();
        const medals = ['ü•á', 'ü•à', 'ü•â'];
        const classes = ['gold', 'silver', 'bronze'];
        const list = document.getElementById('wall-podium-list');
        list.innerHTML = '';

        // Title adapts to mode
        const titleEl = document.getElementById('wall-podium-title');
        if (wallGameMode === 'battle') {
            titleEl.textContent = cumulative.length >= 2 && cumulative[0].pct > cumulative[1].pct
                ? 'üèÜ ' + cumulative[0].teamEmoji + ' ' + cumulative[0].teamName + ' remporte le battle !'
                : cumulative.length >= 2 && cumulative[0].pct === cumulative[1].pct
                    ? 'ü§ù Egalite parfaite !'
                    : 'üèÜ Classement';
        } else if (wallGameMode === 'duo') {
            titleEl.textContent = 'üèÜ Classement des duos';
        } else {
            titleEl.textContent = 'üèÜ Classement des equipes';
        }

        cumulative.forEach((t, i) => {
            const card = document.createElement('div');
            card.className = 'wall-podium-card' + (i < 3 ? ' ' + classes[i] : '');
            card.style.animationDelay = (i * 0.15) + 's';
            card.innerHTML = '<div class="wall-podium-rank">' + (i < 3 ? medals[i] : '#' + (i + 1)) + '</div>' +
                '<div class="wall-podium-name" style="color:' + t.teamColor + '">' + t.teamEmoji + ' ' + t.teamName + '</div>' +
                '<div class="wall-podium-pct">' + t.pct + '%</div>';
            list.appendChild(card);
        });
    }

    // === NAVIGATION ===
    function showWallScreen(name) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const el = document.getElementById('screen-' + name);
        if (el) el.classList.add('active');
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carte Mentale - Pilotage Prof</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* DESIGN G√âN√âRAL */
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: white; display: flex; height: 100vh; overflow: hidden; user-select: none; }
        
        /* SIDEBAR */
        .sidebar { width: 350px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 20; box-shadow: 5px 0 15px rgba(0,0,0,0.3); transition: transform 0.3s; flex-shrink: 0; }
        .sidebar.hidden { transform: translateX(-100%); position: absolute; }
        
        .sidebar-header { padding: 15px; background: #0f172a; border-bottom: 1px solid #334155; display:flex; justify-content:space-between; align-items:center; }
        .sidebar-header h2 { margin: 0; font-size: 1rem; color: #94a3b8; text-transform: uppercase; }
        
        .btn-lock { background: none; border: 1px solid #22c55e; color: #22c55e; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-lock.locked { border-color: #ef4444; color: #ef4444; background: rgba(239, 68, 68, 0.1); }

        .waiting-room { flex-grow: 1; padding: 15px; overflow-y: auto; }
        
        /* ID√âES */
        .idea-card { background: #334155; padding: 10px; margin-bottom: 8px; border-radius: 6px; display: flex; flex-direction: column; gap: 5px; border-left: 3px solid #64748b; animation: slideIn 0.3s ease-out; }
        .idea-meta { font-size: 0.75rem; color: #94a3b8; font-weight: bold; }
        .idea-text { font-size: 1rem; font-weight: 500; word-break: break-word; color: white; }
        .idea-input-edit { width: 100%; padding: 5px; background: #0f172a; border: 1px solid #475569; color: white; border-radius: 4px; display: none; }
        .idea-actions { display: flex; gap: 5px; margin-top: 5px; }
        .btn-action { border: none; flex-grow: 1; padding: 6px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }
        .btn-valid { background: #22c55e; color: #064e3b; }
        .btn-reject { background: #ef4444; color: #7f1d1d; }
        .btn-edit { background: #f59e0b; color: #451a03; }
        /* BOUTON POUCE */
        .btn-like { background: #3b82f6; color: white; flex-grow: 0; width: 40px; } 

        /* CARTE */
        .map-wrapper { flex-grow: 1; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); overflow: hidden; cursor: grab; }
        .map-wrapper:active { cursor: grabbing; }
        .map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform-origin: 0 0; }
        #connections { position: absolute; top: 0; left: 0; width: 5000px; height: 5000px; pointer-events: none; z-index: 0; overflow: visible; }
        
        .node { position: absolute; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; text-align: center; cursor: pointer; z-index: 10; transition: box-shadow 0.2s; color: #0f172a; font-weight: 700; border: 2px solid transparent; }
        .node:hover { z-index: 20; filter: brightness(1.1); }
        .node.selected { border-color: #ef4444; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.4); z-index: 30; }
        
        .level-0 { width: 140px; height: 120px; background: #facc15; clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); font-size: 1.2rem; text-transform: uppercase; }
        .level-1 { padding: 12px 25px; border-radius: 12px; background: #60a5fa; color: white; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .level-2 { padding: 8px 20px; border-radius: 50px; background: #a78bfa; color: white; font-size: 0.95rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .level-3 { padding: 5px 15px; border-radius: 4px; background: #34d399; color: #064e3b; font-size: 0.85rem; border: 1px solid #059669; }

        .toolbar { position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; background: rgba(15, 23, 42, 0.9); padding: 10px; border-radius: 12px; z-index: 100; transition: opacity 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .toolbar.hidden { opacity: 0; pointer-events: none; }
        .toolbar-group { display: flex; gap: 5px; border-right: 1px solid rgba(255,255,255,0.2); padding-right: 10px; margin-right: 5px; }
        .toolbar-group:last-child { border: none; }
        .btn-tool { padding: 8px 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid transparent; border-radius: 6px; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        .btn-tool:hover { background: rgba(255,255,255,0.2); }
        .btn-tool:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-undo { background: #eab308; color: #422006; }
        
        /* WIDGETS */
        .ambient-widget { position: absolute; bottom: 20px; right: 20px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); display: flex; gap: 20px; align-items: center; z-index: 90; }
        .chrono { font-family: monospace; font-size: 1.5rem; font-weight: bold; color: #3b82f6; cursor: pointer; min-width: 80px; text-align: center; }
        .chrono.alert { color: #ef4444; animation: pulse 1s infinite; }
        .sono-container { width: 100px; height: 10px; background: #334155; border-radius: 5px; overflow: hidden; }
        .sono-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #22c55e, #eab308, #ef4444); transition: width 0.1s; }
        
        .btn-projection { position: absolute; top: 20px; left: 20px; z-index: 100; background: #3b82f6; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        #debug-status { position: fixed; bottom: 0; left: 0; width: 350px; background: #000; color: #22c55e; font-size: 0.7rem; padding: 5px; z-index: 1000; font-family: monospace; }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Salle d'Attente</h2>
            <button class="btn-lock" id="btn-lock" onclick="toggleLock()">üîì Ouvert</button>
        </div>

        <div id="session-bar" style="padding:12px; background:#1a1a2e; border-bottom:1px solid #334155;">
            <label style="font-size:0.7rem; color:#888; text-transform:uppercase; letter-spacing:1px;">Session active</label>
            <div style="display:flex; gap:6px; margin-top:6px;">
                <button onclick="newSession()" style="flex:1; padding:7px; background:#2ecc71; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:0.8rem;">üÜï Nouvelle</button>
                <button onclick="resetSession()" style="flex:1; padding:7px; background:#e74c3c; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:0.8rem;">üóëÔ∏è Reset</button>
            </div>
            <div id="session-id-display" style="font-size:0.7rem; color:#64748b; margin-top:6px; text-align:center;"></div>
            <div style="text-align:center; margin-top:8px;">
                <img id="qr-code" src="" alt="QR" style="width:120px; height:120px; border-radius:8px; background:white; padding:4px; display:none;">
                <div id="qr-label" style="font-size:0.6rem; color:#64748b; margin-top:4px; display:none;">üì± Scannez pour rejoindre</div>
            </div>
        </div>

        <div class="waiting-room" id="waiting-room"></div>
        <div id="debug-status">Init...</div>
    </div>

    <div class="map-wrapper" id="map-wrapper">
        <button class="btn-projection" onclick="toggleProjection()">üì∫ Mode Projection</button>
        <div class="map-container" id="map-container">
            <svg id="connections"></svg>
            <div class="node level-0 selected" id="node-root" style="top: 400px; left: 500px;" data-id="root" ondblclick="editNodeText(this)">SUJET</div>
        </div>
        
        <div class="toolbar" id="toolbar">
            <div class="toolbar-group">
                <button class="btn-tool btn-undo" onclick="undoAction()" id="btn-undo" disabled>‚Ü©Ô∏è</button>
                <button class="btn-tool" onclick="resetView()">üéØ</button>
            </div>
            <div class="toolbar-group">
                <button class="btn-tool" onclick="addManualNode()" id="btn-add" disabled>‚ûï</button>
                <button class="btn-tool" onclick="deleteNode()" id="btn-del" disabled style="color:#f87171;">üóëÔ∏è</button>
            </div>
            <div class="toolbar-group">
                <button class="btn-tool" onclick="cutNode()" id="btn-cut" disabled>‚úÇÔ∏è</button>
                <button class="btn-tool" onclick="pasteNode()" id="btn-paste" disabled>üìã</button>
            </div>
            <div class="toolbar-group"><button class="btn-tool" onclick="window.print()">üñ®Ô∏è</button></div>
        </div>

        <div class="ambient-widget">
            <div style="text-align: center;">
                <div class="chrono" id="chrono" onclick="handleChronoClick()">00:00</div>
                <div style="font-size:0.6rem; color:#64748b;">Chrono / Minuteur</div>
            </div>
            <div>
                <div class="sono-container"><div class="sono-bar" id="sono-bar"></div></div>
                <div style="font-size:0.7rem; color:#94a3b8; text-align:center;">Micro</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, updateDoc, doc, setDoc, onSnapshot, query, where, getDocs, writeBatch, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI", authDomain: "devoirs-pse.firebaseapp.com", projectId: "devoirs-pse", storageBucket: "devoirs-pse.firebasestorage.app", messagingSenderId: "614730413904", appId: "1:614730413904:web:a5dd478af5de30f6bede55" };
        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app);

        const statusDiv = document.getElementById('debug-status');
        statusDiv.innerText = "üü¢ Firebase Connect√©. En attente...";

        // ‚îÄ‚îÄ SESSION / ROOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let currentSessionId = localStorage.getItem('mindmap_sessionId') || null;
        let unsubIdeas = null;

        function generateSessionId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 4); }

        window.newSession = async () => {
            currentSessionId = generateSessionId();
            localStorage.setItem('mindmap_sessionId', currentSessionId);
            await setDoc(doc(db, "mindmap_config", "global"), { sessionId: currentSessionId }, { merge: true });
            document.getElementById('session-id-display').textContent = 'üîë Session : ' + currentSessionId;
            // QR Code
            const url = 'https://preventionsanteenvironnement.github.io/PSE/eleve_collecte.html?mode=mindmap&sessionId=' + currentSessionId;
            document.getElementById('qr-code').src = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=0&color=0f172a&bgcolor=ffffff&data=' + encodeURIComponent(url);
            document.getElementById('qr-code').style.display = 'block';
            document.getElementById('qr-label').style.display = 'block';
            setupListeners();
        };

        window.resetSession = async () => {
            if (!currentSessionId) { alert("Aucune session active"); return; }
            if (!confirm("‚ö†Ô∏è Effacer toutes les donn√©es de cette session ?")) return;
            const batch = writeBatch(db);
            const qReset = query(collection(db, "mindmap_ideas"), where("sessionId", "==", currentSessionId));
            (await getDocs(qReset)).forEach(d => batch.delete(d.ref));
            await batch.commit();
            location.reload();
        };

        function setupListeners() {
            if (!currentSessionId) return;
            if (unsubIdeas) unsubIdeas();

            // GESTION SALLE D'ATTENTE
            const qWaiting = query(collection(db, "mindmap_ideas"), where("status", "==", "waiting"), where("sessionId", "==", currentSessionId));

            unsubIdeas = onSnapshot(qWaiting, (snapshot) => {
                const container = document.getElementById('waiting-room');
                container.innerHTML = "";
                if(snapshot.empty) { container.innerHTML = "<div style='text-align:center; color:#64748b; margin-top:20px; font-style:italic;'>En attente d'id√©es...</div>"; return; }
                statusDiv.innerText = `üü¢ Connect√© : ${snapshot.size} id√©e(s).`;
                let ideas = []; snapshot.forEach(doc => ideas.push({ id: doc.id, ...doc.data() }));
                ideas.sort((a, b) => a.timestamp - b.timestamp);
                ideas.forEach(idea => createIdeaCard(idea.id, idea.text, idea.student, idea.feedback));
            }, (err) => { statusDiv.innerText = "üî¥ ERREUR: " + err.message; statusDiv.style.color = "red"; });
        } // ‚Üê fin de setupListeners()

        // Auto-d√©marrage si session en m√©moire
        if (currentSessionId) {
            document.getElementById('session-id-display').textContent = 'üîë Session : ' + currentSessionId;
            const url = 'https://preventionsanteenvironnement.github.io/PSE/eleve_collecte.html?mode=mindmap&sessionId=' + currentSessionId;
            document.getElementById('qr-code').src = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=0&color=0f172a&bgcolor=ffffff&data=' + encodeURIComponent(url);
            document.getElementById('qr-code').style.display = 'block';
            document.getElementById('qr-label').style.display = 'block';
            setupListeners();
        }

        function createIdeaCard(id, text, student, hasLike) {
            const div = document.createElement('div'); div.className = 'idea-card';
            // ICI: On change l'ic√¥ne et le style si "hasLike" est vrai
            const likeIcon = hasLike ? "üëç" : "üëç"; 
            const likeStyle = hasLike ? "opacity:1; transform:scale(1.1); background:#2563eb;" : "opacity:0.5;";
            
            div.innerHTML = `
                <div class="idea-meta"><span>üë§ ${escapeHtml(student || 'Anonyme')}</span></div>
                <div class="idea-text">${escapeHtml(text)}</div>
                <input type="text" class="idea-input-edit" value="${escapeHtml(text)}">
                <div class="idea-actions">
                    <button class="btn-action btn-like" style="${likeStyle}" onclick="window.sendLikeFirebase('${id}', this)">${likeIcon}</button>
                    <button class="btn-action btn-edit" onclick="window.toggleEditIdea(this)">‚úèÔ∏è</button>
                    <button class="btn-action btn-valid" onclick="window.acceptFirebase('${id}', this)">‚úÖ</button>
                    <button class="btn-action btn-reject" onclick="window.rejectFirebase('${id}', this)">‚ùå</button>
                </div>
            `;
            document.getElementById('waiting-room').appendChild(div);
        }

        window.sendLikeFirebase = async (id, btn) => {
            btn.style.opacity = "1"; btn.style.transform = "scale(1.2)";
            try { await updateDoc(doc(db, "mindmap_ideas", id), { feedback: true }); } catch(e) {}
        };
        window.acceptFirebase = async (id, btn) => {
            if(!selectedNode) { alert("S√©lectionne une branche !"); return; }
            const c=btn.closest('.idea-card'), s=c.querySelector('.idea-text'), i=c.querySelector('.idea-input-edit');
            const txt = i.style.display==='block' ? i.value : s.textContent;
            createNode(txt, selectedNode); await updateDoc(doc(db, "mindmap_ideas", id), { status: "accepted", text: txt });
        };
        window.rejectFirebase = async (id, btn) => await updateDoc(doc(db, "mindmap_ideas", id), { status: "rejected" });
        window.toggleEditIdea = (btn) => { const c=btn.closest('.idea-card'), s=c.querySelector('.idea-text'), i=c.querySelector('.idea-input-edit'); if(i.style.display==='none'||!i.style.display){ i.style.display='block'; s.style.display='none'; i.focus(); btn.style.background='#22c55e'; btn.innerText='üíæ'; } else{ s.textContent=i.value; i.style.display='none'; s.style.display='block'; btn.style.background='#f59e0b'; btn.innerText='‚úèÔ∏è'; }};
        function escapeHtml(t) { return t ? t.replace(/&/g,"&amp;").replace(/</g,"&lt;") : ""; }

        // GESTION LOCK
        let isLocked=false;
        window.toggleLock = async () => { isLocked=!isLocked; const b=document.getElementById('btn-lock'); b.innerHTML=isLocked?"üîí Verrouill√©":"üîì Ouvert"; b.classList.toggle('locked',isLocked); await setDoc(doc(db,"mindmap_config","global_state"),{isLocked:isLocked},{merge:true}); };

        // PROJECTION (AUTO SI URL ?mode=projection)
        let isProjection=false;
        window.toggleProjection = () => {
            isProjection=!isProjection;
            document.getElementById('sidebar').classList.toggle('hidden',isProjection);
            document.getElementById('toolbar').classList.toggle('hidden',isProjection);
            const btn=document.querySelector('.btn-projection');
            btn.innerText=isProjection?"‚ùå Quitter":"üì∫ Mode Projection";
            btn.style.opacity=isProjection?"0.5":"1";
        };
        // Auto-projection au chargement
        if(new URLSearchParams(window.location.search).get('mode') === 'projection') { toggleProjection(); }

        // CHRONO & SONO
        let ti, ir=false, ts=0;
        window.handleChronoClick = () => {
            if(ir){ clearInterval(ti); ir=false; document.getElementById('chrono').style.color="#3b82f6"; return; }
            const inp=prompt("Minuteur (min) ? Vide=Chrono"); clearInterval(ti); document.getElementById('chrono').classList.remove('alert');
            if(inp && parseInt(inp)>0){ ts=parseInt(inp)*60; updC(ts); ti=setInterval(()=>{ ts--; updC(ts); if(ts<=0){clearInterval(ti); ir=false; document.getElementById('chrono').classList.add('alert'); document.getElementById('chrono').innerText="FIN!";} },1000); }
            else{ ts=0; updC(0); ti=setInterval(()=>{ ts++; updC(ts); },1000); }
            ir=true;
        };
        function updC(s){ document.getElementById('chrono').innerText=`${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{ const c=new (window.AudioContext||window.webkitAudioContext)(), a=c.createAnalyser(), m=c.createMediaStreamSource(s); m.connect(a); a.fftSize=256; const d=new Uint8Array(a.frequencyBinCount); function dr(){ requestAnimationFrame(dr); a.getByteFrequencyData(d); let sm=0; for(let i=0;i<d.length;i++)sm+=d[i]; document.getElementById('sono-bar').style.width=Math.min(100,(sm/d.length/50)*100)+"%"; } dr(); }).catch(()=>{});

        // MAP LOGIC
        let sn=document.getElementById('node-root'), cn=null, hs=[], sc=1, px=0, py=0, idm=false, spx=0, spy=0, dn=null, dsx=0, dsy=0, inl=0, int=0;
        const mw=document.getElementById('map-wrapper'), mc=document.getElementById('map-container');
        const sub = prompt("Sujet ?", "Le Stress"); document.getElementById('node-root').innerText=sub||"SUJET";
        saveState(); updateToolbar(); updateTransform(); updateFirebaseContext(document.getElementById('node-root').innerText);
        async function updateFirebaseContext(txt){ await setDoc(doc(db,"mindmap_config","global_state"),{currentFocus:txt},{merge:true}); }

        mw.addEventListener('wheel',e=>{ e.preventDefault(); sc=Math.min(Math.max(0.2,sc+(-e.deltaY*0.001)),4); updateTransform(); });
        mw.addEventListener('mousedown',e=>{ if(e.target===mw||e.target.tagName==='svg'||e.target===mc){ idm=true; spx=e.clientX-px; spy=e.clientY-py; mw.style.cursor='grabbing'; selectNode(null); }});
        window.addEventListener('mousemove',e=>{ if(idm){ px=e.clientX-spx; py=e.clientY-spy; updateTransform(); } else if(dn){ e.preventDefault(); const dx=(e.clientX-dsx)/sc; const dy=(e.clientY-dsy)/sc; dn.style.left=(inl+dx)+'px'; dn.style.top=(int+dy)+'px'; updateAllLines(); }});
        window.addEventListener('mouseup',()=>{ if(idm){idm=false; mw.style.cursor='grab';} if(dn){dn=null; saveState();} });

        function ind(n){ n.addEventListener('mousedown',e=>{ if(e.button!==0)return; e.stopPropagation(); dn=n; selectNode(n); dsx=e.clientX; dsy=e.clientY; inl=parseFloat(n.style.left)||0; int=parseFloat(n.style.top)||0; }); }
        ind(document.getElementById('node-root'));
        function updateTransform(){ mc.style.transform=`translate(${px}px,${py}px) scale(${sc})`; }
        
        window.resetView = () => { px=0; py=0; sc=1; updateTransform(); };
        window.addManualNode = () => { const t=prompt("Nouveau noeud :"); if(t) createNode(t, sn); };
        window.deleteNode = () => { if(confirm("Supprimer ?")){ saveState(); deleteRecursive(sn); sn=null; updateAllLines(); saveState(); updateToolbar(); }};
        window.cutNode = () => { cn=sn; sn.style.opacity='0.5'; updateToolbar(); };
        window.pasteNode = () => { if(!cn)return; saveState(); cn.style.opacity='1'; cn.dataset.parentId=sn.dataset.id||'root'; document.querySelectorAll(`line[data-to="${cn.dataset.id}"]`).forEach(l=>l.remove()); createConnectionLine(sn, cn); cn=null; saveState(); updateToolbar(); };
        window.undoAction = () => { if(hs.length<=1)return; hs.pop(); rebuildMap(JSON.parse(hs[hs.length-1])); updateToolbar(); };
        window.editNodeText = (n) => { const t=prompt("Modifier:", n.innerText); if(t){ saveState(); n.innerText=t; saveState(); updateFirebaseContext(t); }};

        function selectNode(el) { document.querySelectorAll('.node').forEach(n=>n.classList.remove('selected')); if(el){ el.classList.add('selected'); updateFirebaseContext(el.innerText); } else { updateFirebaseContext("G√©n√©ral"); } sn=el; updateToolbar(); }
        function createNode(t, p) { saveState(); const d=document.createElement('div'); const pl=parseInt(p.classList[1].split('-')[1]); const l=Math.min(pl+1,3); const id='n-'+Date.now(); const x=parseFloat(p.style.left), y=parseFloat(p.style.top); const a=Math.random()*6.28, dist=[250,200,150,100][l]||100; d.className=`node level-${l}`; d.innerText=t; d.style.left=(x+Math.cos(a)*dist)+'px'; d.style.top=(y+Math.sin(a)*dist)+'px'; d.dataset.id=id; d.dataset.parentId=p.dataset.id||'root'; ind(d); d.ondblclick=function(){window.editNodeText(this)}; d.onclick=(e)=>{e.stopPropagation();selectNode(div)}; mc.appendChild(d); createConnectionLine(p,d); saveState(); return d; }
        function createConnectionLine(p,c){ const s=document.getElementById('connections'), l=document.createElementNS('http://www.w3.org/2000/svg','line'); const lev=parseInt(c.classList[1].split('-')[1]); const cols=['#facc15','#60a5fa','#a78bfa','#34d399']; l.setAttribute('stroke',cols[lev]||'#fff'); l.setAttribute('stroke-width',Math.max(1,4-lev)); l.setAttribute('stroke-opacity',0.6); l.dataset.from=p.dataset.id||'root'; l.dataset.to=c.dataset.id; s.appendChild(l); updateLinePos(l,p,c); }
        function updateLinePos(l,e1,e2){ l.setAttribute('x1',e1.style.left); l.setAttribute('y1',e1.style.top); l.setAttribute('x2',e2.style.left); l.setAttribute('y2',e2.style.top); }
        function updateAllLines(){ const ns=Array.from(document.querySelectorAll('.node')), m={}; ns.forEach(n=>m[n.dataset.id||'root']=n); document.querySelectorAll('line').forEach(l=>{ const n1=m[l.dataset.from], n2=m[l.dataset.to]; if(n1&&n2)updateLinePos(l,n1,n2); else l.remove(); }); }
        function deleteRecursive(n){ Array.from(document.querySelectorAll(`.node[data-parent-id="${n.dataset.id}"]`)).forEach(deleteRecursive); n.remove(); }
        function saveState(){ const d=[]; document.querySelectorAll('.node').forEach(n=>{ d.push({id:n.dataset.id||'root',text:n.innerText,level:parseInt(n.classList[1].split('-')[1]),left:n.style.left,top:n.style.top,parentId:n.dataset.parentId||null}); }); if(hs.length>20)hs.shift(); hs.push(JSON.stringify(d)); updateToolbar(); }
        function rebuildMap(data){ document.getElementById('connections').innerHTML=''; document.querySelectorAll('.node').forEach(n=>n.remove()); const m={}; data.forEach(d=>{ const div=document.createElement('div'); div.className=`node level-${d.level}`; if(d.id==='root')div.classList.add('selected'); div.innerText=d.text; div.style.left=d.left; div.style.top=d.top; div.dataset.id=d.id; div.dataset.parentId=d.parentId; div.id=d.id==='root'?'node-root':''; ind(div); div.ondblclick=function(){window.editNodeText(this)}; div.onclick=(e)=>{e.stopPropagation();selectNode(div)}; mc.appendChild(div); m[d.id]=div; }); data.forEach(d=>{ if(d.parentId&&m[d.parentId]&&m[d.id]) createConnectionLine(m[d.parentId],m[d.id]); }); sn=m['root']||document.getElementById('node-root'); updateToolbar(); }
        function updateToolbar(){ const has=!!sn; document.getElementById('btn-undo').disabled=hs.length<=1; document.getElementById('btn-add').disabled=!has; document.getElementById('btn-del').disabled=!has||sn.id==='node-root'; document.getElementById('btn-cut').disabled=!has||sn.id==='node-root'; document.getElementById('btn-paste').disabled=!has||!clipboardNode; }
    </script>
</body>
</html>

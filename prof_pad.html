<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>PAD - Professeur</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- STYLE PROFESSEUR (TABLEAU DE BORD) --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: white; display: flex; height: 100vh; overflow: hidden; user-select: none; }
        
        /* SIDEBAR GAUCHE */
        .sidebar { width: 300px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 20; flex-shrink: 0; }
        .sidebar.hidden { display: none; }
        .sidebar-header { padding: 15px; background: #0f172a; border-bottom: 1px solid #334155; display:flex; justify-content:space-between; align-items:center; }
        .sidebar-section { flex-grow: 1; overflow-y: auto; padding: 10px; border-bottom: 1px solid #334155; }
        .section-title { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: bold; margin-bottom: 10px; display:flex; justify-content:space-between; }

        /* ZONE PRINCIPALE (GRILLE) */
        .main-content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; position: relative; overflow-y: auto; }
        .btn-projection { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: #3b82f6; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; z-index: 50; }

        /* PAD CONTAINER */
        .pad-container { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto auto; gap: 30px; max-width: 1000px; margin: 0 auto; width: 100%; padding-bottom: 80px; }
        
        /* ZONES */
        .zone { position: relative; padding: 15px; min-height: 120px; border: 3px solid transparent; background: rgba(255,255,255,0.05); transition: 0.3s; cursor: pointer; display: flex; flex-direction: column; }
        .zone:hover { transform: scale(1.02); }
        .zone.active { border-color: white; box-shadow: 0 0 25px rgba(255,255,255,0.2); z-index: 10; transform: scale(1.03); }
        .zone-header { font-weight: 800; text-transform: uppercase; font-size: 1rem; margin-bottom: 10px; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; }
        .zone-content { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }

        /* COULEURS */
        .zone-SD { background: #f87171; color: #450a0a; border-radius: 10px; }
        .zone-ED { background: #fbbf24; color: #451a03; border-radius: 10px; }
        .oval-container { grid-column: 1 / -1; display: flex; justify-content: center; align-items: center; position: relative; height: 200px; }
        .zone-D { width: 45%; height: 100%; background: #fef08a; color: #422006; border-radius: 50% 0 0 50%; margin-right: -20px; padding-right: 40px; clip-path: ellipse(60% 50% at 40% 50%); }
        .zone-O { width: 45%; height: 100%; background: #bae6fd; color: #082f49; border-radius: 0 50% 50% 0; margin-left: -20px; padding-left: 40px; clip-path: ellipse(60% 50% at 60% 50%); }
        .zone-DP { grid-column: 1 / -1; background: #86efac; color: #064e3b; border-radius: 15px; margin: 0 20%; text-align: center; }
        .flash { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 4rem; color: #f59e0b; text-shadow: 0 0 15px #fef08a; z-index: 5; animation: pulseFlash 2s infinite; pointer-events: none; }
        .arrow-down { position: absolute; font-size: 2rem; color: rgba(255,255,255,0.3); pointer-events: none; }

        /* ETIQUETTES & ATTENTE */
        .item-tag { background: rgba(255,255,255,0.7); color: black; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .del-btn { cursor: pointer; color: #ef4444; font-weight: bold; margin-left: 5px; }
        .idea-card { background: #334155; padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9rem; border-left: 3px solid #94a3b8; }
        .idea-input { width: 100%; background: #0f172a; border: 1px solid #475569; color: white; padding: 5px; border-radius: 4px; display: none; }
        .btn-act { border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-weight:bold; margin-right:3px; }

        /* PRESENTS */
        .student-item { display: flex; justify-content: space-between; align-items: center; background: #0f172a; padding: 5px; margin-bottom: 3px; border-radius: 4px; font-size: 0.8rem; }
        .btn-call { background: #eab308; border:none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 0.7rem; }

        /* WIDGETS */
        .ambient-widget { position: absolute; bottom: 15px; right: 15px; background: #1e293b; padding: 10px; border-radius: 10px; display: flex; gap: 15px; align-items: center; border: 1px solid #334155; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 100; }
        .chrono { font-family: monospace; font-size: 1.2rem; font-weight: bold; color: #3b82f6; cursor: pointer; width: 60px; text-align: center; }
        .chrono.alert { color: #ef4444; animation: pulse 1s infinite; }
        .sono-box { width: 80px; height: 10px; background: #0f172a; border-radius: 4px; overflow: hidden; }
        .sono-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #22c55e, #eab308, #ef4444); transition: width 0.1s; }

        @keyframes pulseFlash { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.1); } 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>PAD PROF</h2>
            <button onclick="toggleLock()" id="btn-lock" style="background:none; border:1px solid #22c55e; color:#22c55e; padding:3px 8px; border-radius:4px; cursor:pointer;">üîì</button>
        </div>
        
        <div class="sidebar-section" style="flex: 1;">
            <div class="section-title">En Attente <span onclick="clearWaiting()" style="cursor:pointer; color:#ef4444;">(Tout rejeter)</span></div>
            <div id="waiting-room"></div>
        </div>

        <div class="sidebar-section" style="height: 150px; background:#162032;">
            <div class="section-title">üë• Pr√©sents <span id="student-count">(0)</span></div>
            <div id="student-list"></div>
        </div>

        <div style="padding:15px; border-top:1px solid #334155;">
            <button onclick="resetTotal()" style="width:100%; background:#ef4444; color:white; border:none; padding:10px; border-radius:6px; font-weight:bold; cursor:pointer;">üóëÔ∏è RESET TOTAL</button>
        </div>
    </div>

    <div class="main-content">
        <button class="btn-projection" onclick="toggleProjection()">üì∫ Mode Projection</button>

        <div class="pad-container">
            <div class="zone zone-SD" onclick="selectZone('SD')" id="zone-SD">
                <div class="zone-header">SITUATION DANGEREUSE</div>
                <div class="zone-content" id="list-SD"></div>
                <div class="arrow-down" style="bottom:-20px; left:50%;">‚¨á</div>
            </div>
            
            <div class="zone zone-ED" onclick="selectZone('ED')" id="zone-ED">
                <div class="zone-header">√âV√âNEMENT D√âCLENCHEUR</div>
                <div class="zone-content" id="list-ED"></div>
                <div class="arrow-down" style="bottom:-20px; left:50%;">‚¨á</div>
            </div>

            <div class="oval-container">
                <div class="zone zone-D" onclick="selectZone('D')" id="zone-D">
                    <div class="zone-header">DANGER</div>
                    <div class="zone-content" id="list-D"></div>
                </div>
                <div class="flash">‚ö°</div>
                <div class="zone zone-O" onclick="selectZone('O')" id="zone-O">
                    <div class="zone-header">OP√âRATEUR</div>
                    <div class="zone-content" id="list-O"></div>
                </div>
                <div class="arrow-down" style="bottom:-30px; color:#f87171;">‚¨á</div>
            </div>

            <div class="zone zone-DP" onclick="selectZone('DP')" id="zone-DP">
                <div class="zone-header">DOMMAGE POTENTIEL</div>
                <div class="zone-content" id="list-DP"></div>
            </div>
        </div>

        <div class="ambient-widget">
            <div onclick="handleChronoClick()"><div class="chrono" id="chrono">00:00</div></div>
            <div style="display:flex; align-items:center;">
                <div class="sono-box"><div class="sono-bar" id="sono-bar"></div></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, setDoc, onSnapshot, query, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI", authDomain: "devoirs-pse.firebaseapp.com", projectId: "devoirs-pse", storageBucket: "devoirs-pse.firebasestorage.app", messagingSenderId: "614730413904", appId: "1:614730413904:web:a5dd478af5de30f6bede55" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let activeZone = 'SD';
        let isProjection = new URLSearchParams(window.location.search).get('mode') === 'projection';

        // INIT
        if(isProjection) {
            document.getElementById('sidebar').classList.add('hidden');
            document.querySelector('.btn-projection').style.display = 'none';
        } else {
            setTimeout(() => selectZone('SD'), 1000);
        }

        window.toggleProjection = () => { const url = new URL(window.location.href); url.searchParams.set("mode", "projection"); window.open(url.toString(), "_blank"); };

        // SELECTION ZONE
        window.selectZone = async (code) => {
            if(isProjection) return;
            document.querySelectorAll('.zone').forEach(z => z.classList.remove('active'));
            document.getElementById('zone-'+code).classList.add('active');
            activeZone = code;
            const labels = { SD: "Situation Dangereuse", ED: "Ev√©nement D√©clencheur", D: "Danger", O: "Op√©rateur", DP: "Dommage Potentiel" };
            try { await setDoc(doc(db, "pad_config", "global"), { currentZone: code, currentLabel: labels[code] }, { merge: true }); } catch(e){}
        };

        // GESTION ITEMS (SCHEMA)
        onSnapshot(collection(db, "pad_items"), (snap) => {
            ['SD','ED','D','O','DP'].forEach(c => { const z = document.getElementById('list-'+c); if(z) z.innerHTML=""; });
            snap.forEach(d => {
                const data = d.data();
                const container = document.getElementById('list-' + data.category);
                if(container) {
                    const div = document.createElement('div');
                    div.className = 'item-tag';
                    const delHtml = isProjection ? '' : `<span class="del-btn" onclick="delItem('${d.id}')">‚ùå</span>`;
                    div.innerHTML = `<span>${escapeHtml(data.text)}</span> ${delHtml}`;
                    container.appendChild(div);
                }
            });
        });
        window.delItem = async (id) => { if(confirm("Suppr?")) await deleteDoc(doc(db, "pad_items", id)); };

        // SALLE D'ATTENTE
        if(!isProjection) {
            const q = query(collection(db, "pad_ideas"), where("status", "==", "waiting"));
            onSnapshot(q, (snap) => {
                const div = document.getElementById('waiting-room');
                div.innerHTML = "";
                if(snap.empty) div.innerHTML = "<div style='color:#64748b;text-align:center;font-size:0.8rem;'>Vide...</div>";
                
                snap.forEach(d => {
                    const data = d.data();
                    const card = document.createElement('div');
                    card.className = 'idea-card';
                    card.innerHTML = `
                        <div style="font-size:0.8rem; color:#aaa;">üë§ ${escapeHtml(data.student)}</div>
                        <div class="text-display" style="margin:5px 0; font-weight:bold;">${escapeHtml(data.text)}</div>
                        <input type="text" class="idea-input" value="${escapeHtml(data.text)}">
                        <div style="display:flex;">
                            <button class="btn-act" style="background:#f59e0b;color:white;" onclick="toggleEdit(this)">‚úèÔ∏è</button>
                            <button class="btn-act" style="background:#3b82f6;color:white;" onclick="doLike('${d.id}')">üëç</button>
                            <button class="btn-act" style="background:#22c55e;color:#064e3b;" onclick="doAccept('${d.id}', this)">‚úÖ</button>
                            <button class="btn-act" style="background:#ef4444;color:#7f1d1d;" onclick="doReject('${d.id}')">‚ùå</button>
                        </div>
                    `;
                    div.appendChild(card);
                });
            });
        }

        window.toggleEdit = (btn) => {
            const parent = btn.closest('.idea-card');
            const display = parent.querySelector('.text-display');
            const input = parent.querySelector('.idea-input');
            if (input.style.display === 'none' || !input.style.display) {
                input.style.display = 'block'; display.style.display = 'none'; input.focus(); btn.style.background = '#22c55e';
            } else {
                display.innerText = input.value; input.style.display = 'none'; display.style.display = 'block'; btn.style.background = '#f59e0b';
            }
        };

        window.doAccept = async (id, btn) => {
            const input = btn.closest('.idea-card').querySelector('.idea-input');
            await addDoc(collection(db, "pad_items"), { text: input.value, category: activeZone });
            await updateDoc(doc(db, "pad_ideas", id), { status: "accepted" });
        };
        window.doReject = async (id) => await updateDoc(doc(db, "pad_ideas", id), { status: "rejected" });
        window.doLike = async (id) => await updateDoc(doc(db, "pad_ideas", id), { feedback: true });
        
        window.clearWaiting = async () => {
            if(!confirm("Tout rejeter ?")) return;
            const snap = await getDocs(query(collection(db, "pad_ideas"), where("status", "==", "waiting")));
            const batch = writeBatch(db);
            snap.forEach(d => batch.update(doc(db, "pad_ideas", d.id), { status: "rejected" }));
            await batch.commit();
        };

        // RESET TOTAL
        window.resetTotal = async () => {
            if(!confirm("‚ö†Ô∏è ATTENTION : Cela efface TOUT (Sch√©ma complet + Attente + Liste √©l√®ves).\n\nContinuer ?")) return;
            const batch = writeBatch(db);
            (await getDocs(collection(db, "pad_items"))).forEach(d => batch.delete(d.ref));
            (await getDocs(collection(db, "pad_ideas"))).forEach(d => batch.delete(d.ref));
            (await getDocs(collection(db, "pad_presence"))).forEach(d => batch.delete(d.ref));
            await batch.commit();
            location.reload();
        };

        // GESTION ELEVES
        if(!isProjection) {
            onSnapshot(collection(db, "pad_presence"), (snap) => {
                const list = document.getElementById('student-list'); list.innerHTML = "";
                let count = 0;
                snap.forEach(d => {
                    count++;
                    const div = document.createElement('div');
                    div.className = 'student-item';
                    div.innerHTML = `<span>üë§ ${escapeHtml(d.data().name)}</span> <button class="btn-call" onclick="callStudent('${d.data().name}')">üì¢</button>`;
                    list.appendChild(div);
                });
                document.getElementById('student-count').innerText = `(${count})`;
            });
        }
        window.callStudent = (name) => {
            setDoc(doc(db, "pad_config", "global"), { solicitedStudent: name }, { merge: true });
            setTimeout(() => setDoc(doc(db, "pad_config", "global"), { solicitedStudent: null }, { merge: true }), 5000);
        };

        // LOCK & CHRONO
        let isLocked = false;
        window.toggleLock = async () => {
            isLocked = !isLocked;
            document.getElementById('btn-lock').innerText = isLocked ? "üîí" : "üîì";
            await setDoc(doc(db, "pad_config", "global"), { isLocked: isLocked }, { merge: true });
        };

        let ti, ir=false, ts=0;
        window.handleChronoClick=()=>{ if(ir){clearInterval(ti);ir=false;document.getElementById('chrono').style.color="#3b82f6";return;} const i=prompt("Minuteur?"); clearInterval(ti); document.getElementById('chrono').classList.remove('alert'); if(i&&parseInt(i)>0){ ts=parseInt(i)*60; updC(ts); ti=setInterval(()=>{ ts--; updC(ts); if(ts<=0){clearInterval(ti);ir=false;document.getElementById('chrono').classList.add('alert');document.getElementById('chrono').innerText="FIN!";} },1000); } else { ts=0; updC(0); ti=setInterval(()=>{ ts++; updC(ts); },1000); } ir=true; };
        function updC(s){ document.getElementById('chrono').innerText=`${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{ const c=new(window.AudioContext||window.webkitAudioContext)(), a=c.createAnalyser(), m=c.createMediaStreamSource(s); m.connect(a); a.fftSize=256; const d=new Uint8Array(a.frequencyBinCount); function dr(){ requestAnimationFrame(dr); a.getByteFrequencyData(d); let sm=0; for(let i=0;i<d.length;i++)sm+=d[i]; document.getElementById('sono-bar').style.width=Math.min(100,(sm/d.length/50)*100)+"%"; } dr(); }).catch(()=>{});

        function escapeHtml(t) { return t ? t.replace(/&/g,"&amp;").replace(/</g,"&lt;") : ""; }
    </script>
</body>
</html>

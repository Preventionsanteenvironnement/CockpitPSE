<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Vrai/Faux Diagnostic - Prof</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #121212; color: white; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        #left-panel { width: 380px; background: #1e1e1e; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; box-shadow: 5px 0 15px rgba(0,0,0,0.2); z-index: 10; overflow-y: auto; }
        h2 { font-size: 1.1rem; color: #ccc; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 20px;}
        h2:first-child { margin-top: 0; }
        .control-group { background: #252525; padding: 15px; border-radius: 10px; border: 1px solid #333; }
        input[type="text"], select { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 6px; margin-bottom: 10px; font-family: inherit; font-size: 0.9rem; box-sizing: border-box;}
        label { font-size: 0.75rem; color: #888; margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 1px; }

        .btn-action { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; border: none; margin-top: 5px; transition: 0.2s; }
        .btn-add { background: #8e44ad; color: white; }
        .btn-add:hover { background: #9b59b6; }
        .btn-launch { background: #3498db; color: white; }
        .btn-launch:hover { background: #2980b9; }

        #playlist-container { flex-grow: 1; margin-top: 10px; }
        .playlist-item { background: #2a2a2a; border-radius: 6px; padding: 10px; margin-bottom: 8px; border-left: 4px solid #555; display: flex; flex-direction: column; gap: 5px; transition: 0.2s; }
        .playlist-item:hover { background: #333; }
        .pl-q { font-weight: bold; font-size: 0.9rem; }
        .pl-infos { font-size: 0.75rem; color: #aaa; display: flex; justify-content: space-between; }
        .pl-actions { display: flex; gap: 5px; margin-top: 5px; }
        .btn-pl { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: bold; flex: 1; }
        .btn-pl-go { background: #2ecc71; color: white; } .btn-pl-del { background: #444; color: #ccc; max-width: 30px; }

        #main-panel { flex-grow: 1; padding: 40px; display: flex; flex-direction: column; position: relative; }
        #top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .tool-group { display: flex; gap: 15px; }
        .tool-box { background: #333; padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 10px; font-weight: bold; font-variant-numeric: tabular-nums; }
        
        #results-container { flex-grow: 1; display: flex; gap: 50px; align-items: flex-end; justify-content: center; padding-bottom: 50px; }
        .bar-wrapper { width: 30%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; position: relative; }
        .bar { width: 100%; background: #555; border-radius: 15px 15px 0 0; transition: height 0.5s ease-out; display: flex; align-items: flex-end; justify-content: center; overflow: hidden; min-height: 0px; opacity: 1; transition: 0.5s;}
        .bar-label { font-size: 3rem; font-weight: 900; margin-top: 20px; text-transform: uppercase; }
        .bar-val { font-size: 4rem; font-weight: 900; color: white; margin-bottom: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 2; }
        #bar-vrai { background: #27ae60; box-shadow: 0 0 30px rgba(39, 174, 96, 0.3); }
        #bar-faux { background: #c0392b; box-shadow: 0 0 30px rgba(192, 57, 43, 0.3); }

        #display-question { font-size: 2.5rem; font-weight: bold; text-align: center; margin-bottom: 40px; min-height: 80px; text-shadow: 0 0 20px rgba(255,255,255,0.1); }

        /* BOUTON REVELATION */
        #btn-reveal { 
            background: #f1c40f; color: #333; border: none; padding: 10px 20px; 
            border-radius: 30px; font-weight: 900; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.3); opacity: 0.5; pointer-events: none; transition: 0.3s;
        }
        #btn-reveal.ready { opacity: 1; pointer-events: all; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .action-btn { width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; background: #444; color: white; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: 0.2s;}
        .action-btn:hover { background: #666; transform: scale(1.1); }
        .btn-lock.locked { background: #e74c3c; }
        .btn-reset { background: #c0392b; }
        #sono-fill { width: 8px; height: 20px; background: #2ecc71; border-radius: 4px; transition: height 0.1s; }
        #bilan-overlay { position: absolute; bottom: 20px; right: 20px; background: #2a2a2a; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; max-width: 300px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-size: 0.9rem;}

    </style>
</head>
<body>

    <div id="left-panel">
        <div id="session-bar" style="padding:12px; background:#1a1a2e; border-bottom:1px solid #334155; margin-bottom:10px; border-radius:8px;">
            <label style="font-size:0.7rem; color:#888; text-transform:uppercase; letter-spacing:1px;">Session active</label>
            <div style="display:flex; gap:6px; margin-top:6px;">
                <button onclick="newSession()" style="flex:1; padding:7px; background:#2ecc71; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:0.8rem;">üÜï Nouvelle</button>
                <button onclick="resetSession()" style="flex:1; padding:7px; background:#e74c3c; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:0.8rem;">üóëÔ∏è Reset</button>
            </div>
            <div id="session-id-display" style="font-size:0.7rem; color:#64748b; margin-top:6px; text-align:center;"></div>
            <div style="text-align:center; margin-top:8px;">
                <img id="qr-code" src="" alt="QR" style="width:120px; height:120px; border-radius:8px; background:white; padding:4px; display:none;">
                <div id="qr-label" style="font-size:0.6rem; color:#64748b; margin-top:4px; display:none;">üì± Scannez pour rejoindre</div>
            </div>
        </div>
        <h2>üõ†Ô∏è Cr√©ateur de Question</h2>
        <div class="control-group">
            <label>Question</label>
            <input type="text" id="input-q" placeholder="Ex: On peut rattraper le sommeil...">
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>R√©ponse</label>
                    <select id="input-correct">
                        <option value="VRAI">VRAI</option>
                        <option value="FAUX">FAUX</option>
                    </select>
                </div>
                <div style="flex:2">
                    <label>Notion</label>
                    <input type="text" id="input-notion" placeholder="Ex: Cycles sommeil">
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-action btn-add" onclick="addToPlaylist()">+ AJOUTER</button>
                <button class="btn-action btn-launch" onclick="launchDirect()">LANCER</button>
            </div>
        </div>
        <h2>üìã Playlist</h2>
        <div id="playlist-container"><div style="color:#666; font-style:italic; text-align:center; padding:20px;">Vide.</div></div>
    </div>

    <div id="main-panel">
        <div id="top-bar">
            <div class="tool-group">
                <button class="action-btn" id="btn-lock" onclick="toggleLock()" title="Verrouiller">üîì</button>
                <button class="action-btn btn-reset" onclick="resetVotes()" title="Effacer">üóëÔ∏è</button>
            </div>
            
            <button id="btn-reveal" onclick="revealAnswer()">‚ú® R√âV√âLER</button>

            <div class="tool-group">
                <div class="tool-box"><span>‚è≥</span><span id="timer-display">00:30</span><button class="action-btn" style="width:25px; height:25px; font-size:0.8rem;" onclick="startTimer()">‚ñ∂</button></div>
                <div class="tool-box"><span>üîä</span><div style="height:20px; width:8px; background:#333; border-radius:4px; overflow:hidden; position:relative;"><div id="sono-fill" style="position:absolute; bottom:0; left:0; width:100%; height:10%;"></div></div></div>
            </div>
        </div>

        <div id="display-question">En attente...</div>

        <div id="results-container">
            <div class="bar-wrapper">
                <div class="bar" id="bar-vrai" style="height: 0%;"><span class="bar-val" id="val-vrai">0%</span></div>
                <div class="bar-label" style="color:#27ae60">VRAI</div>
            </div>
            <div class="bar-wrapper">
                <div class="bar" id="bar-faux" style="height: 0%;"><span class="bar-val" id="val-faux">0%</span></div>
                <div class="bar-label" style="color:#c0392b">FAUX</div>
            </div>
        </div>
        <div id="bilan-overlay">Bilan mis √† jour !</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, getDocs, deleteDoc, writeBatch, addDoc, orderBy, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.firebasestorage.app",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55",
            measurementId: "G-7R9N0JL6GG"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let totalVotes = 0; let counts = { VRAI: 0, FAUX: 0 };
        let currentCorrectAnswer = ""; let currentNotion = "";

        // --- SESSION SYSTEM ---
        let currentSessionId = localStorage.getItem('vraifaux_sessionId') || null;
        let unsubListeners = [];

        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 4);
        }

        window.newSession = async () => {
            currentSessionId = generateSessionId();
            localStorage.setItem('vraifaux_sessionId', currentSessionId);
            await setDoc(doc(db, "vraifaux_etat", "config"), { sessionId: currentSessionId }, { merge: true });
            document.getElementById('session-id-display').innerText = 'Session: ' + currentSessionId;
            const qrUrl = 'https://preventionsanteenvironnement.github.io/PSE/eleve_vraifaux.html?sessionId=' + currentSessionId;
            const qrImg = document.getElementById('qr-code');
            qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=' + encodeURIComponent(qrUrl);
            qrImg.style.display = 'block';
            document.getElementById('qr-label').style.display = 'block';
            setupListeners();
        };

        window.resetSession = async () => {
            if(!confirm("Supprimer toutes les donn√©es de cette session ?")) return;
            const snap = await getDocs(query(collection(db, "vraifaux_reponses"), where("sessionId", "==", currentSessionId)));
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
        };

        // --- SETUP LISTENERS (session-filtered) ---
        function setupListeners() {
            unsubListeners.forEach(fn => fn());
            unsubListeners = [];

            if(!currentSessionId) return;

            // ECOUTE VOTES (filtered by session)
            const unsub1 = onSnapshot(query(collection(db, "vraifaux_reponses"), where("sessionId", "==", currentSessionId)), (snap) => {
                counts = { VRAI: 0, FAUX: 0 }; totalVotes = 0;
                snap.forEach(doc => { const data = doc.data(); if(data.vote) { counts[data.vote]++; totalVotes++; } });
                updateBars();
            });
            unsubListeners.push(unsub1);
        }

        function updateBars() {
            const pVrai = totalVotes === 0 ? 0 : Math.round((counts.VRAI / totalVotes) * 100);
            const pFaux = totalVotes === 0 ? 0 : Math.round((counts.FAUX / totalVotes) * 100);
            document.getElementById('bar-vrai').style.height = pVrai + "%";
            document.getElementById('val-vrai').innerText = pVrai + "%";
            document.getElementById('bar-faux').style.height = pFaux + "%";
            document.getElementById('val-faux').innerText = pFaux + "%";
        }

        // LANCER QUESTION
        window.launchDirect = async () => {
            const q = document.getElementById('input-q').value;
            currentCorrectAnswer = document.getElementById('input-correct').value;
            currentNotion = document.getElementById('input-notion').value || "Question";
            if(!q) return alert("Entrez une question !");

            document.getElementById('display-question').innerText = q;
            
            // Reset visuel
            document.getElementById('bar-vrai').style.opacity = 1; 
            document.getElementById('bar-faux').style.opacity = 1;
            document.getElementById('btn-reveal').classList.remove('ready');

            // Envoi Config
            await setDoc(doc(db, "vraifaux_etat", "config"), {
                question: q,
                isOpen: true,
                showResult: false, // On cache le r√©sultat au d√©but
                correctAnswer: currentCorrectAnswer,
                sessionId: currentSessionId
            });
            updateLockIcon(true); resetTimerGUI();
        };

        // REVELATION
        window.revealAnswer = async () => {
            // Met √† jour la config pour que les √©l√®ves voient
            await updateDoc(doc(db, "vraifaux_etat", "config"), { showResult: true });
            
            // Visuel Prof (Griser la mauvaise r√©ponse)
            if(currentCorrectAnswer === "VRAI") {
                document.getElementById('bar-faux').style.opacity = 0.2;
            } else {
                document.getElementById('bar-vrai').style.opacity = 0.2;
            }
            
            analyzeResults(); // Lance l'analyse √† ce moment l√†
        };

        window.analyzeResults = () => {
            if(totalVotes === 0) return;
            const correctCount = counts[currentCorrectAnswer];
            const errorCount = totalVotes - correctCount;
            const errorRate = Math.round((errorCount / totalVotes) * 100);
            let msg = "";
            if(errorRate > 40) msg = `‚ö†Ô∏è √Ä revoir : ${currentNotion} (${errorRate}% erreurs)`;
            else msg = `‚úÖ Acquis : ${currentNotion}`;
            const overlay = document.getElementById('bilan-overlay');
            overlay.innerText = msg; overlay.style.display = "block"; setTimeout(() => overlay.style.display = "none", 5000);
        };

        // GESTION CADENAS
        let isUnlocked = true;
        window.toggleLock = async () => {
            isUnlocked = !isUnlocked;
            await updateDoc(doc(db, "vraifaux_etat", "config"), { isOpen: isUnlocked });
            updateLockIcon(isUnlocked);
            
            // Quand on ferme, le bouton REVELER devient dispo
            if(!isUnlocked) document.getElementById('btn-reveal').classList.add('ready');
        };

        function updateLockIcon(open) {
            const btn = document.getElementById('btn-lock');
            if(open) { btn.innerText = "üîì"; btn.classList.remove('locked'); } 
            else { btn.innerText = "üîí"; btn.classList.add('locked'); }
            isUnlocked = open;
        }

        // PLAYLIST & RESTE (Code identique √† avant, juste copi√© pour compl√©tude)
        const playlistCol = collection(db, "vraifaux_playlist");
        window.addToPlaylist = async () => {
            const q = document.getElementById('input-q').value;
            const rep = document.getElementById('input-correct').value;
            const not = document.getElementById('input-notion').value || "G√©n√©ral";
            if(!q) return alert("Vide !");
            await addDoc(playlistCol, { question: q, reponse: rep, notion: not, created: Date.now() });
            document.getElementById('input-q').value = "";
        };
        const qPlaylist = query(playlistCol, orderBy("created", "asc"));
        onSnapshot(qPlaylist, (snap) => {
            const container = document.getElementById('playlist-container'); container.innerHTML = "";
            snap.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div'); div.className = 'playlist-item';
                div.innerHTML = `<span class="pl-q">${data.question}</span><div class="pl-infos"><span>${data.reponse}</span><span>${data.notion}</span></div><div class="pl-actions"><button class="btn-pl btn-pl-go" onclick="launchFromPlaylist('${data.question}', '${data.reponse}', '${data.notion}')">GO üöÄ</button><button class="btn-pl btn-pl-del" onclick="deleteFromPlaylist('${doc.id}')">‚úï</button></div>`;
                container.appendChild(div);
            });
        });
        window.deleteFromPlaylist = async (id) => { await deleteDoc(doc(db, "vraifaux_playlist", id)); };
        window.launchFromPlaylist = (q, rep, not) => { document.getElementById('input-q').value=q; document.getElementById('input-correct').value=rep; document.getElementById('input-notion').value=not; launchDirect(); };
        
        window.resetVotes = async () => {
            if(confirm("Effacer ?")) {
                const batch = writeBatch(db);
                const snap = currentSessionId
                    ? await getDocs(query(collection(db, "vraifaux_reponses"), where("sessionId", "==", currentSessionId)))
                    : await getDocs(collection(db, "vraifaux_reponses"));
                snap.forEach(d => batch.delete(d.ref)); await batch.commit(); updateBars();
                document.getElementById('bar-vrai').style.opacity = 1; document.getElementById('bar-faux').style.opacity = 1;
            }
        };
        
        let timerInt; let seconds = 30;
        window.startTimer = () => { if(timerInt) { clearInterval(timerInt); timerInt=null; return; } seconds=30; timerInt=setInterval(()=>{ seconds--; document.getElementById('timer-display').innerText=`00:${seconds<10?'0'+seconds:seconds}`; if(seconds<=0){ clearInterval(timerInt); toggleLock(); } },1000); };
        function resetTimerGUI() { clearInterval(timerInt); timerInt=null; document.getElementById('timer-display').innerText="00:30"; }

        // AUTO-START session if exists in localStorage
        if(currentSessionId) {
            document.getElementById('session-id-display').innerText = 'Session: ' + currentSessionId;
            const qrUrl = 'https://preventionsanteenvironnement.github.io/PSE/eleve_vraifaux.html?sessionId=' + currentSessionId;
            const qrImg = document.getElementById('qr-code');
            qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=' + encodeURIComponent(qrUrl);
            qrImg.style.display = 'block';
            document.getElementById('qr-label').style.display = 'block';
            setupListeners();
        }

        // SONO
        async function initSono() { try { const s=await navigator.mediaDevices.getUserMedia({audio:true}); const c=new AudioContext(); const a=c.createAnalyser(); const m=c.createMediaStreamSource(s); const p=c.createScriptProcessor(256,1,1); m.connect(a); a.connect(p); p.connect(c.destination); p.onaudioprocess=()=>{ const d=new Uint8Array(a.frequencyBinCount); a.getByteFrequencyData(d); let v=0; for(let i=0;i<d.length;i++)v+=d[i]; let pc=Math.min(100,(v/d.length)*2); const b=document.getElementById('sono-fill'); b.style.height=pc+"%"; if(pc>80)b.style.background="#e74c3c"; else if(pc>50)b.style.background="#f1c40f"; else b.style.background="#2ecc71"; }; }catch(e){} }
        initSono();
        
        window.toggleLock = toggleLock; window.resetVotes = resetVotes; window.startTimer = startTimer; window.launchDirect = launchDirect; window.addToPlaylist = addToPlaylist; window.revealAnswer = revealAnswer; window.launchFromPlaylist = launchFromPlaylist; window.deleteFromPlaylist = deleteFromPlaylist;
    </script>
</body>
</html>